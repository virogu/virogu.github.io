<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ADB 其他常用命令</title>
    <link href="/2023/08/31/docs/adb/adb-qi-ta-ming-ling/"/>
    <url>/2023/08/31/docs/adb/adb-qi-ta-ming-ling/</url>
    
    <content type="html"><![CDATA[<p>CPU温度</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-built_in">cat</span> /sys/class/thermal/thermal_zone7/temp<br></code></pre></td></tr></tbody></table></figure><p>强制停止程序</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am force-stop com.xxxx.android.mirror<br></code></pre></td></tr></tbody></table></figure><p>启动程序</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am start com.xxxx.xxxx/com.xxxx.PreviewActivity<br></code></pre></td></tr></tbody></table></figure><p>卸载程序</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb uninstall com.xxx.xx<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb forward tcp:10101 tcp:10101<br>adb reverse tcp:9537 tcp:9537<br></code></pre></td></tr></tbody></table></figure><p>查看CPU</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell getprop ro.board.platform<br>top -m 20 -s cpu -d 5<br></code></pre></td></tr></tbody></table></figure><p>获取处理器信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell getprop ro.board.platform<br></code></pre></td></tr></tbody></table></figure><p>查看相机参数<br>执行这个adb命令会打印所有默认参数和当前使用参数</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys media.camera<br></code></pre></td></tr></tbody></table></figure><p>查看某一项参数,使用过滤命令grep(linux), windows下可使用findstr来过滤</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys media.camera |grep picture-size<br></code></pre></td></tr></tbody></table></figure><p>将结果保存到文件中</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys media.camera &gt; F:\Data\桌面\camera.txt<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 打开设置界面</title>
    <link href="/2023/08/31/docs/adb/adb-da-kai-she-zhi-jie-mian/"/>
    <url>/2023/08/31/docs/adb/adb-da-kai-she-zhi-jie-mian/</url>
    
    <content type="html"><![CDATA[<h3 id="adb命令打开手机设置页面"><a href="#adb命令打开手机设置页面" class="headerlink" title="adb命令打开手机设置页面"></a>adb命令打开手机设置页面</h3><p>关闭设置界面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am force-stop com.android.settings<br></code></pre></td></tr></tbody></table></figure><p>//打开设置主页面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am start com.android.settings/com.android.settings.Settings<br></code></pre></td></tr></tbody></table></figure><p>安全</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am start com.android.settings/com.android.settings.SecuritySettings<br></code></pre></td></tr></tbody></table></figure><p>手机无线信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am start com.android.settings/com.android.settings.RadioInfo<br></code></pre></td></tr></tbody></table></figure><p>有些界面需要这样打开</p><p>APN界面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am start -n <span class="hljs-string">'com.android.settings/.Settings\$ApnSettingsActivity'</span><br></code></pre></td></tr></tbody></table></figure><p>更多页面</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.AccessibilitySettings</span> 辅助功能设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.ActivityPicker</span> 选择活动<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.ApnSettings</span> APN设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.ApplicationSettings</span> 应用程序设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.BandMode</span> 设置GSM/UMTS波段<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.BatteryInfo</span> 电池信息<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DateTimeSettings</span> 日期和坝上旅游网时间设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DateTimeSettingsSetupWizard</span> 日期和时间设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DevelopmentSettings</span> 开发者设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DeviceAdminSettings</span> 设备管理器<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DeviceInfoSettings</span> 关于手机<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.Display</span> 显示——设置显示字体大小及预览<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DisplaySettings</span> 显示设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.DockSettings</span> 底座设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.IccLockSettings</span> SIM卡锁定设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.InstalledAppDetails</span> 语言和键盘设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.LanguageSettings</span> 语言和键盘设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.LocalePicker</span> 选择手机语言<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.LocalePickerInSetupWizard</span> 选择手机语言<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.ManageApplications</span> 已下载（安装）软件列表<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.MasterClear</span> 恢复出厂设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.MediaFormat</span> 格式化手机闪存<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.PhysicalKeyboardSettings</span> 设置键盘<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.PrivacySettings</span> 隐私设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.ProxySelector</span> 代理设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.RadioInfo</span> 手机信息<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.RunningServices</span> 正在运行的程序（服务）<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.SecuritySettings</span> 位置和安全设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.Settings</span> 系统设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.SettingsSafetyLegalActivity</span> 安全信息<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.SoundSettings</span> 声音设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.TestingSettings</span> 测试——显示手机信息、电池信息、使用情况统计、Wifi information、服务信息<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.TetherSettings</span> 绑定与便携式热点<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.TextToSpeechSettings</span> 文字转语音设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.UsageStats</span> 使用情况统计<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.UserDictionarySettings</span> 用户词典<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.VoiceInputOutputSettings</span> 语音输入与输出设置<br>com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.settings</span><span class="hljs-selector-class">.WirelessSettings</span> 无线和网络设置<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 执行可执行文件</title>
    <link href="/2023/08/31/docs/adb/adb-zhi-xing-ke-zhi-xing-wen-jian/"/>
    <url>/2023/08/31/docs/adb/adb-zhi-xing-ke-zhi-xing-wen-jian/</url>
    
    <content type="html"><![CDATA[<h3 id="1-推送文件到-data-local-tmp"><a href="#1-推送文件到-data-local-tmp" class="headerlink" title="1. 推送文件到 /data/local/tmp"></a>1. 推送文件到 /data/local/tmp</h3><p>例：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb push E:/Test/libXXX.out.so /data/local/tmp<br></code></pre></td></tr></tbody></table></figure><h3 id="2-设置文件权限"><a href="#2-设置文件权限" class="headerlink" title="2. 设置文件权限"></a>2. 设置文件权限</h3><p>例：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell<br><span class="hljs-built_in">cd</span> /data/local/tmp<br><span class="hljs-built_in">chmod</span> 777 libXXX.out.so<br></code></pre></td></tr></tbody></table></figure><h3 id="3-设置工作目录为当前目录："><a href="#3-设置工作目录为当前目录：" class="headerlink" title="3. 设置工作目录为当前目录："></a>3. 设置工作目录为当前目录：</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=.<br></code></pre></td></tr></tbody></table></figure><h3 id="4-执行可执行文件"><a href="#4-执行可执行文件" class="headerlink" title="4. 执行可执行文件"></a>4. 执行可执行文件</h3><p>例：执行 <code>libXXX.out.so</code></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./libXXX.out.so<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 文件操作</title>
    <link href="/2023/08/31/docs/adb/adb-wen-jian-cao-zuo/"/>
    <url>/2023/08/31/docs/adb/adb-wen-jian-cao-zuo/</url>
    
    <content type="html"><![CDATA[<p>删除文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-built_in">rm</span> -rf /dir1/test1/test<br></code></pre></td></tr></tbody></table></figure><p>批量删除符合条件的文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-built_in">rm</span> -rf /dir1/test1/test*<br></code></pre></td></tr></tbody></table></figure><p>批量删除符合条件的文件（不区分大小写）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-string">'find /dir1/test1 -maxdepth 1 -iname "TesT*" -exec rm -rf {} \;'</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 查看电池记录</title>
    <link href="/2023/08/31/docs/adb/adb-cha-kan-dian-chi-ji-lu/"/>
    <url>/2023/08/31/docs/adb/adb-cha-kan-dian-chi-ji-lu/</url>
    
    <content type="html"><![CDATA[<p>重置电池记录</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys batterystats --reset<br></code></pre></td></tr></tbody></table></figure><p>保存电池记录导致文档</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys batterystats &gt; E:\<span class="hljs-built_in">test</span>\batterystats.txt<br>adb bugreport &gt; E:\<span class="hljs-built_in">test</span>\bugreport.txt<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 音量操作</title>
    <link href="/2023/08/31/docs/adb/adb-cha-kan-yin-liang/"/>
    <url>/2023/08/31/docs/adb/adb-cha-kan-yin-liang/</url>
    
    <content type="html"><![CDATA[<h2 id="获取设备音频流信息"><a href="#获取设备音频流信息" class="headerlink" title="获取设备音频流信息"></a>获取设备音频流信息</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell dumpsys audio<br></code></pre></td></tr></tbody></table></figure><h2 id="获取当前设备各类音量大小"><a href="#获取当前设备各类音量大小" class="headerlink" title="获取当前设备各类音量大小"></a>获取当前设备各类音量大小</h2><h3 id="获取设备的电话音量-STREAM-VOICE-CALL"><a href="#获取设备的电话音量-STREAM-VOICE-CALL" class="headerlink" title="获取设备的电话音量 - STREAM_VOICE_CALL"></a>获取设备的电话音量 - STREAM_VOICE_CALL</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 0 --get<br></code></pre></td></tr></tbody></table></figure><h3 id="获取设备的系统音量-STREAM-SYSTEM"><a href="#获取设备的系统音量-STREAM-SYSTEM" class="headerlink" title="获取设备的系统音量 - STREAM_SYSTEM"></a>获取设备的系统音量 - STREAM_SYSTEM</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 1 --get<br></code></pre></td></tr></tbody></table></figure><h3 id="获取设备的铃音音量-STREAM-RING"><a href="#获取设备的铃音音量-STREAM-RING" class="headerlink" title="获取设备的铃音音量 - STREAM_RING"></a>获取设备的铃音音量 - STREAM_RING</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 2 --get<br></code></pre></td></tr></tbody></table></figure><h3 id="获取设备的音乐音量（多媒体音量-）-STREAM-MUSIC"><a href="#获取设备的音乐音量（多媒体音量-）-STREAM-MUSIC" class="headerlink" title="获取设备的音乐音量（多媒体音量 ）- STREAM_MUSIC"></a>获取设备的音乐音量（多媒体音量 ）- STREAM_MUSIC</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 3 --get<br></code></pre></td></tr></tbody></table></figure><h3 id="获取设备的闹钟音量-STREAM-ALARM"><a href="#获取设备的闹钟音量-STREAM-ALARM" class="headerlink" title="获取设备的闹钟音量- STREAM_ALARM"></a>获取设备的闹钟音量- STREAM_ALARM</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 4 --get<br></code></pre></td></tr></tbody></table></figure><h2 id="设置音量大小"><a href="#设置音量大小" class="headerlink" title="设置音量大小"></a>设置音量大小</h2><p>示例：设置多媒体音量大小</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell media volume --show --stream 3 --<span class="hljs-built_in">set</span> 10<br></code></pre></td></tr></tbody></table></figure><p>输出：</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[v] will control <span class="hljs-attribute">stream</span>=3 (STREAM_MUSIC)<br>[v] will <span class="hljs-built_in">set</span> volume <span class="hljs-keyword">to</span> <span class="hljs-attribute">index</span>=10<br>[v] Connecting <span class="hljs-keyword">to</span> AudioService<br></code></pre></td></tr></tbody></table></figure><blockquote><p>注：设置系统音量为0（stream=1）后，设备会进入静音模式，之后再修改其他模式音量会失败</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 模拟命令</title>
    <link href="/2023/08/31/docs/adb/adb-mo-ni-ming-ling/"/>
    <url>/2023/08/31/docs/adb/adb-mo-ni-ming-ling/</url>
    
    <content type="html"><![CDATA[<p>模拟开关机广播</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell am broadcast -a android.intent.action.BOOT_COMPLETED<br></code></pre></td></tr></tbody></table></figure><p>设置桌面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-string">"cmd package set-home-activity com.xxxx/com.xxx.MainActivity"</span> <br></code></pre></td></tr></tbody></table></figure><p>模拟输入文字</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-string">"input keyboard text 'a text'"</span><br></code></pre></td></tr></tbody></table></figure><p>模拟点击屏幕</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-string">"input keyevent 3"</span><br></code></pre></td></tr></tbody></table></figure><p>在屏幕上做划屏操作，前四个数为坐标点，后面是滑动的时间（单位毫秒）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell input swipe 50 250 250 250 500<br></code></pre></td></tr></tbody></table></figure><p>在 100 100 位置长按 1000毫秒</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell input swipe 100 100 100 100 1000<br></code></pre></td></tr></tbody></table></figure><p>模拟点击屏幕<br>在屏幕上点击坐标点x=50 y=250的位置。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell input tap 50 250<br></code></pre></td></tr></tbody></table></figure><p>设置默认输入法</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell settings put secure default_input_method com.sohu.inputmethod.sogou/.SougouIME<br><br>adb shell settings put secure default_input_method com.android.inputmethod.latin/.LatinIME<br></code></pre></td></tr></tbody></table></figure><p>模拟点击HOME键</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell <span class="hljs-string">"input keyevent 3"</span><br></code></pre></td></tr></tbody></table></figure><p>模拟点击按键时每个数字与keycode对应表如下</p><figure class="highlight basic"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">0 </span>--&gt; <span class="hljs-string">"KEYCODE_UNKNOWN"</span><br><span class="hljs-symbol">1 </span>--&gt; <span class="hljs-string">"KEYCODE_MENU"</span><br><span class="hljs-symbol">2 </span>--&gt; <span class="hljs-string">"KEYCODE_SOFT_RIGHT"</span><br><span class="hljs-symbol">3 </span>--&gt; <span class="hljs-string">"KEYCODE_HOME"</span><br><span class="hljs-symbol">4 </span>--&gt; <span class="hljs-string">"KEYCODE_BACK"</span><br><span class="hljs-symbol">5 </span>--&gt; <span class="hljs-string">"KEYCODE_CALL"</span><br><span class="hljs-symbol">6 </span>--&gt; <span class="hljs-string">"KEYCODE_ENDCALL"</span><br><span class="hljs-symbol">7 </span>--&gt; <span class="hljs-string">"KEYCODE_0"</span><br><span class="hljs-symbol">8 </span>--&gt; <span class="hljs-string">"KEYCODE_1"</span><br><span class="hljs-symbol">9 </span>--&gt; <span class="hljs-string">"KEYCODE_2"</span><br><span class="hljs-symbol">10 </span>--&gt; <span class="hljs-string">"KEYCODE_3"</span><br><span class="hljs-symbol">11 </span>--&gt; <span class="hljs-string">"KEYCODE_4"</span><br><span class="hljs-symbol">12 </span>--&gt; <span class="hljs-string">"KEYCODE_5"</span><br><span class="hljs-symbol">13 </span>--&gt; <span class="hljs-string">"KEYCODE_6"</span><br><span class="hljs-symbol">14 </span>--&gt; <span class="hljs-string">"KEYCODE_7"</span><br><span class="hljs-symbol">15 </span>--&gt; <span class="hljs-string">"KEYCODE_8"</span><br><span class="hljs-symbol">16 </span>--&gt; <span class="hljs-string">"KEYCODE_9"</span><br><span class="hljs-symbol">17 </span>--&gt; <span class="hljs-string">"KEYCODE_STAR"</span><br><span class="hljs-symbol">18 </span>--&gt; <span class="hljs-string">"KEYCODE_POUND"</span><br><span class="hljs-symbol">19 </span>--&gt; <span class="hljs-string">"KEYCODE_DPAD_UP"</span><br><span class="hljs-symbol">20 </span>--&gt; <span class="hljs-string">"KEYCODE_DPAD_DOWN"</span><br><span class="hljs-symbol">21 </span>--&gt; <span class="hljs-string">"KEYCODE_DPAD_LEFT"</span><br><span class="hljs-symbol">22 </span>--&gt; <span class="hljs-string">"KEYCODE_DPAD_RIGHT"</span><br><span class="hljs-symbol">23 </span>--&gt; <span class="hljs-string">"KEYCODE_DPAD_CENTER"</span><br><span class="hljs-symbol">24 </span>--&gt; <span class="hljs-string">"KEYCODE_VOLUME_UP"</span><br><span class="hljs-symbol">25 </span>--&gt; <span class="hljs-string">"KEYCODE_VOLUME_DOWN"</span><br><span class="hljs-symbol">26 </span>--&gt; <span class="hljs-string">"KEYCODE_POWER"</span><br><span class="hljs-symbol">27 </span>--&gt; <span class="hljs-string">"KEYCODE_CAMERA"</span><br><span class="hljs-symbol">28 </span>--&gt; <span class="hljs-string">"KEYCODE_CLEAR"</span><br><span class="hljs-symbol">29 </span>--&gt; <span class="hljs-string">"KEYCODE_A"</span><br><span class="hljs-symbol">30 </span>--&gt; <span class="hljs-string">"KEYCODE_B"</span><br><span class="hljs-symbol">31 </span>--&gt; <span class="hljs-string">"KEYCODE_C"</span><br><span class="hljs-symbol">32 </span>--&gt; <span class="hljs-string">"KEYCODE_D"</span><br><span class="hljs-symbol">33 </span>--&gt; <span class="hljs-string">"KEYCODE_E"</span><br><span class="hljs-symbol">34 </span>--&gt; <span class="hljs-string">"KEYCODE_F"</span><br><span class="hljs-symbol">35 </span>--&gt; <span class="hljs-string">"KEYCODE_G"</span><br><span class="hljs-symbol">36 </span>--&gt; <span class="hljs-string">"KEYCODE_H"</span><br><span class="hljs-symbol">37 </span>--&gt; <span class="hljs-string">"KEYCODE_I"</span><br><span class="hljs-symbol">38 </span>--&gt; <span class="hljs-string">"KEYCODE_J"</span><br><span class="hljs-symbol">39 </span>--&gt; <span class="hljs-string">"KEYCODE_K"</span><br><span class="hljs-symbol">40 </span>--&gt; <span class="hljs-string">"KEYCODE_L"</span><br><span class="hljs-symbol">41 </span>--&gt; <span class="hljs-string">"KEYCODE_M"</span><br><span class="hljs-symbol">42 </span>--&gt; <span class="hljs-string">"KEYCODE_N"</span><br><span class="hljs-symbol">43 </span>--&gt; <span class="hljs-string">"KEYCODE_O"</span><br><span class="hljs-symbol">44 </span>--&gt; <span class="hljs-string">"KEYCODE_P"</span><br><span class="hljs-symbol">45 </span>--&gt; <span class="hljs-string">"KEYCODE_Q"</span><br><span class="hljs-symbol">46 </span>--&gt; <span class="hljs-string">"KEYCODE_R"</span><br><span class="hljs-symbol">47 </span>--&gt; <span class="hljs-string">"KEYCODE_S"</span><br><span class="hljs-symbol">48 </span>--&gt; <span class="hljs-string">"KEYCODE_T"</span><br><span class="hljs-symbol">49 </span>--&gt; <span class="hljs-string">"KEYCODE_U"</span><br><span class="hljs-symbol">50 </span>--&gt; <span class="hljs-string">"KEYCODE_V"</span><br><span class="hljs-symbol">51 </span>--&gt; <span class="hljs-string">"KEYCODE_W"</span><br><span class="hljs-symbol">52 </span>--&gt; <span class="hljs-string">"KEYCODE_X"</span><br><span class="hljs-symbol">53 </span>--&gt; <span class="hljs-string">"KEYCODE_Y"</span><br><span class="hljs-symbol">54 </span>--&gt; <span class="hljs-string">"KEYCODE_Z"</span><br><span class="hljs-symbol">55 </span>--&gt; <span class="hljs-string">"KEYCODE_COMMA"</span><br><span class="hljs-symbol">56 </span>--&gt; <span class="hljs-string">"KEYCODE_PERIOD"</span><br><span class="hljs-symbol">57 </span>--&gt; <span class="hljs-string">"KEYCODE_ALT_LEFT"</span><br><span class="hljs-symbol">58 </span>--&gt; <span class="hljs-string">"KEYCODE_ALT_RIGHT"</span><br><span class="hljs-symbol">59 </span>--&gt; <span class="hljs-string">"KEYCODE_SHIFT_LEFT"</span><br><span class="hljs-symbol">60 </span>--&gt; <span class="hljs-string">"KEYCODE_SHIFT_RIGHT"</span><br><span class="hljs-symbol">61 </span>--&gt; <span class="hljs-string">"KEYCODE_TAB"</span><br><span class="hljs-symbol">62 </span>--&gt; <span class="hljs-string">"KEYCODE_SPACE"</span><br><span class="hljs-symbol">63 </span>--&gt; <span class="hljs-string">"KEYCODE_SYM"</span><br><span class="hljs-symbol">64 </span>--&gt; <span class="hljs-string">"KEYCODE_EXPLORER"</span><br><span class="hljs-symbol">65 </span>--&gt; <span class="hljs-string">"KEYCODE_ENVELOPE"</span><br><span class="hljs-symbol">66 </span>--&gt; <span class="hljs-string">"KEYCODE_ENTER"</span><br><span class="hljs-symbol">67 </span>--&gt; <span class="hljs-string">"KEYCODE_DEL"</span><br><span class="hljs-symbol">68 </span>--&gt; <span class="hljs-string">"KEYCODE_GRAVE"</span><br><span class="hljs-symbol">69 </span>--&gt; <span class="hljs-string">"KEYCODE_MINUS"</span><br><span class="hljs-symbol">70 </span>--&gt; <span class="hljs-string">"KEYCODE_EQUALS"</span><br><span class="hljs-symbol">71 </span>--&gt; <span class="hljs-string">"KEYCODE_LEFT_BRACKET"</span><br><span class="hljs-symbol">72 </span>--&gt; <span class="hljs-string">"KEYCODE_RIGHT_BRACKET"</span><br><span class="hljs-symbol">73 </span>--&gt; <span class="hljs-string">"KEYCODE_BACKSLASH"</span><br><span class="hljs-symbol">74 </span>--&gt; <span class="hljs-string">"KEYCODE_SEMICOLON"</span><br><span class="hljs-symbol">75 </span>--&gt; <span class="hljs-string">"KEYCODE_APOSTROPHE"</span><br><span class="hljs-symbol">76 </span>--&gt; <span class="hljs-string">"KEYCODE_SLASH"</span><br><span class="hljs-symbol">77 </span>--&gt; <span class="hljs-string">"KEYCODE_AT"</span><br><span class="hljs-symbol">78 </span>--&gt; <span class="hljs-string">"KEYCODE_NUM"</span><br><span class="hljs-symbol">79 </span>--&gt; <span class="hljs-string">"KEYCODE_HEADSETHOOK"</span><br><span class="hljs-symbol">80 </span>--&gt; <span class="hljs-string">"KEYCODE_FOCUS"</span><br><span class="hljs-symbol">81 </span>--&gt; <span class="hljs-string">"KEYCODE_PLUS"</span><br><span class="hljs-symbol">82 </span>--&gt; <span class="hljs-string">"KEYCODE_MENU"</span><br><span class="hljs-symbol">83 </span>--&gt; <span class="hljs-string">"KEYCODE_NOTIFICATION"</span><br><span class="hljs-symbol">84 </span>--&gt; <span class="hljs-string">"KEYCODE_SEARCH"</span><br><span class="hljs-symbol">85 </span>--&gt; <span class="hljs-string">"TAG_LAST_KEYCODE"</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ADB 开启远程调试</title>
    <link href="/2023/08/31/docs/adb/adb-yuan-cheng-diao-shi/"/>
    <url>/2023/08/31/docs/adb/adb-yuan-cheng-diao-shi/</url>
    
    <content type="html"><![CDATA[<h2 id="开启无线调试"><a href="#开启无线调试" class="headerlink" title="开启无线调试"></a>开启无线调试</h2><h3 id="Root模式"><a href="#Root模式" class="headerlink" title="Root模式"></a>Root模式</h3><p>方式一</p><p>手动修改 <code>/system/build.prop</code> 文件，后面添加下面这行，然后保存</p><figure class="highlight elm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">service</span>.adb.tcp.<span class="hljs-keyword">port</span>=5555<br></code></pre></td></tr></tbody></table></figure><p>可以这样操作</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb root<br>adb remount<br>adb pull /system/build.prop<br></code></pre></td></tr></tbody></table></figure><p>手动修改 <code>build.prop</code> 文件，添加 <code>service.adb.tcp.port=5555</code>，保存，然后推送到设备中</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb push build.prop /system/build.prop<br>adb shell <span class="hljs-built_in">chmod</span> 0644 /system/build.prop<br></code></pre></td></tr></tbody></table></figure><p>方式二</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell su -c setprop service.adb.tcp.port 5555<br></code></pre></td></tr></tbody></table></figure><h3 id="非Root模式"><a href="#非Root模式" class="headerlink" title="非Root模式"></a>非Root模式</h3><p>需要先用数据线连接到设备，然后执行下面的命令打开无线调试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb tcpip 5555<br></code></pre></td></tr></tbody></table></figure><p>然后就可以断开数据线，通过无线连接到设备了</p><blockquote><p>注：这种方式设备重启后需要重新打开无线调试</p></blockquote><h2 id="无线连接"><a href="#无线连接" class="headerlink" title="无线连接"></a>无线连接</h2><p>连接设备，<code>adb connect ip:port</code></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb connect 192.168.x.x:5555<br></code></pre></td></tr></tbody></table></figure><p>默认端口是 <code>5555</code>，如果没有修改端口的话可以省略端口</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb connect 192.168.x.x<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ADB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ADB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNI中打印AndroidLog</title>
    <link href="/2023/08/30/docs/android/jni/jni-zhong-da-yin-androidlog/"/>
    <url>/2023/08/30/docs/android/jni/jni-zhong-da-yin-androidlog/</url>
    
    <content type="html"><![CDATA[<p>在文件前面加上下面的定义</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/log.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TAG <span class="hljs-string">"LogTag"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, TAG, __VA_ARGS__)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGV(...) __android_log_print(ANDROID_LOG_VERBOSE, TAG, __VA_ARGS__)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, TAG, __VA_ARGS__)</span><br><br></code></pre></td></tr></tbody></table></figure><p>然后就可以使用定义的这些方法打印Logcat日志了</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>JNI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AnimeView</title>
    <link href="/2023/08/29/docs/android/view/customview/animeview/"/>
    <url>/2023/08/29/docs/android/view/customview/animeview/</url>
    
    <content type="html"><![CDATA[<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimeView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(<br>    context: Context, attrs: AttributeSet? = <span class="hljs-literal">null</span>, defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><br>) : View(context, attrs, defStyleAttr) {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> backgroundPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {<br>        color = <span class="hljs-number">0x55FFFFFF</span><br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> topPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {<br>        color = <span class="hljs-number">0xAAFFFFFF</span>.toInt()<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> topLineOffsetX = <span class="hljs-number">0f</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> topLineLength <span class="hljs-keyword">get</span>() = width / <span class="hljs-number">4f</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> animation = ValueAnimator.ofFloat(<span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>).apply {<br>        duration = <span class="hljs-number">2000L</span><br>        repeatMode = ValueAnimator.REVERSE<br>        repeatCount = ValueAnimator.INFINITE<br>        addUpdateListener {<br>            <span class="hljs-keyword">val</span> value = it.animatedValue <span class="hljs-keyword">as</span> <span class="hljs-built_in">Float</span><br>            topLineOffsetX = (width * <span class="hljs-number">.75f</span>) * value<br>            postInvalidate()<br>        }<br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttachedToWindow</span><span class="hljs-params">()</span></span> {<br>        <span class="hljs-keyword">super</span>.onAttachedToWindow()<br>        animation.start()<br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromWindow</span><span class="hljs-params">()</span></span> {<br>        animation.cancel()<br>        <span class="hljs-keyword">super</span>.onDetachedFromWindow()<br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>?)</span></span> {<br>        <span class="hljs-keyword">super</span>.onDraw(canvas)<br><br>        canvas?.let {<br>            it.drawRoundRect(<br>                <span class="hljs-number">0f</span>,<br>                <span class="hljs-number">0f</span>,<br>                width.toFloat(),<br>                height.toFloat(),<br>                height / <span class="hljs-number">2f</span>,<br>                height / <span class="hljs-number">2f</span>,<br>                backgroundPaint<br>            )<br>            it.drawRoundRect(<br>                topLineOffsetX,<br>                <span class="hljs-number">0f</span>,<br>                topLineOffsetX + topLineLength,<br>                height.toFloat(),<br>                height / <span class="hljs-number">2f</span>,<br>                height / <span class="hljs-number">2f</span>,<br>                topPaint<br>            )<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>CustomView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>自定义RadioGroup</title>
    <link href="/2023/08/29/docs/android/view/customview/customradiogroup/"/>
    <url>/2023/08/29/docs/android/view/customview/customradiogroup/</url>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.android.settings.util;<br><br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.content.res.TypedArray;<br><span class="hljs-keyword">import</span> android.util.AttributeSet;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.view.MotionEvent;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.view.ViewGroup;<br><span class="hljs-keyword">import</span> android.widget.RadioButton;<br><span class="hljs-keyword">import</span> android.widget.RadioGroup;<br><br><span class="hljs-keyword">import</span> com.android.internal.R;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRadioGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RadioGroup</span> {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"CustomRadioGroup"</span>;<br><br>    <span class="hljs-keyword">private</span> OnCheckedChangeListener mOnCheckedChangeListener;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mCheckedId</span> <span class="hljs-operator">=</span> View.NO_ID;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">radioIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">private</span> List&lt;RadioButton&gt; radios = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomRadioGroup</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-built_in">super</span>(context);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomRadioGroup</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {<br>        <span class="hljs-built_in">super</span>(context, attrs);<br><br>        <span class="hljs-type">TypedArray</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> context.obtainStyledAttributes(<br>                attrs, com.android.internal.R.styleable.RadioGroup, com.android.internal.R.attr.radioButtonStyle, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getResourceId(R.styleable.RadioGroup_checkedButton, View.NO_ID);<br>        <span class="hljs-keyword">if</span> (value != View.NO_ID) {<br>            mCheckedId = value;<br>        }<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(<span class="hljs-keyword">final</span> View child, <span class="hljs-type">int</span> index, ViewGroup.LayoutParams params)</span> {<br>        findRadioButton(child);<br><br>        <span class="hljs-built_in">super</span>.addView(child, index, params);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findRadioButton</span><span class="hljs-params">(View view)</span> {<br>        <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> ViewGroup) {<br>            <span class="hljs-type">int</span> <span class="hljs-variable">childCount</span> <span class="hljs-operator">=</span> ((ViewGroup) view).getChildCount();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; childCount; i++) {<br>                <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> ((ViewGroup) view).getChildAt(i);<br>                findRadioButton(child);<br>            }<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> RadioButton) {<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">RadioButton</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> (RadioButton) view;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> radioIndex;<br>            radios.add(button);<br>            ((RadioButton) button).setOnTouchListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnTouchListener</span>() {<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(View v, MotionEvent event)</span> {<br>                    <span class="hljs-keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP) {<br>                        check(button.getId());<br>                        <span class="hljs-comment">// ((RadioButton) button).setChecked(true);</span><br>                        <span class="hljs-comment">// checkRadioButton((RadioButton) button);</span><br>                        <span class="hljs-keyword">if</span> (mOnCheckedChangeListener != <span class="hljs-literal">null</span>) {<br>                            mOnCheckedChangeListener.onCheckedChanged(CustomRadioGroup.<span class="hljs-built_in">this</span>, index);<br>                        }<br>                    }<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                }<br>            });<br>            radioIndex++;<br>        }<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">check</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {<br>        <span class="hljs-keyword">if</span> (id != -<span class="hljs-number">1</span> &amp;&amp; (id == mCheckedId)) {<br>            <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span> (mCheckedId != -<span class="hljs-number">1</span>) {<br>            setCheckedStateForView(mCheckedId, <span class="hljs-literal">false</span>);<br>        }<br><br>        <span class="hljs-keyword">if</span> (id != -<span class="hljs-number">1</span>) {<br>            setCheckedStateForView(id, <span class="hljs-literal">true</span>);<br>        }<br><br>        mCheckedId = id;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCheckedStateForView</span><span class="hljs-params">(<span class="hljs-type">int</span> viewId, <span class="hljs-type">boolean</span> checked)</span> {<br>        <span class="hljs-type">View</span> <span class="hljs-variable">checkedView</span> <span class="hljs-operator">=</span> findViewById(viewId);<br>        Log.d(TAG, <span class="hljs-string">"checkedView is "</span> + checkedView);<br>        <span class="hljs-keyword">if</span> (checkedView != <span class="hljs-literal">null</span> &amp;&amp; checkedView <span class="hljs-keyword">instanceof</span> RadioButton) {<br>            ((RadioButton) checkedView).setChecked(checked);<br>        }<br>    }<br><br>    <span class="hljs-comment">// public void checkRadioButton(RadioButton radioButton) {</span><br>    <span class="hljs-comment">//     View child;</span><br>    <span class="hljs-comment">//     int radioCount = getChildCount();</span><br>    <span class="hljs-comment">//     for (int i = 0; i &lt; radioCount; i++) {</span><br>    <span class="hljs-comment">//         child = getChildAt(i);</span><br>    <span class="hljs-comment">//         if (child instanceof RadioButton) {</span><br>    <span class="hljs-comment">//             if (child == radioButton) {</span><br>    <span class="hljs-comment">//                 // do nothing</span><br>    <span class="hljs-comment">//             } else {</span><br>    <span class="hljs-comment">//                 ((RadioButton) child).setChecked(false);</span><br>    <span class="hljs-comment">//             }</span><br>    <span class="hljs-comment">//         } else if (child instanceof LinearLayout) {</span><br>    <span class="hljs-comment">//             int childCount = ((LinearLayout) child).getChildCount();</span><br>    <span class="hljs-comment">//             for (int j = 0; j &lt; childCount; j++) {</span><br>    <span class="hljs-comment">//                 View view = ((LinearLayout) child).getChildAt(j);</span><br>    <span class="hljs-comment">//                 if (view instanceof RadioButton) {</span><br>    <span class="hljs-comment">//                     final RadioButton button = (RadioButton) view;</span><br>    <span class="hljs-comment">//                     if (button == radioButton) {</span><br>    <span class="hljs-comment">//                         // do nothing</span><br>    <span class="hljs-comment">//                     } else {</span><br>    <span class="hljs-comment">//                         ((RadioButton) button).setChecked(false);</span><br>    <span class="hljs-comment">//                     }</span><br>    <span class="hljs-comment">//                 }</span><br>    <span class="hljs-comment">//             }</span><br>    <span class="hljs-comment">//         }</span><br>    <span class="hljs-comment">//     }</span><br>    <span class="hljs-comment">// }</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCheckedRadioPosition</span><span class="hljs-params">()</span> {<br>        <span class="hljs-type">int</span> <span class="hljs-variable">checkedPosition</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (radios.size() &gt; <span class="hljs-number">0</span>) {<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; radios.size(); i++) {<br>                <span class="hljs-keyword">if</span> (radios.get(i).isChecked()) {<br>                    checkedPosition = i;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br><br>        <span class="hljs-keyword">return</span> checkedPosition;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOnCheckedChangeListener</span><span class="hljs-params">(OnCheckedChangeListener mOnCheckedChangeListener)</span> {<br>        <span class="hljs-built_in">this</span>.mOnCheckedChangeListener = mOnCheckedChangeListener;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCheckedId</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> mCheckedId;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>CustomView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垂直SeekBar,VerticalSeekBar</title>
    <link href="/2023/08/29/docs/android/view/customview/verticalseekbar/"/>
    <url>/2023/08/29/docs/android/view/customview/verticalseekbar/</url>
    
    <content type="html"><![CDATA[<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><br><span class="hljs-keyword">import</span> android.<span class="hljs-keyword">annotation</span>.SuppressLint<br><span class="hljs-keyword">import</span> android.content.Context<br><span class="hljs-keyword">import</span> android.util.AttributeSet<br><span class="hljs-keyword">import</span> android.view.MotionEvent<br><span class="hljs-keyword">import</span> androidx.appcompat.widget.AppCompatSeekBar<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VerticalSeekBar</span> : <span class="hljs-type">AppCompatSeekBar</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mOnSeekBarChangeListener: OnSeekBarChangeListener? = <span class="hljs-literal">null</span><br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnSeekBarChangeListener</span><span class="hljs-params">(l: <span class="hljs-type">OnSeekBarChangeListener</span>)</span></span> {<br>        mOnSeekBarChangeListener = l<br>        <span class="hljs-keyword">super</span>.setOnSeekBarChangeListener(l)<br>    }<br><br>    <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"ClickableViewAccessibility"</span>)</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTouchEvent</span><span class="hljs-params">(event: <span class="hljs-type">MotionEvent</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {<br>        <span class="hljs-keyword">if</span> (!isEnabled) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        }<br>        parent.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>)<br>        <span class="hljs-keyword">when</span> (event!!.action) {<br>            MotionEvent.ACTION_DOWN -&gt; {<br>                mOnSeekBarChangeListener?.onStartTrackingTouch(<span class="hljs-keyword">this</span>)<br>                <span class="hljs-keyword">val</span> i = max - (max * event.y * <span class="hljs-number">1f</span> / height).toInt()<br>                progress = i<br>                <span class="hljs-keyword">if</span> (event.action == MotionEvent.ACTION_UP || event.action == MotionEvent.ACTION_CANCEL) {<br>                    parent.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>)<br>                    mOnSeekBarChangeListener?.onStopTrackingTouch(<span class="hljs-keyword">this</span>)<br>                }<br>            }<br>            MotionEvent.ACTION_MOVE, MotionEvent.ACTION_UP -&gt; {<br>                <span class="hljs-keyword">val</span> i = max - (max * event.y * <span class="hljs-number">1f</span> / height).toInt()<br>                progress = i<br>                <span class="hljs-keyword">if</span> (event.action == MotionEvent.ACTION_UP || event.action == MotionEvent.ACTION_CANCEL) {<br>                    parent.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>)<br>                    mOnSeekBarChangeListener?.onStopTrackingTouch(<span class="hljs-keyword">this</span>)<br>                }<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    }<br><br>    <span class="hljs-keyword">constructor</span>(ctx: Context) : <span class="hljs-keyword">super</span>(ctx)<br><br>    <span class="hljs-keyword">constructor</span>(ctx: Context, attrs: AttributeSet?) : <span class="hljs-keyword">this</span>(ctx, attrs, <span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">constructor</span>(ctx: Context, attrs: AttributeSet?, defStyleAttr: <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">super</span>(<br>        ctx,<br>        attrs,<br>        defStyleAttr<br>    )<br><br>    <span class="hljs-keyword">init</span> {<br>        thumb = <span class="hljs-literal">null</span><br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromWindow</span><span class="hljs-params">()</span></span> {<br>        <span class="hljs-keyword">super</span>.onDetachedFromWindow()<br>        mOnSeekBarChangeListener = <span class="hljs-literal">null</span><br>    }<br><br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>CustomView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IP输入框控件</title>
    <link href="/2023/08/29/docs/android/view/customview/ipeditortext/"/>
    <url>/2023/08/29/docs/android/view/customview/ipeditortext/</url>
    
    <content type="html"><![CDATA[<p>IpEditorText.kt</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">import</span> android.content.Context<br><span class="hljs-keyword">import</span> android.content.res.ColorStateList<br><span class="hljs-keyword">import</span> android.graphics.Color<br><span class="hljs-keyword">import</span> android.text.Editable<br><span class="hljs-keyword">import</span> android.text.TextWatcher<br><span class="hljs-keyword">import</span> android.text.method.DigitsKeyListener<br><span class="hljs-keyword">import</span> android.util.AttributeSet<br><span class="hljs-keyword">import</span> android.util.SparseArray<br><span class="hljs-keyword">import</span> android.util.TypedValue<br><span class="hljs-keyword">import</span> android.view.Gravity<br><span class="hljs-keyword">import</span> android.view.KeyEvent<br><span class="hljs-keyword">import</span> android.view.inputmethod.EditorInfo<br><span class="hljs-keyword">import</span> android.widget.EditText<br><span class="hljs-keyword">import</span> android.widget.TextView<br><span class="hljs-keyword">import</span> androidx.appcompat.widget.AppCompatEditText<br><span class="hljs-keyword">import</span> androidx.appcompat.widget.AppCompatTextView<br><span class="hljs-keyword">import</span> androidx.appcompat.widget.LinearLayoutCompat<br><span class="hljs-keyword">import</span> com.google.android.material.shape.MaterialShapeDrawable<br><span class="hljs-keyword">import</span> com.google.android.material.shape.ShapeAppearanceModel<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">IpEditorText</span>(context: Context, attrs: AttributeSet) : LinearLayoutCompat(context, attrs) {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EditorView</span>(<br>        <span class="hljs-keyword">val</span> text: EditText,<br>        <span class="hljs-keyword">val</span> suffixTextView: TextView? = <span class="hljs-literal">null</span><br>    )<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> boxBackground: MaterialShapeDrawable<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> shapeAppearanceModel: ShapeAppearanceModel<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> editorViews: List&lt;EditorView&gt; = emptyList()<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> itemDisableIndex: Set&lt;<span class="hljs-built_in">Int</span>&gt; = emptySet()<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> itemWidth: <span class="hljs-built_in">Int</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> itemHeight: <span class="hljs-built_in">Int</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> textSize: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> textColor: <span class="hljs-built_in">Int</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> textDisableColor: <span class="hljs-built_in">Int</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mBackgroundColor: <span class="hljs-built_in">Int</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxStrokeColor: <span class="hljs-built_in">Int</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxStrokeWidth: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxCornerRadius: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxCornerRadiusTopStart: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxCornerRadiusTopEnd: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxCornerRadiusBottomStart: <span class="hljs-built_in">Float</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> boxCornerRadiusBottomEnd: <span class="hljs-built_in">Float</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> layoutStyle: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ips: SparseArray&lt;String&gt; = SparseArray()<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ipViewCount = <span class="hljs-number">4</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> suffix = <span class="hljs-string">"."</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ipText: String? = <span class="hljs-literal">null</span><br><br>    <span class="hljs-keyword">init</span> {<br>        context.obtainStyledAttributes(<br>            attrs, R.styleable.IpEditorText<br>        ).also {<br>            suffix = it.getString(R.styleable.IpEditorText_splitText) ?: suffix<br>            ipViewCount = it.getInt(R.styleable.IpEditorText_itemCount, <span class="hljs-number">4</span>)<br>            ipViewCount = ipViewCount.coerceAtLeast(<span class="hljs-number">1</span>).coerceAtMost(<span class="hljs-number">4</span>)<br>            itemWidth = it.getDimensionPixelSize(R.styleable.IpEditorText_itemWidth, -<span class="hljs-number">1</span>)<br>            itemHeight = it.getDimensionPixelSize(R.styleable.IpEditorText_itemHeight, -<span class="hljs-number">1</span>)<br><br>            textSize = it.getDimension(<br>                R.styleable.IpEditorText_textSize,<br>                context.resources.getDimension(R.dimen.sp_22)<br>            )<br><br>            textColor = it.getColor(R.styleable.IpEditorText_textColor, Color.DKGRAY)<br>            textDisableColor =<br>                it.getColor(R.styleable.IpEditorText_textDisableColor, Color.LTGRAY)<br><br>            mBackgroundColor =<br>                it.getColor(R.styleable.IpEditorText_boxBackgroundColor, Color.TRANSPARENT)<br>            boxStrokeColor =<br>                it.getColor(R.styleable.IpEditorText_boxStrokeColor, Color.TRANSPARENT)<br>            boxStrokeWidth = it.getDimension(R.styleable.IpEditorText_boxStrokeWidth, <span class="hljs-number">0f</span>)<br><br>            boxCornerRadius = it.getDimension(R.styleable.IpEditorText_boxCornerRadius, <span class="hljs-number">0f</span>)<br>            boxCornerRadiusTopStart =<br>                it.getDimension(R.styleable.IpEditorText_boxCornerRadiusTopStart, -<span class="hljs-number">1f</span>)<br>            boxCornerRadiusTopEnd =<br>                it.getDimension(R.styleable.IpEditorText_boxCornerRadiusTopEnd, -<span class="hljs-number">1f</span>)<br>            boxCornerRadiusBottomStart =<br>                it.getDimension(R.styleable.IpEditorText_boxCornerRadiusBottomStart, -<span class="hljs-number">1f</span>)<br>            boxCornerRadiusBottomEnd =<br>                it.getDimension(R.styleable.IpEditorText_boxCornerRadiusBottomEnd, -<span class="hljs-number">1f</span>)<br><br>            layoutStyle = it.getInt(R.styleable.IpEditorText_layoutStyle, <span class="hljs-number">0</span>)<br>            ipText = it.getString(R.styleable.IpEditorText_ipText)<br>            itemDisableIndex = it.getString(<br>                R.styleable.IpEditorText_itemDisableIndex<br>            )?.split(<span class="hljs-string">","</span>)?.mapNotNull { s -&gt;<br>                s.toIntOrNull()<br>            }?.toSet().orEmpty()<br><br>            it.recycle()<br>        }<br>        initView()<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initView</span><span class="hljs-params">()</span></span> {<br>        createLayouts()<br>        updateLayoutsParams()<br>        updateBackground()<br>        updateIp()<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createLayouts</span><span class="hljs-params">()</span></span> {<br>        removeAllViews()<br>        editorViews = List(ipViewCount) { index -&gt;<br>            <span class="hljs-keyword">val</span> textView = AppCompatEditText(context).apply {<br>                layoutParams = LayoutParams(itemWidth, itemHeight, <span class="hljs-number">1f</span>).apply {<br>                    gravity = Gravity.CENTER<br>                    setPadding(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>                }<br>                setPadding(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>                gravity = Gravity.CENTER<br>                background = <span class="hljs-literal">null</span><br>                inputType = EditorInfo.TYPE_NUMBER_FLAG_DECIMAL<br>                isSingleLine = <span class="hljs-literal">true</span><br>                maxLines = <span class="hljs-number">3</span><br>                keyListener = DigitsKeyListener.getInstance(<span class="hljs-string">"0123456789"</span>)<br>                addListener(index)<br>            }.also(::addView)<br><br>            <span class="hljs-keyword">val</span> suffixTextView = <span class="hljs-keyword">if</span> (index &lt; ipViewCount - <span class="hljs-number">1</span>) {<br>                AppCompatTextView(context).apply {<br>                    layoutParams = LayoutParams(LayoutParams.WRAP_CONTENT, itemHeight).apply {<br>                        setPadding(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>                        gravity = Gravity.CENTER or Gravity.BOTTOM<br>                    }<br>                    gravity = Gravity.CENTER or Gravity.BOTTOM<br>                    setPadding(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>                    text = suffix<br>                }.also(::addView)<br>            } <span class="hljs-keyword">else</span> {<br>                <span class="hljs-literal">null</span><br>            }<br>            EditorView(textView, suffixTextView)<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateLayoutsParams</span><span class="hljs-params">()</span></span> {<br>        updateViewEnable()<br>        updateTextStyle()<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateViewEnable</span><span class="hljs-params">()</span></span> {<br>        editorViews.forEachIndexed { i, editorView -&gt;<br>            editorView.text.isEnabled = !itemDisableIndex.contains(i)<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateTextStyle</span><span class="hljs-params">()</span></span> {<br>        editorViews.forEachIndexed { _, editorView -&gt;<br>            <span class="hljs-keyword">val</span> text = editorView.text<br>            <span class="hljs-keyword">val</span> suffixTextView = editorView.suffixTextView<br><br>            <span class="hljs-keyword">val</span> colorStateList = ColorStateList(<br>                arrayOf(<br>                    intArrayOf(android.R.attr.state_enabled),<br>                    intArrayOf(-android.R.attr.state_enabled),<br>                ),<br>                intArrayOf(textColor, textDisableColor)<br>            )<br>            suffixTextView?.setTextSize(TypedValue.COMPLEX_UNIT_PX, textSize)<br>            suffixTextView?.setTextColor(colorStateList)<br><br>            text.setTextSize(TypedValue.COMPLEX_UNIT_PX, textSize)<br>            text.setTextColor(colorStateList)<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateBackground</span><span class="hljs-params">()</span></span> {<br>        shapeAppearanceModel = ShapeAppearanceModel().toBuilder().apply {<br>            setAllCornerSizes(boxCornerRadius)<br>            boxCornerRadiusTopStart.takeIf { f -&gt; f &gt; <span class="hljs-number">0</span> }?.also(::setTopLeftCornerSize)<br>            boxCornerRadiusTopEnd.takeIf { f -&gt; f &gt; <span class="hljs-number">0</span> }?.also(::setTopRightCornerSize)<br>            boxCornerRadiusBottomStart.takeIf { f -&gt; f &gt; <span class="hljs-number">0</span> }?.also(::setBottomLeftCornerSize)<br>            boxCornerRadiusBottomEnd.takeIf { f -&gt; f &gt; <span class="hljs-number">0</span> }?.also(::setBottomRightCornerSize)<br>        }.build()<br><br>        boxBackground = MaterialShapeDrawable(shapeAppearanceModel).also { d -&gt;<br>            d.strokeWidth = boxStrokeWidth<br>            d.strokeColor = ColorStateList.valueOf(boxStrokeColor)<br>            d.fillColor = ColorStateList.valueOf(mBackgroundColor)<br>        }<br>        <span class="hljs-keyword">if</span> (layoutStyle == <span class="hljs-number">1</span>) {<br>            editorViews.forEach {<br>                it.text.background = boxBackground<br>            }<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-keyword">this</span>.background = boxBackground<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> EditText.<span class="hljs-title">addListener</span><span class="hljs-params">(index: <span class="hljs-type">Int</span>)</span></span> {<br>        setOnKeyListener { _, keyCode, _ -&gt;<br>            <span class="hljs-keyword">if</span> (keyCode == KeyEvent.KEYCODE_DEL) {<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.text.isNullOrEmpty()) {<br>                    toPreEditor(index)<br>                }<br>            }<br>            <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnKeyListener</span> <span class="hljs-literal">false</span><br>        }<br>        addTextChangedListener(<span class="hljs-keyword">object</span> : TextWatcher {<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ip: String = <span class="hljs-string">""</span><br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">beforeTextChanged</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">                s: <span class="hljs-type">CharSequence</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">                start: <span class="hljs-type">Int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                count: <span class="hljs-type">Int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                after: <span class="hljs-type">Int</span></span></span><br><span class="hljs-params"><span class="hljs-function">            )</span></span> {<br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTextChanged</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">                char: <span class="hljs-type">CharSequence</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">                start: <span class="hljs-type">Int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                before: <span class="hljs-type">Int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                count: <span class="hljs-type">Int</span></span></span><br><span class="hljs-params"><span class="hljs-function">            )</span></span> {<br>                <span class="hljs-keyword">if</span> (char.isNullOrEmpty()) {<br>                    ip = <span class="hljs-string">""</span><br>                    <span class="hljs-keyword">return</span><br>                }<br>                <span class="hljs-keyword">if</span> (char.length &gt; <span class="hljs-number">2</span>) {<br>                    <span class="hljs-keyword">val</span> s = char.toString().toIntOrNull() ?: <span class="hljs-built_in">Int</span>.MAX_VALUE<br>                    ip = <span class="hljs-keyword">if</span> (s &gt; <span class="hljs-number">255</span>) {<br>                        <span class="hljs-string">"255"</span><br>                    } <span class="hljs-keyword">else</span> {<br>                        <span class="hljs-string">"<span class="hljs-variable">$s</span>"</span><br>                    }<br>                    toNextEditor(index)<br>                } <span class="hljs-keyword">else</span> {<br>                    ip = char.toString()<br>                }<br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">afterTextChanged</span><span class="hljs-params">(s: <span class="hljs-type">Editable</span>?)</span></span> {<br>                removeTextChangedListener(<span class="hljs-keyword">this</span>)<br>                ips[index] = ip<br>                setText(ip)<br>                setSelection(ip.length)<br>                addTextChangedListener(<span class="hljs-keyword">this</span>)<br>            }<br><br>        })<br>        <span class="hljs-keyword">val</span> next = toNextEditor(index)<br>        imeOptions = <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>) {<br>            EditorInfo.IME_ACTION_NEXT or EditorInfo.IME_FLAG_NO_FULLSCREEN<br>        } <span class="hljs-keyword">else</span> {<br>            EditorInfo.IME_ACTION_DONE or EditorInfo.IME_FLAG_NO_FULLSCREEN<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toPreEditor</span><span class="hljs-params">(index: <span class="hljs-type">Int</span>)</span></span>: EditText? {<br>        <span class="hljs-keyword">return</span> editorViews.getOrNull(index - <span class="hljs-number">1</span>)?.let { prev -&gt;<br>            <span class="hljs-keyword">val</span> editText = prev.text<br>            <span class="hljs-keyword">if</span> (editText.isEnabled) {<br>                editText.requestFocus()<br>                editText.setSelection(editText.text.length)<br>                editText<br>            } <span class="hljs-keyword">else</span> {<br>                toPreEditor(index - <span class="hljs-number">1</span>)<br>            }<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toNextEditor</span><span class="hljs-params">(index: <span class="hljs-type">Int</span>)</span></span>: EditText? {<br>        <span class="hljs-keyword">return</span> editorViews.getOrNull(index + <span class="hljs-number">1</span>)?.let { next -&gt;<br>            <span class="hljs-keyword">val</span> editText = next.text<br>            <span class="hljs-keyword">if</span> (editText.isEnabled) {<br>                editText.requestFocus()<br>                editText.setSelection(editText.text.length)<br>                editText<br>            } <span class="hljs-keyword">else</span> {<br>                toNextEditor(index + <span class="hljs-number">1</span>)<br>            }<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setItemCount</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-meta">@androidx</span>.<span class="hljs-keyword">annotation</span>.IntRange(from = <span class="hljs-number">1</span>, to = <span class="hljs-number">4</span>)</span></span><br>        count: <span class="hljs-built_in">Int</span><br>    ) {<br>        <span class="hljs-keyword">this</span>.ipViewCount = count.coerceAtLeast(<span class="hljs-number">1</span>).coerceAtMost(<span class="hljs-number">4</span>)<br>        initView()<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setDisableItems</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> index: <span class="hljs-type">Int</span>)</span></span> {<br>        <span class="hljs-keyword">this</span>.itemDisableIndex = index.toSet()<br>        updateViewEnable()<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setSuffix</span><span class="hljs-params">(suffix: <span class="hljs-type">String</span>)</span></span> {<br>        <span class="hljs-keyword">this</span>.ipText = <span class="hljs-keyword">this</span>.ipText?.replace(<span class="hljs-keyword">this</span>.suffix, suffix)<br>        <span class="hljs-keyword">this</span>.suffix = suffix<br>        editorViews.forEachIndexed { _, v -&gt;<br>            v.suffixTextView?.text = suffix<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getIp</span><span class="hljs-params">()</span></span>: String {<br>        <span class="hljs-keyword">val</span> s = run {<br>            List(editorViews.size) { index -&gt;<br>                <span class="hljs-keyword">val</span> ip = ips.<span class="hljs-keyword">get</span>(index, <span class="hljs-string">""</span>)<br>                <span class="hljs-keyword">if</span> (ip.isNullOrEmpty()) {<br>                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@run</span> <span class="hljs-string">""</span><br>                }<br>                ip<br>            }.joinToString(suffix)<br>        }<br>        <span class="hljs-keyword">this</span>.ipText = s<br>        <span class="hljs-keyword">return</span> s<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setIp</span><span class="hljs-params">(ip: <span class="hljs-type">String</span>?)</span></span> {<br>        <span class="hljs-keyword">this</span>.ipText = ip<br>        updateIp()<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateIp</span><span class="hljs-params">()</span></span> {<br>        <span class="hljs-keyword">val</span> ip = ipText<br>        <span class="hljs-keyword">if</span> (ip.isNullOrEmpty()) {<br>            editorViews.forEach {<br>                it.text.text.clear()<br>            }<br>            <span class="hljs-keyword">return</span><br>        }<br>        <span class="hljs-keyword">val</span> temp = ip.split(suffix)<br>        <span class="hljs-keyword">if</span> (temp.isEmpty() || temp.size &lt; editorViews.size) {<br>            editorViews.forEach {<br>                it.text.text.clear()<br>            }<br>            <span class="hljs-keyword">return</span><br>        }<br>        editorViews.forEachIndexed { index, editorView -&gt;<br>            <span class="hljs-keyword">val</span> text = editorView.text<br>            <span class="hljs-keyword">val</span> s = temp[index].let {<br>                <span class="hljs-keyword">val</span> i = it.toIntOrNull() ?: <span class="hljs-number">0</span><br>                <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>) {<br>                    <span class="hljs-string">"0"</span><br>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">255</span>) {<br>                    <span class="hljs-string">"255"</span><br>                } <span class="hljs-keyword">else</span> {<br>                    it<br>                }<br>            }<br>            ips[index] = s<br>            text.setText(s)<br>        }<br>    }<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>attr-ip-editor-text.xml</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">declare-styleable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"IpEditorText"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipText"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"string"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"itemWidth"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"itemCount"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"integer"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"itemHeight"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--  define which items is not editable, multi index split with "," , such as "0,1,2" --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"itemDisableIndex"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"string"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"textSize"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"splitText"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"string"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"textColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"textDisableColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"layoutStyle"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">enum</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"one_piece"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">enum</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"separate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">attr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxStrokeColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxStrokeWidth"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxBackgroundColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxCornerRadius"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxCornerRadiusTopStart"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxCornerRadiusTopEnd"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxCornerRadiusBottomStart"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"boxCornerRadiusBottomEnd"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">declare-styleable</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>CustomView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Paging3相关</title>
    <link href="/2023/08/28/docs/android/view/recycleview/paging3-xiang-guan/"/>
    <url>/2023/08/28/docs/android/view/recycleview/paging3-xiang-guan/</url>
    
    <content type="html"><![CDATA[<h2 id="Paging局部修改数据"><a href="#Paging局部修改数据" class="headerlink" title="Paging局部修改数据"></a>Paging局部修改数据</h2><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//转成LiveData</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _pagerData: MutableLiveData&lt;PagingData&lt;Item&gt;&gt; =<br>    repository.pagingData.cachedIn(viewModelScope).asLiveData().let {<br>        it <span class="hljs-keyword">as</span> MutableLiveData&lt;PagingData&lt;Item&gt;&gt;<br>    }<br><br><span class="hljs-keyword">val</span> pagerData: LiveData&lt;PagingData&lt;Item&gt;&gt; <span class="hljs-keyword">get</span>() = _pagerData<br><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mod</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    old: <span class="hljs-type">Item</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">    new: <span class="hljs-type">Item</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span> {<br>    _pagerData.value?.map {<br>        <span class="hljs-keyword">if</span> (it.id == old.id) {<br>            new<br>        } <span class="hljs-keyword">else</span> {<br>            it<br>        }<br>    }.also {<br>        _pagerData.value = it<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><a href="https://sourcediving.com/crud-operations-with-the-new-android-paging-v3-5bf55110aa4d">这里还有一个不修改数据源实现的示例</a></p><h1 id="getRefreshKey示例"><a href="#getRefreshKey示例" class="headerlink" title="getRefreshKey示例"></a>getRefreshKey示例</h1><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRefreshKey</span><span class="hljs-params">(state: <span class="hljs-type">PagingState</span>&lt;<span class="hljs-type">Int</span>, Item&gt;)</span></span>: <span class="hljs-built_in">Int</span>? {<br>    <span class="hljs-keyword">return</span> state.anchorPosition?.let {<br>        state.closestPageToPosition(it)?.prevKey?.plus(<span class="hljs-number">1</span>)<br>            ?: state.closestPageToPosition(it)?.nextKey?.minus(<span class="hljs-number">1</span>)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>RecycleView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RecycleView多选功能示例，RecycleView-Selection</title>
    <link href="/2023/08/28/docs/android/view/recycleview/recycleview-selection/"/>
    <url>/2023/08/28/docs/android/view/recycleview/recycleview-selection/</url>
    
    <content type="html"><![CDATA[<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AFragment</span> : <span class="hljs-type">Fragment</span>() {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> tracker: SelectionTracker&lt;<span class="hljs-built_in">Long</span>&gt;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {<br>        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)<br>        <span class="hljs-comment">//......</span><br>        adapter = MyAdapter()<br><br>        recyclerView.adapter = adapter<br>        recyclerView.setHasFixedSize(<span class="hljs-literal">true</span>)<br><br>        tracker = SelectionTracker.Builder&lt;<span class="hljs-built_in">Long</span>&gt;(<br>            <span class="hljs-string">"appt_unreviewed_selection"</span>,<br>            recyclerView,<br>            MyAdapter.KeyProvider(recyclerView),<br>            MyAdapter.DetailsLookup(recyclerView),<br>            StorageStrategy.createLongStorage()<br>        ).withSelectionPredicate(MyAdapter.SelectionPredicate(recyclerView)).build()<br>        adapter.setSelectionTracker(tracker)<br>        tracker.addObserver(<span class="hljs-keyword">object</span> : SelectionTracker.SelectionObserver&lt;<span class="hljs-built_in">Long</span>&gt;() {<br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSelectionRefresh</span><span class="hljs-params">()</span></span> {<br>                <span class="hljs-keyword">super</span>.onSelectionRefresh()<br>                adapter.refreshSelection()<br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSelectionChanged</span><span class="hljs-params">()</span></span> {<br>                <span class="hljs-keyword">super</span>.onSelectionChanged()<br>                <span class="hljs-keyword">val</span> size = tracker.selection.size()<br>            }<br>        })<br>        <span class="hljs-comment">//......</span><br>    }<br><br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewStateRestored</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {<br>        <span class="hljs-keyword">super</span>.onViewStateRestored(savedInstanceState)<br>        tracker.onRestoreInstanceState(savedInstanceState)<br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSaveInstanceState</span><span class="hljs-params">(outState: <span class="hljs-type">Bundle</span>)</span></span> {<br>        <span class="hljs-keyword">super</span>.onSaveInstanceState(outState)<br>        tracker.onSaveInstanceState(outState)<br>    }<br><br>    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<br>        workerDispatcher: CoroutineDispatcher = Dispatchers.IO,<br>    ) : PagingDataAdapter&lt;Item, MyAdapter.MyHolder&gt;(<br>        diffCallback = COMPARATOR,<br>        workerDispatcher = workerDispatcher<br>    ) {<br>        <span class="hljs-comment">//......</span><br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">VisitAppointHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {<br>            holder.bindView(position, getData(position), PAYLOAD_ALL)<br>        }<br><br>        <span class="hljs-keyword">internal</span> <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHolder</span>(<br>            itemView: View,<br>            <span class="hljs-keyword">val</span> binding: ItemBinding<br>        ) : RecyclerView.ViewHolder(itemView) {<br><br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> details = ItemDetails()<br><br>            <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindView</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">                position: <span class="hljs-type">Int</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">data</span>: <span class="hljs-type">Item</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">                payload: <span class="hljs-type">Set</span>&lt;*&gt;</span></span><br><span class="hljs-params"><span class="hljs-function">            )</span></span> {<br>                <span class="hljs-comment">//val index = if (data == null) -position else position</span><br>                <span class="hljs-keyword">val</span> key = <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> == <span class="hljs-literal">null</span>) -position.toLong() <span class="hljs-keyword">else</span> position.toLong()<br>                details.setIndex(position)<br>                details.setKey(key)<br>                binding.tvNumber.tag = key<br>                <span class="hljs-comment">// .....</span><br>            }<br><br>        }<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemDetails</span> : <span class="hljs-type">ItemDetailsLookup.ItemDetails</span>&lt;<span class="hljs-type">Long</span>&gt;() {<br><br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mIndex: <span class="hljs-built_in">Int</span> = RecyclerView.NO_POSITION<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mKey: <span class="hljs-built_in">Long</span> = -<span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPosition</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {<br>                <span class="hljs-keyword">return</span> mIndex<br>            }<br><br>            <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setIndex</span><span class="hljs-params">(index: <span class="hljs-type">Int</span>)</span></span> {<br>                <span class="hljs-keyword">this</span>.mIndex = index<br>            }<br><br>            <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setKey</span><span class="hljs-params">(key: <span class="hljs-type">Long</span>)</span></span> {<br>                <span class="hljs-keyword">this</span>.mKey = key<br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSelectionKey</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {<br>                <span class="hljs-keyword">return</span> mKey<br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inSelectionHotspot</span><span class="hljs-params">(e: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inDragRegion</span><span class="hljs-params">(e: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {<br>                <span class="hljs-keyword">return</span> mKey &gt;= <span class="hljs-number">0</span><br>            }<br>        }<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailsLookup</span>(<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> recyclerView: RecyclerView<br>        ) : ItemDetailsLookup&lt;<span class="hljs-built_in">Long</span>&gt;() {<br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemDetails</span><span class="hljs-params">(e: <span class="hljs-type">MotionEvent</span>)</span></span>: ItemDetails&lt;<span class="hljs-built_in">Long</span>&gt;? {<br>                <span class="hljs-keyword">val</span> view = recyclerView.findChildViewUnder(e.x, e.y)<br>                <span class="hljs-keyword">val</span> viewHolder = view?.let {<br>                    <span class="hljs-keyword">try</span> {<br>                        recyclerView.getChildViewHolder(it)<br>                    } <span class="hljs-keyword">catch</span> (e: Throwable) {<br>                        <span class="hljs-literal">null</span><br>                    }<br>                }<br>                <span class="hljs-keyword">if</span> (viewHolder <span class="hljs-keyword">is</span> MyAdapter.MyHolder) {<br>                    <span class="hljs-keyword">return</span> viewHolder.getItemDetails()<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>            }<br>        }<br><br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyProvider</span>(<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> recyclerView: RecyclerView<br>        ) : ItemKeyProvider&lt;<span class="hljs-built_in">Long</span>?&gt;(SCOPE_MAPPED) {<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getKey</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Long</span>? {<br>                <span class="hljs-keyword">if</span> (position &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>                <span class="hljs-keyword">val</span> viewHolder = recyclerView.findViewHolderForAdapterPosition(position)<br>                <span class="hljs-keyword">if</span> (viewHolder <span class="hljs-keyword">is</span> MyAdapter.MyHolder) {<br>                    <span class="hljs-keyword">return</span> viewHolder.getItemDetails().selectionKey<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPosition</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> key: <span class="hljs-type">Long</span>)</span></span>: <span class="hljs-built_in">Int</span> {<br>                <span class="hljs-keyword">return</span> abs(key).toInt()<br>            }<br><br>        }<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectionPredicate</span>(<br>            <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> recyclerView: RecyclerView<br>        ) : SelectionTracker.SelectionPredicate&lt;<span class="hljs-built_in">Long</span>&gt;() {<br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">canSetStateForKey</span><span class="hljs-params">(key: <span class="hljs-type">Long</span>, nextState: <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {<br>                <span class="hljs-keyword">if</span> (!nextState) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>                <span class="hljs-keyword">return</span> key &gt;= <span class="hljs-number">0</span><br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">canSetStateAtPosition</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, nextState: <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {<br>                <span class="hljs-keyword">if</span> (!nextState) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>                <span class="hljs-keyword">if</span> (position &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>                <span class="hljs-keyword">val</span> viewHolder = recyclerView.findViewHolderForAdapterPosition(position)<br>                <span class="hljs-keyword">if</span> (viewHolder <span class="hljs-keyword">is</span> MyAdapter.MyHolder) {<br>                    <span class="hljs-keyword">return</span> canSetStateForKey(viewHolder.getItemDetails().selectionKey, nextState)<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>            }<br><br>            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">canSelectMultiple</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span><br><br>        }<br>    }<br><br>}<br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>RecycleView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RecycleView滑动删除</title>
    <link href="/2023/08/28/docs/android/view/recycleview/recycleview-hua-dong-shan-chu/"/>
    <url>/2023/08/28/docs/android/view/recycleview/recycleview-hua-dong-shan-chu/</url>
    
    <content type="html"><![CDATA[<h2 id="RecycleView实现滑动删除或拖动排序"><a href="#RecycleView实现滑动删除或拖动排序" class="headerlink" title="RecycleView实现滑动删除或拖动排序"></a>RecycleView实现滑动删除或拖动排序</h2><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Kotlin">ItemTouchHelper(<span class="hljs-keyword">object</span> : ItemTouchHelper.Callback() {<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMovementFlags</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        recyclerView: <span class="hljs-type">RecyclerView</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">        viewHolder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span></span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>: <span class="hljs-built_in">Int</span> {<br>        <span class="hljs-keyword">return</span> (viewHolder <span class="hljs-keyword">as</span>? MyAdapter.MyHolder)?.<span class="hljs-keyword">data</span>?.let {<br>            <span class="hljs-comment">//dragFlags 拖拽的方式</span><br>            <span class="hljs-comment">//swipeFlags 滑动触发的方式</span><br>            makeMovementFlags(<span class="hljs-number">0</span>, ItemTouchHelper.LEFT or ItemTouchHelper.RIGHT)<br>        } ?: makeMovementFlags(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    }<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMove</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        recyclerView: <span class="hljs-type">RecyclerView</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">        viewHolder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">        target: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span></span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span><br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSwiped</span><span class="hljs-params">(viewHolder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>, direction: <span class="hljs-type">Int</span>)</span></span> {<br>        (viewHolder <span class="hljs-keyword">as</span>? MyAdapter.MyHolder)?.<span class="hljs-keyword">data</span>?.let {<br>            <span class="hljs-comment">//删除某一项的操作</span><br>            <span class="hljs-comment">//model.onViewEvent(ItemViewEvents.Remove(it.id))</span><br>        }<br>    }<br>}).attachToRecyclerView(recyclerView)<br></code></pre></td></tr></tbody></table></figure><p><a href="https://github.com/BeauteousJade/SlideDeleteDemo">仿QQ侧滑删除示例</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>RecycleView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RecyclerView个性化设置</title>
    <link href="/2023/08/28/docs/android/view/recycleview/recyclerview-ge-xing-hua-she-zhi/"/>
    <url>/2023/08/28/docs/android/view/recycleview/recyclerview-ge-xing-hua-she-zhi/</url>
    
    <content type="html"><![CDATA[<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><h3 id="预览视图样式"><a href="#预览视图样式" class="headerlink" title="预览视图样式"></a>预览视图样式</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">tools:itemCount="13" //预览item数量<br>        tools:listitem="@layout/item_goal" //预览item视图<br>        tools:itemCount="5" //线性布局item数量<br>        tools:layoutManager="androidx.recyclerview.widget.GridLayoutManager" //预览布局管理器<br>        tools:spanCount="5" //网格布局列数<br></code></pre></td></tr></tbody></table></figure><h3 id="滑动到底部时显示padding，滑动过程中不显示"><a href="#滑动到底部时显示padding，滑动过程中不显示" class="headerlink" title="滑动到底部时显示padding，滑动过程中不显示"></a>滑动到底部时显示padding，滑动过程中不显示</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:clipToPadding="false"<br>        android:paddingBottom="60dp"<br></code></pre></td></tr></tbody></table></figure><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="加载item动画"><a href="#加载item动画" class="headerlink" title="加载item动画"></a>加载item动画</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> InnerHolder holder,<span class="hljs-type">int</span> position)</span>{<br>        holder.binding.getRoot().setAnimation(AnimationUtils.loadAnimation(holder.itemView.getContext(),R.anim.scale));<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="设置间距"><a href="#设置间距" class="headerlink" title="设置间距"></a>设置间距</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">SpaceItemDecoration dividerItemDecoration=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SpaceItemDecoration</span>(<span class="hljs-number">16</span>);<br>        binding.recyclerView.addItemDecoration(dividerItemDecoration);<br></code></pre></td></tr></tbody></table></figure><h3 id="加载更多"><a href="#加载更多" class="headerlink" title="加载更多"></a>加载更多</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isLoading;<br><br>        binding.recyclerView.addOnScrollListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RecyclerView</span>.OnScrollListener(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onScrolled</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> RecyclerView recyclerView,<span class="hljs-type">int</span> dx,<span class="hljs-type">int</span> dy)</span>{<br>        <span class="hljs-keyword">if</span>(dy&lt;=<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        <span class="hljs-type">boolean</span> slideToBottom=RecyclerViewUtils.isSlideToBottom(recyclerView);<br>        <span class="hljs-keyword">if</span>(slideToBottom){<br>        <span class="hljs-type">boolean</span> nextPage=viewModel.getPagingResult().isNextPage();<br>        <span class="hljs-keyword">if</span>(nextPage&amp;&amp;!isLoading){<br>        isLoading=<span class="hljs-literal">true</span>;<br>        binding.progressBar.setVisibility(View.VISIBLE);<br>        viewModel.loadFoodList();<br>        }<br>        }<br>        }<br>        });<br></code></pre></td></tr></tbody></table></figure><h3 id="判断滑动状态-是否到底部"><a href="#判断滑动状态-是否到底部" class="headerlink" title="判断滑动状态 是否到底部"></a>判断滑动状态 是否到底部</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSlideToBottom</span><span class="hljs-params">(RecyclerView recyclerView)</span>{<br>        <span class="hljs-keyword">if</span>(recyclerView==<span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> recyclerView.computeVerticalScrollExtent()+recyclerView.computeVerticalScrollOffset()&gt;=<br>        recyclerView.computeVerticalScrollRange();<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="流式布局"><a href="#流式布局" class="headerlink" title="流式布局"></a>流式布局</h2><ol><li>引入google流式布局<br>google/flexbox-layout： Flexbox for Android (github.com)</li></ol><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy">dependencies {<br>    implementation <span class="hljs-string">'com.google.android.flexbox:flexbox:3.0.0'</span><br>}<br></code></pre></td></tr></tbody></table></figure><ol start="2"><li>使用</li></ol><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">FlexboxLayoutManager manager=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FlexboxLayoutManager</span>(requireContext());<br>        binding.recyclerView.setLayoutManager(manager);<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
      <category>RecycleView</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EditText属性配置</title>
    <link href="/2023/08/27/docs/android/view/edittext/"/>
    <url>/2023/08/27/docs/android/view/edittext/</url>
    
    <content type="html"><![CDATA[<h3 id="一些-inputType-属性值"><a href="#一些-inputType-属性值" class="headerlink" title="一些 inputType 属性值"></a>一些 <code>inputType</code> 属性值</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs routeros">android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"none"</span>--输入普通字符<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"text"</span>--输入普通字符<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textCapWords"</span>--单词首字母大小<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textCapSentences"</span>--仅第一个字母大小<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textAutoCorrect"</span>--前两个自动完成<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textAutoComplete"</span>--前两个自动完成<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textMultiLine"</span>--多行输入<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textImeMultiLine"</span>--输入法多行（不一定支持）<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textNoSuggestions"</span>--不提示<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textUri"</span>--URI格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textEmailAddress"</span>--电子邮件地址格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textEmailSubject"</span>--邮件主题格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textShortMessage"</span>--短消息格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textLongMessage"</span>--长消息格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textPersonName"</span>--人名格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textPostalAddress"</span>--邮政格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textPassword"</span>--密码格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textVisiblePassword"</span>--密码可见格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textWebEditText"</span>--作为网页表单的文本格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textFilter"</span>--文本筛选格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"textPhonetic"</span>--拼音输入格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"number"</span>--数字格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"numberSigned"</span>--有符号数字格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"numberDecimal"</span>--可以带小数点的浮点格式<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"phone"</span>--拨号键盘<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"datetime"</span><br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"date"</span>--日期键盘<br><br>android:<span class="hljs-attribute">inputType</span>=<span class="hljs-string">"time"</span>--时间键盘<br></code></pre></td></tr></tbody></table></figure><h3 id="清单文件里面键盘的属性"><a href="#清单文件里面键盘的属性" class="headerlink" title="清单文件里面键盘的属性"></a>清单文件里面键盘的属性</h3><p><code>android:windowSoftInputMode</code></p><figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-string">"stateUnspecified"</span><br><br>软键盘的状态<span class="hljs-comment">(是否它是隐藏或可见)</span>没有被指定。系统将选择一个合适的状态或依赖于主题的设置。<br><br>这个是软键盘行为默认的设置。<br><br><span class="hljs-string">"stateUnchanged"</span><br><br>软键盘被保持无论它上次是什么状态，是否可见或隐藏，当主窗口出现在前面时。<br><br><span class="hljs-string">"stateHidden"</span><br><br>当用户选择该Activity时，软键盘被隐藏——也就是，当用户确定导航到该Activity时，而不是返回到它由于离开另一个Activity。<br><br><span class="hljs-string">"stateAlwaysHidden"</span><br><br>软键盘总是被隐藏的，当该Activity主窗口获取焦点时。<br><br><span class="hljs-string">"stateVisible"</span><br><br>软键盘是可见的，当那个是正常合适的时<span class="hljs-comment">(当用户导航到Activity主窗口时)</span>。<br><br><span class="hljs-string">"stateAlwaysVisible"</span><br><br>当用户选择这个Activity时，软键盘是可见的——也就是，也就是，当用户确定导航到该Activity时，而不是返回到它由于离开另一个Activity。<br><br><span class="hljs-string">"adjustUnspecified"</span><br><br>它不被指定是否该Activity主 窗口调整大小以便留出软键盘的空间，或是否窗口上的内容得到屏幕上当前的焦点是可见的。<br><br>系统将自动选择这些模式中一种主要依赖于是否窗口的内容有任何布局 视图能够滚动他们的内容。如果有这样的一个视图，<br><br>这个窗口将调整大小，这样的假设可以使滚动窗口的内容在一个较小的区域中可见的。这个是主窗口默认的行为 设置。<br><br><span class="hljs-string">"adjustResize"</span><br><br>该Activity主窗口总是被调整屏幕的大小以便留出软键盘的空间<br><br><span class="hljs-string">"adjustPan"</span><br><br>该Activity主窗口并不调整屏幕的大小以便留出软键盘的空间。相反，当前窗口的内容将自动移动以便当前焦点从不被键盘覆盖和用户能总是看到输入内容的部分。<br><br>这个通常是不期望比调整大小，因为用户可能关闭软键盘以便获得与被覆盖内容的交互操作。<br></code></pre></td></tr></tbody></table></figure><h3 id="禁止EditText横屏键盘全屏"><a href="#禁止EditText横屏键盘全屏" class="headerlink" title="禁止EditText横屏键盘全屏"></a>禁止EditText横屏键盘全屏</h3><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">android:</span>imeOptions=<span class="hljs-string">"flagNoExtractUi"</span><br></code></pre></td></tr></tbody></table></figure><p>注意 若在切换横竖屏后页面显示不全需要追加属性 <code>flagNoFullscreen</code></p><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">android:</span>imeOptions=<span class="hljs-string">"flagNoExtractUi|flagNoFullscreen"</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RadioButton属性</title>
    <link href="/2023/08/27/docs/android/view/radiobutton/"/>
    <url>/2023/08/27/docs/android/view/radiobutton/</url>
    
    <content type="html"><![CDATA[<h1 id="RadioButton"><a href="#RadioButton" class="headerlink" title="RadioButton"></a>RadioButton</h1><h2 id="切换文字和按钮布局"><a href="#切换文字和按钮布局" class="headerlink" title="切换文字和按钮布局"></a>切换文字和按钮布局</h2><p>RadioButton默认选择框是在左边显示的，文字显示在右边。</p><p>在某些场景下，我们想在右边显示选择框，左边显示文字，给RadioButton 添加一下两个属性就可实现这种效果</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:layoutDirection="rtl"<br>        android:textDirection="ltr"<br></code></pre></td></tr></tbody></table></figure><p>两个属性的值分别设置成 <code>ltr</code> 和 <code>rtl</code> 可以实现4种布局效果</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TextView属性</title>
    <link href="/2023/08/27/docs/android/view/textview-shu-xing/"/>
    <url>/2023/08/27/docs/android/view/textview-shu-xing/</url>
    
    <content type="html"><![CDATA[<h2 id="TextView-跑马灯"><a href="#TextView-跑马灯" class="headerlink" title="TextView 跑马灯"></a>TextView 跑马灯</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/textView"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"40sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:singleLine</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:ellipsize</span>=<span class="hljs-string">"marquee"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:focusableInTouchMode</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:focusable</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:clickable</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:marqueeRepeatLimit</span>=<span class="hljs-string">"marquee_forever"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"人民日报生活漫步：莫让千元打车费毁了专车"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml">focusableInTouchMode="true"<br>        focusable="true"<br>        clickable="true"<br>        singleLine="true"<br>        android:ellipsize="marquee"<br></code></pre></td></tr></tbody></table></figure><p>以上五个属性必须设置</p><p><code>marqueeReatLimit</code>属性是滚动重复次数，设置为<code>marquee_forever</code> 意思为一直都是滚动模式。</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TextView限制输入内容</title>
    <link href="/2023/08/27/docs/android/view/textview-xian-zhi-shu-ru-nei-rong/"/>
    <url>/2023/08/27/docs/android/view/textview-xian-zhi-shu-ru-nei-rong/</url>
    
    <content type="html"><![CDATA[<h3 id="EditText限制只能输入汉字"><a href="#EditText限制只能输入汉字" class="headerlink" title="EditText限制只能输入汉字"></a>EditText限制只能输入汉字</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * EditText限制只能输入汉字</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> InputFilter <span class="hljs-title function_">getInputFilter</span><span class="hljs-params">()</span>{<br>        InputFilter filter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputFilter</span>(){<br><span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source,<span class="hljs-type">int</span> start,<span class="hljs-type">int</span> end,</span><br><span class="hljs-params">        Spanned dest,<span class="hljs-type">int</span> dstart,<span class="hljs-type">int</span> dend)</span>{<br>        <span class="hljs-keyword">if</span>(TextUtils.isEmpty(source)){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">""</span>;<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=start;i&lt;end; i++){<br>        <span class="hljs-keyword">if</span>(stringFilterChinese(source)&amp;&amp;!source.toString().contains(<span class="hljs-string">"。"</span>)&amp;&amp;!source.toString().contains(<span class="hljs-string">"，"</span>)){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">""</span>;<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(CHINESE_RADICAL_DIGISTS.contains(source)){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">""</span>;<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        };<br>        <span class="hljs-keyword">return</span> filter;<br>        }<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 限制只能输入汉字，过滤非汉字</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> str 输入值</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> true 非汉字；false 汉字</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">stringFilterChinese</span><span class="hljs-params">(CharSequence str)</span>{<br>        <span class="hljs-comment">//只允许汉字，正则表达式匹配出所有非汉字</span><br>        String regEx=<span class="hljs-string">"[^\u4E00-\u9FA5]"</span>;<br>        Pattern p=Pattern.compile(regEx);<br>        Matcher m=p.matcher(str);<br>        <span class="hljs-keyword">if</span>(m.find()){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        }<br>        mEdtAddDictation.setFilters(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputFilter</span>[]{getInputFilter()});<br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>View</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android目录文件简析</title>
    <link href="/2023/08/26/docs/android/qi-ta/android-mu-lu-wen-jian-jian-xi/"/>
    <url>/2023/08/26/docs/android/qi-ta/android-mu-lu-wen-jian-jian-xi/</url>
    
    <content type="html"><![CDATA[<h1 id="Android目录文件简析"><a href="#Android目录文件简析" class="headerlink" title="Android目录文件简析"></a>Android目录文件简析</h1><p>[TOC]</p><h2 id="根目录"><a href="#根目录" class="headerlink" title="根目录"></a>根目录</h2><h3 id="data"><a href="#data" class="headerlink" title="data"></a>data</h3><p>data分区</p><h4 id="app"><a href="#app" class="headerlink" title="app"></a>app</h4><p>用户安装的软件都在这里面,一个包名一个文件夹</p><h5 id="oat-arm-base-art-base-odex-base-vdex"><a href="#oat-arm-base-art-base-odex-base-vdex" class="headerlink" title="oat/arm/base.art,base.odex,base.vdex"></a>oat/arm/base.art,base.odex,base.vdex</h5><p>用户运行应用，而这随后就会触发 ART 加载 .dex 文件。<br>如果有 .oat 文件（即 .dex 文件的 AOT 二进制文件），则 ART 会直接使用该文件，软件速度会明显提升。删除这个文件夹一般不会影响软件功能，但是软件速度会明显变慢。<br>有Speed编译方式和Everything编译</p><h4 id="dalvik-cache"><a href="#dalvik-cache" class="headerlink" title="dalvik-cache"></a>dalvik-cache</h4><p>里面有arm和arm64文件夹，存放软件编译后的文件，这些文件删除后会重新生成。</p><h4 id="data-1"><a href="#data-1" class="headerlink" title="data"></a>data</h4><p>软件数据目录</p><h4 id="media"><a href="#media" class="headerlink" title="media"></a>media</h4><h5 id="0"><a href="#0" class="headerlink" title="0"></a>0</h5><p>手机内部存储分区</p><h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><h5 id="locksettings-db"><a href="#locksettings-db" class="headerlink" title="locksettings.db"></a>locksettings.db</h5><p>锁屏密码文件，删除此文件即可删除手机锁屏密码</p><h3 id="dev"><a href="#dev" class="headerlink" title="dev"></a>dev</h3><p>手机各分区文件</p><h3 id="etc"><a href="#etc" class="headerlink" title="etc"></a>etc</h3><h4 id="host"><a href="#host" class="headerlink" title="host"></a>host</h4><figure class="highlight accesslog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> localhost<br>::         1ip6-localhost<br></code></pre></td></tr></tbody></table></figure><p>可以修改此文件达到去广告或限制手机访问某些域名的目的<br>比如加上<code>127.0.0.1  baidu.com</code> ，手机就访问不了百度了</p><h3 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h3><h4 id="wifi"><a href="#wifi" class="headerlink" title="wifi"></a>wifi</h4><h5 id="WifiConfigStore-xml"><a href="#WifiConfigStore-xml" class="headerlink" title="WifiConfigStore.xml"></a>WifiConfigStore.xml</h5><p>这个文件存放手机连接的WiFi信息，打开可以查看手机连接过的所有WiFi密码信息</p><h3 id="sbin"><a href="#sbin" class="headerlink" title="sbin"></a>sbin</h3><h3 id="sdcard"><a href="#sdcard" class="headerlink" title="sdcard"></a>sdcard</h3><p>实质上是一个快捷方式，指向<code>data/media/0</code></p><h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><p><code>storage/emulated/0</code> 也是 <code>data/media/0</code> 手机内部存储目录</p><h3 id="system-1"><a href="#system-1" class="headerlink" title="system"></a>system</h3><h4 id="app-1"><a href="#app-1" class="headerlink" title="app"></a>app</h4><p>系统级非核心软件，删除里面的软件系统不一定会崩溃</p><h4 id="data-app"><a href="#data-app" class="headerlink" title="data-app"></a>data-app</h4><p>不是必有的文件夹，有些系统会预装很多软件，即使卸载后，再恢复出厂设置就又会出现，这些预装软件就是放在这里面的，系统第一次初始化时会把这些软件安装到data分区</p><h4 id="priv-app"><a href="#priv-app" class="headerlink" title="priv-app"></a>priv-app</h4><p>安卓4.4增加的新分区，主要是存放系统的系统级核心应用，比如电话，短信，设置，SystemUI等，这些应用需要系统级权限，而又不能被用户卸载掉，删除里面的软件后系统会崩溃</p><h3 id="xbin"><a href="#xbin" class="headerlink" title="xbin"></a>xbin</h3><p>如果使用普通方式 root，里面会有<code>su</code>文件，可以通过此方式判断设备有没有被 root，但是如果是用的<code>magisk</code><br>进行root不会有这个文件，<code>magisk</code>可以隐藏 root（现在应该有别的方式去判断是否有root权限，Magisk应该也有别的方式去隐藏root）</p><h3 id="media-1"><a href="#media-1" class="headerlink" title="media"></a>media</h3><p>系统媒体文件夹</p><h4 id="audio"><a href="#audio" class="headerlink" title="audio"></a>audio</h4><h4 id="alarm"><a href="#alarm" class="headerlink" title="alarm"></a>alarm</h4><p>系统预设闹铃铃声</p><h4 id="notification"><a href="#notification" class="headerlink" title="notification"></a>notification</h4><p>系统预设通知铃声</p><h4 id="ringtones"><a href="#ringtones" class="headerlink" title="ringtones"></a>ringtones</h4><p>系统预设电话铃声</p><h4 id="ui"><a href="#ui" class="headerlink" title="ui"></a>ui</h4><p>系统各种UI提示音<br>比如拍照快门声，充电音效，锁屏音效等</p><h4 id="lockscreen，wallpager"><a href="#lockscreen，wallpager" class="headerlink" title="lockscreen，wallpager"></a>lockscreen，wallpager</h4><p>系统预设壁纸</p><h4 id="bootanimation-zip"><a href="#bootanimation-zip" class="headerlink" title="bootanimation.zip"></a>bootanimation.zip</h4><p>开机动画，里面是包含一个<code>desc.txt</code>文件和若干个<code>part</code>文件夹<br><code>part</code> 文件夹里面是动画的每一帧<br><code>desc</code> 文件用来描述动画属性</p><h3 id="build-prop"><a href="#build-prop" class="headerlink" title="build.prop"></a>build.prop</h3><p>系统配置属性文件<br>正确的修改可以自定义系统某些特性。<br>下面是里面部分内容所代表的意思</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ro.boot.<span class="hljs-attribute">selinux</span>=permissive<br>permissive模式<br><br><span class="hljs-comment">#音量阶数</span><br>ro.config.media_vol_steps = 30<br><br><span class="hljs-comment">#增加虚拟键</span><br>qemu.hw.<span class="hljs-attribute">mainkeys</span>=0<br><br><span class="hljs-comment">#谷歌相机</span><br>persist.camera.HAL3.<span class="hljs-attribute">enabled</span>=1<br><br><span class="hljs-comment">#增加虚拟键</span><br>qemu.hw.<span class="hljs-attribute">mainkeys</span>=0<br><br><span class="hljs-comment">#渲染GPU的UI</span><br>debug.sf.<span class="hljs-attribute">hw</span>=1<br><br><span class="hljs-comment">#禁用开机动画</span><br>debug.sf.<span class="hljs-attribute">nobootanimation</span>=1<br></code></pre></td></tr></tbody></table></figure><h3 id="vendor"><a href="#vendor" class="headerlink" title="vendor"></a>vendor</h3><p>安卓8新加的分区<br>有<code>vendor</code>分区不一定支持<code>PT（ProjectTreble）</code>，支持<code>PT</code>的一定有<code>vendor</code>分区<br>这里面存放底层芯片硬件驱动等</p><h2 id="Xposed"><a href="#Xposed" class="headerlink" title="Xposed"></a>Xposed</h2><p><code>Xposed</code> 是一款开源框架，可以在不修改APK的情况下影响程序运行(修改系统)的框架服务，基于它可以制作出许多功能强大的模块，且在功能不冲突的情况下同时运作。<br><code>Xposed</code> 具有比较高的可定制化程度。用户可定制手机的外观、状态等几乎所有东西，<br><code>Xposed</code>的主要作用是hook应用方法，动态劫持方法的运行逻辑。<br>需要用 <code>Xposed管理器</code> 配合相关 <code>XP模块</code> 来使用。<br>目前<code>Xposed</code> 已经停止维护，在高版本安卓上面已经不能使用了，取而代之的有<code>Edxposed</code>、<code>LSPosed</code>等<br><code>Xp模块</code>也是一个apk，编写时引用的<code>XposedBridgeApi.jar</code>，<code>Mainfest.xml</code>文件加入以下标签</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"xposedmodule"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"xposeddescription"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"这是一个xposed应用"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"xposedminversion"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"54"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>然后编写hook工具类，重写<code>handleLoadPakage</code>方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XposedHookUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IXposedHookLoadPackage</span> {<br>    <span class="hljs-type">String</span> <span class="hljs-variable">class_name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.hdc.xposeddemo.MainActivity"</span>;<br><br>    <span class="hljs-comment">// 对指定包名,指定方法进行hook，将其修改成自己的方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLoadPackage</span><span class="hljs-params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="hljs-keyword">throws</span> Throwable {<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> loadPackageParam.classLoader.loadClass(class_name);<br>        XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">"getTTAd"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_MethodReplacement</span>() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">replaceHookedMethod</span><span class="hljs-params">(MethodHookParam methodHookParam)</span> <span class="hljs-keyword">throws</span> Throwable {<br>                xxxx;<br>            }<br>        });<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>常用的Xposed模块：QX，微X，应用变量等</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ContentResolver</title>
    <link href="/2023/08/26/docs/android/qi-ta/contentresolver/"/>
    <url>/2023/08/26/docs/android/qi-ta/contentresolver/</url>
    
    <content type="html"><![CDATA[<h2 id="ContentResolver"><a href="#ContentResolver" class="headerlink" title="ContentResolver"></a>ContentResolver</h2><h3 id="遍历其他类型文件"><a href="#遍历其他类型文件" class="headerlink" title="遍历其他类型文件"></a>遍历其他类型文件</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Kotlin"><span class="hljs-keyword">val</span> cursor: Cursor? = requireContext().contentResolver.query(<br>    <span class="hljs-comment">//数据源</span><br>    MediaStore.Files.getContentUri(<span class="hljs-string">"external"</span>),<br>    <span class="hljs-comment">// 想要查询的信息</span><br>    arrayOf(<br>        MediaStore.Files.FileColumns._ID,<br>        MediaStore.Files.FileColumns.TITLE,<br>        MediaStore.Files.FileColumns.DISPLAY_NAME,<br>    ),<br>    <span class="hljs-comment">//条件为文件类型</span><br>    MediaStore.Files.FileColumns.MIME_TYPE + <span class="hljs-string">"= ?"</span>,<br>    arrayOf(<br>        MimeTypeMap.getSingleton().getMimeTypeFromExtension(<span class="hljs-string">"docx"</span>),<br>        MimeTypeMap.getSingleton().getMimeTypeFromExtension(<span class="hljs-string">"pdf"</span>),<br>        MimeTypeMap.getSingleton().getMimeTypeFromExtension(<span class="hljs-string">"doc"</span>),<br>        MimeTypeMap.getSingleton().getMimeTypeFromExtension(<span class="hljs-string">"xls"</span>),<br>        MimeTypeMap.getSingleton().getMimeTypeFromExtension(<span class="hljs-string">"xlsx"</span>),<br>    ),<br>    <span class="hljs-comment">//默认排序</span><br>    <span class="hljs-literal">null</span><br>)<br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AndroidSamples</title>
    <link href="/2023/08/26/docs/android/qi-ta/androidsamples/"/>
    <url>/2023/08/26/docs/android/qi-ta/androidsamples/</url>
    
    <content type="html"><![CDATA[<h2 id="AndroidSamples"><a href="#AndroidSamples" class="headerlink" title="AndroidSamples"></a>AndroidSamples</h2><p><a href="https://github.com/android">Android</a></p><p><a href="git@github.com:sifutang/Camera1Demo.git">Camera1</a></p><p><a href="git@github.com:shalutd/DataStoreDemo.git">DataStoreDemo</a></p><p><a href="git@github.com:haiyangwu/mediasoup-demo-android.git">mediasoup-demo-android</a></p><p><a href="git@github.com:googlesamples/mlkit.git">MLKit</a></p><p><a href="https://github.com/saki4510t/UVCCamera">UVCCamera</a></p><p><a href="git@github.com:android/android-test.git">android-test</a></p><p><a href="git@github.com:googlecodelabs/android-compose-codelabs.git">android-compose-codelabs</a></p><p><a href="git@github.com:android/animation-samples.git">animation-samples</a></p><p><a href="git@github.com:android/background-tasks-samples.git">background-tasks-samples</a></p><p><a href="git@github.com:android/camera-samples.git">camera-samples</a></p><p><a href="https://github.com/android/compose-samples.git">compose-samples</a></p><p><a href="git@github.com:android/graphics-samples.git">graphics-samples</a></p><p><a href="https://github.com/material-components/material-components-android">material-components-android</a></p><p><a href="git@github.com:android/permissions-samples.git">permissions-samples</a></p><p><a href="git@github.com:android/testing-samples.git">testing-samples</a></p><p><a href="git@github.com:android/user-interface-samples.git">user-interface-samples</a></p><p><a href="git@github.com:android/views-widgets-samples.git">views-widgets-samples</a></p><p><a href="https://github.com/vcaen/splashscreen-sample.git">splashscreen-sample</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WebRTC编译</title>
    <link href="/2023/08/26/docs/android/qi-ta/webrtc-bian-yi/"/>
    <url>/2023/08/26/docs/android/qi-ta/webrtc-bian-yi/</url>
    
    <content type="html"><![CDATA[<p><a href="https://glumes.com/post/webrtc/webrtc-android-setup/">https://glumes.com/post/webrtc/webrtc-android-setup/</a></p><h4 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h4><p>下载工具,安装一些基础的软件依赖</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get update<br>sudo apt-get install -y openssl vim git gcc g++ curl python build-essential inetutils-ping net-tools sudo lsb-release libxml2<br></code></pre></td></tr></tbody></table></figure><p>下载depot_tools</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git<br></code></pre></td></tr></tbody></table></figure><p>配置环境</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 配置环境，打开.bashrc文件</span><br>gedit ~/.bashrc<br><span class="hljs-comment"># 在这文件添加如下内容</span><br><span class="hljs-comment"># depot_tools_path</span><br><span class="hljs-built_in">export</span> DEPOT_TOOLS_PATH=/root/work/webrtc/depot_tools<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">${PATH}</span>:<span class="hljs-variable">${DEPOT_TOOLS_PATH}</span><br><span class="hljs-comment"># 使环境生效</span><br><span class="hljs-built_in">source</span> ~/.bashrc<br><span class="hljs-comment"># 查看是否设置成功</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br>fetch --<span class="hljs-built_in">help</span><br></code></pre></td></tr></tbody></table></figure><p>建立源码路径，下载好源码（漫长的过程）后期更新只需要执行 gclient sync 即可</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> webrtc<br><span class="hljs-built_in">cd</span> webrtc<br>fetch --nohooks webrtc_android<br>gclient <span class="hljs-built_in">sync</span><br></code></pre></td></tr></tbody></table></figure><h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><p>下载完 WebRTC 后需要安装相关的依赖，进入到 WebRTC 源码的 <code>src</code> 目录中，执行如下命令：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> src<br>./build/install-build-deps.sh --no-chromeos-fonts<br>./build/install-build-deps-android.sh --no-chromeos-fonts<br></code></pre></td></tr></tbody></table></figure><p>执行shell脚本时报错：: 没有那个文件或目录<br>是因为该文件在windows系统上打开过，关闭后其中的空格符号和Linux的不同，导致这个报错，我们可以通过sed命令与正则的配合将文件中的空格符号替换成linux的空格：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">'s/\r$//'</span> xxx.sh<br></code></pre></td></tr></tbody></table></figure><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>设置编译参数，生成ninja文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># source ./build/android/envsetup.sh</span><br><br>gn gen out/build --args=<span class="hljs-string">'target_os="android" target_cpu="arm64" is_debug=false treat_warnings_as_errors=false'</span><br><span class="hljs-comment"># out/build ： 编译生成文件的目录，随意指定</span><br><span class="hljs-comment"># target_os ： 编译目标平台 android ios 等</span><br><span class="hljs-comment"># target_cpu ： CPU架构平台 arm arm64 x86 x64等</span><br><span class="hljs-comment"># is_debug : Release模式或者Debug模式</span><br></code></pre></td></tr></tbody></table></figure><p>清理目录</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gn clean out/build<br></code></pre></td></tr></tbody></table></figure><p>编译</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#全量编译</span><br>ninja -C out/build<br>    <br>ninja -C out/build AppRTCMobile<br><br><span class="hljs-comment">#编译组合</span><br>a)编译arm debug版本<br>    gn gen out/Debug_arm --args=<span class="hljs-string">'target_os="android" target_cpu="arm" treat_warnings_as_errors=false'</span><br>    ninja -C out/Debug_arm<br>b)编译arm64 debug版本<br>    gn gen out/Debug_arm64 --args=<span class="hljs-string">'target_os="android" target_cpu="arm64" treat_warnings_as_errors=false'</span><br>    ninja -C out/Debug_arm64<br>c)编译arm release版本<br>    gn gen out/Release_arm --args=<span class="hljs-string">'target_os="android" target_cpu="arm" is_debug=false treat_warnings_as_errors=false'</span><br>    ninja -C out/Release_arm<br>d)编译arm64 release版本<br>    gn gen out/Release_arm64 --args=<span class="hljs-string">'target_os="android" target_cpu="arm64" is_debug=false treat_warnings_as_errors=false'</span><br>    ninja -C out/Release_arm64<br></code></pre></td></tr></tbody></table></figure><p>生成aar</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> webrtc/src<br>python tools_webrtc/android/build_aar.py --output <span class="hljs-string">"libwebrtc.aar"</span> --<span class="hljs-built_in">arch</span> <span class="hljs-string">"armeabi-v7a"</span> <span class="hljs-string">"arm64-v8a"</span> --build-dir out/Release  --extra-gn-args <span class="hljs-string">'is_debug=false is_component_build=false is_clang=true rtc_include_tests=false rtc_use_h264=true rtc_enable_protobuf=false use_rtti=true use_custom_libcxx=false treat_warnings_as_errors=false'</span> <br><br>//只编译 arm64<br>python tools_webrtc/android/build_aar.py --output <span class="hljs-string">"libwebrtc.aar"</span> --<span class="hljs-built_in">arch</span> <span class="hljs-string">"arm64-v8a"</span> --build-dir out/Release  --extra-gn-args <span class="hljs-string">'is_debug=false is_component_build=false is_clang=true rtc_include_tests=false rtc_use_h264=true rtc_enable_protobuf=false use_rtti=true use_custom_libcxx=false treat_warnings_as_errors=false'</span><br><br><br><span class="hljs-comment"># 成功后你会在src目录下看到libwebrtc.aar文件，里面就是Android开发需要用到的SDK了。</span><br><span class="hljs-comment"># out/Release目录是编译目录，第一编译会全量编译速度很慢（预计30~40分钟），以后就增量编译很快（预计10s内）。</span><br></code></pre></td></tr></tbody></table></figure><p>生成so文件，生成so文件首次会全量编译，后续增量编译速度非常快。如果以后只改C层代码不生成Java或者Object-C的API，这种方法非常适合测试。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ninja -C out/Release sdk/android:libjingle_peerconnection_so<br></code></pre></td></tr></tbody></table></figure><h4 id="编译mediasoupclient"><a href="#编译mediasoupclient" class="headerlink" title="编译mediasoupclient"></a>编译mediasoupclient</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/work/libmediasoupclient<br><br>cmake . -Bbuild \<br>  -DLIBWEBRTC_INCLUDE_PATH:PATH=/root/work/webrtc/webrtc_android/src \<br>  -DLIBWEBRTC_BINARY_PATH:PATH=/root/work/webrtc/webrtc_android/src/out/build/obj<br><br>make -C build/<br></code></pre></td></tr></tbody></table></figure><p>安装包时可能会因为依赖其他包而安装失败，可以使用aptitude安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装aptitude</span><br>sudo apt-get install aptitude<br><span class="hljs-comment"># 安装所需要的包</span><br>sudo aptitude install xxxxx<br></code></pre></td></tr></tbody></table></figure><p>或者 <a href="https://launchpad.net/ubuntu">https://launchpad.net/ubuntu</a> 搜索需要的deb包，然后到本地下载，然后dpkg -i xxx.deb</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安卓杂记</title>
    <link href="/2023/08/26/docs/android/qi-ta/an-zhuo-za-ji/"/>
    <url>/2023/08/26/docs/android/qi-ta/an-zhuo-za-ji/</url>
    
    <content type="html"><![CDATA[<h2 id="安卓杂记"><a href="#安卓杂记" class="headerlink" title="安卓杂记"></a>安卓杂记</h2><h3 id="Volley（网络请求）"><a href="#Volley（网络请求）" class="headerlink" title="Volley（网络请求）"></a>Volley（网络请求）</h3><ul><li>依赖</li></ul><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">implementation <span class="hljs-string">'com.android.volley:volley:1.1.1'</span><br></code></pre></td></tr></tbody></table></figure><ul><li>请求</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">RequestQueue queue=Volley.newRequestQueue(<span class="hljs-built_in">this</span>);<br>    String url=<span class="hljs-string">""</span>;<br>    JsonObjectRequest request=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonObjectRequest</span>(GET,url,object,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>.Listener&lt;JSONObject&gt;(),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>.ErrorListener());<br>    queue.add(request);<br></code></pre></td></tr></tbody></table></figure><ul><li><p>停止请求：</p><p>方法一：</p>  <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">request.setTag(TAG);<br>queue.add(request);<br><span class="hljs-comment">//为请求添加一个标签TAG，在activityonStop里停止包含TAG</span><br>的请求 <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span> <span class="hljs-params">()</span> {<br>   <span class="hljs-built_in">super</span>.onStop();<br>   <span class="hljs-keyword">if</span> (mRequestQueue != <span class="hljs-literal">null</span>) {<br>       mRequestQueue.cancelAll(TAG);<br>   }<br>}<br></code></pre></td></tr></tbody></table></figure><p>方法二：</p>  <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-comment">// 停止所有请求：</span><br>requestQueue.cancelAll(<span class="hljs-built_in">this</span>)<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="透明状态栏"><a href="#透明状态栏" class="headerlink" title="透明状态栏"></a>透明状态栏</h3><ul><li>依赖</li></ul><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">implementation <span class="hljs-string">'com.jaeger.statusbarutil:library:1.5.1'</span><br></code></pre></td></tr></tbody></table></figure><ul><li>使用</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">    StatusBarUtil.setTransparent(<span class="hljs-built_in">this</span>);<br><span class="hljs-comment">//如果是白色背景加上下面这一句将状态栏改成黑色字体</span><br><span class="hljs-comment">//getWindow().getDecorView().setSystemUiVisibility(SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</span><br></code></pre></td></tr></tbody></table></figure><h3 id="防止手机转屏页面重建数据丢失"><a href="#防止手机转屏页面重建数据丢失" class="headerlink" title="防止手机转屏页面重建数据丢失"></a>防止手机转屏页面重建数据丢失</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".xxxActivity"</span></span><br><span class="hljs-tag">        &lt;!<span class="hljs-attr">---在活动下面加上这句话就可以防止转屏丢失数据---</span>&gt;</span><br>        android:configChanges="orientation|keyboard|keyboardHidden|screenSize"&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>使用DataBinding也可以保持数据</p><h3 id="安卓P允许访问http页面"><a href="#安卓P允许访问http页面" class="headerlink" title="安卓P允许访问http页面"></a>安卓P允许访问http页面</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:usesCleartextTraffic</span>=<span class="hljs-string">"true"</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h3 id="ViewModel、DataBinding-ViewBinding"><a href="#ViewModel、DataBinding-ViewBinding" class="headerlink" title="ViewModel、DataBinding / ViewBinding"></a>ViewModel、DataBinding / ViewBinding</h3><ul><li>依赖</li></ul><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">    dataBinding {<br>    enabled <span class="hljs-literal">true</span><br>}<br>viewBinding {<br>    enabled <span class="hljs-literal">true</span><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>Activity使用方法：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">MyViewModel viewModel;<br>    ActivityViewModelBinding binding;<br><br>    binding=DataBindingUtil.setContentView(<span class="hljs-built_in">this</span>,R.layout.activity_view_model);<br>    viewModel=ViewModelProviders.of(<span class="hljs-built_in">this</span>).get(MyViewModel.class);<br>    binding.setData(viewModel);<br>    binding.setLifecycleOwner(<span class="hljs-built_in">this</span>);<br></code></pre></td></tr></tbody></table></figure><ul><li>XML绑定语法</li></ul><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haskell">@{<span class="hljs-class"><span class="hljs-keyword">data</span>.xxx}</span><br>@{()-&gt;<span class="hljs-class"><span class="hljs-keyword">data</span>.xxx()}</span><br><br>// 与视图<span class="hljs-type">Text</span>控件绑定时一定注意<span class="hljs-type">LiveData</span>类型，不是<span class="hljs-type">String</span>要进行转型（这个错误编译不会报错，但是运行就会<span class="hljs-type">FC</span>）：<br><span class="hljs-title">android</span>:text=<span class="hljs-string">"@{String.valueOf(data.number)}"</span><br></code></pre></td></tr></tbody></table></figure><h3 id="阻止按钮自动大写"><a href="#阻止按钮自动大写" class="headerlink" title="阻止按钮自动大写"></a>阻止按钮自动大写</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"textAllCaps"</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h3 id="Room简单使用流程"><a href="#Room简单使用流程" class="headerlink" title="Room简单使用流程"></a>Room简单使用流程</h3><ul><li>依赖</li></ul><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">    <span class="hljs-keyword">def</span> room_version = <span class="hljs-string">"2.2.2"</span><br>implementation <span class="hljs-string">"androidx.room:room-runtime:$room_version"</span><br>annotationProcessor <span class="hljs-string">"androidx.room:room-compiler:$room_version"</span><br>testImplementation <span class="hljs-string">"androidx.room:room-testing:$room_version"</span><br><span class="hljs-comment">//下面这三个一般用不到</span><br><span class="hljs-comment">//implementation "androidx.room:room-ktx:$room_version"</span><br><span class="hljs-comment">//implementation "androidx.room:room-rxjava2:$room_version"</span><br><span class="hljs-comment">//implementation "androidx.room:room-guava:$room_version"</span><br></code></pre></td></tr></tbody></table></figure><ul><li><p>使用</p><ol><li>新建一个<code>@Entity</code> XXX类，定义表格格式</li><li>定义一个<code>@Dao</code>接口<code>interface</code> <code>xxxDao</code>，编写数据库操作语句</li></ol>  <figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less">      <span class="hljs-variable">@Insert</span><br><span class="hljs-variable">@Update</span><br><span class="hljs-variable">@Delete</span><br><span class="hljs-variable">@Query</span>(“”)<br></code></pre></td></tr></tbody></table></figure><ol start="3"><li>定义一个抽象类<code>xxxDataBase</code></li></ol>  <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-meta">@DataBase(entities = {xxx.class},version = x,exportSchema = boolen)</span><br><span class="hljs-comment">// 里面定义一个抽象方法</span><br><span class="hljs-keyword">abstract</span> xxxDao getxxxDao;<br></code></pre></td></tr></tbody></table></figure><ol start="4"><li>调用：</li></ol>  <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-type">xxxDataBase</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> Room.databaseBuilder(<span class="hljs-built_in">this</span>,xxxDataBase.class,<span class="hljs-string">"name"</span>)<br><span class="hljs-comment">//.allowMainThreadQueries() //设置允许在主线程运行，一般不要这样写</span><br>       .build();<br><span class="hljs-type">xxxDao</span> <span class="hljs-variable">xx</span> <span class="hljs-operator">=</span> x.getxxxDao;<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="防止键盘遮挡输入框"><a href="#防止键盘遮挡输入框" class="headerlink" title="防止键盘遮挡输入框"></a>防止键盘遮挡输入框</h3><p>将布局放到 <code>ScrollView</code> 中，然后在 <code>MainFest</code> 里 <code>Activity</code> 里面加入：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">android:windowSoftInputMode="adjustResize"<br></code></pre></td></tr></tbody></table></figure><h3 id="RecyclerView简单调用流程"><a href="#RecyclerView简单调用流程" class="headerlink" title="RecyclerView简单调用流程"></a>RecyclerView简单调用流程</h3><h4 id="定义Adapter："><a href="#定义Adapter：" class="headerlink" title="定义Adapter："></a>定义Adapter：</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义一个内部类ViewHolder</span><br><span class="hljs-comment">//Adapter继承RecyclerView.Adapter&lt;xxxAdapter.ViewHolder&gt;</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">xxxAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;xxxAdapter.ViewHolder&gt; {<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">xxxAdapter</span><span class="hljs-params">(List&lt;xxx&gt; lists)</span> {<br>    }<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.ViewHolder {<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View itemView)</span> {<br>            <span class="hljs-built_in">super</span>(itemView);<br>            <span class="hljs-comment">//初始化item上的控件</span><br>        }<br>    }<br><br>    <span class="hljs-comment">//IDE会引导生成三个需要实现的方法</span><br>    <span class="hljs-keyword">public</span> ViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">()</span> {<br>        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> LayoutInflater.from(parent.getContext())<br>                .inflate(R.layout.item_recycler, parent, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">ViewHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewHolder</span>(view);<br>        <span class="hljs-keyword">return</span> holder;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">//绑定视图，为item上的控件赋值</span><br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">//返回item个数</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="具体调用："><a href="#具体调用：" class="headerlink" title="具体调用："></a>具体调用：</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;xxx&gt; lists; <span class="hljs-comment">//封装数据</span><br>        RecyclerView recylcler=..;<br>        recycler.setLayoutManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(<span class="hljs-built_in">this</span>));<br><span class="hljs-comment">// 如果可以确定每个item的高度是固定的，设置下面这个选项可以提高性能</span><br>        recycler.setHasFixedSize(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//Adapter</span><br>        xxxAdapter adapter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">xxxAdapter</span>(lists);<br>        recycler.setAdapter(adapter);<br></code></pre></td></tr></tbody></table></figure><h3 id="广播接收器"><a href="#广播接收器" class="headerlink" title="广播接收器"></a>广播接收器</h3><h4 id="发送广播时："><a href="#发送广播时：" class="headerlink" title="发送广播时："></a>发送广播时：</h4><p>高版本的android系统，对于广播的接收变得越来越严格，发送广播时要在 <code>Intent</code> 后面加上 <code>.setComponent</code> 参数</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">"com.xxx.name"</span>);<span class="hljs-comment">//参数是广播接收器name</span><br><span class="hljs-comment">//参数1是广播接收器所在的包名，参数2是广播接收器name</span><br>        intent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(<span class="hljs-string">"com.xxx"</span>,<span class="hljs-string">"com.xxx.name"</span>));<br>        sendBroadcast(intent);<br></code></pre></td></tr></tbody></table></figure><h3 id="Retrofit（网络请求）"><a href="#Retrofit（网络请求）" class="headerlink" title="Retrofit（网络请求）"></a>Retrofit（网络请求）</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建一个接口，通过注解定义请求方式格式等</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RetrofitUtil</span> {<br>    <span class="hljs-comment">//第二段请求地址</span><br>    <span class="hljs-comment">//加上第一段请求地址意思就是请求 https://a.b.b/de</span><br>    <span class="hljs-meta">@GET("de")</span><br>    Call&lt;UpdateInfo&gt; <span class="hljs-title function_">getUpdateInfo</span><span class="hljs-params">()</span>;<br>}<br><br>    <span class="hljs-comment">//使用</span><br><span class="hljs-comment">//构建一个Retrofit</span><br>    <span class="hljs-type">Retrofit</span> <span class="hljs-variable">retrofit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Retrofit</span><br>            .Builder()<br>            <span class="hljs-comment">//这里是使用Gson将请求结果封装成对象</span><br>            .addConverterFactory(GsonConverterFactory.create())<br>            <span class="hljs-comment">//第一段请求地址</span><br>            .baseUrl(<span class="hljs-string">"https://a.b.b/"</span>)<br>            .build();<br>    <span class="hljs-type">RetrofitUtil</span> <span class="hljs-variable">retrofitUtil</span> <span class="hljs-operator">=</span> retrofit.create(RetrofitUtil.class);<br>    Call&lt;UpdateInfo&gt; call = retrofitUtil.getUpdateInfo();<br><br><span class="hljs-comment">//异步请求</span><br>call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;UpdateInfo&gt;(){});<br></code></pre></td></tr></tbody></table></figure><h3 id="EventBus（活动间发送接收信息）"><a href="#EventBus（活动间发送接收信息）" class="headerlink" title="EventBus（活动间发送接收信息）"></a>EventBus（活动间发送接收信息）</h3><h4 id="发送："><a href="#发送：" class="headerlink" title="发送："></a>发送：</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">EventBus.getDefault().postSticky(city_id);<br>        startActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>.getActivity(),B.class));<br></code></pre></td></tr></tbody></table></figure><h4 id="接收："><a href="#接收：" class="headerlink" title="接收："></a>接收：</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//接收前先注册</span><br>EventBus.getDefault().register(<span class="hljs-built_in">this</span>);<br><br><span class="hljs-comment">//活动销毁时反注册</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span>{<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        EventBus.getDefault().unregister(<span class="hljs-built_in">this</span>);<br>        }<br><br><span class="hljs-comment">//通过注解使用</span><br><span class="hljs-comment">//(线程模式，是否Stiky粘性注册)</span><br><span class="hljs-meta">@Subscribe(threadMode = ThreadMode.MAIN, sticky = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eventGetCityId</span><span class="hljs-params">(String city_id)</span>{<br>        <span class="hljs-built_in">this</span>.city_id=city_id;<br>        }<br></code></pre></td></tr></tbody></table></figure><p> </p><h3 id="改变Menu三个小点颜色"><a href="#改变Menu三个小点颜色" class="headerlink" title="改变Menu三个小点颜色"></a>改变Menu三个小点颜色</h3><p>item下面可以继续包含Menu</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">item</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:icon</span>=<span class="hljs-string">"@drawable/ic_more_white_24"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:showAsAction</span>=<span class="hljs-string">"always"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:title</span>=<span class="hljs-string">"About"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">menu</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">item</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/m_item_about"</span></span><br><span class="hljs-tag">                <span class="hljs-attr">android:title</span>=<span class="hljs-string">"关于"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">menu</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h3 id="锁屏显示页面"><a href="#锁屏显示页面" class="headerlink" title="锁屏显示页面"></a>锁屏显示页面</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//onCreat()</span><br>getWindow().addFlags(<br>    WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED <span class="hljs-comment">//锁屏显示</span><br>    | WindowManager . LayoutParams . FLAG_DISMISS_KEYGUARD <span class="hljs-comment">//解锁</span><br>| WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON <span class="hljs-comment">//保持屏幕不息屏</span><br>| WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON);<span class="hljs-comment">//点亮屏幕</span><br><span class="hljs-comment">//startActivity</span><br><span class="hljs-keyword">val</span> pm = getSystemService(Context.POWER_SERVICE) <span class="hljs-keyword">as</span> PowerManager<br><span class="hljs-keyword">val</span> mKeyguardManager = getSystemService(Context.KEYGUARD_SERVICE) <span class="hljs-keyword">as</span> KeyguardManager<br><span class="hljs-keyword">val</span> wakeLock = pm.newWakeLock(PowerManager.ACQUIRE_CAUSES_WAKEUP or PowerManager.SCREEN_DIM_WAKE_LOCK, <span class="hljs-string">"wakeLock"</span>)<br>wakeLock.acquire()<br><span class="hljs-keyword">val</span> mKeyguardLock = mKeyguardManager.newKeyguardLock(<span class="hljs-string">""</span>)<br>mKeyguardLock.disableKeyguard()<br><span class="hljs-keyword">val</span> i = Intent(<span class="hljs-keyword">this</span>, CameraActivity::<span class="hljs-keyword">class</span>.java)<br>i.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS)<br>startActivity(i)<br></code></pre></td></tr></tbody></table></figure><h3 id="查看内存"><a href="#查看内存" class="headerlink" title="查看内存"></a>查看内存</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 打印当前手机内存信息应用的内存信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.JELLY_BEAN)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMemoryInfo</span><span class="hljs-params">()</span>{<br><span class="hljs-keyword">final</span> String TAG=<span class="hljs-string">"MemoryUtils.printMemoryInfo()"</span>;<br>        <span class="hljs-comment">//打印当前APP内存信息</span><br><br>        <span class="hljs-comment">//开启了  android:largeHeap="true" 后,就是启用了流氓应用的内存限制</span><br>        <span class="hljs-comment">//打印当前应用内存信息</span><br>        Runtime rt=Runtime.getRuntime();<br>        Log.d(TAG,<span class="hljs-string">"APP当前内存状态: 最大可申请内存:"</span>+rt.maxMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB 已申请内存:"</span>+rt.totalMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB 空闲内存:"</span>+rt.freeMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB"</span>);<br><br>        }<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获得app可用内存的字节数  这个类不需要try,catch理论上不会报错</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.HONEYCOMB)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAppSurplusMe</span><span class="hljs-params">()</span>{<br><span class="hljs-keyword">final</span> String TAG=<span class="hljs-string">"MemoryUtils.getAppSurplusMe()"</span>;<br><br>        Runtime rt=Runtime.getRuntime();<br>        <span class="hljs-comment">//一下参数单位为字节数</span><br>        <span class="hljs-type">long</span> totalMemory=rt.totalMemory();<span class="hljs-comment">//这个是已经申请的内存,等于已经使用的内存加上空闲内存</span><br>        <span class="hljs-type">long</span> maxMemory=rt.maxMemory();<span class="hljs-comment">//最大内存限制</span><br>        <span class="hljs-type">long</span> freeMemory=rt.freeMemory();<br><br>        <span class="hljs-comment">//假如最大内存限制是64M,已经申请了34M,空闲4M,那么其实当前使用的是:(34-4)M,而实际当前有效可使用的内存是:64-(34-4)=34;</span><br>        <span class="hljs-comment">//64-(34-4)=34   请允许我引用高数老师的那句话:"同理可得" 64-34+4</span><br>        <span class="hljs-comment">//so</span><br>        <span class="hljs-type">long</span> surplusMemory=maxMemory-totalMemory+freeMemory;<br>        Log.d(TAG,<span class="hljs-string">"系统当前内存状态: 最大可申请内存:"</span>+rt.maxMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB 已申请内存:"</span>+rt.totalMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB 空闲内存:"</span>+rt.freeMemory()/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>+<span class="hljs-string">"MB"</span>);<br><br>        <span class="hljs-keyword">return</span> surplusMemory;<br>        }<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获得手机可用内存的字节数  这个类不需要try,catch,理论上不会报错</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 这个方法要慎用  容易导致崩溃  特别在引导页的时候  低内存手机容易发生崩溃</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> context</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getPhoneSurplusMe</span><span class="hljs-params">(Context context)</span>{<br>        ActivityManager am=(ActivityManager)context.getSystemService(context.ACTIVITY_SERVICE);<br>        ActivityManager.MemoryInfo mi=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityManager</span>.MemoryInfo();<br>        am.getMemoryInfo(mi);<br>        <span class="hljs-keyword">return</span> mi.availMem;<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="传感器"><a href="#传感器" class="headerlink" title="传感器"></a>传感器</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_ACCELEROMETER       1 <span class="hljs-comment">//加速度</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_MAGNETIC_FIELD      2 <span class="hljs-comment">//磁力</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_ORIENTATION         3 <span class="hljs-comment">//方向</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_GYROSCOPE           4 <span class="hljs-comment">//陀螺仪</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_LIGHT               5 <span class="hljs-comment">//光线感应</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_PRESSURE            6 <span class="hljs-comment">//压力</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_TEMPERATURE         7 <span class="hljs-comment">//温度 </span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_PROXIMITY           8 <span class="hljs-comment">//接近</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_GRAVITY             9 <span class="hljs-comment">//重力</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_LINEAR_ACCELERATION 10<span class="hljs-comment">//线性加速度</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SENSOR_TYPE_ROTATION_VECTOR     11<span class="hljs-comment">//旋转矢量</span></span><br></code></pre></td></tr></tbody></table></figure><ol><li><p>加速度传感器<br>加速度传感器又叫 <code>G-sensor</code> ，返回x、y、z三轴的加速度数值。</p><p>该数值包含地心引力的影响，单位是m/s^2。<br>将手机平放在桌面上，x轴默认为0，y轴默认0，z轴默认9.81。<br>将手机朝下放在桌面上，z轴为-9.81。<br>将手机向左倾斜，x轴为正值。<br>将手机向右倾斜，x轴为负值。<br>将手机向上倾斜，y轴为负值。<br>将手机向下倾斜，y轴为正值。<br>加速度传感器可能是最为成熟的一种mems产品，市场上的加速度传感器种类很多。<br>手机中常用的加速度传感器有BOSCH（博世）的BMA系列，AMK的897X系列，ST的LIS3X系列等。<br>这些传感器一般提供±2G至±16G的加速度测量范围，采用I2C或SPI接口和MCU相连，数据精度小于16bit。</p></li><li><p>磁力传感器<br>磁力传感器简称为M-sensor，返回x、y、z三轴的环境磁场数据。</p><p>该数值的单位是微特斯拉（micro-Tesla），用uT表示。<br>单位也可以是高斯（Gauss），1Tesla=10000Gauss。<br>硬件上一般没有独立的磁力传感器，磁力数据由电子罗盘传感器提供（E-compass）。<br>电子罗盘传感器同时提供下文的方向传感器数据。</p></li><li><p>方向传感器</p><p>方向传感器简称为O-sensor，返回三轴的角度数据，方向数据的单位是角度。</p><p>为了得到精确的角度数据，E-compass需要获取G-sensor的数据，<br>经过计算生产O-sensor数据，否则只能获取水平方向的角度。<br>方向传感器提供三个数据，分别为azimuth、pitch和roll。<br>azimuth：方位，返回水平时磁北极和Y轴的夹角，范围为0°至360°。<br>0°=北，90°=东，180°=南，270°=西。<br>pitch：x轴和水平面的夹角，范围为-180°至180°。<br>当z轴向y轴转动时，角度为正值。<br>roll：y轴和水平面的夹角，由于历史原因，范围为-90°至90°。<br>当x轴向z轴移动时，角度为正值。<br>电子罗盘在获取正确的数据前需要进行校准，通常可用8字校准法。<br>8字校准法要求用户使用需要校准的设备在空中做8字晃动，<br>原则上尽量多的让设备法线方向指向空间的所有8个象限。<br>手机中使用的电子罗盘芯片有AKM公司的897X系列，ST公司的LSM系列以及雅马哈公司等等。<br>由于需要读取G-sensor数据并计算出M-sensor和O-sensor数据，<br>因此厂商一般会提供一个后台daemon来完成工作，电子罗盘算法一般是公司私有产权。</p></li><li><p>陀螺仪传感器</p><p>陀螺仪传感器叫做Gyro-sensor，返回x、y、z三轴的角加速度数据。<br>角加速度的单位是radians/second。<br>根据Nexus S手机实测：<br>水平逆时针旋转，Z轴为正。<br>水平逆时针旋转，z轴为负。<br>向左旋转，y轴为负。<br>向右旋转，y轴为正。<br>向上旋转，x轴为负。<br>向下旋转，x轴为正。<br>ST的L3G系列的陀螺仪传感器比较流行，iphone4和google的nexus s中使用该种传感器。</p></li><li><p>光线感应传感器</p><p>光线感应传感器检测实时的光线强度，光强单位是lux，其物理意义是照射到单位面积上的光通量。<br>光线感应传感器主要用于Android系统的LCD自动亮度功能。<br>可以根据采样到的光强数值实时调整LCD的亮度。</p></li><li><p>压力传感器</p><p>压力传感器返回当前的压强，单位是百帕斯卡hectopascal（hPa）。</p></li><li><p>温度传感器</p><p>温度传感器返回当前的温度。</p></li><li><p>接近传感器</p><p>接近传感器检测物体与手机的距离，单位是厘米。<br>一些接近传感器只能返回远和近两个状态，<br>因此，接近传感器将最大距离返回远状态，小于最大距离返回近状态。<br>接近传感器可用于接听电话时自动关闭LCD屏幕以节省电量。<br>一些芯片集成了接近传感器和光线传感器两者功能。<br>下面三个传感器是Android2新提出的传感器类型，目前还不太清楚有哪些应用程序使用。</p></li><li><p>重力传感器</p><p>重力传感器简称GV-sensor，输出重力数据。<br>在地球上，重力数值为9.8，单位是m/s^2。<br>坐标系统与加速度传感器相同。<br>当设备复位时，重力传感器的输出与加速度传感器相同。</p></li><li><p>线性加速度传感器</p><p>线性加速度传感器简称LA-sensor。<br>线性加速度传感器是加速度传感器减去重力影响获取的数据。<br>单位是m/s^2，坐标系统与加速度传感器相同。<br>加速度传感器、重力传感器和线性加速度传感器的计算公式如下：<br>加速度 = 重力 + 线性加速度</p></li><li><p>旋转矢量传感器</p><p>旋转矢量传感器简称RV-sensor。旋转矢量代表设备的方向，是一个将坐标轴和角度混合计算得到的数据。<br>RV-sensor输出三个数据：<br>x<em>sin(theta/2)<br>y</em>sin(theta/2)<br>z*sin(theta/2)<br>sin(theta/2)是RV的数量级。<br>RV的方向与轴旋转的方向相同。<br>RV的三个数值，与cos(theta/2)组成一个四元组。<br>RV的数据没有单位，使用的坐标系与加速度相同。<br>举例：</p><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">sensors_event_t</span>.<span class="hljs-class"><span class="hljs-keyword">data</span>[0] = x*sin(<span class="hljs-title">theta</span>/2)</span><br><span class="hljs-title">sensors_event_t</span>.<span class="hljs-class"><span class="hljs-keyword">data</span>[1] = y*sin(<span class="hljs-title">theta</span>/2)</span><br><span class="hljs-title">sensors_event_t</span>.<span class="hljs-class"><span class="hljs-keyword">data</span>[2] = z*sin(<span class="hljs-title">theta</span>/2)</span><br><span class="hljs-title">sensors_event_t</span>.<span class="hljs-class"><span class="hljs-keyword">data</span>[3] = cos(<span class="hljs-title">theta</span>/2)</span><br></code></pre></td></tr></tbody></table></figure><p>GV、LA和RV的数值没有物理传感器可以直接给出，<br>需要G-sensor、O-sensor和Gyro-sensor经过算法计算后得出。<br>算法一般是传感器公司的私有产权。</p><p>参考文献：android source code hardware\libhardware\include\hardwaresensor.h<br><a href="http://www.dzsc.com/data/html/2010-11-29/87454.html">http://www.dzsc.com/data/html/2010-11-29/87454.html</a></p></li></ol><h3 id="状态栏"><a href="#状态栏" class="headerlink" title="状态栏"></a>状态栏</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 隐藏状态栏</span><br>getWindow().addFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN);<br><span class="hljs-comment">// 显示状态栏</span><br>        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN); <br></code></pre></td></tr></tbody></table></figure><h3 id="控制状态栏和导航栏显示-setSystemUiVisibility"><a href="#控制状态栏和导航栏显示-setSystemUiVisibility" class="headerlink" title="控制状态栏和导航栏显示, setSystemUiVisibility"></a>控制状态栏和导航栏显示, setSystemUiVisibility</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java">View.SYSTEM_UI_FLAG_LAYOUT_STABLE<br><span class="hljs-comment">//全屏显示时保证尺寸不变。</span><br><br>        View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<br>        <span class="hljs-comment">//Activity全屏显示，状态栏显示在Activity页面上面。</span><br><br>        View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<br>        <span class="hljs-comment">//效果同View. SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><br>        View.SYSTEM_UI_FLAG_HIDE_NAVIGATION<br>        <span class="hljs-comment">//隐藏导航栏</span><br><br>        View.SYSTEM_UI_FLAG_FULLSCREEN<br><span class="hljs-comment">//Activity全屏显示，且状态栏被隐藏覆盖掉。</span><br><br>        View.SYSTEM_UI_FLAG_VISIBLE<br><span class="hljs-comment">//Activity非全屏显示，显示状态栏和导航栏。</span><br><br>        View.INVISIBLE<br><span class="hljs-comment">//Activity伸展全屏显示，隐藏状态栏。</span><br><br>        View.SYSTEM_UI_LAYOUT_FLAGS<br><span class="hljs-comment">//效果同View. SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><br>        View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY<br><span class="hljs-comment">//必须配合View.SYSTEM_UI_FLAG_FULLSCREEN和View.SYSTEM_UI_FLAG_HIDE_NAVIGATION组合使用，达到的效果是拉出状态栏和导航栏后显示一会儿消失。</span><br><br><span class="hljs-comment">// 全屏展示</span><br>        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.JELLY_BEAN){<br><br>        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.LOLLIPOP){<br>        <span class="hljs-comment">// 全屏显示，隐藏状态栏和导航栏，拉出状态栏和导航栏显示一会儿后消失。</span><br>        activity.getWindow().getDecorView().setSystemUiVisibility(<br>        View.SYSTEM_UI_FLAG_LAYOUT_STABLE<br>        |View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<br>        |View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<br>        |View.SYSTEM_UI_FLAG_HIDE_NAVIGATION<br>        |View.SYSTEM_UI_FLAG_FULLSCREEN<br>        |View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// 全屏显示，隐藏状态栏</span><br>        activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_FULLSCREEN);<br>        }<br><br>        }<br><br><span class="hljs-comment">// 非全屏显示，显示状态栏和导航栏</span><br>        activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE); <br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>查看Apk签名信息</title>
    <link href="/2023/08/26/docs/android/qi-ta/cha-kan-apk-qian-ming-xin-xi/"/>
    <url>/2023/08/26/docs/android/qi-ta/cha-kan-apk-qian-ming-xin-xi/</url>
    
    <content type="html"><![CDATA[<h1 id="查看apk签名信息"><a href="#查看apk签名信息" class="headerlink" title="查看apk签名信息"></a>查看apk签名信息</h1><h2 id="直接用Android-SDK中的工具查看"><a href="#直接用Android-SDK中的工具查看" class="headerlink" title="直接用Android-SDK中的工具查看"></a>直接用Android-SDK中的工具查看</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar .\apksigner.jar verify --verbose --print-certs xxx.apk<br></code></pre></td></tr></tbody></table></figure><p>其中 <code>apksigner.jar</code> 工具包位置在 <code>Android-SDK</code> 目录下面，<code>Android-SDK\build-tools\xx.x.x\lib</code></p><h2 id="使用JDK中的工具查看"><a href="#使用JDK中的工具查看" class="headerlink" title="使用JDK中的工具查看"></a>使用JDK中的工具查看</h2><p>转自：<a href="https://blog.csdn.net/findsafety/article/details/25365997">https://blog.csdn.net/findsafety/article/details/25365997</a></p><p>假定安装了JDK，如果想查HelloWorld.apk所使用的签名的fingerprint，可以这样做：</p><ol><li><p>查找apk里的rsa文件</p><p>（Windows）</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jar tf HelloWorld.apk | findstr RSA<br></code></pre></td></tr></tbody></table></figure><p>（Linux）</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jar tf HelloWorld.apk | grep RSA<br></code></pre></td></tr></tbody></table></figure><p>输出结果：</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">META-INF/CERT.RSA<br></code></pre></td></tr></tbody></table></figure></li><li><p>从apk中解压rsa文件</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jar xf HelloWorld.apk META-INF/CERT.RSA<br></code></pre></td></tr></tbody></table></figure></li><li><p>获取签名的fingerprints</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">keytool -printcert -file META-INF/CERT.RSA<br></code></pre></td></tr></tbody></table></figure><p>输出结果</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">...<br>Certificate fingerprints:<br>MD5: BC:6D:BD:6E:49:69:2A:57:A8:B8:28:89:04:3B:93:A8<br>SHA1: 0D:DF:76:F4:85:96:DF:17:C2:68:1D:3D:FF:9B:0F:D2:A1:CF:14:60<br>Signature algorithm name: SHA1withRSA<br>Version: 3<br>...<br></code></pre></td></tr></tbody></table></figure></li><li><p>清理工作，删除rsa文件</p><p>（Windows）</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rmdir</span> /S /Q META-INF<br></code></pre></td></tr></tbody></table></figure><p>（Linux）</p> <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf META-INF<br></code></pre></td></tr></tbody></table></figure></li></ol><p>如果你想知道两个apk是不是用的同一个签名，那比一下它们签名的MD5码（或SHA1码）是不是一样就行了。</p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>系统信息获取</title>
    <link href="/2023/08/26/docs/android/qi-ta/xi-tong-xin-xi-huo-qu/"/>
    <url>/2023/08/26/docs/android/qi-ta/xi-tong-xin-xi-huo-qu/</url>
    
    <content type="html"><![CDATA[<h3 id="安卓系统信息获取"><a href="#安卓系统信息获取" class="headerlink" title="安卓系统信息获取"></a>安卓系统信息获取</h3><table><thead><tr><th>字段名</th><th>描述</th></tr></thead><tbody><tr><td>android.os.Build.VERSION.RELEASE</td><td>获取系统版本字符串。如 4.1.2 或 7.1.2 等</td></tr><tr><td>android.os.Build.VERSION.SDK_INT</td><td>系统的 API 级别 数字表示</td></tr><tr><td>android.os.Build.BOARD</td><td>获取设备基板名称</td></tr><tr><td>android.os.Build.BOOTLOADER</td><td>获取设备引导程序版本号</td></tr><tr><td>android.os.Build.BRAND</td><td>获取设备品牌</td></tr><tr><td>android.os.Build.CPU_ABI</td><td>获取设备指令集名称（CPU 的类型）</td></tr><tr><td>android.os.Build.CPU_ABI2</td><td>获取第二个指令集名称</td></tr><tr><td>android.os.Build.DEVICE</td><td>获取设备驱动名称</td></tr><tr><td>android.os.Build.DISPLAY</td><td>获取设备显示的版本包（在系统设置中显示为版本号）和 ID 一样</td></tr><tr><td>android.os.Build.FINGERPRINT</td><td>设备的唯一标识。由设备的多个信息拼接合成。</td></tr><tr><td>android.os.Build.HARDWARE</td><td>设备硬件名称,一般和基板名称一样（BOARD）</td></tr><tr><td>android.os.Build.HOST</td><td>设备主机地址</td></tr><tr><td>android.os.Build.ID</td><td>设备版本号。</td></tr><tr><td>android.os.Build.MODEL</td><td>获取手机的型号 设备名称。如：SM-N9100（三星 Note4）</td></tr><tr><td>android.os.Build.MANUFACTURER</td><td>获取设备制造商。如：samsung</td></tr><tr><td>android.os.Build.PRODUCT</td><td>整个产品的名称</td></tr><tr><td>android.os.Build.RADIO</td><td>无线电固件版本号，通常是不可用的 显示</td></tr><tr><td>unknownandroid.os.Build.TAGS</td><td>设备标签。如 release-keys 或测试的 test-keys</td></tr><tr><td>android.os.Build.TIME</td><td>时间</td></tr><tr><td>android.os.Build.TYPE</td><td>设备版本类型 主要为”user” 或”eng”.</td></tr><tr><td>android.os.Build.USER</td><td>设备用户名 基本上都为 android-build</td></tr><tr><td>android.os.Build.VERSION.CODENAME</td><td>设备当前的系统开发代号，一般使用 REL 代替</td></tr><tr><td>android.os.Build.VERSION.INCREMENTAL</td><td>系统源代码控制值，一个数字或者 git hash 值</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>系统广播</title>
    <link href="/2023/08/26/docs/android/qi-ta/xi-tong-guang-bo/"/>
    <url>/2023/08/26/docs/android/qi-ta/xi-tong-guang-bo/</url>
    
    <content type="html"><![CDATA[<h2 id="一些系统广播"><a href="#一些系统广播" class="headerlink" title="一些系统广播"></a>一些系统广播</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs java">intent.action.AIRPLANE_MODE;<br><span class="hljs-comment">//关闭或打开飞行模式时的广播</span><br><br>        Intent.ACTION_BATTERY_CHANGED;<br><span class="hljs-comment">//充电状态，或者电池的电量发生变化</span><br><span class="hljs-comment">//电池的充电状态、电荷级别改变，不能通过组建声明接收这个广播，只有通过Context.registerReceiver()注册</span><br><br>        Intent.ACTION_BATTERY_LOW;<br><span class="hljs-comment">//表示电池电量低</span><br><br>        Intent.ACTION_BATTERY_OKAY;<br><span class="hljs-comment">//表示电池电量充足，即从电池电量低变化到饱满时会发出广播</span><br><br>        Intent.ACTION_BOOT_COMPLETED;<br><span class="hljs-comment">//在系统启动完成后，这个动作被广播一次（只有一次）。</span><br><br>        Intent.ACTION_CAMERA_BUTTON;<br><span class="hljs-comment">//按下照相时的拍照按键(硬件按键)时发出的广播</span><br><br>        Intent.ACTION_CLOSE_SYSTEM_DIALOGS;<br><span class="hljs-comment">//当屏幕超时进行锁屏时,当用户按下电源按钮,长按或短按(不管有没跳出话框)，进行锁屏时,android系统都会广播此Action消息</span><br><br>        Intent.ACTION_CONFIGURATION_CHANGED;<br><span class="hljs-comment">//设备当前设置被改变时发出的广播(包括的改变:界面语言，设备方向，等，请参考Configuration.java)</span><br><br>        Intent.ACTION_DATE_CHANGED;<br><span class="hljs-comment">//设备日期发生改变时会发出此广播</span><br><br>        Intent.ACTION_DEVICE_STORAGE_LOW;<br><span class="hljs-comment">//设备内存不足时发出的广播,此广播只能由系统使用，其它APP不可用？</span><br><br>        Intent.ACTION_DEVICE_STORAGE_OK;<br><span class="hljs-comment">//设备内存从不足到充足时发出的广播,此广播只能由系统使用，其它APP不可用？</span><br><br>        Intent.ACTION_DOCK_EVENT;<br><span class="hljs-comment">//</span><br><span class="hljs-comment">//发出此广播的地方frameworks\base\services\java\com\android\server\DockObserver.java</span><br><br>        Intent.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE;<br><span class="hljs-comment">////移动APP完成之后，发出的广播(移动是指:APP2SD)</span><br><br>        Intent.ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE;<br><span class="hljs-comment">//正在移动APP时，发出的广播(移动是指:APP2SD)</span><br><br>        Intent.ACTION_GTALK_SERVICE_CONNECTED;<br><span class="hljs-comment">//Gtalk已建立连接时发出的广播</span><br><br>        Intent.ACTION_GTALK_SERVICE_DISCONNECTED;<br><span class="hljs-comment">//Gtalk已断开连接时发出的广播</span><br><br>        Intent.ACTION_HEADSET_PLUG;<br><span class="hljs-comment">//在耳机口上插入耳机时发出的广播</span><br><br>        Intent.ACTION_INPUT_METHOD_CHANGED;<br><span class="hljs-comment">//改变输入法时发出的广播</span><br><br>        Intent.ACTION_LOCALE_CHANGED;<br><span class="hljs-comment">//设备当前区域设置已更改时发出的广播</span><br><br>        Intent.ACTION_MANAGE_PACKAGE_STORAGE;<br><span class="hljs-comment">//</span><br><br>        Intent.ACTION_MEDIA_BAD_REMOVAL;<br><span class="hljs-comment">//未正确移除SD卡(正确移除SD卡的方法:设置--SD卡和设备内存--卸载SD卡)，但已把SD卡取出来时发出的广播</span><br><span class="hljs-comment">//广播：扩展介质（扩展卡）已经从 SD 卡插槽拔出，但是挂载点 (mount point) 还没解除 (unmount)</span><br><br>        Intent.ACTION_MEDIA_BUTTON;<br><span class="hljs-comment">//按下"Media Button" 按键时发出的广播,假如有"Media Button" 按键的话(硬件按键)</span><br><br>        Intent.ACTION_MEDIA_CHECKING;<br><span class="hljs-comment">//插入外部储存装置，比如SD卡时，系统会检验SD卡，此时发出的广播?</span><br>        Intent.ACTION_MEDIA_EJECT;<br><span class="hljs-comment">//已拔掉外部大容量储存设备发出的广播（比如SD卡，或移动硬盘）,不管有没有正确卸载都会发出此广播?</span><br><span class="hljs-comment">//广播：用户想要移除扩展介质（拔掉扩展卡）。</span><br>        Intent.ACTION_MEDIA_MOUNTED;<br><span class="hljs-comment">//插入SD卡并且已正确安装（识别）时发出的广播</span><br><span class="hljs-comment">//广播：扩展介质被插入，而且已经被挂载。</span><br>        Intent.ACTION_MEDIA_NOFS;<br><span class="hljs-comment">//</span><br>        Intent.ACTION_MEDIA_REMOVED;<br><span class="hljs-comment">//外部储存设备已被移除，不管有没正确卸载,都会发出此广播？</span><br><span class="hljs-comment">// 广播：扩展介质被移除。</span><br>        Intent.ACTION_MEDIA_SCANNER_FINISHED;<br><span class="hljs-comment">//广播：已经扫描完介质的一个目录</span><br>        Intent.ACTION_MEDIA_SCANNER_SCAN_FILE;<br><span class="hljs-comment">//</span><br>        Intent.ACTION_MEDIA_SCANNER_STARTED;<br><span class="hljs-comment">//广播：开始扫描介质的一个目录</span><br><br>        Intent.ACTION_MEDIA_SHARED;<br><span class="hljs-comment">// 广播：扩展介质的挂载被解除 (unmount)，因为它已经作为 USB 大容量存储被共享。</span><br>        Intent.ACTION_MEDIA_UNMOUNTABLE;<br><span class="hljs-comment">//</span><br>        Intent.ACTION_MEDIA_UNMOUNTED<br><span class="hljs-comment">// 广播：扩展介质存在，但是还没有被挂载 (mount)。</span><br>        Intent.ACTION_NEW_OUTGOING_CALL;<br><br>        Intent.ACTION_PACKAGE_ADDED;<br><span class="hljs-comment">//成功的安装APK之后</span><br><span class="hljs-comment">//广播：设备上新安装了一个应用程序包。</span><br><span class="hljs-comment">//一个新应用包已经安装在设备上，数据包括包名（最新安装的包程序不能接收到这个广播）</span><br>        Intent.ACTION_PACKAGE_CHANGED;<br><span class="hljs-comment">//一个已存在的应用程序包已经改变，包括包名</span><br>        Intent.ACTION_PACKAGE_DATA_CLEARED;<br><span class="hljs-comment">//清除一个应用程序的数据时发出的广播(在设置－－应用管理－－选中某个应用，之后点清除数据时?)</span><br><span class="hljs-comment">//用户已经清除一个包的数据，包括包名（清除包程序不能接收到这个广播）</span><br><br>        Intent.ACTION_PACKAGE_INSTALL;<br><span class="hljs-comment">//触发一个下载并且完成安装时发出的广播，比如在电子市场里下载应用？</span><br><span class="hljs-comment">//</span><br>        Intent.ACTION_PACKAGE_REMOVED;<br><span class="hljs-comment">//成功的删除某个APK之后发出的广播</span><br><span class="hljs-comment">//一个已存在的应用程序包已经从设备上移除，包括包名（正在被安装的包程序不能接收到这个广播）</span><br><br>        Intent.ACTION_PACKAGE_REPLACED;<br><span class="hljs-comment">//替换一个现有的安装包时发出的广播（不管现在安装的APP比之前的新还是旧，都会发出此广播？）</span><br>        Intent.ACTION_PACKAGE_RESTARTED;<br><span class="hljs-comment">//用户重新开始一个包，包的所有进程将被杀死，所有与其联系的运行时间状态应该被移除，包括包名（重新开始包程序不能接收到这个广播）</span><br>        Intent.ACTION_POWER_CONNECTED;<br><span class="hljs-comment">//插上外部电源时发出的广播</span><br>        Intent.ACTION_POWER_DISCONNECTED;<br><span class="hljs-comment">//已断开外部电源连接时发出的广播</span><br>        Intent.ACTION_PROVIDER_CHANGED;<br><span class="hljs-comment">//</span><br><br>        Intent.ACTION_REBOOT;<br><span class="hljs-comment">//重启设备时的广播</span><br><br>        Intent.ACTION_SCREEN_OFF;<br><span class="hljs-comment">//屏幕被关闭之后的广播</span><br><br>        Intent.ACTION_SCREEN_ON;<br><span class="hljs-comment">//屏幕被打开之后的广播</span><br><br>        Intent.ACTION_SHUTDOWN;<br><span class="hljs-comment">//关闭系统时发出的广播</span><br><br>        Intent.ACTION_TIMEZONE_CHANGED;<br><span class="hljs-comment">//时区发生改变时发出的广播</span><br><br>        Intent.ACTION_TIME_CHANGED;<br><span class="hljs-comment">//时间被设置时发出的广播</span><br><br>        Intent.ACTION_TIME_TICK;<br><span class="hljs-comment">//广播：当前时间已经变化（正常的时间流逝）。</span><br><span class="hljs-comment">//当前时间改变，每分钟都发送，不能通过组件声明来接收，只有通过Context.registerReceiver()方法来注册</span><br><br>        Intent.ACTION_UID_REMOVED;<br><span class="hljs-comment">//一个用户ID已经从系统中移除发出的广播</span><br><span class="hljs-comment">//</span><br><br>        Intent.ACTION_UMS_CONNECTED;<br><span class="hljs-comment">//设备已进入USB大容量储存状态时发出的广播？</span><br><br>        Intent.ACTION_UMS_DISCONNECTED;<br><span class="hljs-comment">//设备已从USB大容量储存状态转为正常状态时发出的广播？</span><br><br>        Intent.ACTION_USER_PRESENT;<br><span class="hljs-comment">//</span><br><br>        Intent.ACTION_WALLPAPER_CHANGED;<br><span class="hljs-comment">//设备墙纸已改变时发出的广播</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>系统提供的Activity</title>
    <link href="/2023/08/26/docs/android/qi-ta/xi-tong-ti-gong-de-activity/"/>
    <url>/2023/08/26/docs/android/qi-ta/xi-tong-ti-gong-de-activity/</url>
    
    <content type="html"><![CDATA[<h3 id="系统提供的Activity"><a href="#系统提供的Activity" class="headerlink" title="系统提供的Activity"></a>系统提供的Activity</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.拨打电话</span><br><span class="hljs-comment">// 给移动客服10086拨打电话</span><br>Uri uri=Uri.parse(<span class="hljs-string">"tel:10086"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_DIAL,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//2.发送短信</span><br><span class="hljs-comment">// 给10086发送内容为“Hello”的短信</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"smsto:10086"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SENDTO,uri);<br>        intent.putExtra(<span class="hljs-string">"sms_body"</span>,<span class="hljs-string">"Hello"</span>);<br>        startActivity(intent);<br><br><span class="hljs-comment">//3.发送彩信（相当于发送带附件的短信）</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);<br>        intent.putExtra(<span class="hljs-string">"sms_body"</span>,<span class="hljs-string">"Hello"</span>);<br>        Uri uri=Uri.parse(<span class="hljs-string">"content://media/external/images/media/23"</span>);<br>        intent.putExtra(Intent.EXTRA_STREAM,uri);<br>        intent.setType(<span class="hljs-string">"image/png"</span>);<br>        startActivity(intent);<br><br><span class="hljs-comment">//4.打开浏览器:</span><br><span class="hljs-comment">// 打开Google主页</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"http://www.baidu.com"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//5.发送电子邮件:(阉割了Google服务的没戏!!!!)</span><br><span class="hljs-comment">// 给someone@domain.com发邮件</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"mailto:someone@domain.com"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SENDTO,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">// 给someone@domain.com发邮件发送内容为“Hello”的邮件</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);<br>        intent.putExtra(Intent.EXTRA_EMAIL,<span class="hljs-string">"someone@domain.com"</span>);<br>        intent.putExtra(Intent.EXTRA_SUBJECT,<span class="hljs-string">"Subject"</span>);<br>        intent.putExtra(Intent.EXTRA_TEXT,<span class="hljs-string">"Hello"</span>);<br>        intent.setType(<span class="hljs-string">"text/plain"</span>);<br>        startActivity(intent);<br><br><span class="hljs-comment">// 给多人发邮件</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);<br>        String[]tos={<span class="hljs-string">"1@abc.com"</span>,<span class="hljs-string">"2@abc.com"</span>}; <span class="hljs-comment">// 收件人</span><br>        String[]ccs={<span class="hljs-string">"3@abc.com"</span>,<span class="hljs-string">"4@abc.com"</span>}; <span class="hljs-comment">// 抄送</span><br>        String[]bccs={<span class="hljs-string">"5@abc.com"</span>,<span class="hljs-string">"6@abc.com"</span>}; <span class="hljs-comment">// 密送</span><br>        intent.putExtra(Intent.EXTRA_EMAIL,tos);<br>        intent.putExtra(Intent.EXTRA_CC,ccs);<br>        intent.putExtra(Intent.EXTRA_BCC,bccs);<br>        intent.putExtra(Intent.EXTRA_SUBJECT,<span class="hljs-string">"Subject"</span>);<br>        intent.putExtra(Intent.EXTRA_TEXT,<span class="hljs-string">"Hello"</span>);<br>        intent.setType(<span class="hljs-string">"message/rfc822"</span>);<br>        startActivity(intent);<br><br><span class="hljs-comment">//6.显示地图:</span><br><span class="hljs-comment">// 打开Google地图中国北京位置（北纬39.9，东经116.3）</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"geo:39.9,116.3"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//7.路径规划</span><br><span class="hljs-comment">// 路径规划：从北京某地（北纬39.9，东经116.3）到上海某地（北纬31.2，东经121.4）</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"http://maps.google.com/maps?f=d&amp;saddr=39.9 116.3&amp;daddr=31.2 121.4"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//8.多媒体播放:</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW);<br>        Uri uri=Uri.parse(<span class="hljs-string">"file:///sdcard/foo.mp3"</span>);<br>        intent.setDataAndType(uri,<span class="hljs-string">"audio/mp3"</span>);<br>        startActivity(intent);<br><br><span class="hljs-comment">//获取SD卡下所有音频文件,然后播放第一首=-= </span><br>        Uri uri=Uri.withAppendedPath(MediaStore.Audio.Media.INTERNAL_CONTENT_URI,<span class="hljs-string">"1"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//9.打开摄像头拍照:</span><br><span class="hljs-comment">// 打开拍照程序</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(MediaStore.ACTION_IMAGE_CAPTURE);<br>        startActivityForResult(intent,<span class="hljs-number">0</span>);<br><span class="hljs-comment">// 取出照片数据</span><br>        Bundle extras=intent.getExtras();<br>        Bitmap bitmap=(Bitmap)extras.get(<span class="hljs-string">"data"</span>);<br><br><span class="hljs-comment">//另一种:</span><br><span class="hljs-comment">//调用系统相机应用程序，并存储拍下来的照片</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(MediaStore.ACTION_IMAGE_CAPTURE);<br>        time=Calendar.getInstance().getTimeInMillis();<br>        intent.putExtra(MediaStore.EXTRA_OUTPUT,Uri.fromFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(Environment<br>        .getExternalStorageDirectory().getAbsolutePath()+<span class="hljs-string">"/tucue"</span>,time+<span class="hljs-string">".jpg"</span>)));<br>        startActivityForResult(intent,ACTIVITY_GET_CAMERA_IMAGE);<br><br><span class="hljs-comment">//10.获取并剪切图片</span><br><span class="hljs-comment">// 获取并剪切图片</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_GET_CONTENT);<br>        intent.setType(<span class="hljs-string">"image/*"</span>);<br>        intent.putExtra(<span class="hljs-string">"crop"</span>,<span class="hljs-string">"true"</span>); <span class="hljs-comment">// 开启剪切</span><br>        intent.putExtra(<span class="hljs-string">"aspectX"</span>,<span class="hljs-number">1</span>); <span class="hljs-comment">// 剪切的宽高比为1：2</span><br>        intent.putExtra(<span class="hljs-string">"aspectY"</span>,<span class="hljs-number">2</span>);<br>        intent.putExtra(<span class="hljs-string">"outputX"</span>,<span class="hljs-number">20</span>); <span class="hljs-comment">// 保存图片的宽和高</span><br>        intent.putExtra(<span class="hljs-string">"outputY"</span>,<span class="hljs-number">40</span>);<br>        intent.putExtra(<span class="hljs-string">"output"</span>,Uri.fromFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/mnt/sdcard/temp"</span>))); <span class="hljs-comment">// 保存路径</span><br>        intent.putExtra(<span class="hljs-string">"outputFormat"</span>,<span class="hljs-string">"JPEG"</span>);<span class="hljs-comment">// 返回格式</span><br>        startActivityForResult(intent,<span class="hljs-number">0</span>);<br><span class="hljs-comment">// 剪切特定图片</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">"com.android.camera.action.CROP"</span>);<br>        intent.setClassName(<span class="hljs-string">"com.android.camera"</span>,<span class="hljs-string">"com.android.camera.CropImage"</span>);<br>        intent.setData(Uri.fromFile(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/mnt/sdcard/temp"</span>)));<br>        intent.putExtra(<span class="hljs-string">"outputX"</span>,<span class="hljs-number">1</span>); <span class="hljs-comment">// 剪切的宽高比为1：2</span><br>        intent.putExtra(<span class="hljs-string">"outputY"</span>,<span class="hljs-number">2</span>);<br>        intent.putExtra(<span class="hljs-string">"aspectX"</span>,<span class="hljs-number">20</span>); <span class="hljs-comment">// 保存图片的宽和高</span><br>        intent.putExtra(<span class="hljs-string">"aspectY"</span>,<span class="hljs-number">40</span>);<br>        intent.putExtra(<span class="hljs-string">"scale"</span>,<span class="hljs-literal">true</span>);<br>        intent.putExtra(<span class="hljs-string">"noFaceDetection"</span>,<span class="hljs-literal">true</span>);<br>        intent.putExtra(<span class="hljs-string">"output"</span>,Uri.parse(<span class="hljs-string">"file:///mnt/sdcard/temp"</span>));<br>        startActivityForResult(intent,<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//11.打开Google Market </span><br><span class="hljs-comment">// 打开Google Market直接进入该程序的详细页面</span><br>        Uri uri=Uri.parse(<span class="hljs-string">"market://details?id="</span>+<span class="hljs-string">"com.demo.app"</span>);<br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_VIEW,uri);<br>        startActivity(intent);<br><br><span class="hljs-comment">//12.进入手机设置界面:</span><br><span class="hljs-comment">// 进入无线网络设置界面（其它可以举一反三）  </span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(android.provider.Settings.ACTION_WIRELESS_SETTINGS);<br>        startActivityForResult(intent,<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//13.安装apk:</span><br>        Uri installUri=Uri.fromParts(<span class="hljs-string">"package"</span>,<span class="hljs-string">"xxx"</span>,<span class="hljs-literal">null</span>);<br>        returnIt=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_PACKAGE_ADDED,installUri);<br><br><span class="hljs-comment">//14.卸载apk:</span><br>        Uri uri=Uri.fromParts(<span class="hljs-string">"package"</span>,strPackageName,<span class="hljs-literal">null</span>);<br>        Intent it=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_DELETE,uri);<br>        startActivity(it);<br><br><span class="hljs-comment">//15.发送附件:</span><br>        Intent it=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);<br>        it.putExtra(Intent.EXTRA_SUBJECT,<span class="hljs-string">"The email subject text"</span>);<br>        it.putExtra(Intent.EXTRA_STREAM,<span class="hljs-string">"file:///sdcard/eoe.mp3"</span>);<br>        sendIntent.setType(<span class="hljs-string">"audio/mp3"</span>);<br>        startActivity(Intent.createChooser(it,<span class="hljs-string">"Choose Email Client"</span>));<br><br><span class="hljs-comment">//16.进入联系人页面:</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>        intent.setAction(Intent.ACTION_VIEW);<br>        intent.setData(People.CONTENT_URI);<br>        startActivity(intent);<br><br><span class="hljs-comment">//17.查看指定联系人:</span><br>        Uri personUri=ContentUris.withAppendedId(People.CONTENT_URI,info.id);<span class="hljs-comment">//info.id联系人ID</span><br>        Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>        intent.setAction(Intent.ACTION_VIEW);<br>        intent.setData(personUri);<br>        startActivity(intent);<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>请求忽略电池优化</title>
    <link href="/2023/08/26/docs/android/qi-ta/qing-qiu-hu-lue-dian-chi-you-hua/"/>
    <url>/2023/08/26/docs/android/qi-ta/qing-qiu-hu-lue-dian-chi-you-hua/</url>
    
    <content type="html"><![CDATA[<h2 id="请求忽略电池优化"><a href="#请求忽略电池优化" class="headerlink" title="请求忽略电池优化"></a>请求忽略电池优化</h2><h3 id="添加权限"><a href="#添加权限" class="headerlink" title="添加权限"></a>添加权限</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure><h3 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 忽略电池优化</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ignoreBatteryOptimization</span><span class="hljs-params">(Activity activity)</span> {<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {<br>        <span class="hljs-type">PowerManager</span> <span class="hljs-variable">powerManager</span> <span class="hljs-operator">=</span> (PowerManager) getSystemService(POWER_SERVICE);<br> <br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasIgnored</span> <span class="hljs-operator">=</span> powerManager.isIgnoringBatteryOptimizations(activity.getPackageName());<br>        <span class="hljs-comment">//  判断当前APP是否有加入电池优化的白名单，如果没有，弹出加入电池优化的白名单的设置对话框。</span><br>        <span class="hljs-keyword">if</span> (!hasIgnored) {<br>            <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);<br>            intent.setData(Uri.parse(<span class="hljs-string">"package:"</span> + activity.getPackageName()));<br>            <span class="hljs-keyword">if</span> (intent.resolveActivity(getPackageManager()) != <span class="hljs-literal">null</span>) {<br>                startActivity(intent);<br>            }<br>        } <span class="hljs-keyword">else</span> {<br>            Log.d(<span class="hljs-string">"ignoreBattery"</span>, <span class="hljs-string">"hasIgnored"</span>);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>软键盘相关操作</title>
    <link href="/2023/08/26/docs/android/qi-ta/ruan-jian-pan-xiang-guan-cao-zuo/"/>
    <url>/2023/08/26/docs/android/qi-ta/ruan-jian-pan-xiang-guan-cao-zuo/</url>
    
    <content type="html"><![CDATA[<h1 id="软键盘相关操作"><a href="#软键盘相关操作" class="headerlink" title="软键盘相关操作"></a>软键盘相关操作</h1><h2 id="禁止EditorText自动弹出软键盘"><a href="#禁止EditorText自动弹出软键盘" class="headerlink" title="禁止EditorText自动弹出软键盘"></a>禁止EditorText自动弹出软键盘</h2><p>在控件父布局加上：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">...</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:focusable</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:focusableInTouchMode</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">...</span></span><br><span class="hljs-tag">        &gt;</span><br></code></pre></td></tr></tbody></table></figure><h2 id="弹出软键盘"><a href="#弹出软键盘" class="headerlink" title="弹出软键盘"></a>弹出软键盘</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">InputMethodManager imm=(InputMethodManager)getSystemService(Context.INPUT_METHOD_SERVICE);<br>        <span class="hljs-keyword">if</span>(imm!=<span class="hljs-literal">null</span>){<br>        imm.showSoftInput(view,InputMethodManager.SHOW_FORCED);<br>        }<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//推荐使用这种方式，针对不同Api有不同的实现</span><br> WindowInsetsControllerCompat(<br>    requireActivity().window,<br>    view<br> ).show(WindowInsetsCompat.Type.ime())<br></code></pre></td></tr></tbody></table></figure><h2 id="隐藏软键盘"><a href="#隐藏软键盘" class="headerlink" title="隐藏软键盘"></a>隐藏软键盘</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">InputMethodManager imm=(InputMethodManager)getSystemService(Context.INPUT_METHOD_SERVICE);<br>        <span class="hljs-keyword">if</span>(imm!=<span class="hljs-literal">null</span>&amp;&amp;view!=<span class="hljs-literal">null</span>){<br>        imm.hideSoftInputFromWindow(view.getWindowToken(),<span class="hljs-number">0</span>);<br>        }<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//推荐使用这种方式，针对不同Api有不同的实现</span><br> WindowInsetsControllerCompat(<br>    requireActivity().window,<br>    view<br> ).hide(WindowInsetsCompat.Type.ime())<br></code></pre></td></tr></tbody></table></figure><p>这些方法在大多数情况下都能凑效，但是有些情况可能怎么都无法通过代码隐藏软键盘，可以实现一个模拟返回键事件的功能，在子线程执行（目前未遇到这种情况，该方法未实际测试）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Instrumentation instrumentation=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Instrumentation</span>();<br>        instrumentation.sendKeyDownUpSync(KeyEvent.KEYCODE_BACK);<br></code></pre></td></tr></tbody></table></figure><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li>控件设置<code>enable</code>为<code>false</code>时，不需要手动清除焦点（<code>View.clearFocus()</code>）或手动执行隐藏键盘的方法，因为在 <code>setEnable()</code><br>方法里面已经执行隐藏键盘的相关逻辑了，手动调用 <code>clearFocus</code> 反而可能会引起异常。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TextView.java</span><br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">@android</span>.view.RemotableViewMethod<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> enabled)</span> {<br>    <span class="hljs-keyword">if</span> (enabled == isEnabled()) {<br>        <span class="hljs-keyword">return</span>;<br>    }<br>    <span class="hljs-keyword">if</span> (!enabled) {<br>        <span class="hljs-comment">// Hide the soft input if the currently active TextView is </span><br>        <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> getInputMethodManager();<br>        <span class="hljs-keyword">if</span> (imm != <span class="hljs-literal">null</span> &amp;&amp; imm.isActive(<span class="hljs-built_in">this</span>)) {<br>            imm.hideSoftInputFromWindow(getWindowToken(), <span class="hljs-number">0</span>);<br>        }<br>    }<br>    <span class="hljs-built_in">super</span>.setEnabled(enabled);<br>    <span class="hljs-keyword">if</span> (enabled) {<br>        <span class="hljs-comment">// Make sure IME is updated with current editor info.</span><br>        <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> getInputMethodManager();<br>        <span class="hljs-keyword">if</span> (imm != <span class="hljs-literal">null</span>) imm.restartInput(<span class="hljs-built_in">this</span>);<br>    }<br>    <span class="hljs-comment">// Will change text color</span><br>    <span class="hljs-keyword">if</span> (mEditor != <span class="hljs-literal">null</span>) {<br>        mEditor.invalidateTextDisplayList();<br>        mEditor.prepareCursorControllers();<br>        <span class="hljs-comment">// start or stop the cursor blinking as appropriate</span><br>        mEditor.makeBlink();<br>    }<br>}<br><br>...<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常用图片操作（旋转、缩放、相互转化等）</title>
    <link href="/2023/08/25/docs/android/gong-ju-lei/tu-pian-cao-zuo-xuan-zhuan-suo-fang-xiang-hu-zhuan-hua/"/>
    <url>/2023/08/25/docs/android/gong-ju-lei/tu-pian-cao-zuo-xuan-zhuan-suo-fang-xiang-hu-zhuan-hua/</url>
    
    <content type="html"><![CDATA[<h2 id="byte-Bitmap-YuvImage-Drawable-旋转、缩放、相互转化"><a href="#byte-Bitmap-YuvImage-Drawable-旋转、缩放、相互转化" class="headerlink" title="byte[],Bitmap,YuvImage,Drawable 旋转、缩放、相互转化"></a>byte[],Bitmap,YuvImage,Drawable 旋转、缩放、相互转化</h2><h3 id="1、byte-YuvImage-Bitmap"><a href="#1、byte-YuvImage-Bitmap" class="headerlink" title="1、byte(YuvImage )->Bitmap"></a>1、byte(YuvImage )-&gt;Bitmap</h3><p>在相机开发中，Camera获取到摄像头每一帧的图像数据byte[]，有时候需要把它转为Bitmap</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPreviewFrame</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[]data,Camera camera)</span>{<br>        camera.setPreviewCallback(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">if</span>(mCamera==<span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span>;<br><br>        Camera.Parameters parameters=camera.getParameters();<br>        <span class="hljs-type">int</span> width=parameters.getPreviewSize().width;<br>        <span class="hljs-type">int</span> height=parameters.getPreviewSize().height;<br><br>        YuvImage yuv=<span class="hljs-keyword">new</span> <span class="hljs-title class_">YuvImage</span>(data,parameters.getPreviewFormat(),width,height,<span class="hljs-literal">null</span>);<br><br>        ByteArrayOutputStream out=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        yuv.compressToJpeg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,width,height),<span class="hljs-number">50</span>,out);<br>        <span class="hljs-type">byte</span>[]bytes=out.toByteArray();<br><span class="hljs-keyword">final</span> Bitmap bitmap=BitmapFactory.decodeByteArray(bytes,<span class="hljs-number">0</span>,bytes.length);<br>        <span class="hljs-built_in">this</span>.mCamera.setPreviewCallback(<span class="hljs-built_in">this</span>);<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="2、byte-YuvImage-顺时针旋转90度"><a href="#2、byte-YuvImage-顺时针旋转90度" class="headerlink" title="2、byte(YuvImage )顺时针旋转90度"></a>2、byte(YuvImage )顺时针旋转90度</h3><p>Camera获取到摄像头图像帧数据，直接把byte[]数据进行图像旋转。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[]rotateYUV420Degree90(<span class="hljs-type">byte</span>[]data,<span class="hljs-type">int</span> imageWidth,<span class="hljs-type">int</span> imageHeight)<br>        {<br>        <span class="hljs-type">byte</span>[]yuv=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[imageWidth*imageHeight*<span class="hljs-number">3</span>/<span class="hljs-number">2</span>];<br>        <span class="hljs-comment">// Rotate the Y luma</span><br>        <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>;x&lt;imageWidth;x++)<br>        {<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> y=imageHeight-<span class="hljs-number">1</span>;y&gt;=<span class="hljs-number">0</span>;y--)<br>        {<br>        yuv[i]=data[y*imageWidth+x];<br>        i++;<br>        }<br>        }<br>        <span class="hljs-comment">// Rotate the U and V color components </span><br>        i=imageWidth*imageHeight*<span class="hljs-number">3</span>/<span class="hljs-number">2</span>-<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x=imageWidth-<span class="hljs-number">1</span>;x&gt;<span class="hljs-number">0</span>;x=x-<span class="hljs-number">2</span>)<br>        {<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> y=<span class="hljs-number">0</span>;y&lt;imageHeight/<span class="hljs-number">2</span>;y++)<br>        {<br>        yuv[i]=data[(imageWidth*imageHeight)+(y*imageWidth)+x];<br>        i--;<br>        yuv[i]=data[(imageWidth*imageHeight)+(y*imageWidth)+(x-<span class="hljs-number">1</span>)];<br>        i--;<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> yuv;<br>        }<br></code></pre></td></tr></tbody></table></figure><p>Android很多使用zxing扫码工具，关于获取预览帧进行旋转的代码，大多数都是错误的，包括徐医生的在内的。<br>我从Zxing官方项目，下载源码进行了优化和精简，使用了很多不错的特性。<br><a href="https://github.com/JantHsueh/ZxingAndroid">源码地址</a></p><h3 id="3-、从resources中获取Bitmap"><a href="#3-、从resources中获取Bitmap" class="headerlink" title="3 、从resources中获取Bitmap"></a>3 、从resources中获取Bitmap</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Resources res=getResources();<br>        Bitmap bmp=BitmapFactory.decodeResource(res,R.drawable.icon);<br></code></pre></td></tr></tbody></table></figure><h3 id="4、Bitmap-→-byte"><a href="#4、Bitmap-→-byte" class="headerlink" title="4、Bitmap → byte[]"></a>4、Bitmap → byte[]</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[]Bitmap2Bytes(Bitmap bm){<br>        ByteArrayOutputStream baos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        bm.compress(Bitmap.CompressFormat.PNG,<span class="hljs-number">100</span>,baos);<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="5、byte-→-Bitmap"><a href="#5、byte-→-Bitmap" class="headerlink" title="5、byte[] → Bitmap"></a>5、byte[] → Bitmap</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Bitmap <span class="hljs-title function_">Bytes2Bimap</span><span class="hljs-params">(<span class="hljs-type">byte</span>[]b)</span>{<br>        <span class="hljs-keyword">if</span>(b.length!=<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> BitmapFactory.decodeByteArray(b,<span class="hljs-number">0</span>,b.length);<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="6、将Drawable转化为Bitmap"><a href="#6、将Drawable转化为Bitmap" class="headerlink" title="6、将Drawable转化为Bitmap"></a>6、将Drawable转化为Bitmap</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">drawableToBitmap</span><span class="hljs-params">(Drawable drawable)</span>{<br>        <span class="hljs-comment">// 取 drawable 的长宽</span><br>        <span class="hljs-type">int</span> w=drawable.getIntrinsicWidth();<br>        <span class="hljs-type">int</span> h=drawable.getIntrinsicHeight();<br><br>        <span class="hljs-comment">// 取 drawable 的颜色格式</span><br>        Bitmap.Config config=drawable.getOpacity()!=PixelFormat.OPAQUE?Bitmap.Config.ARGB_8888:Bitmap.Config.RGB_565;<br>        <span class="hljs-comment">// 建立对应 bitmap</span><br>        Bitmap bitmap=Bitmap.createBitmap(w,h,config);<br>        <span class="hljs-comment">// 建立对应 bitmap 的画布</span><br>        Canvas canvas=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Canvas</span>(bitmap);<br>        drawable.setBounds(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,w,h);<br>        <span class="hljs-comment">// 把 drawable 内容画到画布中</span><br>        drawable.draw(canvas);<br>        <span class="hljs-keyword">return</span> bitmap;<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="7、Bitmap转换成Drawable"><a href="#7、Bitmap转换成Drawable" class="headerlink" title="7、Bitmap转换成Drawable"></a>7、Bitmap转换成Drawable</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Bitmap bm=xxx; <span class="hljs-comment">//xxx根据你的情况获取</span><br>        BitmapDrawable bd=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapDrawable</span>(getResource(),bm);<br><span class="hljs-comment">//因为BtimapDrawable是Drawable的子类，最终直接使用bd对象即可。</span><br></code></pre></td></tr></tbody></table></figure><h3 id="8、Bitmap缩放"><a href="#8、Bitmap缩放" class="headerlink" title="8、Bitmap缩放"></a>8、Bitmap缩放</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">zoomBitmap</span><span class="hljs-params">(Bitmap bitmap,<span class="hljs-type">int</span> width,<span class="hljs-type">int</span> height)</span>{<br>        <span class="hljs-type">int</span> w=bitmap.getWidth();<br>        <span class="hljs-type">int</span> h=bitmap.getHeight();<br>        Matrix matrix=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Matrix</span>();<br>        <span class="hljs-type">float</span> scaleWidth=((<span class="hljs-type">float</span>)width/w);<br>        <span class="hljs-type">float</span> scaleHeight=((<span class="hljs-type">float</span>)height/h);<br>        matrix.postScale(scaleWidth,scaleHeight);<br>        Bitmap newbmp=Bitmap.createBitmap(bitmap,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,w,h,matrix,<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> newbmp;<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="9、Drawable缩放"><a href="#9、Drawable缩放" class="headerlink" title="9、Drawable缩放"></a>9、Drawable缩放</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Drawable <span class="hljs-title function_">zoomDrawable</span><span class="hljs-params">(Drawable drawable,<span class="hljs-type">int</span> w,<span class="hljs-type">int</span> h)</span>{<br>        <span class="hljs-type">int</span> width=drawable.getIntrinsicWidth();<br>        <span class="hljs-type">int</span> height=drawable.getIntrinsicHeight();<br>        <span class="hljs-comment">// drawable转换成bitmap</span><br>        Bitmap oldbmp=drawableToBitmap(drawable);<br>        <span class="hljs-comment">// 创建操作图片用的Matrix对象</span><br>        Matrix matrix=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Matrix</span>();<br>        <span class="hljs-comment">// 计算缩放比例</span><br>        <span class="hljs-type">float</span> sx=((<span class="hljs-type">float</span>)w/width);<br>        <span class="hljs-type">float</span> sy=((<span class="hljs-type">float</span>)h/height);<br>        <span class="hljs-comment">// 设置缩放比例</span><br>        matrix.postScale(sx,sy);<br>        <span class="hljs-comment">// 建立新的bitmap，其内容是对原bitmap的缩放后的图</span><br>        Bitmap newbmp=Bitmap.createBitmap(oldbmp,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,width,height,matrix,<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapDrawable</span>(newbmp);<br>        }<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>工具类</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安卓静默安装软件</title>
    <link href="/2023/08/25/docs/android/gong-ju-lei/an-zhuo-jing-mo-an-zhuang-ruan-jian/"/>
    <url>/2023/08/25/docs/android/gong-ju-lei/an-zhuo-jing-mo-an-zhuang-ruan-jian/</url>
    
    <content type="html"><![CDATA[<h2 id="安卓静默安装软件"><a href="#安卓静默安装软件" class="headerlink" title="安卓静默安装软件"></a>安卓静默安装软件</h2><h3 id="InstallUtil"><a href="#InstallUtil" class="headerlink" title="InstallUtil"></a>InstallUtil</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> android.app.PendingIntent;<br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.content.pm.PackageInfo;<br><span class="hljs-keyword">import</span> android.content.pm.PackageInstaller;<br><span class="hljs-keyword">import</span> android.content.pm.PackageManager;<br><span class="hljs-keyword">import</span> android.os.Build;<br><span class="hljs-keyword">import</span> android.util.Log;<br><br><span class="hljs-keyword">import</span> com.kitking.upgrade.receiver.InstallResultReceiver;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><br><span class="hljs-keyword">import</span> androidx.annotation.RequiresApi;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstallUtil</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"InstallUtil"</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">mSessionId</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> PackageInstaller.SessionCallback mSessionCallback;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initSession</span><span class="hljs-params">(Context context)</span> {<br>        mSessionCallback = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstallSessionCallback</span>();<br>        context.getPackageManager().getPackageInstaller().registerSessionCallback(mSessionCallback);<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 适配android9的安装方法。</span><br><span class="hljs-comment">     * 全部替换安装</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installApp</span><span class="hljs-params">(Context context, String apkFilePath)</span> {<br>        Log.d(TAG, <span class="hljs-string">"installApp()-------&gt;"</span> + apkFilePath);<br><span class="hljs-comment">//        apkFilePath = apkFilePath.replace("storage/emulated/0","sdcard");</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">apkFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFilePath);<br>        <span class="hljs-keyword">if</span> (!apkFile.exists()) {<br>            Log.d(TAG, <span class="hljs-string">"文件不存在"</span>);<br>        }<br><br>        <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> context.getPackageManager().getPackageArchiveInfo(apkFilePath, PackageManager.GET_ACTIVITIES | PackageManager.GET_SERVICES);<br>        <span class="hljs-keyword">if</span> (packageInfo != <span class="hljs-literal">null</span>) {<br>            <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> packageInfo.packageName;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">versionCode</span> <span class="hljs-operator">=</span> packageInfo.versionCode;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">versionName</span> <span class="hljs-operator">=</span> packageInfo.versionName;<br>            Log.d(<span class="hljs-string">"ApkActivity"</span>, <span class="hljs-string">"packageName="</span> + packageName + <span class="hljs-string">", versionCode="</span> + versionCode + <span class="hljs-string">", versionName="</span> + versionName);<br>        }<br><br>        <span class="hljs-type">PackageInstaller</span> <span class="hljs-variable">packageInstaller</span> <span class="hljs-operator">=</span> context.getPackageManager().getPackageInstaller();<br>        PackageInstaller.<span class="hljs-type">SessionParams</span> <span class="hljs-variable">sessionParams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PackageInstaller</span>.SessionParams(PackageInstaller.SessionParams.MODE_FULL_INSTALL);<br>        Log.d(TAG, <span class="hljs-string">"apkFile length"</span> + apkFile.length());<br>        sessionParams.setSize(apkFile.length());<br><br>        <span class="hljs-keyword">try</span> {<br>            mSessionId = packageInstaller.createSession(sessionParams);<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br><br>        Log.d(TAG, <span class="hljs-string">"sessionId----&gt;"</span> + mSessionId);<br>        <span class="hljs-keyword">if</span> (mSessionId != -<span class="hljs-number">1</span>) {<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">copySuccess</span> <span class="hljs-operator">=</span> onTransfesApkFile(context,apkFilePath);<br>            Log.d(TAG, <span class="hljs-string">"copySuccess----&gt;"</span> + copySuccess);<br>            <span class="hljs-keyword">if</span> (copySuccess) {<br>                execInstallAPP(context);<br>            }<br>        }<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过文件流传输apk</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> apkFilePath</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTransfesApkFile</span><span class="hljs-params">(Context context, String apkFilePath)</span> {<br>        Log.d(TAG, <span class="hljs-string">"----------&gt;onTransfesApkFile()&lt;---------------------"</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        PackageInstaller.<span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-type">File</span> <span class="hljs-variable">apkFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFilePath);<br>            session = context.getPackageManager().getPackageInstaller().openSession(mSessionId);<br>            out = session.openWrite(<span class="hljs-string">"base.apk"</span>, <span class="hljs-number">0</span>, apkFile.length());<br>            in = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(apkFile);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, c;<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span> ((c = in.read(buffer)) != -<span class="hljs-number">1</span>) {<br>                total += c;<br>                out.write(buffer, <span class="hljs-number">0</span>, c);<br>            }<br>            session.fsync(out);<br>            Log.d(TAG, <span class="hljs-string">"streamed "</span> + total + <span class="hljs-string">" bytes"</span>);<br>            success = <span class="hljs-literal">true</span>;<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != session) {<br>                session.close();<br>            }<br>            <span class="hljs-keyword">try</span> {<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != out) {<br>                    out.close();<br>                }<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != in) {<br>                    in.close();<br>                }<br>            } <span class="hljs-keyword">catch</span> (IOException e) {<br>                e.printStackTrace();<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> success;<br>    }<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行安装并通知安装结果</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execInstallAPP</span><span class="hljs-params">(Context context)</span> {<br>        Log.d(TAG, <span class="hljs-string">"---------------------&gt;execInstallAPP()&lt;------------------"</span>);<br>        PackageInstaller.<span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            session = context.getPackageManager().getPackageInstaller().openSession(mSessionId);<br>            <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, InstallResultReceiver.class);<br>            <span class="hljs-type">PendingIntent</span> <span class="hljs-variable">pendingIntent</span> <span class="hljs-operator">=</span> PendingIntent.getBroadcast(context,<br>                    <span class="hljs-number">1</span>, intent,<br>                    PendingIntent.FLAG_UPDATE_CURRENT);<br>            session.commit(pendingIntent.getIntentSender());<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != session) {<br>                session.close();<br>            }<br>        }<br>    }<br><br>    <span class="hljs-meta">@RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstallSessionCallback</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PackageInstaller</span>.SessionCallback {<br>        String TAG=<span class="hljs-string">"InstallSessionCallback"</span>;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreated</span><span class="hljs-params">(<span class="hljs-type">int</span> sessionId)</span> {<br>            <span class="hljs-comment">// empty</span><br>            Log.d(TAG, <span class="hljs-string">"onCreated()"</span> + sessionId);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBadgingChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> sessionId)</span> {<br>            <span class="hljs-comment">// empty</span><br>            Log.d(TAG, <span class="hljs-string">"onBadgingChanged()"</span> + sessionId + <span class="hljs-string">"active"</span>);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActiveChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> sessionId, <span class="hljs-type">boolean</span> active)</span> {<br>            <span class="hljs-comment">// empty</span><br>            Log.d(TAG, <span class="hljs-string">"onActiveChanged()"</span> + sessionId + <span class="hljs-string">"active"</span> + active);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onProgressChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> sessionId, <span class="hljs-type">float</span> progress)</span> {<br>            Log.d(TAG, <span class="hljs-string">"onProgressChanged()"</span> + sessionId);<br>            <span class="hljs-keyword">if</span> (sessionId == -<span class="hljs-number">1</span>) {<br>                <span class="hljs-type">int</span> <span class="hljs-variable">progres</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Integer.MAX_VALUE * progress);<br>                Log.d(TAG, <span class="hljs-string">"onProgressChanged"</span> + progres);<br>            }<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFinished</span><span class="hljs-params">(<span class="hljs-type">int</span> sessionId, <span class="hljs-type">boolean</span> success)</span> {<br>            <span class="hljs-comment">// empty, finish is handled by InstallResultReceiver</span><br>            Log.d(TAG, <span class="hljs-string">"onFinished()"</span> + sessionId + <span class="hljs-string">"success"</span> + success);<br>            <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> == sessionId) {<br>                <span class="hljs-keyword">if</span> (success) {<br>                    Log.d(TAG, <span class="hljs-string">"onFinished() 安装成功"</span>);<br>                } <span class="hljs-keyword">else</span> {<br>                    Log.d(TAG, <span class="hljs-string">"onFinished() 安装失败"</span>);<br>                }<br><br>            }<br>        }<br>    }<br><br>}<br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>工具类</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>C  知识点汇总</title>
    <link href="/2023/08/24/docs/c/c-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/24/docs/c/c-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E5%A4%B4%E6%96%87%E4%BB%B6">头文件</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">数据类型</a></li><li><a href="#typedef">typedef</a></li><li><a href="#%E7%B1%BB%E5%9E%8B%E9%99%90%E5%AE%9A%E7%AC%A6">类型限定符</a></li><li><a href="#%E5%AE%9A%E4%B9%89%E5%B8%B8%E9%87%8F">定义常量</a></li><li><a href="#%E5%AD%98%E5%82%A8%E7%B1%BB">存储类</a></li><li><a href="#%E5%BC%95%E7%94%A8-vs-%E6%8C%87%E9%92%88">引用 vs 指针</a></li><li><a href="#struct-vs-class">struct vs class</a></li><li><a href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0">成员函数</a></li><li><a href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0">析构函数</a></li><li><a href="#%E6%8B%B7%E8%B4%9D%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">拷贝构造函数</a></li><li><a href="#friend-%E5%8F%8B%E5%85%83">friend 友元</a></li><li><a href="#inline-%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0">inline 内联函数</a></li><li><a href="#%E7%BB%A7%E6%89%BF%E7%B1%BB%E5%9E%8B">继承类型</a></li><li><a href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD">运算符重载</a></li><li><a href="#%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98">动态内存</a></li><li><a href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">命名空间</a></li><li><a href="#%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8">预处理器</a><ul><li><a href="#include">#include</a></li><li><a href="#define">#define</a></li><li><a href="#%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91">条件编译</a></li><li><a href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E5%AE%8F">预定义宏</a></li></ul></li><li><a href="#%E4%BF%A1%E5%8F%B7">信号</a></li><li><a href="#%E7%BA%BF%E7%A8%8B">线程</a></li><li><a href="#%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2">强制类型转换</a><ul><li><a href="#const_cast">const_cast</a></li><li><a href="#static_cast">static_cast</a></li><li><a href="#dynamic_cast">dynamic_cast</a></li><li><a href="#reinterupt_cast">reinterupt_cast</a></li></ul></li><li><a href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">智能指针</a><ul><li><a href="#unique_ptr">unique_ptr</a></li><li><a href="#shared_ptr">shared_ptr</a></li><li><a href="#weak_ptr">weak_ptr</a></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4">内存空间</a></li></ul><h1 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h1><p><strong>.h</strong> 文件中能包含：</p><ul><li>类成员数据的声明，但不能赋值</li><li>类静态数据成员的定义和赋值，但不建议</li><li>类的成员函数的声明</li><li>非类成员函数的声明</li><li>常数的定义：如：constint a=5;</li><li>静态函数的定义</li><li>类的内联函数的定义</li></ul><p>不能包含：</p><ul><li>所有非静态变量（不是类的数据成员）的声明</li><li>默认命名空间声明不要放在头文件，using namespace std; 等应放在 .cpp 中，在 .h 文件中使用 std::string</li></ul><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><table><thead><tr><th>类型</th><th>位</th></tr></thead><tbody><tr><td>char</td><td>1 个字节</td></tr><tr><td>int</td><td>4 个字节</td></tr><tr><td>short int</td><td>2 个字节</td></tr><tr><td>long int</td><td>8 个字节</td></tr><tr><td>float</td><td>4 个字节</td></tr><tr><td>double</td><td>8 个字节</td></tr><tr><td>long double</td><td>16 个字节</td></tr><tr><td>wchar_t</td><td>2 或 4 个字节</td></tr></tbody></table><h1 id="typedef"><a href="#typedef" class="headerlink" title="typedef"></a>typedef</h1><p>使用 typedef 为一个已有的类型取一个新的名字</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> type newname; <br></code></pre></td></tr></tbody></table></figure><h1 id="类型限定符"><a href="#类型限定符" class="headerlink" title="类型限定符"></a>类型限定符</h1><table><thead><tr><th>限定符</th><th>含义</th></tr></thead><tbody><tr><td>const</td><td>const 类型的对象在程序执行期间不能被修改改变。</td></tr><tr><td>volatile</td><td>修饰符 volatile 告诉编译器不需要优化volatile声明的变量，让程序可以直接从内存中读取变量。对于一般的变量编译器会对变量进行优化，将内存中的变量值放在寄存器中以加快读写效率。</td></tr><tr><td>restrict</td><td>由 restrict 修饰的指针是唯一一种访问它所指向的对象的方式。只有 C99 增加了新的类型限定符 restrict。</td></tr></tbody></table><h1 id="定义常量"><a href="#定义常量" class="headerlink" title="定义常量"></a>定义常量</h1><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用 #define 预处理器</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LENGTH 10</span><br><br><span class="hljs-comment">// const 关键字</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> WIDTH  = <span class="hljs-number">5</span>;<br></code></pre></td></tr></tbody></table></figure><h1 id="存储类"><a href="#存储类" class="headerlink" title="存储类"></a>存储类</h1><table><thead><tr><th>存储类</th><th>含义</th></tr></thead><tbody><tr><td>auto</td><td>声明变量时根据初始化表达式自动推断该变量的类型</td></tr><tr><td>register</td><td>用于定义存储在寄存器中而不是 RAM 中的局部变量，用于需要快速访问的变量，不能对它应用一元的 ‘&amp;’ 运算符（因为它没有内存位置）</td></tr><tr><td>static</td><td>用在类数据成员上时，会导致仅有一个该成员的副本被类的所有对象共享；修饰全局变量时，会使变量的作用域限制在声明它的文件内</td></tr><tr><td>extern</td><td>全局变量的引用，全局变量对所有的程序文件都是可见</td></tr><tr><td>mutable</td><td></td></tr><tr><td>thread_local</td><td>仅可在它在其上创建的线程上访问，变量在创建线程时创建，并在销毁线程时销毁，每个线程都有其自己的变量副本</td></tr></tbody></table><h1 id="引用-vs-指针"><a href="#引用-vs-指针" class="headerlink" title="引用 vs 指针"></a>引用 vs 指针</h1><ul><li>不存在空引用。引用必须连接到一块合法的内存。</li><li>一旦引用被初始化为一个对象，就不能被指向到另一个对象。指针可以在任何时候指向到另一个对象。</li><li>引用必须在创建时被初始化。指针可以在任何时间被初始化。</li></ul><h1 id="struct-vs-class"><a href="#struct-vs-class" class="headerlink" title="struct vs class"></a>struct vs class</h1><p>class 和 struct 定义类的唯一区别是默认的反问权限，struct 默认是 public，class 默认是 private。</p><h1 id="成员函数"><a href="#成员函数" class="headerlink" title="成员函数"></a>成员函数</h1><p>成员函数可以在类的外部使用范围解析运算符 :: 定义该函数</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">Box::getVolume</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>{<br>    <span class="hljs-keyword">return</span> length * breadth * height;<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h1><p>析构函数是类的一种特殊的成员函数，它会在每次删除所创建的对象时执行</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Line</span><br>{<br>   <span class="hljs-keyword">public</span>:<br>      ~<span class="hljs-built_in">Line</span>();  <span class="hljs-comment">// 这是析构函数声明</span><br> <br>   <span class="hljs-keyword">private</span>:<br>      <span class="hljs-type">double</span> length;<br>};<br> <br>Line::~<span class="hljs-built_in">Line</span>(<span class="hljs-type">void</span>)<br>{<br>    cout &lt;&lt; <span class="hljs-string">"Object is being deleted"</span> &lt;&lt; endl;<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="拷贝构造函数"><a href="#拷贝构造函数" class="headerlink" title="拷贝构造函数"></a>拷贝构造函数</h1><p>拷贝构造函数是一种特殊的构造函数，它在创建对象时，是使用同一类中之前创建的对象来初始化新创建的对象。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Line</span><br>{<br>   <span class="hljs-keyword">public</span>:<br>      <span class="hljs-built_in">Line</span>(<span class="hljs-type">int</span> len);             <span class="hljs-comment">// 简单的构造函数</span><br>      <span class="hljs-built_in">Line</span>(<span class="hljs-type">const</span> Line &amp;obj);      <span class="hljs-comment">// 拷贝构造函数</span><br> <br>   <span class="hljs-keyword">private</span>:<br>      <span class="hljs-type">int</span> *ptr;<br>};<br><br>Line::<span class="hljs-built_in">Line</span>(<span class="hljs-type">const</span> Line &amp;obj)<br>{<br>    cout &lt;&lt; <span class="hljs-string">"调用拷贝构造函数并为指针 ptr 分配内存"</span> &lt;&lt; endl;<br>    ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>;<br>    *ptr = *obj.ptr; <span class="hljs-comment">// 拷贝值</span><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="friend-友元"><a href="#friend-友元" class="headerlink" title="friend 友元"></a>friend 友元</h1><p>类的友元函数是定义在类外部，但有权访问类的所有私有（private）成员和保护（protected）成员。尽管友元函数的原型有在类的定义中出现过，但是友元函数并不是成员函数。</p><p>友元也可以是一个类，该类被称为友元类类。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span><br>{<br><span class="hljs-keyword">private</span>:<br>   <span class="hljs-type">double</span> width;<br><span class="hljs-keyword">public</span>:<br>   <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">printWidth</span><span class="hljs-params">(Box box)</span></span>;<br>   <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setWidth</span><span class="hljs-params">(<span class="hljs-type">double</span> wid)</span></span>;<br>};<br><br><span class="hljs-comment">// 请注意：printWidth() 不是任何类的成员函数</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printWidth</span><span class="hljs-params">(Box box)</span></span><br><span class="hljs-function"></span>{<br>   <span class="hljs-comment">/* 因为 printWidth() 是 Box 的友元，它可以直接访问该类的任何成员 */</span><br>   cout &lt;&lt; <span class="hljs-string">"Width of box : "</span> &lt;&lt; box.width &lt;&lt;endl;<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="inline-内联函数"><a href="#inline-内联函数" class="headerlink" title="inline 内联函数"></a>inline 内联函数</h1><p>如果一个函数是内联的，那么在编译时，编译器会把该函数的代码副本放置在每个调用该函数的地方。对内联函数进行任何修改，都需要重新编译函数的所有客户端，因为编译器需要重新更换一次所有的代码，否则将会继续使用旧的函数。</p><h1 id="继承类型"><a href="#继承类型" class="headerlink" title="继承类型"></a>继承类型</h1><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span>: <span class="hljs-keyword">public</span> Shape <br>{<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><table><thead><tr><th>继承类型</th><th>说明</th></tr></thead><tbody><tr><td>public</td><td>基类的公有成员也是派生类的公有成员，基类的保护成员也是派生类的保护成员，基类的私有成员不能直接被派生类访问</td></tr><tr><td>protected</td><td>基类的公有和保护成员将成为派生类的保护成员。</td></tr><tr><td>private</td><td>基类的公有和保护成员将成为派生类的私有成员。</td></tr></tbody></table><h1 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h1><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span><br>{<br><span class="hljs-keyword">public</span>:<br>   <span class="hljs-type">double</span> length;      <span class="hljs-comment">// 长度</span><br>   <span class="hljs-type">double</span> breadth;     <span class="hljs-comment">// 宽度</span><br>   <br>   <span class="hljs-comment">// 重载 + 运算符，用于把两个 Box 对象相加</span><br>   Box <span class="hljs-keyword">operator</span>+(<span class="hljs-type">const</span> Box&amp; b)<br>   {<br>      Box box;<br>      box.length = <span class="hljs-keyword">this</span>-&gt;length + b.length;<br>      box.breadth = <span class="hljs-keyword">this</span>-&gt;breadth + b.breadth;<br>      <span class="hljs-keyword">return</span> box;<br>   }<br>};<br></code></pre></td></tr></tbody></table></figure><h1 id="动态内存"><a href="#动态内存" class="headerlink" title="动态内存"></a>动态内存</h1><p>new 运算符为给定类型的变量在运行时分配堆内的内存，这会返回所分配的空间地址。如果不再需要动态分配的内存空间，可以使用 delete<br>运算符，删除之前由 new 运算符分配的内存。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">double</span>* pvalue = <span class="hljs-keyword">new</span> <span class="hljs-type">double</span><br>···<br><span class="hljs-keyword">delete</span> pvalue; <br></code></pre></td></tr></tbody></table></figure><h1 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h1><p>命名空间的定义使用关键字 namespace，后跟命名空间的名称：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">namespace</span> namespace_name {<br>   <span class="hljs-comment">// 代码声明</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>为了调用带有命名空间的函数或变量，需要在前面加上命名空间的名称：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">name::code;  <span class="hljs-comment">// code 可以是变量或函数</span><br></code></pre></td></tr></tbody></table></figure><p>使用 using namespace 指令，这样在使用命名空间时就可以不用在前面加上命名空间的名称。这个指令会告诉编译器，后续的代码将使用指定的命名空间中的名称：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br></code></pre></td></tr></tbody></table></figure><h1 id="预处理器"><a href="#预处理器" class="headerlink" title="预处理器"></a>预处理器</h1><h2 id="include"><a href="#include" class="headerlink" title="#include"></a>#include</h2><p><strong>include</strong> 是一个来自 C 语言的宏命令，它在编译器进行编译之前，即在预编译的时候就会起作用。#include<br>的作用是把它后面所写的那个文件的内容一字不改地包含到当前的文件中来。值得一提的是，它本身是没有其它任何作用与副功能的，它的作用就是把每一个它出现的地方，替换成它后面所写的那个文件的内容。</p><ul><li>系统自带的头文件用尖括号括起来，这样编译器会在系统文件目录下查找。</li><li>用户自定义的文件用双引号括起来，编译器首先会在用户目录下查找，然后在到 C++ 安装目录（比如 VC 中可以指定和修改库文件查找路径，Unix<br>和 Linux 中可以通过环境变量来设定）中查找，最后在系统文件中查找。</li></ul><h2 id="define"><a href="#define" class="headerlink" title="#define"></a>#define</h2><p>#define 预处理指令用于创建符号常量。该符号常量通常称为宏，指令的一般形式是：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> macro-name replacement-text </span><br></code></pre></td></tr></tbody></table></figure><ul><li>示例</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PI 3.14159</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN(a,b) (a&lt;b ? a : b)</span><br></code></pre></td></tr></tbody></table></figure><h2 id="条件编译"><a href="#条件编译" class="headerlink" title="条件编译"></a>条件编译</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEBUG</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEBUG</span><br>   cerr &lt;&lt;<span class="hljs-string">"Trace: Inside main function"</span> &lt;&lt; endl;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></tbody></table></figure><h2 id="预定义宏"><a href="#预定义宏" class="headerlink" title="预定义宏"></a>预定义宏</h2><table><thead><tr><th>宏</th><th>描述</th></tr></thead><tbody><tr><td>__LINE__</td><td>程序编译时包含当前行号</td></tr><tr><td>__FILE__</td><td>程序编译时包含当前文件名</td></tr><tr><td>__DATE__</td><td>包含一个形式为 month/day/year 的字符串，它表示把源文件转换为目标代码的日期</td></tr><tr><td>__TIME__</td><td>包含一个形式为 hour:minute:second 的字符串，它表示程序被编译的时</td></tr></tbody></table><h1 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h1><table><thead><tr><th>信号</th><th>描述</th></tr></thead><tbody><tr><td>SIGABRT</td><td>程序的异常终止，如调用 abort</td></tr><tr><td>SIGFPE</td><td>错误的算术运算，比如除以零或导致溢出的操作</td></tr><tr><td>SIGILL</td><td>检测非法指令</td></tr><tr><td>SIGINT</td><td>程序终止(interrupt)信号</td></tr><tr><td>SIGSEGV</td><td>非法访问内存</td></tr><tr><td>SIGTERM</td><td>发送到程序的终止请求</td></tr></tbody></table><p>C++ 信号处理库提供了 signal 函数，用来捕获突发事件，raise 函数来生成信号：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;csignal&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br> <br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br> <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signalHandler</span><span class="hljs-params">( <span class="hljs-type">int</span> signum )</span></span><br><span class="hljs-function"></span>{<br>    cout &lt;&lt; <span class="hljs-string">"Interrupt signal ("</span> &lt;&lt; signum &lt;&lt; <span class="hljs-string">") received.\n"</span>;<br>    <span class="hljs-built_in">exit</span>(signum);  <br>}<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 注册信号 SIGINT 和信号处理程序</span><br>    <span class="hljs-built_in">signal</span>(SIGINT, signalHandler);  <br>    <span class="hljs-built_in">raise</span>(SIGINT);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>c++ 11 之后有了标准的线程库</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br>std::thread::id main_thread_id = std::this_thread::<span class="hljs-built_in">get_id</span>();<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span>  </span><br><span class="hljs-function"></span>{<br>    std::cout &lt;&lt; <span class="hljs-string">"Hello Concurrent World\n"</span>;<br>    <span class="hljs-keyword">if</span> (main_thread_id == std::this_thread::<span class="hljs-built_in">get_id</span>())<br>        std::cout &lt;&lt; <span class="hljs-string">"This is the main thread.\n"</span>;<br>    <span class="hljs-keyword">else</span><br>        std::cout &lt;&lt; <span class="hljs-string">"This is not the main thread.\n"</span>;<br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pause_thread</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{<br>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(n));<br>    std::cout &lt;&lt; <span class="hljs-string">"pause of "</span> &lt;&lt; n &lt;&lt; <span class="hljs-string">" seconds ended\n"</span>;<br>}<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(hello)</span></span>;<br>    std::cout &lt;&lt; t.<span class="hljs-built_in">hardware_concurrency</span>() &lt;&lt; std::endl;<span class="hljs-comment">//可以并发执行多少个(不准确)</span><br>    std::cout &lt;&lt; <span class="hljs-string">"native_handle "</span> &lt;&lt; t.<span class="hljs-built_in">native_handle</span>() &lt;&lt; std::endl;<span class="hljs-comment">//可以并发执行多少个(不准确)</span><br>    t.<span class="hljs-built_in">join</span>();<br>    <span class="hljs-function">std::thread <span class="hljs-title">a</span><span class="hljs-params">(hello)</span></span>;<br>    a.<span class="hljs-built_in">detach</span>();<br>    std::thread threads[<span class="hljs-number">5</span>];                         <span class="hljs-comment">// 默认构造线程</span><br><br>    std::cout &lt;&lt; <span class="hljs-string">"Spawning 5 threads...\n"</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i)<br>        threads[i] = std::<span class="hljs-built_in">thread</span>(pause_thread, i + <span class="hljs-number">1</span>);   <span class="hljs-comment">// move-assign threads</span><br>    std::cout &lt;&lt; <span class="hljs-string">"Done spawning threads. Now waiting for them to join:\n"</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;thread : threads)<br>        thread.<span class="hljs-built_in">join</span>();<br>    std::cout &lt;&lt; <span class="hljs-string">"All threads joined!\n"</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="强制类型转换"><a href="#强制类型转换" class="headerlink" title="强制类型转换"></a>强制类型转换</h1><h2 id="const-cast"><a href="#const-cast" class="headerlink" title="const_cast"></a>const_cast</h2><p>const_cast 用于去除对象的 const 或 volatile 属性</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Func</span><span class="hljs-params">(<span class="hljs-type">double</span>&amp; d)</span> </span>{ ... }  <br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ConstCast</span><span class="hljs-params">()</span>  </span><br><span class="hljs-function"></span>{  <br>   <span class="hljs-type">const</span> <span class="hljs-type">double</span> pi = <span class="hljs-number">3.14</span>;  <br>   <span class="hljs-built_in">Func</span>(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">double</span>&amp;&gt;(pi)); <span class="hljs-comment">// No error.  </span><br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="static-cast"><a href="#static-cast" class="headerlink" title="static_cast"></a>static_cast</h2><p>static_cast 强制转换只会在编译时检查，但没有运行时类型检查来保证转换的安全性。同时，static_cast 也不能去掉 expression 的<br>const、volitale、或者 __unaligned 属性。</p><p>其主要应用场景有：</p><ul><li>用于类层次结构中基类（父类）和派生类（子类）之间指针或引用的转换。进行上行转换（把派生类的指针或引用转换成基类表示）是安全的；进行下行转换（把基类指针或引用转换成派生类表示）时，由于没有动态类型检查，所以是不安全的。</li><li>用于基本数据类型之间的转换，如把 int 转换成char，把 int 转换成enum。这种转换的安全性也要开发人员来保证。</li><li>把 void 转换成目标类型的空指针.</li><li>把任何类型的表达式转换成 void 类型。</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Sub sub;<br>Base *base_ptr = <span class="hljs-built_in">static_cast</span>&lt;Base*&gt;(&amp;sub);  <br></code></pre></td></tr></tbody></table></figure><h2 id="dynamic-cast"><a href="#dynamic-cast" class="headerlink" title="dynamic_cast"></a>dynamic_cast</h2><p>dynamic_cast 运算符的主要用途：将基类的指针或引用安全地转换成派生类的指针或引用。并用派生类的指针或引用调用非虚函数。</p><p>如果是基类指针或引用调用的是虚函数无需转换就能在运行时调用派生类的虚函数。</p><p>前提条件：当我们将 dynamic_cast 用于某种类型的指针或引用时，只有该类型至少含有虚函数时(最简单是基类析构函数为虚函数)<br>，才能进行这种转换。否则，编译器会报错。</p><p>在指针类型中，基类指针所指对象为基类类型，在这种情况下 dynamic_cast 在运行时做检查，转换失败，返回结果为 0；</p><p>在引用类型中，并不存在空引用，所以引用的 dynamic_cast 检测失败时会抛出一个 bad_cast 异常。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Base * base = <span class="hljs-keyword">new</span> Base;<br><span class="hljs-keyword">if</span> (Derived *der = <span class="hljs-built_in">dynamic_cast</span>&lt;Derived*&gt;(base))<br>{<br>    cout &lt;&lt; <span class="hljs-string">"转换成功"</span> &lt;&lt;endl;<br>    der-&gt;<span class="hljs-built_in">Show</span>();<br>}<br><span class="hljs-keyword">else</span> <br>{<br>    cout &lt;&lt; <span class="hljs-string">"转换失败"</span> &lt;&lt;endl;<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="reinterupt-cast"><a href="#reinterupt-cast" class="headerlink" title="reinterupt_cast"></a>reinterupt_cast</h2><p>reinterpret_cast 用来处理无关类型转换，通常为操作数的位模式提供较低层次的重新解释。</p><p>推荐使用在：</p><ul><li>从指针类型到一个足够大的整数类型</li><li>从整数类型或者枚举类型到指针类型</li><li>从一个指向函数的指针到另一个不同类型的指向函数的指针</li><li>从一个指向对象的指针到另一个不同类型的指向对象的指针</li><li>从一个指向类函数成员的指针到另一个指向不同类型的函数成员的指针</li><li>从一个指向类数据成员的指针到另一个指向不同类型的数据成员的指针</li></ul><p>错误的使用 reinterpret_cast 很容易导致程序的不安全，只有将转换后的类型值转换回到其原始类型，这样才是正确使用<br>reinterpret_cast 方式。</p><h1 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h1><h2 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h2><p>由 unique_ptr 管理的内存，只能被一个对象持有，所以，unique_ptr不支持复制和赋值。想要把一个 unique_ptr 的内存交给另外一个<br>unique_ptr 对象管理。只能使用 std::move 转移当前对象的所有权。转移之后，当前对象不再持有此内存，新的对象将获得专属所有权。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> w = std::<span class="hljs-built_in">make_unique</span>&lt;Widget&gt;();<br><span class="hljs-keyword">auto</span> w2 = std::<span class="hljs-built_in">move</span>(w); <span class="hljs-comment">// w2 获得内存所有权，w 此时等于 nullptr</span><br></code></pre></td></tr></tbody></table></figure><p>unique_ptr在默认情况下和裸指针的大小是一样的，所以内存上没有任何的额外消耗，性能是最优的。</p><h2 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h2><p>多个智能指针可以共享同一个对象。shared_ptr 内部是利用引用计数来实现内存的自动管理，每当复制一个 shared_ptr，引用计数会<br>+1。当一个 shared_ptr 离开作用域时，引用计数会 -1。当引用计数为0的时候，则 delete 内存。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> w = std::<span class="hljs-built_in">make_shared</span>&lt;Widget&gt;();<br></code></pre></td></tr></tbody></table></figure><p>shared_ptr的内存占用是裸指针的两倍。因为除了要管理一个裸指针外，还要维护一个引用计数。</p><h2 id="weak-ptr"><a href="#weak-ptr" class="headerlink" title="weak_ptr"></a>weak_ptr</h2><p>允许你共享但不拥有某对象，一旦最末一个拥有该对象的智能指针失去了所有权，任何 weak_ptr 都会自动成空。</p><h1 id="内存空间"><a href="#内存空间" class="headerlink" title="内存空间"></a>内存空间</h1><table><thead><tr><th>区</th><th>秒速</th></tr></thead><tbody><tr><td>堆</td><td>操作系统维护的一块动态分配内存，malloc 在堆上分配的内存块，使用 free 释放内存</td></tr><tr><td>栈</td><td>由编译器自动分配释放，存放函数的参数值，局部变量的值等</td></tr><tr><td>自由存储区</td><td>C++ 中通过 new 与 delete 动态分配和释放对象的抽象概念</td></tr><tr><td>全局区（静态区）</td><td>全局变量和静态变量分配在此一块内存中</td></tr><tr><td>常量存储区</td><td>存储常量字符串, 程序结束后由系统释放</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>C</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android扩展知识点</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/android-kuo-zhan-zhi-shi-dian/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/android-kuo-zhan-zhi-shi-dian/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#art">ART</a><ul><li><a href="#art-%E5%8A%9F%E8%83%BD">ART 功能</a><ul><li><a href="#%E9%A2%84%E5%85%88-aot-%E7%BC%96%E8%AF%91">预先 (AOT) 编译</a></li><li><a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%BC%98%E5%8C%96">垃圾回收优化</a></li><li><a href="#%E5%BC%80%E5%8F%91%E5%92%8C%E8%B0%83%E8%AF%95%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BC%98%E5%8C%96">开发和调试方面的优化</a></li></ul></li><li><a href="#art-gc">ART GC</a></li></ul></li><li><a href="#hook">Hook</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">基本流程</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">使用示例</a></li></ul></li><li><a href="#proguard">Proguard</a><ul><li><a href="#%E8%A7%84%E5%88%99">规则</a></li><li><a href="#%E5%85%AC%E5%85%B1%E6%A8%A1%E6%9D%BF">公共模板</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B7%B7%E6%B7%86%E8%A7%84%E5%88%99">常用的自定义混淆规则</a></li><li><a href="#aar%E4%B8%AD%E5%A2%9E%E5%8A%A0%E7%8B%AC%E7%AB%8B%E7%9A%84%E6%B7%B7%E6%B7%86%E9%85%8D%E7%BD%AE">aar中增加独立的混淆配置</a></li><li><a href="#%E6%A3%80%E6%9F%A5%E6%B7%B7%E6%B7%86%E5%92%8C%E8%BF%BD%E8%B8%AA%E5%BC%82%E5%B8%B8">检查混淆和追踪异常</a></li></ul></li><li><a href="#%E6%9E%B6%E6%9E%84">架构</a><ul><li><a href="#mvc">MVC</a></li><li><a href="#mvp">MVP</a></li><li><a href="#mvvm">MVVM</a></li></ul></li><li><a href="#jetpack">Jetpack</a><ul><li><a href="#%E6%9E%B6%E6%9E%84-1">架构</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1">使用示例</a></li></ul></li><li><a href="#ndk-%E5%BC%80%E5%8F%91">NDK 开发</a><ul><li><a href="#jni-%E5%9F%BA%E7%A1%80">JNI 基础</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">数据类型</a></li><li><a href="#string-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0%E6%93%8D%E4%BD%9C">String 字符串函数操作</a></li><li><a href="#%E5%B8%B8%E7%94%A8-jni-%E8%AE%BF%E9%97%AE-java-%E5%AF%B9%E8%B1%A1%E6%96%B9%E6%B3%95">常用 JNI 访问 Java 对象方法</a></li></ul></li><li><a href="#ndk-%E5%BC%80%E5%8F%91-1">NDK 开发</a><ul><li><a href="#%E5%9F%BA%E7%A1%80%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B">基础开发流程</a></li><li><a href="#systemloadlibrary">System.loadLibrary()</a></li></ul></li><li><a href="#cmake-%E6%9E%84%E5%BB%BA-ndk-%E9%A1%B9%E7%9B%AE">CMake 构建 NDK 项目</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E7%9A%84-android-ndk-%E5%8E%9F%E7%94%9F-api">常用的 Android NDK 原生 API</a></li></ul></li><li><a href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">类加载器</a><ul><li><a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F">双亲委托模式</a></li><li><a href="#dexpathlist">DexPathList</a></li></ul></li></ul><h1 id="ART"><a href="#ART" class="headerlink" title="ART"></a>ART</h1><p>ART 代表 Android Runtime，其处理应用程序执行的方式完全不同于 Dalvik，Dalvik 是依靠一个 Just-In-Time (JIT)<br>编译器去解释字节码。开发者编译后的应用代码需要通过一个解释器在用户的设备上运行，这一机制并不高效，但让应用能更容易在不同硬件和架构上运<br>行。ART 则完全改变了这套做法，在应用安装时就预编译字节码到机器语言，这一机制叫 Ahead-Of-Time (<br>AOT）编译。在移除解释代码这一过程后，应用程序执行将更有效率，启动更快。</p><h2 id="ART-功能"><a href="#ART-功能" class="headerlink" title="ART 功能"></a>ART 功能</h2><h3 id="预先-AOT-编译"><a href="#预先-AOT-编译" class="headerlink" title="预先 (AOT) 编译"></a>预先 (AOT) 编译</h3><p>ART 引入了预先编译机制，可提高应用的性能。ART 还具有比 Dalvik 更严格的安装时验证。在安装时，ART 使用设备自带的 dex2oat<br>工具来编译应用。该实用工具接受 DEX 文件作为输入，并为目标设备生成经过编译的应用可执行文件。该工具应能够顺利编译所有有效的<br>DEX 文件。</p><h3 id="垃圾回收优化"><a href="#垃圾回收优化" class="headerlink" title="垃圾回收优化"></a>垃圾回收优化</h3><p>垃圾回收 (GC) 可能有损于应用性能，从而导致显示不稳定、界面响应速度缓慢以及其他问题。ART 通过以下几种方式对垃圾回收做了优化：</p><ul><li>只有一次（而非两次）GC 暂停</li><li>在 GC 保持暂停状态期间并行处理</li><li>在清理最近分配的短时对象这种特殊情况中，回收器的总 GC 时间更短</li><li>优化了垃圾回收的工效，能够更加及时地进行并行垃圾回收，这使得 GC_FOR_ALLOC 事件在典型用例中极为罕见</li><li>压缩 GC 以减少后台内存使用和碎片</li></ul><h3 id="开发和调试方面的优化"><a href="#开发和调试方面的优化" class="headerlink" title="开发和调试方面的优化"></a>开发和调试方面的优化</h3><ul><li>支持采样分析器</li></ul><p>一直以来，开发者都使用 Traceview 工具（用于跟踪应用执行情况）作为分析器。虽然 Traceview 可提供有用的信息，但每次方法调用产生的开销会导致<br>Dalvik 分析结果出现偏差，而且使用该工具明显会影响运行时性能</p><p>ART 添加了对没有这些限制的专用采样分析器的支持，因而可更准确地了解应用执行情况，而不会明显减慢速度。KitKat 版本为 Dalvik 的<br>Traceview 添加了采样支持。</p><ul><li>支持更多调试功能</li></ul><p>ART 支持许多新的调试选项，特别是与监控和垃圾回收相关的功能。例如，查看堆栈跟踪中保留了哪些锁，然后跳转到持有锁的线程；询问指定类的当前活动的实例数、请求查看实例，以及查看使对象保持有效状态的参考；过滤特定实例的事件（如断点）等。</p><ul><li>优化了异常和崩溃报告中的诊断详细信息</li></ul><p>当发生运行时异常时，ART 会为您提供尽可能多的上下文和详细信息。ART<br>会提供 <code>java.lang.ClassCastException</code>、<code>java.lang.ClassNotFoundException</code> 和 <code>java.lang.NullPointerException</code><br>的更多异常详细信息（较高版本的 Dalvik 会提供 <code>java.lang.ArrayIndexOutOfBoundsException</code><br>和 <code>java.lang.ArrayStoreException</code> 的更多异常详细信息，这些信息现在包括数组大小和越界偏移量；ART 也提供这类信息）。</p><h2 id="ART-GC"><a href="#ART-GC" class="headerlink" title="ART GC"></a>ART GC</h2><p>ART 有多个不同的 GC 方案，这些方案包括运行不同垃圾回收器。默认方案是 CMS（并发标记清除）方案，主要使用粘性 CMS 和部分 CMS。粘性<br>CMS 是 ART 的不移动分代垃圾回收器。它仅扫描堆中自上次 GC 后修改的部分，并且只能回收自上次 GC 后分配的对象。除 CMS<br>方案外，当应用将进程状态更改为察觉不到卡顿的进程状态（例如，后台或缓存）时，ART 将执行堆压缩。</p><p>除了新的垃圾回收器之外，ART 还引入了一种基于位图的新内存分配程序，称为<br>RosAlloc（插槽运行分配器）。此新分配器具有分片锁，当分配规模较小时可添加线程的本地缓冲区，因而性能优于 DlMalloc。</p><p>与 Dalvik 相比，ART CMS 垃圾回收计划在很多方面都有一定的改善：</p><ul><li><p>与 Dalvik 相比，暂停次数从 2 次减少到 1 次。Dalvik 的第一次暂停主要是为了进行根标记，即在 ART 中进行并发标记，让线程标记自己的根，然后马上恢复运行。</p></li><li><p>与 Dalvik 类似，ART GC 在清除过程开始之前也会暂停 1 次。两者在这方面的主要差异在于：在此暂停期间，某些 Dalvik 环节在 ART<br>中并发进行。这些环节包括 java.lang.ref.Reference 处理、系统弱清除（例如，jni 弱全局等）、重新标记非线程根和卡片预清理。在 ART<br>暂停期间仍进行的阶段包括扫描脏卡片以及重新标记线程根，这些操作有助于缩短暂停时间。</p></li><li><p>相对于 Dalvik，ART GC 改进的最后一个方面是粘性 CMS 回收器增加了 GC 吞吐量。不同于普通的分代 GC，粘性 CMS<br>不移动。系统会将年轻对象保存在一个分配堆栈（基本上是 java.lang.Object<br>数组）中，而非为其设置一个专属区域。这样可以避免移动所需的对象以维持低暂停次数，但缺点是容易在堆栈中加入大量复杂对象图像而使堆栈变长。</p></li></ul><p>ART GC 与 Dalvik 的另一个主要区别在于 ART GC 引入了移动垃圾回收器。使用移动 GC 的目的在于通过堆压缩来减少后台应用使用的内存。目前，触发堆压缩的事件是<br>ActivityManager 进程状态的改变。当应用转到后台运行时，它会通知 ART 已进入不再“感知”卡顿的进程状态。此时 ART<br>会进行一些操作（例如，压缩和监视器压缩），从而导致应用线程长时间暂停。目前正在使用的两个移动 GC 是同构空间压缩和半空间压缩。</p><ul><li><p>半空间压缩将对象在两个紧密排列的碰撞指针空间之间进行移动。这种移动 GC<br>适用于小内存设备，因为它可以比同构空间压缩稍微多节省一点内存。额外节省出的空间主要来自紧密排列的对象，这样可以避免<br>RosAlloc/DlMalloc 分配器占用开销。由于 CMS 仍在前台使用，且不能从碰撞指针空间中进行收集，因此当应用在前台使用时，半空间还要再进行一次转换。这种情况并不理想，因为它可能引起较长时间的暂停。</p></li><li><p>同构空间压缩通过将对象从一个 RosAlloc 空间复制到另一个 RosAlloc<br>空间来实现。这有助于通过减少堆碎片来减少内存使用量。这是目前非低内存设备的默认压缩模式。相比半空间压缩，同构空间压缩的主要优势在于应用从后台切换到前台时无需进行堆转换。</p></li></ul><h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><p>1、根据需求确定 要 hook 的对象<br>2、寻找要hook的对象的持有者，拿到要 hook 的对象<br>3、定义“要 hook 的对象”的代理类，并且创建该类的对象<br>4、使用上一步创建出来的对象，替换掉要 hook 的对象</p><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * hook的核心代码</span><br><span class="hljs-comment"> * 这个方法的唯一目的：用自己的点击事件，替换掉 View 原来的点击事件</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> view hook的范围仅限于这个view</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressLint({"DiscouragedPrivateApi", "PrivateApi"})</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hook</span><span class="hljs-params">(Context context,<span class="hljs-keyword">final</span> View view)</span>{<span class="hljs-comment">//</span><br>        <span class="hljs-keyword">try</span>{<br>        <span class="hljs-comment">// 反射执行View类的getListenerInfo()方法，拿到v的mListenerInfo对象，这个对象就是点击事件的持有者</span><br>        Method method=View.class.getDeclaredMethod(<span class="hljs-string">"getListenerInfo"</span>);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">//由于getListenerInfo()方法并不是public的，所以要加这个代码来保证访问权限</span><br>        Object mListenerInfo=method.invoke(view);<span class="hljs-comment">//这里拿到的就是mListenerInfo对象，也就是点击事件的持有者</span><br><br>        <span class="hljs-comment">// 要从这里面拿到当前的点击事件对象</span><br>        Class&lt;?&gt; listenerInfoClz=Class.forName(<span class="hljs-string">"android.view.View$ListenerInfo"</span>);<span class="hljs-comment">// 这是内部类的表示方法</span><br>        Field field=listenerInfoClz.getDeclaredField(<span class="hljs-string">"mOnClickListener"</span>);<br><span class="hljs-keyword">final</span> View.OnClickListener onClickListenerInstance=(View.OnClickListener)field.get(mListenerInfo);<span class="hljs-comment">//取得真实的mOnClickListener对象</span><br><br>        <span class="hljs-comment">// 2. 创建我们自己的点击事件代理类</span><br>        <span class="hljs-comment">//   方式1：自己创建代理类</span><br>        <span class="hljs-comment">//   ProxyOnClickListener proxyOnClickListener = new ProxyOnClickListener(onClickListenerInstance);</span><br>        <span class="hljs-comment">//   方式2：由于View.OnClickListener是一个接口，所以可以直接用动态代理模式</span><br>        <span class="hljs-comment">// Proxy.newProxyInstance的3个参数依次分别是：</span><br>        <span class="hljs-comment">// 本地的类加载器;</span><br>        <span class="hljs-comment">// 代理类的对象所继承的接口（用Class数组表示，支持多个接口）</span><br>        <span class="hljs-comment">// 代理类的实际逻辑，封装在new出来的InvocationHandler内</span><br>        Object proxyOnClickListener=Proxy.newProxyInstance(context.getClass().getClassLoader(),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{View.OnClickListener.class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy,Method method,Object[]args)</span><span class="hljs-keyword">throws</span> Throwable{<br>        Log.d(<span class="hljs-string">"HookSetOnClickListener"</span>,<span class="hljs-string">"点击事件被hook到了"</span>);<span class="hljs-comment">//加入自己的逻辑</span><br>        <span class="hljs-keyword">return</span> method.invoke(onClickListenerInstance,args);<span class="hljs-comment">//执行被代理的对象的逻辑</span><br>        }<br>        });<br>        <span class="hljs-comment">// 3. 用我们自己的点击事件代理类，设置到"持有者"中</span><br>        field.set(mListenerInfo,proxyOnClickListener);<br>        }<span class="hljs-keyword">catch</span>(Exception e){<br>        e.printStackTrace();<br>        }<br>        }<br><br><span class="hljs-comment">// 自定义代理类</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyOnClickListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnClickListener {<br>    View.OnClickListener oriLis;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProxyOnClickListener</span><span class="hljs-params">(View.OnClickListener oriLis)</span> {<br>        <span class="hljs-built_in">this</span>.oriLis = oriLis;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {<br>        Log.d(<span class="hljs-string">"HookSetOnClickListener"</span>, <span class="hljs-string">"点击事件被hook到了"</span>);<br>        <span class="hljs-keyword">if</span> (oriLis != <span class="hljs-literal">null</span>) {<br>            oriLis.onClick(v);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="Proguard"><a href="#Proguard" class="headerlink" title="Proguard"></a>Proguard</h1><p>Proguard 具有以下三个功能：</p><ul><li>压缩（Shrink）: 检测和删除没有使用的类，字段，方法和特性</li><li>优化（Optimize） : 分析和优化Java字节码</li><li>混淆（Obfuscate）: 使用简短的无意义的名称，对类，字段和方法进行重命名</li></ul><h2 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h2><ul><li>关键字</li></ul><table><thead><tr><th>关键字</th><th>描述</th></tr></thead><tbody><tr><td>keep</td><td>保留类和类中的成员，防止被混淆或移除</td></tr><tr><td>keepnames</td><td>保留类和类中的成员，防止被混淆，成员没有被引用会被移除</td></tr><tr><td>keepclassmembers</td><td>只保留类中的成员，防止被混淆或移除</td></tr><tr><td>keepclassmembernames</td><td>只保留类中的成员，防止被混淆，成员没有引用会被移除</td></tr><tr><td>keepclasseswithmembers</td><td>保留类和类中的成员，防止被混淆或移除，保留指明的成员</td></tr><tr><td>keepclasseswithmembernames</td><td>保留类和类中的成员，防止被混淆，保留指明的成员，成员没有引用会被移除</td></tr></tbody></table><ul><li>通配符</li></ul><table><thead><tr><th>通配符</th><th>描述</th></tr></thead><tbody><tr><td>&lt;field&gt;</td><td>匹配类中的所有字段</td></tr><tr><td>&lt;method&gt;</td><td>匹配类中所有的方法</td></tr><tr><td>&lt;init&gt;</td><td>匹配类中所有的构造函数</td></tr><tr><td>*</td><td>匹配任意长度字符，不包含包名分隔符(.)</td></tr><tr><td>**</td><td>匹配任意长度字符，包含包名分隔符(.)</td></tr><tr><td>***</td><td>匹配任意参数类型</td></tr></tbody></table><ul><li>指定混淆时可使用字典</li></ul><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-applymapping filename 指定重用一个已经写好了的map文件作为新旧元素名的映射。</span><br><span class="hljs-deletion">-obfuscationdictionary filename 指定一个文本文件用来生成混淆后的名字。</span><br><span class="hljs-deletion">-classobfuscationdictionary filename 指定一个混淆类名的字典</span><br><span class="hljs-deletion">-packageobfuscationdictionary filename 指定一个混淆包名的字典</span><br><span class="hljs-deletion">-overloadaggressively 混淆的时候大量使用重载，多个方法名使用同一个混淆名（慎用）</span><br></code></pre></td></tr></tbody></table></figure><h2 id="公共模板"><a href="#公共模板" class="headerlink" title="公共模板"></a>公共模板</h2><figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs clean">#############################################<br>#<br># 对于一些基本指令的添加<br>#<br>#############################################<br># 代码混淆压缩比，在 <span class="hljs-number">0</span>~<span class="hljs-number">7</span> 之间，默认为 <span class="hljs-number">5</span>，一般不做修改<br>-optimizationpasses <span class="hljs-number">5</span><br><br># 混合时不使用大小写混合，混合后的类名为小写<br>-dontusemixedcaseclassnames<br><br># 指定不去忽略非公共库的类<br>-dontskipnonpubliclibraryclasses<br><br># 这句话能够使我们的项目混淆后产生映射文件<br># 包含有类名-&gt;混淆后类名的映射关系<br>-verbose<br><br># 指定不去忽略非公共库的类成员<br>-dontskipnonpubliclibraryclassmembers<br><br># 不做预校验，preverify 是 proguard 的四个步骤之一，Android 不需要 preverify，去掉这一步能够加快混淆速度。<br>-dontpreverify<br><br># 保留 Annotation 不混淆<br>-keepattributes *Annotation*,InnerClasses<br><br># 避免混淆泛型<br>-keepattributes Signature<br><br># 抛出异常时保留代码行号<br>-keepattributes SourceFile,LineNumberTable<br><br># 指定混淆是采用的算法，后面的参数是一个过滤器<br># 这个过滤器是谷歌推荐的算法，一般不做更改<br>-optimizations !<span class="hljs-keyword">code</span>/simplification/cast,!field<span class="hljs-comment">/*,!class/merging/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">#############################################</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Android开发中一些需要保留的公共部分</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#############################################</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留我们使用的四大组件，自定义的 Application 等等这些类不被混淆</span><br><span class="hljs-comment"># 因为这些子类都有可能被外部调用</span><br><span class="hljs-comment">-keep public class * extends android.app.Activity</span><br><span class="hljs-comment">-keep public class * extends android.app.Appliction</span><br><span class="hljs-comment">-keep public class * extends android.app.Service</span><br><span class="hljs-comment">-keep public class * extends android.content.BroadcastReceiver</span><br><span class="hljs-comment">-keep public class * extends android.content.ContentProvider</span><br><span class="hljs-comment">-keep public class * extends android.app.backup.BackupAgentHelper</span><br><span class="hljs-comment">-keep public class * extends android.preference.Preference</span><br><span class="hljs-comment">-keep public class * extends android.view.View</span><br><span class="hljs-comment">-keep public class com.android.vending.licensing.ILicensingService</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留 support 下的所有类及其内部类</span><br><span class="hljs-comment">-keep class android.support.** { *; }</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留继承的</span><br><span class="hljs-comment">-keep public class * extends android.support.v4.**</span><br><span class="hljs-comment">-keep public class * extends android.support.v7.**</span><br><span class="hljs-comment">-keep public class * extends android.support.annotation.**</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留 R 下面的资源</span><br><span class="hljs-comment">-keep class **.R$* { *; }</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留本地 native 方法不被混淆</span><br><span class="hljs-comment">-keepclasseswithmembernames class * {</span><br><span class="hljs-comment">    native &lt;methods&gt;;</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留在 Activity 中的方法参数是view的方法，</span><br><span class="hljs-comment"># 这样以来我们在 layout 中写的 onClick 就不会被影响</span><br><span class="hljs-comment">-keepclassmembers class * extends android.app.Activity {</span><br><span class="hljs-comment">    public void *(android.view.View);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留枚举类不被混淆</span><br><span class="hljs-comment">-keepclassmembers enum * {</span><br><span class="hljs-comment">    public static **[] values();</span><br><span class="hljs-comment">    public static ** valueOf(java.lang.String);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留我们自定义控件（继承自 View）不被混淆</span><br><span class="hljs-comment">-keep public class * extends android.view.View {</span><br><span class="hljs-comment">    *** get*();</span><br><span class="hljs-comment">    void set*(***);</span><br><span class="hljs-comment">    public &lt;init&gt;(android.content.Context);</span><br><span class="hljs-comment">    public &lt;init&gt;(android.content.Context, android.util.AttributeSet);</span><br><span class="hljs-comment">    public &lt;init&gt;(android.content.Context, android.util.AttributeSet, int);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留 Parcelable 序列化类不被混淆</span><br><span class="hljs-comment">-keep class * implements android.os.Parcelable {</span><br><span class="hljs-comment">    public static final android.os.Parcelable$Creator *;</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 保留 Serializable 序列化的类不被混淆</span><br><span class="hljs-comment">-keepnames class * implements java.io.Serializable</span><br><span class="hljs-comment">-keepclassmembers class * implements java.io.Serializable {</span><br><span class="hljs-comment">    static final long serialVersionUID;</span><br><span class="hljs-comment">    private static final java.io.ObjectStreamField[] serialPersistentFields;</span><br><span class="hljs-comment">    !static !transient &lt;fields&gt;;</span><br><span class="hljs-comment">    !private &lt;fields&gt;;</span><br><span class="hljs-comment">    !private &lt;methods&gt;;</span><br><span class="hljs-comment">    private void writeObject(java.io.ObjectOutputStream);</span><br><span class="hljs-comment">    private void readObject(java.io.ObjectInputStream);</span><br><span class="hljs-comment">    java.lang.Object writeReplace();</span><br><span class="hljs-comment">    java.lang.Object readResolve();</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 对于带有回调函数的 onXXEvent、**On*Listener 的，不能被混淆</span><br><span class="hljs-comment">-keepclassmembers class * {</span><br><span class="hljs-comment">    void *(**On*Event);</span><br><span class="hljs-comment">    void *(**On*Listener);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># webView 处理，项目中没有使用到 webView 忽略即可</span><br><span class="hljs-comment">-keepclassmembers class fqcn.of.javascript.interface.for.webview {</span><br><span class="hljs-comment">    public *;</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment">-keepclassmembers class * extends android.webkit.webViewClient {</span><br><span class="hljs-comment">    public void *(android.webkit.WebView, java.lang.String, android.graphics.Bitmap);</span><br><span class="hljs-comment">    public boolean *(android.webkit.WebView, java.lang.String);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment">-keepclassmembers class * extends android.webkit.webViewClient {</span><br><span class="hljs-comment">    public void *(android.webkit.webView, java.lang.String);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># js</span><br><span class="hljs-comment">-keepattributes JavascriptInterface</span><br><span class="hljs-comment">-keep class android.webkit.JavascriptInterface { *; }</span><br><span class="hljs-comment">-keepclassmembers class * {</span><br><span class="hljs-comment">    @android.webkit.JavascriptInterface &lt;methods&gt;;</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># @Keep</span><br><span class="hljs-comment">-keep,allowobfuscation @interface android.support.annotation.Keep</span><br><span class="hljs-comment">-keep @android.support.annotation.Keep class *</span><br><span class="hljs-comment">-keepclassmembers class * {</span><br><span class="hljs-comment">    @android.support.annotation.Keep *;</span><br><span class="hljs-comment">}</span><br></code></pre></td></tr></tbody></table></figure><h2 id="常用的自定义混淆规则"><a href="#常用的自定义混淆规则" class="headerlink" title="常用的自定义混淆规则"></a>常用的自定义混淆规则</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"># 通配符*，匹配任意长度字符，但不含包名分隔符(.)<br>        # 通配符**，匹配任意长度字符，并且包含包名分隔符(.)<br><br>        # 不混淆某个类<br>        -keep public class com.jasonwu.demo.Test { *; }<br><br>        # 不混淆某个包所有的类<br>        -keep class com.jasonwu.demo.test.** { *; }<br><br>        # 不混淆某个类的子类<br>        -keep public class * com.jasonwu.demo.Test { *; }<br><br>        # 不混淆所有类名中包含了 ``model`` 的类及其成员<br>        -keep public class **.*model*.** {*;}<br><br>        # 不混淆某个接口的实现<br>        -keep class * implements com.jasonwu.demo.TestInterface { *; }<br><br>        # 不混淆某个类的构造方法<br>        -keepclassmembers class com.jasonwu.demo.Test {<br>        public<br><span class="hljs-tag">&lt;<span class="hljs-name">init</span>&gt;</span>();<br>    }<br><br>    # 不混淆某个类的特定的方法<br>    -keepclassmembers class com.jasonwu.demo.Test {<br>    public void test(java.lang.String);<br>    }<br></code></pre></td></tr></tbody></table></figure><h2 id="aar中增加独立的混淆配置"><a href="#aar中增加独立的混淆配置" class="headerlink" title="aar中增加独立的混淆配置"></a>aar中增加独立的混淆配置</h2><p><code>build.gralde</code></p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android {<br>    ···<br>    defaultConfig {<br>        ···<br>        consumerProguardFile <span class="hljs-string">'proguard-rules.pro'</span><br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="检查混淆和追踪异常"><a href="#检查混淆和追踪异常" class="headerlink" title="检查混淆和追踪异常"></a>检查混淆和追踪异常</h2><p>开启 Proguard 功能，则每次构建时 ProGuard 都会输出下列文件：</p><ul><li><p>dump.txt<br>说明 APK 中所有类文件的内部结构。</p></li><li><p>mapping.txt<br>提供原始与混淆过的类、方法和字段名称之间的转换。</p></li><li><p>seeds.txt<br>列出未进行混淆的类和成员。</p></li><li><p>usage.txt<br>列出从 APK 移除的代码。</p></li></ul><p>这些文件保存在 /build/outputs/mapping/release/ 中。我们可以查看 seeds.txt 里面是否是我们需要保留的，以及 usage.txt<br>里查看是否有误删除的代码。 mapping.txt 文件很重要，由于我们的部分代码是经过重命名的，如果该部分出现<br>bug，对应的异常堆栈信息里的类或成员也是经过重命名的，难以定位问题。我们可以用 retrace 脚本（在 Windows 上为 retrace.bat；在<br>Mac/Linux 上为 retrace.sh）。它位于 /tools/proguard/ 目录中。该脚本利用 mapping.txt<br>文件和你的异常堆栈文件生成没有经过混淆的异常堆栈文件,这样就可以看清是哪里出问题了。使用 retrace 工具的语法如下：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">retrace.bat|retrace.sh [-verbose] mapping.txt [&lt;stacktrace_file&gt;]<br></code></pre></td></tr></tbody></table></figure><h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/zKFJDM5V3Wy5xbLTp6JMMdouZiavFxyYCwLhGyLdicyLzgUDKFTZVt1OgU6iaSx2IUwnygzmQzW7Renaa8hmQ62cQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>在 Android 中，三者的关系如下：</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/zKFJDM5V3Wy5xbLTp6JMMdouZiavFxyYCicNvEVMO9vDgukUR29Z1DCacZJwmmH1EEb7gUOZmDxolWexP01O8jfg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>由于在 Android 中 xml 布局的功能性太弱，所以 Activity 承担了绝大部分的工作，所以在 Android 中 mvc 更像：</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/zKFJDM5V3Wy5xbLTp6JMMdouZiavFxyYCOq89MLQX4UM3dgBTQfU72desHb1XbOWRQZINnXOCCdZCuicUiaTHhtEg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>总结：</p><ul><li>具有一定的分层，model 解耦，controller 和 view 并没有解耦</li><li>controller 和 view 在 Android 中无法做到彻底分离，Controller 变得臃肿不堪</li><li>易于理解、开发速度快、可维护性高</li></ul><h2 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/zKFJDM5V3Wy5xbLTp6JMMdouZiavFxyYCLVgibsuVQFguBI8FBdZibLNfpvbpd6njkdGWdyR2UL6TzMOhKHFqLC0Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>通过引入接口 BaseView，让相应的视图组件如 Activity，Fragment去实现 BaseView，把业务逻辑放在 presenter 层中，弱化 Model 只有跟<br>view 相关的操作都由 View 层去完成。</p><p>总结：</p><ul><li>彻底解决了 MVC 中 View 和 Controller 傻傻分不清楚的问题</li><li>但是随着业务逻辑的增加，一个页面可能会非常复杂，UI 的改变是非常多，会有非常多的 case，这样就会造成 View 的接口会很庞大</li><li>更容易单元测试</li></ul><h2 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/zKFJDM5V3Wy5xbLTp6JMMdouZiavFxyYCMygIDD6xo5djkq6Y3jZo53sT2A4kKNaz8JEVRwmUnTmcAwJm0pZVWg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>在 MVP 中 View 和 Presenter 要相互持有，方便调用对方，而在 MVP 中 View 和 ViewModel 通过 Binding 进行关联，他们之前的关联处理通过<br>DataBinding 完成。</p><p>总结：</p><ul><li>很好的解决了 MVC 和 MVP 的问题</li><li>视图状态较多，ViewModel 的构建和维护的成本都会比较高</li><li>但是由于数据和视图的双向绑定，导致出现问题时不太好定位来源</li></ul><h1 id="Jetpack"><a href="#Jetpack" class="headerlink" title="Jetpack"></a>Jetpack</h1><h2 id="架构-1"><a href="#架构-1" class="headerlink" title="架构"></a>架构</h2><p><img src="https://developer.android.google.cn/topic/libraries/architecture/images/final-architecture.png"></p><h2 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h2><p><code>build.gradle</code></p><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy">android {<br>    · · ·<br>    dataBinding {<br>        enabled = <span class="hljs-literal">true</span><br>    }<br>}<br>dependencies {<br>    · · ·<br>    implementation <span class="hljs-string">"androidx.fragment:fragment-ktx:$rootProject.fragmentVersion"</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-extensions:$rootProject.lifecycleVersion"</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-livedata-ktx:$rootProject.lifecycleVersion"</span><br>    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-ktx:$rootProject.lifecycleVersion"</span><br>}<br></code></pre></td></tr></tbody></table></figure><p><code>fragment_plant_detail.xml</code></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">variable</span></span><br><span class="hljs-tag">                <span class="hljs-attr">name</span>=<span class="hljs-string">"viewModel"</span></span><br><span class="hljs-tag">                <span class="hljs-attr">type</span>=<span class="hljs-string">"com.google.samples.apps.sunflower.viewmodels.PlantDetailViewModel"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        ···</span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@{viewModel.plant.name}"</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p><code>PlantDetailFragment.kt</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PlantDetailFragment</span> : <span class="hljs-type">Fragment</span>() {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> args: PlantDetailFragmentArgs <span class="hljs-keyword">by</span> navArgs()<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> shareText: String<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> plantDetailViewModel: PlantDetailViewModel <span class="hljs-keyword">by</span> viewModels {<br>        InjectorUtils.providePlantDetailViewModelFactory(requireActivity(), args.plantId)<br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        inflater: <span class="hljs-type">LayoutInflater</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">        container: <span class="hljs-type">ViewGroup</span>?,</span></span><br><span class="hljs-params"><span class="hljs-function">        savedInstanceState: <span class="hljs-type">Bundle</span>?</span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>: View? {<br>        <span class="hljs-keyword">val</span> binding = DataBindingUtil.inflate&lt;FragmentPlantDetailBinding&gt;(<br>            inflater, R.layout.fragment_plant_detail, container, <span class="hljs-literal">false</span><br>        ).apply {<br>            viewModel = plantDetailViewModel<br>            lifecycleOwner = <span class="hljs-keyword">this</span><span class="hljs-symbol">@PlantDetailFragment</span><br>        }<br><br>        plantDetailViewModel.plant.observe(<span class="hljs-keyword">this</span>) { plant -&gt;<br>            <span class="hljs-comment">// 更新相关 UI</span><br>        }<br><br>        <span class="hljs-keyword">return</span> binding.root<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>Plant.kt</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plant</span>(<br>    <span class="hljs-keyword">val</span> name: String<br>)<br></code></pre></td></tr></tbody></table></figure><p><code>PlantDetailViewModel.kt</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PlantDetailViewModel</span>(<br>    plantRepository: PlantRepository,<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> plantId: String<br>) : ViewModel() {<br><br>    <span class="hljs-keyword">val</span> plant: LiveData&lt;Plant&gt;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {<br>        <span class="hljs-keyword">super</span>.onCleared()<br>        viewModelScope.cancel()<br>    }<br><br>    <span class="hljs-keyword">init</span> {<br>        plant = plantRepository.getPlant(plantId)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>PlantDetailViewModelFactory.kt</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PlantDetailViewModelFactory</span>(<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> plantRepository: PlantRepository,<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> plantId: String<br>) : ViewModelProvider.NewInstanceFactory() {<br><br>    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {<br>        <span class="hljs-keyword">return</span> PlantDetailViewModel(plantRepository, plantId) <span class="hljs-keyword">as</span> T<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>InjectorUtils.kt</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">object</span> InjectorUtils {<br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPlantRepository</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: PlantRepository {<br>        ···<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">providePlantDetailViewModelFactory</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        context: <span class="hljs-type">Context</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">        plantId: <span class="hljs-type">String</span></span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>: PlantDetailViewModelFactory {<br>        <span class="hljs-keyword">return</span> PlantDetailViewModelFactory(getPlantRepository(context), plantId)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="NDK-开发"><a href="#NDK-开发" class="headerlink" title="NDK 开发"></a>NDK 开发</h1><blockquote><p>NDK 全称是 Native Development Kit，是一组可以让你在 Android 应用中编写实现 C/C++ 的工具，可以在项目用自己写源代码构建，也可以利用现有的预构建库。</p></blockquote><p>使用 NDK 的使用目的有：</p><ul><li>从设备获取更好的性能以用于计算密集型应用，例如游戏或物理模拟</li><li>重复使用自己或其他开发者的 C/C++ 库，便利于跨平台。</li><li>NDK 集成了譬如 OpenSL、Vulkan 等 API 规范的特定实现，以实现在 java 层无法做到的功能如提升音频性能等</li><li>增加反编译难度</li></ul><h2 id="JNI-基础"><a href="#JNI-基础" class="headerlink" title="JNI 基础"></a>JNI 基础</h2><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ul><li>基本数据类型</li></ul><table><thead><tr><th>Java 类型</th><th>Native 类型</th><th>符号属性</th><th>字长</th></tr></thead><tbody><tr><td>boolean</td><td>jboolean</td><td>无符号</td><td>8位</td></tr><tr><td>byte</td><td>jbyte</td><td>无符号</td><td>8位</td></tr><tr><td>char</td><td>jchar</td><td>无符号</td><td>16位</td></tr><tr><td>short</td><td>jshort</td><td>有符号</td><td>16位</td></tr><tr><td>int</td><td>jnit</td><td>有符号</td><td>32位</td></tr><tr><td>long</td><td>jlong</td><td>有符号</td><td>64位</td></tr><tr><td>float</td><td>jfloat</td><td>有符号</td><td>32位</td></tr><tr><td>double</td><td>jdouble</td><td>有符号</td><td>64位</td></tr></tbody></table><ul><li>引用数据类型</li></ul><table><thead><tr><th>Java 引用类型</th><th>Native 类型</th><th>Java 引用类型</th><th>Native 类型</th></tr></thead><tbody><tr><td>All objects</td><td>jobject</td><td>char[]</td><td>jcharArray</td></tr><tr><td>java.lang.Class</td><td>jclass</td><td>short[]</td><td>jshortArray</td></tr><tr><td>java.lang.String</td><td>jstring</td><td>int[]</td><td>jintArray</td></tr><tr><td>Object[]</td><td>jobjectArray</td><td>long[]</td><td>jlongArray</td></tr><tr><td>boolean[]</td><td>jbooleanArray</td><td>float[]</td><td>jfloatArray</td></tr><tr><td>byte[]</td><td>jbyteArray</td><td>double[]</td><td>jdoubleArray</td></tr><tr><td>java.lang.Throwable</td><td>jthrowable</td><td></td><td></td></tr></tbody></table><h3 id="String-字符串函数操作"><a href="#String-字符串函数操作" class="headerlink" title="String 字符串函数操作"></a>String 字符串函数操作</h3><table><thead><tr><th>JNI 函数</th><th>描述</th></tr></thead><tbody><tr><td>GetStringChars / ReleaseStringChars</td><td>获得或释放一个指向 Unicode 编码的字符串的指针（指 C/C++ 字符串）</td></tr><tr><td>GetStringUTFChars / ReleaseStringUTFChars</td><td>获得或释放一个指向 UTF-8 编码的字符串的指针（指 C/C++ 字符串）</td></tr><tr><td>GetStringLength</td><td>返回 Unicode 编码的字符串的长度</td></tr><tr><td>getStringUTFLength</td><td>返回 UTF-8 编码的字符串的长度</td></tr><tr><td>NewString</td><td>将 Unicode 编码的 C/C++ 字符串转换为 Java 字符串</td></tr><tr><td>NewStringUTF</td><td>将 UTF-8 编码的 C/C++ 字符串转换为 Java 字符串</td></tr><tr><td>GetStringCritical / ReleaseStringCritical</td><td>获得或释放一个指向字符串内容的指针(指 Java 字符串)</td></tr><tr><td>GetStringRegion</td><td>获取或者设置 Unicode 编码的字符串的指定范围的内容</td></tr><tr><td>GetStringUTFRegion</td><td>获取或者设置 UTF-8 编码的字符串的指定范围的内容</td></tr></tbody></table><h3 id="常用-JNI-访问-Java-对象方法"><a href="#常用-JNI-访问-Java-对象方法" class="headerlink" title="常用 JNI 访问 Java 对象方法"></a>常用 JNI 访问 Java 对象方法</h3><p><code>MyJob.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.myjniproject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyJob</span> {<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">JOB_STRING</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my_job"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> jobId;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyJob</span><span class="hljs-params">(<span class="hljs-type">int</span> jobId)</span> {<br>        <span class="hljs-built_in">this</span>.jobId = jobId;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getJobId</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> jobId;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>native-lib.cpp</code></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span><br><span class="hljs-function">JNIEXPORT jint JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Java_com_example_myjniproject_MainActivity_getJobId</span><span class="hljs-params">(JNIEnv *env, jobject thiz, jobject job)</span> </span>{<br><br>    <span class="hljs-comment">// 根据实力获取 class 对象</span><br>    jclass jobClz = env-&gt;<span class="hljs-built_in">GetObjectClass</span>(job);<br>    <span class="hljs-comment">// 根据类名获取 class 对象</span><br>    jclass jobClz = env-&gt;<span class="hljs-built_in">FindClass</span>(<span class="hljs-string">"com/example/myjniproject/MyJob"</span>);<br><br>    <span class="hljs-comment">// 获取属性 id</span><br>    jfieldID fieldId = env-&gt;<span class="hljs-built_in">GetFieldID</span>(jobClz, <span class="hljs-string">"jobId"</span>, <span class="hljs-string">"I"</span>);<br>    <span class="hljs-comment">// 获取静态属性 id</span><br>    jfieldID sFieldId = env-&gt;<span class="hljs-built_in">GetStaticFieldID</span>(jobClz, <span class="hljs-string">"JOB_STRING"</span>, <span class="hljs-string">"Ljava/lang/String;"</span>);<br><br>    <span class="hljs-comment">// 获取方法 id</span><br>    jmethodID methodId = env-&gt;<span class="hljs-built_in">GetMethodID</span>(jobClz, <span class="hljs-string">"getJobId"</span>, <span class="hljs-string">"()I"</span>);<br>    <span class="hljs-comment">// 获取构造方法 id</span><br>    jmethodID  initMethodId = env-&gt;<span class="hljs-built_in">GetMethodID</span>(jobClz, <span class="hljs-string">"&lt;init&gt;"</span>, <span class="hljs-string">"(I)V"</span>);<br><br>    <span class="hljs-comment">// 根据对象属性 id 获取该属性值</span><br>    jint id = env-&gt;<span class="hljs-built_in">GetIntField</span>(job, fieldId);<br>    <span class="hljs-comment">// 根据对象方法 id 调用该方法</span><br>    jint id = env-&gt;<span class="hljs-built_in">CallIntMethod</span>(job, methodId);<br><br>    <span class="hljs-comment">// 创建新的对象</span><br>    jobject newJob = env-&gt;<span class="hljs-built_in">NewObject</span>(jobClz, initMethodId, <span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">return</span> id;<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="NDK-开发-1"><a href="#NDK-开发-1" class="headerlink" title="NDK 开发"></a>NDK 开发</h2><h3 id="基础开发流程"><a href="#基础开发流程" class="headerlink" title="基础开发流程"></a>基础开发流程</h3><ul><li>在 java 中声明 native 方法</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-comment">// Used to load the 'native-lib' library on application startup.</span><br>    <span class="hljs-keyword">static</span> {<br>        System.loadLibrary(<span class="hljs-string">"native-lib"</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        Log.d(<span class="hljs-string">"MainActivity"</span>, stringFromJNI());<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">stringFromJNI</span><span class="hljs-params">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>在 <code>app/src/main</code> 目录下新建 cpp 目录，新建相关 cpp 文件，实现相关方法（AS 可用快捷键快速生成）</li></ul><p><code>native-lib.cpp</code></p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#include &lt;jni.h&gt;</span><br><br><span class="hljs-keyword">extern </span><span class="hljs-string">"C"</span> <span class="hljs-keyword">JNIEXPORT </span><span class="hljs-keyword">jstring </span><span class="hljs-keyword">JNICALL</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">Java_com_example_myjniproject_MainActivity_stringFromJNI(</span><br><span class="hljs-keyword"></span>        <span class="hljs-keyword">JNIEnv </span>*env,<br>        <span class="hljs-keyword">jobject </span><span class="hljs-comment">/* this */</span>) {<br><span class="hljs-symbol">    std:</span>:string hello = <span class="hljs-string">"Hello from C++"</span>;<br>    return env-&gt;NewStringUTF(hello.c_str());<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><ul><li>函数名的格式遵循遵循如下规则：Java_包名_类名_方法名。</li><li>extern “C” 指定采用 C 语言的命名风格来编译，否则由于 C 与 C++ 风格不同，导致链接时无法找到具体的函数</li><li>JNIEnv*：表示一个指向 JNI 环境的指针，可以通过他来访问 JNI 提供的接口方法</li><li>jobject：表示 java 对象中的 this</li><li>JNIEXPORT 和 JNICALL：JNI 所定义的宏，可以在 jni.h 头文件中查找到</li></ul></blockquote><ul><li>通过 CMake 或者 ndk-build 构建动态库</li></ul><h3 id="System-loadLibrary"><a href="#System-loadLibrary" class="headerlink" title="System.loadLibrary()"></a>System.loadLibrary()</h3><p><code>java/lang/System.java</code>:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CallerSensitive</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(String filename)</span>{<br>        Runtime.getRuntime().load0(Reflection.getCallerClass(),filename);<br>        }<br></code></pre></td></tr></tbody></table></figure><ul><li>调用 <code>Runtime</code> 相关 native 方法</li></ul><p><code>java/lang/Runtime.java</code>:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">nativeLoad</span><span class="hljs-params">(String filename,ClassLoader loader,Class&lt;?&gt; caller)</span>;<br></code></pre></td></tr></tbody></table></figure><ul><li>native 方法的实现如下：</li></ul><p><code>dalvik/vm/native/java_lang_Runtime.cpp</code>:</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">Dalvik_java_lang_Runtime_nativeLoad</span><span class="hljs-params">(<span class="hljs-type">const</span> u4* args,</span></span><br><span class="hljs-params"><span class="hljs-function">    JValue* pResult)</span></span><br><span class="hljs-function"></span>{<br>    ···<br>    <span class="hljs-type">bool</span> success;<br><br>    <span class="hljs-built_in">assert</span>(fileNameObj != <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// 将 Java 的 library path String 转换到 native 的 String</span><br>    fileName = <span class="hljs-built_in">dvmCreateCstrFromString</span>(fileNameObj);<br><br>    success = <span class="hljs-built_in">dvmLoadNativeCode</span>(fileName, classLoader, &amp;reason);<br>    <span class="hljs-keyword">if</span> (!success) {<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg = (reason != <span class="hljs-literal">NULL</span>) ? reason : <span class="hljs-string">"unknown failure"</span>;<br>        result = <span class="hljs-built_in">dvmCreateStringFromCstr</span>(msg);<br>        <span class="hljs-built_in">dvmReleaseTrackedAlloc</span>((Object*) result, <span class="hljs-literal">NULL</span>);<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><code>dvmLoadNativeCode</code> 函数实现如下：</li></ul><p><code>dalvik/vm/Native.cpp</code></p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dvmLoadNativeCode</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathName, Object* classLoader,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-type">char</span>** detail)</span></span><br><span class="hljs-function"></span>{<br>    SharedLib* pEntry;<br>    <span class="hljs-type">void</span>* handle;<br>    ···<br>    *detail = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// 如果已经加载过了，则直接返回 true</span><br>    pEntry = <span class="hljs-built_in">findSharedLibEntry</span>(pathName);<br>    <span class="hljs-keyword">if</span> (pEntry != <span class="hljs-literal">NULL</span>) {<br>        <span class="hljs-keyword">if</span> (pEntry-&gt;classLoader != classLoader) {<br>            ···<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        ···<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">checkOnLoadResult</span>(pEntry))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br><br>    Thread* self = <span class="hljs-built_in">dvmThreadSelf</span>();<br>    ThreadStatus oldStatus = <span class="hljs-built_in">dvmChangeStatus</span>(self, THREAD_VMWAIT);<br>    <span class="hljs-comment">// 把.so mmap 到进程空间，并把 func 等相关信息填充到 soinfo 中</span><br>    handle = <span class="hljs-built_in">dlopen</span>(pathName, RTLD_LAZY);<br>    <span class="hljs-built_in">dvmChangeStatus</span>(self, oldStatus);<br>    ···<br>    <span class="hljs-comment">// 创建一个新的 entry</span><br>    SharedLib* pNewEntry;<br>    pNewEntry = (SharedLib*) <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(SharedLib));<br>    pNewEntry-&gt;pathName = <span class="hljs-built_in">strdup</span>(pathName);<br>    pNewEntry-&gt;handle = handle;<br>    pNewEntry-&gt;classLoader = classLoader;<br>    <span class="hljs-built_in">dvmInitMutex</span>(&amp;pNewEntry-&gt;onLoadLock);<br>    <span class="hljs-built_in">pthread_cond_init</span>(&amp;pNewEntry-&gt;onLoadCond, <span class="hljs-literal">NULL</span>);<br>    pNewEntry-&gt;onLoadThreadId = self-&gt;threadId;<br><br>    <span class="hljs-comment">// 尝试添加到列表中</span><br>    SharedLib* pActualEntry = <span class="hljs-built_in">addSharedLibEntry</span>(pNewEntry);<br><br>    <span class="hljs-keyword">if</span> (pNewEntry != pActualEntry) {<br>        ···<br>        <span class="hljs-built_in">freeSharedLibEntry</span>(pNewEntry);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">checkOnLoadResult</span>(pActualEntry);<br>    } <span class="hljs-keyword">else</span> {<br>        ···<br>        <span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">void</span>* vonLoad;<br>        <span class="hljs-type">int</span> version;<br>        <span class="hljs-comment">// 调用该 so 库的 JNI_OnLoad 方法</span><br>        vonLoad = <span class="hljs-built_in">dlsym</span>(handle, <span class="hljs-string">"JNI_OnLoad"</span>);<br>        <span class="hljs-keyword">if</span> (vonLoad == <span class="hljs-literal">NULL</span>) {<br>            ···<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// 调用 JNI_Onload 方法，重写类加载器。</span><br>            OnLoadFunc func = (OnLoadFunc)vonLoad;<br>            Object* prevOverride = self-&gt;classLoaderOverride;<br><br>            self-&gt;classLoaderOverride = classLoader;<br>            oldStatus = <span class="hljs-built_in">dvmChangeStatus</span>(self, THREAD_NATIVE);<br>            ···<br>            version = (*func)(gDvmJni.jniVm, <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-built_in">dvmChangeStatus</span>(self, oldStatus);<br>            self-&gt;classLoaderOverride = prevOverride;<br><br>            <span class="hljs-keyword">if</span> (version != JNI_VERSION_1_2 &amp;&amp; version != JNI_VERSION_1_4 &amp;&amp;<br>                version != JNI_VERSION_1_6)<br>            {<br>                ···<br>                result = <span class="hljs-literal">false</span>;<br>            } <span class="hljs-keyword">else</span> {<br>                ···<br>            }<br>        }<br><br>        <span class="hljs-keyword">if</span> (result)<br>            pNewEntry-&gt;onLoadResult = kOnLoadOkay;<br>        <span class="hljs-keyword">else</span><br>            pNewEntry-&gt;onLoadResult = kOnLoadFailed;<br><br>        pNewEntry-&gt;onLoadThreadId = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// 释放锁资源 </span><br>        <span class="hljs-built_in">dvmLockMutex</span>(&amp;pNewEntry-&gt;onLoadLock);<br>        <span class="hljs-built_in">pthread_cond_broadcast</span>(&amp;pNewEntry-&gt;onLoadCond);<br>        <span class="hljs-built_in">dvmUnlockMutex</span>(&amp;pNewEntry-&gt;onLoadLock);<br>        <span class="hljs-keyword">return</span> result;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><!-- ### native 方法调用原理- 虚拟机调用一个方法时，发现如果这是一个 native 方法，则使用 Method 对象中的nativeFunc 函数指针对象调用。``dalvik2/vm/interp/Stack.cpp``:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Object* <span class="hljs-title">dvmInvokeMethod</span><span class="hljs-params">(Object* obj, <span class="hljs-type">const</span> Method* method,</span></span><br><span class="hljs-params"><span class="hljs-function">    ArrayObject* argList, ArrayObject* params, ClassObject* returnType,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">bool</span> noAccessCheck)</span></span><br><span class="hljs-function"></span>&#123;<br>    ···<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">dvmIsNativeMethod</span>(method)) &#123;<br>        <span class="hljs-built_in">TRACE_METHOD_ENTER</span>(self, method);<br>        (*method-&gt;nativeFunc)((u4*)self-&gt;interpSave.curFrame, &amp;retval, method, self);<br>        <span class="hljs-built_in">TRACE_METHOD_EXIT</span>(self, method);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">dvmInterpret</span>(self, method, &amp;retval);<br>    &#125;<br>    ···<br>&#125;<br>``` --&gt;<br><br>## CMake 构建 NDK 项目<br><br>&gt; CMake 是一个开源的跨平台工具系列，旨在构建，测试和打包软件，从 Android Studio <span class="hljs-number">2.2</span> 开始，Android Sudio 默认地使用 CMake 与<br>&gt; Gradle 搭配使用来构建原生库。<br><br>启动方式只需要在 ``app/build.gradle`` 中添加相关：<br><br>```groovy<br>android &#123;<br>    · · ·<br>    defaultConfig &#123;<br>        · · ·<br>        externalNativeBuild &#123;<br>            cmake &#123;<br>                cppFlags <span class="hljs-string">&quot;&quot;</span><br>            &#125;<br>        &#125;<br><br>        ndk &#123;<br>            abiFilters <span class="hljs-string">&#x27;arm64-v8a&#x27;</span>, <span class="hljs-string">&#x27;armeabi-v7a&#x27;</span><br>        &#125;<br>    &#125;<br>    · · ·<br>    externalNativeBuild &#123;<br>        cmake &#123;<br>            path <span class="hljs-string">&quot;CMakeLists.txt&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后在对应目录新建一个 <code>CMakeLists.txt</code> 文件：</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs txt"># 定义了所需 CMake 的最低版本<br>cmake_minimum_required(VERSION 3.4.1)<br><br># add_library() 命令用来添加库<br># native-lib 对应着生成的库的名字<br># SHARED 代表为分享库<br># src/main/cpp/native-lib.cpp 则是指明了源文件的路径。<br>add_library( # Sets the name of the library.<br>        native-lib<br><br>        # Sets the library as a shared library.<br>        SHARED<br><br>        # Provides a relative path to your source file(s).<br>        src/main/cpp/native-lib.cpp)<br><br># find_library 命令添加到 CMake 构建脚本中以定位 NDK 库，并将其路径存储为一个变量。<br># 可以使用此变量在构建脚本的其他部分引用 NDK 库<br>find_library( # Sets the name of the path variable.<br>        log-lib<br><br>        # Specifies the name of the NDK library that<br>        # you want CMake to locate.<br>        log)<br><br># 预构建的 NDK 库已经存在于 Android 平台上，因此，无需再构建或将其打包到 APK 中。<br># 由于 NDK 库已经是 CMake 搜索路径的一部分，只需要向 CMake 提供希望使用的库的名称，并将其关联到自己的原生库中<br><br># 要将预构建库关联到自己的原生库<br>target_link_libraries( # Specifies the target library.<br>        native-lib<br><br>        # Links the target library to the log library<br>        # included in the NDK.<br>        $&#123;log-lib&#125;)<br>···<br></code></pre></td></tr></table></figure><ul><li><a href="https://cmake.org/cmake/help/latest/manual/cmake-commands.7.html">CMake 命令详细信息文档</a></li></ul><h2 id="常用的-Android-NDK-原生-API"><a href="#常用的-Android-NDK-原生-API" class="headerlink" title="常用的 Android NDK 原生 API"></a>常用的 Android NDK 原生 API</h2><table><thead><tr><th>支持 NDK 的 API 级别</th><th>关键原生 API</th><th>包括</th></tr></thead><tbody><tr><td>3</td><td>Java 原生接口</td><td>#include &lt;jni.h&gt;</td></tr><tr><td>3</td><td>Android 日志记录 API</td><td>#include &lt;android&#x2F;log.h&gt;</td></tr><tr><td>5</td><td>OpenGL ES 2.0</td><td>#include &lt;GLES2&#x2F;gl2.h&gt;<br>#include &lt;GLES2&#x2F;gl2ext.h&gt;</td></tr><tr><td>8</td><td>Android 位图 API</td><td>#include &lt;android&#x2F;bitmap.h&gt;</td></tr><tr><td>9</td><td>OpenSL ES</td><td>#include &lt;SLES&#x2F;OpenSLES.h&gt;<br>#include &lt;SLES&#x2F;OpenSLES_Platform.h&gt;<br>#include &lt;SLES&#x2F;OpenSLES_Android.h&gt;<br>#include &lt;SLES&#x2F;OpenSLES_AndroidConfiguration.h&gt;</td></tr><tr><td>9</td><td>原生应用 API</td><td>#include &lt;android&#x2F;rect.h&gt;<br>#include &lt;android&#x2F;window.h&gt;<br>#include&lt;android&#x2F;native_activity.h&gt;<br>···</td></tr><tr><td>18</td><td>OpenGL ES 3.0</td><td>#include &lt;GLES3&#x2F;gl3.h&gt;<br>#include &lt;GLES3&#x2F;gl3ext.h&gt;</td></tr><tr><td>21</td><td>原生媒体 API</td><td>#include &lt;media&#x2F;NdkMediaCodec.h&gt;<br>#include &lt;media&#x2F;NdkMediaCrypto.h&gt;<br>···</td></tr><tr><td>24</td><td>原生相机 API</td><td>#include &lt;camera&#x2F;NdkCameraCaptureSession.h&gt;<br>#include &lt;camera&#x2F;NdkCameraDevice.h&gt;<br>···</td></tr><tr><td>···</td><td></td><td></td></tr></tbody></table><h1 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h1><p><img src="https://img-blog.csdn.net/20161021101447117?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"></p><h2 id="双亲委托模式"><a href="#双亲委托模式" class="headerlink" title="双亲委托模式"></a>双亲委托模式</h2><p>某个特定的类加载器在接到加载类的请求时，首先将加载任务委托给父类加载器，依次递归，如果父类加载器可以完成类加载任务，就成功返回；只有父类加载器无法完成此加载任务时，才自己去加载。</p><p>因为这样可以避免重复加载，当父亲已经加载了该类的时候，就没有必要子 ClassLoader<br>再加载一次。如果不使用这种委托模式，那我们就可以随时使用自定义的类来动态替代一些核心的类，存在非常大的安全隐患。</p><h2 id="DexPathList"><a href="#DexPathList" class="headerlink" title="DexPathList"></a>DexPathList</h2><p>DexClassLoader 重载了 <code>findClass</code> 方法，在加载类时会调用其内部的 DexPathList 去加载。DexPathList 是在构造 DexClassLoader<br>时生成的，其内部包含了 DexFile。</p><p><code>DexPathList.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">···<br><span class="hljs-keyword">public</span> Class <span class="hljs-title function_">findClass</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-keyword">for</span>(Element element:dexElements)&#123;<br>        DexFile dex=element.dexFile;<br>        <span class="hljs-keyword">if</span>(dex!=<span class="hljs-literal">null</span>)&#123;<br>        Class clazz=dex.loadClassBinaryName(name,definingContext);<br>        <span class="hljs-keyword">if</span>(clazz!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>        &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        ···<br></code></pre></td></tr></table></figure>-->]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android知识点汇总</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/android-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/android-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#activity">Activity</a><ul><li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">生命周期</a></li><li><a href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F">启动模式</a></li><li><a href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B">启动过程</a></li></ul></li><li><a href="#fragment">Fragment</a><ul><li><a href="#%E7%89%B9%E7%82%B9">特点</a></li><li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-1">生命周期</a></li><li><a href="#%E4%B8%8Eactivity%E9%80%9A%E4%BF%A1">与Activity通信</a></li></ul></li><li><a href="#service">Service</a><ul><li><a href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B-1">启动过程</a></li><li><a href="#%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B">绑定过程</a></li><li><a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-2">生命周期</a></li><li><a href="#%E5%90%AF%E7%94%A8%E5%89%8D%E5%8F%B0%E6%9C%8D%E5%8A%A1">启用前台服务</a></li></ul></li><li><a href="#broadcastreceiver">BroadcastReceiver</a><ul><li><a href="#%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B">注册过程</a></li></ul></li><li><a href="#contentprovider">ContentProvider</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">基本使用</a></li></ul></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8">数据存储</a></li><li><a href="#view">View</a><ul><li><a href="#measurespec">MeasureSpec</a></li><li><a href="#motionevent">MotionEvent</a></li><li><a href="#velocitytracker">VelocityTracker</a></li><li><a href="#gesturedetector">GestureDetector</a></li><li><a href="#scroller">Scroller</a></li><li><a href="#view-%E7%9A%84%E6%BB%91%E5%8A%A8">View 的滑动</a></li><li><a href="#view-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91">View 的事件分发</a></li><li><a href="#%E5%9C%A8-activity-%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA-view-%E7%9A%84%E5%AE%BD%E9%AB%98">在 Activity 中获取某个 View 的宽高</a></li><li><a href="#draw-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">Draw 的基本流程</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-view">自定义 View</a></li></ul></li><li><a href="#%E8%BF%9B%E7%A8%8B">进程</a><ul><li><a href="#%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">进程生命周期</a></li><li><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B">多进程</a></li><li><a href="#%E8%BF%9B%E7%A8%8B%E5%AD%98%E6%B4%BB">进程存活</a><ul><li><a href="#oom_adj">OOM_ADJ</a></li><li><a href="#%E8%BF%9B%E7%A8%8B%E8%A2%AB%E6%9D%80%E6%83%85%E5%86%B5">进程被杀情况</a></li><li><a href="#%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%B4%BB%E6%96%B9%E6%A1%88">进程保活方案</a></li></ul></li></ul></li><li><a href="#parcelable-%E6%8E%A5%E5%8F%A3">Parcelable 接口</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">使用示例</a></li><li><a href="#%E6%96%B9%E6%B3%95%E8%AF%B4%E6%98%8E">方法说明</a></li><li><a href="#parcelable-%E4%B8%8E-serializable-%E5%AF%B9%E6%AF%94">Parcelable 与 Serializable 对比</a></li></ul></li><li><a href="#ipc">IPC</a><ul><li><a href="#ipc%E6%96%B9%E5%BC%8F">IPC方式</a></li><li><a href="#binder">Binder</a><ul><li><a href="#%E6%B5%81%E7%A8%8B">流程</a></li></ul></li><li><a href="#aidl-%E9%80%9A%E4%BF%A1">AIDL 通信</a></li><li><a href="#messenger">Messenger</a></li></ul></li><li><a href="#window--windowmanager">Window / WindowManager</a><ul><li><a href="#window-%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%88%86%E7%B1%BB">Window 概念与分类</a></li><li><a href="#window-%E7%9A%84%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6">Window 的内部机制</a></li><li><a href="#window-%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B">Window 的创建过程</a><ul><li><a href="#activity-%E7%9A%84-window-%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B">Activity 的 Window 创建过程</a></li><li><a href="#dialog-%E7%9A%84-window-%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B">Dialog 的 Window 创建过程</a></li><li><a href="#toast-%E7%9A%84-window-%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B">Toast 的 Window 创建过程</a></li></ul></li></ul></li><li><a href="#bitmap">Bitmap</a><ul><li><a href="#%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B8%8E%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F">配置信息与压缩方式</a></li><li><a href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C">常用操作</a><ul><li><a href="#%E8%A3%81%E5%89%AA%E7%BC%A9%E6%94%BE%E6%97%8B%E8%BD%AC%E7%A7%BB%E5%8A%A8">裁剪、缩放、旋转、移动</a></li><li><a href="#%E4%BF%9D%E5%AD%98%E4%B8%8E%E9%87%8A%E6%94%BE">保存与释放</a></li><li><a href="#%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9">图片压缩</a></li></ul></li><li><a href="#bitmapfactory">BitmapFactory</a><ul><li><a href="#bitmap%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B">Bitmap创建流程</a></li><li><a href="#option%E7%B1%BB">Option类</a></li><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-1">基本使用</a></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6">内存回收</a></li></ul></li><li><a href="#%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D">屏幕适配</a><ul><li><a href="#%E5%8D%95%E4%BD%8D">单位</a></li><li><a href="#%E5%A4%B4%E6%9D%A1%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88">头条适配方案</a></li><li><a href="#%E5%88%98%E6%B5%B7%E5%B1%8F%E9%80%82%E9%85%8D">刘海屏适配</a></li></ul></li><li><a href="#context">Context</a></li><li><a href="#sharedpreferences">SharedPreferences</a><ul><li><a href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F">获取方式</a><ul><li><a href="#getpreferences">getPreferences</a></li><li><a href="#getdefaultsharedpreferences">getDefaultSharedPreferences</a></li><li><a href="#getsharedpreferences">getSharedPreferences</a></li></ul></li><li><a href="#%E6%9E%B6%E6%9E%84">架构</a></li><li><a href="#apply--commit">apply / commit</a></li><li><a href="#%E6%B3%A8%E6%84%8F">注意</a></li></ul></li><li><a href="#%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6">消息机制</a><ul><li><a href="#handler-%E6%9C%BA%E5%88%B6">Handler 机制</a></li><li><a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">工作原理</a><ul><li><a href="#threadlocal">ThreadLocal</a></li><li><a href="#messagequeue">MessageQueue</a></li><li><a href="#looper">Looper</a></li><li><a href="#handler">Handler</a></li></ul></li></ul></li><li><a href="#%E7%BA%BF%E7%A8%8B%E5%BC%82%E6%AD%A5">线程异步</a><ul><li><a href="#asynctask">AsyncTask</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-2">基本使用</a></li><li><a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-1">工作原理</a></li></ul></li><li><a href="#handlerthread">HandlerThread</a></li><li><a href="#intentservice">IntentService</a></li><li><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0">线程池</a></li></ul></li><li><a href="#recyclerview-%E4%BC%98%E5%8C%96">RecyclerView 优化</a></li><li><a href="#webview">Webview</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-3">基本使用</a><ul><li><a href="#webview-1">WebView</a></li><li><a href="#websettings">WebSettings</a></li><li><a href="#webviewclient">WebViewClient</a></li><li><a href="#webchromeclient">WebChromeClient</a></li></ul></li><li><a href="#webview-%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96">Webview 加载优化</a></li><li><a href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F">内存泄漏</a></li></ul></li></ul><h1 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h1><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="http://gityuan.com/images/lifecycle/activity.png"></p><ul><li><p>Activity A 启动另一个Activity B，回调如下:<br>Activity A 的onPause() → Activity B的onCreate() → onStart() → onResume() → Activity A的onStop()<br>；如果B是透明主题又或则是个DialogActivity，则不会回调A的onStop；</p></li><li><p>使用onSaveInstanceState（）保存简单，轻量级的UI状态</p></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">lateinit <span class="hljs-keyword">var</span> textView:TextView<br>        <span class="hljs-keyword">var</span> gameState:String?=<span class="hljs-literal">null</span><br><br>        override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState:Bundle?)</span>{<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)<br>        gameState=savedInstanceState?.getString(GAME_STATE_KEY)<br>        setContentView(R.layout.activity_main)<br>        textView=findViewById(R.id.text_view)<br>        }<br><br>        override fun <span class="hljs-title function_">onRestoreInstanceState</span><span class="hljs-params">(savedInstanceState:Bundle?)</span>{<br>        textView.text=savedInstanceState?.getString(TEXT_VIEW_KEY)<br>        }<br><br>        override fun <span class="hljs-title function_">onSaveInstanceState</span><span class="hljs-params">(outState:Bundle?)</span>{<br>        outState?.run{<br>        putString(GAME_STATE_KEY,gameState)<br>        putString(TEXT_VIEW_KEY,textView.text.toString())<br>        }<br>        <span class="hljs-built_in">super</span>.onSaveInstanceState(outState)<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="启动模式"><a href="#启动模式" class="headerlink" title="启动模式"></a>启动模式</h2><table><thead><tr><th>LaunchMode</th><th>说明</th></tr></thead><tbody><tr><td>standard</td><td>系统在启动它的任务中创建 activity 的新实例</td></tr><tr><td>singleTop</td><td>如果activity的实例已存在于当前任务的顶部，则系统通过调用其onNewIntent()，否则会创建新实例</td></tr><tr><td>singleTask</td><td>系统创建新 task 并在 task 的根目录下实例化 activity。但如果 activity 的实例已存在于单独的任务中，则调用其 onNewIntent() 方法，其上面的实例会被移除栈。一次只能存在一个 activity 实例</td></tr><tr><td>singleInstance</td><td>相同 singleTask，activity始终是其task的唯一成员; 任何由此开始的activity 都在一个单独的 task 中打开</td></tr></tbody></table><p>&nbsp;</p><!-- | 使用Intent标志 | 说明                      |----------|-----|| FLAG_ACTIVITY_NEW_TASK | 同 singleTask || FLAG_ACTIVITY_SINGLE_TOP | 同 singleTop || FLAG_ACTIVITY_CLEAR_TOP | 如果正在启动的 activity 已在当前 task中 运行，则不会启动该activity 的新实例，而是销毁其上的 activity，并调用其 onNewIntent() | --><h2 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h2><p><img src="https://img-blog.csdn.net/20180427173504903"></p><p><code>ActivityThread.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r,Intent customIntent)</span>{<br>        ...<br>        ActivityInfo aInfo=r.activityInfo;<br>        <span class="hljs-keyword">if</span>(r.packageInfo==<span class="hljs-literal">null</span>){<br>        <span class="hljs-comment">//step 1: 创建LoadedApk对象</span><br>        r.packageInfo=getPackageInfo(aInfo.applicationInfo,r.compatInfo,<br>        Context.CONTEXT_INCLUDE_CODE);<br>        }<br>        ... <span class="hljs-comment">//component初始化过程</span><br><br>        java.lang.ClassLoader cl=r.packageInfo.getClassLoader();<br>        <span class="hljs-comment">//step 2: 创建Activity对象</span><br>        Activity activity=mInstrumentation.newActivity(cl,component.getClassName(),r.intent);<br>        ...<br><br>        <span class="hljs-comment">//step 3: 创建Application对象</span><br>        Application app=r.packageInfo.makeApplication(<span class="hljs-literal">false</span>,mInstrumentation);<br><br>        <span class="hljs-keyword">if</span>(activity!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-comment">//step 4: 创建ContextImpl对象</span><br>        Context appContext=createBaseContextForActivity(r,activity);<br>        CharSequence title=r.activityInfo.loadLabel(appContext.getPackageManager());<br>        Configuration config=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(mCompatConfiguration);<br>        <span class="hljs-comment">//step5: 将Application/ContextImpl都attach到Activity对象</span><br>        activity.attach(appContext,<span class="hljs-built_in">this</span>,getInstrumentation(),r.token,<br>        r.ident,app,r.intent,r.activityInfo,title,r.parent,<br>        r.embeddedID,r.lastNonConfigurationInstances,config,<br>        r.referrer,r.voiceInteractor);<br><br>        ...<br>        <span class="hljs-type">int</span> theme=r.activityInfo.getThemeResource();<br>        <span class="hljs-keyword">if</span>(theme!=<span class="hljs-number">0</span>){<br>        activity.setTheme(theme);<br>        }<br><br>        activity.mCalled=<span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span>(r.isPersistable()){<br>        <span class="hljs-comment">//step 6: 执行回调onCreate</span><br>        mInstrumentation.callActivityOnCreate(activity,r.state,r.persistentState);<br>        }<span class="hljs-keyword">else</span>{<br>        mInstrumentation.callActivityOnCreate(activity,r.state);<br>        }<br><br>        r.activity=activity;<br>        r.stopped=<span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(!r.activity.mFinished){<br>        activity.performStart(); <span class="hljs-comment">//执行回调onStart</span><br>        r.stopped=<span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(!r.activity.mFinished){<br>        <span class="hljs-comment">//执行回调onRestoreInstanceState</span><br>        <span class="hljs-keyword">if</span>(r.isPersistable()){<br>        <span class="hljs-keyword">if</span>(r.state!=<span class="hljs-literal">null</span>||r.persistentState!=<span class="hljs-literal">null</span>){<br>        mInstrumentation.callActivityOnRestoreInstanceState(activity,r.state,<br>        r.persistentState);<br>        }<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(r.state!=<span class="hljs-literal">null</span>){<br>        mInstrumentation.callActivityOnRestoreInstanceState(activity,r.state);<br>        }<br>        }<br>        ...<br>        r.paused=<span class="hljs-literal">true</span>;<br>        mActivities.put(r.token,r);<br>        }<br><br>        <span class="hljs-keyword">return</span> activity;<br>        }<br><br></code></pre></td></tr></tbody></table></figure><h1 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h1><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul><li>Fragment 解决 Activity 间的切换不流畅，轻量切换</li><li>可以从 startActivityForResult 中接收到返回结果，但是View不能</li><li>只能在 Activity 保存其状态（用户离开 Activity）之前使用 commit() 提交事务。如果您试图在该时间点后提交，则会引发异常。<br>这是因为如需恢复 Activity，则提交后的状态可能会丢失。 对于丢失提交无关紧要的情况，请使用 commitAllowingStateLoss()。</li></ul><h2 id="生命周期-1"><a href="#生命周期-1" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="https://developer.android.google.cn/images/fragment_lifecycle.png"><img src="https://developer.android.google.cn/images/activity_fragment_lifecycle.png"></p><h2 id="与Activity通信"><a href="#与Activity通信" class="headerlink" title="与Activity通信"></a>与Activity通信</h2><p>执行此操作的一个好方法是，在片段内定义一个回调接口，并要求宿主 Activity 实现它。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ListFragment</span> {<br>    ...<br><br>    <span class="hljs-comment">// Container Activity must implement this interface</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnArticleSelectedListener</span> {<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onArticleSelected</span><span class="hljs-params">(Uri articleUri)</span>;<br>    }<br>    ...<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ListFragment</span> {<br>    OnArticleSelectedListener mListener;<br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAttach</span><span class="hljs-params">(Activity activity)</span> {<br>        <span class="hljs-built_in">super</span>.onAttach(activity);<br>        <span class="hljs-keyword">try</span> {<br>            mListener = (OnArticleSelectedListener) activity;<br>        } <span class="hljs-keyword">catch</span> (ClassCastException e) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassCastException</span>(activity.toString());<br>        }<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>Service 分为两种工作状态，一种是启动状态，主要用于执行后台计算；另一种是绑定状态，主要用于其他组件和 Service 的交互。</p><h2 id="启动过程-1"><a href="#启动过程-1" class="headerlink" title="启动过程"></a>启动过程</h2><p><img src="http://gityuan.com/images/android-service/am/Seq_start_service.png"></p><p><code>ActivityThread.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@UnsupportedAppUsage</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCreateService</span><span class="hljs-params">(CreateServiceData data)</span>{<br>        ···<br>        LoadedApk packageInfo=getPackageInfoNoCheck(<br>        data.info.applicationInfo,data.compatInfo);<br>        Service service=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>        java.lang.ClassLoader cl=packageInfo.getClassLoader();<br>        service=packageInfo.getAppFactory()<br>        .instantiateService(cl,data.info.name,data.intent);<br>        }<br>        ···<br><br>        <span class="hljs-keyword">try</span>{<br>        <span class="hljs-keyword">if</span>(localLOGV)Slog.v(TAG,<span class="hljs-string">"Creating service "</span>+data.info.name);<br><br>        ContextImpl context=ContextImpl.createAppContext(<span class="hljs-built_in">this</span>,packageInfo);<br>        context.setOuterContext(service);<br><br>        Application app=packageInfo.makeApplication(<span class="hljs-literal">false</span>,mInstrumentation);<br>        service.attach(context,<span class="hljs-built_in">this</span>,data.info.name,data.token,app,<br>        ActivityManager.getService());<br>        service.onCreate();<br>        mServices.put(data.token,service);<br>        <span class="hljs-keyword">try</span>{<br>        ActivityManager.getService().serviceDoneExecuting(<br>        data.token,SERVICE_DONE_EXECUTING_ANON,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        }<span class="hljs-keyword">catch</span>(RemoteException e){<br>        <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>        }<br>        }<br>        ···<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="绑定过程"><a href="#绑定过程" class="headerlink" title="绑定过程"></a>绑定过程</h2><p><img src="http://gityuan.com/images/ams/bind_service.jpg"></p><p><code>ActivityThread.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindService</span><span class="hljs-params">(BindServiceData data)</span>{<br>        Service s=mServices.get(data.token);<br>        ···<br>        <span class="hljs-keyword">if</span>(s!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">try</span>{<br>        data.intent.setExtrasClassLoader(s.getClassLoader());<br>        data.intent.prepareToEnterProcess();<br>        <span class="hljs-keyword">try</span>{<br>        <span class="hljs-keyword">if</span>(!data.rebind){<br>        IBinder binder=s.onBind(data.intent);<br>        ActivityManager.getService().publishService(<br>        data.token,data.intent,binder);<br>        }<span class="hljs-keyword">else</span>{<br>        s.onRebind(data.intent);<br>        ActivityManager.getService().serviceDoneExecuting(<br>        data.token,SERVICE_DONE_EXECUTING_ANON,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        }<br>        }<span class="hljs-keyword">catch</span>(RemoteException ex){<br>        <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>        }<br>        }<br>        ···<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="生命周期-2"><a href="#生命周期-2" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="https://upload-images.jianshu.io/upload_images/944365-cf5c1a9d2dddaaca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/456/format/webp"></p><table><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td>START_NOT_STICKY</td><td>如果系统在 onStartCommand() 返回后终止服务，则除非有挂起 Intent</td></tr><tr><td>要传递，否则系统不会重建服务。这是最安全的选项，可以避免在不必要时以及应用能够轻松重启所有未完成的作业时运行服务</td><td></td></tr><tr><td>START_STICKY</td><td>如果系统在 onStartCommand() 返回后终止服务，则会重建服务并调用 onStartCommand()，但不会重新传递最后一个</td></tr><tr><td>Intent。相反，除非有挂起 Intent 要启动服务（在这种情况下，将传递这些 Intent ），否则系统会通过空 Intent 调用 onStartCommand()</td><td></td></tr><tr><td>。这适用于不执行命令、但无限期运行并等待作业的媒体播放器（或类似服务</td><td></td></tr><tr><td>START_REDELIVER_INTENT</td><td>如果系统在 onStartCommand() 返回后终止服务，则会重建服务，并通过传递给服务的最后一个 Intent 调用</td></tr><tr><td>onStartCommand()。任何挂起 Intent 均依次传递。这适用于主动执行应该立即恢复的作业（例如下载文件）的服务</td><td></td></tr></tbody></table><h2 id="启用前台服务"><a href="#启用前台服务" class="headerlink" title="启用前台服务"></a>启用前台服务</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;uses-permission android:name=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE"</span>/&gt;<br></code></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Notification notification=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Notification</span>(icon,text,System.currentTimeMillis());<br>        Intent notificationIntent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,ExampleActivity.class);<br>        PendingIntent pendingIntent=PendingIntent.getActivity(<span class="hljs-built_in">this</span>,<span class="hljs-number">0</span>,notificationIntent,<span class="hljs-number">0</span>);<br>        notification.setLatestEventInfo(<span class="hljs-built_in">this</span>,title,mmessage,pendingIntent);<br>        startForeground(ONGOING_NOTIFICATION_ID,notification);<br></code></pre></td></tr></tbody></table></figure><h1 id="BroadcastReceiver"><a href="#BroadcastReceiver" class="headerlink" title="BroadcastReceiver"></a>BroadcastReceiver</h1><p>target 26 之后，无法在 AndroidManifest 显示声明大部分广播，除了一部分必要的广播，如：</p><ul><li>ACTION_BOOT_COMPLETED</li><li>ACTION_TIME_SET</li><li>ACTION_LOCALE_CHANGED</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">LocalBroadcastManager.getInstance(MainActivity.<span class="hljs-built_in">this</span>).registerReceiver(receiver,filter);<br></code></pre></td></tr></tbody></table></figure><h2 id="注册过程"><a href="#注册过程" class="headerlink" title="注册过程"></a>注册过程</h2><p><img src="http://gityuan.com/images/ams/send_broadcast.jpg"></p><h1 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h1><p>ContentProvider 管理对结构化数据集的访问。它们封装数据，并提供用于定义数据安全性的机制。<br>内容提供程序是连接一个进程中的数据与另一个进程中运行的代码的标准界面。</p><p>ContentProvider 无法被用户感知，对于一个 ContentProvider<br>组件来说，它的内部需要实现增删该查这四种操作，它的内部维持着一份数据集合，这个数据集合既可以是数据库实现，也可以是其他任何类型，如<br>List 和 Map，内部的 insert、delete、update、query 方法需要处理好线程同步，因为这几个方法是在 Binder 线程池中被调用的。</p><p>ContentProvider 通过 Binder 向其他组件乃至其他应用提供数据。当 ContentProvider 所在的进程启动时，ContentProvider 会同时启动并发布到<br>AMS 中，需要注意的是，这个时候 ContentProvider 的 onCreate 要先于 Application 的 onCreate 而执行。</p><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Queries the user dictionary and returns results</span><br>mCursor=getContentResolver().query(<br>        UserDictionary.Words.CONTENT_URI,   <span class="hljs-comment">// The content URI of the words table</span><br>        mProjection,                        <span class="hljs-comment">// The columns to return for each row</span><br>        mSelectionClause                    <span class="hljs-comment">// Selection criteria</span><br>        mSelectionArgs,                     <span class="hljs-comment">// Selection criteria</span><br>        mSortOrder);                        <span class="hljs-comment">// The sort order for the returned rows</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Installer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Cursor <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String[] projection, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs, <span class="hljs-meta">@Nullable</span> String sortOrder)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Uri <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues values)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues values, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>ContentProvider 和 sql 在实现上有什么区别?</p><ul><li>ContentProvider 屏蔽了数据存储的细节，内部实现透明化，用户只需关心 uri 即可(是否匹配)</li><li>ContentProvider 能实现不同 app 的数据共享，sql 只能是自己程序才能访问</li><li>Contentprovider 还能增删本地的文件,xml等信息</li></ul></blockquote><h1 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h1><table><thead><tr><th>存储方式</th><th>说明</th></tr></thead><tbody><tr><td>SharedPreferences</td><td>在键值对中存储私有原始数据</td></tr><tr><td>内部存储</td><td>在设备内存中存储私有数据</td></tr><tr><td>外部存储</td><td>在共享的外部存储中存储公共数据</td></tr><tr><td>SQLite 数据库</td><td>在私有数据库中存储结构化数据</td></tr></tbody></table><h1 id="View"><a href="#View" class="headerlink" title="View"></a>View</h1><p><img src="https://user-gold-cdn.xitu.io/2019/6/12/16b4a8a388f3a91a?imageslim"><br>ViewRoot 对应于 ViewRootImpl 类，它是连接 WindowManager 和 DecorView 的纽带，View 的三大流程均是通过 ViewRoot 来完成的。在<br>ActivityThread 中，当 Activity 对象被创建完毕后，会将 DecorView 添加到 Window 中，同时会创建 ViewRootImpl 对象，并将<br>ViewRootImpl 对象和 DecorView 建立关联</p><p>View 的整个绘制流程可以分为以下三个阶段：</p><ul><li>measure: 判断是否需要重新计算 View 的大小，需要的话则计算</li><li>layout: 判断是否需要重新计算 View 的位置，需要的话则计算</li><li>draw: 判断是否需要重新绘制 View，需要的话则重绘制</li></ul><p><img src="https://img-blog.csdn.net/20180510164327114"></p><h2 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h2><p>MeasureSpec表示的是一个32位的整形值，它的高2位表示测量模式SpecMode，低30位表示某种测量模式下的规格大小SpecSize。MeasureSpec<br>是 View 类的一个静态内部类，用来说明应该如何测量这个 View</p><table><thead><tr><th>Mode</th><th>说明</th></tr></thead><tbody><tr><td>UNSPECIFIED</td><td>不指定测量模式, 父视图没有限制子视图的大小，子视图可以是想要的任何尺寸，通常用于系统内部，应用开发中很少用到。</td></tr><tr><td>EXACTLY</td><td>精确测量模式，视图宽高指定为 match_parent 或具体数值时生效，表示父视图已经决定了子视图的精确大小，这种模式下 View 的测量值就是 SpecSize 的值</td></tr><tr><td>AT_MOST</td><td>最大值测量模式，当视图的宽高指定为 wrap_content 时生效，此时子视图的尺寸可以是不超过父视图允许的最大尺寸的任何尺寸</td></tr></tbody></table><p>对于 DecorView 而言，它的MeasureSpec 由窗口尺寸和其自身的 LayoutParams 共同决定；对于普通的 View，它的 MeasureSpec 由父视图的<br>MeasureSpec 和其自身的 LayoutParams 共同决定</p><table><thead><tr><th>childLayoutParams/parentSpecMode</th><th>EXACTLY</th><th>AT_MOST</th></tr></thead><tbody><tr><td>dp/px</td><td>EXACTLY(childSize)</td><td>EXACTLY(childSize)</td></tr><tr><td>match_parent</td><td>EXACTLY(childSize)</td><td>AT_MOST(parentSize)</td></tr><tr><td>wrap_content</td><td>AT_MOST(parentSize)</td><td>AT_MOST(parentSize)</td></tr></tbody></table><p>直接继承 View 的控件需要重写 onMeasure 方法并设置 wrap_content 时的自身大小，因为 View 在布局中使用 wrap_content，那么它的<br>specMode 是 AT_MOST 模式，在这种模式下，它的宽/高等于父容器当前剩余的空间大小，就相当于使用 match_parent。这解决方式如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec,<span class="hljs-type">int</span> heightMeasureSpec)</span>{<br>        <span class="hljs-built_in">super</span>.onMeasure(widthMeasureSpec,heightMeasureSpec);<br>        <span class="hljs-type">int</span> widthSpecMode=MeasureSpec.getMode(widthMeasureSpec);<br>        <span class="hljs-type">int</span> widthSpecSize=MeasureSpec.getSize(widthMeasureSpec);<br>        <span class="hljs-type">int</span> heightSpecMode=MeasureSpec.getMode(heightMeasureSpec);<br>        <span class="hljs-type">int</span> heightSpecSize=MeasureSpec.getSize(heightMeasureSpec);<br>        <span class="hljs-comment">// 在 wrap_content 的情况下指定内部宽/高(mWidth 和 mHeight`)</span><br>        <span class="hljs-keyword">if</span>(widthSpecMode==MeasureSpec.AT_MOST&amp;&amp;heightSpecMode==MeasureSpec.AT_MOST){<br>        setMeasuredDimension(mWidth,mHeight);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(widthSpecMode==MeasureSpec.AT_MOST){<br>        setMeasureDimension(mWidth,heightSpecSize);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(heightSpecMode==MeasureSpec.AT_MOST){<br>        setMeasureDimension(widthSpecSize,mHeight);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="MotionEvent"><a href="#MotionEvent" class="headerlink" title="MotionEvent"></a>MotionEvent</h2><table><thead><tr><th>事件</th><th>说明</th></tr></thead><tbody><tr><td>ACTION_DOWN</td><td>手指刚接触到屏幕</td></tr><tr><td>ACTION_MOVE</td><td>手指在屏幕上移动</td></tr><tr><td>ACTION_UP</td><td>手机从屏幕上松开的一瞬间</td></tr><tr><td>ACTION_CANCEL</td><td>触摸事件取消</td></tr></tbody></table><p>点击屏幕后松开，事件序列为 DOWN -&gt; UP，点击屏幕滑动松开，事件序列为 DOWN -&gt; MOVE -&gt; …&gt; MOVE -&gt; UP。</p><p><code>getX/getY</code> 返回相对于当前View左上角的坐标，<code>getRawX/getRawY</code> 返回相对于屏幕左上角的坐标</p><p>TouchSlop是系统所能识别出的被认为滑动的最小距离，不同设备值可能不相同，可通过 <code>ViewConfiguration.get(getContext()).getScaledTouchSlop()</code><br>获取。</p><h2 id="VelocityTracker"><a href="#VelocityTracker" class="headerlink" title="VelocityTracker"></a>VelocityTracker</h2><p><strong>VelocityTracker</strong> 可用于追踪手指在滑动中的速度：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">view.setOnTouchListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnTouchListener(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(View v,MotionEvent event)</span>{<br>        VelocityTracker velocityTracker=VelocityTracker.obtain();<br>        velocityTracker.addMovement(event);<br>        velocityTracker.computeCurrentVelocity(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">int</span> xVelocity=(<span class="hljs-type">int</span>)velocityTracker.getXVelocity();<br>        <span class="hljs-type">int</span> yVelocity=(<span class="hljs-type">int</span>)velocityTracker.getYVelocity();<br>        velocityTracker.clear();<br>        velocityTracker.recycle();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        });<br></code></pre></td></tr></tbody></table></figure><h2 id="GestureDetector"><a href="#GestureDetector" class="headerlink" title="GestureDetector"></a>GestureDetector</h2><p><strong>GestureDetector</strong> 辅助检测用户的单击、滑动、长按、双击等行为：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> GestureDetector mGestureDetector=<span class="hljs-keyword">new</span> <span class="hljs-title class_">GestureDetector</span>(<span class="hljs-built_in">this</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">GestureDetector</span>.OnGestureListener(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onDown</span><span class="hljs-params">(MotionEvent e)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onShowPress</span><span class="hljs-params">(MotionEvent e)</span>{}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onSingleTapUp</span><span class="hljs-params">(MotionEvent e)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onScroll</span><span class="hljs-params">(MotionEvent e1,MotionEvent e2,<span class="hljs-type">float</span> distanceX,<span class="hljs-type">float</span> distanceY)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLongPress</span><span class="hljs-params">(MotionEvent e)</span>{}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onFling</span><span class="hljs-params">(MotionEvent e1,MotionEvent e2,<span class="hljs-type">float</span> velocityX,<span class="hljs-type">float</span> velocityY)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br>        });<br>        mGestureDetector.setOnDoubleTapListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnDoubleTapListener</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onSingleTapConfirmed</span><span class="hljs-params">(MotionEvent e)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onDoubleTap</span><span class="hljs-params">(MotionEvent e)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onDoubleTapEvent</span><span class="hljs-params">(MotionEvent e)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}<br>        });<br><span class="hljs-comment">// 解决长按屏幕后无法拖动的问题</span><br>        mGestureDetector.setIsLongpressEnabled(<span class="hljs-literal">false</span>);<br>        imageView.setOnTouchListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnTouchListener(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(View v,MotionEvent event)</span>{<br>        <span class="hljs-keyword">return</span> mGestureDetector.onTouchEvent(event);<br>        }<br>        });<br></code></pre></td></tr></tbody></table></figure><p>如果是监听滑动相关，建议在 <code>onTouchEvent</code> 中实现，如果要监听双击，那么就使用 <code>GestureDectector</code>。</p><h2 id="Scroller"><a href="#Scroller" class="headerlink" title="Scroller"></a>Scroller</h2><p>弹性滑动对象，用于实现 View 的弹性滑动，<strong>Scroller</strong> 本身无法让 View 弹性滑动，需要和 View 的 <code>computeScroll</code><br>方法配合使用。<code>startScroll</code> 方法是无法让 View 滑动的，<code>invalidate</code> 会导致 View 重绘，重回后会在 <code>draw</code><br>方法中又会去调用 <code>computeScroll</code> 方法，<code>computeScroll</code> 方法又会去向 Scroller 获取当前的 scrollX 和<br>scrollY，然后通过 <code>scrollTo</code> 方法实现滑动，接着又调用 <code>postInvalidate</code> 方法如此反复。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Scroller mScroller=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scroller</span>(mContext);<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">smoothScrollTo</span><span class="hljs-params">(<span class="hljs-type">int</span> destX)</span>{<br>        <span class="hljs-type">int</span> scrollX=getScrollX();<br>        <span class="hljs-type">int</span> delta=destX-scrollX;<br>        <span class="hljs-comment">// 1000ms 内滑向 destX，效果就是慢慢滑动</span><br>        mScroller.startScroll(scrollX,<span class="hljs-number">0</span>,delta,<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>);<br>        invalidate();<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">computeScroll</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">if</span>(mScroller.computeScrollOffset()){<br>        scrollTo(mScroller.getCurrX(),mScroller.getCurrY());<br>        postInvalidate();<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="View-的滑动"><a href="#View-的滑动" class="headerlink" title="View 的滑动"></a>View 的滑动</h2><ul><li><code>scrollTo/scrollBy</code><br>适合对 View 内容的滑动。<code>scrollBy</code> 实际上也是调用了 <code>scrollTo</code> 方法：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scrollTo</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>{<br>        <span class="hljs-keyword">if</span>(mScrollX!=x||mScrollY!=y){<br>        <span class="hljs-type">int</span> oldX=mScrollX;<br>        <span class="hljs-type">int</span> oldY=mScrollY;<br>        mScrollX=x;<br>        mScrollY=y;<br>        invalidateParentCaches();<br>        onScrollChanged(mScrollX,mScrollY,oldX,oldY);<br>        <span class="hljs-keyword">if</span>(!awakenScrollBars()){<br>        postInvalidateOnAnimation();<br>        }<br>        }<br>        }<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scrollBy</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>{<br>        scrollTo(mScrollX+x,mScrollY+y);<br>        }<br></code></pre></td></tr></tbody></table></figure><p>mScrollX的值等于 View 的左边缘和 View 内容左边缘在水平方向的距离，mScrollY的值等于 View 上边缘和 View<br>内容上边缘在竖直方向的距离。<code>scrollTo</code> 和 <code>scrollBy</code> 只能改变 View 内容的位置而不能改变 View 在布局中的位置。</p><ul><li>使用动画<br>操作简单，主要适用于没有交互的 View 和实现复杂的动画效果。</li><li>改变布局参数<br>操作稍微复杂，适用于有交互的 View.</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">ViewGroup.MarginLayoutParams params=(ViewGroup.MarginLayoutParams)view.getLayoutParams();<br>        params.width+=<span class="hljs-number">100</span>;<br>        params.leftMargin+=<span class="hljs-number">100</span>;<br>        view.requestLayout();<br><span class="hljs-comment">//或者 view.setLayoutParams(params);</span><br></code></pre></td></tr></tbody></table></figure><h2 id="View-的事件分发"><a href="#View-的事件分发" class="headerlink" title="View 的事件分发"></a>View 的事件分发</h2><p>点击事件达到顶级 View(一般是一个 ViewGroup)，会调用 ViewGroup 的 dispatchTouchEvent 方法，如果顶级 ViewGroup 拦截事件即<br>onInterceptTouchEvent 返回 true，则事件由 ViewGroup 处理，这时如果 ViewGroup 的 mOnTouchListener 被设置，则 onTouch 会被调用，否则<br>onTouchEvent 会被调用。也就是说如果都提供的话，onTouch 会屏蔽掉 onTouchEvent。在 onTouchEvent 中，如果设置了<br>mOnClickListenser，则 onClick 会被调用。如果顶级 ViewGroup 不拦截事件，则事件会传递给它所在的点击事件链上的子 View，这时子<br>View 的 dispatchTouchEvent 会被调用。如此循环。</p><p><img src="https://user-gold-cdn.xitu.io/2019/7/19/16c08654e36be140?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p><p><img src="https://user-gold-cdn.xitu.io/2019/7/19/16c086493dc70018?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p><ul><li><p>ViewGroup 默认不拦截任何事件。ViewGroup 的 onInterceptTouchEvent 方法默认返回 false。</p></li><li><p>View 没有 onInterceptTouchEvent 方法，一旦有点击事件传递给它，onTouchEvent 方法就会被调用。</p></li><li><p>View 在可点击状态下，onTouchEvent 默认会消耗事件。</p></li><li><p>ACTION_DOWN 被拦截了，onInterceptTouchEvent 方法执行一次后，就会留下记号（mFirstTouchTarget == null）那么往后的<br>ACTION_MOVE 和 ACTION_UP 都会拦截。`</p></li></ul><h2 id="在-Activity-中获取某个-View-的宽高"><a href="#在-Activity-中获取某个-View-的宽高" class="headerlink" title="在 Activity 中获取某个 View 的宽高"></a>在 Activity 中获取某个 View 的宽高</h2><ul><li>Activity/View#onWindowFocusChanged</li></ul><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 此时View已经初始化完毕</span><br><span class="hljs-comment">// 当Activity的窗口得到焦点和失去焦点时均会被调用一次</span><br><span class="hljs-comment">// 如果频繁地进行onResume和onPause，那么onWindowFocusChanged也会被频繁地调用</span><br>public void on<span class="hljs-constructor">WindowFocusChanged(<span class="hljs-params">boolean</span> <span class="hljs-params">hasFocus</span>)</span> {<br>    super.on<span class="hljs-constructor">WindowFocusChanged(<span class="hljs-params">hasFocus</span>)</span>;<br>    <span class="hljs-keyword">if</span> (hasFocus) {<br>        <span class="hljs-built_in">int</span> width = view.get<span class="hljs-constructor">MeasureWidth()</span>;<br>        <span class="hljs-built_in">int</span> height = view.get<span class="hljs-constructor">MeasuredHeight()</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>view.post(runnable)</li></ul><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">// 通过post可以将一个runnable投递到消息队列的尾部，// 然后等待Looper调用次runnable的时候，View也已经初</span><br><span class="hljs-comment">// 始化好了</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">super</span>.onStart();<br>    view.post(<span class="hljs-keyword">new</span> Runnable() {<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>            <span class="hljs-keyword">int</span> width = view.getMeasuredWidth();<br>            <span class="hljs-keyword">int</span> height = view.getMeasuredHeight();<br>        }<br>    });<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>ViewTreeObserver</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 当View树的状态发生改变或者View树内部的View的可见// 性发生改变时，onGlobalLayout方法将被回调</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span>{<br>        <span class="hljs-built_in">super</span>.onStart();<br><br>        ViewTreeObserver observer=view.getViewTreeObserver();<br>        observer.addOnGlobalLayoutListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnGlobalLayoutListener</span>(){<br><br><span class="hljs-meta">@SuppressWarnings("deprecation")</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onGlobalLayout</span><span class="hljs-params">()</span>{<br>        view.getViewTreeObserver().removeGlobalOnLayoutListener(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-type">int</span> width=view.getMeasuredWidth();<br>        <span class="hljs-type">int</span> height=view.getMeasuredHeight();<br>        }<br>        });<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="Draw-的基本流程"><a href="#Draw-的基本流程" class="headerlink" title="Draw 的基本流程"></a>Draw 的基本流程</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 绘制基本上可以分为六个步骤</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(Canvas canvas)</span>{<br>        ...<br>        <span class="hljs-comment">// 步骤一：绘制View的背景</span><br>        drawBackground(canvas);<br>        ...<br>        <span class="hljs-comment">// 步骤二：如果需要的话，保持canvas的图层，为fading做准备</span><br>        saveCount=canvas.getSaveCount();<br>        ...<br>        canvas.saveLayer(left,top,right,top+length,<span class="hljs-literal">null</span>,flags);<br>        ...<br>        <span class="hljs-comment">// 步骤三：绘制View的内容</span><br>        onDraw(canvas);<br>        ...<br>        <span class="hljs-comment">// 步骤四：绘制View的子View</span><br>        dispatchDraw(canvas);<br>        ...<br>        <span class="hljs-comment">// 步骤五：如果需要的话，绘制View的fading边缘并恢复图层</span><br>        canvas.drawRect(left,top,right,top+length,p);<br>        ...<br>        canvas.restoreToCount(saveCount);<br>        ...<br>        <span class="hljs-comment">// 步骤六：绘制View的装饰(例如滚动条等等)</span><br>        onDrawForeground(canvas)<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="自定义-View"><a href="#自定义-View" class="headerlink" title="自定义 View"></a>自定义 View</h2><ul><li>继承 View 重写 <code>onDraw</code> 方法</li></ul><p>主要用于实现一些不规则的效果，静态或者动态地显示一些不规则的图形，即重写 <code>onDraw</code> 方法。采用这种方式需要自己支持<br>wrap_content，并且 padding 也需要自己处理。</p><ul><li>继承 ViewGroup 派生特殊的 Layout</li></ul><p>主要用于实现自定义布局，采用这种方式需要合适地处理 ViewGroup 的测量、布局两个过程，并同时处理子元素的测量和布局过程。</p><ul><li>继承特定的 View</li></ul><p>用于扩张某种已有的View的功能</p><ul><li>继承特定的 ViewGroup</li></ul><p>用于扩张某种已有的ViewGroup的功能</p><h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><p>进程（Process） 是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。</p><p>当某个应用组件启动且该应用没有运行其他任何组件时，Android 系统会使用单个执行线程为应用启动新的 Linux<br>进程。默认情况下，同一应用的所有组件在相同的进程和线程（称为“主”线程）中运行。</p><p>各类组件元素的清单文件条目<code>&lt;activity&gt;</code>、<code>&lt;service&gt;</code>、<code>&lt;receiver&gt;</code> 和 <code>&lt;provider&gt;</code>—均支持 android:process<br>属性，此属性可以指定该组件应在哪个进程运行。</p><h2 id="进程生命周期"><a href="#进程生命周期" class="headerlink" title="进程生命周期"></a>进程生命周期</h2><p><strong>1、前台进程</strong></p><ul><li>托管用户正在交互的 Activity（已调用 Activity 的 <code>onResume()</code> 方法）</li><li>托管某个 Service，后者绑定到用户正在交互的 Activity</li><li>托管正在“前台”运行的 Service（服务已调用 <code>startForeground()</code>）</li><li>托管正执行一个生命周期回调的 Service（<code>onCreate()</code>、<code>onStart()</code> 或 <code>onDestroy()</code>）</li><li>托管正执行其 <code>onReceive()</code> 方法的 BroadcastReceiver</li></ul><p><strong>2、可见进程</strong></p><ul><li>托管不在前台、但仍对用户可见的 Activity（已调用其 <code>onPause()</code> 方法）。例如，如果 re前台 Activity 启动了一个对话框，允许在其后显示上一<br>Activity，则有可能会发生这种情况。</li><li>托管绑定到可见（或前台）Activity 的 Service</li></ul><p><strong>3、服务进程</strong></p><ul><li>正在运行已使用 startService() 方法启动的服务且不属于上述两个更高类别进程的进程。</li></ul><p><strong>4、后台进程</strong></p><ul><li>包含目前对用户不可见的 Activity 的进程（已调用 Activity 的 <code>onStop()</code> 方法）。通常会有很多后台进程在运行，因此它们会保存在<br>LRU （最近最少使用）列表中，以确保包含用户最近查看的 Activity 的进程最后一个被终止。</li></ul><p><strong>5、空进程</strong></p><ul><li>不含任何活动应用组件的进程。保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间。<br>为使总体系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。\</li></ul><h2 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h2><p>如果注册的四大组件中的任意一个组件时用到了多进程，运行该组件时，都会创建一个新的 Application 对象。对于多进程重复创建<br>Application 这种情况，只需要在该类中对当前进程加以判断即可。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {<br>        Log.d(<span class="hljs-string">"MyApplication"</span>, getProcessName(android.os.Process.myPid()));<br>        <span class="hljs-built_in">super</span>.onCreate();<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据进程 ID 获取进程名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pid 进程id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 进程名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProcessName</span><span class="hljs-params">(<span class="hljs-type">int</span> pid)</span> {<br>        <span class="hljs-type">ActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);<br>        List&lt;ActivityManager.RunningAppProcessInfo&gt; processInfoList = am.getRunningAppProcesses();<br>        <span class="hljs-keyword">if</span> (processInfoList == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        <span class="hljs-keyword">for</span> (ActivityManager.RunningAppProcessInfo processInfo : processInfoList) {<br>            <span class="hljs-keyword">if</span> (processInfo.pid == pid) {<br>                <span class="hljs-keyword">return</span> processInfo.processName;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>一般来说，使用多进程会造成以下几个方面的问题：</p><ul><li>静态成员和单例模式完全失效</li><li>线程同步机制完全失效</li><li>SharedPreferences 的可靠性下降</li><li>Application 会多次创建</li></ul></blockquote><h2 id="进程存活"><a href="#进程存活" class="headerlink" title="进程存活"></a>进程存活</h2><h3 id="OOM-ADJ"><a href="#OOM-ADJ" class="headerlink" title="OOM_ADJ"></a>OOM_ADJ</h3><table><thead><tr><th>ADJ级别</th><th>取值</th><th>解释</th></tr></thead><tbody><tr><td>UNKNOWN_ADJ</td><td>16</td><td>一般指将要会缓存进程，无法获取确定值</td></tr><tr><td>CACHED_APP_MAX_ADJ</td><td>15</td><td>不可见进程的adj最大值</td></tr><tr><td>CACHED_APP_MIN_ADJ</td><td>9</td><td>不可见进程的adj最小值</td></tr><tr><td>SERVICE_B_AD</td><td>8</td><td>B List 中的 Service（较老的、使用可能性更小）</td></tr><tr><td>PREVIOUS_APP_ADJ</td><td>7</td><td>上一个App的进程(往往通过按返回键)</td></tr><tr><td>HOME_APP_ADJ</td><td>6</td><td>Home进程</td></tr><tr><td>SERVICE_ADJ</td><td>5</td><td>服务进程(Service process)</td></tr><tr><td>HEAVY_WEIGHT_APP_ADJ</td><td>4</td><td>后台的重量级进程，system/rootdir/init.rc 文件中设置</td></tr><tr><td>BACKUP_APP_ADJ</td><td>3</td><td>备份进程</td></tr><tr><td>PERCEPTIBLE_APP_ADJ</td><td>2</td><td>可感知进程，比如后台音乐播放</td></tr><tr><td>VISIBLE_APP_ADJ</td><td>1</td><td>可见进程(Visible process)</td></tr><tr><td>FOREGROUND_APP_ADJ</td><td>0</td><td>前台进程（Foreground process)</td></tr><tr><td>PERSISTENT_SERVICE_ADJ</td><td>-11</td><td>关联着系统或persistent进程</td></tr><tr><td>PERSISTENT_PROC_ADJ</td><td>-12</td><td>系统 persistent 进程，比如telephony</td></tr><tr><td>SYSTEM_ADJ</td><td>-16</td><td>系统进程</td></tr><tr><td>NATIVE_ADJ</td><td>-17</td><td>native进程（不被系统管理）</td></tr></tbody></table><h3 id="进程被杀情况"><a href="#进程被杀情况" class="headerlink" title="进程被杀情况"></a>进程被杀情况</h3><p><img src="https://pic3.zhimg.com/80/18b6bfb1bf54433619a7122c3a8e606e_hd.png"></p><h3 id="进程保活方案"><a href="#进程保活方案" class="headerlink" title="进程保活方案"></a>进程保活方案</h3><ul><li>开启一个像素的 Activity</li><li>使用前台服务</li><li>多进程相互唤醒</li><li>JobSheduler 唤醒</li><li>粘性服务 &amp; 与系统服务捆绑</li></ul><h1 id="Parcelable-接口"><a href="#Parcelable-接口" class="headerlink" title="Parcelable 接口"></a>Parcelable 接口</h1><p>只要实现了 Parcelable 接口，一个类的对象就可以实现序列化并可以通过 Intent 和 Binder 传递。</p><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> android.os.Parcel;<br><span class="hljs-keyword">import</span> android.os.Parcelable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> userId;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">User</span><span class="hljs-params">(Parcel in)</span> {<br>        userId = in.readInt();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Creator</span>&lt;User&gt;() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createFromParcel</span><span class="hljs-params">(Parcel in)</span> {<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(in);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> User[] newArray(<span class="hljs-type">int</span> size) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>[size];<br>        }<br>    };<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">describeContents</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToParcel</span><span class="hljs-params">(Parcel dest, <span class="hljs-type">int</span> flags)</span> {<br>        dest.writeInt(userId);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> userId;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="方法说明"><a href="#方法说明" class="headerlink" title="方法说明"></a>方法说明</h2><p>Parcel 内部包装了可序列化的数据，可以在 Binder 中自由传输。序列化功能由 <code>writeToParcel</code> 方法完成，最终是通过 Parcel 中的一系列<br>write 方法完成。反序列化功能由 CREATOR 来完成，通过 Parcel 的一系列 read 方法来完成反序列化过程。</p><table><thead><tr><th>方法</th><th>功能</th></tr></thead><tbody><tr><td>createFromParcel(Parcel in)</td><td>从序列化后的对象中创建原始对象</td></tr><tr><td>newArray(int size)</td><td>创建指定长度的原始对象数组</td></tr><tr><td>User(Parcel in)</td><td>从序列化后的对象中创建原始对象</td></tr><tr><td>writeToParcel(Parcel dest, int flags)</td><td>将当前对象写入序列化结构中，其中 flags 标识有两种值：0 或者 1。为 1 时标识当前对象需要作为返回值返回，不能立即释放资源，几乎所有情况都为 0</td></tr><tr><td>describeContents</td><td>返回当前对象的内容描述。如果含有文件描述符，返回 1，否则返回 0，几乎所有情况都返回 0</td></tr></tbody></table><h2 id="Parcelable-与-Serializable-对比"><a href="#Parcelable-与-Serializable-对比" class="headerlink" title="Parcelable 与 Serializable 对比"></a>Parcelable 与 Serializable 对比</h2><ul><li>Serializable 使用 I/O 读写存储在硬盘上，而 Parcelable 是直接在内存中读写</li><li>Serializable 会使用反射，序列化和反序列化过程需要大量 I/O 操作， Parcelable 自已实现封送和解封（marshalled<br>&amp;unmarshalled）操作不需要用反射，数据也存放在 Native 内存中，效率要快很多</li></ul><h1 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h1><p>IPC 即 Inter-Process Communication (进程间通信)。Android 基于 Linux，而 Linux 出于安全考虑，不同进程间不能之间操作对方的数据，这叫做“进程隔离”。</p><blockquote><p>在 Linux 系统中，虚拟内存机制为每个进程分配了线性连续的内存空间，操作系统将这种虚拟内存空间映射到物理内存空间，每个进程有自己的虚拟内存空间，进而不能操作其他进程的内存空间，只有操作系统才有权限操作物理内存空间。<br>进程隔离保证了每个进程的内存安全。</p></blockquote><h2 id="IPC方式"><a href="#IPC方式" class="headerlink" title="IPC方式"></a>IPC方式</h2><table><thead><tr><th>名称</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>Bundle</td><td>简单易用</td><td>只能传输 Bundle 支持的数据类型</td><td>四大组件间的进程间通信</td></tr><tr><td>文件共享</td><td>简单易用</td><td>不适合高并发场景，并且无法做到进程间即时通信</td><td>无并发访问情形，交换简单的数据实时性不高的场景</td></tr><tr><td>AIDL</td><td>功能强大，支持一对多并发通信，支持实时通信</td><td>使用稍复杂，需要处理好线程同步</td><td>一对多通信且有 RPC 需求</td></tr><tr><td>Messenger</td><td>功能一般，支持一对多串行通信，支持实时通信</td><td>不能很处理高并发清醒，不支持 RPC，数据通过 Message 进行传输，因此只能传输 Bundle 支持的数据类型</td><td>低并发的一对多即时通信，无RPC需求，或者无需返回结果的RPC需求</td></tr><tr><td>ContentProvider</td><td>在数据源访问方面功能强大，支持一对多并发数据共享，可通过 Call 方法扩展其他操作</td><td>可以理解为受约束的 AIDL，主要提供数据源的 CRUD 操作</td><td>一对多的进程间数据共享</td></tr><tr><td>Socket</td><td>可以通过网络传输字节流，支持一对多并发实时通信</td><td>实现细节稍微有点烦琐，不支持直接的RPC</td><td>网络数据交换</td></tr></tbody></table><h2 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h2><p>Binder 是 Android 中的一个类，实现了 IBinder 接口。从 IPC 角度来说，Binder 是 Android 中的一种扩进程通信方方式。从 Android<br>应用层来说，Binder 是客户端和服务器端进行通信的媒介，当 bindService 的时候，服务端会返回一个包含了服务端业务调用的 Binder<br>对象。</p><p>Binder 相较于传统 IPC 来说更适合于Android系统，具体原因的包括如下三点：</p><ul><li>Binder 本身是 C/S 架构的，这一点更符合 Android 系统的架构</li><li>性能上更有优势：管道，消息队列，Socket 的通讯都需要两次数据拷贝，而 Binder 只需要一次。要知道，对于系统底层的 IPC<br>形式，少一次数据拷贝，对整体性能的影响是非常之大的</li><li>安全性更好：传统 IPC 形式，无法得到对方的身份标识（UID/GID)，而在使用 Binder IPC 时，这些身份标示是跟随调用过程而自动传递的。Server<br>端很容易就可以知道 Client 端的身份，非常便于做安全检查</li></ul><p>示例：</p><ul><li><strong>新建AIDL接口文件</strong></li></ul><p><code>RemoteService.aidl</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mystudyapplication3;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteService</span> {<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span>;<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>系统会自动生成 <code>IRemoteService.java</code>:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This file is auto-generated.  DO NOT MODIFY.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> com.example.mystudyapplication3;<br><span class="hljs-comment">// Declare any non-default types here with import statements</span><br><span class="hljs-comment">//import com.example.mystudyapplication3.IUserBean;</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">android</span>.os.IInterface {<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Local-side IPC implementation stub class.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Stub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">android</span>.os.Binder <span class="hljs-keyword">implements</span> <span class="hljs-title class_">com</span>.example.mystudyapplication3.IRemoteService {<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.example.mystudyapplication3.IRemoteService"</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Construct the stub at attach it to the interface.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Stub</span><span class="hljs-params">()</span> {<br>            <span class="hljs-built_in">this</span>.attachInterface(<span class="hljs-built_in">this</span>, DESCRIPTOR);<br>        }<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Cast an IBinder object into an com.example.mystudyapplication3.IRemoteService interface,</span><br><span class="hljs-comment">         * generating a proxy if needed.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> com.example.mystudyapplication3.IRemoteService <span class="hljs-title function_">asInterface</span><span class="hljs-params">(android.os.IBinder obj)</span> {<br>            <span class="hljs-keyword">if</span> ((obj == <span class="hljs-literal">null</span>)) {<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            }<br>            android.os.<span class="hljs-type">IInterface</span> <span class="hljs-variable">iin</span> <span class="hljs-operator">=</span> obj.queryLocalInterface(DESCRIPTOR);<br>            <span class="hljs-keyword">if</span> (((iin != <span class="hljs-literal">null</span>) &amp;&amp; (iin <span class="hljs-keyword">instanceof</span> com.example.mystudyapplication3.IRemoteService))) {<br>                <span class="hljs-keyword">return</span> ((com.example.mystudyapplication3.IRemoteService) iin);<br>            }<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.example.mystudyapplication3.IRemoteService.Stub.Proxy(obj);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> android.os.IBinder <span class="hljs-title function_">asBinder</span><span class="hljs-params">()</span> {<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTransact</span><span class="hljs-params">(<span class="hljs-type">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="hljs-type">int</span> flags)</span> <span class="hljs-keyword">throws</span> android.os.RemoteException {<br>            java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">descriptor</span> <span class="hljs-operator">=</span> DESCRIPTOR;<br>            <span class="hljs-keyword">switch</span> (code) {<br>                <span class="hljs-keyword">case</span> INTERFACE_TRANSACTION: {<br>                    reply.writeString(descriptor);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                }<br>                <span class="hljs-keyword">case</span> TRANSACTION_getUserId: {<br>                    data.enforceInterface(descriptor);<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">_result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserId();<br>                    reply.writeNoException();<br>                    reply.writeInt(_result);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                }<br>                <span class="hljs-keyword">default</span>: {<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTransact(code, data, reply, flags);<br>                }<br>            }<br>        }<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">com</span>.example.mystudyapplication3.IRemoteService {<br>            <span class="hljs-keyword">private</span> android.os.IBinder mRemote;<br><br>            Proxy(android.os.IBinder remote) {<br>                mRemote = remote;<br>            }<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> android.os.IBinder <span class="hljs-title function_">asBinder</span><span class="hljs-params">()</span> {<br>                <span class="hljs-keyword">return</span> mRemote;<br>            }<br><br>            <span class="hljs-keyword">public</span> java.lang.String <span class="hljs-title function_">getInterfaceDescriptor</span><span class="hljs-params">()</span> {<br>                <span class="hljs-keyword">return</span> DESCRIPTOR;<br>            }<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> android.os.RemoteException {<br>                android.os.<span class="hljs-type">Parcel</span> <span class="hljs-variable">_data</span> <span class="hljs-operator">=</span> android.os.Parcel.obtain();<br>                android.os.<span class="hljs-type">Parcel</span> <span class="hljs-variable">_reply</span> <span class="hljs-operator">=</span> android.os.Parcel.obtain();<br>                <span class="hljs-type">int</span> _result;<br>                <span class="hljs-keyword">try</span> {<br>                    _data.writeInterfaceToken(DESCRIPTOR);<br>                    mRemote.transact(Stub.TRANSACTION_getUserId, _data, _reply, <span class="hljs-number">0</span>);<br>                    _reply.readException();<br>                    _result = _reply.readInt();<br>                } <span class="hljs-keyword">finally</span> {<br>                    _reply.recycle();<br>                    _data.recycle();<br>                }<br>                <span class="hljs-keyword">return</span> _result;<br>            }<br>        }<br><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRANSACTION_getUserId</span> <span class="hljs-operator">=</span> (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="hljs-number">0</span>);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> android.os.RemoteException;<br>}<br></code></pre></td></tr></tbody></table></figure><table><thead><tr><th>方法</th><th>含义</th></tr></thead><tbody><tr><td>DESCRIPTOR</td><td>Binder 的唯一标识，一般用当前的 Binder 的类名表示</td></tr><tr><td>asInterface(IBinder obj)</td><td>将服务端的 Binder 对象成客户端所需的 AIDL 接口类型对象，这种转换过程是区分进程的，如果位于同一进程，返回的就是 Stub 对象本身，否则返回的是系统封装后的 Stub.proxy 对象。</td></tr><tr><td>asBinder</td><td>用于返回当前 Binder 对象</td></tr><tr><td>onTransact</td><td>运行在服务端中的 Binder 线程池中，远程请求会通过系统底层封装后交由此方法来处理</td></tr></tbody></table><table><thead><tr><th>定向 tag</th><th>含义</th></tr></thead><tbody><tr><td>in</td><td>数据只能由客户端流向服务端，服务端将会收到客户端对象的完整数据，客户端对象不会因为服务端对传参的修改而发生变动。</td></tr><tr><td>out</td><td>数据只能由服务端流向客户端，服务端将会收到客户端对象，该对象不为空，但是它里面的字段为空，但是在服务端对该对象作任何修改之后客户端的传参对象都会同步改动。</td></tr><tr><td>inout</td><td>服务端将会接收到客户端传来对象的完整信息，并且客户端将会同步服务端对该对象的任何变动。</td></tr></tbody></table><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p><img src="http://gityuan.com/images/binder/binder_start_service/binder_ipc_arch.jpg"></p><h2 id="AIDL-通信"><a href="#AIDL-通信" class="headerlink" title="AIDL 通信"></a>AIDL 通信</h2><p>Android Interface Definition Language</p><p>使用示例：</p><ul><li><strong>新建AIDL接口文件</strong></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RemoteService.aidl</span><br><span class="hljs-keyword">package</span> com.example.mystudyapplication3;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteService</span> {<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span>;<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>创建远程服务</strong></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mId</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Binder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IRemoteService</span>.Stub() {<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException {<br>            <span class="hljs-keyword">return</span> mId;<br>        }<br>    };<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> {<br>        mId = <span class="hljs-number">1256</span>;<br>        <span class="hljs-keyword">return</span> binder;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>声明远程服务</strong></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;service<br>    android:name=<span class="hljs-string">".RemoteService"</span><br>            android:process=<span class="hljs-string">":aidl"</span>/&gt;<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>绑定远程服务</strong></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"wzq"</span>;<br><br>    IRemoteService iRemoteService;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> {<br>            iRemoteService = IRemoteService.Stub.asInterface(service);<br>            <span class="hljs-keyword">try</span> {<br>                Log.d(TAG, String.valueOf(iRemoteService.getUserId()));<br>            } <span class="hljs-keyword">catch</span> (RemoteException e) {<br>                e.printStackTrace();<br>            }<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName name)</span> {<br>            iRemoteService = <span class="hljs-literal">null</span>;<br>        }<br>    };<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        bindService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(MainActivity.<span class="hljs-built_in">this</span>, RemoteService.class), mConnection, Context.BIND_AUTO_CREATE);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="Messenger"><a href="#Messenger" class="headerlink" title="Messenger"></a>Messenger</h2><p>Messenger可以在不同进程中传递 Message 对象，在Message中放入我们需要传递的数据，就可以轻松地实现数据的进程间传递了。Messenger<br>是一种轻量级的 IPC 方案，底层实现是 AIDL。</p><h1 id="Window-WindowManager"><a href="#Window-WindowManager" class="headerlink" title="Window / WindowManager"></a>Window / WindowManager</h1><h2 id="Window-概念与分类"><a href="#Window-概念与分类" class="headerlink" title="Window 概念与分类"></a>Window 概念与分类</h2><p>Window 是一个抽象类，它的具体实现是 PhoneWindow。WindowManager 是外界访问 Window 的入口，Window 的具体实现位于<br>WindowManagerService 中，WindowManager 和 WindowManagerService 的交互是一个 IPC 过程。Android 中所有的视图都是通过 Window<br>来呈现，因此 Window 实际是 View 的直接管理者。</p><table><thead><tr><th>Window 类型</th><th>说明</th><th>层级</th></tr></thead><tbody><tr><td>Application Window</td><td>对应着一个 Activity</td><td>1~99</td></tr><tr><td>Sub Window</td><td>不能单独存在，只能附属在父 Window 中，如 Dialog 等</td><td>1000~1999</td></tr><tr><td>System Window</td><td>需要权限声明，如 Toast 和 系统状态栏等</td><td>2000~2999</td></tr></tbody></table><h2 id="Window-的内部机制"><a href="#Window-的内部机制" class="headerlink" title="Window 的内部机制"></a>Window 的内部机制</h2><p>Window 是一个抽象的概念，每一个 Window 对应着一个 View 和一个 ViewRootImpl。Window 实际是不存在的，它是以 View 的形式存在。对<br>Window 的访问必须通过 WindowManager，WindowManager 的实现类是 WindowManagerImpl：</p><p><code>WindowManagerImpl.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view,<span class="hljs-meta">@NonNull</span> ViewGroup.LayoutParams params)</span>{<br>        applyDefaultToken(params);<br>        mGlobal.addView(view,params,mContext.getDisplay(),mParentWindow);<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view,<span class="hljs-meta">@NonNull</span> ViewGroup.LayoutParams params)</span>{<br>        applyDefaultToken(params);<br>        mGlobal.updateViewLayout(view,params);<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view)</span>{<br>        mGlobal.removeView(view,<span class="hljs-literal">false</span>);<br>        }<br></code></pre></td></tr></tbody></table></figure><p>WindowManagerImpl 没有直接实现 Window 的三大操作，而是全部交给 WindowManagerGlobal 处理，WindowManagerGlobal<br>以工厂的形式向外提供自己的实例：</p><p><code>WindowManagerGlobal.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 添加</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view,ViewGroup.LayoutParams params,</span><br><span class="hljs-params">        Display display,Window parentWindow)</span>{<br>        ···<br><span class="hljs-comment">// 子 Window 的话需要调整一些布局参数</span><br><span class="hljs-keyword">final</span> WindowManager.LayoutParams wparams=(WindowManager.LayoutParams)params;<br>        <span class="hljs-keyword">if</span>(parentWindow!=<span class="hljs-literal">null</span>){<br>        parentWindow.adjustLayoutParamsForSubWindow(wparams);<br>        }<span class="hljs-keyword">else</span>{<br>        ···<br>        }<br>        ViewRootImpl root;<br>        View panelParentView=<span class="hljs-literal">null</span>;<br><span class="hljs-keyword">synchronized</span> (mLock){<br>        <span class="hljs-comment">// 新建一个 ViewRootImpl，并通过其 setView 来更新界面完成 Window 的添加过程</span><br>        ···<br>        root=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(),display);<br>        view.setLayoutParams(wparams);<br>        mViews.add(view);<br>        mRoots.add(root);<br>        mParams.add(wparams);<br>        <span class="hljs-comment">// do this last because it fires off messages to start doing things</span><br>        <span class="hljs-keyword">try</span>{<br>        root.setView(view,wparams,panelParentView);<br>        }<span class="hljs-keyword">catch</span>(RuntimeException e){<br>        <span class="hljs-comment">// BadTokenException or InvalidDisplayException, clean up.</span><br>        <span class="hljs-keyword">if</span>(index&gt;=<span class="hljs-number">0</span>){<br>        removeViewLocked(index,<span class="hljs-literal">true</span>);<br>        }<br>        <span class="hljs-keyword">throw</span> e;<br>        }<br>        }<br>        }<br><br><span class="hljs-comment">// 删除</span><br><span class="hljs-meta">@UnsupportedAppUsage</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view,<span class="hljs-type">boolean</span> immediate)</span>{<br>        ···<br><span class="hljs-keyword">synchronized</span> (mLock){<br>        <span class="hljs-type">int</span> index=findViewLocked(view,<span class="hljs-literal">true</span>);<br>        View curView=mRoots.get(index).getView();<br>        removeViewLocked(index,immediate);<br>        ···<br>        }<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeViewLocked</span><span class="hljs-params">(<span class="hljs-type">int</span> index,<span class="hljs-type">boolean</span> immediate)</span>{<br>        ViewRootImpl root=mRoots.get(index);<br>        View view=root.getView();<br>        <span class="hljs-keyword">if</span>(view!=<span class="hljs-literal">null</span>){<br>        InputMethodManager imm=InputMethodManager.getInstance();<br>        <span class="hljs-keyword">if</span>(imm!=<span class="hljs-literal">null</span>){<br>        imm.windowDismissed(mViews.get(index).getWindowToken());<br>        }<br>        }<br>        <span class="hljs-type">boolean</span> deferred=root.die(immediate);<br>        <span class="hljs-keyword">if</span>(view!=<span class="hljs-literal">null</span>){<br>        view.assignParent(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span>(deferred){<br>        mDyingViews.add(view);<br>        }<br>        }<br>        }<br><br><span class="hljs-comment">// 更新</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(View view,ViewGroup.LayoutParams params)</span>{<br>        ···<br><span class="hljs-keyword">final</span> WindowManager.LayoutParams wparams=(WindowManager.LayoutParams)params;<br>        view.setLayoutParams(wparams);<br><span class="hljs-keyword">synchronized</span> (mLock){<br>        <span class="hljs-type">int</span> index=findViewLocked(view,<span class="hljs-literal">true</span>);<br>        ViewRootImpl root=mRoots.get(index);<br>        mParams.remove(index);<br>        mParams.add(index,wparams);<br>        root.setLayoutParams(wparams,<span class="hljs-literal">false</span>);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><p>在 ViewRootImpl 中最终会通过 WindowSession 来完成 Window 的添加、更新、删除工作，mWindowSession 的类型是 IWindowSession，是一个<br>Binder 对象，真正地实现类是 Session，是一个 IPC 过程。</p><h2 id="Window-的创建过程"><a href="#Window-的创建过程" class="headerlink" title="Window 的创建过程"></a>Window 的创建过程</h2><h3 id="Activity-的-Window-创建过程"><a href="#Activity-的-Window-创建过程" class="headerlink" title="Activity 的 Window 创建过程"></a>Activity 的 Window 创建过程</h3><p>在 Activity 的创建过程中，最终会由 ActivityThread 的 performLaunchActivity() 来完成整个启动过程，该方法内部会通过类加载器创建<br>Activity 的实例对象，并调用 attach 方法关联一系列上下文环境变量。在 Activity 的 attach 方法里，系统会创建所属的 Window<br>对象并设置回调接口，然后在 Activity 的 setContentView 方法中将视图附属在 Window 上：</p><p><code>Activity.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Context context,ActivityThread aThread,</span><br><span class="hljs-params">        Instrumentation instr,IBinder token,<span class="hljs-type">int</span> ident,</span><br><span class="hljs-params">        Application application,Intent intent,ActivityInfo info,</span><br><span class="hljs-params">        CharSequence title,Activity parent,String id,</span><br><span class="hljs-params">        NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="hljs-params">        Configuration config,String referrer,IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">        Window window,ActivityConfigCallback activityConfigCallback)</span>{<br>        attachBaseContext(context);<br><br>        mFragments.attachHost(<span class="hljs-literal">null</span> <span class="hljs-comment">/*parent*/</span>);<br><br>        mWindow=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>,window,activityConfigCallback);<br>        mWindow.setWindowControllerCallback(<span class="hljs-built_in">this</span>);<br>        mWindow.setCallback(<span class="hljs-built_in">this</span>);<br>        mWindow.setOnWindowDismissedCallback(<span class="hljs-built_in">this</span>);<br>        mWindow.getLayoutInflater().setPrivateFactory(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span>(info.softInputMode!=WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED){<br>        mWindow.setSoftInputMode(info.softInputMode);<br>        }<br>        <span class="hljs-keyword">if</span>(info.uiOptions!=<span class="hljs-number">0</span>){<br>        mWindow.setUiOptions(info.uiOptions);<br>        }<br>        ···<br>        }<br>        ···<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span>{<br>        getWindow().setContentView(layoutResID);<br>        initWindowDecorActionBar();<br>        }<br><br></code></pre></td></tr></tbody></table></figure><p><code>PhoneWindow.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-type">int</span> layoutResID)</span>{<br>        <span class="hljs-keyword">if</span>(mContentParent==<span class="hljs-literal">null</span>){ <span class="hljs-comment">// 如果没有 DecorView，就创建</span><br>        installDecor();<br>        }<span class="hljs-keyword">else</span>{<br>        mContentParent.removeAllViews();<br>        }<br>        mLayoutInflater.inflate(layoutResID,mContentParent);<br><span class="hljs-keyword">final</span> Callback cb=getCallback();<br>        <span class="hljs-keyword">if</span>(cb!=<span class="hljs-literal">null</span>&amp;&amp;!isDestroyed()){<br>        <span class="hljs-comment">// 回调 Activity 的 onContentChanged 方法通知 Activity 视图已经发生改变</span><br>        cb.onContentChanged();<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><p>这个时候 DecorView 还没有被 WindowManager 正式添加。在 ActivityThread 的 handleResumeActivity 方法中，首先会调用 Activity<br>的 onResume 方法，接着调用 Activity 的 makeVisible()，完成 DecorView 的添加和显示过程：</p><p><code>Activity.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">makeVisible</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">if</span>(!mWindowAdded){<br>        ViewManager wm=getWindowManager();<br>        wm.addView(mDecor,getWindow().getAttributes());<br>        mWindowAdded=<span class="hljs-literal">true</span>;<br>        }<br>        mDecor.setVisibility(View.VISIBLE);<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="Dialog-的-Window-创建过程"><a href="#Dialog-的-Window-创建过程" class="headerlink" title="Dialog 的 Window 创建过程"></a>Dialog 的 Window 创建过程</h3><p>Dialog 的 Window 的创建过程和 Activity 类似，创建同样是通过 PolicyManager 的 makeNewWindow 方法完成的，创建后的对象实际就是<br>PhoneWindow。当 Dialog 被关闭时，会通过 WindowManager 来移除 DecorView：mWindowManager.removeViewImmediate(mDecor)。</p><p><code>Dialog.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">Dialog(<span class="hljs-meta">@NonNull</span> Context context,<span class="hljs-meta">@StyleRes</span> <span class="hljs-type">int</span> themeResId,<span class="hljs-type">boolean</span> createContextThemeWrapper){<br>        ···<br>        mWindowManager=(WindowManager)context.getSystemService(Context.WINDOW_SERVICE);<br><br><span class="hljs-keyword">final</span> Window w=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(mContext);<br>        mWindow=w;<br>        w.setCallback(<span class="hljs-built_in">this</span>);<br>        w.setOnWindowDismissedCallback(<span class="hljs-built_in">this</span>);<br>        w.setOnWindowSwipeDismissedCallback(()-&gt;{<br>        <span class="hljs-keyword">if</span>(mCancelable){<br>        cancel();<br>        }<br>        });<br>        w.setWindowManager(mWindowManager,<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);<br>        w.setGravity(Gravity.CENTER);<br><br>        mListenersHandler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListenersHandler</span>(<span class="hljs-built_in">this</span>);<br>        }<br></code></pre></td></tr></tbody></table></figure><p>普通 Dialog 必须采用 Activity 的 Context，采用 Application 的 Context 就会报错，是因为应用 token 所导致，应用 token 一般只有<br>Activity 拥有。系统 Window 比较特殊，不需要 token。</p><h3 id="Toast-的-Window-创建过程"><a href="#Toast-的-Window-创建过程" class="headerlink" title="Toast 的 Window 创建过程"></a>Toast 的 Window 创建过程</h3><p>Toast 属于系统 Window ，由于其具有定时取消功能，所以系统采用了 Handler。Toast 的内部有两类 IPC 过程，第一类是 Toast 访问<br>NotificationManagerService，第二类是 NotificationManagerService 回调 Toast 里的 TN 接口。</p><p>Toast 内部的视图由两种方式，一种是系统默认的样式，另一种是 setView 指定一个自定义 View，它们都对应 Toast 的一个内部成员<br>mNextView。</p><p><code>Toast.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">if</span>(mNextView==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"setView must have been called"</span>);<br>        }<br><br>        INotificationManager service=getService();<br>        String pkg=mContext.getOpPackageName();<br>        TN tn=mTN;<br>        tn.mNextView=mNextView;<br><br>        <span class="hljs-keyword">try</span>{<br>        service.enqueueToast(pkg,tn,mDuration);<br>        }<span class="hljs-keyword">catch</span>(RemoteException e){<br>        <span class="hljs-comment">// Empty</span><br>        }<br>        }<br>        ···<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>{<br>        mTN.cancel();<br>        }<br><br></code></pre></td></tr></tbody></table></figure><p><code>NotificationManagerService.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showNextToastLocked</span><span class="hljs-params">()</span>{<br>        ToastRecord record=mToastQueue.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">while</span>(record!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">if</span>(DBG)Slog.d(TAG,<span class="hljs-string">"Show pkg="</span>+record.pkg+<span class="hljs-string">" callback="</span>+record.callback);<br>        <span class="hljs-keyword">try</span>{<br>        record.callback.show();<br>        scheduleTimeoutLocked(record,<span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">return</span>;<br>        }<span class="hljs-keyword">catch</span>(RemoteException e){<br>        Slog.w(TAG,<span class="hljs-string">"Object died trying to show notification "</span>+record.callback<br>        +<span class="hljs-string">" in package "</span>+record.pkg);<br>        <span class="hljs-comment">// remove it from the list and let the process die</span><br>        <span class="hljs-type">int</span> index=mToastQueue.indexOf(record);<br>        <span class="hljs-keyword">if</span>(index&gt;=<span class="hljs-number">0</span>){<br>        mToastQueue.remove(index);<br>        }<br>        keepProcessAliveLocked(record.pid);<br>        <span class="hljs-keyword">if</span>(mToastQueue.size()&gt;<span class="hljs-number">0</span>){<br>        record=mToastQueue.get(<span class="hljs-number">0</span>);<br>        }<span class="hljs-keyword">else</span>{<br>        record=<span class="hljs-literal">null</span>;<br>        }<br>        }<br>        }<br>        }<br><br>        ···<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTimeoutLocked</span><span class="hljs-params">(ToastRecord r,<span class="hljs-type">boolean</span> immediate)</span><br>        {<br>        Message m=Message.obtain(mHandler,MESSAGE_TIMEOUT,r);<br>        <span class="hljs-type">long</span> delay=immediate?<span class="hljs-number">0</span>:(r.duration==Toast.LENGTH_LONG?LONG_DELAY:SHORT_DELAY);<br>        mHandler.removeCallbacksAndMessages(r);<br>        mHandler.sendMessageDelayed(m,delay);<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h1><p><img src="https://upload-images.jianshu.io/upload_images/2618044-cd996dd172cce293.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp"></p><h2 id="配置信息与压缩方式"><a href="#配置信息与压缩方式" class="headerlink" title="配置信息与压缩方式"></a>配置信息与压缩方式</h2><p><strong>Bitmap 中有两个内部枚举类：</strong></p><ul><li>Config 是用来设置颜色配置信息</li><li>CompressFormat 是用来设置压缩方式</li></ul><table><thead><tr><th>Config</th><th>单位像素所占字节数</th><th>解析</th></tr></thead><tbody><tr><td>Bitmap.Config.ALPHA_8</td><td>1</td><td>颜色信息只由透明度组成，占8位</td></tr><tr><td>Bitmap.Config.ARGB_4444</td><td>2</td><td>颜色信息由rgba四部分组成，每个部分都占4位，总共占16位</td></tr><tr><td>Bitmap.Config.ARGB_8888</td><td>4</td><td>颜色信息由rgba四部分组成，每个部分都占8位，总共占32位。是Bitmap默认的颜色配置信息，也是最占空间的一种配置</td></tr><tr><td>Bitmap.Config.RGB_565</td><td>2</td><td>颜色信息由rgb三部分组成，R占5位，G占6位，B占5位，总共占16位</td></tr><tr><td>RGBA_F16</td><td>8</td><td>Android 8.0 新增（更丰富的色彩表现HDR）</td></tr><tr><td>HARDWARE</td><td>Special</td><td>Android 8.0 新增 （Bitmap直接存储在graphic memory）</td></tr></tbody></table><blockquote><p>通常我们优化 Bitmap 时，当需要做性能优化或者防止 OOM，我们通常会使用 Bitmap.Config.RGB_565 这个配置，因为<br>Bitmap.Config.ALPHA_8 只有透明度，显示一般图片没有意义，Bitmap.Config.ARGB_4444 显示图片不清楚， Bitmap.Config.ARGB_8888<br>占用内存最多。</p></blockquote><table><thead><tr><th>CompressFormat</th><th>解析</th></tr></thead><tbody><tr><td>Bitmap.CompressFormat.JPEG</td><td>表示以 JPEG 压缩算法进行图像压缩，压缩后的格式可以是 <code>.jpg</code> 或者 <code>.jpeg</code>，是一种有损压缩</td></tr><tr><td>Bitmap.CompressFormat.PNG</td><td>颜色信息由 rgba 四部分组成，每个部分都占 4 位，总共占 16 位</td></tr><tr><td>Bitmap.Config.ARGB_8888</td><td>颜色信息由 rgba 四部分组成，每个部分都占 8 位，总共占 32 位。是 Bitmap 默认的颜色配置信息，也是最占空间的一种配置</td></tr><tr><td>Bitmap.Config.RGB_565</td><td>颜色信息由 rgb 三部分组成，R 占 5 位，G 占 6 位，B 占 5 位，总共占 16 位</td></tr></tbody></table><h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><h3 id="裁剪、缩放、旋转、移动"><a href="#裁剪、缩放、旋转、移动" class="headerlink" title="裁剪、缩放、旋转、移动"></a>裁剪、缩放、旋转、移动</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">Matrix matrix=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Matrix</span>();<br><span class="hljs-comment">// 缩放 </span><br>        matrix.postScale(<span class="hljs-number">0.8f</span>,<span class="hljs-number">0.9f</span>);<br><span class="hljs-comment">// 左旋，参数为正则向右旋</span><br>        matrix.postRotate(-<span class="hljs-number">45</span>);<br><span class="hljs-comment">// 平移, 在上一次修改的基础上进行再次修改 set 每次操作都是最新的 会覆盖上次的操作</span><br>        matrix.postTranslate(<span class="hljs-number">100</span>,<span class="hljs-number">80</span>);<br><span class="hljs-comment">// 裁剪并执行以上操作</span><br>        Bitmap bitmap=Bitmap.createBitmap(source,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,source.getWidth(),source.getHeight(),matrix,<span class="hljs-literal">true</span>);<br>````<br><br>&gt; 虽然Matrix还可以调用postSkew方法进行倾斜操作，但是却不可以在此时创建Bitmap时使用。<br><br>### Bitmap与Drawable转换<br><br>```java<br><span class="hljs-comment">// Drawable -&gt; Bitmap</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">drawableToBitmap</span><span class="hljs-params">(Drawable drawable)</span>{<br>        Bitmap bitmap=Bitmap.createBitmap(drawable.getIntrinsicWidth(),drawable.getIntrinsicHeight(),drawable.getOpacity()!=PixelFormat.OPAQUE?Bitmap.Config.ARGB_8888:Bitmap.Config.RGB_565);<br>        Canvas canvas=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Canvas</span>(bitmap);<br>        drawable.setBounds(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,drawable.getIntrinsicWidth(),drawable.getIntrinsicHeight();<br>        drawable.draw(canvas);<br>        <span class="hljs-keyword">return</span> bitmap;<br>        }<br><br><span class="hljs-comment">// Bitmap -&gt; Drawable</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Drawable <span class="hljs-title function_">bitmapToDrawable</span><span class="hljs-params">(Resources resources,Bitmap bm)</span>{<br>        Drawable drawable=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapDrawable</span>(resources,bm);<br>        <span class="hljs-keyword">return</span> drawable;<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="保存与释放"><a href="#保存与释放" class="headerlink" title="保存与释放"></a>保存与释放</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Bitmap bitmap=BitmapFactory.decodeResource(getResources(),R.drawable.test);<br>        File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getFilesDir(),<span class="hljs-string">"test.jpg"</span>);<br>        <span class="hljs-keyword">if</span>(file.exists()){<br>        file.delete();<br>        }<br>        <span class="hljs-keyword">try</span>{<br>        FileOutputStream outputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>        bitmap.compress(Bitmap.CompressFormat.JPEG,<span class="hljs-number">90</span>,outputStream);<br>        outputStream.flush();<br>        outputStream.close();<br>        }<span class="hljs-keyword">catch</span>(FileNotFoundException e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">catch</span>(IOException e){<br>        e.printStackTrace();<br>        }<br><span class="hljs-comment">//释放bitmap的资源，这是一个不可逆转的操作</span><br>        bitmap.recycle();<br></code></pre></td></tr></tbody></table></figure><h3 id="图片压缩"><a href="#图片压缩" class="headerlink" title="图片压缩"></a>图片压缩</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">compressImage</span><span class="hljs-params">(Bitmap image)</span>{<br>        <span class="hljs-keyword">if</span>(image==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        ByteArrayOutputStream baos=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>        baos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        image.compress(Bitmap.CompressFormat.JPEG,<span class="hljs-number">100</span>,baos);<br>        <span class="hljs-type">byte</span>[]bytes=baos.toByteArray();<br>        ByteArrayInputStream isBm=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        Bitmap bitmap=BitmapFactory.decodeStream(isBm);<br>        <span class="hljs-keyword">return</span> bitmap;<br>        }<span class="hljs-keyword">catch</span>(OutOfMemoryError e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span>{<br>        <span class="hljs-keyword">try</span>{<br>        <span class="hljs-keyword">if</span>(baos!=<span class="hljs-literal">null</span>){<br>        baos.close();<br>        }<br>        }<span class="hljs-keyword">catch</span>(IOException e){<br>        e.printStackTrace();<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="BitmapFactory"><a href="#BitmapFactory" class="headerlink" title="BitmapFactory"></a>BitmapFactory</h2><h3 id="Bitmap创建流程"><a href="#Bitmap创建流程" class="headerlink" title="Bitmap创建流程"></a>Bitmap创建流程</h3><p><img src="https://upload-images.jianshu.io/upload_images/2618044-9c2046ca5054da05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp"></p><h3 id="Option类"><a href="#Option类" class="headerlink" title="Option类"></a>Option类</h3><table><thead><tr><th>常用方法</th><th>说明</th></tr></thead><tbody><tr><td>boolean inJustDecodeBounds</td><td>如果设置为true，不获取图片，不分配内存，但会返回图片的高度宽度信息</td></tr><tr><td>int inSampleSize</td><td>图片缩放的倍数</td></tr><tr><td>int outWidth</td><td>获取图片的宽度值</td></tr><tr><td>int outHeight</td><td>获取图片的高度值</td></tr><tr><td>int inDensity</td><td>用于位图的像素压缩比</td></tr><tr><td>int inTargetDensity</td><td>用于目标位图的像素压缩比（要生成的位图）</td></tr><tr><td>byte[] inTempStorage</td><td>创建临时文件，将图片存储</td></tr><tr><td>boolean inScaled</td><td>设置为true时进行图片压缩，从inDensity到inTargetDensity</td></tr><tr><td>boolean inDither</td><td>如果为true,解码器尝试抖动解码</td></tr><tr><td>Bitmap.Config inPreferredConfig</td><td>设置解码器这个值是设置色彩模式，默认值是ARGB_8888，在这个模式下，一个像素点占用4bytes空间，一般对透明度不做要求的话，一般采用RGB_565模式，这个模式下一个像素点占用2bytes</td></tr><tr><td>String outMimeType</td><td>设置解码图像</td></tr><tr><td>boolean inPurgeable</td><td>当存储Pixel的内存空间在系统内存不足时是否可以被回收</td></tr><tr><td>boolean inInputShareable</td><td>inPurgeable为true情况下才生效，是否可以共享一个InputStream</td></tr><tr><td>boolean inPreferQualityOverSpeed</td><td>为true则优先保证Bitmap质量其次是解码速度</td></tr><tr><td>boolean inMutable</td><td>配置Bitmap是否可以更改，比如：在Bitmap上隔几个像素加一条线段</td></tr><tr><td>int inScreenDensity</td><td>当前屏幕的像素密度</td></tr></tbody></table><h3 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>{<br>        FileInputStream fis=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filePath);<br>        BitmapFactory.Options options=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapFactory</span>.Options();<br>        options.inJustDecodeBounds=<span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">// 设置inJustDecodeBounds为true后，再使用decodeFile()等方法，并不会真正的分配空间，即解码出来的Bitmap为null，但是可计算出原始图片的宽度和高度，即options.outWidth和options.outHeight</span><br>        BitmapFactory.decodeFileDescriptor(fis.getFD(),<span class="hljs-literal">null</span>,options);<br>        <span class="hljs-type">float</span> srcWidth=options.outWidth;<br>        <span class="hljs-type">float</span> srcHeight=options.outHeight;<br>        <span class="hljs-type">int</span> inSampleSize=<span class="hljs-number">1</span>;<br><br>        <span class="hljs-keyword">if</span>(srcHeight&gt;height||srcWidth&gt;width){<br>        <span class="hljs-keyword">if</span>(srcWidth&gt;srcHeight){<br>        inSampleSize=Math.round(srcHeight/height);<br>        }<span class="hljs-keyword">else</span>{<br>        inSampleSize=Math.round(srcWidth/width);<br>        }<br>        }<br><br>        options.inJustDecodeBounds=<span class="hljs-literal">false</span>;<br>        options.inSampleSize=inSampleSize;<br><br>        <span class="hljs-keyword">return</span> BitmapFactory.decodeFileDescriptor(fis.getFD(),<span class="hljs-literal">null</span>,options);<br>        }<span class="hljs-keyword">catch</span>(Exception e){<br>        e.printStackTrace();<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(bitmap!=<span class="hljs-literal">null</span>&amp;&amp;!bitmap.isRecycled()){<br>        <span class="hljs-comment">// 回收并且置为null</span><br>        bitmap.recycle();<br>        bitmap=<span class="hljs-literal">null</span>;<br>        } <br></code></pre></td></tr></tbody></table></figure><p>Bitmap 类的构造方法都是私有的，所以开发者不能直接 new 出一个 Bitmap 对象，只能通过 BitmapFactory 类的各种静态方法来实例化一个<br>Bitmap。仔细查看 BitmapFactory 的源代码可以看到，生成 Bitmap 对象最终都是通过 JNI 调用方式实现的。所以，加载 Bitmap<br>到内存里以后，是包含两部分内存区域的。简单的说，一部分是Java 部分的，一部分是 C 部分的。这个 Bitmap 对象是由 Java<br>部分分配的，不用的时候系统就会自动回收了，但是那个对应的 C 可用的内存区域，虚拟机是不能直接回收的，这个只能调用底层的功能释放。所以需要调用<br>recycle() 方法来释放 C 部分的内存。从 Bitmap 类的源代码也可以看到，recycle() 方法里也的确是调用了 JNI 方法了的。</p><h1 id="屏幕适配"><a href="#屏幕适配" class="headerlink" title="屏幕适配"></a>屏幕适配</h1><h2 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h2><ul><li><p>dpi<br>每英寸像素数(dot per inch)</p></li><li><p>dp<br>密度无关像素 - 一种基于屏幕物理密度的抽象单元。 这些单位相对于 160 dpi 的屏幕，因此一个 dp 是 160 dpi 屏幕上的一个 px。<br>dp 与像素的比率将随着屏幕密度而变化，但不一定成正比。为不同设备的 UI 元素的实际大小提供了一致性。</p></li><li><p>sp<br>与比例无关的像素 - 这与 dp 单位类似，但它也可以通过用户的字体大小首选项进行缩放。建议在指定字体大小时使用此单位，以便根据屏幕密度和用户偏好调整它们。</p></li></ul><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">dpi</span> <span class="hljs-operator">=</span> px / inch<br><br><span class="hljs-attribute">density</span> <span class="hljs-operator">=</span> dpi / <span class="hljs-number">160</span><br><br><span class="hljs-attribute">dp</span> <span class="hljs-operator">=</span> px / density<br></code></pre></td></tr></tbody></table></figure><h2 id="头条适配方案"><a href="#头条适配方案" class="headerlink" title="头条适配方案"></a>头条适配方案</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCustomDensity</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Activity activity,<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> Application application)</span>{<br><span class="hljs-keyword">final</span> DisplayMetrics appDisplayMetrics=application.getResources().getDisplayMetrics();<br>        <span class="hljs-keyword">if</span>(sNoncompatDensity==<span class="hljs-number">0</span>){<br>        sNoncompatDensity=appDisplayMetrics.density;<br>        sNoncompatScaledDensity=appDisplayMetrics.scaledDensity;<br>        <span class="hljs-comment">// 监听字体切换</span><br>        application.registerComponentCallbacks(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentCallbacks</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onConfigurationChanged</span><span class="hljs-params">(Configuration newConfig)</span>{<br>        <span class="hljs-keyword">if</span>(newConfig!=<span class="hljs-literal">null</span>&amp;&amp;newConfig.fontScale&gt;<span class="hljs-number">0</span>){<br>        sNoncompatScaledDensity=application.getResources().getDisplayMetrics().scaledDensity;<br>        }<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLowMemory</span><span class="hljs-params">()</span>{<br><br>        }<br>        });<br>        }<br><br><span class="hljs-comment">// 适配后的dpi将统一为360dpi</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">float</span> targetDensity=appDisplayMetrics.widthPixels/<span class="hljs-number">360</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-type">float</span> targetScaledDensity=targetDensity*(sNoncompatScaledDensity/sNoncompatDensity);<br><span class="hljs-keyword">final</span> <span class="hljs-type">int</span> targetDensityDpi=(<span class="hljs-type">int</span>)(<span class="hljs-number">160</span>*targetDensity);<br><br>        appDisplayMetrics.density=targetDensity;<br>        appDisplayMetrics.scaledDensity=targetScaledDensity;<br>        appDisplayMetrics.densityDpi=targetDensityDpi;<br><br><span class="hljs-keyword">final</span> DisplayMetrics activityDisplayMetrics=activity.getResources().getDisplayMetrics();<br>        activityDisplayMetrics.density=targetDensity;<br>        activityDisplayMetrics.scaledDensity=targetScaledDensity;<br>        activityDisplayMetrics.densityDpi=targetDensityDpi<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="刘海屏适配"><a href="#刘海屏适配" class="headerlink" title="刘海屏适配"></a>刘海屏适配</h2><ul><li>Android P 刘海屏适配方案</li></ul><p>Android P 支持最新的全面屏以及为摄像头和扬声器预留空间的凹口屏幕。通过全新的 DisplayCutout<br>类，可以确定非功能区域的位置和形状，这些区域不应显示内容。要确定这些凹口屏幕区域是否存在及其位置，使用 getDisplayCutout()<br>函数。</p><table><thead><tr><th>DisplayCutout 类方法</th><th>说明</th></tr></thead><tbody><tr><td>getBoundingRects()</td><td>返回Rects的列表，每个Rects都是显示屏上非功能区域的边界矩形</td></tr><tr><td>getSafeInsetLeft ()</td><td>返回安全区域距离屏幕左边的距离，单位是px</td></tr><tr><td>getSafeInsetRight ()</td><td>返回安全区域距离屏幕右边的距离，单位是px</td></tr><tr><td>getSafeInsetTop ()</td><td>返回安全区域距离屏幕顶部的距离，单位是px</td></tr><tr><td>getSafeInsetBottom()</td><td>返回安全区域距离屏幕底部的距离，单位是px</td></tr></tbody></table><p>Android P 中 WindowManager.LayoutParams 新增了一个布局参数属性 layoutInDisplayCutoutMode：</p><table><thead><tr><th>模式</th><th>模式说明</th></tr></thead><tbody><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT</td><td>只有当DisplayCutout完全包含在系统栏中时，才允许窗口延伸到DisplayCutout区域。 否则，窗口布局不与DisplayCutout区域重叠。</td></tr><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER</td><td>该窗口决不允许与DisplayCutout区域重叠。</td></tr><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES</td><td>该窗口始终允许延伸到屏幕短边上的DisplayCutout区域。</td></tr></tbody></table><ul><li>Android P 之前的刘海屏适配</li></ul><p>不同厂商的刘海屏适配方案不尽相同，需分别查阅各自的开发者文档。</p><h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><p>Context 本身是一个抽象类，是对一系列系统服务接口的封装，包括：内部资源、包、类加载、I/O操作、权限、主线程、IPC<br>和组件启动等操作的管理。ContextImpl, Activity, Service, Application 这些都是 Context 的直接或间接子类, 关系如下:</p><p><img src="http://gityuan.com/images/context/context.jpg"></p><p>ContextWrapper是代理Context的实现，简单地将其所有调用委托给另一个Context（mBase）。</p><p>Application、Activity、Service通过<code>attach() </code>调用父类ContextWrapper的<code>attachBaseContext()</code>, 从而设置父类成员变量 mBase<br>为 ContextImpl 对象, ContextWrapper 的核心工作都是交给 mBase(ContextImpl) 来完成，这样可以子类化 Context 以修改行为而无需更改原始<br>Context。</p><h1 id="SharedPreferences"><a href="#SharedPreferences" class="headerlink" title="SharedPreferences"></a>SharedPreferences</h1><p>SharedPreferences 采用key-value（键值对）形式, 主要用于轻量级的数据存储, 尤其适合保存应用的配置参数, 但不建议使用<br>SharedPreferences 来存储大规模的数据, 可能会降低性能.</p><p>SharedPreferences采用xml文件格式来保存数据, 该文件所在目录位于 <code>/data/data/&lt;package name&gt;/shared_prefs</code>，如：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"blog"</span>&gt;</span>https://github.com/JasonWu1111/Android-Review<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>从Android N开始, 创建的 SP 文件模式, 不允许 <code>MODE_WORLD_READABLE</code> 和 <code>MODE_WORLD_WRITEABLE</code> 模块, 否则会直接抛出异常<br>SecurityException。 <code>MODE_MULTI_PROCESS</code> 这种多进程的方式也是 Google 不推荐的方式, 后续同样会不再支持。</p><p>当设置 MODE_MULTI_PROCESS 模式, 则每次 getSharedPreferences 过程, 会检查 SP 文件上次修改时间和文件大小,<br>一旦所有修改则会重新从磁盘加载文件。</p><h2 id="获取方式"><a href="#获取方式" class="headerlink" title="获取方式"></a>获取方式</h2><h3 id="getPreferences"><a href="#getPreferences" class="headerlink" title="getPreferences"></a>getPreferences</h3><p>Activity.getPreferences(mode): 以当前 Activity 的类名作为 SP 的文件名. 即 xxxActivity.xml<br><code>Activity.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> SharedPreferences <span class="hljs-title function_">getPreferences</span><span class="hljs-params">(<span class="hljs-type">int</span> mode)</span>{<br>        <span class="hljs-keyword">return</span> getSharedPreferences(getLocalClassName(),mode);<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="getDefaultSharedPreferences"><a href="#getDefaultSharedPreferences" class="headerlink" title="getDefaultSharedPreferences"></a>getDefaultSharedPreferences</h3><p>PreferenceManager.getDefaultSharedPreferences(Context): 以包名加上 _preferences 作为文件名, 以 MODE_PRIVATE 模式创建 SP<br>文件. 即 packgeName_preferences.xml.</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SharedPreferences <span class="hljs-title function_">getDefaultSharedPreferences</span><span class="hljs-params">(Context context)</span>{<br>        <span class="hljs-keyword">return</span> context.getSharedPreferences(getDefaultSharedPreferencesName(context),<br>        getDefaultSharedPreferencesMode());<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="getSharedPreferences"><a href="#getSharedPreferences" class="headerlink" title="getSharedPreferences"></a>getSharedPreferences</h3><p>直接调用 Context.getSharedPreferences(name, mode)，所有的方法最终都是调用到如下方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Context</span> {<br>    <span class="hljs-keyword">private</span> ArrayMap&lt;String, File&gt; mSharedPrefsPaths;<br><br>    <span class="hljs-keyword">public</span> SharedPreferences <span class="hljs-title function_">getSharedPreferences</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> mode)</span> {<br>        File file;<br>        <span class="hljs-keyword">synchronized</span> (ContextImpl.class) {<br>            <span class="hljs-keyword">if</span> (mSharedPrefsPaths == <span class="hljs-literal">null</span>) {<br>                mSharedPrefsPaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;();<br>            }<br>            <span class="hljs-comment">//先从mSharedPrefsPaths查询是否存在相应文件</span><br>            file = mSharedPrefsPaths.get(name);<br>            <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span>) {<br>                <span class="hljs-comment">//如果文件不存在, 则创建新的文件 </span><br>                file = getSharedPreferencesPath(name);<br>                mSharedPrefsPaths.put(name, file);<br>            }<br>        }<br><br>        <span class="hljs-keyword">return</span> getSharedPreferences(file, mode);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="http://gityuan.com/images/sp/shared_preference.jpg"></p><p>SharedPreferences 与 Editor 只是两个接口. SharedPreferencesImpl 和 EditorImpl 分别实现了对应接口。另外, ContextImpl 记录着<br>SharedPreferences 的重要数据。</p><p><code>putxxx()</code> 操作把数据写入到EditorImpl.mModified；</p><p><code>apply()/commit()</code> 操作先调用 commitToMemory(), 将数据同步到 SharedPreferencesImpl 的 mMap, 并保存到<br>MemoryCommitResult 的 mapToWriteToDisk，再调用 enqueueDiskWrite(), 写入到磁盘文件; 先之前把原有数据保存到 .bak<br>为后缀的文件,用于在写磁盘的过程出现任何异常可恢复数据;</p><p><code>getxxx()</code> 操作从 SharedPreferencesImpl.mMap 读取数据.</p><h2 id="apply-commit"><a href="#apply-commit" class="headerlink" title="apply / commit"></a>apply / commit</h2><ul><li>apply 没有返回值, commit 有返回值能知道修改是否提交成功</li><li>apply 是将修改提交到内存，再异步提交到磁盘文件，而 commit 是同步的提交到磁盘文件</li><li>多并发的提交 commit 时，需等待正在处理的 commit 数据更新到磁盘文件后才会继续往下执行，从而降低效率; 而 apply<br>只是原子更新到内存，后调用 apply 函数会直接覆盖前面内存数据，从一定程度上提高很多效率。</li></ul><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li>强烈建议不要在 sp 里面存储特别大的 key/value，有助于减少卡顿 / anr</li><li>不要高频地使用 apply，尽可能地批量提交</li><li>不要使用 MODE_MULTI_PROCESS</li><li>高频写操作的 key 与高频读操作的 key 可以适当地拆分文件，由于减少同步锁竞争</li><li>不要连续多次 edit()，应该获取一次获取 edit()，然后多次执行 putxxx()，减少内存波动</li></ul><h1 id="消息机制"><a href="#消息机制" class="headerlink" title="消息机制"></a>消息机制</h1><h2 id="Handler-机制"><a href="#Handler-机制" class="headerlink" title="Handler 机制"></a>Handler 机制</h2><p>Handler 有两个主要用途：（1）安排 Message 和 runnables 在将来的某个时刻执行;<br>（2）将要在不同于自己的线程上执行的操作排入队列。(在多个线程并发更新UI的同时保证线程安全。)</p><p>Android 规定访问 UI 只能在主线程中进行，因为 Android 的 UI 控件不是线程安全的，多线程并发访问会导致 UI 控件处于不可预期的状态。为什么系统不对<br>UI 控件的访问加上锁机制？缺点有两个：加锁会让 UI 访问的逻辑变得复杂；其次锁机制会降低 UI 访问的效率。如果子线程访问<br>UI，那么程序就会抛出异常。ViewRootImpl 对UI操作做了验证，这个验证工作是由 ViewRootImpl的 <code>checkThread</code> 方法完成：</p><p><code>ViewRootImpl.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">checkThread</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">if</span>(mThread!=Thread.currentThread()){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalledFromWrongThreadException</span>(<br>        <span class="hljs-string">"Only the original thread that created a view hierarchy can touch its views."</span>);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><ul><li>Message：Handler 接收和处理的消息对象</li><li>MessageQueue：Message 的队列，先进先出，每一个线程最多可以拥有一个</li><li>Looper：消息泵，是 MessageQueue 的管理者，会不断从 MessageQueue 中取出消息，并将消息分给对应的 Handler 处理，每个线程只有一个<br>Looper。</li></ul><p>Handler 创建的时候会采用当前线程的 Looper 来构造消息循环系统，需要注意的是，线程默认是没有 Looper 的，直接使用 Handler<br>会报错，如果需要使用 Handler 就必须为线程创建 Looper，因为默认的 UI 主线程，也就是 ActivityThread，ActivityThread<br>被创建的时候就会初始化 Looper，这也是在主线程中默认可以使用 Handler 的原因。</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>ThreadLocal 是一个线程内部的数据存储类，通过它可以在指定的线程中存储数据，其他线程则无法获取。Looper、ActivityThread 以及<br>AMS 中都用到了 ThreadLocal。当不同线程访问同一个ThreadLocal 的 get方法，ThreadLocal 内部会从各自的线程中取出一个数组，然后再从数组中根据当前<br>ThreadLcoal 的索引去查找对应的value值。<br><code>ThreadLocal.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span>{<br>        Thread t=Thread.currentThread();<br>        ThreadLocalMap map=getMap(t);<br>        <span class="hljs-keyword">if</span>(map!=<span class="hljs-literal">null</span>)<br>        map.set(<span class="hljs-built_in">this</span>,value);<br>        <span class="hljs-keyword">else</span><br>        createMap(t,value);<br>        }<br><br>        ···<br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span>{<br>        Thread t=Thread.currentThread();<br>        ThreadLocalMap map=getMap(t);<br>        <span class="hljs-keyword">if</span>(map!=<span class="hljs-literal">null</span>){<br>        ThreadLocalMap.Entry e=map.getEntry(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span>(e!=<span class="hljs-literal">null</span>){<br><span class="hljs-meta">@SuppressWarnings("unchecked")</span><br>            T result=(T)e.value;<br>                    <span class="hljs-keyword">return</span> result;<br>                    }<br>                    }<br>                    <span class="hljs-keyword">return</span> setInitialValue();<br>                    }<br></code></pre></td></tr></tbody></table></figure><h3 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h3><p>MessageQueue主要包含两个操作：插入和读取。读取操作本身会伴随着删除操作，插入和读取对应的方法分别是 <code>enqueueMessage</code><br>和 <code>next</code>。MessageQueue 内部实现并不是用的队列，实际上通过一个单链表的数据结构来维护消息列表。next<br>方法是一个无限循环的方法，如果消息队列中没有消息，那么 next 方法会一直阻塞。当有新消息到来时，next 方法会放回这条消息并将其从单链表中移除。</p><p><code>MessageQueue.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(Message msg,<span class="hljs-type">long</span> when)</span>{<br>        ···<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>){<br>        ···<br>        msg.markInUse();<br>        msg.when=when;<br>        Message p=mMessages;<br>        <span class="hljs-type">boolean</span> needWake;<br>        <span class="hljs-keyword">if</span>(p==<span class="hljs-literal">null</span>||when==<span class="hljs-number">0</span>||when&lt;p.when){<br>        <span class="hljs-comment">// New head, wake up the event queue if blocked.</span><br>        msg.next=p;<br>        mMessages=msg;<br>        needWake=mBlocked;<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span><br>        <span class="hljs-comment">// up the event queue unless there is a barrier at the head of the queue</span><br>        <span class="hljs-comment">// and the message is the earliest asynchronous message in the queue.</span><br>        needWake=mBlocked&amp;&amp;p.target==<span class="hljs-literal">null</span>&amp;&amp;msg.isAsynchronous();<br>        Message prev;<br>        <span class="hljs-keyword">for</span>(;;){<br>        prev=p;<br>        p=p.next;<br>        <span class="hljs-keyword">if</span>(p==<span class="hljs-literal">null</span>||when&lt;p.when){<br>        <span class="hljs-keyword">break</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(needWake&amp;&amp;p.isAsynchronous()){<br>        needWake=<span class="hljs-literal">false</span>;<br>        }<br>        }<br>        msg.next=p; <span class="hljs-comment">// invariant: p == prev.next</span><br>        prev.next=msg;<br>        }<br><br>        <span class="hljs-comment">// We can assume mPtr != 0 because mQuitting is false.</span><br>        <span class="hljs-keyword">if</span>(needWake){<br>        nativeWake(mPtr);<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br>        ···<br>        Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span>{<br>        <span class="hljs-comment">// Return here if the message loop has already quit and been disposed.</span><br>        <span class="hljs-comment">// This can happen if the application tries to restart a looper after quit</span><br>        <span class="hljs-comment">// which is not supported.</span><br>        ···<br>        <span class="hljs-keyword">for</span>(;;){<br>        ···<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>){<br><span class="hljs-comment">// Try to retrieve the next message.  Return if found.</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">long</span> now=SystemClock.uptimeMillis();<br>        Message prevMsg=<span class="hljs-literal">null</span>;<br>        Message msg=mMessages;<br>        <span class="hljs-keyword">if</span>(msg!=<span class="hljs-literal">null</span>&amp;&amp;msg.target==<span class="hljs-literal">null</span>){<br>        <span class="hljs-comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span><br>        <span class="hljs-keyword">do</span>{<br>        prevMsg=msg;<br>        msg=msg.next;<br>        }<span class="hljs-keyword">while</span>(msg!=<span class="hljs-literal">null</span>&amp;&amp;!msg.isAsynchronous());<br>        }<br>        <span class="hljs-keyword">if</span>(msg!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">if</span>(now&lt;msg.when){<br>        <span class="hljs-comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span><br>        nextPollTimeoutMillis=(<span class="hljs-type">int</span>)Math.min(msg.when-now,Integer.MAX_VALUE);<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// Got a message.</span><br>        mBlocked=<span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span>(prevMsg!=<span class="hljs-literal">null</span>){<br>        prevMsg.next=msg.next;<br>        }<span class="hljs-keyword">else</span>{<br>        mMessages=msg.next;<br>        }<br>        msg.next=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span>(DEBUG)Log.v(TAG,<span class="hljs-string">"Returning message: "</span>+msg);<br>        msg.markInUse();<br>        <span class="hljs-keyword">return</span> msg;<br>        }<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// No more messages.</span><br>        nextPollTimeoutMillis=-<span class="hljs-number">1</span>;<br>        }<br>        ···<br>        }<br><br>        <span class="hljs-comment">// Run the idle handlers.</span><br>        <span class="hljs-comment">// We only ever reach this code block during the first iteration.</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;pendingIdleHandlerCount; i++){<br><span class="hljs-keyword">final</span> IdleHandler idler=mPendingIdleHandlers[i];<br>        mPendingIdleHandlers[i]=<span class="hljs-literal">null</span>; <span class="hljs-comment">// release the reference to the handler</span><br><br>        <span class="hljs-type">boolean</span> keep=<span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">try</span>{<br>        keep=idler.queueIdle();<br>        }<span class="hljs-keyword">catch</span>(Throwable t){<br>        Log.wtf(TAG,<span class="hljs-string">"IdleHandler threw exception"</span>,t);<br>        }<br><br>        <span class="hljs-keyword">if</span>(!keep){<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>){<br>        mIdleHandlers.remove(idler);<br>        }<br>        }<br>        }<br><br>        <span class="hljs-comment">// Reset the idle handler count to 0 so we do not run them again.</span><br>        pendingIdleHandlerCount=<span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// While calling an idle handler, a new message could have been delivered</span><br>        <span class="hljs-comment">// so go back and look again for a pending message without waiting.</span><br>        nextPollTimeoutMillis=<span class="hljs-number">0</span>;<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h3><p>Looper 会不停地从 MessageQueue 中 查看是否有新消息，如果有新消息就会立刻处理，否则会一直阻塞。<br><code>Looper.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">Looper</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span>{<br>        mQueue=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(quitAllowed);<br>        mThread=Thread.currentThread();<br>        }<br></code></pre></td></tr></tbody></table></figure><p>可通过 Looper.prepare() 为当前线程创建一个 Looper：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-string">"Thread#2"</span>){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        Looper.prepare();<br>        Handler handler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>();<br>        Looper.loop();<br>        }<br>        }.start();<br></code></pre></td></tr></tbody></table></figure><p>除了 prepare 方法外，Looper 还提供了 <code>prepareMainLooper</code> 方法，主要是给 ActivityThread 创建 Looper 使用，本质也是通过<br>prepare 方法实现的。由于主线程的 Looper 比较特殊，所以 Looper 提供了一个 getMainLooper 方法来获取主线程的 Looper。</p><p>Looper 提供了 <code>quit</code> 和 <code>quitSafely</code> 来退出一个 Looper，二者的区别是：<code>quit</code> 会直接退出 Looper，而 <code>quitSafly</code><br>只是设定一个退出标记，然后把消息队列中的已有消息处理完毕后才安全地退出。Looper 退出后，通过 Handler 发送的消息会失败，这个时候<br>Handler 的 send 方法会返回 false。因此在不需要的时候应终止 Looper。</p><p><code>Looper.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>{<br><span class="hljs-keyword">final</span> Looper me=myLooper();<br>        <span class="hljs-keyword">if</span>(me==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);<br>        }<br><span class="hljs-keyword">final</span> MessageQueue queue=me.mQueue;<br>        ···<br>        <span class="hljs-keyword">for</span>(;;){<br>        Message msg=queue.next(); <span class="hljs-comment">// might block</span><br>        <span class="hljs-keyword">if</span>(msg==<span class="hljs-literal">null</span>){<br>        <span class="hljs-comment">// No message indicates that the message queue is quitting.</span><br>        <span class="hljs-keyword">return</span>;<br>        }<br>        ···<br>        <span class="hljs-keyword">try</span>{<br>        msg.target.dispatchMessage(msg);<br>        dispatchEnd=needEndTime?SystemClock.uptimeMillis():<span class="hljs-number">0</span>;<br>        }<span class="hljs-keyword">finally</span>{<br>        <span class="hljs-keyword">if</span>(traceTag!=<span class="hljs-number">0</span>){<br>        Trace.traceEnd(traceTag);<br>        }<br>        }<br>        ···<br>        msg.recycleUnchecked();<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><p>loop 方法是一个死循环，唯一跳出循环的方式是 MessageQueue 的 next 方法返回了null。当 Looper 的 quit 方法被调用时，Looper就会调用<br>MessageQueue 的 quit 或者 qutiSafely 方法来通知消息队列退出，当消息队列被标记为退出状态时，它的 next 方法就会返回<br>null。loop 方法会调用 MessageQueue 的 next 方法来获取新消息，而 next 是一个阻塞操作，当没有消息时，next 会一直阻塞，导致 loop<br>方法一直阻塞。Looper 处理这条消息： msg.target.dispatchMessage(msg)，这里的 msg.target 是发送这条消息的 Handler 对象。</p><h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h3><p>Handler 的工作主要包含消息的发送和接收的过程。消息的发送可以通过 post/send 的一系列方法实现，post 最终也是通过send来实现的。</p><p><img src="https://img-blog.csdnimg.cn/20181220142659447"></p><h1 id="线程异步"><a href="#线程异步" class="headerlink" title="线程异步"></a>线程异步</h1><p>线程（thread） 是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。</p><p>应用启动时，系统会为应用创建一个名为“主线程”的执行线程( UI 线程)。 此线程非常重要，因为它负责将事件分派给相应的用户界面小部件，其中包括绘图事件。<br>此外，它也是应用与 Android UI 工具包组件（来自 <code>android.widget</code> 和 <code>android.view</code> 软件包的组件）进行交互的线程。</p><p>系统不会为每个组件实例创建单独的线程。运行于同一进程的所有组件均在 UI 线程中实例化，并且对每个组件的系统调用均由该线程进行分派。<br>因此，响应系统回调的方法（例如，报告用户操作的 onKeyDown() 或生命周期回调方法）始终在进程的 UI 线程中运行。</p><p>Android 的单线程模式必须遵守两条规则:</p><ul><li>不要阻塞 UI 线程</li><li>不要在 UI 线程之外访问 Android UI 工具包</li></ul><p>为解决此问题，Android 提供了几种途径来从其他线程访问 UI 线程:</p><ul><li><code>Activity.runOnUiThread(Runnable)</code></li><li><code>View.post(Runnable)</code></li><li><code>View.postDelayed(Runnable, long)</code></li></ul><h2 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h2><p>AsyncTask 封装了 Thread 和 Handler，并不适合特别耗时的后台任务，对于特别耗时的任务来说，建议使用线程池。</p><h3 id="基本使用-2"><a href="#基本使用-2" class="headerlink" title="基本使用"></a>基本使用</h3><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>onPreExecute()</td><td>异步任务执行前调用，用于做一些准备工作</td></tr><tr><td>doInBackground(Params…params)</td><td>用于执行异步任务，此方法中可以通过 publishProgress 方法来更新任务的进度，publishProgress 会调用 onProgressUpdate 方法</td></tr><tr><td>onProgressUpdate</td><td>在主线程中执行，后台任务的执行进度发生改变时调用</td></tr><tr><td>onPostExecute</td><td>在主线程中执行，在异步任务执行之后</td></tr></tbody></table><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> android.os.AsyncTask;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;String, Integer, Boolean&gt; {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPreExecute</span><span class="hljs-params">()</span> {<br>        <span class="hljs-built_in">super</span>.onPreExecute();<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">doInBackground</span><span class="hljs-params">(String... strings)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onProgressUpdate</span><span class="hljs-params">(Integer... values)</span> {<br>        <span class="hljs-built_in">super</span>.onProgressUpdate(values);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPostExecute</span><span class="hljs-params">(Boolean aBoolean)</span> {<br>        <span class="hljs-built_in">super</span>.onPostExecute(aBoolean);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>异步任务的实例必须在 UI 线程中创建，即 AsyncTask 对象必须在UI线程中创建。</li><li>execute(Params… params)方法必须在UI线程中调用。</li><li>不要手动调用 onPreExecute()，doInBackground()，onProgressUpdate()，onPostExecute() 这几个方法。</li><li>不能在 doInBackground() 中更改UI组件的信息。</li><li>一个任务实例只能执行一次，如果执行第二次将会抛出异常。</li><li>execute() 方法会让同一个进程中的 AsyncTask 串行执行，如果需要并行，可以调用 executeOnExcutor 方法。</li></ul><h3 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h3><p><code>AsyncTask.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MainThread</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">(Params...params)</span>{<br>        <span class="hljs-keyword">return</span> executeOnExecutor(sDefaultExecutor,params);<br>        }<br><br><span class="hljs-meta">@MainThread</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="hljs-title function_">executeOnExecutor</span><span class="hljs-params">(Executor exec,</span><br><span class="hljs-params">        Params...params)</span>{<br>        <span class="hljs-keyword">if</span>(mStatus!=Status.PENDING){<br>        <span class="hljs-keyword">switch</span>(mStatus){<br>        <span class="hljs-keyword">case</span> RUNNING:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Cannot execute task:"</span><br>        +<span class="hljs-string">" the task is already running."</span>);<br>        <span class="hljs-keyword">case</span> FINISHED:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Cannot execute task:"</span><br>        +<span class="hljs-string">" the task has already been executed "</span><br>        +<span class="hljs-string">"(a task can be executed only once)"</span>);<br>        }<br>        }<br><br>        mStatus=Status.RUNNING;<br><br>        onPreExecute();<br><br>        mWorker.mParams=params;<br>        exec.execute(mFuture);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><p>sDefaultExecutor 是一个串行的线程池，一个进程中的所有的 AsyncTask 全部在该线程池中执行。AysncTask 中有两个线程池（SerialExecutor<br>和 THREAD_POOL_EXECUTOR）和一个 Handler（InternalHandler），其中线程池 SerialExecutor 用于任务的排队，THREAD_POOL_EXECUTOR<br>用于真正地执行任务，InternalHandler 用于将执行环境从线程池切换到主线程。</p><p><code>AsyncTask.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Handler <span class="hljs-title function_">getMainHandler</span><span class="hljs-params">()</span>{<br><span class="hljs-keyword">synchronized</span> (AsyncTask.class){<br>        <span class="hljs-keyword">if</span>(sHandler==<span class="hljs-literal">null</span>){<br>        sHandler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalHandler</span>(Looper.getMainLooper());<br>        }<br>        <span class="hljs-keyword">return</span> sHandler;<br>        }<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InternalHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InternalHandler</span><span class="hljs-params">(Looper looper)</span> {<br>        <span class="hljs-built_in">super</span>(looper);<br>    }<br><br>    <span class="hljs-meta">@SuppressWarnings({"unchecked", "RawUseOfParameterizedType"})</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {<br>        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;<br>        <span class="hljs-keyword">switch</span> (msg.what) {<br>            <span class="hljs-keyword">case</span> MESSAGE_POST_RESULT:<br>                <span class="hljs-comment">// There is only one result</span><br>                result.mTask.finish(result.mData[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MESSAGE_POST_PROGRESS:<br>                result.mTask.onProgressUpdate(result.mData);<br>                <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>}<br><br><br>    <span class="hljs-keyword">private</span> Result <span class="hljs-title function_">postResult</span><span class="hljs-params">(Result result)</span> {<br>        <span class="hljs-meta">@SuppressWarnings("unchecked")</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> getHandler().obtainMessage(MESSAGE_POST_RESULT,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTaskResult</span>&lt;Result&gt;(<span class="hljs-built_in">this</span>, result));<br>        message.sendToTarget();<br>        <span class="hljs-keyword">return</span> result;<br>    }<br></code></pre></td></tr></tbody></table></figure><h2 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h2><p>HandlerThread 集成了 Thread，却和普通的 Thread 有显著的不同。普通的 Thread 主要用于在 run 方法中执行一个耗时任务，而<br>HandlerThread 在内部创建了消息队列，外界需要通过 Handler 的消息方式通知 HanderThread 执行一个具体的任务。</p><p><code>HandlerThread.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        mTid=Process.myTid();<br>        Looper.prepare();<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>){<br>        mLooper=Looper.myLooper();<br>        notifyAll();<br>        }<br>        Process.setThreadPriority(mPriority);<br>        onLooperPrepared();<br>        Looper.loop();<br>        mTid=-<span class="hljs-number">1</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h2><p>IntentService 可用于执行后台耗时的任务，当任务执行后会自动停止，由于其是 Service 的原因，它的优先级比单纯的线程要高，所以<br>IntentService 适合执行一些高优先级的后台任务。在实现上，IntentService 封装了 HandlerThread 和 Handler。</p><p><code>IntentService.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span>{<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> It would be nice to have an option to hold a partial wakelock</span><br>        <span class="hljs-comment">// during processing, and to have a static startService(Context, Intent)</span><br>        <span class="hljs-comment">// method that would launch the service &amp; hand off a wakelock.</span><br><br>        <span class="hljs-built_in">super</span>.onCreate();<br>        HandlerThread thread=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">"IntentService["</span>+mName+<span class="hljs-string">"]"</span>);<br>        thread.start();<br><br>        mServiceLooper=thread.getLooper();<br>        mServiceHandler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceHandler</span>(mServiceLooper);<br>        }<br></code></pre></td></tr></tbody></table></figure><p>IntentService 第一次启动时，会在 onCreatea 方法中创建一个 HandlerThread，然后使用的 Looper 来构造一个 Handler 对象<br>mServiceHandler，这样通过 mServiceHandler 发送的消息最终都会在 HandlerThread 中执行。每次启动 IntentService，它的<br>onStartCommand 方法就会调用一次，onStartCommand 中处理每个后台任务的 Intent，onStartCommand 调用了 onStart 方法：</p><p><code>IntentService.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServiceHandler</span><span class="hljs-params">(Looper looper)</span> {<br>        <span class="hljs-built_in">super</span>(looper);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {<br>        onHandleIntent((Intent) msg.obj);<br>        stopSelf(msg.arg1);<br>    }<br>}<br><br>···<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Intent intent,<span class="hljs-type">int</span> startId)</span>{<br>        Message msg=mServiceHandler.obtainMessage();<br>        msg.arg1=startId;<br>        msg.obj=intent;<br>        mServiceHandler.sendMessage(msg);<br>        }<br></code></pre></td></tr></tbody></table></figure><p>可以看出，IntentService 仅仅是通过 mServiceHandler 发送了一个消息，这个消息会在 HandlerThread 中被处理。mServiceHandler<br>收到消息后，会将 Intent 对象传递给 onHandlerIntent 方法中处理，执行结束后，通过 stopSelf(int startId)<br>来尝试停止服务。（stopSelf() 会立即停止服务，而 stopSelf(int startId) 则会等待所有的消息都处理完毕后才终止服务）。</p><h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>线程池的优点有以下：</p><ul><li>重用线程池中的线程，避免因为线程的创建和销毁带来性能开销。</li><li>能有效控制线程池的最大并发数，避免大量的线程之间因互相抢占系统资源而导致的阻塞现象。</li><li>能够对线程进行管理，并提供定时执行以及定间隔循环执行等功能。</li></ul><p>java 中，ThreadPoolExecutor 是线程池的真正实现：</p><p><code>ThreadPoolExecutor.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creates a new {<span class="hljs-doctag">@code</span> ThreadPoolExecutor} with the given initial</span><br><span class="hljs-comment"> * parameters.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> corePoolSize 核心线程数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> maximumPoolSize 最大线程数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> keepAliveTime 非核心线程闲置的超时时长</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> unit 用于指定 keepAliveTime 参数的时间单位</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> 任务队列，通过线程池的 execute 方法提交的 Runnable 对象会存储在这个参数中</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> threadFactory 线程工厂，用于创建新线程</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> handler 任务队列已满或者是无法成功执行任务时调用</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> maximumPoolSize,</span><br><span class="hljs-params">        <span class="hljs-type">long</span> keepAliveTime,</span><br><span class="hljs-params">        TimeUnit unit,</span><br><span class="hljs-params">        BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="hljs-params">        ThreadFactory threadFactory,</span><br><span class="hljs-params">        RejectedExecutionHandler handler)</span>{<br>        ···<br>        }<br></code></pre></td></tr></tbody></table></figure><table><thead><tr><th>类型</th><th>创建方法</th><th>说明</th></tr></thead><tbody><tr><td>FixedThreadPool</td><td>Executors.newFixedThreadPool(int nThreads)</td><td>一种线程数量固定的线程池，只有核心线程并且不会被回收，没有超时机制</td></tr><tr><td>CachedThreadPool</td><td>Executors.newCachedThreadPool()</td><td>一种线程数量不定的线程池，只有非核心线程，当线程都处于活动状态时，会创建新线程来处理新任务，否则会利用空闲的线程，超时时长为60s</td></tr><tr><td>ScheduledThreadPool</td><td>Executors.newScheduledThreadPool(int corePoolSize)</td><td>核心线程数是固定的，非核心线程数没有限制，非核心线程闲置时立刻回收，主要用于执行定时任务和固定周期的重复任务</td></tr><tr><td>SingleThreadExecutor</td><td>Executors.newSingleThreadExecutor()</td><td>只有一个核心线程，确保所有任务在同一线程中按顺序执行</td></tr></tbody></table><h1 id="RecyclerView-优化"><a href="#RecyclerView-优化" class="headerlink" title="RecyclerView 优化"></a>RecyclerView 优化</h1><ul><li><p>数据处理和视图加载分离：数据的处理逻辑尽可能放在异步处理，onBindViewHolder 方法中只处理数据填充到视图中。</p></li><li><p>数据优化：分页拉取远端数据，对拉取下来的远端数据进行缓存，提升二次加载速度；对于新增或者删除数据通过 DiffUtil<br>来进行局部刷新数据，而不是一味地全局刷新数据。</p></li></ul><p>示例</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdapterDiffCallback</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DiffUtil</span>.Callback {<br><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; mOldList;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; mNewList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AdapterDiffCallback</span><span class="hljs-params">(List&lt;String&gt; oldList, List&lt;String&gt; newList)</span> {<br>        mOldList = oldList;<br>        mNewList = newList;<br>        DiffUtil.DiffResult<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOldListSize</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> mOldList.size();<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getNewListSize</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> mNewList.size();<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">areItemsTheSame</span><span class="hljs-params">(<span class="hljs-type">int</span> oldItemPosition, <span class="hljs-type">int</span> newItemPosition)</span> {<br>        <span class="hljs-keyword">return</span> mOldList.get(oldItemPosition).getClass().equals(mNewList.get(newItemPosition).getClass());<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">areContentsTheSame</span><span class="hljs-params">(<span class="hljs-type">int</span> oldItemPosition, <span class="hljs-type">int</span> newItemPosition)</span> {<br>        <span class="hljs-keyword">return</span> mOldList.get(oldItemPosition).equals(mNewList.get(newItemPosition));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">DiffUtil.DiffResult diffResult=DiffUtil.calculateDiff(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdapterDiffCallback</span>(oldList,newList));<br>        diffResult.dispatchUpdatesTo(mAdapter);<br></code></pre></td></tr></tbody></table></figure><ul><li><p>布局优化：减少布局层级，简化 ItemView</p></li><li><p>升级 RecycleView 版本到 25.1.0 及以上使用 Prefetch 功能</p></li><li><p>通过重写 RecyclerView.onViewRecycled(holder) 来回收资源</p></li><li><p>如果 Item 高度是固定的话，可以使用 RecyclerView.setHasFixedSize(true); 来避免 requestLayout 浪费资源</p></li><li><p>对 ItemView 设置监听器，不要对每个 Item 都调用 addXxListener，应该大家公用一个 XxListener，根据 ID<br>来进行不同的操作，优化了对象的频繁创建带来的资源消耗</p></li><li><p>如果多个 RecycledView 的 Adapter 是一样的，比如嵌套的 RecyclerView 中存在一样的 Adapter，可以通过设置<br>RecyclerView.setRecycledViewPool(pool)，来共用一个 RecycledViewPool。</p></li></ul><h1 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h1><h2 id="基本使用-3"><a href="#基本使用-3" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="WebView"><a href="#WebView" class="headerlink" title="WebView"></a>WebView</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取当前页面的URL</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUrl</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 获取当前页面的原始URL(重定向后可能当前url不同)</span><br><span class="hljs-comment">// 就是http headers的Referer参数，loadUrl时为null</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOriginalUrl</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 获取当前页面的标题</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTitle</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 获取当前页面的favicon</span><br><span class="hljs-keyword">public</span> Bitmap <span class="hljs-title function_">getFavicon</span><span class="hljs-params">()</span>;<br><span class="hljs-comment">// 获取当前页面的加载进度</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getProgress</span><span class="hljs-params">()</span>;<br><br><span class="hljs-comment">// 通知WebView内核网络状态</span><br><span class="hljs-comment">// 用于设置JS属性`window.navigator.isOnline`和产生HTML5事件`online/offline`</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNetworkAvailable</span><span class="hljs-params">(<span class="hljs-type">boolean</span> networkUp)</span><br><br><span class="hljs-comment">// 设置初始缩放比例</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInitialScale</span><span class="hljs-params">(<span class="hljs-type">int</span> scaleInPercent)</span>；<br><br></code></pre></td></tr></tbody></table></figure><h3 id="WebSettings"><a href="#WebSettings" class="headerlink" title="WebSettings"></a>WebSettings</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java">WebSettings settings=web.getSettings();<br><br><span class="hljs-comment">// 存储(storage)</span><br><span class="hljs-comment">// 启用HTML5 DOM storage API，默认值 false</span><br>        settings.setDomStorageEnabled(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 启用Web SQL Database API，这个设置会影响同一进程内的所有WebView，默认值 false</span><br><span class="hljs-comment">// 此API已不推荐使用，参考：https://www.w3.org/TR/webdatabase/</span><br>        settings.setDatabaseEnabled(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 启用Application Caches API，必需设置有效的缓存路径才能生效，默认值 false</span><br><span class="hljs-comment">// 此API已废弃，参考：https://developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache</span><br>        settings.setAppCacheEnabled(<span class="hljs-literal">true</span>);<br>        settings.setAppCachePath(context.getCacheDir().getAbsolutePath());<br><br><span class="hljs-comment">// 定位(location)</span><br>        settings.setGeolocationEnabled(<span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// 是否保存表单数据</span><br>        settings.setSaveFormData(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 是否当webview调用requestFocus时为页面的某个元素设置焦点，默认值 true</span><br>        settings.setNeedInitialFocus(<span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// 是否支持viewport属性，默认值 false</span><br><span class="hljs-comment">// 页面通过`&lt;meta name="viewport" ... /&gt;`自适应手机屏幕</span><br>        settings.setUseWideViewPort(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 是否使用overview mode加载页面，默认值 false</span><br><span class="hljs-comment">// 当页面宽度大于WebView宽度时，缩小使页面宽度等于WebView宽度</span><br>        settings.setLoadWithOverviewMode(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 布局算法</span><br>        settings.setLayoutAlgorithm(WebSettings.LayoutAlgorithm.NORMAL);<br><br><span class="hljs-comment">// 是否支持Javascript，默认值false</span><br>        settings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 是否支持多窗口，默认值false</span><br>        settings.setSupportMultipleWindows(<span class="hljs-literal">false</span>);<br><span class="hljs-comment">// 是否可用Javascript(window.open)打开窗口，默认值 false</span><br>        settings.setJavaScriptCanOpenWindowsAutomatically(<span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// 资源访问</span><br>        settings.setAllowContentAccess(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 是否可访问Content Provider的资源，默认值 true</span><br>        settings.setAllowFileAccess(<span class="hljs-literal">true</span>);    <span class="hljs-comment">// 是否可访问本地文件，默认值 true</span><br><span class="hljs-comment">// 是否允许通过file url加载的Javascript读取本地文件，默认值 false</span><br>        settings.setAllowFileAccessFromFileURLs(<span class="hljs-literal">false</span>);<br><span class="hljs-comment">// 是否允许通过file url加载的Javascript读取全部资源(包括文件,http,https)，默认值 false</span><br>        settings.setAllowUniversalAccessFromFileURLs(<span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// 资源加载</span><br>        settings.setLoadsImagesAutomatically(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 是否自动加载图片</span><br>        settings.setBlockNetworkImage(<span class="hljs-literal">false</span>);       <span class="hljs-comment">// 禁止加载网络图片</span><br>        settings.setBlockNetworkLoads(<span class="hljs-literal">false</span>);       <span class="hljs-comment">// 禁止加载所有网络资源</span><br><br><span class="hljs-comment">// 缩放(zoom)</span><br>        settings.setSupportZoom(<span class="hljs-literal">true</span>);          <span class="hljs-comment">// 是否支持缩放</span><br>        settings.setBuiltInZoomControls(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 是否使用内置缩放机制</span><br>        settings.setDisplayZoomControls(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 是否显示内置缩放控件</span><br><br><span class="hljs-comment">// 默认文本编码，默认值 "UTF-8"</span><br>        settings.setDefaultTextEncodingName(<span class="hljs-string">"UTF-8"</span>);<br>        settings.setDefaultFontSize(<span class="hljs-number">16</span>);        <span class="hljs-comment">// 默认文字尺寸，默认值16，取值范围1-72</span><br>        settings.setDefaultFixedFontSize(<span class="hljs-number">16</span>);   <span class="hljs-comment">// 默认等宽字体尺寸，默认值16</span><br>        settings.setMinimumFontSize(<span class="hljs-number">8</span>);         <span class="hljs-comment">// 最小文字尺寸，默认值 8</span><br>        settings.setMinimumLogicalFontSize(<span class="hljs-number">8</span>);  <span class="hljs-comment">// 最小文字逻辑尺寸，默认值 8</span><br>        settings.setTextZoom(<span class="hljs-number">100</span>);              <span class="hljs-comment">// 文字缩放百分比，默认值 100</span><br><br><span class="hljs-comment">// 字体</span><br>        settings.setStandardFontFamily(<span class="hljs-string">"sans-serif"</span>);   <span class="hljs-comment">// 标准字体，默认值 "sans-serif"</span><br>        settings.setSerifFontFamily(<span class="hljs-string">"serif"</span>);           <span class="hljs-comment">// 衬线字体，默认值 "serif"</span><br>        settings.setSansSerifFontFamily(<span class="hljs-string">"sans-serif"</span>);  <span class="hljs-comment">// 无衬线字体，默认值 "sans-serif"</span><br>        settings.setFixedFontFamily(<span class="hljs-string">"monospace"</span>);       <span class="hljs-comment">// 等宽字体，默认值 "monospace"</span><br>        settings.setCursiveFontFamily(<span class="hljs-string">"cursive"</span>);       <span class="hljs-comment">// 手写体(草书)，默认值 "cursive"</span><br>        settings.setFantasyFontFamily(<span class="hljs-string">"fantasy"</span>);       <span class="hljs-comment">// 幻想体，默认值 "fantasy"</span><br><br><br>        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.KITKAT){<br>        <span class="hljs-comment">// 用户是否需要通过手势播放媒体(不会自动播放)，默认值 true</span><br>        settings.setMediaPlaybackRequiresUserGesture(<span class="hljs-literal">true</span>);<br>        }<br>        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.LOLLIPOP){<br>        <span class="hljs-comment">// 5.0以上允许加载http和https混合的页面(5.0以下默认允许，5.0+默认禁止)</span><br>        settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);<br>        }<br>        <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.M){<br>        <span class="hljs-comment">// 是否在离开屏幕时光栅化(会增加内存消耗)，默认值 false</span><br>        settings.setOffscreenPreRaster(<span class="hljs-literal">false</span>);<br>        }<br><br>        <span class="hljs-keyword">if</span>(isNetworkConnected(context)){<br>        <span class="hljs-comment">// 根据cache-control决定是否从网络上取数据</span><br>        settings.setCacheMode(WebSettings.LOAD_DEFAULT);<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// 没网，离线加载，优先加载缓存(即使已经过期)</span><br>        settings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);<br>        }<br><br><span class="hljs-comment">// deprecated</span><br>        settings.setRenderPriority(WebSettings.RenderPriority.HIGH);<br>        settings.setDatabasePath(context.getDir(<span class="hljs-string">"database"</span>,Context.MODE_PRIVATE).getPath());<br>        settings.setGeolocationDatabasePath(context.getFilesDir().getPath());<br><br></code></pre></td></tr></tbody></table></figure><h3 id="WebViewClient"><a href="#WebViewClient" class="headerlink" title="WebViewClient"></a>WebViewClient</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span><br><span class="hljs-comment">// 此方法在API24被废弃，不处理POST请求</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view,String url)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span><br><span class="hljs-comment">// 此方法添加于API24，不处理POST请求，可拦截处理子frame的非http请求</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.N)</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view,WebResourceRequest request)</span>{<br>        <span class="hljs-keyword">return</span> shouldOverrideUrlLoading(view,request.getUrl().toString());<br>        }<br><br><span class="hljs-comment">// 此方法废弃于API21，调用于非UI线程</span><br><span class="hljs-comment">// 拦截资源请求并返回响应数据，返回null时WebView将继续加载资源</span><br><span class="hljs-keyword">public</span> WebResourceResponse <span class="hljs-title function_">shouldInterceptRequest</span><span class="hljs-params">(WebView view,String url)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br><span class="hljs-comment">// 此方法添加于API21，调用于非UI线程</span><br><span class="hljs-comment">// 拦截资源请求并返回数据，返回null时WebView将继续加载资源</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="hljs-keyword">public</span> WebResourceResponse <span class="hljs-title function_">shouldInterceptRequest</span><span class="hljs-params">(WebView view,WebResourceRequest request)</span>{<br>        <span class="hljs-keyword">return</span> shouldInterceptRequest(view,request.getUrl().toString());<br>        }<br><br><span class="hljs-comment">// 页面(url)开始加载</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPageStarted</span><span class="hljs-params">(WebView view,String url,Bitmap favicon)</span>{<br>        }<br><br><span class="hljs-comment">// 页面(url)完成加载</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPageFinished</span><span class="hljs-params">(WebView view,String url)</span>{<br>        }<br><br><span class="hljs-comment">// 将要加载资源(url)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoadResource</span><span class="hljs-params">(WebView view,String url)</span>{<br>        }<br><br><span class="hljs-comment">// 这个回调添加于API23，仅用于主框架的导航</span><br><span class="hljs-comment">// 通知应用导航到之前页面时，其遗留的WebView内容将不再被绘制。</span><br><span class="hljs-comment">// 这个回调可以用来决定哪些WebView可见内容能被安全地回收，以确保不显示陈旧的内容</span><br><span class="hljs-comment">// 它最早被调用，以此保证WebView.onDraw不会绘制任何之前页面的内容，随后绘制背景色或需要加载的新内容。</span><br><span class="hljs-comment">// 当HTTP响应body已经开始加载并体现在DOM上将在随后的绘制中可见时，这个方法会被调用。</span><br><span class="hljs-comment">// 这个回调发生在文档加载的早期，因此它的资源(css,和图像)可能不可用。</span><br><span class="hljs-comment">// 如果需要更细粒度的视图更新，查看 postVisualStateCallback(long, WebView.VisualStateCallback).</span><br><span class="hljs-comment">// 请注意这上边的所有条件也支持 postVisualStateCallback(long ,WebView.VisualStateCallback)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPageCommitVisible</span><span class="hljs-params">(WebView view,String url)</span>{<br>        }<br><br><span class="hljs-comment">// 此方法废弃于API23</span><br><span class="hljs-comment">// 主框架加载资源时出错</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedError</span><span class="hljs-params">(WebView view,<span class="hljs-type">int</span> errorCode,String description,String failingUrl)</span>{<br>        }<br><br><span class="hljs-comment">// 此方法添加于API23</span><br><span class="hljs-comment">// 加载资源时出错，通常意味着连接不到服务器</span><br><span class="hljs-comment">// 由于所有资源加载错误都会调用此方法，所以此方法应尽量逻辑简单</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.M)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedError</span><span class="hljs-params">(WebView view,WebResourceRequest request,WebResourceError error)</span>{<br>        <span class="hljs-keyword">if</span>(request.isForMainFrame()){<br>        onReceivedError(view,error.getErrorCode(),error.getDescription().toString(),request.getUrl().toString());<br>        }<br>        }<br><br><span class="hljs-comment">// 此方法添加于API23</span><br><span class="hljs-comment">// 在加载资源(iframe,image,js,css,ajax...)时收到了 HTTP 错误(状态码&gt;=400)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedHttpError</span><span class="hljs-params">(WebView view,WebResourceRequest request,WebResourceResponse errorResponse)</span>{<br>        }<br><br><br><span class="hljs-comment">// 是否重新提交表单，默认不重发</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFormResubmission</span><span class="hljs-params">(WebView view,Message dontResend,Message resend)</span>{<br>        dontResend.sendToTarget();<br>        }<br><br><span class="hljs-comment">// 通知应用可以将当前的url存储在数据库中，意味着当前的访问url已经生效并被记录在内核当中。</span><br><span class="hljs-comment">// 此方法在网页加载过程中只会被调用一次，网页前进后退并不会回调这个函数。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doUpdateVisitedHistory</span><span class="hljs-params">(WebView view,String url,<span class="hljs-type">boolean</span> isReload)</span>{<br>        }<br><br><span class="hljs-comment">// 加载资源时发生了一个SSL错误，应用必需响应(继续请求或取消请求)</span><br><span class="hljs-comment">// 处理决策可能被缓存用于后续的请求，默认行为是取消请求</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedSslError</span><span class="hljs-params">(WebView view,SslErrorHandler handler,SslError error)</span>{<br>        handler.cancel();<br>        }<br><br><span class="hljs-comment">// 此方法添加于API21，在UI线程被调用</span><br><span class="hljs-comment">// 处理SSL客户端证书请求，必要的话可显示一个UI来提供KEY。</span><br><span class="hljs-comment">// 有三种响应方式：proceed()/cancel()/ignore()，默认行为是取消请求</span><br><span class="hljs-comment">// 如果调用proceed()或cancel()，Webview 将在内存中保存响应结果且对相同的"host:port"不会再次调用 onReceivedClientCertRequest</span><br><span class="hljs-comment">// 多数情况下，可通过KeyChain.choosePrivateKeyAlias启动一个Activity供用户选择合适的私钥</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedClientCertRequest</span><span class="hljs-params">(WebView view,ClientCertRequest request)</span>{<br>        request.cancel();<br>        }<br><br><span class="hljs-comment">// 处理HTTP认证请求，默认行为是取消请求</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedHttpAuthRequest</span><span class="hljs-params">(WebView view,HttpAuthHandler handler,String host,String realm)</span>{<br>        handler.cancel();<br>        }<br><br><span class="hljs-comment">// 通知应用有个已授权账号自动登陆了</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedLoginRequest</span><span class="hljs-params">(WebView view,String realm,String account,String args)</span>{<br>        }<br><span class="hljs-comment">// 给应用一个机会处理按键事件</span><br><span class="hljs-comment">// 如果返回true，WebView不处理该事件，否则WebView会一直处理，默认返回false</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideKeyEvent</span><span class="hljs-params">(WebView view,KeyEvent event)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 处理未被WebView消费的按键事件</span><br><span class="hljs-comment">// WebView总是消费按键事件，除非是系统按键或shouldOverrideKeyEvent返回true</span><br><span class="hljs-comment">// 此方法在按键事件分派时被异步调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUnhandledKeyEvent</span><span class="hljs-params">(WebView view,KeyEvent event)</span>{<br>        <span class="hljs-built_in">super</span>.onUnhandledKeyEvent(view,event);<br>        }<br><br><span class="hljs-comment">// 通知应用页面缩放系数变化</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onScaleChanged</span><span class="hljs-params">(WebView view,<span class="hljs-type">float</span> oldScale,<span class="hljs-type">float</span> newScale)</span>{<br>        }<br><br></code></pre></td></tr></tbody></table></figure><h3 id="WebChromeClient"><a href="#WebChromeClient" class="headerlink" title="WebChromeClient"></a>WebChromeClient</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获得所有访问历史项目的列表，用于链接着色。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getVisitedHistory</span><span class="hljs-params">(ValueCallback&lt;String[]&gt;callback)</span>{<br>        }<br><br><span class="hljs-comment">// &lt;video /&gt; 控件在未播放时，会展示为一张海报图，HTML中可通过它的'poster'属性来指定。</span><br><span class="hljs-comment">// 如果未指定'poster'属性，则通过此方法提供一个默认的海报图。</span><br><span class="hljs-keyword">public</span> Bitmap <span class="hljs-title function_">getDefaultVideoPoster</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br><span class="hljs-comment">// 当全屏的视频正在缓冲时，此方法返回一个占位视图(比如旋转的菊花)。</span><br><span class="hljs-keyword">public</span> View <span class="hljs-title function_">getVideoLoadingProgressView</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br><span class="hljs-comment">// 接收当前页面的加载进度</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onProgressChanged</span><span class="hljs-params">(WebView view,<span class="hljs-type">int</span> newProgress)</span>{<br>        }<br><br><span class="hljs-comment">// 接收文档标题</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedTitle</span><span class="hljs-params">(WebView view,String title)</span>{<br>        }<br><br><span class="hljs-comment">// 接收图标(favicon)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedIcon</span><span class="hljs-params">(WebView view,Bitmap icon)</span>{<br>        }<br><br><span class="hljs-comment">// Android中处理Touch Icon的方案</span><br><span class="hljs-comment">// http://droidyue.com/blog/2015/01/18/deal-with-touch-icon-in-android/index.html</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedTouchIconUrl</span><span class="hljs-params">(WebView view,String url,<span class="hljs-type">boolean</span> precomposed)</span>{<br>        }<br><br><span class="hljs-comment">// 通知应用当前页进入了全屏模式，此时应用必须显示一个包含网页内容的自定义View</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onShowCustomView</span><span class="hljs-params">(View view,CustomViewCallback callback)</span>{<br>        }<br><br><span class="hljs-comment">// 通知应用当前页退出了全屏模式，此时应用必须隐藏之前显示的自定义View</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHideCustomView</span><span class="hljs-params">()</span>{<br>        }<br><br><br><span class="hljs-comment">// 显示一个alert对话框</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsAlert</span><span class="hljs-params">(WebView view,String url,String message,JsResult result)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 显示一个confirm对话框</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsConfirm</span><span class="hljs-params">(WebView view,String url,String message,JsResult result)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 显示一个prompt对话框</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsPrompt</span><span class="hljs-params">(WebView view,String url,String message,String defaultValue,JsPromptResult result)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 显示一个对话框让用户选择是否离开当前页面</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsBeforeUnload</span><span class="hljs-params">(WebView view,String url,String message,JsResult result)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><br><span class="hljs-comment">// 指定源的网页内容在没有设置权限状态下尝试使用地理位置API。</span><br><span class="hljs-comment">// 从API24开始，此方法只为安全的源(https)调用，非安全的源会被自动拒绝</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onGeolocationPermissionsShowPrompt</span><span class="hljs-params">(String origin,GeolocationPermissions.Callback callback)</span>{<br>        }<br><br><span class="hljs-comment">// 当前一个调用 onGeolocationPermissionsShowPrompt() 取消时，隐藏相关的UI。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onGeolocationPermissionsHidePrompt</span><span class="hljs-params">()</span>{<br>        }<br><br><span class="hljs-comment">// 通知应用打开新窗口</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreateWindow</span><span class="hljs-params">(WebView view,<span class="hljs-type">boolean</span> isDialog,<span class="hljs-type">boolean</span> isUserGesture,Message resultMsg)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 通知应用关闭窗口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCloseWindow</span><span class="hljs-params">(WebView window)</span>{<br>        }<br><br><span class="hljs-comment">// 请求获取取焦点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRequestFocus</span><span class="hljs-params">(WebView view)</span>{<br>        }<br><br><span class="hljs-comment">// 通知应用网页内容申请访问指定资源的权限(该权限未被授权或拒绝)</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPermissionRequest</span><span class="hljs-params">(PermissionRequest request)</span>{<br>        request.deny();<br>        }<br><br><span class="hljs-comment">// 通知应用权限的申请被取消，隐藏相关的UI。</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPermissionRequestCanceled</span><span class="hljs-params">(PermissionRequest request)</span>{<br>        }<br><br><span class="hljs-comment">// 为'&lt;input type="file" /&gt;'显示文件选择器，返回false使用默认处理</span><br><span class="hljs-meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onShowFileChooser</span><span class="hljs-params">(WebView webView,ValueCallback&lt;Uri[]&gt;filePathCallback,FileChooserParams fileChooserParams)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br><span class="hljs-comment">// 接收JavaScript控制台消息</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onConsoleMessage</span><span class="hljs-params">(ConsoleMessage consoleMessage)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br></code></pre></td></tr></tbody></table></figure><h2 id="Webview-加载优化"><a href="#Webview-加载优化" class="headerlink" title="Webview 加载优化"></a>Webview 加载优化</h2><ul><li>使用本地资源替代</li></ul><p>可以 将一些资源文件放在本地的 asset s目录, 然后重 写WebViewClient 的 <code>shouldInterceptRequest</code> 方法，对访问地址进行拦截，当<br>url 地址命中本地配置的url时，使用本地资源替代，否则就使用网络上的资源。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">mWebview.setWebViewClient(<span class="hljs-keyword">new</span>&nbsp;<span class="hljs-title class_">WebViewClient</span>()&nbsp;{&nbsp;&nbsp;&nbsp;<br>        &nbsp;<span class="hljs-comment">//&nbsp;设置不用系统浏览器打开,</span><br><span class="hljs-meta">@Override</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-type">boolean</span>&nbsp;<span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView&nbsp;view,&nbsp;String&nbsp;url)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        view.loadUrl(url);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">true</span>;&nbsp;&nbsp;&nbsp;&nbsp;<br>        }&nbsp;&nbsp;&nbsp;<br>        &nbsp;<br><span class="hljs-meta">@Override</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-keyword">public</span>&nbsp;WebResourceResponse&nbsp;<span class="hljs-title function_">shouldInterceptRequest</span><span class="hljs-params">(WebView&nbsp;view,&nbsp;String&nbsp;url)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;如果命中本地资源,&nbsp;使用本地资源替代&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br>        <span class="hljs-keyword">if</span>&nbsp;(mDataHelper.hasLocalResource(url)){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        &nbsp;<span class="hljs-type">WebResourceResponse</span>&nbsp;<span class="hljs-variable">response</span>&nbsp;<span class="hljs-operator">=</span>&nbsp;mDataHelper.getReplacedWebResourceResponse(getApplicationContext(),url);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">if</span>&nbsp;(response&nbsp;!=&nbsp;<span class="hljs-literal">null</span>)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">return</span>&nbsp;response;<br>        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">return</span>&nbsp;<span class="hljs-built_in">super</span>.shouldInterceptRequest(view,&nbsp;url);&nbsp;&nbsp;&nbsp;&nbsp;<br>        }&nbsp;&nbsp;&nbsp;<br><br><span class="hljs-meta">@TargetApi(VERSION_CODES.LOLLIPOP)</span> <span class="hljs-meta">@Override</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-keyword">public</span>&nbsp;WebResourceResponse&nbsp;<span class="hljs-title function_">shouldInterceptRequest</span><span class="hljs-params">(WebView&nbsp;view,WebResourceRequest&nbsp;request)</span>&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-type">String</span>&nbsp;<span class="hljs-variable">url</span>&nbsp;<span class="hljs-operator">=</span>&nbsp;request.getUrl().toString();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">if</span>&nbsp;(mDataHelper.hasLocalResource(url))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-type">WebResourceResponse</span>&nbsp;<span class="hljs-variable">response</span>&nbsp;<span class="hljs-operator">=</span>&nbsp;&nbsp;mDataHelper.getReplacedWebResourceResponse(getApplicationContext(),&nbsp;url);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">if</span>&nbsp;(response&nbsp;!=&nbsp;<span class="hljs-literal">null</span>)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">return</span>&nbsp;response;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>        <span class="hljs-keyword">return</span>&nbsp;<span class="hljs-built_in">super</span>.shouldInterceptRequest(view,&nbsp;request);&nbsp;&nbsp;&nbsp;&nbsp;<br>        }<br>        });&nbsp;<br></code></pre></td></tr></tbody></table></figure><ul><li><p>WebView初始化慢，可以在初始化同时先请求数据，让后端和网络不要闲着。</p></li><li><p>后端处理慢，可以让服务器分trunk输出，在后端计算的同时前端也加载网络静态资源。</p></li><li><p>脚本执行慢，就让脚本在最后运行，不阻塞页面解析。</p></li><li><p>同时，合理的预加载、预缓存可以让加载速度的瓶颈更小。</p></li><li><p>WebView初始化慢，就随时初始化好一个WebView待用。</p></li><li><p>DNS和链接慢，想办法复用客户端使用的域名和链接。</p></li><li><p>脚本执行慢，可以把框架代码拆分出来，在请求页面之前就执行好。</p></li></ul><p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/9a2f8beb.png"></p><h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><p>直接 new WebView 并传入 application context 代替在 XML 里面声明以防止 activity 引用被滥用，能解决90+%的 WebView 内存泄漏。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">vWeb=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebView</span>(getContext().getApplicationContext());<br>        container.addView(vWeb);<br></code></pre></td></tr></tbody></table></figure><p>销毁 WebView</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(vWeb!=<span class="hljs-literal">null</span>){<br>        vWeb.setWebViewClient(<span class="hljs-literal">null</span>);<br>        vWeb.setWebChromeClient(<span class="hljs-literal">null</span>);<br>        vWeb.loadDataWithBaseURL(<span class="hljs-literal">null</span>,<span class="hljs-string">""</span>,<span class="hljs-string">"text/html"</span>,<span class="hljs-string">"utf-8"</span>,<span class="hljs-literal">null</span>);<br>        vWeb.clearHistory();<br><br>        ((ViewGroup)vWeb.getParent()).removeView(vWeb);<br>        vWeb.destroy();<br>        vWeb=<span class="hljs-literal">null</span>;<br>        } <br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见面试算法题汇总</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/chang-jian-mian-shi-suan-fa-ti-hui-zong/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/chang-jian-mian-shi-suan-fa-ti-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E6%8E%92%E5%BA%8F">排序</a><ul><li><a href="#%E6%AF%94%E8%BE%83%E6%8E%92%E5%BA%8F">比较排序</a><ul><li><a href="#%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F">冒泡排序</a></li><li><a href="#%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F">归并排序</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F">快速排序</a></li></ul></li><li><a href="#%E7%BA%BF%E6%80%A7%E6%8E%92%E5%BA%8F">线性排序</a><ul><li><a href="#%E8%AE%A1%E6%95%B0%E6%8E%92%E5%BA%8F">计数排序</a></li><li><a href="#%E6%A1%B6%E6%8E%92%E5%BA%8F">桶排序</a></li></ul></li></ul></li><li><a href="#%E4%BA%8C%E5%8F%89%E6%A0%91">二叉树</a><ul><li><a href="#%E9%A1%BA%E5%BA%8F%E9%81%8D%E5%8E%86">顺序遍历</a></li><li><a href="#%E5%B1%82%E6%AC%A1%E9%81%8D%E5%8E%86">层次遍历</a></li><li><a href="#%E5%B7%A6%E5%8F%B3%E7%BF%BB%E8%BD%AC">左右翻转</a></li><li><a href="#%E6%9C%80%E5%A4%A7%E5%80%BC">最大值</a></li><li><a href="#%E6%9C%80%E5%A4%A7%E6%B7%B1%E5%BA%A6">最大深度</a></li><li><a href="#%E6%9C%80%E5%B0%8F%E6%B7%B1%E5%BA%A6">最小深度</a></li><li><a href="#%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91">平衡二叉树</a></li></ul></li><li><a href="#%E9%93%BE%E8%A1%A8">链表</a><ul><li><a href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9">删除节点</a></li><li><a href="#%E7%BF%BB%E8%BD%AC%E9%93%BE%E8%A1%A8">翻转链表</a></li><li><a href="#%E4%B8%AD%E9%97%B4%E5%85%83%E7%B4%A0">中间元素</a></li><li><a href="#%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E4%B8%BA%E5%BE%AA%E7%8E%AF%E9%93%BE%E8%A1%A8">判断是否为循环链表</a></li><li><a href="#%E5%90%88%E5%B9%B6%E4%B8%A4%E4%B8%AA%E5%B7%B2%E6%8E%92%E5%BA%8F%E9%93%BE%E8%A1%A8">合并两个已排序链表</a></li><li><a href="#%E9%93%BE%E8%A1%A8%E6%8E%92%E5%BA%8F">链表排序</a></li><li><a href="#%E5%88%A0%E9%99%A4%E5%80%92%E6%95%B0%E7%AC%ACn%E4%B8%AA%E8%8A%82%E7%82%B9">删除倒数第N个节点</a></li><li><a href="#%E4%B8%A4%E4%B8%AA%E9%93%BE%E8%A1%A8%E6%98%AF%E5%90%A6%E7%9B%B8%E4%BA%A4">两个链表是否相交</a></li></ul></li><li><a href="#%E6%A0%88--%E9%98%9F%E5%88%97">栈 / 队列</a><ul><li><a href="#%E5%B8%A6%E6%9C%80%E5%B0%8F%E5%80%BC%E6%93%8D%E4%BD%9C%E7%9A%84%E6%A0%88">带最小值操作的栈</a></li><li><a href="#%E6%9C%89%E6%95%88%E6%8B%AC%E5%8F%B7">有效括号</a></li><li><a href="#%E7%94%A8%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97">用栈实现队列</a></li><li><a href="#%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B1%82%E5%80%BC">逆波兰表达式求值</a></li></ul></li><li><a href="#%E4%BA%8C%E5%88%86">二分</a><ul><li><a href="#%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2">二分搜索</a></li><li><a href="#x%E7%9A%84%E5%B9%B3%E6%96%B9%E6%A0%B9">X的平方根</a></li></ul></li><li><a href="#%E5%93%88%E5%B8%8C%E8%A1%A8">哈希表</a><ul><li><a href="#%E4%B8%A4%E6%95%B0%E4%B9%8B%E5%92%8C">两数之和</a></li><li><a href="#%E8%BF%9E%E7%BB%AD%E6%95%B0%E7%BB%84">连续数组</a></li><li><a href="#%E6%9C%80%E9%95%BF%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E5%AD%90%E4%B8%B2">最长无重复字符的子串</a></li><li><a href="#%E6%9C%80%E5%A4%9A%E7%82%B9%E5%9C%A8%E4%B8%80%E6%9D%A1%E7%9B%B4%E7%BA%BF%E4%B8%8A">最多点在一条直线上</a></li></ul></li><li><a href="#%E5%A0%86--%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97">堆 / 优先队列</a><ul><li><a href="#%E5%89%8Dk%E5%A4%A7%E7%9A%84%E6%95%B0">前K大的数</a></li><li><a href="#%E5%89%8Dk%E5%A4%A7%E7%9A%84%E6%95%B0ii">前K大的数II</a></li><li><a href="#%E7%AC%ACk%E5%A4%A7%E7%9A%84%E6%95%B0">第K大的数</a></li></ul></li><li><a href="#%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91">二叉搜索树</a><ul><li><a href="#%E9%AA%8C%E8%AF%81%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91">验证二叉搜索树</a></li><li><a href="#%E7%AC%ACk%E5%B0%8F%E7%9A%84%E5%85%83%E7%B4%A0">第K小的元素</a></li></ul></li><li><a href="#%E6%95%B0%E7%BB%84--%E5%8F%8C%E6%8C%87%E9%92%88">数组 / 双指针</a><ul><li><a href="#%E5%8A%A0%E4%B8%80">加一</a></li><li><a href="#%E5%88%A0%E9%99%A4%E5%85%83%E7%B4%A0">删除元素</a></li><li><a href="#%E5%88%A0%E9%99%A4%E6%8E%92%E5%BA%8F%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97">删除排序数组中的重复数字</a></li><li><a href="#%E6%88%91%E7%9A%84%E6%97%A5%E7%A8%8B%E5%AE%89%E6%8E%92%E8%A1%A8-i">我的日程安排表 I</a></li><li><a href="#%E5%90%88%E5%B9%B6%E6%8E%92%E5%BA%8F%E6%95%B0%E7%BB%84">合并排序数组</a></li></ul></li><li><a href="#%E8%B4%AA%E5%BF%83">贪心</a><ul><li><a href="#%E4%B9%B0%E5%8D%96%E8%82%A1%E7%A5%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E6%97%B6%E6%9C%BA">买卖股票的最佳时机</a></li><li><a href="#%E4%B9%B0%E5%8D%96%E8%82%A1%E7%A5%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E6%97%B6%E6%9C%BA-ii">买卖股票的最佳时机 II</a></li><li><a href="#%E6%9C%80%E5%A4%A7%E5%AD%90%E6%95%B0%E7%BB%84">最大子数组</a></li><li><a href="#%E4%B8%BB%E5%85%83%E7%B4%A0">主元素</a></li></ul></li><li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86">字符串处理</a><ul><li><a href="#%E7%94%9F%E6%88%90%E6%8B%AC%E5%8F%B7">生成括号</a></li><li><a href="#excel%E8%A1%A8%E5%88%97%E6%A0%87%E9%A2%98">Excel表列标题</a></li><li><a href="#%E7%BF%BB%E8%BD%AC%E6%B8%B8%E6%88%8F">翻转游戏</a></li><li><a href="#%E7%BF%BB%E8%BD%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E5%8D%95%E8%AF%8D">翻转字符串中的单词</a></li><li><a href="#%E8%BD%AC%E6%8D%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%B0%E6%95%B4%E6%95%B0">转换字符串到整数</a></li><li><a href="#%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%89%8D%E7%BC%80">最长公共前缀</a></li><li><a href="#%E5%9B%9E%E6%96%87%E6%95%B0">回文数</a></li></ul></li><li><a href="#%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92">动态规划</a><ul><li><a href="#%E5%8D%95%E8%AF%8D%E6%8B%86%E5%88%86">单词拆分</a></li><li><a href="#%E7%88%AC%E6%A5%BC%E6%A2%AF">爬楼梯</a></li><li><a href="#%E6%89%93%E5%8A%AB%E6%88%BF%E5%B1%8B">打劫房屋</a></li><li><a href="#%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB">编辑距离</a></li><li><a href="#%E4%B9%98%E7%A7%AF%E6%9C%80%E5%A4%A7%E5%AD%90%E5%BA%8F%E5%88%97">乘积最大子序列</a></li></ul></li><li><a href="#%E7%9F%A9%E9%98%B5">矩阵</a><ul><li><a href="#%E8%9E%BA%E6%97%8B%E7%9F%A9%E9%98%B5">螺旋矩阵</a></li><li><a href="#%E5%88%A4%E6%96%AD%E6%95%B0%E7%8B%AC%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95">判断数独是否合法</a></li><li><a href="#%E6%97%8B%E8%BD%AC%E5%9B%BE%E5%83%8F">旋转图像</a></li></ul></li><li><a href="#%E4%BA%8C%E8%BF%9B%E5%88%B6--%E4%BD%8D%E8%BF%90%E7%AE%97">二进制 / 位运算</a><ul><li><a href="#%E8%90%BD%E5%8D%95%E7%9A%84%E6%95%B0">落单的数</a></li><li><a href="#%E6%A0%BC%E9%9B%B7%E7%BC%96%E7%A0%81">格雷编码</a></li></ul></li><li><a href="#%E5%85%B6%E4%BB%96">其他</a><ul><li><a href="#%E5%8F%8D%E8%BD%AC%E6%95%B4%E6%95%B0">反转整数</a></li><li><a href="#lru%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5">LRU缓存策略</a></li></ul></li></ul><h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="比较排序"><a href="#比较排序" class="headerlink" title="比较排序"></a>比较排序</h2><h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><p>重复地走访过要排序的数列，每次比较相邻两个元素，如果它们的顺序错误就把它们交换过来，越大的元素会经由交换慢慢“浮”到数列的尾端。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bubbleSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> {<br>    <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">boolean</span> swap;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> arr.length - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) { <span class="hljs-comment">// 每次需要排序的长度</span><br>        <span class="hljs-comment">// 增加一个swap的标志，当前一轮没有进行交换时，说明数组已经有序</span><br>        swap = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; i; j++) { <span class="hljs-comment">// 从第一个元素到第i个元素</span><br>            <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {<br>                temp = arr[j];<br>                arr[j] = arr[j + <span class="hljs-number">1</span>];<br>                arr[j + <span class="hljs-number">1</span>] = temp;<br>                swap = <span class="hljs-literal">true</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">if</span> (!swap){<br>            <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><p>分解待排序的数组成两个各具 n/2 个元素的子数组，递归调用归并排序两个子数组，合并两个已排序的子数组成一个已排序的数组。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr)</span>{<br>        <span class="hljs-type">int</span>[]temp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length];<br>        internalMergeSort(arr,temp,<span class="hljs-number">0</span>,arr.length-<span class="hljs-number">1</span>);<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalMergeSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr,<span class="hljs-type">int</span>[]temp,<span class="hljs-type">int</span> left,<span class="hljs-type">int</span> right)</span>{<br>        <span class="hljs-comment">// 当left == right时，不需要再划分</span><br>        <span class="hljs-keyword">if</span>(left&lt;right){<br>        <span class="hljs-type">int</span> mid=(left+right)/<span class="hljs-number">2</span>;<br>        internalMergeSort(arr,temp,left,mid);<br>        internalMergeSort(arr,temp,mid+<span class="hljs-number">1</span>,right);<br>        mergeSortedArray(arr,temp,left,mid,right);<br>        }<br>        }<br><br><span class="hljs-comment">// 合并两个有序子序列</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeSortedArray</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr,<span class="hljs-type">int</span>[]temp,<span class="hljs-type">int</span> left,<span class="hljs-type">int</span> mid,<span class="hljs-type">int</span> right)</span>{<br>        <span class="hljs-type">int</span> i=left;<br>        <span class="hljs-type">int</span> j=mid+<span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span>(i&lt;=mid&amp;&amp;j&lt;=right){<br>        temp[k++]=arr[i]&lt;arr[j]?arr[i++]:arr[j++];<br>        }<br>        <span class="hljs-keyword">while</span>(i&lt;=mid){<br>        temp[k++]=arr[i++];<br>        }<br>        <span class="hljs-keyword">while</span>(j&lt;=right){<br>        temp[k++]=arr[j++];<br>        }<br>        <span class="hljs-comment">// 把temp数据复制回原数组</span><br>        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;k; i++){<br>        arr[left+i]=temp[i];<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><p>在待排序的数组选取一个元素作为基准，将待排序的元素进行分区，比基准元素大的元素放在一边，比其小的放另一边，递归调用快速排序对两边的元素排序。选取基准元素并分区的过程采用双指针左右交换。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr)</span>{<br>        quickSort(arr,<span class="hljs-number">0</span>,arr.length-<span class="hljs-number">1</span>);<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr,<span class="hljs-type">int</span> low,<span class="hljs-type">int</span> high)</span>{<br>        <span class="hljs-keyword">if</span>(low&gt;=high)<br>        <span class="hljs-keyword">return</span>;<br>        <span class="hljs-type">int</span> pivot=partition(arr,low,high);        <span class="hljs-comment">//将数组分为两部分</span><br>        quickSort(arr,low,pivot-<span class="hljs-number">1</span>);                   <span class="hljs-comment">//递归排序左子数组</span><br>        quickSort(arr,pivot+<span class="hljs-number">1</span>,high);                  <span class="hljs-comment">//递归排序右子数组</span><br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr,<span class="hljs-type">int</span> low,<span class="hljs-type">int</span> high)</span>{<br>        <span class="hljs-type">int</span> pivot=arr[low];     <span class="hljs-comment">//基准</span><br>        <span class="hljs-keyword">while</span>(low&lt;high){<br>        <span class="hljs-keyword">while</span>(low&lt;high &amp;&amp;arr[high]&gt;=pivot){<br>        high--;<br>        }<br>        arr[low]=arr[high];             <span class="hljs-comment">//交换比基准大的记录到左端</span><br>        <span class="hljs-keyword">while</span>(low&lt;high &amp;&amp;arr[low]&lt;=pivot){<br>        low++;<br>        }<br>        arr[high]=arr[low];           <span class="hljs-comment">//交换比基准小的记录到右端</span><br>        }<br>        <span class="hljs-comment">//扫描完成，基准到位</span><br>        arr[low]=pivot;<br>        <span class="hljs-comment">//返回的是基准的位置</span><br>        <span class="hljs-keyword">return</span> low;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="线性排序"><a href="#线性排序" class="headerlink" title="线性排序"></a>线性排序</h2><h3 id="计数排序"><a href="#计数排序" class="headerlink" title="计数排序"></a>计数排序</h3><p>根据待排序的数组中最大和最小的元素，统计数组中每个值为i的元素出现的次数，存入数组C的第i项，对所有的计数累加，然后反向填充目标数组。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr)</span>{<br>        <span class="hljs-type">int</span> max=Integer.MIN_VALUE;<br>        <span class="hljs-type">int</span> min=Integer.MAX_VALUE;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        max=Math.max(max,arr[i]);<br>        min=Math.min(min,arr[i]);<br>        }<br><br>        <span class="hljs-type">int</span>[]b=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[arr.length]; <span class="hljs-comment">// 存储数组</span><br>        <span class="hljs-type">int</span>[]count=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[max-min+<span class="hljs-number">1</span>]; <span class="hljs-comment">// 计数数组</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> num=min;num&lt;=max;num++){<br>        <span class="hljs-comment">// 初始化各元素值为0，数组下标从0开始因此减min</span><br>        count[num-min]=<span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        <span class="hljs-type">int</span> num=arr[i];<br>        count[num-min]++; <span class="hljs-comment">// 每出现一个值，计数数组对应元素的值+1</span><br>        <span class="hljs-comment">// 此时count[i]表示数值等于i的元素的个数</span><br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=min+<span class="hljs-number">1</span>;i&lt;=max;i++){<br>        count[i-min]+=count[i-min-<span class="hljs-number">1</span>];<br>        <span class="hljs-comment">// 此时count[i]表示数值&lt;=i的元素的个数</span><br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        <span class="hljs-type">int</span> num=arr[i]; <span class="hljs-comment">// 原数组第i位的值</span><br>        <span class="hljs-type">int</span> index=count[num-min]-<span class="hljs-number">1</span>; <span class="hljs-comment">//加总数组中对应元素的下标</span><br>        b[index]=num; <span class="hljs-comment">// 将该值存入存储数组对应下标中</span><br>        count[num-min]--; <span class="hljs-comment">// 加总数组中，该值的总和减少1。</span><br>        }<br><br>        <span class="hljs-comment">// 将存储数组的值替换给原数组</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        arr[i]=b[i];<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h3 id="桶排序"><a href="#桶排序" class="headerlink" title="桶排序"></a>桶排序</h3><p>找出待排序数组中的最大值max、最小值min，数组ArrayList作为桶，桶里放的元素用ArrayList存储。计算每个元素 arr[i]<br>放的桶，每个桶各自排序，遍历桶数组，把排序好的元素放进输出数组。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bucketSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr)</span>{<br>        <span class="hljs-type">int</span> max=Integer.MIN_VALUE;<br>        <span class="hljs-type">int</span> min=Integer.MAX_VALUE;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        max=Math.max(max,arr[i]);<br>        min=Math.min(min,arr[i]);<br>        }<br>        <span class="hljs-comment">// 桶数</span><br>        <span class="hljs-type">int</span> bucketNum=(max-min)/arr.length+<span class="hljs-number">1</span>;<br>        ArrayList&lt;ArrayList&lt;Integer&gt;&gt;bucketArr=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(bucketNum);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;bucketNum; i++){<br>        bucketArr.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;());<br>        }<br>        <span class="hljs-comment">// 将每个元素放入桶</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;arr.length;i++){<br>        <span class="hljs-type">int</span> num=(arr[i]-min)/(arr.length);<br>        bucketArr.get(num).add(arr[i]);<br>        }<br>        <span class="hljs-comment">// 对每个桶进行排序</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;bucketArr.size();i++){<br>        Collections.sort(bucketArr.get(i));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;bucketArr.get(i).size();j++){<br>        arr[j]=bucketArr.get(i).get(j);<br>        }<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span> {<br>    <span class="hljs-keyword">public</span> TreeNode left, right;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> val;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TreeNode</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> {<br>        <span class="hljs-built_in">this</span>.val = val;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="顺序遍历"><a href="#顺序遍历" class="headerlink" title="顺序遍历"></a>顺序遍历</h2><p>先序遍历: 根-&gt;左-&gt;右<br>中序遍历: 左-&gt;根-&gt;右<br>后序遍历: 左-&gt;右-&gt;根</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 先序遍历</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preTraverse</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root!=<span class="hljs-literal">null</span>){<br>        System.out.println(root.val);<br>        preTraverse(root.left);<br>        preTraverse(root.right);<br>        }<br>        }<br><br><span class="hljs-comment">// 中序遍历</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inTraverse</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root!=<span class="hljs-literal">null</span>){<br>        inTraverse(root.left);<br>        System.out.println(root.val);<br>        inTraverse(root.right);<br>        }<br>        }<br><br><span class="hljs-comment">// 后序遍历</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postTraverse</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root!=<span class="hljs-literal">null</span>){<br>        postTraverse(root.left);<br>        postTraverse(root.right);<br>        System.out.println(root.val);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="层次遍历"><a href="#层次遍历" class="headerlink" title="层次遍历"></a>层次遍历</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 层次遍历(DFS)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;List&lt;Integer&gt;&gt;levelOrder(TreeNode root){<br>        List&lt;List&lt;Integer&gt;&gt;res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> res;<br>        }<br><br>        dfs(root,res,<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> res;<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(TreeNode root,List&lt;List&lt;Integer&gt;&gt;res,<span class="hljs-type">int</span> level)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(level==res.size()){<br>        res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());<br>        }<br>        res.get(level).add(root.val);<br><br>        dfs(root.left,res,level+<span class="hljs-number">1</span>);<br>        dfs(root.right,res,level+<span class="hljs-number">1</span>);<br>        }<br><br><span class="hljs-comment">// 层次遍历(BFS)</span><br><span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt;levelOrder(TreeNode root){<br>        List result=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> result;<br>        }<br><br>        Queue&lt;TreeNode&gt; queue=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;TreeNode&gt;();<br>        queue.offer(root);<br><br>        <span class="hljs-keyword">while</span>(!queue.isEmpty()){<br>        ArrayList&lt;Integer&gt; level=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;();<br>        <span class="hljs-type">int</span> size=queue.size();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;size; i++){<br>        TreeNode head=queue.poll();<br>        level.add(head.val);<br>        <span class="hljs-keyword">if</span>(head.left!=<span class="hljs-literal">null</span>){<br>        queue.offer(head.left);<br>        }<br>        <span class="hljs-keyword">if</span>(head.right!=<span class="hljs-literal">null</span>){<br>        queue.offer(head.right);<br>        }<br>        }<br>        result.add(level);<br>        }<br><br>        <span class="hljs-keyword">return</span> result;<br>        }<br><br><span class="hljs-comment">// "Z"字遍历</span><br><span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt;zigzagLevelOrder(TreeNode root){<br>        List&lt;List&lt;Integer&gt;&gt;result=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> result;<br>        }<br><br>        Queue&lt;TreeNode&gt; queue=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        queue.offer(root);<br>        <span class="hljs-type">boolean</span> isFromLeft=<span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">while</span>(!queue.isEmpty()){<br>        <span class="hljs-type">int</span> size=queue.size();<br>        isFromLeft=!isFromLeft;<br>        List&lt;Integer&gt; list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;size; i++){<br>        TreeNode node;<br>        <span class="hljs-keyword">if</span>(isFromLeft){<br>        node=queue.pollFirst();<br>        }<span class="hljs-keyword">else</span>{<br>        node=queue.pollLast();<br>        }<br>        list.add(node.val);<br><br>        <span class="hljs-keyword">if</span>(isFromLeft){<br>        <span class="hljs-keyword">if</span>(node.left!=<span class="hljs-literal">null</span>){<br>        queue.offerLast(node.left);<br>        }<br>        <span class="hljs-keyword">if</span>(node.right!=<span class="hljs-literal">null</span>){<br>        queue.offerLast(node.right);<br>        }<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">if</span>(node.right!=<span class="hljs-literal">null</span>){<br>        queue.offerFirst(node.right);<br>        }<br>        <span class="hljs-keyword">if</span>(node.left!=<span class="hljs-literal">null</span>){<br>        queue.offerFirst(node.left);<br>        }<br>        }<br>        }<br>        result.add(list);<br>        }<br><br>        <span class="hljs-keyword">return</span> result;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="左右翻转"><a href="#左右翻转" class="headerlink" title="左右翻转"></a>左右翻转</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invert</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        TreeNode temp=root.left;<br>        root.left=root.right;<br>        root.right=temp;<br><br>        invert(root.left);<br>        invert(root.right);<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最大值"><a href="#最大值" class="headerlink" title="最大值"></a>最大值</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMax</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> Integer.MIN_VALUE;<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-type">int</span> left=getMax(root.left);<br>        <span class="hljs-type">int</span> right=getMax(root.right);<br>        <span class="hljs-keyword">return</span> Math.max(Math.max(left,rigth),root.val);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最大深度"><a href="#最大深度" class="headerlink" title="最大深度"></a>最大深度</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxDepth</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> left=maxDepth(root.left);<br>        <span class="hljs-type">int</span> right=maxDepth(root.right);<br>        <span class="hljs-keyword">return</span> Math.max(left,right)+<span class="hljs-number">1</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最小深度"><a href="#最小深度" class="headerlink" title="最小深度"></a>最小深度</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">minDepth</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> left=minDepth(root.left);<br>        <span class="hljs-type">int</span> right=minDepth(root.right);<br><br>        <span class="hljs-keyword">if</span>(left==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> right+<span class="hljs-number">1</span>;<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(right==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> left+<span class="hljs-number">1</span>;<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">return</span> Math.min(left,right)+<span class="hljs-number">1</span>;<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h2><blockquote><p>平衡二叉树每一个节点的左右两个子树的高度差不超过1</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBalanced</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">return</span> maxDepth(root)!=-<span class="hljs-number">1</span>;<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxDepth</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> left=maxDepth(root.left);<br>        <span class="hljs-type">int</span> right=maxDepth(root.right);<br>        <span class="hljs-keyword">if</span>(left==-<span class="hljs-number">1</span>||right==-<span class="hljs-number">1</span>||Math.abs(left-right)&gt;<span class="hljs-number">1</span>){<br>        <span class="hljs-keyword">return</span>-<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-keyword">return</span> Math.max(left,right)+<span class="hljs-number">1</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> {<br>    <span class="hljs-type">int</span> val;<br>    ListNode next;<br><br>    ListNode(<span class="hljs-type">int</span> x) {<br>        val = x;<br>        next = <span class="hljs-literal">null</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteNode</span><span class="hljs-params">(ListNode node)</span>{<br>        <span class="hljs-keyword">if</span>(node.next==<span class="hljs-literal">null</span>){<br>        node=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        <span class="hljs-comment">// 取缔下一节点</span><br>        node.val=node.next.val<br>        node.next=node.next.next<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="翻转链表"><a href="#翻转链表" class="headerlink" title="翻转链表"></a>翻转链表</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">reverse</span><span class="hljs-params">(ListNode head)</span>{<br>        <span class="hljs-comment">//prev表示前继节点</span><br>        ListNode prev=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span>(head!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-comment">//temp记录下一个节点，head是当前节点</span><br>        ListNode temp=head.next;<br>        head.next=prev;<br>        prev=head;<br>        head=temp;<br>        }<br>        <span class="hljs-keyword">return</span> prev;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="中间元素"><a href="#中间元素" class="headerlink" title="中间元素"></a>中间元素</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">findMiddle</span><span class="hljs-params">(ListNode head)</span>{<br>        <span class="hljs-keyword">if</span>(head==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br>        ListNode slow=head;<br>        ListNode fast=head;<br><br>        <span class="hljs-comment">// fast.next = null 表示 fast 是链表的尾节点</span><br>        <span class="hljs-keyword">while</span>(fast!=<span class="hljs-literal">null</span>&amp;&amp;fast.next!=<span class="hljs-literal">null</span>){<br>        fast=fast.next.next;<br>        slow=slow.next;<br>        }<br>        <span class="hljs-keyword">return</span> slow;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="判断是否为循环链表"><a href="#判断是否为循环链表" class="headerlink" title="判断是否为循环链表"></a>判断是否为循环链表</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">hasCycle</span><span class="hljs-params">(ListNode head)</span>{<br>        <span class="hljs-keyword">if</span>(head==<span class="hljs-literal">null</span>||head.next==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        ListNode slow=head;<br>        ListNode fast=head.next;<br><br>        <span class="hljs-keyword">while</span>(fast!=slow){<br>        <span class="hljs-keyword">if</span>(fast==<span class="hljs-literal">null</span>||fast.next==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        fast=fast.next.next;<br>        slow=slow.next;<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="合并两个已排序链表"><a href="#合并两个已排序链表" class="headerlink" title="合并两个已排序链表"></a>合并两个已排序链表</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">mergeTwoLists</span><span class="hljs-params">(ListNode l1,ListNode l2)</span>{<br>        ListNode dummy=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">0</span>);<br>        ListNode lastNode=dummy;<br><br>        <span class="hljs-keyword">while</span>(l1!=<span class="hljs-literal">null</span>&amp;&amp;l2!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">if</span>(l1.val&lt;l2.val){<br>        lastNode.next=l1;<br>        l1=l1.next;<br>        }<span class="hljs-keyword">else</span>{<br>        lastNode.next=l2;<br>        l2=l2.next;<br>        }<br>        lastNode=lastNode.next;<br>        }<br><br>        <span class="hljs-keyword">if</span>(l1!=<span class="hljs-literal">null</span>){<br>        lastNode.next=l1;<br>        }<span class="hljs-keyword">else</span>{<br>        lastNode.next=l2;<br>        }<br><br>        <span class="hljs-keyword">return</span> dummy.next;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="链表排序"><a href="#链表排序" class="headerlink" title="链表排序"></a>链表排序</h2><p>可利用归并、快排等算法实现</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 归并排序</span><br><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">sortList</span><span class="hljs-params">(ListNode head)</span>{<br>        <span class="hljs-keyword">if</span>(head==<span class="hljs-literal">null</span>||head.next==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> head;<br>        }<br><br>        ListNode mid=findMiddle(head);<br><br>        ListNode right=sortList(mid.next);<br>        mid.next=<span class="hljs-literal">null</span>;<br>        ListNode left=sortList(head);<br><br>        <span class="hljs-keyword">return</span> mergeTwoLists(left,right);<br>        }<br><br><span class="hljs-comment">// 快速排序</span><br><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">sortList</span><span class="hljs-params">(ListNode head)</span>{<br>        quickSort(head,<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> head;<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(ListNode start,ListNode end)</span>{<br>        <span class="hljs-keyword">if</span>(start==end){<br>        <span class="hljs-keyword">return</span>;<br>        }<br><br>        ListNode pt=partition(start,end);<br>        quickSort(start,pt);<br>        quickSort(pt.next,end);<br>        }<br><br><span class="hljs-keyword">private</span> ListNode <span class="hljs-title function_">partition</span><span class="hljs-params">(ListNode start,ListNode end)</span>{<br>        <span class="hljs-type">int</span> pivotKey=start.val;<br>        ListNode p1=start,p2=start.next;<br>        <span class="hljs-keyword">while</span>(p2!=end){<br>        <span class="hljs-keyword">if</span>(p2.val&lt;pivotKey){<br>        p1=p1.next;<br>        swapValue(p1,p2);<br>        }<br>        p2=p2.next;<br>        }<br><br>        swapValue(start,p1);<br>        <span class="hljs-keyword">return</span> p1;<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swapValue</span><span class="hljs-params">(ListNode node1,ListNode node2)</span>{<br>        <span class="hljs-type">int</span> tmp=node1.val;<br>        node1.val=node2.val;<br>        node2.val=tmp;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="删除倒数第N个节点"><a href="#删除倒数第N个节点" class="headerlink" title="删除倒数第N个节点"></a>删除倒数第N个节点</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">removeNthFromEnd</span><span class="hljs-params">(ListNode head,<span class="hljs-type">int</span> n)</span>{<br>        <span class="hljs-keyword">if</span>(n&lt;=<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br>        ListNode dummy=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">0</span>);<br>        dummy.next=head;<br><br>        ListNode preDelete=dummy;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n; i++){<br>        <span class="hljs-keyword">if</span>(head==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        head=head.next;<br>        }<br>        <span class="hljs-comment">// 此时head为正数第N个节点</span><br>        <span class="hljs-keyword">while</span>(head!=<span class="hljs-literal">null</span>){<br>        head=head.next;<br>        preDelete=preDelete.next;<br>        }<br>        preDelete.next=preDelete.next.next;<br>        <span class="hljs-keyword">return</span> dummy.next;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="两个链表是否相交"><a href="#两个链表是否相交" class="headerlink" title="两个链表是否相交"></a>两个链表是否相交</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">getIntersectionNode</span><span class="hljs-params">(ListNode headA,ListNode headB)</span>{<br>        <span class="hljs-keyword">if</span>(headA==<span class="hljs-literal">null</span>||headB==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br><br>        ListNode currA=headA;<br>        ListNode currB=headB;<br>        <span class="hljs-type">int</span> lengthA=<span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> lengthB=<span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// 让长的先走到剩余长度和短的一样</span><br>        <span class="hljs-keyword">while</span>(currA!=<span class="hljs-literal">null</span>){<br>        currA=currA.next;<br>        lengthA++;<br>        }<br>        <span class="hljs-keyword">while</span>(currB!=<span class="hljs-literal">null</span>){<br>        currB=currB.next;<br>        lengthB++;<br>        }<br><br>        currA=headA;<br>        currB=headB;<br>        <span class="hljs-keyword">while</span>(lengthA&gt;lengthB){<br>        currA=currA.next;<br>        lengthA--;<br>        }<br>        <span class="hljs-keyword">while</span>(lengthB&gt;lengthA){<br>        currB=currB.next;<br>        lengthB--;<br>        }<br><br>        <span class="hljs-comment">// 然后同时走到第一个相同的地方</span><br>        <span class="hljs-keyword">while</span>(currA!=currB){<br>        currA=currA.next;<br>        currB=currB.next;<br>        }<br>        <span class="hljs-comment">// 返回交叉开始的节点</span><br>        <span class="hljs-keyword">return</span> currA;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="栈-队列"><a href="#栈-队列" class="headerlink" title="栈 / 队列"></a>栈 / 队列</h1><h2 id="带最小值操作的栈"><a href="#带最小值操作的栈" class="headerlink" title="带最小值操作的栈"></a>带最小值操作的栈</h2><blockquote><p>实现一个栈, 额外支持一个操作：min() 返回栈中元素的最小值</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinStack</span> {<br>    <span class="hljs-keyword">private</span> Stack&lt;Integer&gt; stack;<br>    <span class="hljs-keyword">private</span> Stack&lt;Integer&gt; minStack; <span class="hljs-comment">// 维护一个辅助栈，传入当前栈的最小值</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MinStack</span><span class="hljs-params">()</span> {<br>        stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Integer&gt;();<br>        minStack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Integer&gt;();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> number)</span> {<br>        stack.push(number);<br>        <span class="hljs-keyword">if</span> (minStack.isEmpty()) {<br>            minStack.push(number);<br>        } <span class="hljs-keyword">else</span> {<br>            minStack.push(Math.min(number, minStack.peek()));<br>        }<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {<br>        minStack.pop();<br>        <span class="hljs-keyword">return</span> stack.pop();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">min</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> minStack.peek();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="有效括号"><a href="#有效括号" class="headerlink" title="有效括号"></a>有效括号</h2><blockquote><p>给定一个字符串所表示的括号序列，包含以下字符： ‘(‘, ‘)’, ‘{‘, ‘}’, ‘[‘ and ‘]’，<br>判定是否是有效的括号序列。括号必须依照 “()” 顺序表示， “()[]{}” 是有效的括号，但 “([)]” 则是无效的括号。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidParentheses</span><span class="hljs-params">(String s)</span>{<br>        Stack&lt;Character&gt; stack=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Character&gt;();<br>        <span class="hljs-keyword">for</span>(Character c:s.toCharArray()){<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">"({["</span>.contains(String.valueOf(c))){<br>        stack.push(c);<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">if</span>(!stack.isEmpty()&amp;&amp;isValid(stack.peek(),c)){<br>        stack.pop();<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> stack.isEmpty();<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(<span class="hljs-type">char</span> c1,<span class="hljs-type">char</span> c2)</span>{<br>        <span class="hljs-keyword">return</span>(c1==<span class="hljs-string">'('</span>&amp;&amp;c2==<span class="hljs-string">')'</span>)||(c1==<span class="hljs-string">'{'</span>&amp;&amp;c2==<span class="hljs-string">'}'</span>)<br>        ||(c1==<span class="hljs-string">'['</span>&amp;&amp;c2==<span class="hljs-string">']'</span>);<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="用栈实现队列"><a href="#用栈实现队列" class="headerlink" title="用栈实现队列"></a>用栈实现队列</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyQueue</span> {<br>    <span class="hljs-keyword">private</span> Stack&lt;Integer&gt; outStack;<br>    <span class="hljs-keyword">private</span> Stack&lt;Integer&gt; inStack;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyQueue</span><span class="hljs-params">()</span> {<br>        outStack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Integer&gt;();<br>        inStack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Integer&gt;();<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">in2OutStack</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">while</span> (!inStack.isEmpty()) {<br>            outStack.push(inStack.pop());<br>        }<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> element)</span> {<br>        inStack.push(element);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">if</span> (outStack.isEmpty()) {<br>            <span class="hljs-built_in">this</span>.in2OutStack();<br>        }<br>        <span class="hljs-keyword">return</span> outStack.pop();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">top</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">if</span> (outStack.isEmpty()) {<br>            <span class="hljs-built_in">this</span>.in2OutStack();<br>        }<br>        <span class="hljs-keyword">return</span> outStack.peek();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="逆波兰表达式求值"><a href="#逆波兰表达式求值" class="headerlink" title="逆波兰表达式求值"></a>逆波兰表达式求值</h2><blockquote><p>在反向波兰表示法中计算算术表达式的值, [“2”, “1”, “+”, “3”, “*”] -&gt; (2 + 1) * 3 -&gt; 9</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">evalRPN</span><span class="hljs-params">(String[]tokens)</span>{<br>        Stack&lt;Integer&gt; s=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Integer&gt;();<br>        String operators=<span class="hljs-string">"+-*/"</span>;<br>        <span class="hljs-keyword">for</span>(String token:tokens){<br>        <span class="hljs-keyword">if</span>(!operators.contains(token)){<br>        s.push(Integer.valueOf(token));<br>        <span class="hljs-keyword">continue</span>;<br>        }<br><br>        <span class="hljs-type">int</span> a=s.pop();<br>        <span class="hljs-type">int</span> b=s.pop();<br>        <span class="hljs-keyword">if</span>(token.equals(<span class="hljs-string">"+"</span>)){<br>        s.push(b+a);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(token.equals(<span class="hljs-string">"-"</span>)){<br>        s.push(b-a);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(token.equals(<span class="hljs-string">"*"</span>)){<br>        s.push(b*a);<br>        }<span class="hljs-keyword">else</span>{<br>        s.push(b/a);<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> s.pop();<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="二分"><a href="#二分" class="headerlink" title="二分"></a>二分</h1><h2 id="二分搜索"><a href="#二分搜索" class="headerlink" title="二分搜索"></a>二分搜索</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">binarySearch</span><span class="hljs-params">(<span class="hljs-type">int</span>[]arr,<span class="hljs-type">int</span> start,<span class="hljs-type">int</span> end,<span class="hljs-type">int</span> hkey)</span>{<br>        <span class="hljs-keyword">if</span>(start&gt;end){<br>        <span class="hljs-keyword">return</span>-<span class="hljs-number">1</span>;<br>        }<br><br>        <span class="hljs-type">int</span> mid=start+(end-start)/<span class="hljs-number">2</span>;    <span class="hljs-comment">//防止溢位</span><br>        <span class="hljs-keyword">if</span>(arr[mid]&gt;hkey){<br>        <span class="hljs-keyword">return</span> binarySearch(arr,start,mid-<span class="hljs-number">1</span>,hkey);<br>        }<br>        <span class="hljs-keyword">if</span>(arr[mid]&lt;hkey){<br>        <span class="hljs-keyword">return</span> binarySearch(arr,mid+<span class="hljs-number">1</span>,end,hkey);<br>        }<br>        <span class="hljs-keyword">return</span> mid;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="X的平方根"><a href="#X的平方根" class="headerlink" title="X的平方根"></a>X的平方根</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sqrt</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span>{<br>        <span class="hljs-keyword">if</span>(x&lt; <span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(x&lt;=<span class="hljs-number">1</span>){<br>        <span class="hljs-keyword">return</span> x;<br>        }<br><br>        <span class="hljs-type">int</span> start=<span class="hljs-number">1</span>,end=x;<br>        <span class="hljs-comment">// 直接对答案可能存在的区间进行二分 =&gt; 二分答案</span><br>        <span class="hljs-keyword">while</span>(start+<span class="hljs-number">1</span>&lt;end){<br>        <span class="hljs-type">int</span> mid=start+(end-start)/<span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">if</span>(mid==x/mid){<br>        <span class="hljs-keyword">return</span> mid;<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(mid&lt;x /mid){<br>        start=mid;<br>        }<span class="hljs-keyword">else</span>{<br>        end=mid;<br>        }<br>        }<br>        <span class="hljs-keyword">if</span>(end&gt;x/end){<br>        <span class="hljs-keyword">return</span> start;<br>        }<br>        <span class="hljs-keyword">return</span> end;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h1><h2 id="两数之和"><a href="#两数之和" class="headerlink" title="两数之和"></a>两数之和</h2><blockquote><p>给一个整数数组，找到两个数使得他们的和等于一个给定的数 target。需要实现的函数twoSum需要返回这两个数的下标。</p></blockquote><p>用一个hashmap来记录，key记录target-numbers[i]的值，value记录numbers[i]的i的值，如果碰到一个<br>numbers[j]在hashmap中存在，那么说明前面的某个numbers[i]和numbers[j]的和为target，i和j即为答案</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[]twoSum(<span class="hljs-type">int</span>[]numbers,<span class="hljs-type">int</span> target){<br><br>        HashMap&lt;Integer, Integer&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;numbers.length;i++){<br>        <span class="hljs-keyword">if</span>(map.containsKey(numbers[i])){<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{map.get(numbers[i]),i};<br>        }<br>        map.put(target-numbers[i],i);<br>        }<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{};<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="连续数组"><a href="#连续数组" class="headerlink" title="连续数组"></a>连续数组</h2><blockquote><p>给一个二进制数组，找到 0 和 1 数量相等的子数组的最大长度</p></blockquote><p>使用一个数字sum维护到i为止1的数量与0的数量的差值。在loop<br>i的同时维护sum并将其插入hashmap中。对于某一个sum值，若hashmap中已有这个值，则当前的i与sum上一次出现的位置之间的序列0的数量与1的数量相同。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findMaxLength</span><span class="hljs-params">(<span class="hljs-type">int</span>[]nums)</span>{<br>        Map&lt;Integer, Integer&gt; prefix=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> sum=<span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> max=<span class="hljs-number">0</span>;<br>        prefix.put(<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>); <span class="hljs-comment">// 当第一个0 1数量相等的情况出现时，数组下标减去-1得到正确的长度</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;nums.length;i++){<br>        <span class="hljs-type">int</span> num=nums[i];<br>        <span class="hljs-keyword">if</span>(num==<span class="hljs-number">0</span>){<br>        sum--;<br>        }<span class="hljs-keyword">else</span>{<br>        sum++;<br>        }<br><br>        <span class="hljs-keyword">if</span>(prefix.containsKey(sum)){<br>        max=Math.max(max,i-prefix.get(sum));<br>        }<span class="hljs-keyword">else</span>{<br>        prefix.put(sum,i);<br>        }<br>        }<br><br>        <span class="hljs-keyword">return</span> max;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最长无重复字符的子串"><a href="#最长无重复字符的子串" class="headerlink" title="最长无重复字符的子串"></a>最长无重复字符的子串</h2><p>用HashMap记录每一个字母出现的位置。设定一个左边界, 到当前枚举到的位置之间的字符串为不含重复字符的子串。若新碰到的字符的上一次的位置在左边界右边,<br>则需要向右移动左边界</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lengthOfLongestSubstring</span><span class="hljs-params">(String s)</span>{<br>        <span class="hljs-keyword">if</span>(s==<span class="hljs-literal">null</span>||s.length()==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br>        HashMap&lt;Character, Integer&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> max=Integer.MIN_VALUE;<br>        <span class="hljs-type">int</span> start=-<span class="hljs-number">1</span>; <span class="hljs-comment">// 计算无重复字符子串开始的位置</span><br>        <span class="hljs-type">int</span> current=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;s.length();i++){<br>        <span class="hljs-keyword">if</span>(map.containsKey(s.charAt(i))){<br>        <span class="hljs-type">int</span> tmp=map.get(s.charAt(i));<br>        <span class="hljs-keyword">if</span>(tmp&gt;=start){ <span class="hljs-comment">// 上一次的位置在左边界右边, 则需要向右移动左边界</span><br>        start=tmp;<br>        }<br>        }<br><br>        map.put(s.charAt(i),i);<br>        max=Math.max(max,i-start);<br>        }<br>        <span class="hljs-keyword">return</span> max;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最多点在一条直线上"><a href="#最多点在一条直线上" class="headerlink" title="最多点在一条直线上"></a>最多点在一条直线上</h2><blockquote><p>给出二维平面上的n个点，求最多有多少点在同一条直线上</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {<br>    <span class="hljs-type">int</span> x;<br>    <span class="hljs-type">int</span> y;<br><br>    Point() {<br>        x = <span class="hljs-number">0</span>;<br>        y = <span class="hljs-number">0</span>;<br>    }<br><br>    Point(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b) {<br>        x = a;<br>        y = b;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>通过HashMap记录下两个点之间的斜率相同出现的次数，注意考虑点重合的情况</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxPoints</span><span class="hljs-params">(Point[]points)</span>{<br>        <span class="hljs-keyword">if</span>(points==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> max=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;points.length;i++){<br>        Map&lt;Double, Integer&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> maxPoints=<span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> overlap=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i+<span class="hljs-number">1</span>;j&lt;points.length;j++){<br>        <span class="hljs-keyword">if</span>(points[i].x==points[j].x&amp;&amp;points[i].y==points[j].y){<br>        overlap++; <span class="hljs-comment">// 两个点重合的情况记录下来</span><br>        <span class="hljs-keyword">continue</span>;<br>        }<br>        <span class="hljs-type">double</span> rate=(<span class="hljs-type">double</span>)(points[i].y-points[j].y)/(points[i].x-points[j].x);<br>        <span class="hljs-keyword">if</span>(map.containsKey(rate)){<br>        map.put(rate,map.get(rate)+<span class="hljs-number">1</span>);<br>        }<span class="hljs-keyword">else</span>{<br>        map.put(rate,<span class="hljs-number">2</span>);<br>        }<br>        maxPoints=Math.max(maxPoints,map.get(rate));<br>        }<br>        <span class="hljs-keyword">if</span>(maxPoints==<span class="hljs-number">0</span>)maxPoints=<span class="hljs-number">1</span>;<br>        max=Math.max(max,maxPoints+overlap);<br>        }<br>        <span class="hljs-keyword">return</span> max;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="堆-优先队列"><a href="#堆-优先队列" class="headerlink" title="堆 / 优先队列"></a>堆 / 优先队列</h1><h2 id="前K大的数"><a href="#前K大的数" class="headerlink" title="前K大的数"></a>前K大的数</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 维护一个 PriorityQueue，以返回前K的数</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[]topk(<span class="hljs-type">int</span>[]nums,<span class="hljs-type">int</span> k){<br>        <span class="hljs-type">int</span>[]result=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[k];<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-literal">null</span>||nums.length&lt;k){<br>        <span class="hljs-keyword">return</span> result;<br>        }<br><br>        Queue&lt;Integer&gt; pq=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> num:nums){<br>        pq.add(num);<br>        <span class="hljs-keyword">if</span>(pq.size()&gt;k){<br>        pq.poll();<br>        }<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=k-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">0</span>;i--){<br>        result[i]=pq.poll();<br>        }<br><br>        <span class="hljs-keyword">return</span> result;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="前K大的数II"><a href="#前K大的数II" class="headerlink" title="前K大的数II"></a>前K大的数II</h2><blockquote><p>实现一个数据结构，提供下面两个接口：1.add(number) 添加一个元素 2.topk() 返回前K大的数</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxSize;<br>    <span class="hljs-keyword">private</span> Queue&lt;Integer&gt; minheap;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Solution</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span> {<br>        minheap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();<br>        maxSize = k;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {<br>        <span class="hljs-keyword">if</span> (minheap.size() &lt; maxSize) {<br>            minheap.offer(num);<br>            <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span> (num &gt; minheap.peek()) {<br>            minheap.poll();<br>            minheap.offer(num);<br>        }<br>    }<br><br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">topk</span><span class="hljs-params">()</span> {<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">it</span> <span class="hljs-operator">=</span> minheap.iterator();<br>        List&lt;Integer&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;();<br>        <span class="hljs-keyword">while</span> (it.hasNext()) {<br>            result.add((Integer) it.next());<br>        }<br>        Collections.sort(result, Collections.reverseOrder());<br>        <span class="hljs-keyword">return</span> result;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="第K大的数"><a href="#第K大的数" class="headerlink" title="第K大的数"></a>第K大的数</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kthLargestElement</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span>[]nums)</span>{<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-literal">null</span>||nums.length==<span class="hljs-number">0</span>||k&lt; <span class="hljs-number">1</span>||k&gt;nums.length){<br>        <span class="hljs-keyword">return</span>-<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-keyword">return</span> partition(nums,<span class="hljs-number">0</span>,nums.length-<span class="hljs-number">1</span>,nums.length-k);<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[]nums,<span class="hljs-type">int</span> start,<span class="hljs-type">int</span> end,<span class="hljs-type">int</span> k)</span>{<br>        <span class="hljs-keyword">if</span>(start&gt;=end){<br>        <span class="hljs-keyword">return</span> nums[k];<br>        }<br><br>        <span class="hljs-type">int</span> left=start,right=end;<br>        <span class="hljs-type">int</span> pivot=nums[(start+end)/<span class="hljs-number">2</span>];<br><br>        <span class="hljs-keyword">while</span>(left&lt;=right){<br>        <span class="hljs-keyword">while</span>(left&lt;=right&amp;&amp;nums[left]&lt;pivot){<br>        left++;<br>        }<br>        <span class="hljs-keyword">while</span>(left&lt;=right&amp;&amp;nums[right]&gt;pivot){<br>        right--;<br>        }<br>        <span class="hljs-keyword">if</span>(left&lt;=right){<br>        swap(nums,left,right);<br>        left++;<br>        right--;<br>        }<br>        }<br><br>        <span class="hljs-keyword">if</span>(k&lt;=right){<br>        <span class="hljs-keyword">return</span> partition(nums,start,right,k);<br>        }<br>        <span class="hljs-keyword">if</span>(k&gt;=left){<br>        <span class="hljs-keyword">return</span> partition(nums,left,end,k);<br>        }<br>        <span class="hljs-keyword">return</span> nums[k];<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[]nums,<span class="hljs-type">int</span> i,<span class="hljs-type">int</span> j)</span>{<br>        <span class="hljs-type">int</span> tmp=nums[i];<br>        nums[i]=nums[j];<br>        nums[j]=tmp;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h1><h2 id="验证二叉搜索树"><a href="#验证二叉搜索树" class="headerlink" title="验证二叉搜索树"></a>验证二叉搜索树</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidBST</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">return</span> isValidBST(root,Long.MIN_VALUE,Long.MAX_VALUE);<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidBST</span><span class="hljs-params">(TreeNode root,<span class="hljs-type">long</span> min,<span class="hljs-type">long</span> max)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span>(root.val&lt;=min||root.val&gt;=max){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-keyword">return</span> isValidBST(root.left,min,root.val)&amp;&amp;isValidBST(root.right,root.val,max);<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="第K小的元素"><a href="#第K小的元素" class="headerlink" title="第K小的元素"></a>第K小的元素</h2><p>增加getCount方法来获取传入节点的子节点数（包括自己），从root节点开始判断k值和子节点数的大小决定递归路径是往左还是往右。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kthSmallest</span><span class="hljs-params">(TreeNode root,<span class="hljs-type">int</span> k)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> leftCount=getCount(root.left);<br>        <span class="hljs-keyword">if</span>(leftCount&gt;=k){<br>        <span class="hljs-keyword">return</span> kthSmallest(root.left,k);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(leftCount+<span class="hljs-number">1</span>==k){<br>        <span class="hljs-keyword">return</span> root.val;<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-keyword">return</span> kthSmallest(root.right,k-leftCount-<span class="hljs-number">1</span>);<br>        }<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">(TreeNode root)</span>{<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-keyword">return</span> getCount(root.left)+getCount(root.right)+<span class="hljs-number">1</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="数组-双指针"><a href="#数组-双指针" class="headerlink" title="数组 / 双指针"></a>数组 / 双指针</h1><h2 id="加一"><a href="#加一" class="headerlink" title="加一"></a>加一</h2><blockquote><p>给定一个非负数，表示一个数字数组，在该数的基础上+1，返回一个新的数组。该数字按照数位高低进行排列，最高位的数在列表的最前面。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[]plusOne(<span class="hljs-type">int</span>[]digits){<br>        <span class="hljs-type">int</span> carries=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=digits.length-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">0</span>&amp;&amp;carries&gt;<span class="hljs-number">0</span>;i--){<br>        <span class="hljs-type">int</span> sum=digits[i]+carries;<br>        digits[i]=sum%<span class="hljs-number">10</span>;<br>        carries=sum/<span class="hljs-number">10</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(carries==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> digits;<br>        }<br><br>        <span class="hljs-type">int</span>[]rst=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[digits.length+<span class="hljs-number">1</span>];<br>        rst[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;rst.length;i++){<br>        rst[i]=digits[i-<span class="hljs-number">1</span>];<br>        }<br>        <span class="hljs-keyword">return</span> rst;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="删除元素"><a href="#删除元素" class="headerlink" title="删除元素"></a>删除元素</h2><blockquote><p>给定一个数组和一个值，在原地删除与值相同的数字，返回新数组的长度。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">removeElement</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A,<span class="hljs-type">int</span> elem)</span>{<br>        <span class="hljs-keyword">if</span>(A==<span class="hljs-literal">null</span>||A.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> index=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;A.length;i++){<br>        <span class="hljs-keyword">if</span>(A[i]!=elem){<br>        A[index++]=A[i];<br>        }<br>        }<br><br>        <span class="hljs-keyword">return</span> index;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="删除排序数组中的重复数字"><a href="#删除排序数组中的重复数字" class="headerlink" title="删除排序数组中的重复数字"></a>删除排序数组中的重复数字</h2><blockquote><p>在原数组中“删除”重复出现的数字，使得每个元素只出现一次，并且返回“新”数组的长度。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">removeDuplicates</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A)</span>{<br>        <span class="hljs-keyword">if</span>(A==<span class="hljs-literal">null</span>||A.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> size=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;A.length;i++){<br>        <span class="hljs-keyword">if</span>(A[i]!=A[size]){<br>        A[++size]=A[i];<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> size+<span class="hljs-number">1</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="我的日程安排表-I"><a href="#我的日程安排表-I" class="headerlink" title="我的日程安排表 I"></a>我的日程安排表 I</h2><blockquote><p>实现MyCalendar类来存储活动。如果新添加的活动没有重复，则可以添加。类将有方法book(int start，int end)。这代表左闭右开的间隔[<br>start，end)有了预定，范围内的实数x，都满足start &lt;= x &lt; end，返回true。 否则，返回false，并且事件不会添加到日历中。</p></blockquote><p>TreeMap 是一个有序的key-value集合，它通过 <a href="http://www.cnblogs.com/skywang12345/p/3245399.html">红黑树</a><br>实现，继承于AbstractMap，所以它是一个Map，即一个key-value集合。TreeMap可以查询小于等于某个值的最大的key，也可查询大于等于某个值的最小的key。<br>元素的顺序可以改变，并且对新的数组不会有影响。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCalendar</span> {<br>    TreeMap&lt;Integer, Integer&gt; calendar;<br><br>    MyCalendar() {<br>        calendar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">book</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> calendar.floorKey(start), next = calendar.ceilingKey(start);<br>        <span class="hljs-keyword">if</span> ((previous == <span class="hljs-literal">null</span> || calendar.get(previous) &lt;= start) &amp;&amp; (next == <span class="hljs-literal">null</span> || end &lt;= next)) {<br>            calendar.put(start, end);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="合并排序数组"><a href="#合并排序数组" class="headerlink" title="合并排序数组"></a>合并排序数组</h2><blockquote><p>合并两个排序的整数数组A和B变成一个新的数组。可以假设A具有足够的空间去添加B中的元素。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeSortedArray</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A,<span class="hljs-type">int</span> m,<span class="hljs-type">int</span>[]B,<span class="hljs-type">int</span> n)</span>{<br>        <span class="hljs-type">int</span> i=m-<span class="hljs-number">1</span>,j=n-<span class="hljs-number">1</span>,index=m+n-<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(i&gt;=<span class="hljs-number">0</span>&amp;&amp;j&gt;=<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">if</span>(A[i]&gt;B[j]){<br>        A[index--]=A[i--];<br>        }<span class="hljs-keyword">else</span>{<br>        A[index--]=B[j--];<br>        }<br>        }<br>        <span class="hljs-keyword">while</span>(i&gt;=<span class="hljs-number">0</span>){<br>        A[index--]=A[i--];<br>        }<br>        <span class="hljs-keyword">while</span>(j&gt;=<span class="hljs-number">0</span>){<br>        A[index--]=B[j--];<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="贪心"><a href="#贪心" class="headerlink" title="贪心"></a>贪心</h1><h2 id="买卖股票的最佳时机"><a href="#买卖股票的最佳时机" class="headerlink" title="买卖股票的最佳时机"></a>买卖股票的最佳时机</h2><blockquote><p>假设有一个数组，它的第i个元素是一支给定的股票在第i天的价格。如果你最多只允许完成一次交易(例如，一次买卖股票)<br>，设计一个算法来找出最大利润。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProfit</span><span class="hljs-params">(<span class="hljs-type">int</span>[]prices)</span>{<br>        <span class="hljs-keyword">if</span>(prices==<span class="hljs-literal">null</span>||prices.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> min=Integer.MAX_VALUE;  <span class="hljs-comment">//记录最低的价格</span><br>        <span class="hljs-type">int</span> profit=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> price:prices){<br>        min=Math.min(price,min);<br>        profit=Math.max(price-min,profit);<br>        }<br><br>        <span class="hljs-keyword">return</span> profit;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="买卖股票的最佳时机-II"><a href="#买卖股票的最佳时机-II" class="headerlink" title="买卖股票的最佳时机 II"></a>买卖股票的最佳时机 II</h2><blockquote><p>给定一个数组 prices 表示一支股票每天的价格。可以完成任意次数的交易, 不过不能同时参与多个交易，设计一个算法求出最大的利润。</p></blockquote><p>贪心：只要相邻的两天股票的价格是上升的, 我们就进行一次交易, 获得一定利润。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProfit</span><span class="hljs-params">(<span class="hljs-type">int</span>[]prices)</span>{<br>        <span class="hljs-type">int</span> profit=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;prices.length-<span class="hljs-number">1</span>;i++){<br>        <span class="hljs-type">int</span> diff=prices[i+<span class="hljs-number">1</span>]-prices[i];<br>        <span class="hljs-keyword">if</span>(diff&gt;<span class="hljs-number">0</span>){<br>        profit+=diff;<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> profit;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最大子数组"><a href="#最大子数组" class="headerlink" title="最大子数组"></a>最大子数组</h2><blockquote><p>给定一个整数数组，找到一个具有最大和的子数组，返回其最大和。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxSubArray</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A)</span>{<br>        <span class="hljs-keyword">if</span>(A==<span class="hljs-literal">null</span>||A.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br>        <span class="hljs-comment">//max记录全局最大值，sum记录区间和，如果当前sum&gt;0，那么可以继续和后面的数求和，否则就从0开始</span><br>        <span class="hljs-type">int</span> max=Integer.MIN_VALUE,sum=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;A.length;i++){<br>        sum+=A[i];<br>        max=Math.max(max,sum);<br>        sum=Math.max(sum,<span class="hljs-number">0</span>);<br>        }<br><br>        <span class="hljs-keyword">return</span> max;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="主元素"><a href="#主元素" class="headerlink" title="主元素"></a>主元素</h2><p>给定一个整型数组，找出主元素，它在数组中的出现次数严格大于数组元素个数的二分之一(可以假设数组非空，且数组中总是存在主元素)。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">majorityNumber</span><span class="hljs-params">(List&lt;Integer&gt; nums)</span>{<br>        <span class="hljs-type">int</span> currentMajor=<span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> count=<span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span>(Integer num:nums){<br>        <span class="hljs-keyword">if</span>(count==<span class="hljs-number">0</span>){<br>        currentMajor=num;<br>        }<br><br>        <span class="hljs-keyword">if</span>(num==currentMajor){<br>        count++;<br>        }<span class="hljs-keyword">else</span>{<br>        count--;<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> currentMajor;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h1><h2 id="生成括号"><a href="#生成括号" class="headerlink" title="生成括号"></a>生成括号</h2><blockquote><p>给定 n，表示有 n 对括号, 请写一个函数以将其生成所有的括号组合，并返回组合结果。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">generateParenthesis</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>{<br>        List&lt;String&gt; res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        helper(n,n,<span class="hljs-string">""</span>,res);<br>        <span class="hljs-keyword">return</span> res;<br>        }<br><br><span class="hljs-comment">// DFS</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">helper</span><span class="hljs-params">(<span class="hljs-type">int</span> nL,<span class="hljs-type">int</span> nR,String parenthesis,List&lt;String&gt; res)</span>{<br>        <span class="hljs-comment">// nL 和 nR 分别代表左右括号剩余的数量</span><br>        <span class="hljs-keyword">if</span>(nL&lt; <span class="hljs-number">0</span>||nR&lt; <span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span>(nL==<span class="hljs-number">0</span>&amp;&amp;nR==<span class="hljs-number">0</span>){<br>        res.add(parenthesis);<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        helper(nL-<span class="hljs-number">1</span>,nR,parenthesis+<span class="hljs-string">"("</span>,res);<br>        <span class="hljs-keyword">if</span>(nL&gt;=nR){<br>        <span class="hljs-keyword">return</span>;<br>        }<br>        helper(nL,nR-<span class="hljs-number">1</span>,parenthesis+<span class="hljs-string">")"</span>,res);<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="Excel表列标题"><a href="#Excel表列标题" class="headerlink" title="Excel表列标题"></a>Excel表列标题</h2><blockquote><p>给定一个正整数，返回相应的列标题，如Excel表中所示。如1 -&gt; A，2 -&gt; B…26 -&gt; Z，27 -&gt; AA</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">convertToTitle</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>{<br>        StringBuilder str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">while</span>(n&gt;<span class="hljs-number">0</span>){<br>        n--;<br>        str.append((<span class="hljs-type">char</span>)((n%<span class="hljs-number">26</span>)+<span class="hljs-string">'A'</span>));<br>        n/=<span class="hljs-number">26</span>;<br>        }<br>        <span class="hljs-keyword">return</span> str.reverse().toString();<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="翻转游戏"><a href="#翻转游戏" class="headerlink" title="翻转游戏"></a>翻转游戏</h2><blockquote><p>翻转游戏：给定一个只包含两种字符的字符串：+和-，你和你的小伙伴轮流翻转”++”变成”–”<br>。当一个人无法采取行动时游戏结束，另一个人将是赢家。编写一个函数，计算字符串在一次有效移动后的所有可能状态。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">generatePossibleNextMoves</span><span class="hljs-params">(String s)</span>{<br>        List list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=-<span class="hljs-number">1</span>;(i=s.indexOf(<span class="hljs-string">"++"</span>,i+<span class="hljs-number">1</span>))&gt;=<span class="hljs-number">0</span>;){<br>        list.add(s.substring(<span class="hljs-number">0</span>,i)+<span class="hljs-string">"--"</span>+s.substring(i+<span class="hljs-number">2</span>));<br>        }<br>        <span class="hljs-keyword">return</span> list;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="翻转字符串中的单词"><a href="#翻转字符串中的单词" class="headerlink" title="翻转字符串中的单词"></a>翻转字符串中的单词</h2><blockquote><p>给定一个字符串，逐个翻转字符串中的每个单词。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">reverseWords</span><span class="hljs-params">(String s)</span>{<br>        <span class="hljs-keyword">if</span>(s.length()==<span class="hljs-number">0</span>||s==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">" "</span>;<br>        }<br>        <span class="hljs-comment">//按照空格将s切分</span><br>        String[]array=s.split(<span class="hljs-string">" "</span>);<br>        StringBuilder sb=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-comment">//从后往前遍历array，在sb中插入单词</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=array.length-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">0</span>;i--){<br>        <span class="hljs-keyword">if</span>(!array[i].equals(<span class="hljs-string">""</span>)){<br>        <span class="hljs-keyword">if</span>(sb.length()&gt;<span class="hljs-number">0</span>){<br>        sb.append(<span class="hljs-string">" "</span>);<br>        }<br><br>        sb.append(array[i]);<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> sb.toString();<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="转换字符串到整数"><a href="#转换字符串到整数" class="headerlink" title="转换字符串到整数"></a>转换字符串到整数</h2><blockquote><p>实现atoi这个函数，将一个字符串转换为整数。如果没有合法的整数，返回0。如果整数超出了32位整数的范围，返回INT_MAX(2147483647)<br>如果是正整数，或者INT_MIN(-2147483648)如果是负整数。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAtoi</span><span class="hljs-params">(String str)</span>{<br>        <span class="hljs-keyword">if</span>(str==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br>        str=str.trim();<br>        <span class="hljs-keyword">if</span>(str.length()==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        }<br><br>        <span class="hljs-type">int</span> sign=<span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> index=<span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">if</span>(str.charAt(index)==<span class="hljs-string">'+'</span>){<br>        index++;<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(str.charAt(index)==<span class="hljs-string">'-'</span>){<br>        sign=-<span class="hljs-number">1</span>;<br>        index++;<br>        }<br>        <span class="hljs-type">long</span> num=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(;index&lt;str.length();index++){<br>        <span class="hljs-keyword">if</span>(str.charAt(index)&lt; <span class="hljs-string">'0'</span>||str.charAt(index)&gt;<span class="hljs-string">'9'</span>){<br>        <span class="hljs-keyword">break</span>;<br>        }<br>        num=num*<span class="hljs-number">10</span>+(str.charAt(index)-<span class="hljs-string">'0'</span>);<br>        <span class="hljs-keyword">if</span>(num&gt;Integer.MAX_VALUE){<br>        <span class="hljs-keyword">break</span>;<br>        }<br>        }<br>        <span class="hljs-keyword">if</span>(num*sign&gt;=Integer.MAX_VALUE){<br>        <span class="hljs-keyword">return</span> Integer.MAX_VALUE;<br>        }<br>        <span class="hljs-keyword">if</span>(num*sign&lt;=Integer.MIN_VALUE){<br>        <span class="hljs-keyword">return</span> Integer.MIN_VALUE;<br>        }<br>        <span class="hljs-keyword">return</span>(<span class="hljs-type">int</span>)num*sign;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="最长公共前缀"><a href="#最长公共前缀" class="headerlink" title="最长公共前缀"></a>最长公共前缀</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">longestCommonPrefix</span><span class="hljs-params">(String[]strs)</span>{<br>        <span class="hljs-keyword">if</span>(strs==<span class="hljs-literal">null</span>||strs.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">""</span>;<br>        }<br>        String prefix=strs[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;strs.length;i++){<br>        <span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span>(j&lt;strs[i].length()&amp;&amp;j&lt;prefix.length()&amp;&amp;strs[i].charAt(j)==prefix.charAt(j)){<br>        j++;<br>        }<br>        <span class="hljs-keyword">if</span>(j==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span><span class="hljs-string">""</span>;<br>        }<br>        prefix=prefix.substring(<span class="hljs-number">0</span>,j);<br>        }<br>        <span class="hljs-keyword">return</span> prefix;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="回文数"><a href="#回文数" class="headerlink" title="回文数"></a>回文数</h2><blockquote><p>判断一个正整数是不是回文数。回文数的定义是，将这个数反转之后，得到的数仍然是同一个数。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">palindromeNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span>{<br>        <span class="hljs-comment">// Write your code here</span><br>        <span class="hljs-keyword">if</span>(num&lt; <span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-type">int</span> div=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(num/div&gt;=<span class="hljs-number">10</span>){<br>        div*=<span class="hljs-number">10</span>;<br>        }<br>        <span class="hljs-keyword">while</span>(num&gt;<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">if</span>(num/div!=num%<span class="hljs-number">10</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        num=(num%div)/<span class="hljs-number">10</span>;<br>        div/=<span class="hljs-number">100</span>;<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h1><h2 id="单词拆分"><a href="#单词拆分" class="headerlink" title="单词拆分"></a>单词拆分</h2><blockquote><p>给定字符串 s 和单词字典 dict，确定 s 是否可以分成一个或多个以空格分隔的子串，并且这些子串都在字典中存在。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">wordBreak</span><span class="hljs-params">(String s,Set&lt;String&gt; dict)</span>{<br>        <span class="hljs-comment">// write your code here</span><br>        <span class="hljs-type">int</span> maxLength=getMaxLength(dict);<br><br>        <span class="hljs-comment">// 长度为n的单词 有n + 1个切割点 比如: _l_i_n_t_</span><br>        <span class="hljs-type">boolean</span>[]canBreak=<span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[s.length()+<span class="hljs-number">1</span>];<br>        <span class="hljs-comment">// 当s长度为0时</span><br>        canBreak[<span class="hljs-number">0</span>]=<span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;canBreak.length;i++){<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=maxLength&amp;&amp;j&lt;=i;j++){<br>        <span class="hljs-comment">//i - j 表示从 i 点开始往前j个点的位置</span><br>        String str=s.substring(i-j,i);<br>        <span class="hljs-comment">//如果此str在词典中 并且 str之前的 字符串可以拆分     </span><br>        <span class="hljs-keyword">if</span>(dict.contains(str)&amp;&amp;canBreak[i-j]){<br>        canBreak[i]=<span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">break</span>;<br>        }<br>        }<br>        }<br><br>        <span class="hljs-keyword">return</span> canBreak[canBreak.length-<span class="hljs-number">1</span>];<br>        }<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMaxLength</span><span class="hljs-params">(Set&lt;String&gt; dict)</span>{<br>        <span class="hljs-type">int</span> max=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(String s:dict){<br>        max=Math.max(max,s.length());<br>        }<br>        <span class="hljs-keyword">return</span> max;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="爬楼梯"><a href="#爬楼梯" class="headerlink" title="爬楼梯"></a>爬楼梯</h2><blockquote><p>假设你正在爬楼梯，需要n步你才能到达顶部。但每次你只能爬一步或者两步，你能有多少种不同的方法爬到楼顶部？</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">climbStairs</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>{<br>        <span class="hljs-keyword">if</span>(n==<span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span>[]array=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n+<span class="hljs-number">1</span>];<br>        array[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span>(array.length&gt;<span class="hljs-number">1</span>){<br>        array[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;array.length;i++){<br>        array[i]=array[i-<span class="hljs-number">1</span>]+array[i-<span class="hljs-number">2</span>];<br>        }<br>        <span class="hljs-keyword">return</span> array[n];<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="打劫房屋"><a href="#打劫房屋" class="headerlink" title="打劫房屋"></a>打劫房屋</h2><blockquote><p>假设你是一个专业的窃贼，准备沿着一条街打劫房屋。每个房子都存放着特定金额的钱。你面临的唯一约束条件是：相邻的房子装着相互联系的防盗系统，且<br>当相邻的两个房子同一天被打劫时，该系统会自动报警。给定一个非负整数列表，表示每个房子中存放的钱， 算一算，如果今晚去打劫，在不触动报警装置的情况下,<br>你最多可以得到多少钱 。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">houseRobber</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A)</span>{<br>        <span class="hljs-keyword">if</span>(A.length==<span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">long</span>[]res=<span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[A.length+<span class="hljs-number">1</span>];<br>        res[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;<br>        res[<span class="hljs-number">1</span>]=A[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;res.length;i++){<br>        res[i]=Math.max(res[i-<span class="hljs-number">2</span>]+A[i-<span class="hljs-number">1</span>],res[i-<span class="hljs-number">1</span>]);<br>        }<br>        <span class="hljs-keyword">return</span> res[A.length];<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="编辑距离"><a href="#编辑距离" class="headerlink" title="编辑距离"></a>编辑距离</h2><blockquote><p>给出两个单词word1和word2，计算出将word1 转换为word2的最少操作次数。你总共三种操作方法：插入一个字符、删除一个字符、替换一个字符。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">minDistance</span><span class="hljs-params">(String word1,String word2)</span>{<br>        <span class="hljs-comment">// write your code here</span><br>        <span class="hljs-type">int</span> n=word1.length();<br>        <span class="hljs-type">int</span> m=word2.length();<br>        <span class="hljs-type">int</span>[][]dp=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n+<span class="hljs-number">1</span>][m+<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n +<span class="hljs-number">1</span>;i++){<br>        dp[i][<span class="hljs-number">0</span>]=i;<br>        }<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;m +<span class="hljs-number">1</span>;j++){<br>        dp[<span class="hljs-number">0</span>][j]=j;<br>        }<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n +<span class="hljs-number">1</span>;i++){<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;m +<span class="hljs-number">1</span>;j++){<br>        <span class="hljs-keyword">if</span>(word1.charAt(i-<span class="hljs-number">1</span>)==word2.charAt(j-<span class="hljs-number">1</span>)){<br>        dp[i][j]=dp[i-<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>];<br>        }<span class="hljs-keyword">else</span>{<br>        dp[i][j]=<span class="hljs-number">1</span>+Math.min(dp[i-<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>],Math.min(dp[i][j-<span class="hljs-number">1</span>],dp[i-<span class="hljs-number">1</span>][j]));<br>        }<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> dp[n][m];<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="乘积最大子序列"><a href="#乘积最大子序列" class="headerlink" title="乘积最大子序列"></a>乘积最大子序列</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProduct</span><span class="hljs-params">(List&lt;Integer&gt; nums)</span>{<br>        <span class="hljs-comment">// 分别记录正数最大值和负数最小值</span><br>        <span class="hljs-type">int</span>[]max=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[nums.size()];<br>        <span class="hljs-type">int</span>[]min=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[nums.size()];<br><br>        min[<span class="hljs-number">0</span>]=max[<span class="hljs-number">0</span>]=nums.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">int</span> result=nums.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;nums.size();i++){<br>        min[i]=max[i]=nums.get(i);<br>        <span class="hljs-keyword">if</span>(nums.get(i)&gt;<span class="hljs-number">0</span>){<br>        max[i]=Math.max(max[i],max[i-<span class="hljs-number">1</span>]*nums.get(i));<br>        min[i]=Math.min(min[i],min[i-<span class="hljs-number">1</span>]*nums.get(i));<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums.get(i)&lt; <span class="hljs-number">0</span>){<br>        max[i]=Math.max(max[i],min[i-<span class="hljs-number">1</span>]*nums.get(i));<br>        min[i]=Math.min(min[i],max[i-<span class="hljs-number">1</span>]*nums.get(i));<br>        }<br><br>        result=Math.max(result,max[i]);<br>        }<br><br>        <span class="hljs-keyword">return</span> result;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="矩阵"><a href="#矩阵" class="headerlink" title="矩阵"></a>矩阵</h1><h2 id="螺旋矩阵"><a href="#螺旋矩阵" class="headerlink" title="螺旋矩阵"></a>螺旋矩阵</h2><blockquote><p>给定一个包含 m x n 个要素的矩阵，（m 行, n 列），按照螺旋顺序，返回该矩阵中的所有要素。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">spiralOrder</span><span class="hljs-params">(<span class="hljs-type">int</span>[][]matrix)</span>{<br>        ArrayList&lt;Integer&gt; rst=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;();<br>        <span class="hljs-keyword">if</span>(matrix==<span class="hljs-literal">null</span>||matrix.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span> rst;<br>        }<br><br>        <span class="hljs-type">int</span> rows=matrix.length;<br>        <span class="hljs-type">int</span> cols=matrix[<span class="hljs-number">0</span>].length;<br>        <span class="hljs-type">int</span> count=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span>(count*<span class="hljs-number">2</span>&lt;rows &amp;&amp;count*<span class="hljs-number">2</span>&lt;cols){<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=count;i&lt;cols -count;i++){<br>        rst.add(matrix[count][i]);<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=count+<span class="hljs-number">1</span>;i&lt;rows -count;i++){<br>        rst.add(matrix[i][cols-count-<span class="hljs-number">1</span>]);<br>        }<br><br>        <span class="hljs-keyword">if</span>(rows-<span class="hljs-number">2</span>*count==<span class="hljs-number">1</span>||cols-<span class="hljs-number">2</span>*count==<span class="hljs-number">1</span>){ <span class="hljs-comment">// 如果只剩1行或1列</span><br>        <span class="hljs-keyword">break</span>;<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=cols-count-<span class="hljs-number">2</span>;i&gt;=count;i--){<br>        rst.add(matrix[rows-count-<span class="hljs-number">1</span>][i]);<br>        }<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=rows-count-<span class="hljs-number">2</span>;i&gt;=count+<span class="hljs-number">1</span>;i--){<br>        rst.add(matrix[i][count]);<br>        }<br><br>        count++;<br>        }<br>        <span class="hljs-keyword">return</span> rst;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="判断数独是否合法"><a href="#判断数独是否合法" class="headerlink" title="判断数独是否合法"></a>判断数独是否合法</h2><blockquote><p>请判定一个数独是否有效。该数独可能只填充了部分数字，其中缺少的数字用 . 表示。</p></blockquote><p>维护一个HashSet用来记同一行、同一列、同一九宫格是否存在相同数字</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidSudoku</span><span class="hljs-params">(<span class="hljs-type">char</span>[][]board)</span>{<br>        Set seen=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">9</span>;++i){<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">9</span>;++j){<br>        <span class="hljs-type">char</span> number=board[i][j];<br>        <span class="hljs-keyword">if</span>(number!=<span class="hljs-string">'.'</span>)<br>        <span class="hljs-keyword">if</span>(!seen.add(number+<span class="hljs-string">" in row "</span>+i)||<br>        !seen.add(number+<span class="hljs-string">" in column "</span>+j)||<br>        !seen.add(number+<span class="hljs-string">" in block "</span>+i/<span class="hljs-number">3</span>+<span class="hljs-string">"-"</span>+j/<span class="hljs-number">3</span>))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="旋转图像"><a href="#旋转图像" class="headerlink" title="旋转图像"></a>旋转图像</h2><blockquote><p>给定一个N×N的二维矩阵表示图像，90度顺时针旋转图像。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rotate</span><span class="hljs-params">(<span class="hljs-type">int</span>[][]matrix)</span>{<br>        <span class="hljs-keyword">if</span>(matrix==<span class="hljs-literal">null</span>||matrix.length==<span class="hljs-number">0</span>||matrix[<span class="hljs-number">0</span>].length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span>;<br>        }<br><br>        <span class="hljs-type">int</span> length=matrix.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;length /<span class="hljs-number">2</span>;i++){<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt; (length+<span class="hljs-number">1</span>)/<span class="hljs-number">2</span>;j++){<br>        <span class="hljs-type">int</span> tmp=matrix[i][j];<br>        matrix[i][j]=matrix[length-j-<span class="hljs-number">1</span>][i];<br>        matrix[length-j-<span class="hljs-number">1</span>][i]=matrix[length-i-<span class="hljs-number">1</span>][length-j-<span class="hljs-number">1</span>];<br>        matrix[length-i-<span class="hljs-number">1</span>][length-j-<span class="hljs-number">1</span>]=matrix[j][length-i-<span class="hljs-number">1</span>];<br>        matrix[j][length-i-<span class="hljs-number">1</span>]=tmp;<br>        }<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="二进制-位运算"><a href="#二进制-位运算" class="headerlink" title="二进制 / 位运算"></a>二进制 / 位运算</h1><h2 id="落单的数"><a href="#落单的数" class="headerlink" title="落单的数"></a>落单的数</h2><blockquote><p>给出 2 * n + 1个数字，除其中一个数字之外其他每个数字均出现两次，找到这个数字。</p></blockquote><p>异或运算具有很好的性质，相同数字异或运算后为0，并且具有交换律和结合律，故将所有数字异或运算后即可得到只出现一次的数字。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">singleNumber</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A)</span>{<br>        <span class="hljs-keyword">if</span>(A==<span class="hljs-literal">null</span>||A.length==<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">return</span>-<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-type">int</span> rst=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;A.length;i++){<br>        rst^=A[i];<br>        }<br>        <span class="hljs-keyword">return</span> rst;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="格雷编码"><a href="#格雷编码" class="headerlink" title="格雷编码"></a>格雷编码</h2><blockquote><p>格雷编码是一个二进制数字系统，在该系统中，两个连续的数值仅有一个二进制的差异。给定一个非负整数 n<br>，表示该代码中所有二进制的总数，请找出其格雷编码顺序。一个格雷编码顺序必须以 0 开始，并覆盖所有的 2n<br>个整数。例子——输入：2；输出：[0, 1, 3, 2]；解释: 0 - 00，1 - 01，3 - 11，2 - 10</p></blockquote><p>格雷码生成公式：G(i) = i ^ (i &gt;&gt; 2)</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ArrayList&lt;Integer&gt; <span class="hljs-title function_">grayCode</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>{<br>        ArrayList&lt;Integer&gt; result=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt; (<span class="hljs-number">1</span>&lt;&lt;n);i++){<br>        result.add(i^(i&gt;&gt;<span class="hljs-number">1</span>));<br>        }<br>        <span class="hljs-keyword">return</span> result;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="反转整数"><a href="#反转整数" class="headerlink" title="反转整数"></a>反转整数</h2><blockquote><p>将一个整数中的数字进行颠倒，当颠倒后的整数溢出时，返回 0 (标记为 32 位整数)。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">reverseInteger</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>{<br>        <span class="hljs-type">int</span> reversed_n=<span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">while</span>(n!=<span class="hljs-number">0</span>){<br>        <span class="hljs-type">int</span> temp=reversed_n*<span class="hljs-number">10</span>+n%<span class="hljs-number">10</span>;<br>        n=n/<span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">if</span>(temp/<span class="hljs-number">10</span>!=reversed_n){<br>        reversed_n=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">break</span>;<br>        }<br>        reversed_n=temp;<br>        }<br>        <span class="hljs-keyword">return</span> reversed_n;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="LRU缓存策略"><a href="#LRU缓存策略" class="headerlink" title="LRU缓存策略"></a>LRU缓存策略</h2><blockquote><p>为最近最少使用（LRU）缓存策略设计一个数据结构，它应该支持以下操作：获取数据（get）和写入数据（set）。获取数据get(key)<br>：如果缓存中存在key，则获取其数据值（通常是正数），否则返回-1。 写入数据set(key, value)<br>：如果key还没有在缓存中，则写入其数据值。当缓存达到上限，它应该在写入新数据之前删除最近最少使用的数据用来腾出空闲位置。</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> {<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {<br>        Node prev;<br>        Node next;<br>        <span class="hljs-type">int</span> key;<br>        <span class="hljs-type">int</span> value;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Node</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> {<br>            <span class="hljs-built_in">this</span>.key = key;<br>            <span class="hljs-built_in">this</span>.value = value;<br>            <span class="hljs-built_in">this</span>.prev = <span class="hljs-literal">null</span>;<br>            <span class="hljs-built_in">this</span>.next = <span class="hljs-literal">null</span>;<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<br>    <span class="hljs-keyword">private</span> HashMap&lt;Integer, Node&gt; hs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Integer, Node&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">tail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {<br>        <span class="hljs-built_in">this</span>.capacity = capacity;<br>        tail.prev = head;<br>        head.next = tail;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span> {<br>      <span class="hljs-keyword">if</span> (!hs.containsKey(key)) {            <span class="hljs-comment">//key找不到</span><br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        }<br><br>        <span class="hljs-comment">// remove current</span><br>        <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> hs.get(key);<br>        current.prev.next = current.next;<br>        current.next.prev = current.prev;<br><br>        <span class="hljs-comment">// move current to tail</span><br>      move_to_tail(current);            <span class="hljs-comment">//每次get，使用次数+1，最近使用，放于尾部</span><br><br>        <span class="hljs-keyword">return</span> hs.get(key).value;<br>    }<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> {            <span class="hljs-comment">//数据放入缓存</span><br>        <span class="hljs-comment">// get 这个方法会把key挪到最末端，因此，不需要再调用 move_to_tail</span><br>        <span class="hljs-keyword">if</span> (get(key) != -<span class="hljs-number">1</span>) {<br>            hs.get(key).value = value;<br>            <span class="hljs-keyword">return</span>;<br>        }<br><br>    <span class="hljs-keyword">if</span> (hs.size() == capacity) {        <span class="hljs-comment">//超出缓存上限</span><br>      hs.remove(head.next.key);        <span class="hljs-comment">//删除头部数据</span><br>            head.next = head.next.next;<br>            head.next.prev = head;<br>        }<br><br>    <span class="hljs-type">Node</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(key, value);        <span class="hljs-comment">//新建节点</span><br>        hs.put(key, insert);<br>    move_to_tail(insert);                    <span class="hljs-comment">//放于尾部</span><br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">move_to_tail</span><span class="hljs-params">(Node current)</span> {    <span class="hljs-comment">//移动数据至尾部</span><br>        current.prev = tail.prev;<br>        tail.prev = current;<br>        current.prev.next = current;<br>        current.next = tail;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一些LiveData粘性事件解决方案</title>
    <link href="/2023/08/24/docs/android/zhi-shi-bi-ji/yi-xie-livedata-nian-xing-shi-jian-jie-jue-fang-an/"/>
    <url>/2023/08/24/docs/android/zhi-shi-bi-ji/yi-xie-livedata-nian-xing-shi-jian-jie-jue-fang-an/</url>
    
    <content type="html"><![CDATA[<h3 id="BusMutableLiveData"><a href="#BusMutableLiveData" class="headerlink" title="BusMutableLiveData"></a>BusMutableLiveData</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br><span class="hljs-keyword">import</span> androidx.lifecycle.LifecycleOwner;<br><span class="hljs-keyword">import</span> androidx.lifecycle.LiveData;<br><span class="hljs-keyword">import</span> androidx.lifecycle.MutableLiveData;<br><span class="hljs-keyword">import</span> androidx.lifecycle.Observer;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusMutableLiveData</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MutableLiveData</span>&lt;T&gt; {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">observe</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LifecycleOwner owner, <span class="hljs-meta">@NonNull</span> Observer&lt;? <span class="hljs-built_in">super</span> T&gt; observer)</span> {<br>        <span class="hljs-built_in">super</span>.observe(owner, observer);<br>        hook(observer);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hook</span><span class="hljs-params">(Observer&lt;? <span class="hljs-built_in">super</span> T&gt; observer)</span> {<br>        Class&lt;LiveData&gt; liveDataClass = LiveData.class;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//获取field private SafeIterableMap&lt;Observer&lt;T&gt;, ObserverWrapper&gt; mObservers</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mObservers</span> <span class="hljs-operator">=</span> liveDataClass.getDeclaredField(<span class="hljs-string">"mObservers"</span>);<br>            mObservers.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">//获取SafeIterableMap集合mObservers</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">observers</span> <span class="hljs-operator">=</span> mObservers.get(<span class="hljs-built_in">this</span>);<br>            Class&lt;?&gt; observersClass = Objects.requireNonNull(observers).getClass();<br>            <span class="hljs-comment">//获取SafeIterableMap的get(Object obj)方法</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">methodGet</span> <span class="hljs-operator">=</span> observersClass.getDeclaredMethod(<span class="hljs-string">"get"</span>, Object.class);<br>            methodGet.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">//获取到observer在集合中对应的ObserverWrapper对象</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectWrapperEntry</span> <span class="hljs-operator">=</span> methodGet.invoke(observers, observer);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (objectWrapperEntry <span class="hljs-keyword">instanceof</span> Map.Entry) {<br>                objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();<br>            }<br>            <span class="hljs-keyword">if</span> (objectWrapper == <span class="hljs-literal">null</span>) {<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"ObserverWrapper can not be null"</span>);<br>            }<br>            <span class="hljs-comment">//获取ObserverWrapper的Class对象  LifecycleBoundObserver extends ObserverWrapper</span><br>            Class&lt;?&gt; wrapperClass = objectWrapper.getClass().getSuperclass();<br>            <span class="hljs-comment">//获取ObserverWrapper的field mLastVersion</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mLastVersion</span> <span class="hljs-operator">=</span> Objects.requireNonNull(wrapperClass).getDeclaredField(<span class="hljs-string">"mLastVersion"</span>);<br>            mLastVersion.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">//获取liveData的field mVersion</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mVersion</span> <span class="hljs-operator">=</span> liveDataClass.getDeclaredField(<span class="hljs-string">"mVersion"</span>);<br>            mVersion.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">mV</span> <span class="hljs-operator">=</span> mVersion.get(<span class="hljs-built_in">this</span>);<br>            <span class="hljs-comment">//把当前ListData的mVersion赋值给 ObserverWrapper的field mLastVersion</span><br>            mLastVersion.set(objectWrapper, mV);<br><br>            mObservers.setAccessible(<span class="hljs-literal">false</span>);<br>            methodGet.setAccessible(<span class="hljs-literal">false</span>);<br>            mLastVersion.setAccessible(<span class="hljs-literal">false</span>);<br>            mVersion.setAccessible(<span class="hljs-literal">false</span>);<br>        } <span class="hljs-keyword">catch</span> (Exception e) {<br>            e.printStackTrace();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="LiveDataCallAdapterFactory"><a href="#LiveDataCallAdapterFactory" class="headerlink" title="LiveDataCallAdapterFactory"></a>LiveDataCallAdapterFactory</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">import</span> androidx.lifecycle.LiveData<br><span class="hljs-keyword">import</span> retrofit2.*<br><span class="hljs-keyword">import</span> java.lang.reflect.ParameterizedType<br><span class="hljs-keyword">import</span> java.lang.reflect.Type<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicBoolean<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LiveDataCallAdapterFactory</span> : <span class="hljs-type">CallAdapter.Factory</span>() {<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(returnType: <span class="hljs-type">Type</span>, annotations: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">Annotation</span>&gt;, retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: CallAdapter&lt;*, *&gt;? {<br>        <span class="hljs-keyword">val</span> responseType: Type<br>        <span class="hljs-keyword">if</span> (getRawType(returnType) != LiveData::<span class="hljs-keyword">class</span>.javaObjectType) {<br>            <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"return type must be parameterized"</span>)<br>        }<br>        <span class="hljs-keyword">val</span> observableType = getParameterUpperBound(<span class="hljs-number">0</span>, returnType <span class="hljs-keyword">as</span> ParameterizedType)<br>        <span class="hljs-keyword">val</span> rawObservableType = getRawType(observableType)<br>        responseType = <span class="hljs-keyword">if</span> (rawObservableType == Response::<span class="hljs-keyword">class</span>.javaObjectType) {<br>            <span class="hljs-keyword">if</span> (observableType !<span class="hljs-keyword">is</span> ParameterizedType) {<br>                <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"Response must be parameterized"</span>)<br>            }<br>            getParameterUpperBound(<span class="hljs-number">0</span>, observableType)<br>        } <span class="hljs-keyword">else</span> {<br>            observableType<br>        }<br>        <span class="hljs-keyword">return</span> LiveDataCallAdapter&lt;Any&gt;(responseType)<br>    }<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiveDataCallAdapter</span>&lt;<span class="hljs-type">R</span>&gt;(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> responseType: Type) : CallAdapter&lt;R, LiveData&lt;R&gt;&gt; {<br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">responseType</span><span class="hljs-params">()</span></span> = responseType<br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">adapt</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">R</span>&gt;)</span></span>: LiveData&lt;R&gt; {<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">object</span> : LiveData&lt;R&gt;() {<br>                <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> started = AtomicBoolean(<span class="hljs-literal">false</span>)<br>                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActive</span><span class="hljs-params">()</span></span> {<br>                    <span class="hljs-keyword">super</span>.onActive()<br>                    <span class="hljs-keyword">if</span> (started.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {<br>                        call.enqueue(<span class="hljs-keyword">object</span> : Callback&lt;R&gt; {<br>                            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">R</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">R</span>&gt;)</span></span> {<br>                                postValue(response.body())<br>                            }<br><br>                            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">R</span>&gt;, throwable: <span class="hljs-type">Throwable</span>)</span></span> {<br>                                postValue(<span class="hljs-literal">null</span>)<br>                            }<br>                        })<br>                    }<br>                }<br>            }<br>        }<br>    }<br><br>}<br><br></code></pre></td></tr></tbody></table></figure><h3 id="SingleLiveEvent"><a href="#SingleLiveEvent" class="headerlink" title="SingleLiveEvent"></a>SingleLiveEvent</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> androidx.annotation.MainThread;<br><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br><span class="hljs-keyword">import</span> androidx.annotation.Nullable;<br><span class="hljs-keyword">import</span> androidx.lifecycle.LifecycleOwner;<br><span class="hljs-keyword">import</span> androidx.lifecycle.MutableLiveData;<br><span class="hljs-keyword">import</span> androidx.lifecycle.Observer;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingleLiveEvent</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MutableLiveData</span>&lt;T&gt; {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">mPending</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">observe</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LifecycleOwner owner, <span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> Observer&lt;? <span class="hljs-built_in">super</span> T&gt; observer)</span> {<br>        <span class="hljs-built_in">super</span>.observe(owner, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;T&gt;() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChanged</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> T t)</span> {<br>                <span class="hljs-keyword">if</span> (mPending.compareAndSet(<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>)) {<br>                    observer.onChanged(t);<br>                }<br>            }<br>        });<br>    }<br><br>    <span class="hljs-meta">@MainThread</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> T t)</span> {<br>        mPending.set(<span class="hljs-literal">true</span>);<br>        <span class="hljs-built_in">super</span>.setValue(t);<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Used for cases where T is Void, to make calls cleaner.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@MainThread</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">()</span> {<br>        setValue(<span class="hljs-literal">null</span>);<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算机网络基础</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/ji-suan-ji-wang-luo-ji-chu/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/ji-suan-ji-wang-luo-ji-chu/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%9A%84%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84">网络体系的分层结构</a></li><li><a href="#http-%E7%9B%B8%E5%85%B3">HTTP 相关</a><ul><li><a href="#%E9%80%9A%E7%94%A8%E5%A4%B4%E9%83%A8">通用头部</a></li><li><a href="#%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87">请求报文</a><ul><li><a href="#%E8%AF%B7%E6%B1%82%E8%A1%8C">请求行</a><ul><li><a href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95">请求方法</a></li></ul></li><li><a href="#%E8%AF%B7%E6%B1%82%E5%A4%B4">请求头</a></li><li><a href="#%E8%AF%B7%E6%B1%82%E4%BD%93">请求体</a></li></ul></li><li><a href="#%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87">响应报文</a><ul><li><a href="#%E5%B8%B8%E8%A7%81%E7%8A%B6%E6%80%81%E7%A0%81">常见状态码</a></li><li><a href="#%E5%93%8D%E5%BA%94%E5%A4%B4">响应头</a></li></ul></li><li><a href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6">缓存机制</a></li><li><a href="#http-11">HTTP 1.1</a></li><li><a href="#http-20">HTTP 2.0</a></li><li><a href="#https">HTTPS</a><ul><li><a href="#%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86">加密原理</a></li></ul></li></ul></li><li><a href="#tcpip">TCP/IP</a><ul><li><a href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B">三次握手</a></li><li><a href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">四次挥手</a></li><li><a href="#tcp-%E4%B8%8E-udp-%E7%9A%84%E5%8C%BA%E5%88%AB">TCP 与 UDP 的区别</a></li></ul></li><li><a href="#socket">Socket</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">使用示例</a></li></ul></li></ul><h1 id="网络体系的分层结构"><a href="#网络体系的分层结构" class="headerlink" title="网络体系的分层结构"></a>网络体系的分层结构</h1><table><thead><tr><th>分层</th><th>说明</th></tr></thead><tbody><tr><td>应用层（HTTP、FTP、DNS、SMTP 等）</td><td>定义了如何包装和解析数据，应用层是 http 协议的话，则会按照协议规定包装数据，如按照请求行、请求头、请求体包装，包装好数据后将数据传至运输层</td></tr><tr><td>运输层（TCP、UDP 等）</td><td>运输层有 TCP 和 UDP 两种，分别对应可靠和不可靠的运输。在这一层，一般都是和 Socket 打交道，Socket 是一组封装的编程调用接口，通过它，我们就能操作 TCP、UDP 进行连接的建立等。这一层指定了把数据送到对应的端口号</td></tr><tr><td>网络层（IP 等）</td><td>这一层IP协议，以及一些路由选择协议等等，所以这一层的指定了数据要传输到哪个IP地址。中间涉及到一些最优线路，路由选择算法等</td></tr><tr><td>数据链路层（ARP）</td><td>负责把 IP 地址解析为 MAC 地址，即硬件地址，这样就找到了对应的唯一的机器</td></tr><tr><td>物理层</td><td>提供二进制流传输服务，也就是真正开始通过传输介质（有线、无线）开始进行数据的传输</td></tr></tbody></table><h1 id="HTTP-相关"><a href="#HTTP-相关" class="headerlink" title="HTTP 相关"></a>HTTP 相关</h1><h2 id="通用头部"><a href="#通用头部" class="headerlink" title="通用头部"></a>通用头部</h2><h2 id="请求报文"><a href="#请求报文" class="headerlink" title="请求报文"></a>请求报文</h2><p>http 请求由三部分组成，分别是：请求行、请求头、请求体</p><h3 id="请求行"><a href="#请求行" class="headerlink" title="请求行"></a>请求行</h3><p>请求行以一个方法符号开头，以空格分开，格式如下：<br><strong>Method Request-URI HTTP-Version CRLF</strong></p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>Method</td><td>请求方法如 post/get</td></tr><tr><td>Request-URI</td><td>资源标识符（请求路径）</td></tr><tr><td>HTTP-Version</td><td>请求的HTTP协议版本</td></tr><tr><td>CRLF</td><td>回车和换行（除了作为结尾的CRLF外，不允许出现单独的CR或LF字符）</td></tr></tbody></table><h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><ul><li>HTTP 1.0</li></ul><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>GET</td><td>请求获取 Request-URI 所标识的资源</td></tr><tr><td>POST</td><td>在 Request-URI 所标识的资源后附加新的数据</td></tr><tr><td>HEAD</td><td>请求获取由 Request-URI 所标识的资源的响应消息报头</td></tr></tbody></table><ul><li>HTTP 1.1 新增</li></ul><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>PUT</td><td>请求服务器存储一个资源，并用 Request-URI 作为其标识</td></tr><tr><td>DELETE</td><td>请求服务器删除 Request-URI 所标识的资源</td></tr><tr><td>TRACE</td><td>请求服务器回送收到的请求信息，主要用于测试或诊断</td></tr><tr><td>CONNECT</td><td>保留将来使用</td></tr><tr><td>OPTIONS</td><td>请求查询服务器的性能，或者查询与资源相关的选项和需求</td></tr></tbody></table><ul><li>GET &amp; POST 的区别</li></ul><table><thead><tr><th>区别</th><th>说明</th></tr></thead><tbody><tr><td>数据传输方式</td><td>GET 请求通过 URL 传输数据，而 POST 的数据通过请求体传输。</td></tr><tr><td>安全性</td><td>POST的数据因为在请求主体内，所以有一定的安全性保证，而 GET 的数据在 URL 中，通过历史记录，缓存很容易查到数据信息。</td></tr><tr><td>数据类型不同</td><td>GET只允许 ASCII 字符，而 POST 无限制</td></tr><tr><td>特性</td><td>GET 是安全无害（只读）且幂等（多次提交等于一次提交），而 POST 是非安全非幂等，可能重复提交表单</td></tr></tbody></table><h3 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h3><table><thead><tr><th>Header</th><th>解释</th><th>示例</th></tr></thead><tbody><tr><td>Accept</td><td>指定客户端能够接收的内容类型</td><td>Accept: text/plain, text/html,application/json</td></tr><tr><td>Accept-Charset</td><td>浏览器可以接受的字符编码集</td><td>Accept-Charset: iso-8859-5</td></tr><tr><td>Accept-Encoding</td><td>指定浏览器可以支持的web服务器返回内容压缩编码类型。</td><td>Accept-Encoding: compress, gzip</td></tr><tr><td>Accept-Language</td><td>浏览器可接受的语言</td><td>Accept-Language: en,zh</td></tr><tr><td>Accept-Ranges</td><td>可以请求网页实体的一个或者多个子范围字段</td><td>Accept-Ranges: bytes</td></tr><tr><td>Authorization</td><td>HTTP授权的授权证书</td><td>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</td></tr><tr><td>Cache-Control</td><td>指定请求和响应遵循的缓存机制</td><td>Cache-Control: no-cache</td></tr><tr><td>Connection</td><td>表示是否需要持久连接。（HTTP 1.1默认进行持久连接）</td><td>Connection: close</td></tr><tr><td>Cookie</td><td>HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器。</td><td>Cookie: $Version=1; Skin=new;</td></tr><tr><td>Content-Length</td><td>请求的内容长度</td><td>Content-Length: 348</td></tr><tr><td>Content-Type</td><td>请求的与实体对应的MIME信息</td><td>Content-Type: application/</td></tr><tr><td>Date</td><td>请求发送的日期和时间</td><td>Date: Tue, 15 Nov 2010 08:12:31 GMT</td></tr><tr><td>Expect</td><td>请求的特定的服务器行为</td><td>Expect: 100-continue</td></tr><tr><td>From</td><td>发出请求的用户的Email</td><td>From: <a href="mailto:user@email.com">user@email.com</a></td></tr><tr><td>Host</td><td>指定请求的服务器的域名和端口号</td><td>Host: <a href="http://www.zcmhi.com/">www.zcmhi.com</a></td></tr><tr><td>If-Match</td><td>只有请求内容与实体相匹配才有效</td><td>If-Match: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Modified-Since</td><td>如果请求的部分在指定时间之后被修改则请求成功，未被修改则返回304代码</td><td>If-Modified-Since: Sat, 29 Oct 2010 19:43:31 GMT</td></tr><tr><td>If-None-Match</td><td>如果内容未改变返回304代码，参数为服务器先前发送的Etag，与服务器回应的Etag比较判断是否改变</td><td>If-None-Match: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Range</td><td>如果实体未改变，服务器发送客户端丢失的部分，否则发送整个实体。参数也为Etag</td><td>If-Range: “737060cd8c284d8af7ad3082f209582d”</td></tr><tr><td>If-Unmodified-Since</td><td>只在实体在指定时间之后未被修改才请求成功</td><td>If-Unmodified-Since: Sat, 29 Oct 2010 19:43:31 GMT</td></tr><tr><td>Max-Forwards</td><td>限制信息通过代理和网关传送的时间</td><td>Max-Forwards: 10</td></tr><tr><td>Pragma</td><td>用来包含实现特定的指令</td><td>Pragma: no-cache</td></tr><tr><td>Proxy-Authorization</td><td>连接到代理的授权证书</td><td>Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</td></tr><tr><td>Range</td><td>只请求实体的一部分，指定范围</td><td>Range: bytes=500-999</td></tr><tr><td>Referer</td><td>先前网页的地址，当前请求网页紧随其后,即来路</td><td>Referer: <a href="http://www.zcmhi.com/archives">http://www.zcmhi.com/archives</a>…</td></tr><tr><td>TE</td><td>客户端愿意接受的传输编码，并通知服务器接受接受尾加头信息</td><td>TE: trailers,deflate;q=0.5</td></tr><tr><td>Upgrade</td><td>向服务器指定某种传输协议以便服务器进行转换（如果支持）</td><td>Upgrade: HTTP/2.0, SHTTP/1.3, IRC/6.9, RTA/x11</td></tr><tr><td>User-Agent</td><td>User-Agent的内容包含发出请求的用户信息</td><td>User-Agent: Mozilla/5.0 (Linux; X11)</td></tr><tr><td>Via</td><td>通知中间网关或代理服务器地址，通信协议</td><td>Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)</td></tr><tr><td>Warning</td><td>关于消息实体的警告信息</td><td>Warn: 199 Miscellaneous warning</td></tr></tbody></table><h3 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a>请求体</h3><h2 id="响应报文"><a href="#响应报文" class="headerlink" title="响应报文"></a>响应报文</h2><ul><li>响应报文</li></ul><table><thead><tr><th>名称</th><th>组成</th></tr></thead><tbody><tr><td>状态行</td><td>状态码如 200、协议版本等</td></tr><tr><td>响应头</td><td>即返回的 header</td></tr><tr><td>响应体</td><td>响应的正文数据</td></tr></tbody></table><h3 id="常见状态码"><a href="#常见状态码" class="headerlink" title="常见状态码"></a>常见状态码</h3><p><strong>2XX 成功</strong></p><ul><li>200 OK，表示从客户端发来的请求在服务器端被正确处理</li><li>204 No content，表示请求成功，但响应报文不含实体的主体部分</li><li>206 Partial Content，进行范围请求</li></ul><p><strong>3XX 重定向</strong></p><ul><li>301 moved permanently，永久性重定向，表示资源已被分配了新的 URL</li><li>302 found，临时性重定向，表示资源临时被分配了新的 URL</li><li>303 see other，表示资源存在着另一个 URL，应使用 GET 方法丁香获取资源</li><li>304 not modified，表示服务器允许访问资源，但因发生请求未满足条件的情况</li><li>307 temporary redirect，临时重定向，和 302 含义相同</li></ul><p><strong>4XX 客户端错误</strong></p><ul><li>400 bad request，请求报文存在语法错误</li><li>401 unauthorized，表示发送的请求需要有通过 HTTP 认证的认证信息</li><li>403 forbidden，表示对请求资源的访问被服务器拒绝</li><li>404 not found，表示在服务器上没有找到请求的资源</li></ul><p><strong>5XX 服务器错误</strong></p><ul><li>500 internal sever error，表示服务器端在执行请求时发生了错误</li><li>503 service unavailable，表明服务器暂时处于超负载或正在停机维护，无法处理请求</li></ul><h3 id="响应头"><a href="#响应头" class="headerlink" title="响应头"></a>响应头</h3><h2 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h2><p><img src="https://upload-images.jianshu.io/upload_images/1445840-c3465ef477e24416.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/930/format/webp"></p><ul><li>Cache-control 主要包含以下几个字段：</li></ul><table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td>private</td><td>只有客户端可以缓存</td></tr><tr><td>public</td><td>客户端和代理服务器都可以缓存</td></tr><tr><td>max-age</td><td>缓存的过期时间</td></tr><tr><td>no-cache</td><td>需要使用对比缓存来验证缓存数据，如果服务端确认资源没有更新，则返回304，取本地缓存即可，如果有更新，则返回最新的资源。做对比缓存与 Etag 有关。</td></tr><tr><td>no-store</td><td>这个字段打开，则不会进行缓存，也不会取缓存</td></tr></tbody></table><ul><li>Etag：当客户端发送第一次请求时服务端会下发当前请求资源的标识码 Etag ，下次再请求时，客户端则会通过 header 里的<br>If-None-Match 将这个标识码 Etag 带上，服务端将客户端传来的 Etag 与最新的资源 Etag 做对比，如果一样，则表示资源没有更新，返回304。</li></ul><h2 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP 1.1"></a>HTTP 1.1</h2><p>对比 1.0，HTTP 1.1 主要区别主要体现在：</p><ul><li><strong>缓存处理</strong>：在 HTTP 1.0 中主要使用 header 里的 If-Modified-Since，Expires 来做为缓存判断的标准，HTTP1.1 则引入了更多的缓存控制策略例如<br>Entity tag，If-Unmodified-Since, If-Match, If-None-Match 等更多可供选择的缓存头来控制缓存策略。<br></li><li><strong>带宽优化及网络连接的使用</strong>：HTTP1.1 则在请求头引入了 range 头域，它允许只请求资源的某个部分，即返回码是206（Partial<br>Content），避免带宽浪费。<br></li><li><strong>错误通知管理</strong>：HTTP 1.1 新增了 24 个错误状态响应码，410（Gone）表示服务器上的某个资源被永久性的删除。<br></li><li><strong>Host 头处理</strong>：HTTP 1.1 的请求消息和响应消息都应支持Host头域，且请求消息中如果没有Host头域会报告一个错误（400 Bad<br>Request）。<br></li><li><strong>长连接</strong>：HTTP 1.1 支持长连接和请求的流水线理，在一个 TCP 连接上可以传送多个 HTTP<br>请求和响应，减少了建立和关闭连接的消耗和延迟，在HTTP1.1中默认开启Connection：keep-alive。</li></ul><h2 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h2><p>Okhttp 支持配置使用 HTTP 2.0 协议，HTTP 2.0 相对于 Http1.x 来说提升是巨大的，主要有以下几点：</p><ul><li><strong>二进制格式</strong>：http1.x 是文本协议，而 http2.0 是二进制以帧为基本单位，是一个二进制协议，一帧中除了包含数据外同时还包含该帧的标识：Stream<br>Identifier，即标识了该帧属于哪个 request，使得网络传输变得十分灵活。<br></li><li><strong>多路复用</strong>：多个请求共用一个 TCP 连接，多个请求可以同时在这个 TCP 连接上并发，一个request 对应一个 id。<br></li><li><strong>header 压缩</strong>：HTTP2.0 使用 encoder 来减少需要传输的 header 大小，通讯双方各自cache一份 header fields<br>表，避免了重复传输，流量消耗，提高效率。<br></li><li><strong>支持服务端推送</strong></li></ul><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>HTTP 的端口号是 80，HTTPS 是 443，HTTPS 需要到 CA 申请证书，一般免费证书很少，需要交费</p><p>SSL 的全称是 Secure Sockets Layer，即安全套接层协议，是为网络通信提供安全及数据完整性的一种安全协议。SSL协议在1994年被Netscape发明，后来各个浏览器均支持<br>SSL，其最新的版本是 3.0</p><p>TLS 的全称是 Transport Layer Security，即安全传输层协议，最新版本的 TLS是 IETF 制定的一种新的协议，它建立在 SSL 3.0<br>协议规范之上，是SSL 3.0的后续版本。在 TLS 与SSL 3.0 之间存在着显著的差别，主要是它们所支持的加密算法不同，所以 TLS 与 SSL3.0<br>不能互操作。虽然 TLS 与 SSL 3.0 在加密算法上不同，但在理解 HTTPS 的过程中，可以把 SSL 和 TLS 看做是同一个协议。</p><p>SSL（Secure Sockets Layer 安全套接层)，及其继任者传输层安全（Transport Layer<br>Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层对网络连接进行加密。</p><h3 id="加密原理"><a href="#加密原理" class="headerlink" title="加密原理"></a>加密原理</h3><p>HTTPS<br>为了兼顾安全与效率，同时使用了对称加密和非对称加密。数据是被对称加密传输的，对称加密过程需要客户端的一个密钥，为了确保能把该密钥安全传输到服务器端，采用非对称加密对该密钥进行加密传输，总的来说，对数据进行对称加密，对称加密所要使用的密钥通过非对称加密传输。</p><p><img src="https://upload-images.jianshu.io/upload_images/627325-dc83fef6ac2e6c88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/648/format/webp"></p><h1 id="TCP-IP"><a href="#TCP-IP" class="headerlink" title="TCP/IP"></a>TCP/IP</h1><p>IP（Internet Protocol）协议提供了主机和主机间的通信，为了完成不同主机的通信，我们需要某种方式来唯一标识一台主机，这个标识，就是著名的<br>IP 地址。通过IP地址，IP 协议就能够帮我们把一个数据包发送给对方。</p><p>TCP 的全称是 Transmission Control Protocol，TCP 协议在 IP 协议提供的主机间通信功能的基础上，完成这两个主机上进程对进程的通信。</p><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。</p><p>三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket<br>编程中，客户端执行 connect() 时。将触发三次握手。</p><p><img src="https://raw.githubusercontent.com/HIT-Alibaba/interview/master/img/tcp-connection-made-three-way-handshake.png"></p><ul><li>第一次握手(SYN=1, seq=x):</li></ul><p>客户端发送一个 TCP 的 SYN 标志位置 1 的包，指明客户端打算连接的服务器的端口，以及初始序号 X，保存在包头的序列号 (Sequence<br>Number) 字段里。</p><p>发送完毕后，客户端进入 <code>SYN_SEND</code> 状态。</p><ul><li>第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1):</li></ul><p>服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为 1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(<br>Acknowledgement Number)设置为客户的 ISN 加1，即 X+1。 发送完毕后，服务器端进入 <code>SYN_RCVD</code> 状态。</p><ul><li>第三次握手(ACK=1，ACKnum=y+1)</li></ul><p>客户端再次发送确认包(ACK)，SYN 标志位为 0，ACK 标志位为 1，并且把服务器发来 ACK 的序号字段 +1，放在确定字段中发送给对方，并且在数据段放写<br>ISN 的 +1</p><p>发送完毕后，客户端进入 ESTABLISHED 状态，当服务器端接收到这个包时，也进入 ESTABLISHED 状态，TCP 握手结束。</p><h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p>TCP 的连接的拆除需要发送四个包，因此称为四次挥手(Four-way handshake)，也叫做改进的三次握手。客户端或服务器均可主动发起挥手动作，在<br>socket 编程中，任何一方执行 close() 操作即可产生挥手操作。</p><p><img src="https://raw.githubusercontent.com/HIT-Alibaba/interview/master/img/tcp-connection-closed-four-way-handshake.png"></p><ul><li>第一次挥手(FIN=1，seq=x)</li></ul><p>假设客户端想要关闭连接，客户端发送一个 FIN 标志位置为1的包，表示自己已经没有数据可以发送了，但是仍然可以接受数据。</p><p>发送完毕后，客户端进入 FIN_WAIT_1 状态。</p><ul><li>第二次挥手(ACK=1，ACKnum=x+1)</li></ul><p>服务器端确认客户端的 FIN 包，发送一个确认包，表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。</p><p>发送完毕后，服务器端进入 CLOSE_WAIT 状态，客户端接收到这个确认包之后，进入 FIN_WAIT_2 状态，等待服务器端关闭连接。</p><ul><li>第三次挥手(FIN=1，seq=y)</li></ul><p>服务器端准备好关闭连接时，向客户端发送结束连接请求，FIN 置为1。</p><p>发送完毕后，服务器端进入 LAST_ACK 状态，等待来自客户端的最后一个ACK。</p><ul><li>第四次挥手(ACK=1，ACKnum=y+1)</li></ul><p>客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 TIME_WAIT状态，等待可能出现的要求重传的 ACK 包。</p><p>服务器端接收到这个确认包之后，关闭连接，进入 CLOSED 状态。</p><p>客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK<br>，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 CLOSED 状态。</p><h2 id="TCP-与-UDP-的区别"><a href="#TCP-与-UDP-的区别" class="headerlink" title="TCP 与 UDP 的区别"></a>TCP 与 UDP 的区别</h2><table><thead><tr><th>区别点</th><th>TCP</th><th>UDP</th></tr></thead><tbody><tr><td>连接性</td><td>面向连接</td><td>无连接</td></tr><tr><td>可靠性</td><td>可靠</td><td>不可靠</td></tr><tr><td>有序性</td><td>有序</td><td>无序</td></tr><tr><td>面向</td><td>字节流</td><td>报文（保留报文的边界）</td></tr><tr><td>有界性</td><td>有界</td><td>无界</td></tr><tr><td>流量控制</td><td>有（滑动窗口）</td><td>无</td></tr><tr><td>拥塞控制</td><td>有（慢开始、拥塞避免、快重传、快恢复）</td><td>无</td></tr><tr><td>传输速度</td><td>慢</td><td>快</td></tr><tr><td>量级</td><td>重量级</td><td>轻量级</td></tr><tr><td>双工性</td><td>全双工</td><td>一对一、一对多、多对一、多对多</td></tr><tr><td>头部</td><td>大（20-60 字节）</td><td>小（8 字节）</td></tr><tr><td>应用</td><td>文件传输、邮件传输、浏览器等</td><td>即时通讯、视频通话等</td></tr></tbody></table><h1 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h1><p>Socket 是一组操作 TCP/UDP 的 API，像 HttpURLConnection 和 Okhttp 这种涉及到比较底层的网络请求发送的，最终当然也都是通过<br>Socket 来进行网络请求连接发送，而像 Volley、Retrofit 则是更上层的封装。</p><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>使用 socket 的步骤如下：</p><ul><li>创建 ServerSocket 并监听客户连接；</li><li>使用 Socket 连接服务端；</li><li>通过 Socket.getInputStream()/getOutputStream() 获取输入输出流进行通信。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoClient</span> {<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Socket mSocket;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EchoClient</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> IOException {<br>        <span class="hljs-comment">// 创建 socket 并连接服务器</span><br>        mSocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(host, port);<br>    }<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">// 和服务端进行通信</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">readerThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>::readResponse);<br>        readerThread.start();<br> <br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> mSocket.getOutputStream();<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-type">int</span> n;<br>        <span class="hljs-keyword">while</span> ((n = System.in.read(buffer)) &gt; <span class="hljs-number">0</span>) {<br>            out.write(buffer, <span class="hljs-number">0</span>, n);<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readResponse</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> mSocket.getInputStream();<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span> ((n = in.read(buffer)) &gt; <span class="hljs-number">0</span>) {<br>                System.out.write(buffer, <span class="hljs-number">0</span>, n);<br>            }<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br>    }<br> <br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span> {<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">// 由于服务端运行在同一主机，这里我们使用 localhost</span><br>            <span class="hljs-type">EchoClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EchoClient</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">9877</span>);<br>            client.run();<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>设计模式汇总</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/she-ji-mo-shi-hui-zong/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/she-ji-mo-shi-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB">设计模式分类</a></li><li><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99">面向对象六大原则</a></li><li><a href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F">工厂模式</a></li><li><a href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">单例模式</a></li><li><a href="#%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F">建造者模式</a></li><li><a href="#%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F">原型模式</a></li><li><a href="#%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F">适配器模式</a></li><li><a href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">观察者模式</a></li><li><a href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F">代理模式</a></li><li><a href="#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">责任链模式</a></li><li><a href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">策略模式</a></li><li><a href="#%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F">备忘录模式</a></li></ul><h1 id="设计模式分类"><a href="#设计模式分类" class="headerlink" title="设计模式分类"></a>设计模式分类</h1><table><thead><tr><th>模式 &amp; 描述</th><th>包括</th></tr></thead><tbody><tr><td><strong>创建型模式</strong><br>提供了一种在创建对象的同时隐藏创建逻辑的方式。</td><td>工厂模式（Factory Pattern）<br>抽象工厂模式（Abstract Factory Pattern）<br>单例模式（Singleton Pattern）<br>建造者模式（Builder Pattern）<br>原型模式（Prototype Pattern）</td></tr><tr><td><strong>结构型模式</strong><br>关注类和对象的组合。</td><td>适配器模式（Adapter Pattern）<br>桥接模式（Bridge Pattern）<br>过滤器模式（Filter、Criteria Pattern）<br>组合模式（Composite Pattern）<br>装饰器模式（Decorator Pattern）<br>外观模式（Facade Pattern）<br>享元模式（Flyweight Pattern）<br>代理模式（Proxy Pattern）</td></tr><tr><td><strong>行为型模式</strong><br>特别关注对象之间的通信。</td><td>责任链模式（Chain of Responsibility Pattern）<br>命令模式（Command Pattern）<br>解释器模式（Interpreter Pattern）<br>迭代器模式（Iterator Pattern）<br>中介者模式（Mediator Pattern）<br>备忘录模式（Memento Pattern）<br>观察者模式（Observer Pattern）<br>状态模式（State Pattern）<br>空对象模式（Null Object Pattern）<br>策略模式（Strategy Pattern）<br>模板模式（Template Pattern）<br>访问者模式（Visitor Pattern）</td></tr></tbody></table><h1 id="面向对象六大原则"><a href="#面向对象六大原则" class="headerlink" title="面向对象六大原则"></a>面向对象六大原则</h1><table><thead><tr><th>原则</th><th>描述</th></tr></thead><tbody><tr><td>单一职责原则</td><td>一个类只负责一个功能领域中的相应职责。</td></tr><tr><td>开闭原则</td><td>对象应该对于扩展是开放的，对于修改是封闭的。</td></tr><tr><td>里氏替换原则</td><td>所有引用基类的地方必须能透明地使用其子类的对象。</td></tr><tr><td>依赖倒置原则</td><td>高层模块不依赖低层模块，两者应该依赖其对象；抽象不应该依赖细节；细节应该依赖抽象。</td></tr><tr><td>接口隔离原则</td><td>类间的依赖关系应该建立在最小的接口上。</td></tr><tr><td>迪米特原则</td><td>也称最少知识原则，一个对象对其他对象有最少的了解。</td></tr></tbody></table><h1 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h1><p>适用于复杂对象的创建。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Bitmap bitmap=BitmapFactory.decodeResource(getResources(),R.drawable.demo);<br></code></pre></td></tr></tbody></table></figure><p><code>BitmapFactory.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 生成 Bitmap 对象的工厂类 BitmapFactory</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapFactory</span> {<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">decodeFile</span><span class="hljs-params">(String pathName)</span> {<br>        ···<br>    }<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">decodeResource</span><span class="hljs-params">(Resources res, <span class="hljs-type">int</span> id, Options opts)</span> {<br>        validate(opts);<br>        <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">TypedValue</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedValue</span>();<br>            is = res.openRawResource(id, value);<br><br>            bm = decodeResourceStream(res, value, is, <span class="hljs-literal">null</span>, opts);<br>        } <br>        ···<br>        <span class="hljs-keyword">return</span> bm;<br>    }<br>    ···<br>}<br><br></code></pre></td></tr></tbody></table></figure><h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><p>确保某一个类只有一个实例，并自动实例化向整个系统提供这个实例，且可以避免产生多个对象消耗资源。</p><p>示例：</p><p><code>InputMethodManager.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Retrieve the global InputMethodManager instance, creating it if it</span><br><span class="hljs-comment"> * doesn't already exist.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputMethodManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span>{<br><span class="hljs-keyword">synchronized</span> (InputMethodManager.class){<br>        <span class="hljs-keyword">if</span>(sInstance==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">try</span>{<br>        sInstance=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputMethodManager</span>(Looper.getMainLooper());<br>        }<span class="hljs-keyword">catch</span>(ServiceNotFoundException e){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);<br>        }<br>        }<br>        <span class="hljs-keyword">return</span> sInstance;<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h1><p>将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示，适用于初始化的对象比较复杂且参数较多的情况。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">AlertDialog.Builder builder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(<span class="hljs-built_in">this</span>)<br>        .setTitle(<span class="hljs-string">"Title"</span>)<br>        .setMessage(<span class="hljs-string">"Message"</span>);<br>        AlertDialog dialog=builder.create();<br>        dialog.show();<br></code></pre></td></tr></tbody></table></figure><p><code>AlertDialog.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertDialog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Dialog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DialogInterface</span> {<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AlertController.AlertParams P;<br>        ···<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Context context)</span> {<br>            <span class="hljs-built_in">this</span>(context, resolveDialogTheme(context, ResourceId.ID_NULL));<br>        }<br>        ···<br><br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">setTitle</span><span class="hljs-params">(CharSequence title)</span> {<br>            P.mTitle = title;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        }<br>        ···<br><br>        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">setMessage</span><span class="hljs-params">(CharSequence message)</span> {<br>            P.mMessage = message;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        }<br>        ···<br><br>        <span class="hljs-keyword">public</span> AlertDialog <span class="hljs-title function_">create</span><span class="hljs-params">()</span> {<br>            <span class="hljs-comment">// Context has already been wrapped with the appropriate theme.</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">AlertDialog</span> <span class="hljs-variable">dialog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>(P.mContext, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<br>            P.apply(dialog.mAlert);<br>            ···<br>            <span class="hljs-keyword">return</span> dialog;<br>        }<br>        ···<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h1><p>用原型模式实例指定创建对象的种类，并通过拷贝这些原型创建新的对象。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ArrayList&lt;T&gt; newArrayList=(ArrayList&lt;T&gt;)arrayList.clone();<br></code></pre></td></tr></tbody></table></figure><p><code>ArrayList.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Returns a shallow copy of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance.  (The</span><br><span class="hljs-comment"> * elements themselves are not copied.)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> a clone of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">clone</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">try</span>{<br>        ArrayList&lt;?&gt; v=(ArrayList&lt;?&gt;)<span class="hljs-built_in">super</span>.clone();<br>        v.elementData=Arrays.copyOf(elementData,size);<br>        v.modCount=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> v;<br>        }<span class="hljs-keyword">catch</span>(CloneNotSupportedException e){<br>        <span class="hljs-comment">// this shouldn't happen, since we are Cloneable</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(e);<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h1><p>适配器模式把一个类的接口变成客户端所期待的另一种接口，从而使原因接口不匹配而无法一起工作的两个类能够在一起工作。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">RecyclerView recyclerView=findViewById(R.id.recycler_view);<br>        recyclerView.setAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAdapter</span>());<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;RecyclerView.ViewHolder&gt; {<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RecyclerView.ViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> {<br>        ···<br>    }<br><br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>RecyclerView.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java">···<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAdapterInternal</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Adapter adapter,<span class="hljs-type">boolean</span> compatibleWithPrevious,</span><br><span class="hljs-params">        <span class="hljs-type">boolean</span> removeAndRecycleViews)</span>{<br>        <span class="hljs-keyword">if</span>(mAdapter!=<span class="hljs-literal">null</span>){<br>        mAdapter.unregisterAdapterDataObserver(mObserver);<br>        mAdapter.onDetachedFromRecyclerView(<span class="hljs-built_in">this</span>);<br>        }<br>        ···<br>        mAdapterHelper.reset();<br><span class="hljs-keyword">final</span> Adapter oldAdapter=mAdapter;<br>        mAdapter=adapter;<br>        <span class="hljs-keyword">if</span>(adapter!=<span class="hljs-literal">null</span>){<br>        adapter.registerAdapterDataObserver(mObserver);<br>        adapter.onAttachedToRecyclerView(<span class="hljs-built_in">this</span>);<br>        }<br>        <span class="hljs-keyword">if</span>(mLayout!=<span class="hljs-literal">null</span>){<br>        mLayout.onAdapterChanged(oldAdapter,mAdapter);<br>        }<br>        mRecycler.onAdapterChanged(oldAdapter,mAdapter,compatibleWithPrevious);<br>        mState.mStructureChanged=<span class="hljs-literal">true</span>;<br>        }<br><br>        ···<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recycler</span> {<br>    <span class="hljs-meta">@Nullable</span><br>    ViewHolder <span class="hljs-title function_">tryGetViewHolderForPositionByDeadline</span><span class="hljs-params">(<span class="hljs-type">int</span> position,</span><br><span class="hljs-params">                                                     <span class="hljs-type">boolean</span> dryRun, <span class="hljs-type">long</span> deadlineNs)</span> {<br>        ···<br>        <span class="hljs-type">ViewHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        ···<br>        <span class="hljs-keyword">if</span> (holder == <span class="hljs-literal">null</span>) {<br>            ···<br>            holder = mAdapter.createViewHolder(RecyclerView.<span class="hljs-built_in">this</span>, type);<br>            ···<br>        }<br>        ···<br>        <span class="hljs-keyword">return</span> holder;<br>    }<br>}<br><br>···<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span>&lt;VH <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewHolder</span>&gt; {<br>    ···<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> VH <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span>;<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> VH <span class="hljs-title function_">createViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> {<br>        <span class="hljs-keyword">try</span> {<br>            TraceCompat.beginSection(TRACE_CREATE_VIEW_TAG);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">VH</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> onCreateViewHolder(parent, viewType);<br>            ···<br>            holder.mItemViewType = viewType;<br>            <span class="hljs-keyword">return</span> holder;<br>        } <span class="hljs-keyword">finally</span> {<br>            TraceCompat.endSection();<br>        }<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h1><p>定义对象间一种一对多的依赖关系，使得每当一个对象改变状态，则所有依赖于它的对象都会得到通知并被自动更新。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">MyAdapter adapter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAdapter</span>();<br>        recyclerView.setAdapter(adapter);<br>        adapter.notifyDataSetChanged();<br></code></pre></td></tr></tbody></table></figure><p><code>RecyclerView.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java">···<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RecyclerViewDataObserver mObserver=<span class="hljs-keyword">new</span> <span class="hljs-title class_">RecyclerViewDataObserver</span>();<br><br>        ···<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAdapterInternal</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Adapter adapter,<span class="hljs-type">boolean</span> compatibleWithPrevious,</span><br><span class="hljs-params">        <span class="hljs-type">boolean</span> removeAndRecycleViews)</span>{<br>        ···<br>        mAdapter=adapter;<br>        <span class="hljs-keyword">if</span>(adapter!=<span class="hljs-literal">null</span>){<br>        adapter.registerAdapterDataObserver(mObserver);<br>        adapter.onAttachedToRecyclerView(<span class="hljs-built_in">this</span>);<br>        }<br>        ···<br>        }<br><br>        ···<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span>&lt;VH <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewHolder</span>&gt; {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AdapterDataObservable</span> <span class="hljs-variable">mObservable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdapterDataObservable</span>();<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAdapterDataObserver</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> AdapterDataObserver observer)</span> {<br>        mObservable.registerObserver(observer);<br>    }<br><br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyDataSetChanged</span><span class="hljs-params">()</span> {<br>        mObservable.notifyChanged();<br>    }<br>}<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdapterDataObservable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Observable</span>&lt;AdapterDataObserver&gt; {<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyChanged</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> mObservers.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {<br>            mObservers.get(i).onChanged();<br>        }<br>    }<br>    ···<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecyclerViewDataObserver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AdapterDataObserver</span> {<br>    ···<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChanged</span><span class="hljs-params">()</span> {<br>        assertNotInLayoutOrScroll(<span class="hljs-literal">null</span>);<br>        mState.mStructureChanged = <span class="hljs-literal">true</span>;<br><br>        processDataSetCompletelyChanged(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">if</span> (!mAdapterHelper.hasPendingUpdates()) {<br>            requestLayout();<br>        }<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h1><p>为其他的对象提供一种代理以控制对这个对象的访问。适用于当无法或不想直接访问某个对象时通过一个代理对象来间接访问，为了保证客户端使用的透明性，委托对象与代理对象需要实现相同的接口。</p><p>示例：</p><p><code>Context.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> {<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent)</span>;<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>ContextWrapper.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Context</span> {<br>    Context mBase; <span class="hljs-comment">// 代理类，实为 ContextImpl 对象</span><br>    ···<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> {<br>        <span class="hljs-keyword">if</span> (mBase != <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Base context already set"</span>);<br>        }<br>        mBase = base;<br>    }<br>    ···<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent)</span> {<br>        mBase.startActivity(intent); <span class="hljs-comment">// 核心工作交由给代理类对象 mBase 实现</span><br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>ContextImpl.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Context 的真正实现类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Context</span> {<br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent)</span> {<br>        warnIfCallingFromSystemProcess();<br>        startActivity(intent, <span class="hljs-literal">null</span>);<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h1><p>使多个对象都有机会处理请求，从而避免了请求的发送者和接受者之间的耦合。将这些对象连成一条链，并沿着这条链传递该请求，直到有对象处理它为止。</p><p><code>ViewGroup.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@UiThread</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ViewParent</span>, ViewManager {<br>    ···<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTransformedTouchEvent</span><span class="hljs-params">(MotionEvent event, <span class="hljs-type">boolean</span> cancel,</span><br><span class="hljs-params">                                                  View child, <span class="hljs-type">int</span> desiredPointerIdBits)</span> {<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> handled;<br>        ···<br>        <span class="hljs-keyword">final</span> MotionEvent transformedEvent;<br>        <span class="hljs-keyword">if</span> (newPointerIdBits == oldPointerIdBits) {<br>            <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span> || child.hasIdentityMatrix()) {<br>                <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) {<br>                    handled = <span class="hljs-built_in">super</span>.dispatchTouchEvent(event);<br>                } <span class="hljs-keyword">else</span> {<br>                    ···<br>                    <span class="hljs-comment">// 获取子 view 处理的结果</span><br>                    handled = child.dispatchTouchEvent(event);<br>                }<br>                <span class="hljs-keyword">return</span> handled;<br>            }<br>            transformedEvent = MotionEvent.obtain(event);<br>        } <span class="hljs-keyword">else</span> {<br>            transformedEvent = event.split(newPointerIdBits);<br>        }<br><br>        <span class="hljs-comment">// Perform any necessary transformations and dispatch.</span><br>        <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) {<br>            handled = <span class="hljs-built_in">super</span>.dispatchTouchEvent(transformedEvent);<br>        } <span class="hljs-keyword">else</span> {<br>            ···<br>            <span class="hljs-comment">// 获取子 view 处理的结果</span><br>            handled = child.dispatchTouchEvent(transformedEvent);<br>        }<br>        ···<br>        <span class="hljs-keyword">return</span> handled;<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h1><p>策略模式定义了一系列的算法，并封装起来，提供针对同一类型问题的多种处理方式。</p><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 匀速</span><br>animation.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearInterpolator</span>());<br><span class="hljs-comment">// 加速</span><br>        animation.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AccelerateInterpolator</span>());<br>        ···<br></code></pre></td></tr></tbody></table></figure><p><code>BaseInterpolator.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * An abstract class which is extended by default interpolators.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseInterpolator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interpolator</span> {<br>    <span class="hljs-keyword">private</span> <span class="hljs-meta">@Config</span> <span class="hljs-type">int</span> mChangingConfiguration;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-meta">@Config</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getChangingConfiguration</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> mChangingConfiguration;<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChangingConfiguration</span><span class="hljs-params">(<span class="hljs-meta">@Config</span> <span class="hljs-type">int</span> changingConfiguration)</span> {<br>        mChangingConfiguration = changingConfiguration;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>LinearInterpolator.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@HasNativeInterpolator</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinearInterpolator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseInterpolator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NativeInterpolatorFactory</span> {<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>AccelerateInterpolator.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@HasNativeInterpolator</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccelerateInterpolator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseInterpolator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NativeInterpolatorFactory</span> {<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="备忘录模式"><a href="#备忘录模式" class="headerlink" title="备忘录模式"></a>备忘录模式</h1><p>在不破坏封闭的前提下，在对象之外保存保存对象的当前状态，并且在之后可以恢复到此状态。</p><p>示例：</p><p><code>Activity.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 保存状态</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSaveInstanceState</span><span class="hljs-params">(Bundle outState)</span>{<br>        <span class="hljs-comment">// 存储当前窗口的视图树的状态</span><br>        outState.putBundle(WINDOW_HIERARCHY_TAG,mWindow.saveHierarchyState());<br><br>        outState.putInt(LAST_AUTOFILL_ID,mLastAutofillId);<br>        <span class="hljs-comment">// 存储 Fragment 的状态</span><br>        Parcelable p=mFragments.saveAllState();<br>        <span class="hljs-keyword">if</span>(p!=<span class="hljs-literal">null</span>){<br>        outState.putParcelable(FRAGMENTS_TAG,p);<br>        }<br>        <span class="hljs-keyword">if</span>(mAutoFillResetNeeded){<br>        outState.putBoolean(AUTOFILL_RESET_NEEDED,<span class="hljs-literal">true</span>);<br>        getAutofillManager().onSaveInstanceState(outState);<br>        }<br>        <span class="hljs-comment">// 调用 ActivityLifecycleCallbacks 的 onSaveInstanceState 进行存储状态</span><br>        getApplication().dispatchActivitySaveInstanceState(<span class="hljs-built_in">this</span>,outState);<br>        }<br><br>        ···<br><span class="hljs-comment">// onCreate 方法中恢复状态</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span>{<br>        ···<br>        <span class="hljs-keyword">if</span>(savedInstanceState!=<span class="hljs-literal">null</span>){<br>        mAutoFillResetNeeded=savedInstanceState.getBoolean(AUTOFILL_RESET_NEEDED,<span class="hljs-literal">false</span>);<br>        mLastAutofillId=savedInstanceState.getInt(LAST_AUTOFILL_ID,<br>        View.LAST_APP_AUTOFILL_ID);<br><br>        <span class="hljs-keyword">if</span>(mAutoFillResetNeeded){<br>        getAutofillManager().onCreate(savedInstanceState);<br>        }<br><br>        Parcelable p=savedInstanceState.getParcelable(FRAGMENTS_TAG);<br>        mFragments.restoreAllState(p,mLastNonConfigurationInstances!=<span class="hljs-literal">null</span><br>        ?mLastNonConfigurationInstances.fragments:<span class="hljs-literal">null</span>);<br>        }<br>        mFragments.dispatchCreate();<br>        getApplication().dispatchActivityCreated(<span class="hljs-built_in">this</span>,savedInstanceState);<br>        ···<br>        mRestoredFromBundle=savedInstanceState!=<span class="hljs-literal">null</span>;<br>        mCalled=<span class="hljs-literal">true</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><p><code>ActivityThread.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleStartActivity</span><span class="hljs-params">(ActivityClientRecord r,</span><br><span class="hljs-params">        PendingTransactionActions pendingActions)</span>{<br><span class="hljs-keyword">final</span> Activity activity=r.activity;<br>        ···<br>        <span class="hljs-comment">// Start</span><br>        activity.performStart(<span class="hljs-string">"handleStartActivity"</span>);<br>        r.setState(ON_START);<br>        ···<br>        <span class="hljs-comment">// Restore instance state</span><br>        <span class="hljs-keyword">if</span>(pendingActions.shouldRestoreInstanceState()){<br>        <span class="hljs-keyword">if</span>(r.isPersistable()){<br>        <span class="hljs-keyword">if</span>(r.state!=<span class="hljs-literal">null</span>||r.persistentState!=<span class="hljs-literal">null</span>){<br>        mInstrumentation.callActivityOnRestoreInstanceState(activity,r.state,<br>        r.persistentState);<br>        }<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(r.state!=<span class="hljs-literal">null</span>){<br>        mInstrumentation.callActivityOnRestoreInstanceState(activity,r.state);<br>        }<br>        }<br>        ···<br>        }<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android开源库源码分析</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/android-kai-yuan-ku-yuan-ma-fen-xi/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/android-kai-yuan-ku-yuan-ma-fen-xi/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#OKHttp">OKHttp</a><ul><li><a href="#OKHttp%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B">OKHttp请求流程</a><ul><li><a href="#%E6%96%B0%E5%BB%BAOKHttpClient%E5%AE%A2%E6%88%B7%E7%AB%AF">新建OKHttpClient客户端</a></li><li><a href="#%E5%90%8C%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B">同步请求流程</a></li><li><a href="#%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B">异步请求流程</a></li></ul></li><li><a href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86%E4%B9%8BCacheInterceptor">网络请求缓存处理</a></li><li><a href="#ConnectInterceptor%E4%B9%8B%E8%BF%9E%E6%8E%A5%E6%B1%A0">连接池</a></li></ul></li><li><a href="#Retrofit">Retrofit</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B">基本使用流程</a></li><li><a href="#Retrofit%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B">Retrofit构建过程</a><ul><li><a href="#Retrofit%E6%A0%B8%E5%BF%83%E5%AF%B9%E8%B1%A1%E8%A7%A3%E6%9E%90">Retrofit核心对象解析</a></li><li><a href="#Builder%E5%86%85%E9%83%A8%E6%9E%84%E9%80%A0">Builder内部构造</a></li><li><a href="#%E6%B7%BB%E5%8A%A0baseUrl">添加baseUrl</a></li><li><a href="#%E6%B7%BB%E5%8A%A0GsonConverterFactory">添加GsonConverterFactory</a></li><li><a href="#build%E8%BF%87%E7%A8%8B">build过程</a></li></ul></li><li><a href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3%E5%AE%9E%E4%BE%8B%E8%BF%87%E7%A8%8B">创建网络请求接口实例过程</a></li><li><a href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%AE%9E%E4%BE%8B%E5%B9%B6%E6%89%A7%E8%A1%8C%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B">创建网络请求接口类实例并执行请求过程</a></li><li><a href="#Retrofit%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E5%9B%BE">Retrofit源码流程图</a></li></ul></li><li><a href="#Glide">Glide</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B-1">基本使用流程</a></li><li><a href="#GlideAppwithcontext%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3">GlideApp.with(context)源码详解</a></li><li><a href="#loadurl%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3">load(url)源码详解</a></li><li><a href="#intoiv%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3">into(iv)源码详解</a></li><li><a href="#%E5%AE%8C%E6%95%B4Glide%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%9B%BE">完整Glide加载流程图</a></li></ul></li><li><a href="#GreenDao">GreenDao</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B-2">基本使用流程</a></li><li><a href="#GreenDao%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">GreenDao使用流程分析</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B8%AE%E5%8A%A9%E7%B1%BB%E5%AF%B9%E8%B1%A1DaoMasterDevOpenHelper">创建数据库帮助类对象DaoMaster.DevOpenHelper</a></li><li><a href="#%E5%88%9B%E5%BB%BADaoMaster%E5%AF%B9%E8%B1%A1">创建DaoMaster对象</a></li><li><a href="#%E5%88%9B%E5%BB%BADaoSession%E5%AF%B9%E8%B1%A1">创建DaoSession对象</a></li><li><a href="#%E6%8F%92%E5%85%A5%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">插入源码分析</a></li><li><a href="#%E6%9F%A5%E8%AF%A2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">查询源码分析</a></li></ul></li><li><a href="#GreenDao%E6%98%AF%E5%A6%82%E4%BD%95%E4%B8%8EReactiveX%E7%BB%93%E5%90%88">GreenDao是如何与ReactiveX结合？</a></li></ul></li><li><a href="#RxJava">RxJava</a><ul><li><a href="#RxJava%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88">RxJava是什么？</a></li><li><a href="#RxJava%E7%9A%84%E8%AE%A2%E9%98%85%E6%B5%81%E7%A8%8B">RxJava的订阅流程</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E8%A2%AB%E8%A7%82%E5%AF%9F%E8%80%85%E8%BF%87%E7%A8%8B">创建被观察者过程</a></li><li><a href="#%E8%AE%A2%E9%98%85%E8%BF%87%E7%A8%8B">订阅过程</a></li></ul></li><li><a href="#RxJava%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2">RxJava的线程切换</a></li></ul></li><li><a href="#LeakCanary">LeakCanary</a><ul><li><a href="#%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0">原理概述</a></li><li><a href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B">简单示例</a></li><li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码分析</a></li><li><a href="#LeakCanary%E8%BF%90%E4%BD%9C%E6%B5%81%E7%A8%8B">LeakCanary运作流程</a></li></ul></li><li><a href="#ButterKnife">ButterKnife</a><ul><li><a href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B-1">简单示例</a></li><li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1">源码分析</a><ul><li><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90">模板代码解析</a></li><li><a href="#ButterKnife-%E6%98%AF%E6%80%8E%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E7%9A%84">ButterKnife 是怎样实现代码注入的</a></li><li><a href="#ButterKnife%E6%98%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E7%BC%96%E8%AF%91%E6%97%B6%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84">ButterKnife是如何在编译时生成代码的？</a></li></ul></li></ul></li><li><a href="#Dagger-2">Dagger 2</a><ul><li><a href="#%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86">预备知识</a><ul><li><a href="#@Inject">@Inject</a></li><li><a href="#@Module">@Module</a></li><li><a href="#@Singleton">@Singleton</a></li><li><a href="#@Providers">@Providers</a></li><li><a href="#@Component">@Component</a></li><li><a href="#@Scope">@Scope</a></li><li><a href="#@Qualifier">@Qualifier</a></li><li><a href="#dependencies">dependencies</a></li><li><a href="#@SubComponent">@SubComponent</a></li></ul></li><li><a href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B-2">简单示例</a></li><li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2">源码分析</a></li></ul></li><li><a href="#EventBus">EventBus</a><ul><li><a href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B-3">简单示例</a></li><li><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-3">源码分析</a></li></ul></li></ul><h1 id="OKHttp"><a href="#OKHttp" class="headerlink" title="OKHttp"></a>OKHttp</h1><h2 id="OKHttp请求流程"><a href="#OKHttp请求流程" class="headerlink" title="OKHttp请求流程"></a>OKHttp请求流程</h2><p>OKHttp内部的大致请求流程图如下所示：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/976154d56c224d96b33b1ca424e935a2~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><p>如下为使用OKHttp进行Get请求的步骤：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//1.新建OKHttpClient客户端</span><br>OkHttpClient client = <span class="hljs-keyword">new</span> <span class="hljs-constructor">OkHttpClient()</span>;<br><span class="hljs-comment">//新建一个Request对象</span><br>Request request = <span class="hljs-keyword">new</span> Request.<span class="hljs-constructor">Builder()</span><br>        .url(url)<br>        .build<span class="hljs-literal">()</span>;<br><span class="hljs-comment">//2.Response为OKHttp中的响应</span><br>Response response = client.<span class="hljs-keyword">new</span><span class="hljs-constructor">Call(<span class="hljs-params">request</span>)</span>.execute<span class="hljs-literal">()</span>;<br></code></pre></td></tr></tbody></table></figure><h3 id="新建OKHttpClient客户端"><a href="#新建OKHttpClient客户端" class="headerlink" title="新建OKHttpClient客户端"></a>新建OKHttpClient客户端</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">OkHttpClient client = <span class="hljs-keyword">new</span> <span class="hljs-constructor">OkHttpClient()</span>;<br><br>public <span class="hljs-constructor">OkHttpClient()</span> {<br>    this(<span class="hljs-keyword">new</span> <span class="hljs-constructor">Builder()</span>);<br>}<br><br><span class="hljs-constructor">OkHttpClient(Builder <span class="hljs-params">builder</span>)</span> {<br>    ....<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，OkHttpClient使用了建造者模式，Builder里面的可配置参数如下：</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span> </span>{<br>    Dispatcher dispatcher;<span class="hljs-comment">// 分发器</span><br>    <span class="hljs-meta">@Nullable</span> Proxy proxy;<br>    List&lt;Protocol&gt; protocols;<br>    List&lt;ConnectionSpec&gt; connectionSpecs;<span class="hljs-comment">// 传输层版本和连接协议</span><br>    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<span class="hljs-comment">// 拦截器</span><br>    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; networkInterceptors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    EventListener.Factory eventListenerFactory;<br>    ProxySelector proxySelector;<br>    CookieJar cookieJar;<br>    <span class="hljs-meta">@Nullable</span> Cache cache;<br>    <span class="hljs-meta">@Nullable</span> InternalCache internalCache;<span class="hljs-comment">// 内部缓存</span><br>    SocketFactory socketFactory;<br>    <span class="hljs-meta">@Nullable</span> SSLSocketFactory sslSocketFactory;<span class="hljs-comment">// 安全套接层socket 工厂，用于HTTPS</span><br>    <span class="hljs-meta">@Nullable</span> CertificateChainCleaner certificateChainCleaner;<span class="hljs-comment">// 验证确认响应证书 适用 HTTPS 请求连接的主机名。</span><br>    HostnameVerifier hostnameVerifier;<span class="hljs-comment">// 验证确认响应证书 适用 HTTPS 请求连接的主机名。  </span><br>    CertificatePinner certificatePinner;<span class="hljs-comment">// 证书锁定，使用CertificatePinner来约束哪些认证机构被信任。</span><br>    Authenticator proxyAuthenticator;<span class="hljs-comment">// 代理身份验证</span><br>    Authenticator authenticator;<span class="hljs-comment">// 身份验证</span><br>    ConnectionPool connectionPool;<span class="hljs-comment">// 连接池</span><br>    Dns dns;<br>    <span class="hljs-keyword">boolean</span> followSslRedirects; <span class="hljs-comment">// 安全套接层重定向</span><br>    <span class="hljs-keyword">boolean</span> followRedirects;<span class="hljs-comment">// 本地重定向</span><br>    <span class="hljs-keyword">boolean</span> retryOnConnectionFailure;<span class="hljs-comment">// 重试连接失败</span><br>    <span class="hljs-keyword">int</span> callTimeout;<br>    <span class="hljs-keyword">int</span> connectTimeout;<br>    <span class="hljs-keyword">int</span> readTimeout;<br>    <span class="hljs-keyword">int</span> writeTimeout;<br>    <span class="hljs-keyword">int</span> pingInterval;<br><br>    <span class="hljs-comment">// 这里是默认配置的构建参数</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Builder</span><span class="hljs-params">()</span> </span>{<br>        dispatcher = <span class="hljs-keyword">new</span> Dispatcher();<br>        protocols = DEFAULT_PROTOCOLS;<br>        connectionSpecs = DEFAULT_CONNECTION_SPECS;<br>        ...<br>    }<br><br>    <span class="hljs-comment">// 这里传入自己配置的构建参数</span><br>    Builder(OkHttpClient okHttpClient) {<br>        <span class="hljs-keyword">this</span>.dispatcher = okHttpClient.dispatcher;<br>        <span class="hljs-keyword">this</span>.proxy = okHttpClient.proxy;<br>        <span class="hljs-keyword">this</span>.protocols = okHttpClient.protocols;<br>        <span class="hljs-keyword">this</span>.connectionSpecs = okHttpClient.connectionSpecs;<br>        <span class="hljs-keyword">this</span>.interceptors.addAll(okHttpClient.interceptors);<br>        <span class="hljs-keyword">this</span>.networkInterceptors.addAll(okHttpClient.networkInterceptors);<br>        ...<br>    }<br></code></pre></td></tr></tbody></table></figure><h3 id="同步请求流程"><a href="#同步请求流程" class="headerlink" title="同步请求流程"></a>同步请求流程</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.newCall(request).execute();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Prepares the {<span class="hljs-doctag">@code</span> request} to be executed at   some point in the future.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Call <span class="hljs-title function_">newCall</span><span class="hljs-params">(Request request)</span> {<br>    <span class="hljs-keyword">return</span> RealCall.newRealCall(<span class="hljs-built_in">this</span>, request, <span class="hljs-literal">false</span> <span class="hljs-comment">/* for web socket */</span>);<br>}<br><br><span class="hljs-comment">// RealCall为真正的请求执行者</span><br><span class="hljs-keyword">static</span> RealCall <span class="hljs-title function_">newRealCall</span><span class="hljs-params">(OkHttpClient client, Request originalRequest, <span class="hljs-type">boolean</span> forWebSocket)</span> {<br>    <span class="hljs-comment">// Safely publish the Call instance to the EventListener.</span><br>    <span class="hljs-type">RealCall</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealCall</span>(client, originalRequest, forWebSocket);<br>    call.eventListener = client.eventListenerFactory().create(call);<br>    <span class="hljs-keyword">return</span> call;<br>}<br><br><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {<br>        <span class="hljs-comment">// 每个Call只能执行一次</span><br>        <span class="hljs-keyword">if</span> (executed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Already Executed"</span>);<br>        executed = <span class="hljs-literal">true</span>;<br>    }<br>    captureCallStackTrace();<br>    timeout.enter();<br>    eventListener.callStart(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 通知dispatcher已经进入执行状态</span><br>        client.dispatcher().executed(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// 通过一系列的拦截器请求处理和响应处理得到最终的返回结果</span><br>        <span class="hljs-type">Response</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getResponseWithInterceptorChain();<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"Canceled"</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    } <span class="hljs-keyword">catch</span> (IOException e) {<br>        e = timeoutExit(e);<br>        eventListener.callFailed(<span class="hljs-built_in">this</span>, e);<br>        <span class="hljs-keyword">throw</span> e;<br>    } <span class="hljs-keyword">finally</span> {<br>        <span class="hljs-comment">// 通知 dispatcher 自己已经执行完毕</span><br>        client.dispatcher().finished(<span class="hljs-built_in">this</span>);<br>    }<br>}<br><br>Response <span class="hljs-title function_">getResponseWithInterceptorChain</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-comment">// Build a full stack of interceptors.</span><br>    List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 在配置 OkHttpClient 时设置的 interceptors；</span><br>    interceptors.addAll(client.interceptors());<br>    <span class="hljs-comment">// 负责失败重试以及重定向</span><br>    interceptors.add(retryAndFollowUpInterceptor);<br>    <span class="hljs-comment">// 请求时，对必要的Header进行一些添加，接收响应时，移除必要的Header</span><br>    interceptors.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BridgeInterceptor</span>(client.cookieJar()));<br>    <span class="hljs-comment">// 负责读取缓存直接返回、更新缓存</span><br>    interceptors.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheInterceptor</span>(client.internalCache()));<br>    <span class="hljs-comment">// 负责和服务器建立连接</span><br>    interceptors.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectInterceptor</span>(client));<br>    <span class="hljs-keyword">if</span> (!forWebSocket) {<br>        <span class="hljs-comment">// 配置 OkHttpClient 时设置的 networkInterceptors</span><br>        interceptors.addAll(client.networkInterceptors());<br>    }<br>    <span class="hljs-comment">// 负责向服务器发送请求数据、从服务器读取响应数据</span><br>    interceptors.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CallServerInterceptor</span>(forWebSocket));<br><br>    Interceptor.<span class="hljs-type">Chain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealInterceptorChain</span>(interceptors, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>,<br>        originalRequest, <span class="hljs-built_in">this</span>, eventListener, client.connectTimeoutMillis(),<br>        client.readTimeoutMillis(), client.writeTimeoutMillis());<br><br>    <span class="hljs-comment">// 使用责任链模式开启链式调用</span><br>    <span class="hljs-keyword">return</span> chain.proceed(originalRequest);<br>}<br><br><span class="hljs-comment">// StreamAllocation 对象，它相当于一个管理类，维护了服务器连接、并发流</span><br><span class="hljs-comment">// 和请求之间的关系，该类还会初始化一个 Socket 连接对象，获取输入/输出流对象。</span><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">proceed</span><span class="hljs-params">(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span><br><span class="hljs-params">  RealConnection connection)</span> <span class="hljs-keyword">throws</span> IOException {<br>    ...<br><br>    <span class="hljs-comment">// Call the next interceptor in the chain.</span><br>    <span class="hljs-comment">// 实例化下一个拦截器对应的RealIterceptorChain对象</span><br>    <span class="hljs-type">RealInterceptorChain</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealInterceptorChain</span>(interceptors, streamAllocation, httpCodec,<br>        connection, index + <span class="hljs-number">1</span>, request, call, eventListener, connectTimeout, readTimeout,<br>        writeTimeout);<br>    <span class="hljs-comment">// 得到当前的拦截器</span><br>    <span class="hljs-type">Interceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> interceptors.get(index);<br>    <span class="hljs-comment">// 调用当前拦截器的intercept()方法，并将下一个拦截器的RealIterceptorChain对象传递下去,最后得到响应</span><br>    <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> interceptor.intercept(next);<br><br>    ...<br>    <br>    <span class="hljs-keyword">return</span> response;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="异步请求流程"><a href="#异步请求流程" class="headerlink" title="异步请求流程"></a>异步请求流程</h3><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs gradle">Request request = <span class="hljs-keyword">new</span> Request.Builder()<br>    .url(<span class="hljs-string">"http://publicobject.com/helloworld.txt"</span>)<br>    .build();<br><br>client.newCall(request).enqueue(<span class="hljs-keyword">new</span> Callback() {<br>    @Override <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {<br>      e.printStackTrace();<br>    }<br><br>    @Override <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, Response response) <span class="hljs-keyword">throws</span> IOException {<br>        ...<br>    }<br>    <br><span class="hljs-keyword">void</span> enqueue(AsyncCall <span class="hljs-keyword">call</span>) {<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {<br>        readyAsyncCalls.add(<span class="hljs-keyword">call</span>);<br>    }<br>    promoteAndExecute();<br>}<br><br><span class="hljs-comment">// 正在准备中的异步请求队列</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="hljs-keyword">new</span> ArrayDeque&lt;&gt;();<br><br><span class="hljs-comment">// 运行中的异步请求</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="hljs-keyword">new</span> ArrayDeque&lt;&gt;();<br><br><span class="hljs-comment">// 同步请求</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="hljs-keyword">new</span> ArrayDeque&lt;&gt;();<br><br><span class="hljs-comment">// Promotes eligible calls from {@link #readyAsyncCalls} to {@link #runningAsyncCalls} and runs</span><br><span class="hljs-comment">// them on the executor service. Must not be called with synchronization because executing calls</span><br><span class="hljs-comment">// can call into user code.</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> promoteAndExecute() {<br>    assert (!Thread.holdsLock(<span class="hljs-keyword">this</span>));<br><br>    List&lt;AsyncCall&gt; executableCalls = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">boolean</span> isRunning;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {<br>      <span class="hljs-keyword">for</span> (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) {<br>        AsyncCall asyncCall = i.<span class="hljs-keyword">next</span>();<br><br>        <span class="hljs-comment">// 如果其中的runningAsynCalls不满，且call占用的host小于最大数量，则将call加入到runningAsyncCalls中执行，</span><br>        <span class="hljs-comment">// 同时利用线程池执行call；否者将call加入到readyAsyncCalls中。</span><br>        <span class="hljs-keyword">if</span> (runningAsyncCalls.<span class="hljs-keyword">size</span>() &gt;= maxRequests) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Max capacity.</span><br>        <span class="hljs-keyword">if</span> (runningCallsForHost(asyncCall) &gt;= maxRequestsPerHost) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// Host max capacity.</span><br><br>        i.remove();<br>        executableCalls.add(asyncCall);<br>        runningAsyncCalls.add(asyncCall);<br>      }<br>      isRunning = runningCallsCount() &gt; <span class="hljs-number">0</span>;<br>    }<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, <span class="hljs-keyword">size</span> = executableCalls.<span class="hljs-keyword">size</span>(); i &lt; <span class="hljs-keyword">size</span>; i++) {<br>      AsyncCall asyncCall = executableCalls.get(i);<br>      asyncCall.executeOn(executorService());<br>    }<br><br>    <span class="hljs-keyword">return</span> isRunning;<br>}<br></code></pre></td></tr></tbody></table></figure><p>最后，我们在看看AsynCall的代码。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCall</span> <span class="hljs-title">extends</span> <span class="hljs-title">NamedRunnable</span> {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callback responseCallback;<br><br>    AsyncCall(Callback responseCallback) {<br>      <span class="hljs-keyword">super</span>(<span class="hljs-string">"OkHttp %s"</span>, redactedUrl());<br>      <span class="hljs-keyword">this</span>.responseCallback = responseCallback;<br>    }<br><br>    String host() {<br>      <span class="hljs-keyword">return</span> originalRequest.url().host();<br>    }<br><br>    Request request() {<br>      <span class="hljs-keyword">return</span> originalRequest;<br>    }<br><br>    RealCall <span class="hljs-keyword">get</span>() {<br>      <span class="hljs-keyword">return</span> RealCall.<span class="hljs-keyword">this</span>;<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Attempt to enqueue this async call on {<span class="hljs-doctag">@code</span>    executorService}. This will attempt to clean up</span><br><span class="hljs-comment">     * if the executor has been shut down by reporting    the call as failed.</span><br><span class="hljs-comment">     */</span><br>    void executeOn(ExecutorService executorService) {<br>      assert (!Thread.holdsLock(client.dispatcher()));<br>      boolean success = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">try</span> {<br>        executorService.execute(<span class="hljs-keyword">this</span>);<br>        success = <span class="hljs-literal">true</span>;<br>      } <span class="hljs-keyword">catch</span> (RejectedExecutionException e) {<br>        InterruptedIOException ioException = new InterruptedIOException(<span class="hljs-string">"executor rejected"</span>);<br>        ioException.initCause(e);<br>        eventListener.callFailed(RealCall.<span class="hljs-keyword">this</span>, ioException);<br>        responseCallback.onFailure(RealCall.<span class="hljs-keyword">this</span>, ioException);<br>      } <span class="hljs-keyword">finally</span> {<br>        <span class="hljs-keyword">if</span> (!success) {<br>          client.dispatcher().finished(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// This call is no longer running!</span><br>        }<br>      }<br>    }<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">protected</span> void execute() {<br>      boolean signalledCallback = <span class="hljs-literal">false</span>;<br>      timeout.enter();<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 跟同步执行一样，最后都会调用到这里</span><br>        Response response = getResponseWithInterceptorChain();<br>        <span class="hljs-keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) {<br>          signalledCallback = <span class="hljs-literal">true</span>;<br>          responseCallback.onFailure(RealCall.<span class="hljs-keyword">this</span>, new   IOException(<span class="hljs-string">"Canceled"</span>));<br>        } <span class="hljs-keyword">else</span> {<br>          signalledCallback = <span class="hljs-literal">true</span>;<br>          responseCallback.onResponse(RealCall.<span class="hljs-keyword">this</span>,   response);<br>        }<br>      } <span class="hljs-keyword">catch</span> (IOException e) {<br>        e = timeoutExit(e);<br>        <span class="hljs-keyword">if</span> (signalledCallback) {<br>          <span class="hljs-comment">// Do not signal the callback twice!</span><br>          Platform.<span class="hljs-keyword">get</span>().log(INFO, <span class="hljs-string">"Callback failure   for "</span> + toLoggableString(), e);<br>        } <span class="hljs-keyword">else</span> {<br>          eventListener.callFailed(RealCall.<span class="hljs-keyword">this</span>, e);<br>          responseCallback.onFailure(RealCall.<span class="hljs-keyword">this</span>, e);<br>        }<br>      } <span class="hljs-keyword">finally</span> {<br>        client.dispatcher().finished(<span class="hljs-keyword">this</span>);<br>      }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面的源码可以知道，拦截链的处理OKHttp帮我们默认做了五步拦截处理，其中RetryAndFollowUpInterceptor、BridgeInterceptor、CallServerInterceptor内部的源码很简洁易懂，此处不再多说。</p><h2 id="网络请求缓存处理之CacheInterceptor"><a href="#网络请求缓存处理之CacheInterceptor" class="headerlink" title="网络请求缓存处理之CacheInterceptor"></a>网络请求缓存处理之CacheInterceptor</h2><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Override public Response intercept(Chain chain) throws IOException {<br>    <span class="hljs-comment">// 根据request得到cache中缓存的response</span><br>    Response cacheCandidate = cache != null<br>        ? cache.get(chain.request<span class="hljs-literal">()</span>)<br>        : null;<br><br>    long now = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>current<span class="hljs-constructor">TimeMillis()</span>;<br><br>    <span class="hljs-comment">// request判断缓存的策略，是否要使用了网络，缓存或两者都使用</span><br>    CacheStrategy strategy = <span class="hljs-keyword">new</span> CacheStrategy.<span class="hljs-constructor">Factory(<span class="hljs-params">now</span>, <span class="hljs-params">chain</span>.<span class="hljs-params">request</span>()</span>,     cacheCandidate).get<span class="hljs-literal">()</span>;<br>    Request networkRequest = strategy.networkRequest;<br>    Response cacheResponse = strategy.cacheResponse;<br><br>    <span class="hljs-keyword">if</span> (cache != null) {<br>      cache.track<span class="hljs-constructor">Response(<span class="hljs-params">strategy</span>)</span>;<br>    }<br><br>    <span class="hljs-keyword">if</span> (cacheCandidate != null<span class="hljs-operator"> &amp;&amp; </span>cacheResponse<span class="hljs-operator"> == </span>null) {<br>      close<span class="hljs-constructor">Quietly(<span class="hljs-params">cacheCandidate</span>.<span class="hljs-params">body</span>()</span>); <span class="hljs-comment">// The cache   candidate wasn't applicable. Close it.</span><br>    }<br><br>    <span class="hljs-comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span><br>    <span class="hljs-keyword">if</span> (networkRequest<span class="hljs-operator"> == </span>null<span class="hljs-operator"> &amp;&amp; </span>cacheResponse<span class="hljs-operator"> == </span>null) {<br>      return <span class="hljs-keyword">new</span> Response.<span class="hljs-constructor">Builder()</span><br>          .request(chain.request<span class="hljs-literal">()</span>)<br>          .protocol(Protocol.HTTP_1_1)<br>          .code(<span class="hljs-number">504</span>)<br>          .message(<span class="hljs-string">"Unsatisfiable Request (only-if-cached)"</span>)<br>          .body(Util.EMPTY_RESPONSE)<br>          .sent<span class="hljs-constructor">RequestAtMillis(-1L)</span><br>          .received<span class="hljs-constructor">ResponseAtMillis(System.<span class="hljs-params">currentTimeMillis</span>()</span>)<br>          .build<span class="hljs-literal">()</span>;<br>    }<br><br>    <span class="hljs-comment">// If we don't need the network, we're done.</span><br>    <span class="hljs-keyword">if</span> (networkRequest<span class="hljs-operator"> == </span>null) {<br>      return cacheResponse.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span><br>          .cache<span class="hljs-constructor">Response(<span class="hljs-params">stripBody</span>(<span class="hljs-params">cacheResponse</span>)</span>)<br>          .build<span class="hljs-literal">()</span>;<br>    }<br><br>    Response networkResponse = null;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 调用下一个拦截器，决定从网络上来得到response</span><br>        networkResponse = chain.proceed(networkRequest);<br>    } finally {<br>        <span class="hljs-comment">// If we're crashing on I/O or otherwise,   don't leak the cache body.</span><br>        <span class="hljs-keyword">if</span> (networkResponse<span class="hljs-operator"> == </span>null<span class="hljs-operator"> &amp;&amp; </span>cacheCandidate != null) {<br>          close<span class="hljs-constructor">Quietly(<span class="hljs-params">cacheCandidate</span>.<span class="hljs-params">body</span>()</span>);<br>        }<br>    }<br><br>    <span class="hljs-comment">// If we have a cache response too, then we're doing a conditional get.</span><br>    <span class="hljs-comment">// 如果本地已经存在cacheResponse，那么让它和网络得到的networkResponse做比较，决定是否来更新缓存的cacheResponse</span><br>    <span class="hljs-keyword">if</span> (cacheResponse != null) {<br>        <span class="hljs-keyword">if</span> (networkResponse.code<span class="hljs-literal">()</span><span class="hljs-operator"> == </span>HTTP_NOT_MODIFIED)   {<br>          Response response = cacheResponse.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span><br>                  .headers(combine(cacheResponse.headers<span class="hljs-literal">()</span>, networkResponse.headers<span class="hljs-literal">()</span>))<br>                  .sent<span class="hljs-constructor">RequestAtMillis(<span class="hljs-params">networkResponse</span>.<span class="hljs-params">sentRequestAtMillis</span>()</span>)<br>                  .received<span class="hljs-constructor">ResponseAtMillis(<span class="hljs-params">networkResponse</span>.<span class="hljs-params">receivedResponseAtMillis</span>()</span>)<br>                  .cache<span class="hljs-constructor">Response(<span class="hljs-params">stripBody</span>(<span class="hljs-params">cacheResponse</span>)</span>)<br>                  .network<span class="hljs-constructor">Response(<span class="hljs-params">stripBody</span>(<span class="hljs-params">networkResponse</span>)</span>)<br>              .build<span class="hljs-literal">()</span>;<br>          networkResponse.body<span class="hljs-literal">()</span>.close<span class="hljs-literal">()</span>;<br>    <br>          <span class="hljs-comment">// Update the cache after combining headers but before stripping the</span><br>          <span class="hljs-comment">// Content-Encoding header (as performed by initContentStream()).</span><br>          cache.track<span class="hljs-constructor">ConditionalCacheHit()</span>;<br>          cache.update(cacheResponse, response);<br>          return response;<br>        } <span class="hljs-keyword">else</span> {<br>          close<span class="hljs-constructor">Quietly(<span class="hljs-params">cacheResponse</span>.<span class="hljs-params">body</span>()</span>);<br>        }<br>    }<br><br>    Response response = networkResponse.<span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span><br>        .cache<span class="hljs-constructor">Response(<span class="hljs-params">stripBody</span>(<span class="hljs-params">cacheResponse</span>)</span>)<br>        .network<span class="hljs-constructor">Response(<span class="hljs-params">stripBody</span>(<span class="hljs-params">networkResponse</span>)</span>)<br>        .build<span class="hljs-literal">()</span>;<br><br>    <span class="hljs-keyword">if</span> (cache != null) {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HttpHeaders</span>.</span></span>has<span class="hljs-constructor">Body(<span class="hljs-params">response</span>)</span><span class="hljs-operator"> &amp;&amp; </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">CacheStrategy</span>.</span></span>is<span class="hljs-constructor">Cacheable(<span class="hljs-params">response</span>,   <span class="hljs-params">networkRequest</span>)</span>) {<br>        <span class="hljs-comment">// Offer this request to the cache.</span><br>        <span class="hljs-comment">// 缓存未经缓存过的response</span><br>        CacheRequest cacheRequest = cache.put(response);<br>        return cache<span class="hljs-constructor">WritingResponse(<span class="hljs-params">cacheRequest</span>, <span class="hljs-params">response</span>)</span>;<br>      }<br><br>      <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HttpMethod</span>.</span></span>invalidates<span class="hljs-constructor">Cache(<span class="hljs-params">networkRequest</span>.<span class="hljs-params">method</span>()</span>)) {<br>        <span class="hljs-keyword">try</span> {<br>          cache.remove(networkRequest);<br>        } catch (IOException ignored) {<br>          <span class="hljs-comment">// The cache cannot be written.</span><br>        }<br>      }<br>    }<br><br>    return response;<br>}<br></code></pre></td></tr></tbody></table></figure><p>缓存拦截器会根据请求的信息和缓存的响应的信息来判断是否存在缓存可用，如果有可以使用的缓存，那么就返回该缓存给用户，否则就继续使用责任链模式来从服务器中获取响应。当获取到响应的时候，又会把响应缓存到磁盘上面。</p><h2 id="ConnectInterceptor之连接池"><a href="#ConnectInterceptor之连接池" class="headerlink" title="ConnectInterceptor之连接池"></a>ConnectInterceptor之连接池</h2><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs gradle">@Override <span class="hljs-keyword">public</span> Response intercept(Chain chain) <span class="hljs-keyword">throws</span> IOException {<br>    RealInterceptorChain realChain = (RealInterceptorChain) chain;<br>    Request request = realChain.request();<br>    StreamAllocation streamAllocation = realChain.streamAllocation();<br><br>    <span class="hljs-comment">// We need the network to satisfy this request.     Possibly for validating a conditional GET.</span><br>    <span class="hljs-keyword">boolean</span> doExtensiveHealthChecks = !request.method().equals(<span class="hljs-string">"GET"</span>);<br>    <span class="hljs-comment">// HttpCodec是对 HTTP 协议操作的抽象，有两个实现：Http1Codec和Http2Codec，顾名思义，它们分别对应 HTTP/1.1 和 HTTP/2 版本的实现。在这个方法的内部实现连接池的复用处理</span><br>    HttpCodec httpCodec = streamAllocation.newStream(client, chain,     doExtensiveHealthChecks);<br>    RealConnection connection = streamAllocation.connection();<br><br>    <span class="hljs-keyword">return</span> realChain.proceed(request, streamAllocation, httpCodec, connection);<br>}<br><br><br><br><span class="hljs-comment">// Returns a connection to host a new stream. This // prefers the existing connection if it exists,</span><br><span class="hljs-comment">// then the pool, finally building a new connection.</span><br><span class="hljs-comment">// 调用 streamAllocation 的 newStream() 方法的时候，最终会经过一系列</span><br><span class="hljs-comment">// 的判断到达 StreamAllocation 中的 findConnection() 方法</span><br><span class="hljs-keyword">private</span> RealConnection findConnection(<span class="hljs-keyword">int</span>   connectTimeout, <span class="hljs-keyword">int</span> readTimeout, <span class="hljs-keyword">int</span> writeTimeout,<br>    <span class="hljs-keyword">int</span> pingIntervalMillis, <span class="hljs-keyword">boolean</span> connectionRetryEnabled) <span class="hljs-keyword">throws</span> IOException {<br>      ...<br>    <br>      <span class="hljs-comment">// Attempt to use an already-allocated connection. We need to be careful here because our</span><br>      <span class="hljs-comment">// already-allocated connection may have been restricted from creating new streams.</span><br>      <span class="hljs-comment">// 尝试使用已分配的连接，已经分配的连接可能已经被限制创建新的流</span><br>      releasedConnection = <span class="hljs-keyword">this</span>.connection;<br>      <span class="hljs-comment">// 释放当前连接的资源，如果该连接已经被限制创建新的流，就返回一个Socket以关闭连接</span><br>      toClose = releaseIfNoNewStreams();<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connection != <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-comment">// We had an already-allocated connection and it's good.</span><br>        result = <span class="hljs-keyword">this</span>.connection;<br>        releasedConnection = <span class="hljs-keyword">null</span>;<br>      }<br>      <span class="hljs-keyword">if</span> (!reportedAcquired) {<br>        <span class="hljs-comment">// If the connection was never reported acquired, don't report it as released!</span><br>        <span class="hljs-comment">// 如果该连接从未被标记为获得，不要标记为发布状态，reportedAcquired 通过 acquire()   方法修改</span><br>        releasedConnection = <span class="hljs-keyword">null</span>;<br>      }<br>    <br>      <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-comment">// Attempt to get a connection from the pool.</span><br>        <span class="hljs-comment">// 尝试供连接池中获取一个连接</span><br>        Internal.instance.get(connectionPool, address, <span class="hljs-keyword">this</span>, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-keyword">if</span> (connection != <span class="hljs-keyword">null</span>) {<br>          foundPooledConnection = <span class="hljs-keyword">true</span>;<br>          result = connection;<br>        } <span class="hljs-keyword">else</span> {<br>          selectedRoute = route;<br>        }<br>      }<br>    }<br>    <span class="hljs-comment">// 关闭连接</span><br>    closeQuietly(toClose);<br>    <br>    <span class="hljs-keyword">if</span> (releasedConnection != <span class="hljs-keyword">null</span>) {<br>      eventListener.connectionReleased(<span class="hljs-keyword">call</span>, releasedConnection);<br>    }<br>    <span class="hljs-keyword">if</span> (foundPooledConnection) {<br>      eventListener.connectionAcquired(<span class="hljs-keyword">call</span>, result);<br>    }<br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-keyword">null</span>) {<br>      <span class="hljs-comment">// If we found an already-allocated or pooled connection, we're done.</span><br>      <span class="hljs-comment">// 如果已经从连接池中获取到了一个连接，就将其返回</span><br>      <span class="hljs-keyword">return</span> result;<br>    }<br>    <br>    <span class="hljs-comment">// If we need a route selection, make one. This   is a blocking operation.</span><br>    <span class="hljs-keyword">boolean</span> newRouteSelection = <span class="hljs-keyword">false</span>;<br>    <span class="hljs-keyword">if</span> (selectedRoute == <span class="hljs-keyword">null</span> &amp;&amp; (routeSelection == <span class="hljs-keyword">null</span> || !routeSelection.hasNext())) {<br>      newRouteSelection = <span class="hljs-keyword">true</span>;<br>      routeSelection = routeSelector.<span class="hljs-keyword">next</span>();<br>    }<br>    <br>    <span class="hljs-keyword">synchronized</span> (connectionPool) {<br>      <span class="hljs-keyword">if</span> (canceled) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"Canceled"</span>);<br>    <br>      <span class="hljs-keyword">if</span> (newRouteSelection) {<br>        <span class="hljs-comment">// Now that we have a set of IP addresses,   make another attempt at getting a   connection from</span><br>        <span class="hljs-comment">// the pool. This could match due to   connection coalescing.</span><br>         <span class="hljs-comment">// 根据一系列的 IP地址从连接池中获取一个链接</span><br>        List&lt;Route&gt; routes = routeSelection.getAll();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, <span class="hljs-keyword">size</span> = routes.<span class="hljs-keyword">size</span>(); i &lt; <span class="hljs-keyword">size</span>;i++) {<br>          Route route = routes.get(i);<br>          <span class="hljs-comment">// 从连接池中获取一个连接</span><br>          Internal.instance.get(connectionPool, address, <span class="hljs-keyword">this</span>, route);<br>          <span class="hljs-keyword">if</span> (connection != <span class="hljs-keyword">null</span>) {<br>            foundPooledConnection = <span class="hljs-keyword">true</span>;<br>            result = connection;<br>            <span class="hljs-keyword">this</span>.route = route;<br>            <span class="hljs-keyword">break</span>;<br>          }<br>        }<br>      }<br>    <br>      <span class="hljs-keyword">if</span> (!foundPooledConnection) {<br>        <span class="hljs-keyword">if</span> (selectedRoute == <span class="hljs-keyword">null</span>) {<br>          selectedRoute = routeSelection.<span class="hljs-keyword">next</span>();<br>        }<br>    <br>        <span class="hljs-comment">// Create a connection and assign it to this allocation immediately. This makes it   possible</span><br>        <span class="hljs-comment">// for an asynchronous cancel() to interrupt the handshake we're about to do.</span><br>        <span class="hljs-comment">// 在连接池中如果没有该连接，则创建一个新的连接，并将其分配，这样我们就可以在握手之前进行终端</span><br>        route = selectedRoute;<br>        refusedStreamCount = <span class="hljs-number">0</span>;<br>        result = <span class="hljs-keyword">new</span> RealConnection(connectionPool, selectedRoute);<br>        acquire(result, <span class="hljs-keyword">false</span>);<br>      }<br>    }<br>    <span class="hljs-comment">// If we found a pooled connection on the 2nd time around, we're done.</span><br>    <span class="hljs-keyword">if</span> (foundPooledConnection) {<br>    <span class="hljs-comment">// 如果我们在第二次的时候发现了一个池连接，那么我们就将其返回</span><br>      eventListener.connectionAcquired(<span class="hljs-keyword">call</span>, result);<br>      <span class="hljs-keyword">return</span> result;<br>    }<br><br>    <span class="hljs-comment">// Do TCP + TLS handshakes. This is a blocking     operation.</span><br>     <span class="hljs-comment">// 进行 TCP 和 TLS 握手</span><br>    result.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis,<br>      connectionRetryEnabled, <span class="hljs-keyword">call</span>, eventListener);<br>    routeDatabase().connected(result.route());<br><br>    Socket socket = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">synchronized</span> (connectionPool) {<br>      reportedAcquired = <span class="hljs-keyword">true</span>;<br><br>      <span class="hljs-comment">// Pool the connection.</span><br>      <span class="hljs-comment">// 将该连接放进连接池中</span><br>      Internal.instance.put(connectionPool, result);<br><br>      <span class="hljs-comment">// If another multiplexed connection to the same   address was created concurrently, then</span><br>      <span class="hljs-comment">// release this connection and acquire that one.</span><br>      <span class="hljs-comment">// 如果同时创建了另一个到同一地址的多路复用连接，释放这个连接并获取那个连接</span><br>      <span class="hljs-keyword">if</span> (result.isMultiplexed()) {<br>        socket = Internal.instance.deduplicate(connectionPool, address, <span class="hljs-keyword">this</span>);<br>        result = connection;<br>      }<br>    }<br>    closeQuietly(socket);<br><br>    eventListener.connectionAcquired(<span class="hljs-keyword">call</span>, result);<br>    <span class="hljs-keyword">return</span> result;<br>}<br></code></pre></td></tr></tbody></table></figure><p>从以上的源码分析可知：</p><ul><li>判断当前的连接是否可以使用：流是否已经被关闭，并且已经被限制创建新的流；</li><li>如果当前的连接无法使用，就从连接池中获取一个连接；</li><li>连接池中也没有发现可用的连接，创建一个新的连接，并进行握手，然后将其放到连接池中。</li></ul><p>在从连接池中获取一个连接的时候，使用了 Internal 的 get() 方法。Internal 有一个静态的实例，会在 OkHttpClient<br>的静态代码快中被初始化。我们会在 Internal 的 get() 中调用连接池的 get() 方法来得到一个连接。并且，从中我们明白了连接复用的一个好处就是省去了进行<br>TCP 和 TLS 握手的一个过程。因为建立连接本身也是需要消耗一些时间的，连接被复用之后可以提升我们网络访问的效率。</p><p>接下来详细分析下ConnectionPool是如何实现连接管理的。</p><p>OkHttp 的缓存管理分成两个步骤，一边当我们创建了一个新的连接的时候，我们要把它放进缓存里面；另一边，我们还要来对缓存进行清理。在<br>ConnectionPool 中，当我们向连接池中缓存一个连接的时候，只要调用双端队列的 add() 方法，将其加入到双端队列即可，而清理连接缓存的操作则交给线程池来定时执行。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;RealConnection&gt; connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(RealConnection connection)</span> {<br><span class="hljs-keyword">assert</span> (Thread.holdsLock(<span class="hljs-built_in">this</span>));<br>    <span class="hljs-keyword">if</span> (!cleanupRunning) {<br>      cleanupRunning = <span class="hljs-literal">true</span>;<br>      <span class="hljs-comment">// 使用线程池执行清理任务</span><br>      executor.execute(cleanupRunnable);<br>    }<br>    <span class="hljs-comment">// 将新建的连接插入到双端队列中</span><br>    connections.add(connection);<br>}<br><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">cleanupRunnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {<br><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<br>        <span class="hljs-comment">// 内部调用 cleanup() 方法来清理无效的连接</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">waitNanos</span> <span class="hljs-operator">=</span> cleanup(System.nanoTime());<br>        <span class="hljs-keyword">if</span> (waitNanos == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">if</span> (waitNanos &gt; <span class="hljs-number">0</span>) {<br>          <span class="hljs-type">long</span> <span class="hljs-variable">waitMillis</span> <span class="hljs-operator">=</span> waitNanos / <span class="hljs-number">1000000L</span>;<br>          waitNanos -= (waitMillis * <span class="hljs-number">1000000L</span>);<br>          <span class="hljs-keyword">synchronized</span> (ConnectionPool.<span class="hljs-built_in">this</span>) {<br>            <span class="hljs-keyword">try</span> {<br>              ConnectionPool.<span class="hljs-built_in">this</span>.wait(waitMillis, (<span class="hljs-type">int</span>) waitNanos);<br>            } <span class="hljs-keyword">catch</span> (InterruptedException ignored) {<br>            }<br>          }<br>        }<br>    }<br>};<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">(<span class="hljs-type">long</span> now)</span> {<br>    <span class="hljs-type">int</span> <span class="hljs-variable">inUseConnectionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">idleConnectionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">RealConnection</span> <span class="hljs-variable">longestIdleConnection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">longestIdleDurationNs</span> <span class="hljs-operator">=</span> Long.MIN_VALUE;<br><br>    <span class="hljs-comment">// Find either a connection to evict, or the time that the next eviction is due.</span><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {<br>        <span class="hljs-comment">// 遍历所有的连接</span><br>        <span class="hljs-keyword">for</span> (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) {<br>          <span class="hljs-type">RealConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> i.next();<br>    <br>          <span class="hljs-comment">// If the connection is in use, keep     searching.</span><br>          <span class="hljs-comment">// 遍历所有的连接</span><br>          <span class="hljs-keyword">if</span> (pruneAndGetAllocationCount(connection, now) &gt; <span class="hljs-number">0</span>) {<br>            inUseConnectionCount++;<br>            <span class="hljs-keyword">continue</span>;<br>          }<br>    <br>          idleConnectionCount++;<br>    <br>          <span class="hljs-comment">// If the connection is ready to be     evicted,     we're done.</span><br>          <span class="hljs-comment">// 如果找到了一个可以被清理的连接，会尝试去寻找闲置时间最久的连接来释放</span><br>          <span class="hljs-type">long</span> <span class="hljs-variable">idleDurationNs</span> <span class="hljs-operator">=</span> now - connection.idleAtNanos;<br>          <span class="hljs-keyword">if</span> (idleDurationNs &gt; longestIdleDurationNs) {<br>            longestIdleDurationNs = idleDurationNs;<br>            longestIdleConnection = connection;<br>          }<br>        }<br>    <br>        <span class="hljs-comment">// maxIdleConnections 表示最大允许的闲置的连接的数量,keepAliveDurationNs表示连接允许存活的最长的时间。</span><br>        <span class="hljs-comment">// 默认空闲连接最大数目为5个，keepalive 时间最长为5分钟。</span><br>        <span class="hljs-keyword">if</span> (longestIdleDurationNs &gt;= <span class="hljs-built_in">this</span>.keepAliveDurationNs<br>            || idleConnectionCount &gt; <span class="hljs-built_in">this</span>.maxIdleConnections) {<br>          <span class="hljs-comment">// We've found a connection to evict. Remove it from the list, then close it     below (outside</span><br>          <span class="hljs-comment">// of the synchronized block).</span><br>          <span class="hljs-comment">// 该连接的时长超出了最大的活跃时长或者闲置的连接数量超出了最大允许的范围，直接移除</span><br>          connections.remove(longestIdleConnection);<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idleConnectionCount &gt; <span class="hljs-number">0</span>) {<br>          <span class="hljs-comment">// A connection will be ready to evict soon.</span><br>          <span class="hljs-comment">// 闲置的连接的数量大于0，停顿指定的时间（等会儿会将其清理掉，现在还不是时候）</span><br>          <span class="hljs-keyword">return</span> keepAliveDurationNs - longestIdleDurationNs;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (inUseConnectionCount &gt; <span class="hljs-number">0</span>) {<br>          <span class="hljs-comment">// All connections are in use. It'll be at least the keep alive duration 'til we run again.</span><br>          <span class="hljs-comment">// 所有的连接都在使用中，5分钟后再清理</span><br>          <span class="hljs-keyword">return</span> keepAliveDurationNs;<br>        } <span class="hljs-keyword">else</span> {<br>          <span class="hljs-comment">// No connections, idle or in use.</span><br>           <span class="hljs-comment">// 没有连接</span><br>          cleanupRunning = <span class="hljs-literal">false</span>;<br>          <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>      }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从以上的源码分析可知，首先会对缓存中的连接进行遍历，以寻找一个闲置时间最长的连接，然后根据该连接的闲置时长和最大允许的连接数量等参数来决定是否应该清理该连接。同时注意上面的方法的返回值是一个时间，如果闲置时间最长的连接仍然需要一段时间才能被清理的时候，会返回这段时间的时间差，然后会在这段时间之后再次对连接池进行清理。</p><blockquote></blockquote><p>经过上面对OKHttp内部工作机制的一系列分析，相信你已经对OKHttp已经有了一个比较深入的了解了。首先，我们会在请求的时候初始化一个Call的实例，然后执行它的execute()<br>方法或enqueue()方法，内部最后都会执行到getResponseWithInterceptorChain()<br>方法，这个方法里面通过拦截器组成的责任链，依次经过用户自定义普通拦截器、重试拦截器、桥接拦截器、缓存拦截器、连接拦截器和用户自定义网络拦截器以及访问服务器拦截器等拦截处理过程，来获取到一个响应并交给用户。</p><blockquote><p>其中，除了OKHttp的内部请求流程这点之外，缓存和连接这两部分内容也是两个很重要的点，相信经过讲解，大家对这三部分重点内容已经有了自己的理解。</p></blockquote><h1 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a>Retrofit</h1><h2 id="基本使用流程"><a href="#基本使用流程" class="headerlink" title="基本使用流程"></a>基本使用流程</h2><h3 id="定义HTTP-API，用于描述请求"><a href="#定义HTTP-API，用于描述请求" class="headerlink" title="定义HTTP API，用于描述请求"></a>定义HTTP API，用于描述请求</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">GitHubService</span> {<br><br>     <span class="hljs-variable">@GET</span>(<span class="hljs-string">"users/{user}/repos"</span>)<br>     Call&lt;List&lt;Repo&gt;&gt; <span class="hljs-built_in">listRepos</span>(<span class="hljs-variable">@Path</span>(<span class="hljs-string">"user"</span>) String user);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="创建Retrofit并生成API的实现"><a href="#创建Retrofit并生成API的实现" class="headerlink" title="创建Retrofit并生成API的实现"></a>创建Retrofit并生成API的实现</h3><blockquote><p>（<strong>注意：</strong> 方法上面的注解表示请求的接口部分，返回类型是请求的返回值类型，方法的参数即是请求的参数）</p></blockquote><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 1.Retrofit构建过程</span><br>Retrofit retrofit = <span class="hljs-keyword">new</span> Retrofit.<span class="hljs-constructor">Builder()</span><br>.base<span class="hljs-constructor">Url(<span class="hljs-string">"https://api.github.com/"</span>)</span><br>.build<span class="hljs-literal">()</span>;<br><br><span class="hljs-comment">// 2.创建网络请求接口类实例过程</span><br>GitHubService service = retrofit.create(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">GitHubService</span>.</span></span><span class="hljs-keyword">class</span>);<br></code></pre></td></tr></tbody></table></figure><h3 id="调用API方法，生成Call，执行请求"><a href="#调用API方法，生成Call，执行请求" class="headerlink" title="调用API方法，生成Call，执行请求"></a>调用API方法，生成Call，执行请求</h3><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// 3.生成并执行请求过程</span><br><span class="hljs-type">Call</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">Repo</span>&gt;&gt; repos <span class="hljs-operator">=</span> service.listRepos(<span class="hljs-string">"octocat"</span>);<br>repos.execute() or repos.enqueue()<br></code></pre></td></tr></tbody></table></figure><p>Retrofit的基本使用流程很简洁，但是简洁并不代表简单，Retrofit为了实现这种简洁的使用流程，内部使用了优秀的架构设计和大量的设计模式，在分析过Retrofit最新版的源码和大量优秀的Retrofit源码分析文章后发现，要想真正理解Retrofit内部的核心源码流程和设计思想，首先，需要对这九大设计模式有一定的了解，如下：</p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs">1.Retrofit构建过程 <br>建造者模式、工厂方法模式<br><br>2.创建网络请求接口实例过程<br>外观模式、代理模式、单例模式、策略模式、装饰模式（建造者模式）<br><br>3.生成并执行请求过程<br>适配器模式（代理模式、装饰模式）<br></code></pre></td></tr></tbody></table></figure><p>其次，需要对OKHttp源码有一定的了解。让我们按以上流程去深入Retrofit源码内部，领悟它带给我们的<strong>设计之美</strong>。</p><h2 id="Retrofit构建过程"><a href="#Retrofit构建过程" class="headerlink" title="Retrofit构建过程"></a>Retrofit构建过程</h2><h3 id="Retrofit核心对象解析"><a href="#Retrofit核心对象解析" class="headerlink" title="Retrofit核心对象解析"></a>Retrofit核心对象解析</h3><p>首先Retrofit中有一个全局变量非常关键，在V2.5之前的版本，使用的是LinkedHashMap()，它是一个网络请求配置对象，是由网络请求接口中方法注解进行解析后得到的。</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Retrofit</span> {<br><br>    <span class="hljs-comment">// 网络请求配置对象，存储网络请求相关的配置，如网络请求的方法、数据转换器、网络请求适配器、网络请求工厂、基地址等</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Method</span>, <span class="hljs-type">ServiceMethod</span>&lt;?&gt;&gt; serviceMethodCache <span class="hljs-operator">=</span> new <span class="hljs-type">ConcurrentHashMap</span>&lt;&gt;();<br></code></pre></td></tr></tbody></table></figure><p>Retrofit使用了建造者模式通过内部类Builder类建立一个Retrofit实例，如下：</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {<br><br>    <span class="hljs-comment">// 平台类型对象（Platform -&gt; Android)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Platform</span> platform;<br>    <span class="hljs-comment">// 网络请求工厂，默认使用OkHttpCall（工厂方法模式）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> okhttp3.<span class="hljs-type">Call</span>.<span class="hljs-type">Factory</span> callFactory;<br>    <span class="hljs-comment">// 网络请求的url地址</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> <span class="hljs-type">HttpUrl</span> baseUrl;<br>    <span class="hljs-comment">// 数据转换器工厂的集合</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Converter</span>.<span class="hljs-type">Factory</span>&gt; converterFactories <span class="hljs-operator">=</span> new <span class="hljs-type">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 网络请求适配器工厂的集合，默认是ExecutorCallAdapterFactory</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">CallAdapter</span>.<span class="hljs-type">Factory</span>&gt; callAdapterFactories <span class="hljs-operator">=</span> new <span class="hljs-type">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 回调方法执行器，在 Android 上默认是封装了 handler 的 MainThreadExecutor, 默认作用是：切换线程（子线程 -&gt; 主线程）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> <span class="hljs-type">Executor</span> callbackExecutor;<br>    <span class="hljs-comment">// 一个开关，为true则会缓存创建的ServiceMethod</span><br>    <span class="hljs-keyword">private</span> boolean validateEagerly;<br></code></pre></td></tr></tbody></table></figure><h3 id="Builder内部构造"><a href="#Builder内部构造" class="headerlink" title="Builder内部构造"></a>Builder内部构造</h3><p>下面看看Builder内部构造做了什么。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {<br><br>    ...<br>    <br>    Builder(Platform platform) {<br>        <span class="hljs-built_in">this</span>.platform = platform;<br>    }<br><br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">()</span> {<br>        <span class="hljs-built_in">this</span>(Platform.get());<br>    }<br>    <br>    ...<br>    <br>}<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Platform</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Platform</span> <span class="hljs-variable">PLATFORM</span> <span class="hljs-operator">=</span> findPlatform();<br>    <br>    <span class="hljs-keyword">static</span> Platform <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {<br>      <span class="hljs-keyword">return</span> PLATFORM;<br>    }<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Platform <span class="hljs-title function_">findPlatform</span><span class="hljs-params">()</span> {<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 使用JVM加载类的方式判断是否是Android平台</span><br>        Class.forName(<span class="hljs-string">"android.os.Build"</span>);<br>        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT != <span class="hljs-number">0</span>) {<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Android</span>();<br>        }<br>      } <span class="hljs-keyword">catch</span> (ClassNotFoundException ignored) {<br>      }<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 同时支持Java平台</span><br>        Class.forName(<span class="hljs-string">"java.util.Optional"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Java8</span>();<br>      } <span class="hljs-keyword">catch</span> (ClassNotFoundException ignored) {<br>      }<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Platform</span>();<br>    }<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Android</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Platform</span> {<br><br>    ...<br><br>    <br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">defaultCallbackExecutor</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">//切换线程（子线程 -&gt; 主线程）</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainThreadExecutor</span>();<br>    }<br><br>    <span class="hljs-comment">// 创建默认的网络请求适配器工厂，如果是Android7.0或Java8上，则使</span><br>    <span class="hljs-comment">// 用了并发包中的CompletableFuture保证了回调的同步</span><br>    <span class="hljs-comment">// 在Retrofit中提供了四种CallAdapterFactory(策略模式)：</span><br>    <span class="hljs-comment">// ExecutorCallAdapterFactory（默认）、GuavaCallAdapterFactory、</span><br>    <span class="hljs-comment">// va8CallAdapterFactory、RxJavaCallAdapterFactory</span><br>    <span class="hljs-meta">@Override</span> List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CallAdapter</span>.Factory&gt; defaultCallAdapterFactories(<br>        <span class="hljs-meta">@Nullable</span> Executor callbackExecutor) {<br>      <span class="hljs-keyword">if</span> (callbackExecutor == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>();<br>      <span class="hljs-type">ExecutorCallAdapterFactory</span> <span class="hljs-variable">executorFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span>   <span class="hljs-title class_">ExecutorCallAdapterFactory</span>(callbackExecutor);<br>      <span class="hljs-keyword">return</span> Build.VERSION.SDK_INT &gt;= <span class="hljs-number">24</span><br>        ? asList(CompletableFutureCallAdapterFactory.INSTANCE, executorFactory)<br>        : singletonList(executorFactory);<br>    }<br>    <br>    ...<br><br>    <span class="hljs-meta">@Override</span> List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Converter</span>.Factory&gt; defaultConverterFactories() {<br>      <span class="hljs-keyword">return</span> Build.VERSION.SDK_INT &gt;= <span class="hljs-number">24</span><br>          ? singletonList(OptionalConverterFactory.INSTANCE)<br>          : Collections.&lt;Converter.Factory&gt;emptyList();<br>    }<br><br>    ...<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainThreadExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {<br>    <br>        <span class="hljs-comment">// 获取Android 主线程的Handler </span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper());<br><br>        <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable r)</span> {<br>        <br>            <span class="hljs-comment">// 在UI线程对网络请求返回数据处理</span><br>            handler.post(r);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，在Builder内部构造时设置了默认Platform、callAdapterFactories和callbackExecutor。</p><h3 id="添加baseUrl"><a href="#添加baseUrl" class="headerlink" title="添加baseUrl"></a>添加baseUrl</h3><p>很简单，就是将String类型的url转换为OkHttp的HttpUrl过程如下：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Set the API base URL.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @see #baseUrl(HttpUrl)</span><br><span class="hljs-comment"> */</span><br>public Builder base<span class="hljs-constructor">Url(String <span class="hljs-params">baseUrl</span>)</span> {<br>    check<span class="hljs-constructor">NotNull(<span class="hljs-params">baseUrl</span>, <span class="hljs-string">"baseUrl == null"</span>)</span>;<br>    return base<span class="hljs-constructor">Url(HttpUrl.<span class="hljs-params">get</span>(<span class="hljs-params">baseUrl</span>)</span>);<br>}<br><br>public Builder base<span class="hljs-constructor">Url(HttpUrl <span class="hljs-params">baseUrl</span>)</span> {<br>    check<span class="hljs-constructor">NotNull(<span class="hljs-params">baseUrl</span>, <span class="hljs-string">"baseUrl == null"</span>)</span>;<br>    List&lt;String&gt; pathSegments = baseUrl.path<span class="hljs-constructor">Segments()</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">""</span>.equals(pathSegments.get(pathSegments.size<span class="hljs-literal">()</span> - <span class="hljs-number">1</span>))) {<br>      throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">IllegalArgumentException(<span class="hljs-string">"baseUrl must end in /: "</span> + <span class="hljs-params">baseUrl</span>)</span>;<br>    }<br>    this.baseUrl = baseUrl;<br>    return this;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="添加GsonConverterFactory"><a href="#添加GsonConverterFactory" class="headerlink" title="添加GsonConverterFactory"></a>添加GsonConverterFactory</h3><p>首先，看到GsonConverterFactory.creat()的源码。</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GsonConverterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Converter</span>.<span class="hljs-title">Factory</span> </span>{<br> <br>    public static <span class="hljs-type">GsonConverterFactory</span> create() {<br>        <span class="hljs-keyword">return</span> create(<span class="hljs-keyword">new</span> <span class="hljs-type">Gson</span>());<br>    }<br>    <br>    <br>    public static <span class="hljs-type">GsonConverterFactory</span> create(<span class="hljs-type">Gson</span> gson) {<br>        <span class="hljs-keyword">if</span> (gson == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">NullPointerException</span>(<span class="hljs-string">"gson ==   null"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">GsonConverterFactory</span>(gson);<br>    }<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Gson</span> gson;<br>    <br>    <span class="hljs-comment">// 创建了一个含有Gson对象实例的GsonConverterFactory</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">GsonConverterFactory</span>(<span class="hljs-type">Gson</span> gson) {<br>        <span class="hljs-keyword">this</span>.gson = gson;<br>    }<br><br></code></pre></td></tr></tbody></table></figure><p>然后，看看addConverterFactory()方法内部。</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> Builder <span class="hljs-title">addConverterFactory</span>(<span class="hljs-params">Converter.Factory factory</span>)</span> {<br>    converterFactories.<span class="hljs-keyword">add</span>(checkNotNull(factory, <span class="hljs-string">"factory null"</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可知，这一步是将一个含有Gson对象实例的GsonConverterFactory放入到了数据转换器工厂converterFactories里。</p><h3 id="build过程"><a href="#build过程" class="headerlink" title="build过程"></a>build过程</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Retrofit build<span class="hljs-literal">()</span> {<br><br>    <span class="hljs-keyword">if</span> (baseUrl<span class="hljs-operator"> == </span>null) {<br>      throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">IllegalStateException(<span class="hljs-string">"Base URL required."</span>)</span>;<br>    }<br>    <br>    okhttp3.Call.Factory callFactory = this.callFactory;<br>    <span class="hljs-keyword">if</span> (callFactory<span class="hljs-operator"> == </span>null) {<br>        <span class="hljs-comment">// 默认使用okhttp</span><br>         callFactory = <span class="hljs-keyword">new</span> <span class="hljs-constructor">OkHttpClient()</span>;<br>    }<br>    <br>    Executor callbackExecutor = this.callbackExecutor;<br>    <span class="hljs-keyword">if</span> (callbackExecutor<span class="hljs-operator"> == </span>null) {<br>        <span class="hljs-comment">// Android默认的callbackExecutor</span><br>        callbackExecutor = platform.default<span class="hljs-constructor">CallbackExecutor()</span>;<br>    }<br>    <br>    <span class="hljs-comment">// Make a defensive copy of the adapters and add the defaultCall adapter.</span><br>    List&lt;CallAdapter.Factory&gt; callAdapterFactories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(this.callAdapterFactories);<br>    <span class="hljs-comment">// 添加默认适配器工厂在集合尾部</span><br>    callAdapterFactories.add<span class="hljs-constructor">All(<span class="hljs-params">platform</span>.<span class="hljs-params">defaultCallAdapterFactorisca</span>  <span class="hljs-params">llbackExecutor</span>)</span>);<br>    <br>    <span class="hljs-comment">// Make a defensive copy of the converters.</span><br>    List&lt;Converter.Factory&gt; converterFactories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<br>        <span class="hljs-number">1</span> + this.converterFactories.size<span class="hljs-literal">()</span> + platform.default<span class="hljs-constructor">ConverterFactoriesSize()</span>);<br>    <span class="hljs-comment">// Add the built-in converter factory first. This prevents overriding its behavior but also</span><br>    <span class="hljs-comment">// ensures correct behavior when using converters thatconsumeall types.</span><br>    converterFactories.add(<span class="hljs-keyword">new</span> <span class="hljs-constructor">BuiltInConverters()</span>);<br>    converterFactories.add<span class="hljs-constructor">All(<span class="hljs-params">this</span>.<span class="hljs-params">converterFactories</span>)</span>;<br>    converterFactories.add<span class="hljs-constructor">All(<span class="hljs-params">platform</span>.<span class="hljs-params">defaultConverterFactories</span>()</span>;<br>    <br>    return <span class="hljs-keyword">new</span> <span class="hljs-constructor">Retrofit(<span class="hljs-params">callFactory</span>, <span class="hljs-params">baseUrl</span>, <span class="hljs-params">unmodifiableList</span>(<span class="hljs-params">converterFactories</span>)</span>,<br>        unmodifiable<span class="hljs-constructor">List(<span class="hljs-params">callAdapterFactories</span>)</span>, callbackExecutor, validateEagerly);<br>        <br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，最终我们在Builder类中看到的6大核心对象都已经配置到Retrofit对象中了。</p><h2 id="创建网络请求接口实例过程"><a href="#创建网络请求接口实例过程" class="headerlink" title="创建网络请求接口实例过程"></a>创建网络请求接口实例过程</h2><p>retrofit.create()使用了外观模式和代理模式创建了网络请求的接口实例，我们分析下create方法。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public &lt;T&gt; T create(final Class&lt;T&gt; service) {<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>validate<span class="hljs-constructor">ServiceInterface(<span class="hljs-params">service</span>)</span>;<br>    <span class="hljs-keyword">if</span> (validateEagerly) {<br>        <span class="hljs-comment">// 判断是否需要提前缓存ServiceMethod对象</span><br>        eagerly<span class="hljs-constructor">ValidateMethods(<span class="hljs-params">service</span>)</span>;<br>    }<br>    <br>    <span class="hljs-comment">// 使用动态代理拿到请求接口所有注解配置后，创建网络请求接口实例</span><br>    return (T) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Proxy</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">ProxyInstance(<span class="hljs-params">service</span>.<span class="hljs-params">getClassLoader</span>()</span>, <span class="hljs-keyword">new</span>  Class&lt;?&gt;<span class="hljs-literal">[]</span> { service },<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">InvocationHandler()</span> {<br>          <span class="hljs-keyword">private</span> final Platform platform = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Platform</span>.</span></span>get<span class="hljs-literal">()</span>;<br>          <span class="hljs-keyword">private</span> final Object<span class="hljs-literal">[]</span> emptyArgs = <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>;<br><br>          @Override public Object invoke(Object proxy, Method <span class="hljs-keyword">method</span>, @Nullable Object<span class="hljs-literal">[]</span> args)<br>              throws Throwable {<br>            <span class="hljs-comment">// If the method is a method from Object then defer to normal invocation.</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">method</span>.get<span class="hljs-constructor">DeclaringClass()</span><span class="hljs-operator"> == </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Object</span>.</span></span><span class="hljs-keyword">class</span>) {<br>              return <span class="hljs-keyword">method</span>.invoke(this, args);<br>            }<br>            <span class="hljs-keyword">if</span> (platform.is<span class="hljs-constructor">DefaultMethod(<span class="hljs-params">method</span>)</span>) {<br>              return platform.invoke<span class="hljs-constructor">DefaultMethod(<span class="hljs-params">method</span>, <span class="hljs-params">service</span>, <span class="hljs-params">proxy</span>, <span class="hljs-params">args</span>)</span>;<br>            }<br>            return load<span class="hljs-constructor">ServiceMethod(<span class="hljs-params">method</span>)</span>.invoke(args != null ? args : emptyArgs);<br>          }<br>    });<br> }<br><br><span class="hljs-keyword">private</span> void eagerly<span class="hljs-constructor">ValidateMethods(Class&lt;?&gt; <span class="hljs-params">service</span>)</span> {<br><br>  Platform platform = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Platform</span>.</span></span>get<span class="hljs-literal">()</span>;<br>  <span class="hljs-keyword">for</span> (Method <span class="hljs-keyword">method</span> : service.get<span class="hljs-constructor">DeclaredMethods()</span>) {<br>    <span class="hljs-keyword">if</span> (!platform.is<span class="hljs-constructor">DefaultMethod(<span class="hljs-params">method</span>)</span>) {<br>      load<span class="hljs-constructor">ServiceMethod(<span class="hljs-params">method</span>)</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>继续看看loadServiceMethod的内部流程</p><figure class="highlight oxygene"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">ServiceMethod&lt;?&gt; loadServiceMethod(<span class="hljs-keyword">Method</span> <span class="hljs-title function_">method</span>) <span class="hljs-comment">{</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    ServiceMethod&lt;?&gt; result = serviceMethodCache.get(method);</span><br><span class="hljs-comment">    if (result != null) return result;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    synchronized (serviceMethodCache) {</span><br><span class="hljs-comment">      result = serviceMethodCache.get(method);</span><br><span class="hljs-comment">      if (result == null) {</span><br><span class="hljs-comment">            // 解析注解配置得到了ServiceMethod</span><br><span class="hljs-comment">            result = ServiceMethod.parseAnnotations(this, method);</span><br><span class="hljs-comment">            // 可以看到，最终加入到ConcurrentHashMap缓存中</span><br><span class="hljs-comment">            serviceMethodCache.put(method, result);</span><br><span class="hljs-comment">      }</span><br>    }<br>    <span class="hljs-title function_">return</span> <span class="hljs-title function_">result</span>;<br>}<br><br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> ServiceMethod&lt;T&gt; <span class="hljs-comment">{</span><br><span class="hljs-comment">  static &lt;T&gt; ServiceMethod&lt;T&gt; parseAnnotations(Retrofit retrofit, Method   method) {</span><br><span class="hljs-comment">        // 通过RequestFactory解析注解配置（工厂模式、内部使用了建造者模式）</span><br><span class="hljs-comment">        RequestFactory requestFactory = RequestFactory.parseAnnotations(retrofit, method);</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">        Type returnType = method.getGenericReturnType();</span><br><span class="hljs-comment">        if (Utils.hasUnresolvableType(returnType)) {</span><br><span class="hljs-comment">          throw methodError(method,</span><br><span class="hljs-comment">              "Method return type must not include a type variable or wildcard: %s", returnType);</span><br><span class="hljs-comment">        }</span><br>        <span class="hljs-keyword">if</span> (returnType == void.class) <span class="hljs-comment">{</span><br><span class="hljs-comment">          throw methodError(method, "Service methods cannot return void.");</span><br><span class="hljs-comment">        }</span><br>    <br>        <span class="hljs-comment">// 最终是通过HttpServiceMethod构建的请求方法</span><br>        return HttpServiceMethod.parseAnnotations(retrofit, <span class="hljs-keyword">method</span>, <span class="hljs-title function_">requestFactory</span>);<br>    }<br><br>    <span class="hljs-keyword">abstract</span> T invoke(Object[] args)<span class="hljs-punctuation">;</span><br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="请求构造核心流程"><a href="#请求构造核心流程" class="headerlink" title="请求构造核心流程"></a>请求构造核心流程</h3><p>根据RequestFactory#Builder构造方法和parseAnnotations方法的源码，可知的它的作用就是用来解析注解配置的。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-constructor">Builder(Retrofit <span class="hljs-params">retrofit</span>, Method <span class="hljs-params">method</span>)</span> {<br>    this.retrofit = retrofit;<br>    this.<span class="hljs-keyword">method</span> = <span class="hljs-keyword">method</span>;<br>    <span class="hljs-comment">// 获取网络请求接口方法里的注释</span><br>    this.methodAnnotations = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">Annotations()</span>;<br>    <span class="hljs-comment">// 获取网络请求接口方法里的参数类型       </span><br>    this.parameterTypes = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">GenericParameterTypes()</span>;<br>    <span class="hljs-comment">// 获取网络请求接口方法里的注解内容    </span><br>    this.parameterAnnotationsArray = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">ParameterAnnotations()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>接着看HttpServiceMethod.parseAnnotations()的内部流程。</p><figure class="highlight oxygene"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">static</span> &lt;ResponseT, ReturnT&gt; HttpServiceMethod&lt;ResponseT, ReturnT&gt; parseAnnotations(<br>      Retrofit retrofit, <span class="hljs-keyword">Method</span> <span class="hljs-title function_">method</span>, <span class="hljs-title function_">RequestFactory</span> <span class="hljs-title function_">requestFactory</span>) <span class="hljs-comment">{</span><br><span class="hljs-comment">        </span><br><span class="hljs-comment">    //1.根据网络请求接口方法的返回值和注解类型，</span><br><span class="hljs-comment">    // 从Retrofit对象中获取对应的网络请求适配器</span><br><span class="hljs-comment">    CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter = createCallAdapter(retrofit,method);</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    // 得到响应类型</span><br><span class="hljs-comment">    Type responseType = callAdapter.responseType();</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    //2.根据网络请求接口方法的返回值和注解类型从Retrofit对象中获取对应的数据转换器 </span><br><span class="hljs-comment">    Converter&lt;ResponseBody, ResponseT&gt;responseConverter =</span><br><span class="hljs-comment">        createResponseConverter(retrofit,method, responseType);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    okhttp3.Call.Factory callFactory = retrofit.callFactory;</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    return newHttpServiceMethod&lt;&gt;(requestFactory, callFactory, callAdapter,responseConverter);</span><br><span class="hljs-comment">}</span><br></code></pre></td></tr></tbody></table></figure><h4 id="createCallAdapter-retrofit-method"><a href="#createCallAdapter-retrofit-method" class="headerlink" title="createCallAdapter(retrofit, method)"></a>createCallAdapter(retrofit, method)</h4><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;<span class="hljs-title class_">ResponseT</span>, <span class="hljs-title class_">ReturnT</span>&gt; <span class="hljs-title class_">CallAdapter</span>&lt;<span class="hljs-title class_">ResponseT</span>, <span class="hljs-title class_">ReturnT</span>&gt;     <span class="hljs-title function_">createCallAdapter</span>(<span class="hljs-params"></span><br><span class="hljs-params">      Retrofit retrofit, Method method</span>) {<br>      <br>    <span class="hljs-comment">// 获取网络请求接口里方法的返回值类型</span><br>    <span class="hljs-title class_">Type</span> returnType = method.<span class="hljs-title function_">getGenericReturnType</span>();<br>    <br>    <span class="hljs-comment">// 获取网络请求接口接口里的注解</span><br>    <span class="hljs-title class_">Annotation</span>[] annotations = method.<span class="hljs-title function_">getAnnotations</span>();<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">//noinspection unchecked</span><br>      <span class="hljs-keyword">return</span> (<span class="hljs-title class_">CallAdapter</span>&lt;<span class="hljs-title class_">ResponseT</span>, <span class="hljs-title class_">ReturnT</span>&gt;)  retrofit.<span class="hljs-title function_">callAdapter</span>(returnType, annotations);<br>    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">RuntimeException</span> e) { <span class="hljs-comment">// Wide exception range because factories are user code.</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-title function_">methodError</span>(method, e, <span class="hljs-string">"Unable to create call adapter for %s"</span>, returnType);<br>    }<br>}<br>  <br><span class="hljs-keyword">public</span> <span class="hljs-title class_">CallAdapter</span>&lt;?, ?&gt; <span class="hljs-title function_">callAdapter</span>(<span class="hljs-params">Type returnType, Annotation[] annotations</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">nextCallAdapter</span>(<span class="hljs-literal">null</span>, returnType, annotations);<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">CallAdapter</span>&lt;?, ?&gt; <span class="hljs-title function_">nextCallAdapter</span>(<span class="hljs-params"><span class="hljs-meta">@Nullable</span> CallAdapter.Factory skipPast, Type returnType,</span><br><span class="hljs-params">  Annotation[] annotations</span>) {<br>    ...<br><br>    int start = callAdapterFactories.<span class="hljs-title function_">indexOf</span>(skipPast) + <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// 遍历 CallAdapter.Factory 集合寻找合适的工厂</span><br>    <span class="hljs-keyword">for</span> (int i = start, count = callAdapterFactories.<span class="hljs-title function_">size</span>(); i &lt;count; i++) {<br>        <span class="hljs-title class_">CallAdapter</span>&lt;?, ?&gt; adapter = callAdapterFactories.<span class="hljs-title function_">get</span>(i).<span class="hljs-title function_">get</span>(returnType, annotations, <span class="hljs-variable language_">this</span>);<br>        <span class="hljs-keyword">if</span> (adapter != <span class="hljs-literal">null</span>) {<br>          <span class="hljs-keyword">return</span> adapter;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="createResponseConverter-Retrofit-retrofit-Method-method-Type-responseType"><a href="#createResponseConverter-Retrofit-retrofit-Method-method-Type-responseType" class="headerlink" title="createResponseConverter(Retrofit retrofit, Method method, Type responseType)"></a>createResponseConverter(Retrofit retrofit, Method method, Type responseType)</h4><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;<span class="hljs-title class_">ResponseT</span>&gt; <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">ResponseBody</span>, <span class="hljs-title class_">ResponseT</span>&gt;  <span class="hljs-title function_">createResponseConverter</span>(<span class="hljs-params"></span><br><span class="hljs-params">     Retrofit retrofit, Method method, Type responseType</span>) {<br>   <span class="hljs-title class_">Annotation</span>[] annotations = method.<span class="hljs-title function_">getAnnotations</span>();<br>   <span class="hljs-keyword">try</span> {<br>     <span class="hljs-keyword">return</span> retrofit.<span class="hljs-title function_">responseBodyConverter</span>(responseType,annotations);<br>   } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">RuntimeException</span> e) { <span class="hljs-comment">// Wide exception range because    factories are user code.</span><br>     <span class="hljs-keyword">throw</span> <span class="hljs-title function_">methodError</span>(method, e, <span class="hljs-string">"Unable to create converter for%s"</span>,   responseType);<br>   }<br>}<br><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">ResponseBody</span>, T&gt; <span class="hljs-title function_">responseBodyConverter</span>(<span class="hljs-params">Type <span class="hljs-keyword">type</span>, Annotation[] annotations</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">nextResponseBodyConverter</span>(<span class="hljs-literal">null</span>, <span class="hljs-keyword">type</span>, annotations);<br>}<br><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">ResponseBody</span>, T&gt; <span class="hljs-title function_">nextResponseBodyConverter</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-meta">@Nullable</span> Converter.Factory skipPast, Type <span class="hljs-keyword">type</span>, Annotation[] annotations</span>) {<br>...<br><br>int start = converterFactories.<span class="hljs-title function_">indexOf</span>(skipPast) + <span class="hljs-number">1</span>;<br><span class="hljs-comment">// 遍历 Converter.Factory 集合并寻找合适的工厂, 这里是GsonResponseBodyConverter</span><br><span class="hljs-keyword">for</span> (int i = start, count = converterFactories.<span class="hljs-title function_">size</span>(); i &lt; count; i++) {<br>  <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">ResponseBody</span>, ?&gt; converter =<br>      converterFactories.<span class="hljs-title function_">get</span>(i).<span class="hljs-title function_">responseBodyConverter</span>(<span class="hljs-keyword">type</span>, annotations, <span class="hljs-variable language_">this</span>);<br>  <span class="hljs-keyword">if</span> (converter != <span class="hljs-literal">null</span>) {<br>    <span class="hljs-comment">//noinspection unchecked</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">ResponseBody</span>, T&gt;) converter;<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="执行HttpServiceMethod的invoke方法"><a href="#执行HttpServiceMethod的invoke方法" class="headerlink" title="执行HttpServiceMethod的invoke方法"></a>执行HttpServiceMethod的invoke方法</h4><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span> <span class="hljs-title class_">ReturnT</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span>[] args</span>) {<br>    <span class="hljs-keyword">return</span> callAdapter.<span class="hljs-title function_">adapt</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpCall</span>&lt;&gt;(requestFactory, args, callFactory, responseConverter));<br>}<br></code></pre></td></tr></tbody></table></figure><p>最终在adapt中创建了一个ExecutorCallbackCall对象，它是一个装饰者，而在它内部真正去执行网络请求的还是OkHttpCall。</p><h2 id="创建网络请求接口类实例并执行请求过程"><a href="#创建网络请求接口类实例并执行请求过程" class="headerlink" title="创建网络请求接口类实例并执行请求过程"></a>创建网络请求接口类实例并执行请求过程</h2><h3 id="service-listRepos"><a href="#service-listRepos" class="headerlink" title="service.listRepos()"></a>service.listRepos()</h3><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-number">1</span>、Call&lt;List&lt;Repo&gt;&gt; repos <span class="hljs-operator">=</span> service.listRepos(<span class="hljs-string">"octocat"</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>service对象是动态代理对象Proxy.newProxyInstance()，当调用getCall()时会被 它拦截，然后调用自身的InvocationHandler#invoke()<br>，得到最终的Call对象。</p><h3 id="同步执行流程-repos-execute"><a href="#同步执行流程-repos-execute" class="headerlink" title="同步执行流程 repos.execute()"></a>同步执行流程 repos.execute()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Response&lt;T&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {<br>    okhttp3.Call call;<br><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {<br>      <span class="hljs-keyword">if</span> (executed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Already executed."</span>);<br>      executed = <span class="hljs-literal">true</span>;<br><br>      <span class="hljs-keyword">if</span> (creationFailure != <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">if</span> (creationFailure <span class="hljs-keyword">instanceof</span> IOException) {<br>          <span class="hljs-keyword">throw</span> (IOException) creationFailure;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (creationFailure <span class="hljs-keyword">instanceof</span> RuntimeException) {<br>          <span class="hljs-keyword">throw</span> (RuntimeException) creationFailure;<br>        } <span class="hljs-keyword">else</span> {<br>          <span class="hljs-keyword">throw</span> (Error) creationFailure;<br>        }<br>      }<br><br>      call = rawCall;<br>      <span class="hljs-keyword">if</span> (call == <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">try</span> {<br>          <span class="hljs-comment">// 创建一个OkHttp的Request对象请求</span><br>          call = rawCall = createRawCall();<br>        } <span class="hljs-keyword">catch</span> (IOException | RuntimeException | Error e) {<br>          throwIfFatal(e); <span class="hljs-comment">//  Do not assign a fatal error to     creationFailure.</span><br>          creationFailure = e;<br>          <span class="hljs-keyword">throw</span> e;<br>        }<br>      }<br>    }<br><br>    <span class="hljs-keyword">if</span> (canceled) {<br>      call.cancel();<br>    }<br><br>    <span class="hljs-comment">// 调用OkHttpCall的execute()发送网络请求（同步），</span><br>    <span class="hljs-comment">// 并解析网络请求返回的数据</span><br>    <span class="hljs-keyword">return</span> parseResponse(call.execute());<br>}<br><br><br><span class="hljs-keyword">private</span> okhttp3.Call <span class="hljs-title function_">createRawCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-comment">// 创建 一个okhttp3.Request</span><br>    okhttp3.<span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span><br>    callFactory.newCall(requestFactory.create(args));<br>    <span class="hljs-keyword">if</span> (call == <span class="hljs-literal">null</span>) {<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"Call.Factory returned null."</span>);<br>    }<br>    <span class="hljs-keyword">return</span> call;<br>}<br><br><br>Response&lt;T&gt; <span class="hljs-title function_">parseResponse</span><span class="hljs-params">(okhttp3.Response rawResponse)</span> <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-type">ResponseBody</span> <span class="hljs-variable">rawBody</span> <span class="hljs-operator">=</span> rawResponse.body(); <br>    <br>    <span class="hljs-comment">// Remove the body's source (the only stateful object) so we can   pass the response along.</span><br>    rawResponse = rawResponse.newBuilder()<br>        .body(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NoContentResponseBody</span>(rawBody.contentType(), rawBody.contentLength()))<br>        .build();    <br>    <br>    <span class="hljs-comment">// 根据响应返回的状态码进行处理    </span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> rawResponse.code();<br>    <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">200</span> || code &gt;= <span class="hljs-number">300</span>) {<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// Buffer the entire body to avoid future I/O.</span><br>        <span class="hljs-type">ResponseBody</span> <span class="hljs-variable">bufferedBody</span> <span class="hljs-operator">=</span> Utils.buffer(rawBody);<br>        <span class="hljs-keyword">return</span> Response.error(bufferedBody, rawResponse);<br>      } <span class="hljs-keyword">finally</span> {<br>        rawBody.close();<br>      }<br>    }    <br>    <span class="hljs-keyword">if</span> (code == <span class="hljs-number">204</span> || code == <span class="hljs-number">205</span>) {<br>      rawBody.close();<br>      <span class="hljs-keyword">return</span> Response.success(<span class="hljs-literal">null</span>, rawResponse);<br>    }    <br>    <br>    <br>    <span class="hljs-type">ExceptionCatchingResponseBody</span> <span class="hljs-variable">catchingBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionCatchingResponseBody</span>(rawBody);<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">// 将响应体转为Java对象</span><br>      <span class="hljs-type">T</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> responseConverter.convert(catchingBody);<br>      <br>      <span class="hljs-keyword">return</span> Response.success(body, rawResponse);<br>    } <span class="hljs-keyword">catch</span> (RuntimeException e) {<br>      <span class="hljs-comment">// If the underlying source threw an exception, propagate that     rather than indicating it was</span><br>      <span class="hljs-comment">// a runtime exception.</span><br>      catchingBody.throwIfCaught();<br>      <span class="hljs-keyword">throw</span> e;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="异步请求流程-reponse-enqueque"><a href="#异步请求流程-reponse-enqueque" class="headerlink" title="异步请求流程 reponse.enqueque"></a>异步请求流程 reponse.enqueque</h3><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Override</span> <br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Callback&lt;T&gt; callback)</span> </span>{<br><br>    <span class="hljs-comment">// 使用静态代理 delegate进行异步请求 </span><br>    delegate.enqueue(<span class="hljs-keyword">new</span> Callback&lt;T&gt;() {<br><br>      <span class="hljs-meta">@Override</span> <br>      <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(Call&lt;T&gt; call, finalResponse&lt;T&gt;response)</span> </span>{<br>        <span class="hljs-comment">// 线程切换，在主线程显示结果</span><br>        callbackExecutor.execute(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span> <br>             <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>            <span class="hljs-keyword">if</span> (delegate.isCanceled()) {<br>              callback.onFailure(ExecutorCallbackCall.<span class="hljs-keyword">this</span>, newIOException(<span class="hljs-string">"Canceled"</span>));<br>            } <span class="hljs-keyword">else</span> {<br>              callback.onResponse(ExecutorCallbackCall.<span class="hljs-keyword">this</span>,respons);<br>            }<br>          }<br>        });<br>      }<br>      <span class="hljs-meta">@Override</span> <br>      <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(Call&lt;T&gt; call, <span class="hljs-keyword">final</span> Throwable t)</span> </span>{<br>        callbackExecutor.execute(<span class="hljs-keyword">new</span> Runnable() {<br>          <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>            callback.onFailure(ExecutorCallbackCall.<span class="hljs-keyword">this</span>, t);<br>          }<br>        });<br>      }<br>    });<br>}<br></code></pre></td></tr></tbody></table></figure><p>看看 delegate.enqueue 内部流程。</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Override</span> <br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Callback&lt;T&gt; callback)</span> </span>{<br>   <br>    okhttp3.Call call;<br>    Throwable failure;<br><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {<br>      <span class="hljs-keyword">if</span> (executed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Already executed."</span>);<br>      executed = <span class="hljs-keyword">true</span>;<br><br>      call = rawCall;<br>      failure = creationFailure;<br>      <span class="hljs-keyword">if</span> (call == <span class="hljs-keyword">null</span> &amp;&amp; failure == <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-keyword">try</span> {<br>          <span class="hljs-comment">// 创建OkHttp的Request对象，再封装成OkHttp.call</span><br>          <span class="hljs-comment">// 方法同发送同步请求，此处上面已分析</span><br>          call = rawCall = createRawCall(); <br>        } <span class="hljs-keyword">catch</span> (Throwable t) {<br>          failure = creationFailure = t;<br>        }<br>      }<br><br><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Callback&lt;T&gt; callback)</span> </span>{<br>  checkNotNull(callback, <span class="hljs-string">"callback == null"</span>);<br><br>  okhttp3.Call call;<br>  Throwable failure;<br><br>  ...<br><br>  call.enqueue(<span class="hljs-keyword">new</span> okhttp3.Callback() {<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(okhttp3.Call call, okhttp3.Response rawResponse)</span> </span>{<br>      Response&lt;T&gt; response;<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 此处上面已分析</span><br>        response = parseResponse(rawResponse);<br>      } <span class="hljs-keyword">catch</span> (Throwable e) {<br>        throwIfFatal(e);<br>        callFailure(e);<br>        <span class="hljs-keyword">return</span>;<br>      }<br><br>      <span class="hljs-keyword">try</span> {<br>        callback.onResponse(OkHttpCall.<span class="hljs-keyword">this</span>, response);<br>      } <span class="hljs-keyword">catch</span> (Throwable t) {<br>        t.printStackTrace();<br>      }<br>    }<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(okhttp3.Call call, IOException e)</span> </span>{<br>      callFailure(e);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">callFailure</span><span class="hljs-params">(Throwable e)</span> </span>{<br>      <span class="hljs-keyword">try</span> {<br>        callback.onFailure(OkHttpCall.<span class="hljs-keyword">this</span>, e);<br>      } <span class="hljs-keyword">catch</span> (Throwable t) {<br>        t.printStackTrace();<br>      }<br>    }<br>  });<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="Retrofit源码流程图"><a href="#Retrofit源码流程图" class="headerlink" title="Retrofit源码流程图"></a>Retrofit源码流程图</h2><p>建议大家自己主动配合着Retrofit最新版的源码一步步去彻底地认识它，只有这样，你才能看到它真实的内心，附上一张Retrofit源码流程图，要注意的是，这是V2.5之前版本的流程，但是，在看完上面的源码分析后，我们知道，主体流程是没有变化的。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ab58d6242cc4fae96cd73eb198e325a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><blockquote><p>从本质上来说，Retrofit虽然只是一个RESTful 的HTTP 网络请求框架的封装库。但是，它内部通过 大量的设计模式 封装了<br>OkHttp，让使用者感到它非常简洁、易懂。它内部主要是用动态代理的方式，动态将网络请求接口的注解解析成HTTP请求，最后执行请求的过程。</p></blockquote><h1 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h1><h2 id="基本使用流程-1"><a href="#基本使用流程-1" class="headerlink" title="基本使用流程"></a>基本使用流程</h2><p>Glide最基本的使用流程就是下面这行代码，其它所有扩展的额外功能都是以其建造者链式调用的基础上增加的。</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">GlideApp.<span class="hljs-keyword">with</span>(context).<span class="hljs-keyword">load</span>(url).<span class="hljs-keyword">into</span>(iv);<br></code></pre></td></tr></tbody></table></figure><p>其中的GlideApp是注解处理器自动生成的，要使用GlideApp，必须先配置应用的AppGlideModule模块，里面可以为空配置，也可以根据实际情况添加指定配置。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml">@GlideModule<br>public class MyAppGlideModule extends AppGlideModule {<br><br>    @Override<br>    public void applyOptions(Context context, GlideBuilder builder) {<br>        // 实际使用中根据情况可以添加如下配置<br>        <span class="hljs-comment">&lt;!--builder.setDefaultRequestOptions(new RequestOptions().format(DecodeFormat.PREFER_RGB_565));--&gt;</span><br>        <span class="hljs-comment">&lt;!--int memoryCacheSizeBytes = 1024 * 1024 * 20;--&gt;</span><br>        <span class="hljs-comment">&lt;!--builder.setMemoryCache(new LruResourceCache(memoryCacheSizeBytes));--&gt;</span><br>        <span class="hljs-comment">&lt;!--int bitmapPoolSizeBytes = 1024 * 1024 * 30;--&gt;</span><br>        <span class="hljs-comment">&lt;!--builder.setBitmapPool(new LruBitmapPool(bitmapPoolSizeBytes));--&gt;</span><br>        <span class="hljs-comment">&lt;!--int diskCacheSizeBytes = 1024 * 1024 * 100;--&gt;</span><br>        <span class="hljs-comment">&lt;!--builder.setDiskCache(new InternalCacheDiskCacheFactory(context, diskCacheSizeBytes));--&gt;</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>接下来，本文将针对Glide的最新源码版本V4.8.0对Glide加载网络图片的流程进行详细地分析与讲解，力争做到让读者朋友们知其然也知其所以然。</p><h2 id="GlideApp-with-context-源码详解"><a href="#GlideApp-with-context-源码详解" class="headerlink" title="GlideApp.with(context)源码详解"></a>GlideApp.with(context)源码详解</h2><p>首先，用这份Glide框架图让我们对Glide的总体框架有一个初步的了解。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2478933d44534c2fabb6466049b9f3b7~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><p>从GlideApp.with这行代码开始，内部主线执行流程如下。</p><h3 id="GlideApp-with"><a href="#GlideApp-with" class="headerlink" title="GlideApp#with"></a>GlideApp#with</h3><figure class="highlight vhdl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vhdl"><span class="hljs-keyword">return</span> (GlideRequests) Glide.<span class="hljs-keyword">with</span>(<span class="hljs-keyword">context</span>);<br></code></pre></td></tr></tbody></table></figure><h3 id="Glide-with"><a href="#Glide-with" class="headerlink" title="Glide#with"></a>Glide#with</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">return get<span class="hljs-constructor">Retriever(<span class="hljs-params">context</span>)</span>.get(context);<br><br>return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Glide</span>.</span></span>get(context).get<span class="hljs-constructor">RequestManagerRetriever()</span>;<br><br><span class="hljs-comment">// 外部使用了双重检锁的同步方式确保同一时刻只执一次Glide的初始化</span><br>check<span class="hljs-constructor">AndInitializeGlide(<span class="hljs-params">context</span>)</span>;<br><br>initialize<span class="hljs-constructor">Glide(<span class="hljs-params">context</span>)</span>;<br><br><span class="hljs-comment">// 最终执行到Glide的另一个重载方法</span><br>initialize<span class="hljs-constructor">Glide(<span class="hljs-params">context</span>, <span class="hljs-params">new</span> GlideBuilder()</span>);<br><br>@<span class="hljs-constructor">SuppressWarnings(<span class="hljs-string">"deprecation"</span>)</span><br>  <span class="hljs-keyword">private</span> static void initialize<span class="hljs-constructor">Glide(@NonNull Context   <span class="hljs-params">context</span>, @NonNull GlideBuilder <span class="hljs-params">builder</span>)</span> {<br>    Context applicationContext =     context.get<span class="hljs-constructor">ApplicationContext()</span>;<br>    <span class="hljs-comment">// 1、获取前面应用中带注解的GlideModule</span><br>    GeneratedAppGlideModule annotationGeneratedModule =     get<span class="hljs-constructor">AnnotationGeneratedGlideModules()</span>;<br>    <span class="hljs-comment">// 2、如果GlideModule为空或者可配置manifest里面的标志为true，则获取manifest里面</span><br>    <span class="hljs-comment">// 配置的GlideModule模块（manifestModules）。</span><br>    List&lt;com.bumptech.glide.<span class="hljs-keyword">module</span>.GlideModule&gt;     manifestModules = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Collections</span>.</span></span>empty<span class="hljs-constructor">List()</span>;<br>    <span class="hljs-keyword">if</span> (annotationGeneratedModule<span class="hljs-operator"> == </span>null<span class="hljs-operator"> ||     </span>annotationGeneratedModule.is<span class="hljs-constructor">ManifestParsingEnabled(    )</span>) {<br>      manifestModules = <span class="hljs-keyword">new</span>   <span class="hljs-constructor">ManifestParser(<span class="hljs-params">applicationContext</span>)</span>.parse<span class="hljs-literal">()</span>;<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>RequestManagerRetriever.RequestManagerFactory     factory =<br>        annotationGeneratedModule != null<br>            ? annotationGeneratedModule.getRequestManag    er<span class="hljs-constructor">Factory()</span> : null;<br>    builder.set<span class="hljs-constructor">RequestManagerFactory(<span class="hljs-params">factory</span>)</span>;<br>    <span class="hljs-keyword">for</span> (com.bumptech.glide.<span class="hljs-keyword">module</span>.GlideModule <span class="hljs-keyword">module</span> :     manifestModules) {<br>      <span class="hljs-keyword">module</span>.apply<span class="hljs-constructor">Options(<span class="hljs-params">applicationContext</span>, <span class="hljs-params">builder</span>)</span>;<br>    }<br>    <span class="hljs-keyword">if</span> (annotationGeneratedModule != null) {<br>      annotationGeneratedModule.apply<span class="hljs-constructor">Options(<span class="hljs-params">applicatio</span>  <span class="hljs-params">nContext</span>, <span class="hljs-params">builder</span>)</span>;<br>    }<br>    <span class="hljs-comment">// 3、初始化各种配置信息</span><br>    Glide glide = builder.build(applicationContext);<br>    <span class="hljs-comment">// 4、把manifestModules以及annotationGeneratedModule里面的配置信息放到builder</span><br>    <span class="hljs-comment">// 里面（applyOptions）替换glide默认组件（registerComponents）</span><br>    <span class="hljs-keyword">for</span> (com.bumptech.glide.<span class="hljs-keyword">module</span>.GlideModule <span class="hljs-keyword">module</span> :     manifestModules) {<br>      <span class="hljs-keyword">module</span>.register<span class="hljs-constructor">Components(<span class="hljs-params">applicationContext</span>,   <span class="hljs-params">glide</span>, <span class="hljs-params">glide</span>.<span class="hljs-params">registry</span>)</span>;<br>    }<br>    <span class="hljs-keyword">if</span> (annotationGeneratedModule != null) {<br>      annotationGeneratedModule.register<span class="hljs-constructor">Components(<span class="hljs-params">appl</span>  <span class="hljs-params">icationContext</span>, <span class="hljs-params">glide</span>, <span class="hljs-params">glide</span>.<span class="hljs-params">registry</span>)</span>;<br>    }<br>    applicationContext.register<span class="hljs-constructor">ComponentCallbacks(<span class="hljs-params">glide</span>    )</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Glide</span>.</span></span>glide = glide;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="GlideBuilder-build"><a href="#GlideBuilder-build" class="headerlink" title="GlideBuilder#build"></a>GlideBuilder#build</h3><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs haxe">@NonNull<br>  Glide build(@NonNull Context context) {<br>    <span class="hljs-comment">// 创建请求图片线程池sourceExecutor</span><br>    <span class="hljs-keyword">if</span> (sourceExecutor == <span class="hljs-literal">null</span>) {<br>      sourceExecutor =   GlideExecutor.<span class="hljs-keyword">new</span><span class="hljs-type">SourceExecutor</span>();<br>    }<br><br>    <span class="hljs-comment">// 创建硬盘缓存线程池diskCacheExecutor</span><br>    <span class="hljs-keyword">if</span> (diskCacheExecutor == <span class="hljs-literal">null</span>) {<br>      diskCacheExecutor =   GlideExecutor.<span class="hljs-keyword">new</span><span class="hljs-type">DiskCacheExecutor</span>();<br>    }<br><br>    <span class="hljs-comment">// 创建动画线程池animationExecutor</span><br>    <span class="hljs-keyword">if</span> (animationExecutor == <span class="hljs-literal">null</span>) {<br>      animationExecutor =   GlideExecutor.<span class="hljs-keyword">new</span><span class="hljs-type">AnimationExecutor</span>();<br>    }<br><br>    <span class="hljs-keyword">if</span> (memorySizeCalculator == <span class="hljs-literal">null</span>) {<br>      memorySizeCalculator = <span class="hljs-keyword">new</span>   <span class="hljs-type">MemorySizeCalculator</span>.Builder(context).build();<br>    }<br><br>    <span class="hljs-keyword">if</span> (connectivityMonitorFactory == <span class="hljs-literal">null</span>) {<br>      connectivityMonitorFactory = <span class="hljs-keyword">new</span>   <span class="hljs-type">DefaultConnectivityMonitorFactory</span>();<br>    }<br><br>    <span class="hljs-keyword">if</span> (bitmapPool == <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// 依据设备的屏幕密度和尺寸设置各种pool的size</span><br>      int size =   memorySizeCalculator.getBitmapPoolSize();<br>      <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {<br>        <span class="hljs-comment">// 创建图片线程池LruBitmapPool，缓存所有被释放的bitmap</span><br>        <span class="hljs-comment">// 缓存策略在API大于19时，为SizeConfigStrategy，小于为AttributeStrategy。</span><br>        <span class="hljs-comment">// 其中SizeConfigStrategy是以bitmap的size和config为key，value为bitmap的HashMap</span><br>        bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-type">LruBitmapPool</span>(size);<br>      } <span class="hljs-keyword">else</span> {<br>        bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-type">BitmapPoolAdapter</span>();<br>      }<br>    }<br><br>    <span class="hljs-comment">// 创建对象数组缓存池LruArrayPool，默认4M</span><br>    <span class="hljs-keyword">if</span> (arrayPool == <span class="hljs-literal">null</span>) {<br>      arrayPool = <span class="hljs-keyword">new</span>   <span class="hljs-type">LruArrayPool</span>(memorySizeCalculator.getArrayPoolSiz  eInBytes());<br>    }<br><br>    <span class="hljs-comment">// 创建LruResourceCache，内存缓存</span><br>    <span class="hljs-keyword">if</span> (memoryCache == <span class="hljs-literal">null</span>) {<br>      memoryCache = <span class="hljs-keyword">new</span>   <span class="hljs-type">LruResourceCache</span>(memorySizeCalculator.getMemoryCa  cheSize());<br>    }<br><br>    <span class="hljs-keyword">if</span> (diskCacheFactory == <span class="hljs-literal">null</span>) {<br>      diskCacheFactory = <span class="hljs-keyword">new</span>   <span class="hljs-type">InternalCacheDiskCacheFactory</span>(context);<br>    }<br><br>    <span class="hljs-comment">// 创建任务和资源管理引擎（线程池，内存缓存和硬盘缓存对象）</span><br>    <span class="hljs-keyword">if</span> (engine == <span class="hljs-literal">null</span>) {<br>      engine =<br>          <span class="hljs-keyword">new</span> <span class="hljs-type">Engine</span>(<br>              memoryCache,<br>              diskCacheFactory,<br>              diskCacheExecutor,<br>              sourceExecutor,<br>              GlideExecutor.<span class="hljs-keyword">new</span><span class="hljs-type">UnlimitedSourceExecutor</span>(  ),<br>              GlideExecutor.<span class="hljs-keyword">new</span><span class="hljs-type">AnimationExecutor</span>(),<br>              isActiveResourceRetentionAllowed);<br>    }<br>    <br>    RequestManagerRetriever requestManagerRetriever =<br>    <span class="hljs-keyword">new</span> <span class="hljs-type">RequestManagerRetriever</span>(requestManagerFactory);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">Glide</span>(<br>        context,<br>        engine,<br>        memoryCache,<br>        bitmapPool,<br>        arrayPool,<br>        requestManagerRetriever,<br>        connectivityMonitorFactory,<br>        logLevel,<br>        defaultRequestOptions.lock(),<br>        defaultTransitionOptions);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="Glide-Glide构造方法"><a href="#Glide-Glide构造方法" class="headerlink" title="Glide#Glide构造方法"></a>Glide#Glide构造方法</h3><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs haxe">Glide(...) {<br>    ...<br>    <span class="hljs-comment">// 注册管理任务执行对象的类(Registry)</span><br>    <span class="hljs-comment">// Registry是一个工厂，而其中所有注册的对象都是一个工厂员工，当任务分发时，</span><br>    <span class="hljs-comment">// 根据当前任务的性质，分发给相应员工进行处理</span><br>    registry = <span class="hljs-keyword">new</span> <span class="hljs-type">Registry</span>();<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 这里大概有60余次的append或register员工组件（解析器、编解码器、工厂类、转码类等等组件）</span><br>    registry<br>    .append(ByteBuffer.class, <span class="hljs-keyword">new</span> <span class="hljs-type">ByteBufferEncoder</span>())<br>    .append(InputStream.class, <span class="hljs-keyword">new</span> <span class="hljs-type">StreamEncoder</span>(arrayPool))<br>    <br>    <span class="hljs-comment">// 根据给定子类产出对应类型的target（BitmapImageViewTarget / DrawableImageViewTarget)</span><br>    ImageViewTargetFactory imageViewTargetFactory = <span class="hljs-keyword">new</span> <span class="hljs-type">ImageViewTargetFactory</span>();<br>    <br>    glideContext =<br>        <span class="hljs-keyword">new</span> <span class="hljs-type">GlideContext</span>(<br>            context,<br>            arrayPool,<br>            registry,<br>            imageViewTargetFactory,<br>            defaultRequestOptions,<br>            defaultTransitionOptions,<br>            engine,<br>            logLevel);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="RequestManagerRetriever-get"><a href="#RequestManagerRetriever-get" class="headerlink" title="RequestManagerRetriever#get"></a>RequestManagerRetriever#get</h3><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@NonNull</span><br><span class="hljs-keyword">public</span> <span class="hljs-function">RequestManager <span class="hljs-title">get</span><span class="hljs-params">(@NonNull Context context)</span> </span>{<br>  <span class="hljs-keyword">if</span> (context == <span class="hljs-keyword">null</span>) {<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"You cannot start a load on a null Context"</span>);<br>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="hljs-keyword">instanceof</span> Application)) {<br>    <span class="hljs-comment">// 如果当前线程是主线程且context不是Application走相应的get重载方法</span><br>    <span class="hljs-keyword">if</span> (context <span class="hljs-keyword">instanceof</span> FragmentActivity) {<br>      <span class="hljs-keyword">return</span> get((FragmentActivity) context);<br>    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(context <span class="hljs-keyword">instanceof</span> Activity)</span> </span>{<br>      <span class="hljs-keyword">return</span> get((Activity) context);<br>    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(context <span class="hljs-keyword">instanceof</span> ContextWrapper)</span> </span>{<br>      <span class="hljs-keyword">return</span> get(((ContextWrapper) context).getBaseContext());<br>    }<br>  }<br><br>  <span class="hljs-comment">// 否则直接将请求与ApplicationLifecycle关联</span><br>  <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">getApplicationManager</span><span class="hljs-params">(context)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里总结一下，对于当前传入的context是application或当前线程是子线程时，请求的生命周期和ApplicationLifecycle关联，否则，context是FragmentActivity或Fragment时，在当前组件添加一个SupportFragment（SupportRequestManagerFragment），context是Activity时，在当前组件添加一个Fragment(<br>RequestManagerFragment)。</p><h3 id="GlideApp-with小结"><a href="#GlideApp-with小结" class="headerlink" title="GlideApp#with小结"></a>GlideApp#with小结</h3><ol><li><p>初始化各式各样的配置信息（包括缓存，请求线程池，大小，图片格式等等）以及glide对象。</p></li><li><p>将glide请求和application/SupportFragment/Fragment的生命周期绑定在一块。</p></li></ol><h3 id="with方法的执行流程"><a href="#with方法的执行流程" class="headerlink" title="with方法的执行流程"></a>with方法的执行流程</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a307a034fea446a486c4f988849751a0~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><h2 id="load-url-源码详解"><a href="#load-url-源码详解" class="headerlink" title="load(url)源码详解"></a>load(url)源码详解</h2><h3 id="GlideRequest-RequestManager-load"><a href="#GlideRequest-RequestManager-load" class="headerlink" title="GlideRequest(RequestManager)#load"></a>GlideRequest(RequestManager)#load</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">return</span> (GlideRequest&lt;Drawable&gt;) <span class="hljs-keyword">super</span>.load(string);<br><br><span class="hljs-keyword">return</span> asDrawable().load(string);<br><br><span class="hljs-comment">// 1、asDrawable部分</span><br><span class="hljs-keyword">return</span> (GlideRequest&lt;Drawable&gt;) <span class="hljs-keyword">super</span>.asDrawable();<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">as</span>(Drawable.<span class="hljs-keyword">class</span>);<br><br><span class="hljs-comment">// 最终返回了一个GlideRequest（RequestManager的子类）</span><br><span class="hljs-keyword">return</span> new GlideRequest&lt;&gt;(glide, <span class="hljs-keyword">this</span>, resourceClass, context);<br><br><span class="hljs-comment">// 2、load部分</span><br><span class="hljs-keyword">return</span> (GlideRequest&lt;TranscodeType&gt;) <span class="hljs-keyword">super</span>.load(string);<br><br><span class="hljs-keyword">return</span> loadGeneric(string);<br><br><span class="hljs-meta">@NonNull</span><br><span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; loadGeneric(<span class="hljs-meta">@Nullable</span> Object model) {<br>    <span class="hljs-comment">// model则为设置的url</span><br>    <span class="hljs-keyword">this</span>.model = model;<br>    <span class="hljs-comment">// 记录url已设置</span><br>    isModelSet = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，load这部分的源码很简单，就是给GlideRequest（RequestManager）设置了要请求的mode（url），并记录了url已设置的状态。</p><h3 id="load方法的执行流程"><a href="#load方法的执行流程" class="headerlink" title="load方法的执行流程"></a>load方法的执行流程</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33114794d81a421ea4345806826919b7~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><h2 id="into-iv-源码详解"><a href="#into-iv-源码详解" class="headerlink" title="into(iv)源码详解"></a>into(iv)源码详解</h2><p>真正复杂的地方要开始了。</p><h3 id="RequestBuilder-into"><a href="#RequestBuilder-into" class="headerlink" title="RequestBuilder.into"></a>RequestBuilder.into</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@NonNull</span><br><span class="hljs-keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt;   <span class="hljs-title function_">into</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ImageView view)</span> {<br>  Util.assertMainThread();<br>  Preconditions.checkNotNull(view);<br><br>  <span class="hljs-type">RequestOptions</span> <span class="hljs-variable">requestOptions</span> <span class="hljs-operator">=</span>     <span class="hljs-built_in">this</span>.requestOptions;<br>  <span class="hljs-keyword">if</span> (!requestOptions.isTransformationSet()<br>      &amp;&amp; requestOptions.isTransformationAllowed()<br>      &amp;&amp; view.getScaleType() != <span class="hljs-literal">null</span>) {<br>    <span class="hljs-comment">// Clone in this method so that if we use this   RequestBuilder to load into a View and then</span><br>    <span class="hljs-comment">// into a different target, we don't retain the   transformation applied based on the previous</span><br>    <span class="hljs-comment">// View's scale type.</span><br>    <span class="hljs-keyword">switch</span> (view.getScaleType()) {<br>      <span class="hljs-comment">// 这个RequestOptions里保存了要设置的scaleType，Glide自身封装了CenterCrop、CenterInside、</span><br>      <span class="hljs-comment">// FitCenter、CenterInside四种规格。</span><br>      <span class="hljs-keyword">case</span> CENTER_CROP:<br>        requestOptions =   requestOptions.clone().optionalCenterCrop();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> CENTER_INSIDE:<br>        requestOptions =   requestOptions.clone().optionalCenterInside()  ;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> FIT_CENTER:<br>      <span class="hljs-keyword">case</span> FIT_START:<br>      <span class="hljs-keyword">case</span> FIT_END:<br>        requestOptions =   requestOptions.clone().optionalFitCenter();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> FIT_XY:<br>        requestOptions =   requestOptions.clone().optionalCenterInside()  ;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> CENTER:<br>      <span class="hljs-keyword">case</span> MATRIX:<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// Do nothing.</span><br>    }<br>  }<br><br>  <span class="hljs-comment">// 注意，这个transcodeClass是指的drawable或bitmap</span><br>  <span class="hljs-keyword">return</span> into(<br>      glideContext.buildImageViewTarget(view,     transcodeClass),<br>      <span class="hljs-comment">/*targetListener=*/</span> <span class="hljs-literal">null</span>,<br>      requestOptions);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="GlideContext-buildImageViewTarget"><a href="#GlideContext-buildImageViewTarget" class="headerlink" title="GlideContext#buildImageViewTarget"></a>GlideContext#buildImageViewTarget</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">return imageViewTargetFactory.build<span class="hljs-constructor">Target(<span class="hljs-params">imageView</span>, <span class="hljs-params">transcodeClass</span>)</span>;<br></code></pre></td></tr></tbody></table></figure><h3 id="ImageViewTargetFactory-buildTarget"><a href="#ImageViewTargetFactory-buildTarget" class="headerlink" title="ImageViewTargetFactory#buildTarget"></a>ImageViewTargetFactory#buildTarget</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@NonNull</span><br><span class="hljs-variable">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)<br>public &lt;Z&gt; ViewTarget&lt;ImageView, Z&gt;   <span class="hljs-built_in">buildTarget</span>(<span class="hljs-variable">@NonNull</span> ImageView view,<br>    <span class="hljs-variable">@NonNull</span> Class&lt;Z&gt; clazz) {<br>  <span class="hljs-comment">// 返回展示Bimtap/Drawable资源的目标对象</span><br>  <span class="hljs-selector-tag">if</span> (Bitmap.class.<span class="hljs-built_in">equals</span>(clazz)) {<br>    <span class="hljs-selector-tag">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="hljs-selector-tag">new</span>   <span class="hljs-selector-tag">BitmapImageViewTarget</span>(view);<br>  } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (Drawable.class.<span class="hljs-built_in">isAssignableFrom</span>(clazz))     {<br>    <span class="hljs-selector-tag">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="hljs-selector-tag">new</span>   <span class="hljs-selector-tag">DrawableImageViewTarget</span>(view);<br>  } <span class="hljs-selector-tag">else</span> {<br>    <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">IllegalArgumentException</span>(<br>        <span class="hljs-string">"Unhandled class: "</span> + clazz + <span class="hljs-string">", try   .as*(Class).transcode(ResourceTranscoder)"</span>);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，Glide内部只维护了两种target，一种是BitmapImageViewTarget，另一种则是DrawableImageViewTarget，接下来继续深入。</p><h3 id="RequestBuilder-into-1"><a href="#RequestBuilder-into-1" class="headerlink" title="RequestBuilder#into"></a>RequestBuilder#into</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-meta">@NonNull</span> Y target,</span><br><span class="hljs-params">      <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt;   targetListener,</span><br><span class="hljs-params">      <span class="hljs-meta">@NonNull</span> RequestOptions options)</span> {<br>    Util.assertMainThread();<br>    Preconditions.checkNotNull(target);<br>    <span class="hljs-keyword">if</span> (!isModelSet) {<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"You must call   #load() before calling #into()"</span>);<br>    }<br><br>    options = options.autoClone();<br>    <span class="hljs-comment">// 分析1.建立请求</span><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> buildRequest(target,     targetListener, options);<br><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> target.getRequest();<br>    <span class="hljs-keyword">if</span> (request.isEquivalentTo(previous)<br>        &amp;&amp; !isSkipMemoryCacheWithCompletePreviousReques    <span class="hljs-title function_">t</span><span class="hljs-params">(options, previous)</span>) {<br>      request.recycle();<br>      <span class="hljs-comment">// If the request is completed, beginning again   will ensure the result is re-delivered,</span><br>      <span class="hljs-comment">// triggering RequestListeners and Targets. If   the request is failed, beginning again will</span><br>      <span class="hljs-comment">// restart the request, giving it another chance   to complete. If the request is already</span><br>      <span class="hljs-comment">// running, we can let it continue running   without interruption.</span><br>      <span class="hljs-keyword">if</span> (!Preconditions.checkNotNull(previous).isRunni  <span class="hljs-title function_">ng</span><span class="hljs-params">()</span>) {<br>        <span class="hljs-comment">// Use the previous request rather than the new     one to allow for optimizations like skipping</span><br>        <span class="hljs-comment">// setting placeholders, tracking and     un-tracking Targets, and obtaining View     dimensions</span><br>        <span class="hljs-comment">// that are done in the individual Request.</span><br>        previous.begin();<br>      }<br>      <span class="hljs-keyword">return</span> target;<br>    }<br>    <br>    requestManager.clear(target);<br>    target.setRequest(request);<br>    <span class="hljs-comment">// 分析2.真正追踪请求的地方</span><br>    requestManager.track(target, request);<br><br>    <span class="hljs-keyword">return</span> target;<br>}<br><br><span class="hljs-comment">// 分析1</span><br><span class="hljs-keyword">private</span> Request <span class="hljs-title function_">buildRequest</span><span class="hljs-params">(</span><br><span class="hljs-params">      Target&lt;TranscodeType&gt; target,</span><br><span class="hljs-params">      <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt;   targetListener,</span><br><span class="hljs-params">      RequestOptions requestOptions)</span> {<br>    <span class="hljs-keyword">return</span> buildRequestRecursive(<br>        target,<br>        targetListener,<br>        <span class="hljs-comment">/*parentCoordinator=*/</span> <span class="hljs-literal">null</span>,<br>        transitionOptions,<br>        requestOptions.getPriority(),<br>        requestOptions.getOverrideWidth(),<br>        requestOptions.getOverrideHeight(),<br>        requestOptions);<br>}<br><br><span class="hljs-comment">// 分析1</span><br><span class="hljs-keyword">private</span> Request <span class="hljs-title function_">buildRequestRecursive</span><span class="hljs-params">(</span><br><span class="hljs-params">      Target&lt;TranscodeType&gt; target,</span><br><span class="hljs-params">      <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt;   targetListener,</span><br><span class="hljs-params">      <span class="hljs-meta">@Nullable</span> RequestCoordinator parentCoordinator,</span><br><span class="hljs-params">      TransitionOptions&lt;?, ? <span class="hljs-built_in">super</span> TranscodeType&gt;   transitionOptions,</span><br><span class="hljs-params">      Priority priority,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideWidth,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideHeight,</span><br><span class="hljs-params">      RequestOptions requestOptions)</span> {<br><br>    <span class="hljs-comment">// Build the ErrorRequestCoordinator first if     necessary so we can update parentCoordinator.</span><br>    <span class="hljs-type">ErrorRequestCoordinator</span> <span class="hljs-variable">errorRequestCoordinator</span> <span class="hljs-operator">=</span>     <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (errorBuilder != <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// 创建errorRequestCoordinator（异常处理对象）</span><br>      errorRequestCoordinator = <span class="hljs-keyword">new</span>   <span class="hljs-title class_">ErrorRequestCoordinator</span>(parentCoordinator);<br>      parentCoordinator = errorRequestCoordinator;<br>    }<br><br>    <span class="hljs-comment">// 递归建立缩略图请求</span><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">mainRequest</span> <span class="hljs-operator">=</span><br>        buildThumbnailRequestRecursive(<br>            target,<br>            targetListener,<br>            parentCoordinator,<br>            transitionOptions,<br>            priority,<br>            overrideWidth,<br>            overrideHeight,<br>            requestOptions);<br><br>    <span class="hljs-keyword">if</span> (errorRequestCoordinator == <span class="hljs-literal">null</span>) {<br>      <span class="hljs-keyword">return</span> mainRequest;<br>    }<br><br>    ...<br>    <br>    <span class="hljs-type">Request</span> <span class="hljs-variable">errorRequest</span> <span class="hljs-operator">=</span>     errorBuilder.buildRequestRecursive(<br>        target,<br>        targetListener,<br>        errorRequestCoordinator,<br>        errorBuilder.transitionOptions,<br>        errorBuilder.requestOptions.getPriority(),<br>        errorOverrideWidth,<br>        errorOverrideHeight,<br>        errorBuilder.requestOptions);<br>    errorRequestCoordinator.setRequests(mainRequest,     errorRequest);<br>    <span class="hljs-keyword">return</span> errorRequestCoordinator;<br>}<br><br><span class="hljs-comment">// 分析1</span><br><span class="hljs-keyword">private</span> Request <span class="hljs-title function_">buildThumbnailRequestRecursive</span><span class="hljs-params">(</span><br><span class="hljs-params">      Target&lt;TranscodeType&gt; target,</span><br><span class="hljs-params">      RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="hljs-params">      <span class="hljs-meta">@Nullable</span> RequestCoordinator parentCoordinator,</span><br><span class="hljs-params">      TransitionOptions&lt;?, ? <span class="hljs-built_in">super</span> TranscodeType&gt; transitionOptions,</span><br><span class="hljs-params">      Priority priority,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideWidth,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideHeight,</span><br><span class="hljs-params">      RequestOptions requestOptions)</span> {<br>    <span class="hljs-keyword">if</span> (thumbnailBuilder != <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// Recursive case: contains a potentially recursive thumbnail request builder.</span><br>      <br>      ...<br><br>      <span class="hljs-type">ThumbnailRequestCoordinator</span> <span class="hljs-variable">coordinator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThumbnailRequestCoordinator</span>(parentCoordinator);<br>      <span class="hljs-comment">// 获取一个正常请求对象</span><br>      <span class="hljs-type">Request</span> <span class="hljs-variable">fullRequest</span> <span class="hljs-operator">=</span><br>          obtainRequest(<br>              target,<br>              targetListener,<br>              requestOptions,<br>              coordinator,<br>              transitionOptions,<br>              priority,<br>              overrideWidth,<br>              overrideHeight);<br>      isThumbnailBuilt = <span class="hljs-literal">true</span>;<br>      <span class="hljs-comment">// Recursively generate thumbnail requests.</span><br>      <span class="hljs-comment">// 使用递归的方式建立一个缩略图请求对象</span><br>      <span class="hljs-type">Request</span> <span class="hljs-variable">thumbRequest</span> <span class="hljs-operator">=</span><br>          thumbnailBuilder.buildRequestRecursive(<br>              target,<br>              targetListener,<br>              coordinator,<br>              thumbTransitionOptions,<br>              thumbPriority,<br>              thumbOverrideWidth,<br>              thumbOverrideHeight,<br>              thumbnailBuilder.requestOptions);<br>      isThumbnailBuilt = <span class="hljs-literal">false</span>;<br>      <span class="hljs-comment">// coordinator（ThumbnailRequestCoordinator）是作为两者的协调者，</span><br>      <span class="hljs-comment">// 能够同时加载缩略图和正常的图的请求</span><br>      coordinator.setRequests(fullRequest, thumbRequest);<br>      <span class="hljs-keyword">return</span> coordinator;<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (thumbSizeMultiplier != <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// Base case: thumbnail multiplier generates a thumbnail request, but cannot recurse.</span><br>      <span class="hljs-comment">// 当设置了缩略的比例thumbSizeMultiplier(0 ~  1)时，</span><br>      <span class="hljs-comment">// 不需要递归建立缩略图请求</span><br>      <span class="hljs-type">ThumbnailRequestCoordinator</span> <span class="hljs-variable">coordinator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThumbnailRequestCoordinator</span>(parentCoordinator);<br>      <span class="hljs-type">Request</span> <span class="hljs-variable">fullRequest</span> <span class="hljs-operator">=</span><br>          obtainRequest(<br>              target,<br>              targetListener,<br>              requestOptions,<br>              coordinator,<br>              transitionOptions,<br>              priority,<br>              overrideWidth,<br>              overrideHeight);<br>      <span class="hljs-type">RequestOptions</span> <span class="hljs-variable">thumbnailOptions</span> <span class="hljs-operator">=</span> requestOptions.clone()<br>          .sizeMultiplier(thumbSizeMultiplier);<br><br>      <span class="hljs-type">Request</span> <span class="hljs-variable">thumbnailRequest</span> <span class="hljs-operator">=</span><br>          obtainRequest(<br>              target,<br>              targetListener,<br>              thumbnailOptions,<br>              coordinator,<br>              transitionOptions,<br>              getThumbnailPriority(priority),<br>              overrideWidth,<br>              overrideHeight);<br><br>      coordinator.setRequests(fullRequest, thumbnailRequest);<br>      <span class="hljs-keyword">return</span> coordinator;<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-comment">// Base case: no thumbnail.</span><br>      <span class="hljs-comment">// 没有缩略图请求时，直接获取一个正常图请求</span><br>      <span class="hljs-keyword">return</span> obtainRequest(<br>          target,<br>          targetListener,<br>          requestOptions,<br>          parentCoordinator,<br>          transitionOptions,<br>          priority,<br>          overrideWidth,<br>          overrideHeight);<br>    }<br>}<br><br><span class="hljs-keyword">private</span> Request <span class="hljs-title function_">obtainRequest</span><span class="hljs-params">(</span><br><span class="hljs-params">      Target&lt;TranscodeType&gt; target,</span><br><span class="hljs-params">      RequestListener&lt;TranscodeType&gt; targetListener,</span><br><span class="hljs-params">      RequestOptions requestOptions,</span><br><span class="hljs-params">      RequestCoordinator requestCoordinator,</span><br><span class="hljs-params">      TransitionOptions&lt;?, ? <span class="hljs-built_in">super</span> TranscodeType&gt;   transitionOptions,</span><br><span class="hljs-params">      Priority priority,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideWidth,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> overrideHeight)</span> {<br>    <span class="hljs-comment">// 最终实际返回的是一个SingleRequest对象（将制定的资源加载进对应的Target</span><br>    <span class="hljs-keyword">return</span> SingleRequest.obtain(<br>        context,<br>        glideContext,<br>        model,<br>        transcodeClass,<br>        requestOptions,<br>        overrideWidth,<br>        overrideHeight,<br>        priority,<br>        target,<br>        targetListener,<br>        requestListeners,<br>        requestCoordinator,<br>        glideContext.getEngine(),<br>        transitionOptions.getTransitionFactory());<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上源码分析可知，我们在分析1处的buildRequest()<br>方法里建立了请求，且最多可同时进行缩略图和正常图的请求，最后，调用了requestManager.track(target, request)<br>方法，接着看看track里面做了什么。</p><h3 id="RequestManager-track"><a href="#RequestManager-track" class="headerlink" title="RequestManager#track"></a>RequestManager#track</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// 分析2</span><br><span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">track</span>(<span class="hljs-variable">@NonNull</span> Target&lt;?&gt; target, <span class="hljs-variable">@NonNull</span> Request request) {<br>    <span class="hljs-comment">// 加入一个target目标集合(Set)</span><br>    <span class="hljs-selector-tag">targetTracker</span><span class="hljs-selector-class">.track</span>(target);<br>    <br>    <span class="hljs-selector-tag">requestTracker</span><span class="hljs-selector-class">.runRequest</span>(request);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="RequestTracker-runRequest"><a href="#RequestTracker-runRequest" class="headerlink" title="RequestTracker#runRequest"></a>RequestTracker#runRequest</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Starts tracking the given request.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// 分析2</span><br><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">runRequest</span>(<span class="hljs-variable">@NonNull</span> Request request) {<br>    <span class="hljs-selector-tag">requests</span><span class="hljs-selector-class">.add</span>(request);<br>    <span class="hljs-selector-tag">if</span> (!isPaused) {<br>      <span class="hljs-comment">// 如果不是暂停状态则开始请求</span><br>      <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.begin</span>();<br>    } <span class="hljs-selector-tag">else</span> {<br>      <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.clear</span>();<br>      <span class="hljs-selector-tag">if</span> (Log.<span class="hljs-built_in">isLoggable</span>(TAG, Log.VERBOSE)) {<br>        <span class="hljs-selector-tag">Log</span><span class="hljs-selector-class">.v</span>(TAG, <span class="hljs-string">"Paused, delaying request"</span>);<br>      }<br>      <span class="hljs-comment">// 否则清空请求，加入延迟请求队列（为了对这些请求维持一个强引用，使用了ArrayList实现）</span><br>      <span class="hljs-selector-tag">pendingRequests</span><span class="hljs-selector-class">.add</span>(request);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="SingleRequest-begin"><a href="#SingleRequest-begin" class="headerlink" title="SingleRequest#begin"></a>SingleRequest#begin</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 分析2</span><br>@Override<br>public void <span class="hljs-keyword">begin</span><span class="hljs-literal">()</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  </span><span class="hljs-keyword">if</span> (model<span class="hljs-operator"> == </span>null) {<span class="hljs-operator"></span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><span class="hljs-comment">// model（url）为空，回调加载失败</span><br>    on<span class="hljs-constructor">LoadFailed(<span class="hljs-params">new</span> GlideException(<span class="hljs-string">"Received null   model"</span>)</span>, logLevel);<br>    return;<br>  }<br><br>  <span class="hljs-keyword">if</span> (status<span class="hljs-operator"> == </span>Status.RUNNING) {<br>    throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">IllegalArgumentException(<span class="hljs-string">"Cannot   restart a running request"</span>)</span>;<br>  }<br><br> <br>  <span class="hljs-keyword">if</span> (status<span class="hljs-operator"> == </span>Status.COMPLETE) {<br>    on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">resource</span>,   DataSource.MEMORY_CACHE)</span>;<br>    return;<br>  }<br><br>  status = Status.WAITING_FOR_SIZE;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Util</span>.</span></span>is<span class="hljs-constructor">ValidDimensions(<span class="hljs-params">overrideWidth</span>, <span class="hljs-params">overrideHeight</span>)</span>) {<br>    <span class="hljs-comment">// 当使用override() API为图片指定了一个固定的宽高时直接执行onSizeReady，</span><br>    <span class="hljs-comment">// 最终的核心处理位于onSizeReady</span><br>    on<span class="hljs-constructor">SizeReady(<span class="hljs-params">overrideWidth</span>, <span class="hljs-params">overrideHeight</span>)</span>;<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-comment">// 根据imageView的宽高算出图片的宽高，最终也会走到onSizeReady</span><br>    target.get<span class="hljs-constructor">Size(<span class="hljs-params">this</span>)</span>;<br>  }<br><br>  <span class="hljs-keyword">if</span> ((status<span class="hljs-operator"> == </span>Status.RUNNING<span class="hljs-operator"> || </span>status<span class="hljs-operator"> ==     </span>Status.WAITING_FOR_SIZE)<span class="hljs-operator"></span><br><span class="hljs-operator">      &amp;&amp; </span>can<span class="hljs-constructor">NotifyStatusChanged()</span>) {<br>    <span class="hljs-comment">// 预先加载设置的缩略图</span><br>    target.on<span class="hljs-constructor">LoadStarted(<span class="hljs-params">getPlaceholderDrawable</span>()</span>);<br>  }<br>  <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {<br>    log<span class="hljs-constructor">V(<span class="hljs-string">"finished run method in "</span> +   LogTime.<span class="hljs-params">getElapsedMillis</span>(<span class="hljs-params">startTime</span>)</span>);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从requestManager.track(target, request)开始，最终会执行到SingleRequest#begin()<br>方法的onSizeReady，可以猜到（因为后面只做了预加载缩略图的处理），真正的请求就是从这里开始的，咱们进去一探究竟~</p><h3 id="SingleRequest-onSizeReady"><a href="#SingleRequest-onSizeReady" class="headerlink" title="SingleRequest#onSizeReady"></a>SingleRequest#onSizeReady</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 分析2</span><br>@Override<br>public void on<span class="hljs-constructor">SizeReady(<span class="hljs-params">int</span> <span class="hljs-params">width</span>, <span class="hljs-params">int</span> <span class="hljs-params">height</span>)</span> {<br>  stateVerifier.throw<span class="hljs-constructor">IfRecycled()</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  </span>status = Status.RUNNING;<br><br>  <span class="hljs-built_in">float</span> sizeMultiplier =     requestOptions.get<span class="hljs-constructor">SizeMultiplier()</span>;<br>  this.width = maybe<span class="hljs-constructor">ApplySizeMultiplier(<span class="hljs-params">width</span>,     <span class="hljs-params">sizeMultiplier</span>)</span>;<br>  this.height = maybe<span class="hljs-constructor">ApplySizeMultiplier(<span class="hljs-params">height</span>,     <span class="hljs-params">sizeMultiplier</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  </span><span class="hljs-comment">// 根据给定的配置进行加载，engine是一个负责加载、管理活跃和缓存资源的引擎类</span><br>  loadStatus = engine.load(<br>      glideContext,<br>      model,<br>      requestOptions.get<span class="hljs-constructor">Signature()</span>,<br>      this.width,<br>      this.height,<br>      requestOptions.get<span class="hljs-constructor">ResourceClass()</span>,<br>      transcodeClass,<br>      priority,<br>      requestOptions.get<span class="hljs-constructor">DiskCacheStrategy()</span>,<br>      requestOptions.get<span class="hljs-constructor">Transformations()</span>,<br>      requestOptions.is<span class="hljs-constructor">TransformationRequired()</span>,<br>      requestOptions.is<span class="hljs-constructor">ScaleOnlyOrNoTransform()</span>,<br>      requestOptions.get<span class="hljs-constructor">Options()</span>,<br>      requestOptions.is<span class="hljs-constructor">MemoryCacheable()</span>,<br>      requestOptions.getUseUnlimitedSourceGeneratorsP    ool<span class="hljs-literal">()</span>,<br>      requestOptions.get<span class="hljs-constructor">UseAnimationPool()</span>,<br>      requestOptions.get<span class="hljs-constructor">OnlyRetrieveFromCache()</span>,<br>      this);<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator"></span>}<br></code></pre></td></tr></tbody></table></figure><p>终于看到Engine类了，感觉距离成功不远了，继续~</p><h3 id="Engine-load"><a href="#Engine-load" class="headerlink" title="Engine#load"></a>Engine#load</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public &lt;R&gt; LoadStatus load(<br>    GlideContext glideContext,<br>    Object model,<br>    Key signature,<br>    <span class="hljs-built_in">int</span> width,<br>    <span class="hljs-built_in">int</span> height,<br>    Class&lt;?&gt; resourceClass,<br>    Class&lt;R&gt; transcodeClass,<br>    Priority priority,<br>    DiskCacheStrategy diskCacheStrategy,<br>    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,<br>    boolean isTransformationRequired,<br>    boolean isScaleOnlyOrNoTransform,<br>    Options options,<br>    boolean isMemoryCacheable,<br>    boolean useUnlimitedSourceExecutorPool,<br>    boolean useAnimationPool,<br>    boolean onlyRetrieveFromCache,<br>    ResourceCallback cb) {<span class="hljs-operator"></span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">  </span><span class="hljs-comment">// 先从弱引用中查找，如果有的话回调onResourceReady并直接返回</span><br>  EngineResource&lt;?&gt; active = load<span class="hljs-constructor">FromActiveResources(<span class="hljs-params">key</span>, <span class="hljs-params">isMemoryCacheable</span>)</span>;<br>  <span class="hljs-keyword">if</span> (active != null) {<br>    cb.on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">active</span>,   DataSource.MEMORY_CACHE)</span>;<br>    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {<br>      log<span class="hljs-constructor">WithTimeAndKey(<span class="hljs-string">"Loaded resource from active     resources"</span>, <span class="hljs-params">startTime</span>, <span class="hljs-params">key</span>)</span>;<br>    }<br>    return null;<br>  }<br><br>  <span class="hljs-comment">// 没有再从内存中查找,有的话会取出并放到ActiveResources（内部维护的弱引用缓存map）里面</span><br>  EngineResource&lt;?&gt; cached = load<span class="hljs-constructor">FromCache(<span class="hljs-params">key</span>,     <span class="hljs-params">isMemoryCacheable</span>)</span>;<br>  <span class="hljs-keyword">if</span> (cached != null) {<br>    cb.on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">cached</span>,   DataSource.MEMORY_CACHE)</span>;<br>    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {<br>      log<span class="hljs-constructor">WithTimeAndKey(<span class="hljs-string">"Loaded resource from cache"</span>,     <span class="hljs-params">startTime</span>, <span class="hljs-params">key</span>)</span>;<br>    }<br>    return null;<br>  }<br><br>  EngineJob&lt;?&gt; current = jobs.get(key,     onlyRetrieveFromCache);<br>  <span class="hljs-keyword">if</span> (current != null) {<br>    current.add<span class="hljs-constructor">Callback(<span class="hljs-params">cb</span>)</span>;<br>    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {<br>      log<span class="hljs-constructor">WithTimeAndKey(<span class="hljs-string">"Added to existing load"</span>,     <span class="hljs-params">startTime</span>, <span class="hljs-params">key</span>)</span>;<br>    }<br>    return <span class="hljs-keyword">new</span> <span class="hljs-constructor">LoadStatus(<span class="hljs-params">cb</span>, <span class="hljs-params">current</span>)</span>;<br>  }<br><br>  <span class="hljs-comment">// 如果内存中没有，则创建engineJob（decodejob的回调类，管理下载过程以及状态）</span><br>  EngineJob&lt;R&gt; engineJob =<br>      engineJobFactory.build(<br>          key,<br>          isMemoryCacheable,<br>          useUnlimitedSourceExecutorPool,<br>          useAnimationPool,<br>          onlyRetrieveFromCache);<br><br>  <span class="hljs-comment">// 创建解析工作对象</span><br>  DecodeJob&lt;R&gt; decodeJob =<br>      decodeJobFactory.build(<br>          glideContext,<br>          model,<br>          key,<br>          signature,<br>          width,<br>          height,<br>          resourceClass,<br>          transcodeClass,<br>          priority,<br>          diskCacheStrategy,<br>          transformations,<br>          isTransformationRequired,<br>          isScaleOnlyOrNoTransform,<br>          onlyRetrieveFromCache,<br>          options,<br>          engineJob);<br><br>  <span class="hljs-comment">// 放在Jobs内部维护的HashMap中</span><br>  jobs.put(key, engineJob);<br><br>  <span class="hljs-comment">// 关注点8 后面分析会用到</span><br>  <span class="hljs-comment">// 注册ResourceCallback接口</span><br>  engineJob.add<span class="hljs-constructor">Callback(<span class="hljs-params">cb</span>)</span>;<br>  <span class="hljs-comment">// 内部开启线程去请求</span><br>  engineJob.start(decodeJob);<br><br>  <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {<br>    log<span class="hljs-constructor">WithTimeAndKey(<span class="hljs-string">"Started new load"</span>, <span class="hljs-params">startTime</span>,   <span class="hljs-params">key</span>)</span>;<br>  }<br>  return <span class="hljs-keyword">new</span> <span class="hljs-constructor">LoadStatus(<span class="hljs-params">cb</span>, <span class="hljs-params">engineJob</span>)</span>;<br>}<br><br>public void start(DecodeJob&lt;R&gt; decodeJob) {<br>    this.decodeJob = decodeJob;<br>    <span class="hljs-comment">// willDecodeFromCache方法内部根据不同的阶段stage，如果是RESOURCE_CACHE/DATA_CACHE则返回true，使用diskCacheExecutor，否则调用getActiveSourceExecutor，内部会根据相应的条件返回sourceUnlimitedExecutor/animationExecutor/sourceExecutor</span><br>    GlideExecutor executor =   <br>    decodeJob.will<span class="hljs-constructor">DecodeFromCache()</span><br>        ? diskCacheExecutor<br>        : get<span class="hljs-constructor">ActiveSourceExecutor()</span>;<br>    executor.execute(decodeJob);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，最终Engine(引擎)<br>类内部会执行到自身的start方法，它会根据不同的配置采用不同的线程池使用diskCacheExecutor/sourceUnlimitedExecutor/animationExecutor/sourceExecutor来执行最终的解码任务decodeJob。</p><h3 id="DecodeJob-run"><a href="#DecodeJob-run" class="headerlink" title="DecodeJob#run"></a>DecodeJob#run</h3><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp">runWrapped();<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">runWrapped</span>()</span> {<br>    <span class="hljs-keyword">switch</span> (runReason) {<br>      <span class="hljs-keyword">case</span> INITIALIZE:<br>        stage = getNextStage(Stage.INITIALIZE);<br>        <span class="hljs-comment">// 关注点1</span><br>        currentGenerator = getNextGenerator();<br>        <span class="hljs-comment">// 关注点2 内部会调用相应Generator的startNext()</span><br>        runGenerators();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> SWITCH_TO_SOURCE_SERVICE:<br>        runGenerators();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> DECODE_DATA:<br>        <span class="hljs-comment">// 关注点3 将获取的数据解码成对应的资源</span><br>        decodeFromRetrievedData();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-literal">default</span>:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Unrecognized     run reason: "</span> + runReason);<br>    }<br>}<br><br><span class="hljs-comment">// 关注点1，完整情况下，会异步依次生成这里的ResourceCacheGenerator、DataCacheGenerator和SourceGenerator对象，并在之后执行其中的startNext()</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> DataFetcherGenerator <span class="hljs-title">getNextGenerator</span>()</span> {<br>    <span class="hljs-keyword">switch</span> (stage) {<br>      <span class="hljs-keyword">case</span> RESOURCE_CACHE:<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="hljs-keyword">this</span>);<br>      <span class="hljs-keyword">case</span> DATA_CACHE:<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataCacheGenerator(decodeHelper, <span class="hljs-keyword">this</span>);<br>      <span class="hljs-keyword">case</span> SOURCE:<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SourceGenerator(decodeHelper, <span class="hljs-keyword">this</span>);<br>      <span class="hljs-keyword">case</span> FINISHED:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-literal">default</span>:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Unrecognized     stage: "</span> + stage);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="SourceGenerator-startNext"><a href="#SourceGenerator-startNext" class="headerlink" title="SourceGenerator#startNext"></a>SourceGenerator#startNext</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 关注点2</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startNext</span><span class="hljs-params">()</span> {<br>  <span class="hljs-comment">// dataToCache数据不为空的话缓存到硬盘（第一执行该方法是不会调用的）</span><br>  <span class="hljs-keyword">if</span> (dataToCache != <span class="hljs-literal">null</span>) {<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> dataToCache;<br>    dataToCache = <span class="hljs-literal">null</span>;<br>    cacheData(data);<br>  }<br><br>  <span class="hljs-keyword">if</span> (sourceCacheGenerator != <span class="hljs-literal">null</span> &amp;&amp;     sourceCacheGenerator.startNext()) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  }<br>  sourceCacheGenerator = <span class="hljs-literal">null</span>;<br><br>  loadData = <span class="hljs-literal">null</span>;<br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) {<br>    <span class="hljs-comment">// 关注点4 getLoadData()方法内部会在modelLoaders里面找到ModelLoder对象</span><br>    <span class="hljs-comment">// （每个Generator对应一个ModelLoader），</span><br>    <span class="hljs-comment">// 并使用modelLoader.buildLoadData方法返回一个loadData列表</span><br>    loadData =   helper.getLoadData().get(loadDataListIndex++);<br>    <span class="hljs-keyword">if</span> (loadData != <span class="hljs-literal">null</span><br>        &amp;&amp; (helper.getDiskCacheStrategy().isDataCache  <span class="hljs-title function_">able</span><span class="hljs-params">(loadData.fetcher.getDataSource()</span>)<br>        || helper.hasLoadPath(loadData.fetcher.getDat  <span class="hljs-title function_">aClass</span><span class="hljs-params">()</span>))) {<br>      started = <span class="hljs-literal">true</span>;<br>      <span class="hljs-comment">// 关注点6 通过loadData对象的fetcher对象（有关注点3的分析可知其实现类为HttpUrlFetcher）的</span><br>      <span class="hljs-comment">// loadData方法来获取图片数据</span><br>      loadData.fetcher.loadData(helper.getPriority(),     <span class="hljs-built_in">this</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> started;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="DecodeHelper-getLoadData"><a href="#DecodeHelper-getLoadData" class="headerlink" title="DecodeHelper#getLoadData"></a>DecodeHelper#getLoadData</h3><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">List&lt;LoadData&lt;?&gt;&gt; getLoadData() {<br>    <span class="hljs-keyword">if</span> (!isLoadDataSet) {<br>      isLoadDataSet = <span class="hljs-keyword">true</span>;<br>      loadData.clear();<br>      List&lt;ModelLoader&lt;<span class="hljs-keyword">Object</span>, ?&gt;&gt; modelLoaders =   glideContext.getRegistry().getModelLoaders(model)  ;<br>      //noinspection ForLoopReplaceableByForEach <span class="hljs-keyword">to</span>   improve perf<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>, size = modelLoaders.size(); i &lt;   size; i++) {<br>        ModelLoader&lt;<span class="hljs-keyword">Object</span>, ?&gt; modelLoader =     modelLoaders.<span class="hljs-keyword">get</span>(i);<br>        // 注意：这里最终是通过HttpGlideUrlLoader的buildLoadData获取到实际的loadData对象<br>        LoadData&lt;?&gt; <span class="hljs-keyword">current</span> =<br>            modelLoader.buildLoadData(model, width,     height, <span class="hljs-keyword">options</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">current</span> != <span class="hljs-keyword">null</span>) {<br>          loadData.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">current</span>);<br>        }<br>      }<br>    }<br>    <span class="hljs-keyword">return</span> loadData;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="HttpGlideUrlLoader-buildLoadData"><a href="#HttpGlideUrlLoader-buildLoadData" class="headerlink" title="HttpGlideUrlLoader#buildLoadData"></a>HttpGlideUrlLoader#buildLoadData</h3><figure class="highlight processing"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs processing">@Override<br><span class="hljs-keyword">public</span> LoadData&lt;InputStream&gt; <span class="hljs-title function_">buildLoadData</span>(@NonNull   GlideUrl model, <span class="hljs-type">int</span> <span class="hljs-built_in">width</span>, <span class="hljs-type">int</span> <span class="hljs-built_in">height</span>,<br>    @NonNull Options options) {<br>  <span class="hljs-comment">// GlideUrls memoize parsed URLs so caching them     saves a few object instantiations and time</span><br>  <span class="hljs-comment">// spent parsing urls.</span><br>  GlideUrl url = model;<br>  <span class="hljs-keyword">if</span> (modelCache != <span class="hljs-literal">null</span>) {<br>    url = modelCache.<span class="hljs-property">get</span>(model, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (url == <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// 关注点5</span><br>      modelCache.<span class="hljs-property">put</span>(model, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, model);<br>      url = model;<br>    }<br>  }<br>  <span class="hljs-type">int</span> timeout = options.<span class="hljs-property">get</span>(TIMEOUT);<br>  <span class="hljs-comment">// 注意，这里创建了一个DataFetcher的实现类HttpUrlFetcher</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new </span><span class="hljs-class title_">LoadData</span>&lt;&gt;(url, <span class="hljs-keyword">new </span><span class="hljs-class title_">HttpUrlFetcher</span>(url,     timeout));<br>}<br><br><span class="hljs-comment">// 关注点5</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span>(A model, <span class="hljs-type">int</span> <span class="hljs-built_in">width</span>, <span class="hljs-type">int</span> <span class="hljs-built_in">height</span>, B value) {<br>    ModelKey&lt;A&gt; <span class="hljs-built_in">key</span> = ModelKey.<span class="hljs-property">get</span>(model, <span class="hljs-built_in">width</span>,     <span class="hljs-built_in">height</span>);<br>    <span class="hljs-comment">// 最终是通过LruCache来缓存对应的值，key是一个ModelKey对象（由model、width、height三个属性组成）</span><br>    cache.<span class="hljs-property">put</span>(<span class="hljs-built_in">key</span>, value);<br>}<br></code></pre></td></tr></tbody></table></figure><p>从这里的分析，我们明白了HttpUrlFetcher实际上就是最终的请求执行者，而且，我们知道了Glide会使用LruCache来对解析后的url来进行缓存，以便后续可以省去解析url的时间。</p><h3 id="HttpUrlFetcher-loadData"><a href="#HttpUrlFetcher-loadData" class="headerlink" title="HttpUrlFetcher#loadData"></a>HttpUrlFetcher#loadData</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadData</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Priority priority,</span><br><span class="hljs-params">    <span class="hljs-meta">@NonNull</span> DataCallback&lt;? <span class="hljs-built_in">super</span> InputStream&gt;   callback)</span> {<br>  <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> LogTime.getLogTime();<br>  <span class="hljs-keyword">try</span> {<br>    <span class="hljs-comment">// 关注点6</span><br>    <span class="hljs-comment">// loadDataWithRedirects内部是通过HttpURLConnection网络请求数据</span><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span>   loadDataWithRedirects(glideUrl.toURL(), <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>,   glideUrl.getHeaders());<br>    <span class="hljs-comment">// 请求成功回调onDataReady()</span><br>    callback.onDataReady(result);<br>  } <span class="hljs-keyword">catch</span> (IOException e) {<br>    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {<br>      Log.d(TAG, <span class="hljs-string">"Failed to load data for url"</span>, e);<br>    }<br>    callback.onLoadFailed(e);<br>  } <span class="hljs-keyword">finally</span> {<br>    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {<br>      Log.v(TAG, <span class="hljs-string">"Finished http url fetcher fetch in     "</span> + LogTime.getElapsedMillis(startTime));<br>    }<br>  }<br>}<br><br><span class="hljs-keyword">private</span> InputStream <span class="hljs-title function_">loadDataWithRedirects</span><span class="hljs-params">(URL url, <span class="hljs-type">int</span> redirects, URL lastUrl,</span><br><span class="hljs-params">  Map&lt;String, String&gt; headers)</span> <span class="hljs-keyword">throws</span> IOException {<br>    <br>    ...<br><br>    urlConnection.connect();<br>    <span class="hljs-comment">// Set the stream so that it's closed in cleanup to avoid resource leaks. See #2352.</span><br>    stream = urlConnection.getInputStream();<br>    <span class="hljs-keyword">if</span> (isCancelled) {<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">statusCode</span> <span class="hljs-operator">=</span> urlConnection.getResponseCode();<br>    <span class="hljs-comment">// 只要是2xx形式的状态码则判断为成功</span><br>    <span class="hljs-keyword">if</span> (isHttpOk(statusCode)) {<br>      <span class="hljs-comment">// 从urlConnection中获取资源流</span><br>      <span class="hljs-keyword">return</span> getStreamForSuccessfulRequest(urlConnection);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isHttpRedirect(statusCode)) {<br>    <br>      ...<br>      <br>      <span class="hljs-comment">// 重定向请求</span><br>      <span class="hljs-keyword">return</span> loadDataWithRedirects(redirectUrl, redirects + <span class="hljs-number">1</span>, url,   headers);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (statusCode == INVALID_STATUS_CODE) {<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpException</span>(statusCode);<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpException</span>(urlConnection.getResponseMessage(),   statusCode);<br>    }<br>}<br><br><span class="hljs-keyword">private</span> InputStream <span class="hljs-title function_">getStreamForSuccessfulRequest</span><span class="hljs-params">(HttpURLConnection urlConnection)</span><br>  <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-keyword">if</span> (TextUtils.isEmpty(urlConnection.getContentEncoding())) {<br>      <span class="hljs-type">int</span> <span class="hljs-variable">contentLength</span> <span class="hljs-operator">=</span> urlConnection.getContentLength();<br>      stream = ContentLengthInputStream.obtain(urlConnection.getInputStr  <span class="hljs-title function_">eam</span><span class="hljs-params">()</span>, contentLength);<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {<br>        Log.d(TAG, <span class="hljs-string">"Got non empty content encoding: "</span> +     urlConnection.getContentEncoding());<br>      }<br>      stream = urlConnection.getInputStream();<br>    }<br>    <span class="hljs-keyword">return</span> stream;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在HttpUrlFetcher#loadData方法的loadDataWithRedirects里面，Glide通过原生的HttpURLConnection进行请求后，并调用getStreamForSuccessfulRequest()<br>方法获取到了最终的图片流。</p><h3 id="DecodeJob-run-1"><a href="#DecodeJob-run-1" class="headerlink" title="DecodeJob#run"></a>DecodeJob#run</h3><p>在我们通过HtttpUrlFetcher的loadData()方法请求得到对应的流之后，我们还必须对流进行处理得到最终我们想要的资源。这里我们回到第10步DecodeJob#run方法的关注点3处，这行代码将会对流进行解码。</p><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">decodeFromRetrievedData</span>();<br></code></pre></td></tr></tbody></table></figure><p>接下来，继续看看他内部的处理。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> void decodeFromRetrievedData() {<br>    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {<br>      logWithTimeAndKey(<span class="hljs-string">"Retrieved data"</span>, startFetchTime,<br>          <span class="hljs-string">"data: "</span> + currentData<br>              + <span class="hljs-string">", cache key: "</span> + currentSourceKey<br>              + <span class="hljs-string">", fetcher: "</span> + currentFetcher);<br>    }<br>    Resource&lt;R&gt; resource = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">//  核心代码 </span><br>      <span class="hljs-comment">// 从数据中解码得到资源</span><br>      resource = decodeFromData(currentFetcher, currentData,   currentDataSource);<br>    } <span class="hljs-keyword">catch</span> (GlideException e) {<br>      e.setLoggingDetails(currentAttemptingKey, currentDataSource);<br>      throwables.add(e);<br>    }<br>    <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) {<br>      <span class="hljs-comment">// 关注点8 </span><br>      <span class="hljs-comment">// 编码和发布最终得到的Resource&lt;Bitmap&gt;对象</span><br>      notifyEncodeAndRelease(resource, currentDataSource);<br>    } <span class="hljs-keyword">else</span> {<br>      runGenerators();<br>    }<br>}<br><br> <span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; decodeFromData(DataFetcher&lt;?&gt; fetcher, Data <span class="hljs-keyword">data</span>,<br>  DataSource dataSource) throws GlideException {<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> == <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      }<br>      long startTime = LogTime.getLogTime();<br>      <span class="hljs-comment">// 核心代码</span><br>      <span class="hljs-comment">// 进一步包装了解码方法</span><br>      Resource&lt;R&gt; result = decodeFromFetcher(<span class="hljs-keyword">data</span>, dataSource);<br>      <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {<br>        logWithTimeAndKey(<span class="hljs-string">"Decoded result "</span> + result, startTime);<br>      }<br>      <span class="hljs-keyword">return</span> result;<br>    } <span class="hljs-keyword">finally</span> {<br>      fetcher.cleanup();<br>    }<br>}<br><br><span class="hljs-meta">@SuppressWarnings(<span class="hljs-string">"unchecked"</span>)</span><br><span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; decodeFromFetcher(Data <span class="hljs-keyword">data</span>, DataSource dataSource)<br>  throws GlideException {<br>    LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) <span class="hljs-keyword">data</span>.getClass());<br>    <span class="hljs-comment">// 核心代码</span><br>    <span class="hljs-comment">// 将解码任务分发给LoadPath</span><br>    <span class="hljs-keyword">return</span> runLoadPath(<span class="hljs-keyword">data</span>, dataSource, path);<br>}<br><br><span class="hljs-keyword">private</span> &lt;Data, ResourceType&gt; Resource&lt;R&gt; runLoadPath(Data <span class="hljs-keyword">data</span>, DataSource dataSource,<br>  LoadPath&lt;Data, ResourceType, R&gt; path) throws GlideException {<br>    Options options = getOptionsWithHardwareConfig(dataSource);<br>    <span class="hljs-comment">// 将数据进一步包装</span><br>    DataRewinder&lt;Data&gt; rewinder =     glideContext.getRegistry().getRewinder(<span class="hljs-keyword">data</span>);<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">// ResourceType in DecodeCallback below is required for   compilation to work with gradle.</span><br>      <span class="hljs-comment">// 核心代码</span><br>      <span class="hljs-comment">// 将解码任务分发给LoadPath</span><br>      <span class="hljs-keyword">return</span> path.load(<br>          rewinder, options, width, height, new   DecodeCallback&lt;ResourceType&gt;(dataSource));<br>    } <span class="hljs-keyword">finally</span> {<br>      rewinder.cleanup();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="LoadPath-load"><a href="#LoadPath-load" class="headerlink" title="LoadPath#load"></a>LoadPath#load</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Resource&lt;Transcode&gt; load(DataRewinder&lt;Data&gt; rewinder, @NonNull Options options, <span class="hljs-built_in">int</span> width,<br>  <span class="hljs-built_in">int</span> height, DecodePath.DecodeCallback&lt;ResourceType&gt; decodeCallback) throws GlideException {<br>List&lt;Throwable&gt; throwables = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Preconditions</span>.</span></span>check<span class="hljs-constructor">NotNull(<span class="hljs-params">listPool</span>.<span class="hljs-params">acquire</span>()</span>);<br><span class="hljs-keyword">try</span> {<br>  <span class="hljs-comment">// 核心代码</span><br>  return load<span class="hljs-constructor">WithExceptionList(<span class="hljs-params">rewinder</span>, <span class="hljs-params">options</span>, <span class="hljs-params">width</span>, <span class="hljs-params">height</span>, <span class="hljs-params">decodeCallback</span>, <span class="hljs-params">throwables</span>)</span>;<br>} finally {<br>  listPool.release(throwables);<br>}<br></code></pre></td></tr></tbody></table></figure><p>}</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">private</span> Resource&lt;Transcode&gt; loadWithExceptionList(DataRewinder&lt;Data&gt; rewinder,<br>      @NonNull <span class="hljs-keyword">Options</span> <span class="hljs-keyword">options</span>,<br>      <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height, DecodePath.DecodeCallback&lt;ResourceType&gt;   decodeCallback,<br>      List&lt;Throwable&gt; exceptions) <span class="hljs-keyword">throws</span> GlideException {<br>    Resource&lt;Transcode&gt; result = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-comment">//noinspection ForLoopReplaceableByForEach to improve perf</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, <span class="hljs-keyword">size</span> = decodePaths.<span class="hljs-keyword">size</span>(); i &lt; <span class="hljs-keyword">size</span>; i++) {<br>      DecodePath&lt;Data, ResourceType, Transcode&gt; path =   decodePaths.get(i);<br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 核心代码</span><br>        <span class="hljs-comment">// 将解码任务又进一步分发给DecodePath的decode方法去解码</span><br>        result = path.decode(rewinder, width, height, <span class="hljs-keyword">options</span>,     decodeCallback);<br>      } <span class="hljs-keyword">catch</span> (GlideException e) {<br>        exceptions.add(e);<br>      }<br>      <span class="hljs-keyword">if</span> (result != <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-keyword">break</span>;<br>      }<br>    }<br><br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span>) {<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> GlideException(failureMessage, <span class="hljs-keyword">new</span>   ArrayList&lt;&gt;(exceptions));<br>    }<br><br>    <span class="hljs-keyword">return</span> result;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="DecodePath-decode"><a href="#DecodePath-decode" class="headerlink" title="DecodePath#decode"></a>DecodePath#decode</h3><figure class="highlight processing"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> Resource&lt;Transcode&gt; <span class="hljs-title function_">decode</span>(DataRewinder&lt;DataType&gt; rewinder,     <span class="hljs-type">int</span> <span class="hljs-built_in">width</span>, <span class="hljs-type">int</span> <span class="hljs-built_in">height</span>,<br>      @NonNull Options options, DecodeCallback&lt;ResourceType&gt; callback)   <span class="hljs-keyword">throws</span> GlideException {<br>    <span class="hljs-comment">// 核心代码</span><br>    <span class="hljs-comment">// 继续调用DecodePath的decodeResource方法去解析出数据</span><br>    Resource&lt;ResourceType&gt; decoded = <span class="hljs-title function_">decodeResource</span>(rewinder, <span class="hljs-built_in">width</span>,     <span class="hljs-built_in">height</span>, options);<br>    Resource&lt;ResourceType&gt; transformed =     callback.<span class="hljs-property">onResourceDecoded</span>(decoded);<br>    <span class="hljs-keyword">return</span> transcoder.<span class="hljs-property">transcode</span>(transformed, options);<br>}<br><br>@NonNull<br><span class="hljs-keyword">private</span> Resource&lt;ResourceType&gt; <span class="hljs-title function_">decodeResource</span>(DataRewinder&lt;DataType&gt;   rewinder, <span class="hljs-type">int</span> <span class="hljs-built_in">width</span>,<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">height</span>, @NonNull Options options) <span class="hljs-keyword">throws</span> GlideException {<br>  List&lt;Throwable&gt; exceptions =     Preconditions.<span class="hljs-property">checkNotNull</span>(listPool.<span class="hljs-property">acquire</span>());<br>  <span class="hljs-keyword">try</span> {<br>    <span class="hljs-comment">// 核心代码</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">decodeResourceWithList</span>(rewinder, <span class="hljs-built_in">width</span>, <span class="hljs-built_in">height</span>, options,   exceptions);<br>  } <span class="hljs-keyword">finally</span> {<br>    listPool.<span class="hljs-property">release</span>(exceptions);<br>  }<br>}<br><br>@NonNull<br><span class="hljs-keyword">private</span> Resource&lt;ResourceType&gt;   <span class="hljs-title function_">decodeResourceWithList</span>(DataRewinder&lt;DataType&gt; rewinder, <span class="hljs-type">int</span> <span class="hljs-built_in">width</span>,<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">height</span>, @NonNull Options options, List&lt;Throwable&gt; exceptions)   <span class="hljs-keyword">throws</span> GlideException {<br>  Resource&lt;ResourceType&gt; result = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">//noinspection ForLoopReplaceableByForEach to improve perf</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>, <span class="hljs-built_in">size</span> = decoders.<span class="hljs-property">size</span>(); i &lt; <span class="hljs-built_in">size</span>; i++) {<br>    ResourceDecoder&lt;DataType, ResourceType&gt; decoder = decoders.<span class="hljs-property">get</span>(i);<br>    <span class="hljs-keyword">try</span> {<br>      DataType data = rewinder.<span class="hljs-property">rewindAndGet</span>();<br>      <span class="hljs-keyword">if</span> (decoder.<span class="hljs-property">handles</span>(data, options)) {<br>        <span class="hljs-comment">// 获取包装的数据</span><br>        data = rewinder.<span class="hljs-property">rewindAndGet</span>();<br>        <span class="hljs-comment">// 核心代码 </span><br>        <span class="hljs-comment">// 根据DataType和ResourceType的类型分发给不同的解码器Decoder</span><br>        result = decoder.<span class="hljs-property">decode</span>(data, <span class="hljs-built_in">width</span>, <span class="hljs-built_in">height</span>, options);<br>      }<br>    } <span class="hljs-title function_">catch</span> (IOException | RuntimeException | OutOfMemoryError e) {<br>      <span class="hljs-keyword">if</span> (Log.<span class="hljs-property">isLoggable</span>(TAG, Log.<span class="hljs-property">VERBOSE</span>)) {<br>        Log.<span class="hljs-property">v</span>(TAG, <span class="hljs-string">"Failed to decode data for "</span> + decoder, e);<br>      }<br>      exceptions.<span class="hljs-property">add</span>(e);<br>    }<br><br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br><br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new </span><span class="hljs-class title_">GlideException</span>(failureMessage, <span class="hljs-keyword">new   </span><span class="hljs-class title_">ArrayList</span>&lt;&gt;(exceptions));<br>  }<br>  <span class="hljs-keyword">return</span> result;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，经过一连串的嵌套调用，最终执行到了decoder.decode()这行代码，decode是一个ResourceDecoder&lt;DataType, ResourceType&gt;<br>接口（资源解码器），根据不同的DataType和ResourceType它会有不同的实现类，这里的实现类是ByteBufferBitmapDecoder，接下来让我们来看看这个解码器内部的解码流程。</p><h3 id="ByteBufferBitmapDecoder-decode"><a href="#ByteBufferBitmapDecoder-decode" class="headerlink" title="ByteBufferBitmapDecoder#decode"></a>ByteBufferBitmapDecoder#decode</h3><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Decodes {@link android.graphics.Bitmap Bitmaps} from {@link    java.nio.ByteBuffer ByteBuffers}.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">ByteBufferBitmapDecoder</span> <span class="hljs-symbol">implements</span>     <span class="hljs-symbol">ResourceDecoder</span>&lt;<span class="hljs-symbol">ByteBuffer, <span class="hljs-symbol">Bitmap</span></span>&gt; {<br>  <br>  ...<br><br>  @Override<br>  <span class="hljs-keyword">public</span> Resource&lt;Bitmap&gt; decode(@NonNull ByteBuffer source, <span class="hljs-built_in">int</span> width,   <span class="hljs-built_in">int</span> height,<br>      @NonNull Options options)<br>      throws IOException {<br>    InputStream <span class="hljs-keyword">is</span> = ByteBufferUtil.toStream(source);<br>    <span class="hljs-comment">// 核心代码</span><br>    <span class="hljs-keyword">return</span> downsampler.decode(<span class="hljs-keyword">is</span>, width, height, options);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，最终是使用了一个downsampler，它是一个压缩器，主要是对流进行解码，压缩，圆角等处理。</p><h3 id="DownSampler-decode"><a href="#DownSampler-decode" class="headerlink" title="DownSampler#decode"></a>DownSampler#decode</h3><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> Resource&lt;Bitmap&gt; decode(InputStream is, <span class="hljs-keyword">int</span> outWidth, <span class="hljs-keyword">int</span> outHeight,<br>  <span class="hljs-keyword">Options</span> <span class="hljs-keyword">options</span>) <span class="hljs-keyword">throws</span> IOException {<br>    <span class="hljs-keyword">return</span> decode(is, outWidth, outHeight, <span class="hljs-keyword">options</span>, EMPTY_CALLBACKS);<br>}<br><br> @SuppressWarnings({<span class="hljs-string">"resource"</span>, <span class="hljs-string">"deprecation"</span>})<br><span class="hljs-keyword">public</span> Resource&lt;Bitmap&gt; decode(InputStream is, <span class="hljs-keyword">int</span> requestedWidth, <span class="hljs-keyword">int</span> requestedHeight,<br>      <span class="hljs-keyword">Options</span> <span class="hljs-keyword">options</span>, DecodeCallbacks callbacks) <span class="hljs-keyword">throws</span> IOException {<br>    Preconditions.checkArgument(is.markSupported(), <span class="hljs-string">"You must provide an     InputStream that supports"</span><br>        + <span class="hljs-string">" mark()"</span>);<br><br>    ...<br><br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">// 核心代码</span><br>      Bitmap result = decodeFromWrappedStreams(is, bitmapFactoryOptions,<br>          downsampleStrategy, decodeFormat, isHardwareConfigAllowed,   requestedWidth,<br>          requestedHeight, fixBitmapToRequestedDimensions, callbacks);<br>      <span class="hljs-comment">// 关注点7   </span><br>      <span class="hljs-comment">// 解码得到Bitmap对象后，包装成BitmapResource对象返回，</span><br>      <span class="hljs-comment">// 通过内部的get方法得到Resource&lt;Bitmap&gt;对象</span><br>      <span class="hljs-keyword">return</span> BitmapResource.obtain(result, bitmapPool);<br>    } <span class="hljs-keyword">finally</span> {<br>      releaseOptions(bitmapFactoryOptions);<br>      byteArrayPool.put(bytesForOptions);<br>    }<br>}<br><br><span class="hljs-keyword">private</span> Bitmap decodeFromWrappedStreams(InputStream is,<br>      BitmapFactory.<span class="hljs-keyword">Options</span> <span class="hljs-keyword">options</span>, DownsampleStrategy downsampleStrategy,<br>      DecodeFormat decodeFormat, <span class="hljs-keyword">boolean</span> isHardwareConfigAllowed, <span class="hljs-keyword">int</span> requestedWidth,<br>      <span class="hljs-keyword">int</span> requestedHeight, <span class="hljs-keyword">boolean</span> fixBitmapToRequestedDimensions,<br>      DecodeCallbacks callbacks) <span class="hljs-keyword">throws</span> IOException {<br>    <br>    <span class="hljs-comment">// 省去计算压缩比例等一系列非核心逻辑</span><br>    ...<br>    <br>    <span class="hljs-comment">// 核心代码</span><br>    Bitmap downsampled = decodeStream(is, <span class="hljs-keyword">options</span>, callbacks, bitmapPool);<br>    callbacks.onDecodeComplete(bitmapPool, downsampled);<br><br>    ...<br><br>    <span class="hljs-comment">// Bimtap旋转处理</span><br>    ...<br>    <br>    <span class="hljs-keyword">return</span> rotated;<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Bitmap decodeStream(InputStream is,     BitmapFactory.<span class="hljs-keyword">Options</span> <span class="hljs-keyword">options</span>,<br>      DecodeCallbacks callbacks, BitmapPool bitmapPool) <span class="hljs-keyword">throws</span>   IOException {<br>    <br>    ...<br>    <br>    TransformationUtils.getBitmapDrawableLock().lock();<br>    <span class="hljs-keyword">try</span> {<br>      <span class="hljs-comment">// 核心代码</span><br>      result = BitmapFactory.decodeStream(is, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">options</span>);<br>    } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {<br>      ...<br>    } <span class="hljs-keyword">finally</span> {<br>      TransformationUtils.getBitmapDrawableLock().unlock();<br>    }<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">options</span>.inJustDecodeBounds) {<br>      is.reset();<br>    }<br>    <span class="hljs-keyword">return</span> result;<br>}<br></code></pre></td></tr></tbody></table></figure><p>从以上源码流程我们知道，最后是在DownSampler的decodeStream()方法中使用了BitmapFactory.decodeStream()<br>来得到Bitmap对象。然后，我们来分析下图片时如何显示的，我们回到步骤19的DownSampler#decode方法，看到关注点7，这里是将Bitmap包装成BitmapResource对象返回，通过内部的get方法可以得到Resource对象，再回到步骤15的DecodeJob#run方法，这是使用了notifyEncodeAndRelease()<br>方法对Resource对象进行了发布。</p><h3 id="DecodeJob-notifyEncodeAndRelease"><a href="#DecodeJob-notifyEncodeAndRelease" class="headerlink" title="DecodeJob#notifyEncodeAndRelease"></a>DecodeJob#notifyEncodeAndRelease</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void notify<span class="hljs-constructor">EncodeAndRelease(Resource&lt;R&gt; <span class="hljs-params">resource</span>, DataSource     <span class="hljs-params">dataSource</span>)</span> {<span class="hljs-operator"></span><br><span class="hljs-operator"> </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>notify<span class="hljs-constructor">Complete(<span class="hljs-params">result</span>, <span class="hljs-params">dataSource</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><br><span class="hljs-operator"></span>}<br><br><span class="hljs-keyword">private</span> void notify<span class="hljs-constructor">Complete(Resource&lt;R&gt; <span class="hljs-params">resource</span>, DataSource     <span class="hljs-params">dataSource</span>)</span> {<br>    set<span class="hljs-constructor">NotifiedOrThrow()</span>;<br>    callback.on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">resource</span>, <span class="hljs-params">dataSource</span>)</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>从以上EngineJob的源码可知，它实现了DecodeJob.CallBack这个接口。</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EngineJob</span>&lt;<span class="hljs-title">R</span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">DecodeJob</span></span>.<span class="hljs-title">Callback</span>&lt;<span class="hljs-title">R</span>&gt;,</span><br><span class="hljs-class">    <span class="hljs-title">Poolable</span> </span>{<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="EngineJob-onResourceReady"><a href="#EngineJob-onResourceReady" class="headerlink" title="EngineJob#onResourceReady"></a>EngineJob#onResourceReady</h3><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onResourceReady</span>(<span class="hljs-params">Resource&lt;R&gt; resource, DataSource   dataSource</span>) {<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">resource</span> = resource;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span> = dataSource;<br>  <span class="hljs-variable constant_">MAIN_THREAD_HANDLER</span>.<span class="hljs-title function_">obtainMessage</span>(<span class="hljs-variable constant_">MSG_COMPLETE</span>, <span class="hljs-variable language_">this</span>).<span class="hljs-title function_">sendToTarget</span>();<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainThreadCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Handler</span>.<span class="hljs-property">Callback</span>{<br><br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">Message message</span>) {<br>      <span class="hljs-title class_">EngineJob</span>&lt;?&gt; job = (<span class="hljs-title class_">EngineJob</span>&lt;?&gt;) message.<span class="hljs-property">obj</span>;<br>      <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">what</span>) {<br>        <span class="hljs-keyword">case</span> <span class="hljs-attr">MSG_COMPLETE</span>:<br>          <span class="hljs-comment">// 核心代码</span><br>          job.<span class="hljs-title function_">handleResultOnMainThread</span>();<br>          <span class="hljs-keyword">break</span>;<br>        ...<br>      }<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从以上源码可知，通过主线程Handler对象进行切换线程，然后在主线程调用了handleResultOnMainThread这个方法。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Synthetic<br>void handle<span class="hljs-constructor">ResultOnMainThread()</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">  </span><span class="hljs-comment">//noinspection ForLoopReplaceableByForEach to improve perf</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>, size = cbs.size<span class="hljs-literal">()</span>; i &lt; size; i++) {<br>    ResourceCallback cb = cbs.get(i);<br>    <span class="hljs-keyword">if</span> (!is<span class="hljs-constructor">InIgnoredCallbacks(<span class="hljs-params">cb</span>)</span>) {<br>      engineResource.acquire<span class="hljs-literal">()</span>;<br>      cb.on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">engineResource</span>, <span class="hljs-params">dataSource</span>)</span>;<br>    }<br>  }<span class="hljs-operator"></span><br><span class="hljs-operator"> </span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator"></span>}<br></code></pre></td></tr></tbody></table></figure><p>这里又通过一个循环调用了所有ResourceCallback的方法，让我们回到步骤9处Engine#load方法的关注点8这行代码，这里对ResourceCallback进行了注册，在步骤8出SingleRequest#onSizeReady方法里的engine.load中，我们看到最后一个参数，传入的是this，可以明白，engineJob.addCallback(<br>cb)这里的cb的实现类就是SingleRequest。接下来，让我们看看SingleRequest的onResourceReady方法。</p><h3 id="SingleRequest-onResourceReady"><a href="#SingleRequest-onResourceReady" class="headerlink" title="SingleRequest#onResourceReady"></a>SingleRequest#onResourceReady</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * A callback method that should never be invoked directly.</span><br><span class="hljs-comment"> */</span><br>@<span class="hljs-constructor">SuppressWarnings(<span class="hljs-string">"unchecked"</span>)</span><br>@Override<br>public void on<span class="hljs-constructor">ResourceReady(Resource&lt;?&gt; <span class="hljs-params">resource</span>, DataSource   <span class="hljs-params">dataSource</span>)</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  </span><span class="hljs-comment">// 从Resource&lt;Bitmap&gt;中得到Bitmap对象</span><br>  Object received = resource.get<span class="hljs-literal">()</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  ...</span><br><span class="hljs-operator">  </span><br><span class="hljs-operator">  </span>on<span class="hljs-constructor">ResourceReady((Resource&lt;R&gt;)</span> resource, (R) received, dataSource);<br>}<br><br><span class="hljs-keyword">private</span> void on<span class="hljs-constructor">ResourceReady(Resource&lt;R&gt; <span class="hljs-params">resource</span>, R <span class="hljs-params">resultDataSource</span> <span class="hljs-params">dataSource</span>)</span> {<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span><span class="hljs-keyword">try</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">      ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">      </span><span class="hljs-keyword">if</span> (!anyListenerHandledUpdatingTarget) {<br>        Transition&lt;? super R&gt; animation =<br>            animationFactory.build(dataSource, isFirstResource);<br>        <span class="hljs-comment">// 核心代码</span><br>        target.on<span class="hljs-constructor">ResourceReady(<span class="hljs-params">result</span>, <span class="hljs-params">animation</span>)</span>;<br>      }<br>    } finally {<br>      isCallingCallbacks = <span class="hljs-literal">false</span>;<br>    }<br><br>    notify<span class="hljs-constructor">LoadSuccess()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在SingleRequest#onResourceReady方法中又调用了target.onResourceReady(result, animation)<br>方法，这里的target其实就是我们在into方法中建立的那个BitmapImageViewTarget，看到BitmapImageViewTarget类，我们并没有发现onResourceReady方法，但是我们从它的子类ImageViewTarget中发现了onResourceReady方法，从这里继续往下看。</p><h3 id="ImageViewTarget-onResourceReady"><a href="#ImageViewTarget-onResourceReady" class="headerlink" title="ImageViewTarget#onResourceReady"></a>ImageViewTarget#onResourceReady</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageViewTarget&lt;Z&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewTarget&lt;ImageView</span>, <span class="hljs-title">Z&gt;</span></span><br>implements <span class="hljs-type">Transition</span>.<span class="hljs-type">ViewAdapter</span> {<br><br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    public void onResourceReady(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Z</span> resource, <span class="hljs-meta">@Nullable</span>       <span class="hljs-type">Transition</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">Z</span>&gt; transition) {<br>      <span class="hljs-keyword">if</span> (transition == <span class="hljs-literal">null</span> || !transition.transition(resource, <span class="hljs-keyword">this</span>))   {<br>        <span class="hljs-comment">// 核心代码</span><br>        setResourceInternal(resource);<br>      } <span class="hljs-keyword">else</span> {<br>        maybeUpdateAnimatable(resource);<br>      }<br>    }<br> <br>    ...<br>    <br>    <span class="hljs-keyword">private</span> void setResourceInternal(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Z</span> resource) {<br>        <span class="hljs-comment">// Order matters here. Set the resource first to make sure that the         Drawable has a valid and</span><br>        <span class="hljs-comment">// non-null Callback before starting it.</span><br>        <span class="hljs-comment">// 核心代码</span><br>        setResource(resource);<br>        maybeUpdateAnimatable(resource);<br>    }<br>    <br>    <span class="hljs-comment">// 核心代码</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> void setResource(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Z</span> resource);<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里我们在回到BitmapImageViewTarget的setResource方法中，终于看到Bitmap被设置到了当前的imageView上了。</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BitmapImageViewTarget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ImageViewTarget&lt;Bitmap&gt;</span> </span>{<br><br>    ...<br>    <br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> void setResource(<span class="hljs-type">Bitmap</span> resource) {<br>      view.setImageBitmap(resource);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>到这里，我们的分析就结束了，从以上的分析可知，Glide将大部分的逻辑处理都放在了最后一个into方法中，里面经过了20多个分析步骤才将请求图片流、解码出图片，到最终设置到对应的imageView上。</p><h2 id="完整Glide加载流程图"><a href="#完整Glide加载流程图" class="headerlink" title="完整Glide加载流程图"></a>完整Glide加载流程图</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9da2924eeab4ef79249b5836fd916da~tplv-k3u1fbpfcp-zoom-1.image" alt="img"></p><blockquote><p>可以看到，Glide最核心的逻辑都聚集在into()方法中，它里面的设计精巧而复杂，这部分的源码分析非常耗时，但是，如果你真真正正地去一步步去深入其中，你也许在Android进阶之路上将会有顿悟的感觉。</p></blockquote><h1 id="GreenDao"><a href="#GreenDao" class="headerlink" title="GreenDao"></a>GreenDao</h1><h2 id="基本使用流程-2"><a href="#基本使用流程-2" class="headerlink" title="基本使用流程"></a>基本使用流程</h2><h3 id="导入GreenDao的代码生成插件和库"><a href="#导入GreenDao的代码生成插件和库" class="headerlink" title="导入GreenDao的代码生成插件和库"></a>导入GreenDao的代码生成插件和库</h3><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">// 项目下的build.gradle</span><br><span class="hljs-keyword">buildscript</span> {<br>    ...<br>    <span class="hljs-keyword">dependencies</span> {<br>        <span class="hljs-keyword">classpath</span> <span class="hljs-string">'com.android.tools.build:gradle:2.3.0'</span><br>        <span class="hljs-keyword">classpath</span> <span class="hljs-string">'org.greenrobot:greendao-gradle-plugin:3.2.1'</span> <br>    }<br>}<br><br><span class="hljs-comment">// app模块下的build.gradle</span><br>apply plugin: <span class="hljs-string">'com.android.application'</span><br>apply plugin: <span class="hljs-string">'org.greenrobot.greendao'</span><br><br>...<br><br><span class="hljs-keyword">dependencies</span> {<br>    ...<br>    <span class="hljs-keyword">compile</span> <span class="hljs-string">'org.greenrobot:greendao:3.2.0'</span> <br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="创建一个实体类，这里为HistoryData"><a href="#创建一个实体类，这里为HistoryData" class="headerlink" title="创建一个实体类，这里为HistoryData"></a>创建一个实体类，这里为HistoryData</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@Entity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryData</span> {<br><br>    <span class="hljs-meta">@Id(autoincrement = true)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;<br><br>    <span class="hljs-keyword">private</span> long date;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">data</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="选择ReBuild-Project，HistoryData会被自动添加Set-get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。"><a href="#选择ReBuild-Project，HistoryData会被自动添加Set-get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。" class="headerlink" title="选择ReBuild Project，HistoryData会被自动添加Set/get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。"></a>选择ReBuild Project，HistoryData会被自动添加Set/get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75ea30aea6034e939918d0da2b43c9d9~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@Entity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryData</span> {<br><br>    <span class="hljs-meta">@Id(autoincrement = true)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;<br><br>    <span class="hljs-keyword">private</span> long date;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">data</span>;<br><br>    <span class="hljs-meta">@Generated(hash = 1371145256)</span><br>    <span class="hljs-keyword">public</span> HistoryData(<span class="hljs-built_in">Long</span> id, long date, String <span class="hljs-keyword">data</span>) {<br>        <span class="hljs-keyword">this</span>.id = id;<br>        <span class="hljs-keyword">this</span>.date = date;<br>        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;<br>    }<br><br>    <span class="hljs-meta">@Generated(hash = 422767273)</span><br>    <span class="hljs-keyword">public</span> HistoryData() {<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Long</span> getId() {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.id;<br>    }<br><br>    <span class="hljs-keyword">public</span> void setId(<span class="hljs-built_in">Long</span> id) {<br>        <span class="hljs-keyword">this</span>.id = id;<br>    }<br><br>    <span class="hljs-keyword">public</span> long getDate() {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.date;<br>    }<br><br>    <span class="hljs-keyword">public</span> void setDate(long date) {<br>        <span class="hljs-keyword">this</span>.date = date;<br>    }<br><br>    <span class="hljs-keyword">public</span> String getData() {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> void setData(String <span class="hljs-keyword">data</span>) {<br>        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里点明一下这几个类的作用：</p><ul><li>DaoMaster：所有Dao类的主人，负责整个库的运行，内部的静态抽象子类DevOpenHelper继承并重写了Android的SqliteOpenHelper。</li><li>DaoSession：作为一个会话层的角色，用于生成相应的Dao对象、Dao对象的注册，操作Dao的具体对象。</li><li>xxDao（HistoryDataDao）：生成的Dao对象，用于进行具体的数据库操作。</li></ul><h3 id="获取并使用相应的Dao对象进行增删改查操作"><a href="#获取并使用相应的Dao对象进行增删改查操作" class="headerlink" title="获取并使用相应的Dao对象进行增删改查操作"></a>获取并使用相应的Dao对象进行增删改查操作</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">DaoMaster.DevOpenHelper devOpenHelper = <span class="hljs-keyword">new</span> DaoMaster.<span class="hljs-constructor">DevOpenHelper(<span class="hljs-params">this</span>, Constants.DB_NAME)</span>;<br>SQLiteDatabase database = devOpenHelper.get<span class="hljs-constructor">WritableDatabase()</span>;<br>DaoMaster daoMaster = <span class="hljs-keyword">new</span> <span class="hljs-constructor">DaoMaster(<span class="hljs-params">database</span>)</span>;<br>mDaoSession = daoMaster.<span class="hljs-keyword">new</span><span class="hljs-constructor">Session()</span>;<br>HistoryDataDao historyDataDao = daoSession.get<span class="hljs-constructor">HistoryDataDao()</span>;<br><br><span class="hljs-comment">// 省略创建historyData的代码</span><span class="hljs-operator"></span><br><span class="hljs-operator">...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator"></span><span class="hljs-comment">// 增</span><br>historyDataDao.insert(historyData);<br><br><span class="hljs-comment">// 删</span><br>historyDataDao.delete(historyData);<br><br><span class="hljs-comment">// 改</span><br>historyDataDao.update(historyData);<br><br><span class="hljs-comment">// 查</span><br>List&lt;HistoryData&gt; historyDataList = historyDataDao.load<span class="hljs-constructor">All()</span>;<br></code></pre></td></tr></tbody></table></figure><p>本节将会以上述使用流程来对GreenDao的源码进行逐步分析，最后会分析下GreenDao中一些优秀的特性，让大家对GreenDao的理解有更一步的加深。</p><h2 id="GreenDao使用流程分析"><a href="#GreenDao使用流程分析" class="headerlink" title="GreenDao使用流程分析"></a>GreenDao使用流程分析</h2><h3 id="创建数据库帮助类对象DaoMaster-DevOpenHelper"><a href="#创建数据库帮助类对象DaoMaster-DevOpenHelper" class="headerlink" title="创建数据库帮助类对象DaoMaster.DevOpenHelper"></a>创建数据库帮助类对象DaoMaster.DevOpenHelper</h3><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">DaoMaster.DevOpenHelper devOpenHelper = <span class="hljs-keyword">new</span> <span class="hljs-type">DaoMaster</span>.DevOpenHelper(<span class="hljs-built_in">this</span>, Constants.DB_NAME);<br></code></pre></td></tr></tbody></table></figure><p>创建GreenDao内部实现的数据库帮助类对象devOpenHelper，核心源码如下：</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DaoMaster</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDaoMaster</span> </span>{<br><br>    ...<br><br>    public static <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DatabaseOpenHelper</span> </span>{<br>    <br>    ...<br>    <br>         <span class="hljs-meta">@Override</span><br>        public void onCreate(<span class="hljs-type">Database</span> db) {<br>            <span class="hljs-type">Log</span>.i(<span class="hljs-string">"greenDAO"</span>, <span class="hljs-string">"Creating tables for schema version "</span> + <span class="hljs-type">SCHEMA_VERSION</span>);<br>            createAllTables(db, <span class="hljs-literal">false</span>);<br>        }<br>    }<br>    <br>    public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DevOpenHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OpenHelper</span> </span>{<br>    <br>        ...<br>        <br>        <span class="hljs-meta">@Override</span><br>        public void onUpgrade(<span class="hljs-type">Database</span> db, int oldVersion, int newVersion) {<br>            <span class="hljs-type">Log</span>.i(<span class="hljs-string">"greenDAO"</span>, <span class="hljs-string">"Upgrading schema from version "</span> + oldVersion + <span class="hljs-string">" to "</span> + newVersion + <span class="hljs-string">" by dropping all tables"</span>);<br>            dropAllTables(db, <span class="hljs-literal">true</span>);<br>            onCreate(db);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>DevOpenHelper自身实现了更新的逻辑，这里是弃置了所有的表，并且调用了OpenHelper实现的onCreate方法用于创建所有的表，其中DevOpenHelper继承于OpenHelper，而OpenHelper自身又继承于DatabaseOpenHelper，那么，这个DatabaseOpenHelper这个类的作用是什么呢？</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseOpenHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SQLiteOpenHelper</span> </span>{<br><br>    ...<br>    <br>    <span class="hljs-comment">// 关注点1</span><br>    public <span class="hljs-type">Database</span> getWritableDb() {<br>        <span class="hljs-keyword">return</span> wrap(getWritableDatabase());<br>    }<br>    <br>    public <span class="hljs-type">Database</span> getReadableDb() {<br>        <span class="hljs-keyword">return</span> wrap(getReadableDatabase());<br>    }   <br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">Database</span> wrap(<span class="hljs-type">SQLiteDatabase</span> sqLiteDatabase) {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">StandardDatabase</span>(sqLiteDatabase);<br>    }<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 关注点2</span><br>    public <span class="hljs-type">Database</span> getEncryptedWritableDb(<span class="hljs-type">String</span> password) {<br>        <span class="hljs-type">EncryptedHelper</span> encryptedHelper = checkEncryptedHelper();<br>        <span class="hljs-keyword">return</span> encryptedHelper.wrap(encryptedHelper.getWritableDatabase(password));<br>    }<br>    <br>    public <span class="hljs-type">Database</span> getEncryptedReadableDb(<span class="hljs-type">String</span> password) {<br>        <span class="hljs-type">EncryptedHelper</span> encryptedHelper = checkEncryptedHelper();<br>        <span class="hljs-keyword">return</span> encryptedHelper.wrap(encryptedHelper.getReadableDatabase(password));<br>    }<br>    <br>    ...<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EncryptedHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">net</span>.<span class="hljs-title">sqlcipher</span>.<span class="hljs-title">database</span>.<span class="hljs-title">SQLiteOpenHelper</span> </span>{<br>    <br>        ...<br>    <br>    <br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">Database</span> wrap(net.sqlcipher.database.<span class="hljs-type">SQLiteDatabase</span>     sqLiteDatabase) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">EncryptedDatabase</span>(sqLiteDatabase);<br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure><p>其实，DatabaseOpenHelper也是实现了SQLiteOpenHelper的一个帮助类，它内部可以获取到两种不同的数据库类型，一种是标准型的数据库*<br><em>StandardDatabase<strong>，另一种是加密型的数据库</strong>EncryptedDatabase*</em><br>，从以上源码可知，它们内部都通过wrap这样一个包装的方法，返回了对应的数据库类型，我们大致看一下StandardDatabase和EncryptedDatabase的内部实现。</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StandardDatabase</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Database</span> </span>{<br><br>    <span class="hljs-comment">// 这里的SQLiteDatabase是android.database.sqlite.SQLiteDatabase包下的</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SQLiteDatabase delegate;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StandardDatabase</span><span class="hljs-params">(SQLiteDatabase delegate)</span> </span>{<br>        <span class="hljs-keyword">this</span>.delegate = delegate;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function">Cursor <span class="hljs-title">rawQuery</span><span class="hljs-params">(String sql, String[] selectionArgs)</span> </span>{<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> delegate.<span class="hljs-title">rawQuery</span><span class="hljs-params">(sql, selectionArgs)</span></span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execSQL</span><span class="hljs-params">(String sql)</span> <span class="hljs-keyword">throws</span> SQLException </span>{<br>        delegate.execSQL(sql);<br>    }<br><br>    ...<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EncryptedDatabaseStatement</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">DatabaseStatement</span>     </span>{<br><br>    <span class="hljs-comment">// 这里的SQLiteStatement是net.sqlcipher.database.SQLiteStatement包下的</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SQLiteStatement delegate;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EncryptedDatabaseStatement</span><span class="hljs-params">(SQLiteStatement delegate)</span> </span>{<br>        <span class="hljs-keyword">this</span>.delegate = delegate;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>{<br>        delegate.execute();<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>StandardDatabase和EncryptedDatabase这两个类内部都使用了<strong>代理模式</strong><br>给相同的接口添加了不同的具体实现，StandardDatabase自然是使用的Android包下的SQLiteDatabase，而EncryptedDatabaseStatement为了实现加密数据库的功能，则使用了一个叫做<br><strong>sqlcipher</strong>的数据库加密三方库，*<br>*<br>如果你项目下的数据库需要保存比较重要的数据，则可以使用getEncryptedWritableDb方法来代替getdWritableDb方法对数据库进行加密，这样，我们之后的数据库操作则会以代理模式的形式间接地使用sqlcipher提供的API去操作数据库<br>**。</p><h3 id="创建DaoMaster对象"><a href="#创建DaoMaster对象" class="headerlink" title="创建DaoMaster对象"></a>创建DaoMaster对象</h3><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">SQLiteDatabase database <span class="hljs-operator">=</span> devOpenHelper.getWritableDatabase()<span class="hljs-comment">;</span><br>DaoMaster daoMaster <span class="hljs-operator">=</span> new DaoMaster(database)<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>首先，DaoMaster作为所有Dao对象的主人，它内部肯定是需要一个SQLiteDatabase对象的，因此，先由DaoMaster的帮助类对象devOpenHelper的getWritableDatabase方法得到一个标准的数据库类对象database，再由此创建一个DaoMaster对象。</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DaoMaster</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDaoMaster</span> </span>{<br><br>    ...<br><br>    public <span class="hljs-type">DaoMaster</span>(<span class="hljs-type">SQLiteDatabase</span> db) {<br>        <span class="hljs-keyword">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">StandardDatabase</span>(db));<br>    }<br><br>    public <span class="hljs-type">DaoMaster</span>(<span class="hljs-type">Database</span> db) {<br>        <span class="hljs-keyword">super</span>(db, <span class="hljs-type">SCHEMA_VERSION</span>);<br>        registerDaoClass(<span class="hljs-type">HistoryDataDao</span>.<span class="hljs-keyword">class</span>);<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在DaoMaster的构造方法中，它首先执行了super(db, SCHEMA_VERSION)方法，即它的父类AbstractDaoMaster的构造方法。</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AbstractDaoMaster</span> {<br><br>    ...<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractDaoMaster</span>(<span class="hljs-params">Database db, <span class="hljs-built_in">int</span> schemaVersion</span>)</span> {<br>        <span class="hljs-keyword">this</span>.db = db;<br>        <span class="hljs-keyword">this</span>.schemaVersion = schemaVersion;<br><br>        daoConfigMap = <span class="hljs-keyword">new</span> HashMap&lt;Class&lt;? <span class="hljs-function">extends <span class="hljs-title">AbstractDao</span>&lt;?, ?&gt;&gt;, DaoConfig&gt;()</span>;<br>    }<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerDaoClass</span>(<span class="hljs-params">Class&lt;? extends AbstractDao&lt;?, ?&gt;&gt; daoClass</span>)</span> {<br>        DaoConfig daoConfig = <span class="hljs-keyword">new</span> DaoConfig(db, daoClass);<br>        daoConfigMap.put(daoClass, daoConfig);<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在AbstractDaoMaster对象的构造方法中，除了记录当前的数据库对象db和版本schemaVersion之外，还创建了一个类型为*<br>*HashMap<code>&lt;Class&gt;</code>, DaoConfig&gt;()的daoConfigMap对象用于保存每一个DAO对应的数据配置对象DaoConfig，并且Daoconfig对象存储了对应的Dao对象所必需的数据<br>**。最后，在DaoMaster的构造方法中使用了registerDaoClass(HistoryDataDao.class)<br>方法将HistoryDataDao类对象进行了注册，实际上，就是为HistoryDataDao这个Dao对象创建了相应的DaoConfig对象并将它放入daoConfigMap对象中保存起来。</p><h3 id="创建DaoSession对象"><a href="#创建DaoSession对象" class="headerlink" title="创建DaoSession对象"></a>创建DaoSession对象</h3><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">mDaoSession</span> <span class="hljs-operator">=</span> daoMaster.newSession()<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>在DaoMaster对象中使用了newSession方法新建了一个DaoSession对象。</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> DaoSession <span class="hljs-keyword">new</span><span class="hljs-type">Session</span>() {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">DaoSession</span>(db, IdentityScopeType.Session, daoConfigMap);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在DaoSeesion的构造方法中，又做了哪些事情呢？</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DaoSession</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDaoSession</span> </span>{<br><br>    ...<br><br>    public <span class="hljs-type">DaoSession</span>(<span class="hljs-type">Database</span> db, <span class="hljs-type">IdentityScopeType</span> <span class="hljs-class"><span class="hljs-keyword">type</span>, <span class="hljs-title">Map&lt;Class&lt;?</span>     <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDao&lt;?</span>, <span class="hljs-title">?&gt;&gt;</span>, <span class="hljs-title">DaoConfig&gt;</span></span><br>            daoConfigMap) {<br>        <span class="hljs-keyword">super</span>(db);<br><br>        historyDataDaoConfig = daoConfigMap.get(<span class="hljs-type">HistoryDataDao</span>.<span class="hljs-keyword">class</span>).clone();<br>        historyDataDaoConfig.initIdentityScope(<span class="hljs-class"><span class="hljs-keyword">type</span>)</span>;<br><br>        historyDataDao = <span class="hljs-keyword">new</span> <span class="hljs-type">HistoryDataDao</span>(historyDataDaoConfig, <span class="hljs-keyword">this</span>);<br><br>        registerDao(<span class="hljs-type">HistoryData</span>.<span class="hljs-keyword">class</span>, historyDataDao);<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，调用了父类AbstractDaoSession的构造方法。</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractDaoSession</span> {<br><br>    ...<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractDaoSession</span><span class="hljs-params">(Database db)</span> </span>{<br>        <span class="hljs-keyword">this</span>.db = db;<br>        <span class="hljs-keyword">this</span>.entityToDao = <span class="hljs-keyword">new</span> HashMap&lt;Class&lt;?&gt;, AbstractDao&lt;?, ?&gt;&gt;();<br>    }<br>    <br>    <span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerDao</span><span class="hljs-params">(Class&lt;T&gt; entityClass, AbstractDao&lt;T, ?&gt; dao)</span> </span>{<br>        entityToDao.<span class="hljs-built_in">put</span>(entityClass, dao);<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在AbstractDaoSession构造方法里面<strong>创建了一个实体与Dao对象的映射集合</strong>。接下来，在DaoSession的构造方法中还做了2件事：</p><ol><li><p><strong>创建每一个Dao对应的DaoConfig对象</strong>，这里是historyDataDaoConfig，<strong>并且根据IdentityScopeType的类型初始化创建一个相应的IdentityScope<br><strong>，根据type的不同，它有两种类型，分别是</strong>IdentityScopeObject</strong>和<strong>IdentityScopeLong</strong><br>，它的作用是根据主键缓存对应的实体数据。当主键是数字类型的时候，如long/Long、int/Integer、short/Short、byte/Byte，则使用IdentityScopeLong缓存实体数据，当主键不是数字类型的时候，则使用IdentityScopeObject缓存实体数据。</p></li><li><p><strong>根据DaoSession对象和每一个Dao对应的DaoConfig对象，创建与之对应的historyDataDao对象</strong><br>，由于这个项目只创建了一个实体类HistoryData，因此这里只有一个Dao对象historyDataDao，然后就是注册Dao对象，其实就是将实体和对应的Dao对象放入entityToDao这个映射集合中保存起来了。</p></li></ol><h3 id="插入源码分析"><a href="#插入源码分析" class="headerlink" title="插入源码分析"></a>插入源码分析</h3><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">HistoryDataDao historyDataDao <span class="hljs-operator">=</span> daoSession.getHistoryDataDao()<span class="hljs-comment">;</span><br><br>// 增<br>historyDataDao.insert(historyData)<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>这里首先在会话层DaoSession中获取了我们要操作的Dao对象HistoryDataDao，然后插入了一个我们预先创建好的historyData实体对象。其中HistoryDataDao继承了AbstractDao&lt;<br>HistoryData, Long&gt; 。</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HistoryDataDao</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractDao&lt;HistoryData</span>, <span class="hljs-title">Long&gt;</span> </span>{<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>那么，这个AbstractDao是干什么的呢？</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public abstract <span class="hljs-keyword">class</span> AbstractDao&lt;T, K&gt; {<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    </span>public List&lt;T&gt; load<span class="hljs-constructor">All()</span> {<br>        Cursor cursor = db.raw<span class="hljs-constructor">Query(<span class="hljs-params">statements</span>.<span class="hljs-params">getSelectAll</span>()</span>, null);<br>        return load<span class="hljs-constructor">AllAndCloseCursor(<span class="hljs-params">cursor</span>)</span>;<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    </span>public long insert(T entity) {<br>        return execute<span class="hljs-constructor">Insert(<span class="hljs-params">entity</span>, <span class="hljs-params">statements</span>.<span class="hljs-params">getInsertStatement</span>()</span>,     <span class="hljs-literal">true</span>);<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    </span>public void delete(T entity) {<br>        <span class="hljs-keyword">assert</span><span class="hljs-constructor">SinglePk()</span>;<br>        K key = get<span class="hljs-constructor">KeyVerified(<span class="hljs-params">entity</span>)</span>;<br>        delete<span class="hljs-constructor">ByKey(<span class="hljs-params">key</span>)</span>;<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator"></span>}<br></code></pre></td></tr></tbody></table></figure><p>看到这里，根据程序员优秀的直觉，大家应该能猜到，AbstractDao是所有Dao对象的基类，它实现了实体数据的操作如增删改查。我们接着分析insert是如何实现的，在AbstractDao的insert方法中又调用了executeInsert这个方法。在这个方法中，第二个参里的statements是一个<br><strong>TableStatements</strong>对象，它是在AbstractDao初始化构造器时从DaoConfig对象中取出来的，是一个**根据指定的表格创建SQL语句的一个帮助类<br>**。使用statements.getInsertStatement()则是获取了一个插入的语句。而第三个参数则是判断是否是主键的标志。</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TableStatements</span> </span>{<br><br>    ...<br><br>    <span class="hljs-keyword">public</span> DatabaseStatement getInsertStatement() {<br>        <span class="hljs-keyword">if</span> (insertStatement == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">String</span> sql = SqlUtils.createSqlInsert(<span class="hljs-string">"INSERT INTO "</span>, tablename, allColumns);<br>            DatabaseStatement <span class="hljs-keyword">new</span><span class="hljs-type">InsertStatement</span> = db.compileStatement(sql);<br>            ...<br>        }<br>        <span class="hljs-keyword">return</span> insertStatement;<br>    }<br><br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在TableStatements的getInsertStatement方法中，主要做了两件事：</p><ol><li><p><strong>使用SqlUtils创建了插入的sql语句</strong>。</p></li><li><p><strong>根据不同的数据库类型（标准数据库或加密数据库）将sql语句编译成当前数据库对应的语句</strong>。</p></li></ol><p>我们继续往下分析executeInsert的执行流程。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> long execute<span class="hljs-constructor">Insert(T <span class="hljs-params">entity</span>, DatabaseStatement <span class="hljs-params">stmt</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">setKeyAndAttach</span>)</span> {<br>    long rowId;<br>    <span class="hljs-keyword">if</span> (db.is<span class="hljs-constructor">DbLockedByCurrentThread()</span>) {<br>        rowId = insert<span class="hljs-constructor">InsideTx(<span class="hljs-params">entity</span>, <span class="hljs-params">stmt</span>)</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        db.<span class="hljs-keyword">begin</span><span class="hljs-constructor">Transaction()</span>;<br>        <span class="hljs-keyword">try</span> {<br>            rowId = insert<span class="hljs-constructor">InsideTx(<span class="hljs-params">entity</span>, <span class="hljs-params">stmt</span>)</span>;<br>            db.set<span class="hljs-constructor">TransactionSuccessful()</span>;<br>        } finally {<br>            db.<span class="hljs-keyword">end</span><span class="hljs-constructor">Transaction()</span>;<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (setKeyAndAttach) {<br>        update<span class="hljs-constructor">KeyAfterInsertAndAttach(<span class="hljs-params">entity</span>, <span class="hljs-params">rowId</span>, <span class="hljs-params">true</span>)</span>;<br>    }<br>    return rowId;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里首先是判断数据库是否被当前线程锁定，如果是，则直接插入数据，否则为了避免死锁，则开启一个数据库事务，再进行插入数据的操作。最后如果设置了主键，则在插入数据之后更新主键的值并将对应的实体缓存到相应的identityScope中，这一块的代码流程如下所示：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">protected void update<span class="hljs-constructor">KeyAfterInsertAndAttach(T <span class="hljs-params">entity</span>, <span class="hljs-params">long</span> <span class="hljs-params">rowId</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">lock</span>)</span> {<br>    <span class="hljs-keyword">if</span> (rowId != -<span class="hljs-number">1</span>) {<br>        K key = update<span class="hljs-constructor">KeyAfterInsert(<span class="hljs-params">entity</span>, <span class="hljs-params">rowId</span>)</span>;<br>        attach<span class="hljs-constructor">Entity(<span class="hljs-params">key</span>, <span class="hljs-params">entity</span>, <span class="hljs-params">lock</span>)</span>;<br>    } <span class="hljs-keyword">else</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">       ...</span><br><span class="hljs-operator">    </span>}<br>}<br><br>protected final void attach<span class="hljs-constructor">Entity(K <span class="hljs-params">key</span>, T <span class="hljs-params">entity</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">lock</span>)</span> {<br>    attach<span class="hljs-constructor">Entity(<span class="hljs-params">entity</span>)</span>;<br>    <span class="hljs-keyword">if</span> (identityScope != null<span class="hljs-operator"> &amp;&amp; </span>key != null) {<br>        <span class="hljs-keyword">if</span> (lock) {<br>            identityScope.put(key, entity);<br>        } <span class="hljs-keyword">else</span> {<br>            identityScope.put<span class="hljs-constructor">NoLock(<span class="hljs-params">key</span>, <span class="hljs-params">entity</span>)</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>接着，我们还是继续追踪主线流程，在executeInsert这个方法中调用了insertInsideTx进行数据的插入。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> long insert<span class="hljs-constructor">InsideTx(T <span class="hljs-params">entity</span>, DatabaseStatement <span class="hljs-params">stmt</span>)</span> {<br>    synchronized (stmt) {<br>        <span class="hljs-keyword">if</span> (isStandardSQLite) {<br>            SQLiteStatement rawStmt = (SQLiteStatement) stmt.get<span class="hljs-constructor">RawStatement()</span>;<br>            bind<span class="hljs-constructor">Values(<span class="hljs-params">rawStmt</span>, <span class="hljs-params">entity</span>)</span>;<br>            return rawStmt.execute<span class="hljs-constructor">Insert()</span>;<br>        } <span class="hljs-keyword">else</span> {<br>            bind<span class="hljs-constructor">Values(<span class="hljs-params">stmt</span>, <span class="hljs-params">entity</span>)</span>;<br>            return stmt.execute<span class="hljs-constructor">Insert()</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>为了防止并发，这里使用了悲观锁保证了数据的一致性，在AbstractDao这个类中，大量使用了这种锁保证了它的线程安全性。接着，如果当前是标准数据库，则直接获取stmt这个DatabaseStatement类对应的原始语句进行实体字段属性的绑定和最后的执行插入操作。如果是加密数据库，则直接使用当前的加密数据库所属的插入语句进行实体字段属性的绑定和执行最后的插入操作。其中bindValues这个方法对应的实现类就是我们的HistoryDataDao类。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> HistoryDataDao extends AbstractDao&lt;HistoryData, Long&gt; {<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>@Override<br>    protected final void bind<span class="hljs-constructor">Values(DatabaseStatement <span class="hljs-params">stmt</span>, HistoryData     <span class="hljs-params">entity</span>)</span> {<br>        stmt.clear<span class="hljs-constructor">Bindings()</span>;<br><br>        Long id = entity.get<span class="hljs-constructor">Id()</span>;<br>        <span class="hljs-keyword">if</span> (id != null) {<br>            stmt.bind<span class="hljs-constructor">Long(1, <span class="hljs-params">id</span>)</span>;<br>        }<br>        stmt.bind<span class="hljs-constructor">Long(2, <span class="hljs-params">entity</span>.<span class="hljs-params">getDate</span>()</span>);<br><br>        String data = entity.get<span class="hljs-constructor">Data()</span>;<br>        <span class="hljs-keyword">if</span> (data != null) {<br>            stmt.bind<span class="hljs-constructor">String(3, <span class="hljs-params">data</span>)</span>;<br>        }<br>    }<br>    <br>    @Override<br>    protected final void bind<span class="hljs-constructor">Values(SQLiteStatement <span class="hljs-params">stmt</span>, HistoryData     <span class="hljs-params">entity</span>)</span> {<br>        stmt.clear<span class="hljs-constructor">Bindings()</span>;<br><br>        Long id = entity.get<span class="hljs-constructor">Id()</span>;<br>        <span class="hljs-keyword">if</span> (id != null) {<br>            stmt.bind<span class="hljs-constructor">Long(1, <span class="hljs-params">id</span>)</span>;<br>        }<br>        stmt.bind<span class="hljs-constructor">Long(2, <span class="hljs-params">entity</span>.<span class="hljs-params">getDate</span>()</span>);<br><br>        String data = entity.get<span class="hljs-constructor">Data()</span>;<br>        <span class="hljs-keyword">if</span> (data != null) {<br>            stmt.bind<span class="hljs-constructor">String(3, <span class="hljs-params">data</span>)</span>;<br>        }<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里对HistoryData的所有字段使用对应的数据库语句进行了绑定操作。这里最后再提及一下，*<br>*如果当前数据库是加密型时，则会使用最开始提及的DatabaseStatement的加密实现类EncryptedDatabaseStatement应用代理模式去使用sqlcipher这个加密型数据库的insert方法<br>**。</p><h3 id="查询源码分析"><a href="#查询源码分析" class="headerlink" title="查询源码分析"></a>查询源码分析</h3><p>经过对插入源码的分析，相信大家对GreenDao内部的机制已经有了一些自己的理解，由于删除和更新内部的流程比较简单，且与插入源码有异曲同工之妙，这里就不再赘述了。最后再分析下查询的源码，查询的流程调用链较长，所以将它的核心流程源码直接给出。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">List&lt;HistoryData&gt; historyDataList = historyDataDao.load<span class="hljs-constructor">All()</span>;<br><br>public List&lt;T&gt; load<span class="hljs-constructor">All()</span> {<br>    Cursor cursor = db.raw<span class="hljs-constructor">Query(<span class="hljs-params">statements</span>.<span class="hljs-params">getSelectAll</span>()</span>, null);<br>    return load<span class="hljs-constructor">AllAndCloseCursor(<span class="hljs-params">cursor</span>)</span>;<br>}<br><br>protected List&lt;T&gt; load<span class="hljs-constructor">AllAndCloseCursor(Cursor <span class="hljs-params">cursor</span>)</span> {<br>    <span class="hljs-keyword">try</span> {<br>        return load<span class="hljs-constructor">AllFromCursor(<span class="hljs-params">cursor</span>)</span>;<br>    } finally {<br>        cursor.close<span class="hljs-literal">()</span>;<br>    }<br>}<br><br>protected List&lt;T&gt; load<span class="hljs-constructor">AllFromCursor(Cursor <span class="hljs-params">cursor</span>)</span> {<br>    <span class="hljs-built_in">int</span> count = cursor.get<span class="hljs-constructor">Count()</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span>boolean useFastCursor = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (cursor instanceof CrossProcessCursor) {<br>        window = ((CrossProcessCursor) cursor).get<span class="hljs-constructor">Window()</span>;<br>        <span class="hljs-keyword">if</span> (window != null) {  <br>            <span class="hljs-keyword">if</span> (window.get<span class="hljs-constructor">NumRows()</span><span class="hljs-operator"> == </span>count) {<br>                cursor = <span class="hljs-keyword">new</span> <span class="hljs-constructor">FastCursor(<span class="hljs-params">window</span>)</span>;<br>                useFastCursor = <span class="hljs-literal">true</span>;<br>            } <span class="hljs-keyword">else</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">              ...</span><br><span class="hljs-operator">            </span>}<br>        }<br>    }<br><br>    <span class="hljs-keyword">if</span> (cursor.move<span class="hljs-constructor">ToFirst()</span>) {<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">        </span><span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">if</span> (!useFastCursor<span class="hljs-operator"> &amp;&amp; </span>window != null<span class="hljs-operator"> &amp;&amp; </span>identityScope != null) {<br>                load<span class="hljs-constructor">AllUnlockOnWindowBounds(<span class="hljs-params">cursor</span>, <span class="hljs-params">window</span>, <span class="hljs-params">list</span>)</span>;<br>            } <span class="hljs-keyword">else</span> {<br>                <span class="hljs-keyword">do</span> {<br>                    <span class="hljs-built_in">list</span>.add(load<span class="hljs-constructor">Current(<span class="hljs-params">cursor</span>, 0, <span class="hljs-params">false</span>)</span>);<br>                } <span class="hljs-keyword">while</span> (cursor.move<span class="hljs-constructor">ToNext()</span>);<br>            }<br>        } finally {<span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">        </span>}<br>    }<br>    return <span class="hljs-built_in">list</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>最终，loadAll方法将会调用到loadAllFromCursor这个方法，首先，如果<strong>当前的游标cursor是跨进程的cursor</strong><br>，并且cursor的行数没有偏差的话，则使用一个加快版的<strong>FastCursor</strong><br>对象进行游标遍历。接着，不管是执行loadAllUnlockOnWindowBounds这个方法还是直接加载当前的数据列表list.add(loadCurrent(<br>cursor, 0, false))，最后都会调用到这行list.add(loadCurrent(cursor, 0, false))代码，很明显，loadCurrent方法就是加载数据的方法。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">final protected T load<span class="hljs-constructor">Current(Cursor <span class="hljs-params">cursor</span>, <span class="hljs-params">int</span> <span class="hljs-params">offset</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">lock</span>)</span> {<br>    <span class="hljs-keyword">if</span> (identityScopeLong != null) {<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">        </span>T entity = lock ? identityScopeLong.get2(key) : identityScopeLong.get2<span class="hljs-constructor">NoLock(<span class="hljs-params">key</span>)</span>;<br>        <span class="hljs-keyword">if</span> (entity != null) {<br>            return entity;<br>        } <span class="hljs-keyword">else</span> {<br>            entity = read<span class="hljs-constructor">Entity(<span class="hljs-params">cursor</span>, <span class="hljs-params">offset</span>)</span>;<br>            attach<span class="hljs-constructor">Entity(<span class="hljs-params">entity</span>)</span>;<br>            <span class="hljs-keyword">if</span> (lock) {<br>                identityScopeLong.put2(key, entity);<br>            } <span class="hljs-keyword">else</span> {<br>                identityScopeLong.put2<span class="hljs-constructor">NoLock(<span class="hljs-params">key</span>, <span class="hljs-params">entity</span>)</span>;<br>            }<br>            return entity;<br>        }<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (identityScope != null) {<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">        </span>T entity = lock ? identityScope.get(key) : identityScope.get<span class="hljs-constructor">NoLock(<span class="hljs-params">key</span>)</span>;<br>        <span class="hljs-keyword">if</span> (entity != null) {<br>            return entity;<br>        } <span class="hljs-keyword">else</span> {<br>            entity = read<span class="hljs-constructor">Entity(<span class="hljs-params">cursor</span>, <span class="hljs-params">offset</span>)</span>;<br>            attach<span class="hljs-constructor">Entity(<span class="hljs-params">key</span>, <span class="hljs-params">entity</span>, <span class="hljs-params">lock</span>)</span>;<br>            return entity;<br>        }<br>    } <span class="hljs-keyword">else</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">        </span>T entity = read<span class="hljs-constructor">Entity(<span class="hljs-params">cursor</span>, <span class="hljs-params">offset</span>)</span>;<br>        attach<span class="hljs-constructor">Entity(<span class="hljs-params">entity</span>)</span>;<br>        return entity;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="loadCurrent方法内部的执行策略"><a href="#loadCurrent方法内部的执行策略" class="headerlink" title="loadCurrent方法内部的执行策略"></a>loadCurrent方法内部的执行策略</h4><ul><li></li><li><p>首先，如果有实体数据缓存identityScopeLong/identityScope，则先从缓存中取，如果缓存中没有，会使用该实体对应的Dao对象，这里的是HistoryDataDao，它在内部根据游标取出的数据新建了一个新的HistoryData实体对象返回。<br>**</p></li></ul><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">@Override<br><span class="hljs-built_in">public</span> HistoryData readEntity(<span class="hljs-keyword">Cursor</span> <span class="hljs-keyword">cursor</span>, <span class="hljs-type">int</span> <span class="hljs-keyword">offset</span>) {<br>    HistoryData entity = <span class="hljs-built_in">new</span> HistoryData( //<br>        <span class="hljs-keyword">cursor</span>.<span class="hljs-keyword">isNull</span>(<span class="hljs-keyword">offset</span> + <span class="hljs-number">0</span>) ? <span class="hljs-keyword">null</span> : <span class="hljs-keyword">cursor</span>.getLong(<span class="hljs-keyword">offset</span> + <span class="hljs-number">0</span>), // id<br>        <span class="hljs-keyword">cursor</span>.getLong(<span class="hljs-keyword">offset</span> + <span class="hljs-number">1</span>), // <span class="hljs-type">date</span><br>        <span class="hljs-keyword">cursor</span>.<span class="hljs-keyword">isNull</span>(<span class="hljs-keyword">offset</span> + <span class="hljs-number">2</span>) ? <span class="hljs-keyword">null</span> : <span class="hljs-keyword">cursor</span>.getString(<span class="hljs-keyword">offset</span> + <span class="hljs-number">2</span>) // data<br>    );<br>    <span class="hljs-keyword">return</span> entity;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li></li></ul><p>*最后，如果是非identityScopeLong缓存类型，即是属于identityScope的情况下，则还会在identityScope中将上面获得的数据进行缓存。如果没有实体数据缓存的话，则直接调用readEntity组装数据返回即可。<br>**</p><p>注意：对于GreenDao缓存的特性，可能会出现没有拿到最新数据的bug，因此，如果遇到这种情况，可以使用DaoSession的clear方法删除缓存。</p><h2 id="GreenDao是如何与ReactiveX结合？"><a href="#GreenDao是如何与ReactiveX结合？" class="headerlink" title="GreenDao是如何与ReactiveX结合？"></a>GreenDao是如何与ReactiveX结合？</h2><p>首先，看下与rx结合的使用流程：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">RxDao</span>&lt;<span class="hljs-title class_">HistoryData</span>, <span class="hljs-title class_">Long</span>&gt; xxDao = daoSession.<span class="hljs-title function_">getHistoryDataDao</span>().<span class="hljs-title function_">rx</span>();<br>xxDao.<span class="hljs-title function_">insert</span>(historyData)<br>        .<span class="hljs-title function_">observerOn</span>(<span class="hljs-title class_">AndroidSchedulers</span>.<span class="hljs-title function_">mainThread</span>())<br>        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Action1</span>&lt;<span class="hljs-title class_">HistoryData</span>&gt;() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">HistoryData entity</span>) {<br>                <span class="hljs-comment">// insert success</span><br>            }<br>        });<br></code></pre></td></tr></tbody></table></figure><p>在AbstractDao对象的.rx()方法中，创建了一个默认执行在io线程的rxDao对象。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Experimental</span><br><span class="hljs-keyword">public</span> <span class="hljs-title class_">RxDao</span>&lt;T, K&gt; <span class="hljs-title function_">rx</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">if</span> (rxDao == <span class="hljs-literal">null</span>) {<br>        rxDao = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RxDao</span>&lt;&gt;(<span class="hljs-variable language_">this</span>, <span class="hljs-title class_">Schedulers</span>.<span class="hljs-title function_">io</span>());<br>    }<br>    <span class="hljs-keyword">return</span> rxDao;<br>}<br></code></pre></td></tr></tbody></table></figure><p>接着分析rxDao的insert方法。</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Experimental</span><br><span class="hljs-keyword">public</span> Observable&lt;T&gt; insert(<span class="hljs-keyword">final</span> T entity) {<br>    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">wrap</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Callable&lt;T&gt;()</span> </span>{<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function">T <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>            dao.insert(entity);<br>            <span class="hljs-keyword">return</span> entity;<br>        }<br>    });<br>}<br></code></pre></td></tr></tbody></table></figure><p>起实质作用的就是这个wrap方法了，在这个方法里面主要是调用了RxUtils.fromCallable(callable)这个方法。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@Internal</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RxBase</span> {<br><br>    ...<br><br>    <span class="hljs-keyword">protected</span> &lt;R&gt; Observable&lt;R&gt; wrap(Callable&lt;R&gt; callable) {<br>        <span class="hljs-keyword">return</span> wrap(RxUtils.fromCallable(callable));<br>    }<br><br>    <span class="hljs-keyword">protected</span> &lt;R&gt; Observable&lt;R&gt; wrap(Observable&lt;R&gt; observable) {<br>        <span class="hljs-keyword">if</span> (scheduler != <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">return</span> observable.subscribeOn(scheduler);<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-keyword">return</span> observable;<br>        }<br>    }<br><br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在RxUtils的fromCallable这个方法内部，其实就是**使用defer这个延迟操作符来进行被观察者事件的发送，主要目的就是为了确保Observable被订阅后才执行<br>**。最后，如果调度器scheduler存在的话，将通过外部的wrap方法将执行环境调度到io线程。</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-meta">@Internal</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RxUtils</span> {<br><br>    <span class="hljs-meta">@Internal</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt; fromCallable(<span class="hljs-keyword">final</span> <span class="hljs-type">Callable</span>&lt;<span class="hljs-type">T</span>&gt; callable) {<br>        <span class="hljs-keyword">return</span> <span class="hljs-type">Observable</span>.defer(new <span class="hljs-type">Func0</span>&lt;<span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt;&gt;() {<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt; call() {<br>                <span class="hljs-type">T</span> result;<br>                <span class="hljs-keyword">try</span> {<br>                    result <span class="hljs-operator">=</span> callable.call();<br>                } <span class="hljs-keyword">catch</span> (<span class="hljs-type">Exception</span> e) {<br>                    <span class="hljs-keyword">return</span> <span class="hljs-type">Observable</span>.error(e);<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-type">Observable</span>.just(result);<br>            }<br>        });<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>在分析完GreenDao的核心源码之后发现，GreenDao作为最好的数据库框架之一，是有一定道理的。</p><p><strong>首先，它通过使用自身的插件配套相应的freemarker模板生成所需的静态代码，避免了反射等消耗性能的操作。</strong></p><p>**其次，它内部提供了实体数据的映射缓存机制，能够进一步加快查询速度。对于不同数据库对应的SQL语句，也使用了不同的DataBaseStatement实现类结合代理模式进行了封装，屏蔽了数据库操作等繁琐的细节。<br>**</p><p>**最后，它使用了sqlcipher提供了加密数据库的功能，在一定程度确保了安全性，同时，结合RxJava，我们便能更简洁地实现异步的数据库操作<br>**。</p></blockquote><h1 id="RxJava"><a href="#RxJava" class="headerlink" title="RxJava"></a>RxJava</h1><h2 id="RxJava到底是什么？"><a href="#RxJava到底是什么？" class="headerlink" title="RxJava到底是什么？"></a>RxJava到底是什么？</h2><p>RxJava是基于Java虚拟机上的响应式扩展库，它通过<strong>使用可观察的序列将异步和基于事件的程序组合起来</strong>。 与此同时，它*<br><em>扩展了观察者模式来支持数据/事件序列<strong>，并且添加了操作符，这些</strong>操作符允许你声明性地组合序列*</em><br>，同时抽象出要关注的问题：比如低级线程、同步、线程安全和并发数据结构等。</p><p>从RxJava的官方定义来看，我们如果要想真正地理解RxJava，就必须对它以下两个部分进行深入的分析：</p><ol><li><p><strong>订阅流程</strong></p></li><li><p><strong>线程切换</strong></p></li></ol><p>当然，RxJava操作符的源码也是很不错的学习资源，特别是FlatMap、Zip等操作符的源码，有很多可以借鉴的地方，但是它们内部的实现比较复杂。</p><h2 id="RxJava的订阅流程"><a href="#RxJava的订阅流程" class="headerlink" title="RxJava的订阅流程"></a>RxJava的订阅流程</h2><p>首先给出RxJava消息订阅的例子：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Observable</span>.<span class="hljs-title function_">create</span>(newObservableOnSubscribe&lt;<span class="hljs-title class_">String</span>&gt;() {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-title class_">ObservableEmitter</span>&lt;<span class="hljs-title class_">String</span>&gt;emitter) throws <span class="hljs-title class_">Exception</span> {<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"1"</span>);<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"2"</span>);<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"3"</span>);<br>        emitter.<span class="hljs-title function_">onComplete</span>();<br>    }<br>}).<span class="hljs-title function_">subscribe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;<span class="hljs-title class_">String</span>&gt;() {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onSubscribe</span>(<span class="hljs-params">Disposable d</span>) {<br>        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onSubscribe"</span>);<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onNext</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {<br>        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onNext : "</span> + s);<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">Throwable e</span>) {<br>        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onError : "</span> + e.<span class="hljs-title function_">toString</span>());<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onComplete</span>(<span class="hljs-params"></span>) {<br>        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onComplete"</span>);<br>    }<br>});<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里首先创建了一个被观察者，然后创建一个观察者订阅了这个被观察者，因此下面分两个部分对RxJava的订阅流程进行分析：</p><ol><li><p><strong>创建被观察者过程</strong></p></li><li><p><strong>订阅过程</strong></p></li></ol><h3 id="创建被观察者过程"><a href="#创建被观察者过程" class="headerlink" title="创建被观察者过程"></a>创建被观察者过程</h3><p>首先，上面使用了Observable类的create()方法创建了一个被观察者，看看里面做了什么。</p><h4 id="Observable-create"><a href="#Observable-create" class="headerlink" title="Observable#create()"></a>Observable#create()</h4><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">// 省略一些检测性的注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Observable&lt;T&gt; create(ObservableOnSubscribe&lt;T&gt; <span class="hljs-keyword">source</span>) {<br>    ObjectHelper.requireNonNull(<span class="hljs-keyword">source</span>, <span class="hljs-string">"source is null"</span>);<br>    <span class="hljs-keyword">return</span> RxJavaPlugins.onAssembly(<span class="hljs-keyword">new</span> ObservableCreate&lt;T&gt;(<span class="hljs-keyword">source</span>));<br>}<br></code></pre></td></tr></tbody></table></figure><p>在Observable的create()<br>里面实际上是创建了一个新的ObservableCreate对象，同时，把我们定义好的ObservableOnSubscribe对象传入了ObservableCreate对象中，最后调用了RxJavaPlugins.onAssembly()<br>方法。接下来看看这个ObservableCreate是干什么的。</p><h4 id="ObservableCreate"><a href="#ObservableCreate" class="headerlink" title="ObservableCreate"></a>ObservableCreate</h4><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObservableCreate&lt;T&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Observable&lt;T&gt;</span> </span>{<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ObservableOnSubscribe</span>&lt;<span class="hljs-type">T</span>&gt; source;<br><br>    public <span class="hljs-type">ObservableCreate</span>(<span class="hljs-type">ObservableOnSubscribe</span>&lt;<span class="hljs-type">T</span>&gt; source) {<br>        <span class="hljs-keyword">this</span>.source = source;<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里仅仅是把ObservableOnSubscribe这个对象保存在ObservableCreate中了。然后看看RxJavaPlugins.onAssembly()这个方法的处理。</p><h4 id="RxJavaPlugins-onAssembly"><a href="#RxJavaPlugins-onAssembly" class="headerlink" title="RxJavaPlugins#onAssembly()"></a>RxJavaPlugins#onAssembly()</h4><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt; onAssembly(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt; source) {<br><br>    <span class="hljs-comment">// 应用hook函数的一些处理，一般用到不到</span><br>    <span class="hljs-operator">...</span><br>    <span class="hljs-keyword">return</span> source;<br>}<br></code></pre></td></tr></tbody></table></figure><p>最终仅仅是把我们的ObservableCreate给返回了。</p><h4 id="创建被观察者过程小结"><a href="#创建被观察者过程小结" class="headerlink" title="创建被观察者过程小结"></a>创建被观察者过程小结</h4><p>从以上分析可知，Observable.create()方法仅仅是**先将我们自定义的ObservableOnSubscribe对象重新包装成了一个ObservableCreate对象<br>**。</p><h3 id="订阅过程"><a href="#订阅过程" class="headerlink" title="订阅过程"></a>订阅过程</h3><p>接着，看看Observable.subscribe()的订阅过程是如何实现的。</p><h4 id="Observable-subscribe"><a href="#Observable-subscribe" class="headerlink" title="Observable#subscribe()"></a>Observable#subscribe()</h4><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">subscribe</span><span class="hljs-params">(Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer)</span> </span>{<br>    ...<br>    <br>    <span class="hljs-comment">// 1</span><br>    observer = RxJavaPlugins.onSubscribe(<span class="hljs-keyword">this</span>,observer);<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 2</span><br>    subscribeActual(observer);<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，在Observable的subscribe()方法内部首先调用了RxJavaPlugins的onSubscribe()方法。</p><h4 id="RxJavaPlugins-onSubscribe"><a href="#RxJavaPlugins-onSubscribe" class="headerlink" title="RxJavaPlugins#onSubscribe()"></a>RxJavaPlugins#onSubscribe()</h4><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Observer</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">T</span>&gt; onSubscribe(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">T</span>&gt; source, <span class="hljs-meta">@NonNull</span> <span class="hljs-type">Observer</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">T</span>&gt; observer) {<br><br>    <span class="hljs-comment">// 应用hook函数的一些处理，一般用到不到</span><br>    <span class="hljs-operator">...</span><br>    <br>    <span class="hljs-keyword">return</span> observer;<br>}<br></code></pre></td></tr></tbody></table></figure><p>除去hook应用的逻辑，这里仅仅是将observer返回了。接着来分析下注释2处的subscribeActual()方法，</p><h4 id="Observable-subscribeActual"><a href="#Observable-subscribeActual" class="headerlink" title="Observable#subscribeActual()"></a>Observable#subscribeActual()</h4><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">subscribeActual</span><span class="hljs-params">(Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer)</span></span>;<br></code></pre></td></tr></tbody></table></figure><p>这是一个抽象的方法，很明显，它对应的具体实现类就是我们在第一步创建的ObservableCreate类，接下来看到ObservableCreate的subscribeActual()<br>方法。</p><h4 id="ObservableCreate-subscribeActual"><a href="#ObservableCreate-subscribeActual" class="headerlink" title="ObservableCreate#subscribeActual()"></a>ObservableCreate#subscribeActual()</h4><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Override<br>protected void subscribe<span class="hljs-constructor">Actual(Observer&lt;? <span class="hljs-params">super</span> T&gt; <span class="hljs-params">observer</span>)</span> {<br>    <span class="hljs-comment">// 1</span><br>    CreateEmitter&lt;T&gt; parent = <span class="hljs-keyword">new</span> CreateEmitter&lt;T&gt;(observer);<br>    <span class="hljs-comment">// 2</span><br>    observer.on<span class="hljs-constructor">Subscribe(<span class="hljs-params">parent</span>)</span>;<br><br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 3</span><br>        source.subscribe(parent);<br>    } catch (Throwable ex) {<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Exceptions</span>.</span></span>throw<span class="hljs-constructor">IfFatal(<span class="hljs-params">ex</span>)</span>;<br>        parent.on<span class="hljs-constructor">Error(<span class="hljs-params">ex</span>)</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，首先新创建了一个CreateEmitter对象，同时传入了我们自定义的observer对象进去。</p><h5 id="CreateEmitter"><a href="#CreateEmitter" class="headerlink" title="CreateEmitter"></a>CreateEmitter</h5><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">static <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">CreateEmitter</span>&lt;<span class="hljs-symbol">T</span>&gt;<br><span class="hljs-symbol">extends</span> <span class="hljs-symbol">AtomicReference</span>&lt;<span class="hljs-symbol">Disposable</span>&gt;<br><span class="hljs-symbol">implements</span> <span class="hljs-symbol">ObservableEmitter</span>&lt;<span class="hljs-symbol">T</span>&gt;, <span class="hljs-symbol">Disposable</span> {<br><br>    ...<br>    <br>    <span class="hljs-keyword">final</span> Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer;<br><br>    CreateEmitter(Observer&lt;? <span class="hljs-keyword">super</span> T&gt; observer) {<br>        <span class="hljs-keyword">this</span>.observer = observer;<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面可以看出，<strong>CreateEmitter通过继承了Java并发包中的原子引用类AtomicReference保证了事件流切断状态Dispose的一致性</strong><br>（这里不理解的话，看到后面讲解Dispose的时候就明白了），并<strong>实现了ObservableEmitter接口和Disposable接口</strong><br>，接着我们分析下注释2处的observer.onSubscribe(parent)，这个onSubscribe回调的含义其实就是**告诉观察者已经成功订阅了被观察者<br>**。再看到注释3处的source.subscribe(parent)<br>这行代码，这里的source其实是ObservableOnSubscribe对象，我们看到ObservableOnSubscribe的subscribe()方法。</p><h5 id="ObservableOnSubscribe-subscribe"><a href="#ObservableOnSubscribe-subscribe" class="headerlink" title="ObservableOnSubscribe#subscribe()"></a>ObservableOnSubscribe#subscribe()</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Observable</span> <span class="hljs-variable">observable</span> <span class="hljs-operator">=</span> Observable.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObservableOnSubscribe</span>&lt;String&gt;() {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">voidsubscribe</span><span class="hljs-params">(ObservableEmitter&lt;String&gt; emitter)</span> <span class="hljs-keyword">throws</span> Exception {<br>        emitter.onNext(<span class="hljs-string">"1"</span>);<br>        emitter.onNext(<span class="hljs-string">"2"</span>);<br>        emitter.onNext(<span class="hljs-string">"3"</span>);<br>        emitter.onComplete();<br>    }<br>});<br></code></pre></td></tr></tbody></table></figure><p>这里面使用到了ObservableEmitter的onNext()方法将事件流发送出去，最后调用了onComplete()<br>方法完成了订阅过程。ObservableEmitter是一个抽象类，实现类就是我们传入的CreateEmitter对象，接下来我们看看CreateEmitter的onNext()<br>方法和onComplete()方法的处理。</p><h5 id="CreateEmitter-onNext-CreateEmitter-onComplete"><a href="#CreateEmitter-onNext-CreateEmitter-onComplete" class="headerlink" title="CreateEmitter#onNext() &amp;&amp; CreateEmitter#onComplete()"></a>CreateEmitter#onNext() &amp;&amp; CreateEmitter#onComplete()</h5><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">static <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">CreateEmitter</span>&lt;<span class="hljs-symbol">T</span>&gt;<br><span class="hljs-symbol">extends</span> <span class="hljs-symbol">AtomicReference</span>&lt;<span class="hljs-symbol">Disposable</span>&gt;<br><span class="hljs-symbol">implements</span> <span class="hljs-symbol">ObservableEmitter</span>&lt;<span class="hljs-symbol">T</span>&gt;, <span class="hljs-symbol">Disposable</span> {<br><br>...<br><br>@Override<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> onNext(T t) {<br>    ...<br>    <br>    <span class="hljs-keyword">if</span> (!isDisposed()) {<br>        <span class="hljs-comment">//调用观察者的onNext()</span><br>        observer.onNext(t);<br>    }<br>}<br><br>@Override<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> onComplete() {<br>    <span class="hljs-keyword">if</span> (!isDisposed()) {<br>        <span class="hljs-keyword">try</span> {<br>            observer.onComplete();<br>        } finally {<br>            dispose();<br>        }<br>    }<br>}<br><br><br>...<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>在CreateEmitter的onNext和onComplete方法中首先都要经过一个<strong>isDisposed</strong>的判断，作用就是看**当前的事件流是否被切断（废弃）掉了<br>**，默认是不切断的，如果想要切断，可以调用Disposable的dispose()方法将此状态设置为切断（废弃）状态。继续看看这个isDisposed内部的处理。</p><h5 id="ObservableEmitter-isDisposed"><a href="#ObservableEmitter-isDisposed" class="headerlink" title="ObservableEmitter#isDisposed()"></a>ObservableEmitter#isDisposed()</h5><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDisposed</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">DisposableHelper</span>.<span class="hljs-title function_">isDisposed</span>(<span class="hljs-title function_">get</span>());<br>}<br></code></pre></td></tr></tbody></table></figure><p>注意到这里通过get()<br>方法首先从ObservableEmitter的AtomicReference中拿到了保存的Disposable状态。然后交给了DisposableHelper进行判断处理。接下来看看DisposableHelper的处理。</p><h5 id="DisposableHelper-isDisposed-DisposableHelper-set"><a href="#DisposableHelper-isDisposed-DisposableHelper-set" class="headerlink" title="DisposableHelper#isDisposed() &amp;&amp; DisposableHelper#set()"></a>DisposableHelper#isDisposed() &amp;&amp; DisposableHelper#set()</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DisposableHelper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Disposable</span> {<br><br>    DISPOSED;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDisposed</span><span class="hljs-params">(Disposable d)</span> {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-keyword">return</span> d == DISPOSED;<br>    }<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">set</span><span class="hljs-params">(AtomicReference&lt;Disposable&gt; field, Disposable d)</span> {<br>        <span class="hljs-keyword">for</span> (;;) {<br>            <span class="hljs-type">Disposable</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> field.get();<br>            <span class="hljs-keyword">if</span> (current == DISPOSED) {<br>                <span class="hljs-keyword">if</span> (d != <span class="hljs-literal">null</span>) {<br>                    d.dispose();<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            }<br>            <span class="hljs-comment">// 2</span><br>            <span class="hljs-keyword">if</span> (field.compareAndSet(current, d)) {<br>                <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span>) {<br>                    current.dispose();<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            }<br>        }<br>    }<br>    <br>    ...<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispose</span><span class="hljs-params">(AtomicReference&lt;Disposable&gt; field)</span> {<br>        <span class="hljs-type">Disposable</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> field.get();<br>        <span class="hljs-type">Disposable</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> DISPOSED;<br>        <span class="hljs-keyword">if</span> (current != d) {<br>            <span class="hljs-comment">// ...</span><br>            current = field.getAndSet(d);<br>            <span class="hljs-keyword">if</span> (current != d) {<br>                <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span>) {<br>                    current.dispose();<br>                }<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>DisposableHelper是一个枚举类，内部只有一个值即DISPOSED, 从上面的分析可知它就是用来<strong>标记事件流被切断（废弃）状态的</strong><br>。先看到注释2和注释3处的代码**field.compareAndSet(current, d)和field.getAndSet(d)<strong>，这里使用了*<br>*原子引用AtomicReference内部包装的<a href="https://www.jianshu.com/p/ab2c8fce878b">CAS</a>方法处理了标志Disposable的并发读写问题</strong><br>。最后看到注释3处，将我们传入的CreateEmitter这个原子引用类保存的Dispable状态和DisposableHelper内部的DISPOSED进行比较，如果相等，就证明数据流被切断了。为了更进一步理解Disposed的作用，再来看看CreateEmitter中剩余的关键方法。</p><h5 id="CreateEmitter-1"><a href="#CreateEmitter-1" class="headerlink" title="CreateEmitter"></a>CreateEmitter</h5><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onNext</span>(<span class="hljs-params">T t</span>) {<br>    ...<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDisposed</span>()) {<br>        observer.<span class="hljs-title function_">onNext</span>(t);<br>    }<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">Throwable t</span>) {<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">tryOnError</span>(t)) {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-title class_">RxJavaPlugins</span>.<span class="hljs-title function_">onError</span>(t);<br>    }<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">tryOnError</span>(<span class="hljs-params">Throwable t</span>) {<br>    ...<br>    <span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDisposed</span>()) {<br>        <span class="hljs-keyword">try</span> {<br>            observer.<span class="hljs-title function_">onError</span>(t);<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">// 4</span><br>            <span class="hljs-title function_">dispose</span>();<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onComplete</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-comment">// 5</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDisposed</span>()) {<br>        <span class="hljs-keyword">try</span> {<br>            observer.<span class="hljs-title function_">onComplete</span>();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">// 6</span><br>            <span class="hljs-title function_">dispose</span>();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1、3、5处，onNext()和onError()、onComplete()方法首先都会判断事件流是否被切断，如果事件流此时被切断了，那么onNext()<br>和onComplete()则会退出方法体，不做处理，**onError()则会执行到RxJavaPlugins.onError(t)这句代码，内部会直接抛出异常，导致崩溃<br>**。如果事件流没有被切断，那么在onError()和onComplete()内部最终会调用到注释4、6处的这句dispose()代码，将事件流进行切断，由此可知，<br><strong>onError()和onComplete()只能调用一个，如果先执行的是onComplete()，再调用onError()的话就会导致异常崩溃</strong>。</p><h2 id="RxJava的线程切换"><a href="#RxJava的线程切换" class="headerlink" title="RxJava的线程切换"></a>RxJava的线程切换</h2><p>首先给出RxJava线程切换的例子：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">Observable</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObservableOnSubscribe</span>&lt;<span class="hljs-title class_">String</span>&gt;() {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">voidsubscribe</span>(<span class="hljs-title class_">ObservableEmitter</span>&lt;<span class="hljs-title class_">String</span>&gt;emitter) throws <span class="hljs-title class_">Exception</span> {<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"1"</span>);<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"2"</span>);<br>        emitter.<span class="hljs-title function_">onNext</span>(<span class="hljs-string">"3"</span>);<br>        emitter.<span class="hljs-title function_">onComplete</span>();<br>    }<br>}) <br>    .<span class="hljs-title function_">subscribeOn</span>(<span class="hljs-title class_">Schedulers</span>.<span class="hljs-title function_">io</span>())<br>    .<span class="hljs-title function_">observeOn</span>(<span class="hljs-title class_">AndroidSchedulers</span>.<span class="hljs-title function_">mainThread</span>())<br>    .<span class="hljs-title function_">subscribe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;<span class="hljs-title class_">String</span>&gt;() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onSubscribe</span>(<span class="hljs-params">Disposable d</span>) {<br>            <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onSubscribe"</span>);<br>        }<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onNext</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {<br>            <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onNext : "</span> + s);<br>        }<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">Throwable e</span>) {<br>            <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onError : "</span> +e.<span class="hljs-title function_">toString</span>());<br>        }<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onComplete</span>(<span class="hljs-params"></span>) {<br>            <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"onComplete"</span>);<br>        }<br>});<br></code></pre></td></tr></tbody></table></figure><p>可以看到，RxJava的线程切换主要<strong>分为subscribeOn()和observeOn()方法</strong>，首先，来分析下subscribeOn()方法。</p><h3 id="subscribeOn-Schedulers-io"><a href="#subscribeOn-Schedulers-io" class="headerlink" title="subscribeOn(Schedulers.io())"></a>subscribeOn(Schedulers.io())</h3><p>在Schedulers.io()<br>方法中，我们需要先传入一个Scheduler调度类，这里是传入了一个调度到io子线程的调度类，我们看看这个Schedulers.io()<br>方法内部是怎么构造这个调度器的。</p><h3 id="Schedulers-io"><a href="#Schedulers-io" class="headerlink" title="Schedulers#io()"></a>Schedulers#io()</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Scheduler</span> IO;<br><br>...<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-built_in">Scheduler</span> <span class="hljs-title">io</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">return</span> RxJavaPlugins.<span class="hljs-built_in">onIoScheduler</span>(IO);<br>}<br><br><span class="hljs-type">static</span> {<br>    ...<br><br>    <span class="hljs-comment">// 2</span><br>    IO = RxJavaPlugins.<span class="hljs-built_in">initIoScheduler</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">IOTask</span>());<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOTask</span> implements Callable&lt;<span class="hljs-built_in">Scheduler</span>&gt; {<br>    @<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Scheduler</span> <span class="hljs-title">call</span><span class="hljs-params">()</span> throws Exception </span>{<br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-keyword">return</span> IoHolder.<span class="hljs-literal">DEFAULT</span>;<br>    }<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IoHolder</span> {<br>    <span class="hljs-comment">// 4</span><br>    <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Scheduler</span> <span class="hljs-literal">DEFAULT</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">IoScheduler</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><p>Schedulers这个类的代码很多，这里我只拿出有关Schedulers.io这个方法涉及的逻辑代码进行讲解。首先，在注释1处，同前面分析的订阅流程的处理一样，只是一个处理hook的逻辑，最终返回的还是传入的这个IO对象。再看到注释2处，<br><strong>在Schedulers的静态代码块中将IO对象进行了初始化，其实质就是新建了一个IOTask的静态内部类</strong><br>，在IOTask的call方法中，也就是注释3处，可以了解到使用了静态内部类的方式把创建的IOScheduler对象给返回出去了。绕了这么大圈子，*<br>*Schedulers.io方法其实质就是返回了一个IOScheduler对象**。</p><h3 id="Observable-subscribeOn"><a href="#Observable-subscribeOn" class="headerlink" title="Observable#subscribeOn()"></a>Observable#subscribeOn()</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Observable&lt;T&gt; <span class="hljs-title">subscribeOn</span><span class="hljs-params">(<span class="hljs-built_in">Scheduler</span> scheduler)</span> </span>{<br>    ...<br>    <br>    <span class="hljs-keyword">return</span> RxJavaPlugins.<span class="hljs-built_in">onAssembly</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ObservableSubscribeOn</span>&lt;T&gt;(<span class="hljs-keyword">this</span>, scheduler));<br>}<br></code></pre></td></tr></tbody></table></figure><p>在subscribeOn()方法里面，又将ObservableCreate包装成了一个ObservableSubscribeOn对象。我们关注到ObservableSubscribeOn类。</p><h3 id="ObservableSubscribeOn"><a href="#ObservableSubscribeOn" class="headerlink" title="ObservableSubscribeOn"></a>ObservableSubscribeOn</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObservableSubscribeOn&lt;T&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractObservableWithUpstream&lt;T</span>, <span class="hljs-title">T&gt;</span> </span>{<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Scheduler</span> scheduler;<br><br>    public <span class="hljs-type">ObservableSubscribeOn</span>(<span class="hljs-type">ObservableSource</span>&lt;<span class="hljs-type">T</span>&gt; source, <span class="hljs-type">Scheduler</span> scheduler) {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-keyword">super</span>(source);<br>        <span class="hljs-keyword">this</span>.scheduler = scheduler;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    public void subscribeActual(<span class="hljs-keyword">final</span> <span class="hljs-type">Observer</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">T</span>&gt; observer) {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">SubscribeOnObserver</span>&lt;<span class="hljs-type">T</span>&gt; parent = <span class="hljs-keyword">new</span> <span class="hljs-type">SubscribeOnObserver</span>&lt;<span class="hljs-type">T</span>&gt;(observer);<br>        <br>        <span class="hljs-comment">// 3</span><br>        observer.onSubscribe(parent);<br>        <br>        <span class="hljs-comment">// 4</span><br>        parent.setDisposable(scheduler.scheduleDirect(<span class="hljs-keyword">new</span> <span class="hljs-type">SubscribeTask</span>(parent)));<br>    }<br><br>...<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，将传进来的source和scheduler保存起来。接着，等到实际订阅的时候，就会执行到这个subscribeActual方法，在注释2处，将我们自定义的Observer包装成了一个SubscribeOnObserver对象。在注释3处，通知观察者订阅了被观察者。在注释4处，内部先创建了一个SubscribeTask对象，来看看它的实现。</p><h3 id="ObservableSubscribeOn-SubscribeTask"><a href="#ObservableSubscribeOn-SubscribeTask" class="headerlink" title="ObservableSubscribeOn#SubscribeTask"></a>ObservableSubscribeOn#SubscribeTask</h3><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">SubscribeTask</span> <span class="hljs-symbol">implements</span> <span class="hljs-symbol">Runnable</span> {<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SubscribeOnObserver&lt;T&gt; parent;<br><br>    SubscribeTask(SubscribeOnObserver&lt;T&gt; parent) {<br>        <span class="hljs-keyword">this</span>.parent = parent;<br>    }<br><br>    @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> run() {<br>        source.subscribe(parent);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>SubscribeTask是ObservableSubscribeOn的内部类，它实质上就是一个任务类，在它的run方法中会执行到source.subscribe(parent)<br>的订阅方法，<strong>这个source其实就是我们在ObservableSubscribeOn构造方法中传进来的ObservableCreate对象</strong><br>。接下来看看scheduler.scheduleDirect()内部的处理。</p><h3 id="Scheduler-scheduleDirect"><a href="#Scheduler-scheduleDirect" class="headerlink" title="Scheduler#scheduleDirect()"></a>Scheduler#scheduleDirect()</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Disposable schedule<span class="hljs-constructor">Direct(@NonNull Runnable <span class="hljs-params">run</span>)</span> {<br>    return schedule<span class="hljs-constructor">Direct(<span class="hljs-params">run</span>, 0L, TimeUnit.NANOSECONDS)</span>;<br>}<br><br>public Disposable schedule<span class="hljs-constructor">Direct(@NonNull Runnable <span class="hljs-params">run</span>, <span class="hljs-params">long</span> <span class="hljs-params">delay</span>, @NonNull TimeUnit <span class="hljs-params">unit</span>)</span> {<br><br>    <span class="hljs-comment">// 1</span><br>    final Worker w = create<span class="hljs-constructor">Worker()</span>;<br><br>    <span class="hljs-comment">// 2</span><br>    final Runnable decoratedRun = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RxJavaPlugins</span>.</span></span>on<span class="hljs-constructor">Schedule(<span class="hljs-params">run</span>)</span>;<br><br>    <span class="hljs-comment">// 3</span><br>    DisposeTask task = <span class="hljs-keyword">new</span> <span class="hljs-constructor">DisposeTask(<span class="hljs-params">decoratedRun</span>, <span class="hljs-params">w</span>)</span>;<br><br>    <span class="hljs-comment">// 4</span><br>    w.schedule(task, delay, <span class="hljs-built_in">unit</span>);<br><br>    return task;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里最后会执行到上面这个scheduleDirect()重载方法。首先，在注释1处，会调用createWorker()<br>方法创建一个工作者对象Worker，它是一个抽象类，这里的实现类就是IoScheduler，下面看看IoScheduler类的createWorker()方法。</p><h4 id="IOScheduler-createWorker"><a href="#IOScheduler-createWorker" class="headerlink" title="IOScheduler#createWorker()"></a>IOScheduler#createWorker()</h4><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">final</span> <span class="hljs-type">AtomicReference</span>&lt;<span class="hljs-type">CachedWorkerPool</span>&gt; pool;<br><br>...<br><br>public <span class="hljs-type">IoScheduler</span>(<span class="hljs-type">ThreadFactory</span> threadFactory) {<br>    <span class="hljs-keyword">this</span>.threadFactory = threadFactory;<br>    <span class="hljs-keyword">this</span>.pool = <span class="hljs-keyword">new</span> <span class="hljs-type">AtomicReference</span>&lt;<span class="hljs-type">CachedWorkerPool</span>&gt;(<span class="hljs-type">NONE</span>);<br>    start();<br>}<br><br>...<br><br><span class="hljs-meta">@Override</span><br>public <span class="hljs-type">Worker</span> createWorker() {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">EventLoopWorker</span>(pool.get());<br>}<br><br>static <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventLoopWorker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Scheduler</span>.<span class="hljs-title">Worker</span> </span>{<br>    ...<br><br>    <span class="hljs-type">EventLoopWorker</span>(<span class="hljs-type">CachedWorkerPool</span> pool) {<br>        <span class="hljs-keyword">this</span>.pool = pool;<br>        <span class="hljs-keyword">this</span>.tasks = <span class="hljs-keyword">new</span> <span class="hljs-type">CompositeDisposable</span>();<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">this</span>.threadWorker = pool.get();<br>    }<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处调用了pool.get()这个方法，<strong>pool是一个CachedWorkerPool类型的原子引用对象</strong>，它的作用就是**用于缓存工作者对象Worker的<br>**。然后，将得到的CachedWorkerPool传入新创建的EventLoopWorker对象中。重点关注一下注释2处，这里将CachedWorkerPool缓存的threadWorker对象保存起来了。</p><p>下面继续分析3.6处代码段的注释2处的代码，这里又是一个关于hook的封装处理，最终还是返回的当前的Runnable对象。在注释3处新建了一个切断任务DisposeTask将decoratedRun和w对象包装了起来。最后在注释4处调用了工作者的schedule()<br>方法。下面来分析下它内部的处理。</p><h4 id="IoScheduler-schedule"><a href="#IoScheduler-schedule" class="headerlink" title="IoScheduler#schedule()"></a>IoScheduler#schedule()</h4><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Override</span><br>public Disposable <span class="hljs-built_in">schedule</span>(<span class="hljs-variable">@NonNull</span> Runnableaction, long delayTime, <span class="hljs-variable">@NonNull</span> TimeUnit unit){<br>    ...<br>    <br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">threadWorker</span><span class="hljs-selector-class">.scheduleActual</span>(action,delayTime, unit, tasks);<br>}<br></code></pre></td></tr></tbody></table></figure><p>内部调用了threadWorker的scheduleActual()方法，实际上是调用到了父类NewThreadWorker的scheduleActual()<br>方法，继续看看NewThreadWorker的scheduleActual()方法中做的事情。</p><h4 id="NewThreadWorker-scheduleActual"><a href="#NewThreadWorker-scheduleActual" class="headerlink" title="NewThreadWorker#scheduleActual()"></a>NewThreadWorker#scheduleActual()</h4><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-constructor">NewThreadWorker(ThreadFactory <span class="hljs-params">threadFactory</span>)</span> {<br>    executor = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SchedulerPoolFactory</span>.</span></span>create(threadFactory);<br>}<br><br><br>@NonNull<br>public ScheduledRunnable schedule<span class="hljs-constructor">Actual(<span class="hljs-params">final</span> Runnable <span class="hljs-params">run</span>, <span class="hljs-params">long</span> <span class="hljs-params">delayTime</span>, @NonNull TimeUnit <span class="hljs-params">unit</span>, @Nullable DisposableContainer <span class="hljs-params">parent</span>)</span> {<br>    Runnable decoratedRun = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RxJavaPlugins</span>.</span></span>on<span class="hljs-constructor">Schedule(<span class="hljs-params">run</span>)</span>;<br><br>    <span class="hljs-comment">// 1</span><br>    ScheduledRunnable sr = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ScheduledRunnable(<span class="hljs-params">decoratedRun</span>, <span class="hljs-params">parent</span>)</span>;<br>    <br>   <br>    <span class="hljs-keyword">if</span> (parent != null) {<br>        <span class="hljs-keyword">if</span> (!parent.add(sr)) {<br>            return sr;<br>        }<br>    }<br><br>    Future&lt;?&gt; f;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">if</span> (delayTime &lt;= <span class="hljs-number">0</span>) {<br>            <span class="hljs-comment">// 3</span><br>            f = executor.submit((Callable&lt;Object&gt;)sr);<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// 4</span><br>            f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, <span class="hljs-built_in">unit</span>);<br>        }<br>        sr.set<span class="hljs-constructor">Future(<span class="hljs-params">f</span>)</span>;<br>    } catch (RejectedExecutionException ex) {<br>        <span class="hljs-keyword">if</span> (parent != null) {<br>            parent.remove(sr);<br>        }<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RxJavaPlugins</span>.</span></span>on<span class="hljs-constructor">Error(<span class="hljs-params">ex</span>)</span>;<br>    }<br><br>    return sr;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在NewThreadWorker的scheduleActual()方法的内部，在注释1处首先会新建一个ScheduledRunnable对象，将Runnable对象和parent包装起来了，</p><ul><li></li><li><p>这里parent是一个DisposableContainer对象，它实际的实现类是CompositeDisposable类，它是一个保存所有事件流是否被切断状态的容器，其内部的实现是使用了RxJava自己定义的一个简单的OpenHashSet类进行存储<br>**。最后注释2处，判断是否设置了延迟时间，如果设置了，则调用线程池的submit()方法立即进行线程切换，否则，调用schedule()<br>方法进行延时执行线程切换。</p></li></ul><h3 id="为什么多次执行subscribeOn-，只有第一次有效？"><a href="#为什么多次执行subscribeOn-，只有第一次有效？" class="headerlink" title="为什么多次执行subscribeOn()，只有第一次有效？"></a>为什么多次执行subscribeOn()，只有第一次有效？</h3><p>从上面的分析，可以很容易了解到**被观察者被订阅时是从最外面的一层（ObservableSubscribeOn）通知到里面的一层（ObservableOnSubscribe）<br>**，当连续执行了到多次subscribeOn()的时候，其实就是先执行倒数第一次的subscribeOn()方法，直到最后一次执行的subscribeOn()<br>方法，这样肯定会覆盖前面的线程切换。</p><h3 id="observeOn-AndroidSchedulers-mainThread"><a href="#observeOn-AndroidSchedulers-mainThread" class="headerlink" title="observeOn(AndroidSchedulers.mainThread())"></a>observeOn(AndroidSchedulers.mainThread())</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public final Observable&lt;T&gt; observe<span class="hljs-constructor">On(Scheduler <span class="hljs-params">scheduler</span>)</span> {<br>    return observe<span class="hljs-constructor">On(<span class="hljs-params">scheduler</span>, <span class="hljs-params">false</span>, <span class="hljs-params">bufferSize</span>()</span>);<br>}<br><br>public final Observable&lt;T&gt; observe<span class="hljs-constructor">On(Scheduler <span class="hljs-params">scheduler</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">delayError</span>, <span class="hljs-params">int</span> <span class="hljs-params">bufferSize</span>)</span> {<br>    ....<br>    <br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RxJavaPlugins</span>.</span></span>on<span class="hljs-constructor">Assembly(<span class="hljs-params">new</span> ObservableObserveOn&lt;T&gt;(<span class="hljs-params">this</span>, <span class="hljs-params">scheduler</span>, <span class="hljs-params">delayError</span>, <span class="hljs-params">bufferSize</span>)</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，observeOn()方法内部最终也是返回了一个ObservableObserveOn对象，直接来看看ObservableObserveOn的subscribeActual()<br>方法。</p><h3 id="ObservableObserveOn-subscribeActual"><a href="#ObservableObserveOn-subscribeActual" class="headerlink" title="ObservableObserveOn#subscribeActual()"></a>ObservableObserveOn#subscribeActual()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribeActual</span><span class="hljs-params">(Observer&lt;? <span class="hljs-built_in">super</span> T&gt; observer)</span> {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">if</span> (scheduler <span class="hljs-keyword">instanceof</span> TrampolineScheduler) {<br>        <span class="hljs-comment">// 2</span><br>        source.subscribe(observer);<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// 3</span><br>        Scheduler.<span class="hljs-type">Worker</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> scheduler.createWorker();<br>        <span class="hljs-comment">// 4</span><br>        source.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObserveOnObserver</span>&lt;T&gt;(observer, w, delayError, bufferSize));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，判断指定的调度器是不是TrampolineScheduler，这是一个不进行线程切换，立即执行当前代码的调度器。如果是，则会直接调用ObservableSubscribeOn的subscribe()<br>方法，如果不是，则会在注释3处创建一个工作者对象。然后，在注释4处创建一个新的ObserveOnObserver将SubscribeOnobserver对象包装起来，并传入ObservableSubscribeOn的subscribe()<br>方法进行订阅。接下来看看ObserveOnObserver类的重点方法。</p><h3 id="ObserveOnObserver"><a href="#ObserveOnObserver" class="headerlink" title="ObserveOnObserver"></a>ObserveOnObserver</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Override</span><br>public void <span class="hljs-built_in">onNext</span>(T t) {<br>    ...<br>    <span class="hljs-selector-tag">if</span> (sourceMode != QueueDisposable.ASYNC) {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-selector-tag">queue</span><span class="hljs-selector-class">.offer</span>(t);<br>    }<br>    <span class="hljs-selector-tag">schedule</span>();<br>}<br><br>@<span class="hljs-selector-tag">Override</span><br><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onError</span>(Throwable t) {<br>    ...<br>    <span class="hljs-selector-tag">schedule</span>();<br>}<br><br><span class="hljs-variable">@Override</span><br>public void <span class="hljs-built_in">onComplete</span>() {<br>    ...<br>    <span class="hljs-selector-tag">schedule</span>();<br>}<br><br></code></pre></td></tr></tbody></table></figure><p>去除非主线逻辑的代码，在ObserveOnObserver的onNext()和onError()、onComplete()方法中最后都会调用到schedule()<br>方法。接着看schedule()方法，其中<strong>onNext()还会把消息存放到队列中</strong>。</p><h3 id="ObserveOnObserver-schedule"><a href="#ObserveOnObserver-schedule" class="headerlink" title="ObserveOnObserver#schedule()"></a>ObserveOnObserver#schedule()</h3><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">schedule</span>()</span> {<br>    <span class="hljs-keyword">if</span> (getAndIncrement() == <span class="hljs-number">0</span>) {<br>        worker.schedule(<span class="hljs-keyword">this</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里使用了worker进行调度ObserveOnObserver这个实现了Runnable的任务。worker就是在AndroidSchedulers.mainThread()中创建的，内部其实就是<br><strong>使用Handler进行线程切换的</strong>，此处不再赘述了。接着看ObserveOnObserver的run()方法。</p><h3 id="ObserveOnObserver-run"><a href="#ObserveOnObserver-run" class="headerlink" title="ObserveOnObserver#run()"></a>ObserveOnObserver#run()</h3><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-keyword">@Override</span><br>public void run() {<br>    <span class="hljs-comment">// 1</span><br>    if (outputFused) {<br>        <span class="hljs-built_in">drainFused</span>();<br>    } else {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-built_in">drainNormal</span>();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处会<strong>先判断outputFused这个标志位，它表示事件流是否被融化掉，默认是false，所以，最后会执行到drainNormal()方法</strong><br>。接着看看drainNormal()方法内部的处理。</p><h3 id="ObserveOnObserver-drainNormal"><a href="#ObserveOnObserver-drainNormal" class="headerlink" title="ObserveOnObserver#drainNormal()"></a>ObserveOnObserver#drainNormal()</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">drainNormal</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-type">int</span> missed = <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-keyword">final</span> SimpleQueue&lt;T&gt; q = queue;<br>    <br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">final</span> Observer&lt;? super T&gt; a = downstream;<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 2</span><br>    v = q.<span class="hljs-built_in">poll</span>();<br>    <br>    ...<br>    <span class="hljs-comment">// 3</span><br>    a.<span class="hljs-built_in">onNext</span>(v);<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，这里的downstream实际上是从外面传进来的SubscribeOnObserver对象。在注释2处将队列中的消息取出来，接着在注释3处调用了SubscribeOnObserver的onNext方法。<br><strong>最终，会从我们包装类的最外层一直调用到最里面的我们自定义的Observer中的onNext()方法，所以，在observeOn()<br>方法下面的链式代码都会执行到它所指定的线程中，噢，原来如此</strong>。</p><blockquote><p>很多人使用RxJava也已经挺长时间了，但是一直没有去深入去了解过它的内部实现原理，<strong>如今细细品尝，的确是酣畅淋漓</strong>。</p></blockquote><h1 id="LeakCanary"><a href="#LeakCanary" class="headerlink" title="LeakCanary"></a>LeakCanary</h1><h2 id="原理概述"><a href="#原理概述" class="headerlink" title="原理概述"></a>原理概述</h2><p>查看Leakcanary官方的github仓库，最重要的便是对<strong>Leakcanary是如何起作用的</strong>（即原理）这一问题进行了阐述，把它翻译成了易于理解的文字，主要分为如下7个步骤：</p><ol><li><p>RefWatcher.watch()创建了一个KeyedWeakReference用于去观察对象。</p></li><li><p>然后，在后台线程中，它会检测引用是否被清除了，并且是否没有触发GC。</p></li><li><p>如果引用仍然没有被清除，那么它将会把堆栈信息保存在文件系统中的.hprof文件里。</p></li><li><p>HeapAnalyzerService被开启在一个独立的进程中，并且HeapAnalyzer使用了HAHA开源库解析了指定时刻的堆栈快照文件heap dump。</p></li><li><p>从heap dump中，HeapAnalyzer根据一个独特的引用key找到了KeyedWeakReference，并且定位了泄露的引用。</p></li><li><p>HeapAnalyzer为了确定是否有泄露，计算了到GC Roots的最短强引用路径，然后建立了导致泄露的链式引用。</p></li><li><p>这个结果被传回到app进程中的DisplayLeakService，然后一个泄露通知便展现出来了。</p></li></ol><p>官方的原理简单来解释就是这样的：**在一个Activity执行完onDestroy()<br>之后，将它放入WeakReference中，然后将这个WeakReference类型的Activity对象与ReferenceQueque关联。这时再从ReferenceQueque中查看是否有没有该对象，如果没有，执行gc，再次查看，还是没有的话则判断发生内存泄露了。最后用HAHA这个开源库去分析dump之后的heap内存。<br>**</p><h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>下面这段是Leakcanary官方仓库的示例代码：</p><p>首先在你项目app下的build.gradle中配置:</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">dependencies {<br>  debugImplementation <span class="hljs-string">'com.squareup.leakcanary:leakcanary-android:1.6.2'</span><br>  releaseImplementation   <span class="hljs-string">'com.squareup.leakcanary:leakcanary-android-no-op:1.6.2'</span><br>  <span class="hljs-regexp">//</span> 可选，如果你使用支持库的fragments的话<br>  debugImplementation   <span class="hljs-string">'com.squareup.leakcanary:leakcanary-support-fragment:1.6.2'</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>然后在你的Application中配置:</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WanAndroidApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Application</span> </span>{<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">RefWatcher</span> refWatcher;<br>    <br>    public static <span class="hljs-type">RefWatcher</span> getRefWatcher(<span class="hljs-type">Context</span> context) {<br>        <span class="hljs-type">WanAndroidApp</span> application = (<span class="hljs-type">WanAndroidApp</span>)     context.getApplicationContext();<br>        <span class="hljs-keyword">return</span> application.refWatcher;<br>    }<br><br>    <span class="hljs-meta">@Override</span> public void onCreate() {<br>      <span class="hljs-keyword">super</span>.onCreate();<br>      <span class="hljs-keyword">if</span> (<span class="hljs-type">LeakCanary</span>.isInAnalyzerProcess(<span class="hljs-keyword">this</span>)) {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-keyword">return</span>;<br>      }<br>      <span class="hljs-comment">// 2</span><br>      refWatcher = <span class="hljs-type">LeakCanary</span>.install(<span class="hljs-keyword">this</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，会首先判断当前进程是否是Leakcanary专门用于分析heap内存的而创建的那个进程，即HeapAnalyzerService所在的进程，如果是的话，则不进行Application中的初始化功能。如果是当前应用所处的主进程的话，则会执行注释2处的LeakCanary.install(<br>this)<br>进行LeakCanary的安装。只需这样简单的几行代码，我们就可以在应用中检测是否产生了内存泄露了。当然，这样使用只会检测Activity和标准Fragment是否发生内存泄漏，如果要检测V4包的Fragment在执行完onDestroy()<br>之后是否发生内存泄露的话，则需要在Fragment的onDestroy()方法中加上如下两行代码去监视当前的Fragment：</p><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">RefWatcher refWatcher <span class="hljs-operator">=</span> WanAndroidApp.getRefWatcher(_mActivity)<span class="hljs-comment">;</span><br>refWatcher.watch(this)<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>上面的<strong>RefWatcher其实就是一个引用观察者对象，是用于监测当前实例对象的引用状态的</strong><br>。从以上的分析可以了解到，核心代码就是LeakCanary.install(this)这行代码，接下来，就从这里出发将LeakCanary一步一步进行拆解。</p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="LeakCanary-install"><a href="#LeakCanary-install" class="headerlink" title="LeakCanary#install()"></a>LeakCanary#install()</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> @<span class="hljs-selector-tag">NonNull</span> <span class="hljs-selector-tag">RefWatcher</span> <span class="hljs-selector-tag">install</span>(<span class="hljs-variable">@NonNull</span> Application application) {<br>  <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">refWatcher</span>(application)<span class="hljs-selector-class">.listenerServiceClass</span>(DisplayLeakService.class)<br>      <span class="hljs-selector-class">.excludedRefs</span>(AndroidExcludedRefs.<span class="hljs-built_in">createAppDefaults</span>().<span class="hljs-built_in">build</span>())<br>      <span class="hljs-selector-class">.buildAndInstall</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><p>在install()方法中的处理，可以分解为如下四步：</p><ol><li><p><strong>refWatcher(application)</strong></p></li><li><p><strong>链式调用listenerServiceClass(DisplayLeakService.class)</strong></p></li><li><p><strong>链式调用excludedRefs(AndroidExcludedRefs.createAppDefaults().build())</strong></p></li><li><p><strong>链式调用buildAndInstall()</strong></p></li></ol><p>首先，我们来看下第一步，这里调用了LeakCanary类的refWatcher方法，如下所示：</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> @<span class="hljs-selector-tag">NonNull</span> <span class="hljs-selector-tag">AndroidRefWatcherBuilder</span> <span class="hljs-selector-tag">refWatcher</span>(<span class="hljs-variable">@NonNull</span> Context context) {<br>  <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">AndroidRefWatcherBuilder</span>(context);<br>}<br></code></pre></td></tr></tbody></table></figure><p>然后新建了一个AndroidRefWatcherBuilder对象，再看看AndroidRefWatcherBuilder这个类。</p><h3 id="AndroidRefWatcherBuilder"><a href="#AndroidRefWatcherBuilder" class="headerlink" title="AndroidRefWatcherBuilder"></a>AndroidRefWatcherBuilder</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">/** A {@link RefWatcherBuilder} with appropriate Android defaults. */</span><br>public <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AndroidRefWatcherBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RefWatcherBuilder&lt;AndroidRefWatcherBuilder&gt;</span> </span>{<br><br>...<br><br>    <span class="hljs-type">AndroidRefWatcherBuilder</span>(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Context</span> context) {<br>        <span class="hljs-keyword">this</span>.context = context.getApplicationContext();<br>    }<br><br>...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在AndroidRefWatcherBuilder的构造方法中仅仅是将外部传入的applicationContext对象保存起来了。*<br>*AndroidRefWatcherBuilder是一个适配Android平台的引用观察者构造器对象，它继承了RefWatcherBuilder，RefWatcherBuilder是一个负责建立引用观察者RefWatcher实例的基类构造器<br>**。继续看看RefWatcherBuilder这个类。</p><h3 id="RefWatcherBuilder"><a href="#RefWatcherBuilder" class="headerlink" title="RefWatcherBuilder"></a>RefWatcherBuilder</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefWatcherBuilder&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RefWatcherBuilder&lt;T&gt;&gt;</span> </span>{<br><br>    ...<br>    <br>    public <span class="hljs-type">RefWatcherBuilder</span>() {<br>        heapDumpBuilder = <span class="hljs-keyword">new</span> <span class="hljs-type">HeapDump</span>.<span class="hljs-type">Builder</span>();<br>    }<br><br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>在RefWatcher的基类构造器RefWatcherBuilder的构造方法中新建了一个HeapDump的构造器对象。其中<strong>HeapDump就是一个保存heap<br>dump信息的数据结构</strong>。</p><p>接着来分析下install()方法中的链式调用的listenerServiceClass(DisplayLeakService.class)这部分逻辑。</p><h3 id="AndroidRefWatcherBuilder-listenerServiceClass"><a href="#AndroidRefWatcherBuilder-listenerServiceClass" class="headerlink" title="AndroidRefWatcherBuilder#listenerServiceClass()"></a>AndroidRefWatcherBuilder#listenerServiceClass()</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">public</span> @<span class="hljs-selector-tag">NonNull</span> <span class="hljs-selector-tag">AndroidRefWatcherBuilder</span> <span class="hljs-selector-tag">listenerServiceClass</span>(<br>  <span class="hljs-variable">@NonNull</span> Class&lt;? extends AbstractAnalysisResultService&gt; listenerServiceClass) {<br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">heapDumpListener</span>(new <span class="hljs-built_in">ServiceHeapDumpListener</span>(context, listenerServiceClass));<br>}<br></code></pre></td></tr></tbody></table></figure><p>在这里，传入了一个DisplayLeakService的Class对象，它的作用是展示泄露分析的结果日志，然后会展示一个用于跳转到显示泄露界面DisplayLeakActivity的通知。在listenerServiceClass()<br>这个方法中新建了一个ServiceHeapDumpListener对象，下面看看它内部的操作。</p><h3 id="ServiceHeapDumpListener"><a href="#ServiceHeapDumpListener" class="headerlink" title="ServiceHeapDumpListener"></a>ServiceHeapDumpListener</h3><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceHeapDumpListener</span> <span class="hljs-title">implements</span> <span class="hljs-title">HeapDump</span>.<span class="hljs-title">Listener</span> {<br><br>    ...<br>    <br>    <span class="hljs-keyword">public</span> ServiceHeapDumpListener(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> Context context,<br>        <span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> Class&lt;? extends AbstractAnalysisResultService&gt; listenerServiceClass) {<br>      <span class="hljs-keyword">this</span>.listenerServiceClass = checkNotNull(listenerServiceClass, <span class="hljs-string">"listenerServiceClass"</span>);<br>      <span class="hljs-keyword">this</span>.context = checkNotNull(context, <span class="hljs-string">"context"</span>).getApplicationContext();<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到这里仅仅是在ServiceHeapDumpListener中保存了DisplayLeakService的Class对象和application对象。它的作用就是接收一个heap<br>dump去分析。</p><p>然后我们继续看install()方法链式调用.excludedRefs(AndroidExcludedRefs.createAppDefaults().build())<br>的这部分代码。先看AndroidExcludedRefs.createAppDefaults()。</p><h3 id="AndroidExcludedRefs-createAppDefaults"><a href="#AndroidExcludedRefs-createAppDefaults" class="headerlink" title="AndroidExcludedRefs#createAppDefaults()"></a>AndroidExcludedRefs#createAppDefaults()</h3><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> AndroidExcludedRefs {<br><br>    ...<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> @NonNull ExcludedRefs.<span class="hljs-function">Builder <span class="hljs-title">createAppDefaults</span>()</span> {<br>      <span class="hljs-keyword">return</span> createBuilder(EnumSet.allOf(AndroidExcludedRefs.<span class="hljs-keyword">class</span>));<br>    }<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> @NonNull ExcludedRefs.<span class="hljs-function">Builder <span class="hljs-title">createBuilder</span>(<span class="hljs-params">EnumSet&lt;AndroidExcludedRefs&gt; refs</span>)</span> {<br>      ExcludedRefs.Builder excluded = ExcludedRefs.builder();<br>      <span class="hljs-keyword">for</span> (AndroidExcludedRefs <span class="hljs-keyword">ref</span> : refs) {<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">ref</span>.applies) {<br>          <span class="hljs-keyword">ref</span>.<span class="hljs-keyword">add</span>(excluded);<br>          ((ExcludedRefs.BuilderWithParams) excluded).named(<span class="hljs-keyword">ref</span>.name());<br>        }<br>      }<br>      <span class="hljs-keyword">return</span> excluded;<br>    }<br>    <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>先来说下<strong>AndroidExcludedRefs</strong>这个类，它是一个enum类，它<strong>声明了Android SDK和厂商定制的SDK中存在的内存泄露的case</strong><br>，根据AndroidExcludedRefs这个类的类名就可看出这些case<strong>都会被Leakcanary的监测过滤掉</strong>。目前这个版本是有<strong>46种</strong>这样的*<br><em>case**被包含在内，后续可能会一直增加。然后EnumSet.allOf(AndroidExcludedRefs.class)<br>这个方法将会返回一个包含AndroidExcludedRefs元素类型的EnumSet。Enum是一个抽象类，在这里具体的实现类是</em><br><em>通用正规型的RegularEnumSet，如果Enum里面的元素个数大于64，则会使用存储大数据量的JumboEnumSet</em>*<br>。最后，在createBuilder这个方法里面构建了一个排除引用的建造器excluded，将各式各样的case分门别类地保存起来再返回出去。</p><p>最后看到链式调用的最后一步buildAndInstall()。</p><h3 id="AndroidRefWatcherBuilder-buildAndInstall"><a href="#AndroidRefWatcherBuilder-buildAndInstall" class="headerlink" title="AndroidRefWatcherBuilder#buildAndInstall()"></a>AndroidRefWatcherBuilder#buildAndInstall()</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> boolean watchActivities = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">private</span> boolean watchFragments = <span class="hljs-literal">true</span>;<br><br>public @NonNull RefWatcher build<span class="hljs-constructor">AndInstall()</span> {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LeakCanaryInternals</span>.</span></span>installedRefWatcher != null) {<br>      throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">UnsupportedOperationException(<span class="hljs-string">"buildAndInstall() should only be called once."</span>)</span>;<br>    }<br>    <br>    <span class="hljs-comment">// 2</span><br>    RefWatcher refWatcher = build<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">if</span> (refWatcher != DISABLED) {<br>      <span class="hljs-comment">// 3</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LeakCanaryInternals</span>.</span></span>set<span class="hljs-constructor">EnabledAsync(<span class="hljs-params">context</span>, DisplayLeakActivity.<span class="hljs-params">class</span>, <span class="hljs-params">true</span>)</span>;<br>      <span class="hljs-keyword">if</span> (watchActivities) {<br>        <span class="hljs-comment">// 4</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ActivityRefWatcher</span>.</span></span>install(context, refWatcher);<br>      }<br>      <span class="hljs-keyword">if</span> (watchFragments) {<br>        <span class="hljs-comment">// 5</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FragmentRefWatcher</span>.</span><span class="hljs-module"><span class="hljs-identifier">Helper</span>.</span></span>install(context, refWatcher);<br>      }<br>    }<br>    <span class="hljs-comment">// 6</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LeakCanaryInternals</span>.</span></span>installedRefWatcher = refWatcher;<br>    return refWatcher;<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，会判断LeakCanaryInternals.installedRefWatcher是否已经被赋值，如果被赋值了，则会抛出异常，警告<br>buildAndInstall()<br>这个方法应该仅仅只调用一次，在此方法结束时，即在注释6处，该LeakCanaryInternals.installedRefWatcher才会被赋值。再来看注释2处，调用了AndroidRefWatcherBuilder其基类RefWatcherBuilder的build()<br>方法，看看它是如何建造的。</p><h3 id="RefWatcherBuilder-build"><a href="#RefWatcherBuilder-build" class="headerlink" title="RefWatcherBuilder#build()"></a>RefWatcherBuilder#build()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> RefWatcher <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {<br>    <span class="hljs-keyword">if</span> (isDisabled()) {<br>      <span class="hljs-keyword">return</span> RefWatcher.DISABLED;<br>    }<br><br>    <span class="hljs-keyword">if</span> (heapDumpBuilder.excludedRefs == <span class="hljs-literal">null</span>) {<br>      heapDumpBuilder.excludedRefs(defaultExcludedRefs());<br>    }<br><br>    HeapDump.<span class="hljs-type">Listener</span> <span class="hljs-variable">heapDumpListener</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.heapDumpListener;<br>    <span class="hljs-keyword">if</span> (heapDumpListener == <span class="hljs-literal">null</span>) {<br>      heapDumpListener = defaultHeapDumpListener();<br>    }<br><br>    <span class="hljs-type">DebuggerControl</span> <span class="hljs-variable">debuggerControl</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.debuggerControl;<br>    <span class="hljs-keyword">if</span> (debuggerControl == <span class="hljs-literal">null</span>) {<br>      debuggerControl = defaultDebuggerControl();<br>    }<br><br>    <span class="hljs-type">HeapDumper</span> <span class="hljs-variable">heapDumper</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.heapDumper;<br>    <span class="hljs-keyword">if</span> (heapDumper == <span class="hljs-literal">null</span>) {<br>      heapDumper = defaultHeapDumper();<br>    }<br><br>    <span class="hljs-type">WatchExecutor</span> <span class="hljs-variable">watchExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.watchExecutor;<br>    <span class="hljs-keyword">if</span> (watchExecutor == <span class="hljs-literal">null</span>) {<br>      watchExecutor = defaultWatchExecutor();<br>    }<br><br>    <span class="hljs-type">GcTrigger</span> <span class="hljs-variable">gcTrigger</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.gcTrigger;<br>    <span class="hljs-keyword">if</span> (gcTrigger == <span class="hljs-literal">null</span>) {<br>      gcTrigger = defaultGcTrigger();<br>    }<br><br>    <span class="hljs-keyword">if</span> (heapDumpBuilder.reachabilityInspectorClasses == <span class="hljs-literal">null</span>) {<br>      heapDumpBuilder.reachabilityInspectorClasses(defa  <span class="hljs-title function_">ultReachabilityInspectorClasses</span><span class="hljs-params">()</span>);<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RefWatcher</span>(watchExecutor, debuggerControl, gcTrigger, heapDumper, heapDumpListener,<br>        heapDumpBuilder);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，<strong>RefWatcherBuilder包含了以下7个组成部分：</strong></p><ol><li><p><strong>excludedRefs : 记录可以被忽略的泄漏路径</strong>。</p></li><li><p>**heapDumpListener : 转储堆信息到hprof文件，并在解析完 hprof 文件后进行回调，最后通知 DisplayLeakService 弹出泄漏提醒<br>**。</p></li><li><p>debuggerControl : 判断是否处于调试模式，调试模式中不会进行内存泄漏检测。为什么呢？因为**在调试过程中可能会保留上一个引用从而导致错误信息上报<br>**。</p></li><li><p><strong>heapDumper : 堆信息转储者，负责dump 内存泄漏处的 heap 信息到 hprof 文件</strong>。</p></li><li><p><strong>watchExecutor : 线程控制器，在 onDestroy() 之后并且在主线程空闲时执行内存泄漏检测</strong>。</p></li><li><p><strong>gcTrigger : 用于 GC，watchExecutor 首次检测到可能的内存泄漏，会主动进行 GC，GC<br>之后会再检测一次，仍然泄漏的判定为内存泄漏，最后根据heapDump信息生成相应的泄漏引用链</strong>。</p></li><li><p><strong>reachabilityInspectorClasses : 用于要进行可达性检测的类列表。</strong></p></li></ol><p>最后，会使用建造者模式将这些组成部分构建成一个新的RefWatcher并将其返回。</p><p>继续看回到AndroidRefWatcherBuilder的注释3处的 LeakCanaryInternals.setEnabledAsync(context, DisplayLeakActivity.class,<br>true)这行代码。</p><h3 id="LeakCanaryInternals-setEnabledAsync"><a href="#LeakCanaryInternals-setEnabledAsync" class="headerlink" title="LeakCanaryInternals#setEnabledAsync()"></a>LeakCanaryInternals#setEnabledAsync()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEnabledAsync</span><span class="hljs-params">(Context context, <span class="hljs-keyword">final</span> Class&lt;?&gt; componentClass,</span><br><span class="hljs-params"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> enabled)</span> {<br>  <span class="hljs-keyword">final</span> <span class="hljs-type">Context</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> context.getApplicationContext();<br>  AsyncTask.THREAD_POOL_EXECUTOR.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>      setEnabledBlocking(appContext, componentClass, enabled);<br>    }<br>  });<br>}<br></code></pre></td></tr></tbody></table></figure><p>在这里直接使用了<strong>AsyncTask内部自带的THREAD_POOL_EXECUTOR线程池</strong>进行阻塞式地显示DisplayLeakActivity。</p><p>然后再继续看AndroidRefWatcherBuilder的注释4处的代码。</p><h3 id="ActivityRefWatcher-install"><a href="#ActivityRefWatcher-install" class="headerlink" title="ActivityRefWatcher#install()"></a>ActivityRefWatcher#install()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">install</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@NonNull</span> RefWatcher refWatcher)</span> {<br>    <span class="hljs-type">Application</span> <span class="hljs-variable">application</span> <span class="hljs-operator">=</span> (Application) context.getApplicationContext();<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-type">ActivityRefWatcher</span> <span class="hljs-variable">activityRefWatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityRefWatcher</span>(application, refWatcher);<br>    <br>    <span class="hljs-comment">// 2</span><br>    application.registerActivityLifecycleCallbacks(activityRefWatcher.lifecycleCallbacks);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，在注释1处创建一个自己的activityRefWatcher实例，并在注释2处调用了application的registerActivityLifecycleCallbacks()<br>方法，这样就能够监听activity对应的生命周期事件了。继续看看activityRefWatcher.lifecycleCallbacks里面的操作。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Application.<span class="hljs-type">ActivityLifecycleCallbacks</span> <span class="hljs-variable">lifecycleCallbacks</span> <span class="hljs-operator">=</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityLifecycleCallbacksAdapter</span>() {<br>      <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityDestroyed</span><span class="hljs-params">(Activity activity)</span> {<br>          refWatcher.watch(activity);<br>      }<br>};<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityLifecycleCallbacksAdapter</span><br><span class="hljs-keyword">implements</span> <span class="hljs-title class_">Application</span>.ActivityLifecycleCallbacks {<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>很明显，这里<strong>实现并重写了Application的ActivityLifecycleCallbacks的onActivityDestroyed()<br>方法，这样便能在所有Activity执行完onDestroyed()方法之后调用 refWatcher.watch(activity)这行代码进行内存泄漏的检测了</strong>。</p><p>再看到注释5处的FragmentRefWatcher.Helper.install(context, refWatcher)这行代码，</p><h3 id="FragmentRefWatcher-Helper-install"><a href="#FragmentRefWatcher-Helper-install" class="headerlink" title="FragmentRefWatcher.Helper#install()"></a>FragmentRefWatcher.Helper#install()</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FragmentRefWatcher</span> {<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">watchFragments</span><span class="hljs-params">(Activity activity)</span>;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Helper</span> {<br>    <br>      <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SUPPORT_FRAGMENT_REF_WATCHER_CLASS_NAME</span> <span class="hljs-operator">=</span><br>          <span class="hljs-string">"com.squareup.leakcanary.internal.SupportFragmentRefWatcher"</span>;<br>    <br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">install</span><span class="hljs-params">(Context context, RefWatcher refWatcher)</span> {<br>        List&lt;FragmentRefWatcher&gt; fragmentRefWatchers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-keyword">if</span> (SDK_INT &gt;= O) {<br>          fragmentRefWatchers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidOFragmentRefWatcher</span>(refWatcher));<br>        }<br>    <br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">try</span> {<br>          Class&lt;?&gt; fragmentRefWatcherClass = Class.forName(SUPPORT_FRAGMENT_REF_WATCHER_CLASS_NAME);<br>          Constructor&lt;?&gt; constructor =<br>              fragmentRefWatcherClass.getDeclaredConstructor(RefWatcher.class);<br>          <span class="hljs-type">FragmentRefWatcher</span> <span class="hljs-variable">supportFragmentRefWatcher</span>   <span class="hljs-operator">=</span><br>              (FragmentRefWatcher) constructor.newInstance(refWatcher);<br>          fragmentRefWatchers.add(supportFragmentRefWatcher);<br>        } <span class="hljs-keyword">catch</span> (Exception ignored) {<br>        }<br>    <br>        <span class="hljs-keyword">if</span> (fragmentRefWatchers.size() == <span class="hljs-number">0</span>) {<br>          <span class="hljs-keyword">return</span>;<br>        }<br>    <br>        <span class="hljs-type">Helper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>(fragmentRefWatchers);<br>    <br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-type">Application</span> <span class="hljs-variable">application</span> <span class="hljs-operator">=</span> (Application) context.getApplicationContext();<br>        application.registerActivityLifecycleCallbacks(helper.activityLifecycleCallbacks);<br>      }<br>      <br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里面的逻辑很简单，首先在注释1处将Android标准的Fragment的RefWatcher类，即AndroidOfFragmentRefWatcher添加到新创建的fragmentRefWatchers中。在注释2处</p><ul><li></li><li><p>使用反射将leakcanary-support-fragment包下面的SupportFragmentRefWatcher添加进来，如果你在app的build.gradle下没有添加下面这行引用的话，则会拿不到此类，即LeakCanary只会检测Activity和标准Fragment这两种情况<br>**。</p></li></ul><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">debugImplementation</span>   'com.squareup.leakcanary:leakcanary-support-fragment:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span>'<br></code></pre></td></tr></tbody></table></figure><p>继续看到注释3处helper.activityLifecycleCallbacks里面的代码。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Application.<span class="hljs-type">ActivityLifecycleCallbacks</span> <span class="hljs-variable">activityLifecycleCallbacks</span> <span class="hljs-operator">=</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityLifecycleCallbacksAdapter</span>() {<br>      <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityCreated</span><span class="hljs-params">(Activity activity, Bundle savedInstanceState)</span> {<br>        <span class="hljs-keyword">for</span> (FragmentRefWatcher watcher : fragmentRefWatchers) {<br>            watcher.watchFragments(activity);<br>        }<br>    }<br>};<br></code></pre></td></tr></tbody></table></figure><p>可以看到，在Activity执行完onActivityCreated()方法之后，会调用指定watcher的watchFragments()<br>方法，注意，这里的watcher可能有两种，但不管是哪一种，都会使用当前传入的activity获取到对应的FragmentManager/SupportFragmentManager对象，调用它的registerFragmentLifecycleCallbacks()<br>方法，在对应的onDestroyView()和onDestoryed()方法执行完后，分别使用refWatcher.watch(view)和refWatcher.watch(fragment)<br>进行内存泄漏的检测，代码如下所示。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onFragmentViewDestroyed</span>(<span class="hljs-params">FragmentManager fm, Fragment fragment</span>) {<br>    <span class="hljs-title class_">View</span> view = fragment.<span class="hljs-title function_">getView</span>();<br>    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {<br>        refWatcher.<span class="hljs-title function_">watch</span>(view);<br>    }<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onFragmentDestroyed</span>(<span class="hljs-params">FragmentManagerfm, Fragment fragment</span>) {<br>    refWatcher.<span class="hljs-title function_">watch</span>(fragment);<br>}<br></code></pre></td></tr></tbody></table></figure><p>注意，下面到真正关键的地方了，接下来分析refWatcher.watch()这行代码。</p><h3 id="RefWatcher-watch"><a href="#RefWatcher-watch" class="headerlink" title="RefWatcher#watch()"></a>RefWatcher#watch()</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void watch(Object watchedReference, String referenceName) {<br>    <span class="hljs-keyword">if</span> (this<span class="hljs-operator"> == </span>DISABLED) {<br>      return;<br>    }<br>    check<span class="hljs-constructor">NotNull(<span class="hljs-params">watchedReference</span>, <span class="hljs-string">"watchedReference"</span>)</span>;<br>    check<span class="hljs-constructor">NotNull(<span class="hljs-params">referenceName</span>, <span class="hljs-string">"referenceName"</span>)</span>;<br>    final long watchStartNanoTime = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>nano<span class="hljs-constructor">Time()</span>;<br>    <span class="hljs-comment">// 1</span><br>    String key = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UUID</span>.</span></span>random<span class="hljs-constructor">UUID()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>;<br>    <span class="hljs-comment">// 2</span><br>    retainedKeys.add(key);<br>    <span class="hljs-comment">// 3</span><br>    final KeyedWeakReference reference =<br>        <span class="hljs-keyword">new</span> <span class="hljs-constructor">KeyedWeakReference(<span class="hljs-params">watchedReference</span>, <span class="hljs-params">key</span>, <span class="hljs-params">referenceName</span>, <span class="hljs-params">queue</span>)</span>;<br><br>    <span class="hljs-comment">// 4</span><br>    ensure<span class="hljs-constructor">GoneAsync(<span class="hljs-params">watchStartNanoTime</span>, <span class="hljs-params">reference</span>)</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>注意到在注释1处<strong>使用随机的UUID保证了每个检测对象对应 key 的唯一性</strong><br>。在注释2处将生成的key添加到类型为CopyOnWriteArraySet的Set集合中。在注释3处新建了一个自定义的弱引用KeyedWeakReference，看看它内部的实现。</p><h3 id="KeyedWeakReference"><a href="#KeyedWeakReference" class="headerlink" title="KeyedWeakReference"></a>KeyedWeakReference</h3><figure class="highlight processing"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyedWeakReference</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">WeakReference</span>&lt;<span class="hljs-built_in">Object</span>&gt; {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> <span class="hljs-built_in">key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;<br>    <br>    <span class="hljs-title function_">KeyedWeakReference</span>(<span class="hljs-built_in">Object</span> referent, <span class="hljs-built_in">String</span> <span class="hljs-built_in">key</span>, <span class="hljs-built_in">String</span> name,<br>        ReferenceQueue&lt;<span class="hljs-built_in">Object</span>&gt; referenceQueue) {<br>      <span class="hljs-comment">// 1</span><br>      <span class="hljs-title function_">super</span>(<span class="hljs-title function_">checkNotNull</span>(referent, <span class="hljs-string">"referent"</span>), <span class="hljs-title function_">checkNotNull</span>(referenceQueue, <span class="hljs-string">"referenceQueue"</span>));<br>      <span class="hljs-variable">this</span>.<span class="hljs-property">key</span> = <span class="hljs-title function_">checkNotNull</span>(<span class="hljs-built_in">key</span>, <span class="hljs-string">"key"</span>);<br>      <span class="hljs-variable">this</span>.<span class="hljs-property">name</span> = <span class="hljs-title function_">checkNotNull</span>(name, <span class="hljs-string">"name"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，<strong>在KeyedWeakReference内部，使用了key和name标识了一个被检测的WeakReference对象</strong>。在注释1处，<strong>将弱引用和引用队列<br>ReferenceQueue 关联起来，如果弱引用reference持有的对象被GC回收，JVM就会把这个弱引用加入到与之关联的引用队列referenceQueue中。即<br>KeyedWeakReference 持有的 Activity 对象如果被GC回收，该对象就会加入到引用队列 referenceQueue 中</strong>。</p><p>接着回到RefWatcher.watch()里注释4处的ensureGoneAsync()方法。</p><h3 id="RefWatcher-ensureGoneAsync"><a href="#RefWatcher-ensureGoneAsync" class="headerlink" title="RefWatcher#ensureGoneAsync()"></a>RefWatcher#ensureGoneAsync()</h3><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ensureGoneAsync</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> watchStartNanoTime, <span class="hljs-keyword">final</span> KeyedWeakReference reference)</span> </span>{<br>    <span class="hljs-comment">// 1</span><br>    watchExecutor.execute(<span class="hljs-keyword">new</span> Retryable() {<br>        <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Retryable.<span class="hljs-function">Result <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>            <span class="hljs-comment">// 2</span><br>            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">ensureGone</span><span class="hljs-params">(reference watchStartNanoTime)</span></span>;<br>        }<br>    });<br>}<br></code></pre></td></tr></tbody></table></figure><p>在ensureGoneAsync()方法中，在注释1处使用 watchExecutor 执行了注释2处的 ensureGone 方法，watchExecutor 是<br>AndroidWatchExecutor 的实例。</p><p>下面看看watchExecutor内部的逻辑。</p><h3 id="AndroidWatchExecutor"><a href="#AndroidWatchExecutor" class="headerlink" title="AndroidWatchExecutor"></a>AndroidWatchExecutor</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public final <span class="hljs-keyword">class</span> AndroidWatchExecutor implements WatchExecutor {<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    </span>public <span class="hljs-constructor">AndroidWatchExecutor(<span class="hljs-params">long</span> <span class="hljs-params">initialDelayMillis</span>)</span>     {<br>      mainHandler = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Handler(Looper.<span class="hljs-params">getMainLooper</span>()</span>);<br>      HandlerThread handlerThread = <span class="hljs-keyword">new</span> <span class="hljs-constructor">HandlerThread(LEAK_CANARY_THREAD_NAME)</span>;<br>      handlerThread.start<span class="hljs-literal">()</span>;<br>      <span class="hljs-comment">// 1</span><br>      backgroundHandler = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Handler(<span class="hljs-params">handlerThread</span>.<span class="hljs-params">getLooper</span>()</span>);<br>      this.initialDelayMillis = initialDelayMillis;<br>      maxBackoffFactor = Long.MAX_VALUE<span class="hljs-operator"> / </span>initialDelayMillis;<br>    }<br>    <br>    @Override public void execute(@NonNull Retryable retryable) {<br>      <span class="hljs-comment">// 2</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>get<span class="hljs-constructor">MainLooper()</span>.get<span class="hljs-constructor">Thread()</span><span class="hljs-operator"> == </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>current<span class="hljs-constructor">Thread()</span>) {<br>        wait<span class="hljs-constructor">ForIdle(<span class="hljs-params">retryable</span>, 0)</span>;<br>      } <span class="hljs-keyword">else</span> {<br>        post<span class="hljs-constructor">WaitForIdle(<span class="hljs-params">retryable</span>, 0)</span>;<br>      }<br>    }<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处<strong>AndroidWatchExecutor的构造方法</strong>中，注意到这里<strong>使用HandlerThread的looper新建了一个backgroundHandler</strong><br>，后面会用到。在注释2处，会判断当前线程是否是主线程，如果是，则直接调用waitForIdle()方法，如果不是，则调用postWaitForIdle()<br>，来看看这个方法。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void post<span class="hljs-constructor">WaitForIdle(<span class="hljs-params">final</span> Retryable <span class="hljs-params">retryable</span>, <span class="hljs-params">final</span> <span class="hljs-params">int</span> <span class="hljs-params">failedAttempts</span>)</span> {<br>  mainHandler.post(<span class="hljs-keyword">new</span> <span class="hljs-constructor">Runnable()</span> {<br>    @Override public void run<span class="hljs-literal">()</span> {<br>      wait<span class="hljs-constructor">ForIdle(<span class="hljs-params">retryable</span>, <span class="hljs-params">failedAttempts</span>)</span>;<br>    }<br>  });<br>}<br></code></pre></td></tr></tbody></table></figure><p>很清晰，这里使用了在构造方法中用主线程looper构造的mainHandler进行post，那么waitForIdle()<br>最终也会在主线程执行。接着看看waitForIdle()的实现。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void wait<span class="hljs-constructor">ForIdle(<span class="hljs-params">final</span> Retryable <span class="hljs-params">retryable</span>,     <span class="hljs-params">final</span> <span class="hljs-params">int</span> <span class="hljs-params">failedAttempts</span>)</span> {<br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>my<span class="hljs-constructor">Queue()</span>.add<span class="hljs-constructor">IdleHandler(<span class="hljs-params">new</span> MessageQueue.IdleHandler()</span> {<br>    @Override public boolean queue<span class="hljs-constructor">Idle()</span> {<br>      post<span class="hljs-constructor">ToBackgroundWithDelay(<span class="hljs-params">retryable</span>, <span class="hljs-params">failedAttempts</span>)</span>;<br>      return <span class="hljs-literal">false</span>;<br>    }<br>  });<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里**MessageQueue.IdleHandler()回调方法的作用是当 looper 空闲的时候，会回调 queueIdle 方法，利用这个机制我们可以实现第三方库的延迟初始化<br>**，然后执行内部的postToBackgroundWithDelay()方法。接下来看看它的实现。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postToBackgroundWithDelay</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Retryable retryable, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> failedAttempts)</span> {<br>  <span class="hljs-type">long</span> <span class="hljs-variable">exponentialBackoffFactor</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) Math.min(Math.pow(<span class="hljs-number">2</span>, failedAttempts),     maxBackoffFactor);<br>  <span class="hljs-comment">// 1</span><br>  <span class="hljs-type">long</span> <span class="hljs-variable">delayMillis</span> <span class="hljs-operator">=</span> initialDelayMillis * exponentialBackoffFactor;<br>  <span class="hljs-comment">// 2</span><br>  backgroundHandler.postDelayed(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>      <span class="hljs-comment">// 3</span><br>      Retryable.<span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> retryable.run();<br>      <span class="hljs-comment">// 4</span><br>      <span class="hljs-keyword">if</span> (result == RETRY) {<br>        postWaitForIdle(retryable, failedAttempts +   <span class="hljs-number">1</span>);<br>      }<br>    }<br>  }, delayMillis);<br>}<br></code></pre></td></tr></tbody></table></figure><p>先看到注释4处，可以明白，postToBackgroundWithDelay()是一个递归方法，如果result<br>一直等于RETRY的话，则会一直执行postWaitForIdle()方法。在回到注释1处，这里initialDelayMillis 的默认值是<br>5s，因此delayMillis就是5s。在注释2处，使用了在构造方法中用HandlerThread的looper新建的backgroundHandler进行异步延时执行retryable的run()<br>方法。这个run()方法里执行的就是RefWatcher的ensureGoneAsync()方法中注释2处的ensureGone()这行代码，继续看它内部的逻辑。</p><h3 id="RefWatcher-ensureGone"><a href="#RefWatcher-ensureGone" class="headerlink" title="RefWatcher#ensureGone()"></a>RefWatcher#ensureGone()</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Retryable.Result ensure<span class="hljs-constructor">Gone(<span class="hljs-params">final</span> KeyedWeakReference <span class="hljs-params">reference</span>, <span class="hljs-params">final</span> <span class="hljs-params">long</span> <span class="hljs-params">watchStartNanoTime</span>)</span> {<br>    long gcStartNanoTime = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>nano<span class="hljs-constructor">Time()</span>;<br>    long watchDurationMs = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NANOSECONDS</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">Millis(<span class="hljs-params">gcStartNanoTime</span> -     <span class="hljs-params">watchStartNanoTime</span>)</span>;<br><br>    <span class="hljs-comment">// 1</span><br>    remove<span class="hljs-constructor">WeaklyReachableReferences()</span>;<br><br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">if</span> (debuggerControl.is<span class="hljs-constructor">DebuggerAttached()</span>) {<br>      <span class="hljs-comment">// The debugger can create false leaks.</span><br>      return RETRY;<br>    }<br>    <br>    <span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">if</span> (gone(reference)) {<br>      return DONE;<br>    }<br>    <br>    <span class="hljs-comment">// 4</span><br>    gcTrigger.run<span class="hljs-constructor">Gc()</span>;<br>    remove<span class="hljs-constructor">WeaklyReachableReferences()</span>;<br>    <br>    <span class="hljs-comment">// 5</span><br>    <span class="hljs-keyword">if</span> (!gone(reference)) {<br>      long startDumpHeap = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>nano<span class="hljs-constructor">Time()</span>;<br>      long gcDurationMs = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NANOSECONDS</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">Millis(<span class="hljs-params">startDumpHeap</span> - <span class="hljs-params">gcStartNanoTime</span>)</span>;<br><br>      File heapDumpFile = heapDumper.dump<span class="hljs-constructor">Heap()</span>;<br>      <span class="hljs-keyword">if</span> (heapDumpFile<span class="hljs-operator"> == </span>RETRY_LATER) {<br>        <span class="hljs-comment">// Could not dump the heap.</span><br>        return RETRY;<br>      }<br>      <br>      long heapDumpDurationMs = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NANOSECONDS</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">Millis(System.<span class="hljs-params">nanoTime</span>()</span> - startDumpHeap);<br><br>      HeapDump heapDump = heapDumpBuilder.heap<span class="hljs-constructor">DumpFile(<span class="hljs-params">heapDumpFile</span>)</span>.reference<span class="hljs-constructor">Key(<span class="hljs-params">reference</span>.<span class="hljs-params">key</span>)</span><br>          .reference<span class="hljs-constructor">Name(<span class="hljs-params">reference</span>.<span class="hljs-params">name</span>)</span><br>          .watch<span class="hljs-constructor">DurationMs(<span class="hljs-params">watchDurationMs</span>)</span><br>          .gc<span class="hljs-constructor">DurationMs(<span class="hljs-params">gcDurationMs</span>)</span><br>          .heap<span class="hljs-constructor">DumpDurationMs(<span class="hljs-params">heapDumpDurationMs</span>)</span><br>          .build<span class="hljs-literal">()</span>;<br><br>      heapdumpListener.analyze(heapDump);<br>    }<br>    return DONE;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，执行了removeWeaklyReachableReferences()这个方法，接下来分析下它的含义。</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeWeaklyReachableReferences</span>()</span> {<br>    KeyedWeakReference <span class="hljs-keyword">ref</span>;<br>    <span class="hljs-keyword">while</span> ((<span class="hljs-keyword">ref</span> = (KeyedWeakReference) queue.poll()) != <span class="hljs-literal">null</span>) {<br>        retainedKeys.<span class="hljs-keyword">remove</span>(<span class="hljs-keyword">ref</span>.key);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里使用了while循环遍历 ReferenceQueue ，并从 retainedKeys中移除对应的Reference。</p><p>再看到注释2处，<strong>当Android设备处于debug状态时，会直接返回RETRY进行延时重试检测的操作</strong>。在注释3处，看看gone(reference)<br>这个方法的逻辑。</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span>ean gone(KeyedWeakReference <span class="hljs-built_in">ref</span>erence) {<br>    <span class="hljs-keyword">return</span> !retainedKeys.contains(<span class="hljs-built_in">ref</span>erence.key);<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里会**判断 retainedKeys 集合中是否还含有 reference，若没有，证明已经被回收了，若含有，可能已经发生内存泄露（或Gc还没有执行回收）<br>**。前面的分析中我们知道了 <strong>reference 被回收的时候，会被加进 referenceQueue<br>里面，然后我们会调用removeWeaklyReachableReferences()遍历 referenceQueue 移除掉 retainedKeys 里面的 refrence</strong>。</p><p>接着看到注释4处，执行了gcTrigger的runGc()方法进行垃圾回收，然后使用了removeWeaklyReachableReferences()<br>方法移除已经被回收的引用。这里再深入地分析下runGc()的实现。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">GcTrigger DEFAULT = <span class="hljs-keyword">new</span> <span class="hljs-constructor">GcTrigger()</span> {<br>    @Override public void run<span class="hljs-constructor">Gc()</span> {<br>      <span class="hljs-comment">// Code taken from AOSP FinalizationTest:</span><br>      <span class="hljs-comment">// https://android.googlesource.com/platform/libc  ore/+/master/support/src/test/java/libcore/</span><br>      <span class="hljs-comment">// java/lang/ref/FinalizationTester.java</span><br>      <span class="hljs-comment">// System.gc() does not garbage collect every   time. Runtime.gc() is</span><br>      <span class="hljs-comment">// more likely to perform a gc.</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.gc<span class="hljs-literal">()</span>;<br>      enqueue<span class="hljs-constructor">References()</span>;<br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>run<span class="hljs-constructor">Finalization()</span>;<br>    }<br><br>    <span class="hljs-keyword">private</span> void enqueue<span class="hljs-constructor">References()</span> {<br>      <span class="hljs-comment">// Hack. We don't have a programmatic way to wait   for the reference queue daemon to move</span><br>      <span class="hljs-comment">// references to the appropriate queues.</span><br>      <span class="hljs-keyword">try</span> {<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>sleep(<span class="hljs-number">100</span>);<br>      } catch (InterruptedException e) {<br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">AssertionError()</span>;<br>      }<br>    }<br>};<br></code></pre></td></tr></tbody></table></figure><p>这里并没有使用System.gc()方法进行回收，因为<strong>system.gc()并不会每次都执行</strong>。而是*<br>*从AOSP中拷贝一段GC回收的代码，从而相比System.gc()更能够保证垃圾回收的工作**。</p><p>最后分析下注释5处的代码处理。首先会判断activity是否被回收，如果还没有被回收，则证明发生内存泄露，进行if判断里面的操作。在里面先调用堆信息转储者heapDumper的dumpHeap()<br>生成相应的 hprof<br>文件。这里的heapDumper是一个HeapDumper接口，具体的实现是AndroidHeapDumper。我们分析下AndroidHeapDumper的dumpHeap()<br>方法是如何生成hprof文件的。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">public</span> File dumpHeap() {<br>    File heapDumpFile = leakDirectoryProvider.newHeapDumpFile();<br><br>    <span class="hljs-keyword">if</span> (heapDumpFile == RETRY_LATER) {<br>        <span class="hljs-keyword">return</span> RETRY_LATER;<br>    }<br><br>    ...<br>    <br>    <span class="hljs-keyword">try</span> {<br>      Debug.dumpHprofData(heapDumpFile.getAbsolutePath());<br>      ...<br>      <br>      <span class="hljs-keyword">return</span> heapDumpFile;<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>      ...<br>      <span class="hljs-comment">// Abort heap dump</span><br>      <span class="hljs-keyword">return</span> RETRY_LATER;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里的核心操作就是<strong>调用了Android SDK的API Debug.dumpHprofData() 来生成 hprof 文件</strong>。</p><p>如果这个文件等于RETRY_LATER则表示生成失败，直接返回RETRY进行延时重试检测的操作。如果不等于的话，则表示生成成功，最后会*<br><em>执行heapdumpListener的analyze()对新创建的HeapDump对象进行泄漏分析</em>*<br>。由前面对AndroidRefWatcherBuilder的listenerServiceClass()的分析可知，heapdumpListener的实现<br>就是ServiceHeapDumpListener，接着看到ServiceHeapDumpListener的analyze方法。</p><h3 id="ServiceHeapDumpListener-analyze"><a href="#ServiceHeapDumpListener-analyze" class="headerlink" title="ServiceHeapDumpListener#analyze()"></a>ServiceHeapDumpListener#analyze()</h3><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Override</span> public void <span class="hljs-built_in">analyze</span>(<span class="hljs-variable">@NonNull</span> HeapDump heapDump) {<br>    <span class="hljs-selector-tag">checkNotNull</span>(heapDump, <span class="hljs-string">"heapDump"</span>);<br>    <span class="hljs-selector-tag">HeapAnalyzerService</span><span class="hljs-selector-class">.runAnalysis</span>(context, heapDump, listenerServiceClass);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里**执行了HeapAnalyzerService的runAnalysis()方法，为了避免降低app进程的性能或占用内存，这里将HeapAnalyzerService设置在了一个独立的进程中<br>**。接着继续分析runAnalysis()方法里面的处理。</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeapAnalyzerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ForegroundService</span></span><br>implements <span class="hljs-type">AnalyzerProgressListener</span> {<br><br>    ...<br><br>    public static void runAnalysis(<span class="hljs-type">Context</span> context, <span class="hljs-type">HeapDump</span> heapDump,<br>    <span class="hljs-type">Class</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-type">AbstractAnalysisResultService</span>&gt; listenerServiceClass) {<br>        ...<br>        <br>        <span class="hljs-type">ContextCompat</span>.startForegroundService(context, intent);<br>    }<br><br>    ...<br>    <br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">protected</span> void onHandleIntentInForeground(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent) {<br>        ...<br><br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-type">HeapAnalyzer</span> heapAnalyzer =<br>            <span class="hljs-keyword">new</span> <span class="hljs-type">HeapAnalyzer</span>(heapDump.excludedRefs, <span class="hljs-keyword">this</span>, heapDump.reachabilityInspectorClasses);<br><br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-type">AnalysisResult</span> result = heapAnalyzer.checkForLeak(heapDump.heapDumpFile, heapDump.referenceKey,<br>        heapDump.computeRetainedHeapSize);<br>        <br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-type">AbstractAnalysisResultService</span>.sendResultToListener(<span class="hljs-keyword">this</span>, listenerClassName, heapDump, result);<br>    }<br>        ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里的HeapAnalyzerService实质是一个类型为IntentService的ForegroundService，执行startForegroundService()<br>之后，会回调onHandleIntentInForeground()方法。注释1处，首先会新建一个<strong>HeapAnalyzer</strong>对象，顾名思义，它就是*<br>*根据RefWatcher生成的heap dumps信息来分析被怀疑的泄漏是否是真的<strong>。在注释2处，然后会</strong>调用它的checkForLeak()方法去使用haha库解析<br>hprof文件**，如下所示：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@NonNull</span> AnalysisResult <span class="hljs-title function_">checkForLeak</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> File heapDumpFile,</span><br><span class="hljs-params">  <span class="hljs-meta">@NonNull</span> String referenceKey,</span><br><span class="hljs-params">  <span class="hljs-type">boolean</span> computeRetainedSize)</span> {<br>    ...<br>    <br>    <span class="hljs-keyword">try</span> {<br>    listener.onProgressUpdate(READING_HEAP_DUMP_FILE);<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-type">HprofBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryMappedFileBuffer</span>(heapDumpFile);<br>  <br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-type">HprofParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HprofParser</span>(buffer);<br>    listener.onProgressUpdate(PARSING_HEAP_DUMP);<br>    <span class="hljs-type">Snapshot</span> <span class="hljs-variable">snapshot</span> <span class="hljs-operator">=</span> parser.parse();<br>  <br>    listener.onProgressUpdate(DEDUPLICATING_GC_ROOTS);<br>    <span class="hljs-comment">// 3</span><br>    deduplicateGcRoots(snapshot);<br>    listener.onProgressUpdate(FINDING_LEAKING_REF);<br>  <br>    <span class="hljs-comment">// 4</span><br>    <span class="hljs-type">Instance</span> <span class="hljs-variable">leakingRef</span> <span class="hljs-operator">=</span> findLeakingReference(referenceKey, snapshot);<br><br>    <span class="hljs-comment">// 5</span><br>    <span class="hljs-keyword">if</span> (leakingRef == <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">return</span> noLeak(since(analysisStartNanoTime));<br>    }<br>  <br>    <span class="hljs-comment">// 6</span><br>    <span class="hljs-keyword">return</span> findLeakTrace(analysisStartNanoTime, snapshot, leakingRef, computeRetainedSize);<br>    } <span class="hljs-keyword">catch</span> (Throwable e) {<br>    <span class="hljs-keyword">return</span> failure(e, since(analysisStartNanoTime));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，会新建一个<strong>内存映射缓存文件buffer</strong>。在注释2处，会<strong>使用buffer新建一个HprofParser解析器去解析出对应的引用内存快照文件snapshot<br><strong>。在注释3处，</strong>为了减少在Android 6.0版本中重复GCRoots带来的内存压力的影响，使用deduplicateGcRoots()<br>删除了gcRoots中重复的根对象RootObj</strong>。在注释4处，<strong>调用了findLeakingReference()<br>方法将传入的referenceKey和snapshot对象里面所有类实例的字段值对应的keyCandidate进行比较，如果没有相等的，则表示没有发生内存泄漏<br><strong>，直接调用注释5处的代码返回一个没有泄漏的分析结果AnalysisResult对象。</strong>如果找到了相等的，则表示发生了内存泄漏</strong><br>，执行注释6处的代码findLeakTrace()方法返回一个有泄漏分析结果的AnalysisResult对象。</p><p>最后，来分析下HeapAnalyzerService中注释3处的AbstractAnalysisResultService.sendResultToListener()<br>方法，很明显，这里AbstractAnalysisResultService的实现类就是我们刚开始分析的用于展示泄漏路径信息的DisplayLeakService对象。在里面直接<br><strong>创建一个由PendingIntent构建的泄漏通知用于供用户点击去展示详细的泄漏界面DisplayLeakActivity</strong>。核心代码如下所示：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> DisplayLeakService extends AbstractAnalysisResultService {<br><br>    @Override<br>    protected final void on<span class="hljs-constructor">HeapAnalyzed(@NonNull AnalyzedHeap <span class="hljs-params">analyzedHeap</span>)</span> {<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">        </span><br><span class="hljs-operator">        </span>boolean resultSaved = <span class="hljs-literal">false</span>;<br>        boolean shouldSaveResult = result.leakFound<span class="hljs-operator"> || </span>result.failure != null;<br>        <span class="hljs-keyword">if</span> (shouldSaveResult) {<br>            heapDump = rename<span class="hljs-constructor">Heapdump(<span class="hljs-params">heapDump</span>)</span>;<br>            <span class="hljs-comment">// 1</span><br>            resultSaved = save<span class="hljs-constructor">Result(<span class="hljs-params">heapDump</span>, <span class="hljs-params">result</span>)</span>;<br>        }<br>        <br>        <span class="hljs-keyword">if</span> (!shouldSaveResult) {<span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">            </span>show<span class="hljs-constructor">Notification(<span class="hljs-params">null</span>, <span class="hljs-params">contentTitle</span>, <span class="hljs-params">contentText</span>)</span>;<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultSaved) {<span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">            </span><span class="hljs-comment">// 2</span><br>            PendingIntent pendingIntent =<br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DisplayLeakActivity</span>.</span></span>create<span class="hljs-constructor">PendingIntent(<span class="hljs-params">this</span>, <span class="hljs-params">heapDump</span>.<span class="hljs-params">referenceKey</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">            </span><br><span class="hljs-operator">            </span>show<span class="hljs-constructor">Notification(<span class="hljs-params">pendingIntent</span>, <span class="hljs-params">contentTitle</span>, <span class="hljs-params">contentText</span>)</span>;<br>        } <span class="hljs-keyword">else</span> {<br>             on<span class="hljs-constructor">AnalysisResultFailure(<span class="hljs-params">getString</span>(R.<span class="hljs-params">string</span>.<span class="hljs-params">leak_canary_could_not_save_text</span>)</span>);<br>        }<span class="hljs-operator"></span><br><span class="hljs-operator">    </span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span>}<br><br>@Override protected final void on<span class="hljs-constructor">AnalysisResultFailure(String <span class="hljs-params">failureMessage</span>)</span> {<br>    super.on<span class="hljs-constructor">AnalysisResultFailure(<span class="hljs-params">failureMessage</span>)</span>;<br>    String failureTitle = get<span class="hljs-constructor">String(R.<span class="hljs-params">string</span>.<span class="hljs-params">leak_canary_result_failure_title</span>)</span>;<br>    show<span class="hljs-constructor">Notification(<span class="hljs-params">null</span>, <span class="hljs-params">failureTitle</span>, <span class="hljs-params">failureMessage</span>)</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，只要当分析的堆信息文件保存成功之后，即在注释1处返回的resultSaved为true时，才会执行注释2处的逻辑，即创建一个供用户点击跳转到DisplayLeakActivity的延时通知。</p><h2 id="LeakCanary运作流程"><a href="#LeakCanary运作流程" class="headerlink" title="LeakCanary运作流程"></a>LeakCanary运作流程</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d0363331db824e7ab342e4bd74702a93~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p><blockquote><p>性能优化一直是Android中进阶和深入的方向之一，而内存泄漏一直是性能优化中比较重要的一部分，Android<br>Studio自身提供了MAT等工具去分析内存泄漏，但是分析起来比较耗时耗力，因而才诞生了LeakCanary，它的使用非常简单，但是经过对它的深入分析之后，才发现，<br><strong>简单的API后面往往藏着许多复杂的逻辑处理，尝试去领悟它们，你可能会发现不一样的世界</strong>。</p></blockquote><h1 id="ButterKnife"><a href="#ButterKnife" class="headerlink" title="ButterKnife"></a>ButterKnife</h1><h2 id="简单示例-1"><a href="#简单示例-1" class="headerlink" title="简单示例"></a>简单示例</h2><p>首先看一下ButterKnife的基本使用，如下所示：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseRootFragment</span>&lt;CollectPresenter&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CollectContract</span>.View {<br><br>    <span class="hljs-meta">@BindView(R.id.normal_view)</span><br>    SmartRefreshLayout mRefreshLayout;<br>    <span class="hljs-meta">@BindView(R.id.collect_recycler_view)</span><br>    RecyclerView mRecyclerView;<br>    <span class="hljs-meta">@BindView(R.id.collect_floating_action_btn)</span><br>    FloatingActionButton mFloatingActionButton;<br>    <br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(LayoutInflater inflater, <span class="hljs-meta">@Nullable</span> ViewGroup container, <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {<br>        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> inflater.inflate(getLayoutId(), container, <span class="hljs-literal">false</span>);<br>        unBinder = ButterKnife.bind(<span class="hljs-built_in">this</span>, view);<br>        initView();<br>        <span class="hljs-keyword">return</span> view;<br>    }<br>    <br>    <span class="hljs-meta">@OnClick({R.id.collect_floating_action_btn})</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> {<br>        <span class="hljs-keyword">switch</span> (view.getId()) {<br>            <span class="hljs-keyword">case</span> R.id.collect_floating_action_btn:<br>                mRecyclerView.smoothScrollToPosition(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>    <br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroyView</span><span class="hljs-params">()</span> {<br>        <span class="hljs-built_in">super</span>.onDestroyView();<br>        <span class="hljs-keyword">if</span> (unBinder != <span class="hljs-literal">null</span> &amp;&amp; unBinder != Unbinder.EMPTY) {<br>            unBinder.unbind();<br>            unBinder = <span class="hljs-literal">null</span>;<br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure><p>可以看到，我们使用了@BindView()替代了findViewById()方法，然后使用了@OnClick替代了setOnClickListener()<br>方法。ButterKnife的初期版本是通过使用注解+反射这样的运行时解析的方式实现上述功能的，后面，为了改善性能，便使用了*<br>*注解+APT编译时解析技术并从中生成配套模板代码的方式**来实现。</p><p>在开始分析之前，可能有同学对APT不是很了解，这里普及一下，APT是Annotation Processing Tool的缩写，即注解处理工具。它的使用步骤通常为如下三个步骤：</p><ol><li><p>**首先，声明注解的生命周期为CLASS，即@Retention(CLASS)**。</p></li><li><p><strong>然后，通过继承AbstractProcessor自定义一个注解处理器</strong>。</p></li><li><p><strong>最后，在编译的时候，编译器会扫描所有带有你要处理的注解的类，最后再调用AbstractProcessor的process方法，对注解进行处理</strong>。</p></li></ol><p>下面，正式来解剖一下ButterKnife的心脏。</p><h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="模板代码解析"><a href="#模板代码解析" class="headerlink" title="模板代码解析"></a>模板代码解析</h3><p>首先，在编写好上述的示例代码之后，调用 gradle build<br>命令，在app/build/generated/source/apt下将可以找到APT为我们生产的配套模板代码CollectFragment_ViewBinding，如下所示：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> CollectFragment_ViewBinding implements Unbinder {<br>    <span class="hljs-keyword">private</span> CollectFragment target;<br>    <br>    <span class="hljs-keyword">private</span> View view2131230812;<br>    <br>    @UiThread<br>    public <span class="hljs-constructor">CollectFragment_ViewBinding(<span class="hljs-params">final</span> CollectFragment <span class="hljs-params">target</span>, View <span class="hljs-params">source</span>)</span> {<br>      this.target = target;<br>    <br>      View view;<br>      <span class="hljs-comment">// 1</span><br>      target.mRefreshLayout = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>find<span class="hljs-constructor">RequiredViewAsType(<span class="hljs-params">source</span>, R.<span class="hljs-params">id</span>.<span class="hljs-params">normal_view</span>, <span class="hljs-string">"field 'mRefreshLayout'"</span>, SmartRefreshLayout.<span class="hljs-params">class</span>)</span>;<br>      target.mRecyclerView = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>find<span class="hljs-constructor">RequiredViewAsType(<span class="hljs-params">source</span>, R.<span class="hljs-params">id</span>.<span class="hljs-params">collect_recycler_view</span>, <span class="hljs-string">"field 'mRecyclerView'"</span>, RecyclerView.<span class="hljs-params">class</span>)</span>;<br>      view = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>find<span class="hljs-constructor">RequiredView(<span class="hljs-params">source</span>, R.<span class="hljs-params">id</span>.<span class="hljs-params">collect_floating_action_btn</span>, <span class="hljs-string">"field 'mFloatingActionButton' and method 'onClick'"</span>)</span>;<br>      target.mFloatingActionButton = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>cast<span class="hljs-constructor">View(<span class="hljs-params">view</span>, R.<span class="hljs-params">id</span>.<span class="hljs-params">collect_floating_action_btn</span>, <span class="hljs-string">"field 'mFloatingActionButton'"</span>, FloatingActionButton.<span class="hljs-params">class</span>)</span>;<br>      view2131230812 = view;<br>      <span class="hljs-comment">// 2</span><br>      view.set<span class="hljs-constructor">OnClickListener(<span class="hljs-params">new</span> DebouncingOnClickListener()</span> {<br>        @Override<br>        public void <span class="hljs-keyword">do</span><span class="hljs-constructor">Click(View <span class="hljs-params">p0</span>)</span> {<br>          target.on<span class="hljs-constructor">Click(<span class="hljs-params">p0</span>)</span>;<br>        }<br>      });<br>    }<br>    <br>    @Override<br>    @CallSuper<br>    public void unbind<span class="hljs-literal">()</span> {<br>      CollectFragment target = this.target;<br>      <span class="hljs-keyword">if</span> (target<span class="hljs-operator"> == </span>null) throw <span class="hljs-keyword">new</span><span class="hljs-constructor">IllegalStateException(<span class="hljs-string">"Bindings already     cleared."</span>)</span>;<br>      this.target = null;<br>    <br>      target.mRefreshLayout = null;<br>      target.mRecyclerView = null;<br>      target.mFloatingActionButton = null;<br>    <br>      view2131230812.set<span class="hljs-constructor">OnClickListener(<span class="hljs-params">null</span>)</span>;<br>      view2131230812 = null;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>生成的配套模板CollectFragment_ViewBinding中，在注释1处，使用了ButterKnife内部的工具类Utils的findRequiredViewAsType()<br>方法来寻找控件。在注释2处，使用了view的setOnClickListener()<br>方法来添加了一个去抖动的DebouncingOnClickListener，这样便可以防止重复点击，在重写的doClick()<br>方法内部，直接调用了CollectFragment的onClick方法。最后，再深入看下Utils的findRequiredViewAsType()方法内部的实现。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">findRequiredViewAsType</span>(<span class="hljs-params">View source, <span class="hljs-meta">@IdRes</span> int id, <span class="hljs-built_in">String</span> who,</span><br><span class="hljs-params">  Class&lt;T&gt; cls</span>) {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-title class_">View</span> view = <span class="hljs-title function_">findRequiredView</span>(source, id, who);<br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">castView</span>(view, id, who, cls);<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">View</span> <span class="hljs-title function_">findRequiredView</span>(<span class="hljs-params">View source, <span class="hljs-meta">@IdRes</span> int id, <span class="hljs-built_in">String</span> who</span>) {<br>    <span class="hljs-title class_">View</span> view = source.<span class="hljs-title function_">findViewById</span>(id);<br>    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">return</span> view;<br>    }<br>    <br>    ...<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">castView</span>(<span class="hljs-params">View view, <span class="hljs-meta">@IdRes</span> int id, <span class="hljs-built_in">String</span> who, Class&lt;T&gt; cls</span>) {<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-keyword">return</span> cls.<span class="hljs-title function_">cast</span>(view);<br>    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ClassCastException</span> e) {<br>        ...<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，<strong>最终也是通过View的findViewById()方法找到相应的控件</strong>，在注释2处，**通过相应Class对象的cast方法强转成对应的控件类型<br>**。</p><h3 id="ButterKnife-是怎样实现代码注入的"><a href="#ButterKnife-是怎样实现代码注入的" class="headerlink" title="ButterKnife 是怎样实现代码注入的"></a>ButterKnife 是怎样实现代码注入的</h3><p>接下来，为了使用这套模板代码，我们必须调用ButterKnife的bind()<br>方法实现代码注入，即自动帮我们执行重复繁琐的findViewById和setOnClicklistener操作。下面我们来分析下bind()方法是如何实现注入的。</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@NonNull</span> <span class="hljs-variable">@UiThread</span><br>public static Unbinder <span class="hljs-built_in">bind</span>(<span class="hljs-variable">@NonNull</span> Object target, <span class="hljs-variable">@NonNull</span> View source) {<br>    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">createBinding</span>(target, source);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在bind()方法中调用了createBinding()，</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@NonNull</span> <span class="hljs-meta">@UiThread</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function">Unbinder <span class="hljs-title">bind</span><span class="hljs-params">(@NonNull Object <span class="hljs-keyword">target</span>, @NonNull View source)</span> </span>{<br>    Class&lt;?&gt; targetClass = <span class="hljs-keyword">target</span>.getClass();<br>    <span class="hljs-comment">// 1</span><br>    Constructor&lt;? <span class="hljs-keyword">extends</span> Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);<br><br>    <span class="hljs-keyword">if</span> (constructor == <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-keyword">return</span> Unbinder.EMPTY;<br>    }<br><br>    <br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-function"><span class="hljs-keyword">return</span> constructor.<span class="hljs-title">newInstance</span><span class="hljs-params">(<span class="hljs-keyword">target</span>, source)</span></span>;<br>    <span class="hljs-comment">// 3</span><br>    } <span class="hljs-keyword">catch</span> (IllegalAccessException e) {<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，通过 findBindingConstructorForClass() 方法从 Class 中查找<br>constructor，这里constructor即上文生成的CollectFragment_ViewBinding类。然后，在注释2处，<strong>利用反射来新建 constructor 对象</strong><br>。最后，如果新建 constructor 对象失败，则会在注释3后面捕获一系列对应的异常进行自定义异常抛出处理。</p><p>下面，来详细分析下 findBindingConstructorForClass() 方法的实现逻辑。</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@VisibleForTesting<br>static final Map&lt;Class&lt;?&gt;, Constructor&lt;? extends Unbinder&gt;&gt; BINDINGS = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;<span class="hljs-literal">()</span>;<br><br>@Nullable @CheckResult @UiThread<br><span class="hljs-keyword">private</span> static Constructor&lt;? extends Unbinder&gt; find<span class="hljs-constructor">BindingConstructorForClass(Class&lt;?&gt; <span class="hljs-params">cls</span>)</span> {<br>    <span class="hljs-comment">// 1</span><br>    Constructor&lt;? extends Unbinder&gt; bindingCtor = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BINDINGS</span>.</span></span>get(cls);<br>    <span class="hljs-keyword">if</span> (bindingCtor != null<span class="hljs-operator"> || </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BINDINGS</span>.</span></span>contains<span class="hljs-constructor">Key(<span class="hljs-params">cls</span>)</span>) {<br>        return bindingCtor;<br>    }<br>    <br>    <span class="hljs-comment">// 2</span><br>    String clsName = cls.get<span class="hljs-constructor">Name()</span>;<br>    <span class="hljs-keyword">if</span> (clsName.starts<span class="hljs-constructor">With(<span class="hljs-string">"android."</span>)</span><span class="hljs-operator"> || </span>clsName.starts<span class="hljs-constructor">With(<span class="hljs-string">"java."</span>)</span><span class="hljs-operator"></span><br><span class="hljs-operator">    || </span>clsName.starts<span class="hljs-constructor">With(<span class="hljs-string">"androidx."</span>)</span>) {<br>        return null;<br>    }<br>    <br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 3</span><br>        Class&lt;?&gt; bindingClass = cls.get<span class="hljs-constructor">ClassLoader()</span>.load<span class="hljs-constructor">Class(<span class="hljs-params">clsName</span> + <span class="hljs-string">"_ViewBinding"</span>)</span>;<br>        bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.get<span class="hljs-constructor">Constructor(<span class="hljs-params">cls</span>, View.<span class="hljs-params">class</span>)</span>;<br>    } catch (ClassNotFoundException e) {<br>        <span class="hljs-comment">// 4</span><br>        bindingCtor = find<span class="hljs-constructor">BindingConstructorForClass(<span class="hljs-params">cls</span>.<span class="hljs-params">getSuperclass</span>()</span>);<br>    } catch (NoSuchMethodException e) {<br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">RuntimeException(<span class="hljs-string">"Unable to find binding constructor for "</span> + <span class="hljs-params">clsName</span>, <span class="hljs-params">e</span>)</span>;<br>    }<br>    <br>    <span class="hljs-comment">// 5</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BINDINGS</span>.</span></span>put(cls, bindingCtor);<br>    return bindingCtor;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里，我把多余的log代码删除并把代码格式优化了一下，可以看到，findBindingConstructorForClass() 这个方法中的逻辑瞬间清晰不少，这里<br><strong>建议以后大家自己在分析源码的时候可以进行这样的优化重整</strong>，会带来不少好处。</p><p>重新看到 findBindingConstructorForClass()<br>方法，在注释1处，我们首先从缓存BINDINGS中获取CollectFragment类对象对应的模块类CollectFragment_ViewBinding的构造器对象，这里的BINDINGS是一个LinkedHashMap对象，它保存了上述两者的映射关系。在注释2处，如果是<br>android，androidx，java 原生的文件，不进行处理。在注释3处，先*<br>*通过CollectFragment类对象的类加载器加载出对应的模块类CollectFragment_ViewBinding的类对象**，再通过自身的getConstructor()<br>方法获得相应的构造对象。如果在步骤3中加载不出对应的模板类对象，则会在注释4处使用类似递归的方法重新执行findBindingConstructorForClass()<br>方法。最后，如果找到了bindingCtor模板构造对象，则将它保存在BINDINGS这个LinkedHashMap对象中。</p><p><strong>这里总结一下findBindingConstructorForClass()方法的处理：</strong></p><ol><li><p>**首先从缓存BINDINGS中获取CollectFragment类对象对应的模块类CollectFragment_ViewBinding的构造器对象，获取不到，则继续执行下面的操作<br>**。</p></li><li><p><strong>如果不是android，androidx，java 原生的文件，再进行后面的处理</strong>。</p></li><li><ul><li>*通过CollectFragment类对象的类加载器加载出对应的模块类CollectFragment_ViewBinding的类对象，再通过自身的getConstructor()<br>方法获得相应的构造对象，如果获取不到，会抛出异常，在异常的处理中，我们会从当前 class<br>文件的父类中再去查找。如果找到了，最后会将bindingCtor对象缓存进在BINDINGS对象中**。</li></ul></li></ol><h3 id="ButterKnife是如何在编译时生成代码的？"><a href="#ButterKnife是如何在编译时生成代码的？" class="headerlink" title="ButterKnife是如何在编译时生成代码的？"></a>ButterKnife是如何在编译时生成代码的？</h3><p>在编译的时候，ButterKnife会通过自定义的注解处理器ButterKnifeProcessor的process方法，对编译器扫描到的要处理的类中的注解进行处理，然后，<br><strong>通过javapoet这个库来动态生成绑定事件或者控件的模板代码</strong>，最后在运行的时候，直接调用bind方法完成绑定即可。</p><p>首先，先来分析下ButterKnifeProcessor的重写的入口方法init()。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> synchronized <span class="hljs-built_in">void</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">ProcessingEnvironment env</span>) {<br>    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">init</span>(env);<br><br>    <span class="hljs-title class_">String</span> sdk = env.<span class="hljs-title function_">getOptions</span>().<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">OPTION_SDK_INT</span>);<br>    <span class="hljs-keyword">if</span> (sdk != <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">sdk</span> = <span class="hljs-title class_">Integer</span>.<span class="hljs-built_in">parseInt</span>(sdk);<br>        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">NumberFormatException</span> e) {<br>           ...<br>        }<br>    }<br><br>    typeUtils = env.<span class="hljs-title function_">getTypeUtils</span>();<br>    filer = env.<span class="hljs-title function_">getFiler</span>();<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，**ProcessingEnviroment对象提供了两大工具类 typeUtils和filer。typeUtils的作用是用来处理TypeMirror，而Filer则是用来创建生成辅助文件<br>**。</p><p>接着，再来看看被重写的getSupportedAnnotationTypes()方法，这个方法的作用主要是用于指定ButterknifeProcessor注册了哪些注解的。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getSupportedAnnotationTypes</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; types = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Class</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; annotation : <span class="hljs-title function_">getSupportedAnnotations</span>()) {<br>    types.<span class="hljs-title function_">add</span>(annotation.<span class="hljs-title function_">getCanonicalName</span>());<br>    }<br>    <span class="hljs-keyword">return</span> types;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里面首先创建了一个LinkedHashSet对象，然后将getSupportedAnnotations()方法返回的支持注解集合进行遍历一一并添加到types中返回。</p><p>接着看下getSupportedAnnotations()方法，</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs routeros">private Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() {<br>    Set&lt;Class&lt;? extends Annotation&gt;&gt; annotations = new LinkedHashSet&lt;&gt;();<br><br>    annotations.<span class="hljs-built_in">add</span>(BindAnim.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindArray.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindBitmap.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindBool.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindColor.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindDimen.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindDrawable.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindFloat.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindFont.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindInt.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindString.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindView.class);<br>    annotations.<span class="hljs-built_in">add</span>(BindViews.class);<br>    annotations.addAll(LISTENERS);<br><br>    return annotations;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里注册了一系列的Bindxxx注解类和监听列表LISTENERS，接着看一下LISTENERS中包含的监听方法：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;<span class="hljs-keyword">Class</span>&lt;? <span class="hljs-keyword">extends</span> Annotation&gt;&gt; LISTENERS = Arrays.<span class="hljs-keyword">asList</span>(<br>    OnCheckedChanged.<span class="hljs-keyword">class</span>, <br>    OnClick.<span class="hljs-keyword">class</span>, <br>    OnEditorAction.<span class="hljs-keyword">class</span>, <br>    OnFocusChange.<span class="hljs-keyword">class</span>, <br>    OnItemClick.<span class="hljs-keyword">class</span>, <br>    OnItemLongClick.<span class="hljs-keyword">class</span>, <br>    OnItemSelected.<span class="hljs-keyword">class</span>, <br>    OnLongClick.<span class="hljs-keyword">class</span>, <br>    OnPageChange.<span class="hljs-keyword">class</span>, <br>    OnTextChanged.<span class="hljs-keyword">class</span>, <br>    OnTouch.<span class="hljs-keyword">class</span> <br>);<br></code></pre></td></tr></tbody></table></figure><p>最后，来分析下整个ButterKnifeProcessor中最关键的方法process()。</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;? <span class="hljs-keyword">extends</span> TypeElement&gt; elements, RoundEnvironment env</span>) {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">TypeElement</span>, <span class="hljs-title class_">BindingSet</span>&gt; bindingMap = <span class="hljs-title function_">findAndParseTargets</span>(env);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>&lt;<span class="hljs-title class_">TypeElement</span>, <span class="hljs-title class_">BindingSet</span>&gt; entry : bindingMap.<span class="hljs-title function_">entrySet</span>()) {<br>        <span class="hljs-title class_">TypeElement</span> typeElement = entry.<span class="hljs-title function_">getKey</span>();<br>        <span class="hljs-title class_">BindingSet</span> binding = entry.<span class="hljs-title function_">getValue</span>();<br><br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-title class_">JavaFile</span> javaFile = binding.<span class="hljs-title function_">brewJava</span>(sdk, debuggable);<br>        <span class="hljs-keyword">try</span> {<br>            javaFile.<span class="hljs-title function_">writeTo</span>(filer);<br>        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) {<br>           ...<br>        }<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处通过<strong>findAndParseTargets()方法</strong>，知名见义，它应该就是<strong>找到并解析注解目标的关键方法</strong>了，继续看看它内部的处理：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> Map&lt;TypeElement, BindingSet&gt; find<span class="hljs-constructor">AndParseTargets(RoundEnvironment <span class="hljs-params">env</span>)</span> {<br>    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;<span class="hljs-literal">()</span>;<br>    Set&lt;TypeElement&gt; erasedTargetNames = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;<span class="hljs-literal">()</span>;<br><br>    <span class="hljs-comment">// 1、一系列处理每一个@Bindxxx元素的for循环代码块</span><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span><span class="hljs-comment">// Process each @BindView element.</span><br>    <span class="hljs-keyword">for</span> (Element element : env.get<span class="hljs-constructor">ElementsAnnotatedWith(BindView.<span class="hljs-params">class</span>)</span>) {<br>        <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 2</span><br>        parse<span class="hljs-constructor">BindView(<span class="hljs-params">element</span>, <span class="hljs-params">builderMap</span>, <span class="hljs-params">erasedTargetNames</span>)</span>;<br>        } catch (Exception e) {<br>            log<span class="hljs-constructor">ParsingError(<span class="hljs-params">element</span>, BindView.<span class="hljs-params">class</span>, <span class="hljs-params">e</span>)</span>;<br>        }<br>    }<br><br>    <span class="hljs-comment">// Process each @BindViews element.</span><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span><span class="hljs-comment">// Process each annotation that corresponds to a listener.</span><br>    <span class="hljs-keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) {<br>        find<span class="hljs-constructor">AndParseListener(<span class="hljs-params">env</span>, <span class="hljs-params">listener</span>, <span class="hljs-params">builderMap</span>, <span class="hljs-params">erasedTargetNames</span>)</span>;<br>    }<br><br>    <span class="hljs-comment">// 2</span><br>    Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =<br>        <span class="hljs-keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entry<span class="hljs-constructor">Set()</span>);<br>    Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">while</span> (!entries.is<span class="hljs-constructor">Empty()</span>) {<br>        Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.remove<span class="hljs-constructor">First()</span>;<br><br>        TypeElement <span class="hljs-keyword">type</span> = entry.get<span class="hljs-constructor">Key()</span>;<br>        BindingSet.Builder builder = entry.get<span class="hljs-constructor">Value()</span>;<br><br>        TypeElement parentType = find<span class="hljs-constructor">ParentType(<span class="hljs-params">type</span>, <span class="hljs-params">erasedTargetNames</span>)</span>;<br>        <span class="hljs-keyword">if</span> (parentType<span class="hljs-operator"> == </span>null) {<br>            bindingMap.put(<span class="hljs-keyword">type</span>, builder.build<span class="hljs-literal">()</span>);<br>        } <span class="hljs-keyword">else</span> {<br>            BindingSet parentBinding = bindingMap.get(parentType);<br>            <span class="hljs-keyword">if</span> (parentBinding != null) {<br>                builder.set<span class="hljs-constructor">Parent(<span class="hljs-params">parentBinding</span>)</span>;<br>                bindingMap.put(<span class="hljs-keyword">type</span>, builder.build<span class="hljs-literal">()</span>);<br>            } <span class="hljs-keyword">else</span> {<br>            entries.add<span class="hljs-constructor">Last(<span class="hljs-params">entry</span>)</span>;<br>            }<br>        }<br>    }<br>    return bindingMap;<br>}<br></code></pre></td></tr></tbody></table></figure><p>findAndParseTargets()方法的代码非常多，这里尽可能做了精简。首先，在注释1处，*<br><em>扫描并处理所有具有@Bindxxx注解和符合LISTENERS监听方法集合的代码，然后在每一个@Bindxxx对应的for循环代码中的parseBindxxx()<br>或findAndParseListener()方法中将解析出的信息放入builderMap这个LinkedHashMap对象中</em>*<br>，其中builderMap是一个key为TypeElement，value为BindingSet.Builder的映射集合，这个 BindSet 是指**的一个类型请求的所有绑定的集合<br>**<br>。在注释3处，首先使用上面的builderMap对象去构建了一个entries对象，它是一个双向队列，能实现两端存取的操作。接着，又新建了一个key为TypeElement，value为BindingSet的LinkedHashMap对象，最后使用了一个while循环从entries的第一个元素开始，这里会判断当前元素类型是否有父类，如果没有，直接构建builder放入bindingMap中，如果有，则将parentBinding添加到BindingSet.Builder这个建造者对象中，然后再创建BindingSet再添加到bindingMap中。</p><p>接着，分析下注释2处parseBindView是如何对每一个@BindView注解的元素进行处理。</p><figure class="highlight dart"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs dart">private <span class="hljs-keyword">void</span> parseBindView(<span class="hljs-built_in">Element</span> element, <span class="hljs-built_in">Map</span>&lt;TypeElement, BindingSet.Builder&gt; builderMap,<br>  <span class="hljs-built_in">Set</span>&lt;TypeElement&gt; erasedTargetNames) {<br>    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();<br><br>    <span class="hljs-comment">// 1、首先验证生成的常见代码限制</span><br>    ...<br><br>    <span class="hljs-comment">// 2、验证目标类型是否继承自View。</span><br>    ...<br>    <br>    <span class="hljs-comment">// 3</span><br>    <span class="hljs-built_in">int</span> id = element.getAnnotation(BindView.<span class="hljs-keyword">class</span>).value();<br>    BindingSet.Builder builder = builderMap.<span class="hljs-keyword">get</span>(enclosingElement);<br>    Id resourceId = elementToId(element, BindView.<span class="hljs-keyword">class</span>, id);<br>    <span class="hljs-keyword">if</span> (builder != <span class="hljs-keyword">null</span>) {<br>        <span class="hljs-built_in">String</span> existingBindingName = builder.findExistingBindingName(resourceId);<br>        <span class="hljs-keyword">if</span> (existingBindingName != <span class="hljs-keyword">null</span>) {<br>            ...<br>            <span class="hljs-keyword">return</span>;<br>        }<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// 4</span><br>        builder = getOrCreateBindingBuilder(builderMap, enclosingElement);<br>    }<br><br>    <span class="hljs-built_in">String</span> name = simpleName.toString();<br>    TypeName type = TypeName.<span class="hljs-keyword">get</span>(elementType);<br>    boolean <span class="hljs-keyword">required</span> = isFieldRequired(element);<br><br>    <span class="hljs-comment">// 5</span><br>    builder.addField(resourceId, <span class="hljs-keyword">new</span>     FieldViewBinding(name, type, <span class="hljs-keyword">required</span>));<br><br>    <span class="hljs-comment">// Add the type-erased version to the valid binding targets set.</span><br>    erasedTargetNames.add(enclosingElement);<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1、2处均是一些验证处理操作，如果不符合则会return。然后，看到注释3处，这里获取了BindView要绑定的View的id，然后先从builderMap中获取BindingSet.Builder对象，如果存在，直接return。如果不存在，则会在注释4处的<br>getOrCreateBindingBuilder()方法生成一个。看一下getOrCreateBindingBuilder()方法:</p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">private <span class="hljs-keyword">BindingSet.Builder </span>getOrCreateBindingBuilder(<br>  Map&lt;TypeElement, <span class="hljs-keyword">BindingSet.Builder&gt; </span><span class="hljs-keyword">builderMap, </span>TypeElement enclosingElement) {<br>    <span class="hljs-keyword">BindingSet.Builder </span><span class="hljs-keyword">builder </span>= <span class="hljs-keyword">builderMap.get(enclosingElement);</span><br><span class="hljs-keyword"></span>    if (<span class="hljs-keyword">builder </span>== null) {<br>        <span class="hljs-keyword">builder </span>= <span class="hljs-keyword">BindingSet.newBuilder(enclosingElement);</span><br><span class="hljs-keyword"></span>        <span class="hljs-keyword">builderMap.put(enclosingElement, </span><span class="hljs-keyword">builder);</span><br><span class="hljs-keyword"></span>    }<br>    return <span class="hljs-keyword">builder;</span><br><span class="hljs-keyword"></span>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里会再次从buildMap中获取BindingSet.Builder对象，如果没有则直接调用BindingSet的newBuilder()<br>方法新建一个BindingSet.Builder对象并保存在builderMap中，然后，再将新建的builder对象返回。</p><p>回到parseBindView()方法的注释5处，这里根据view的信息生成一个FieldViewBinding，最后添加到上边生成的builder对象中。</p><p>最后，再回到我们的process()方法中，现在*<br>*所有的绑定的集合数据都放在了bindingMap对象中，这里使用for循环取出每一个BindingSet对象，调用它的brewJava()方法**，看看它内部的处理：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">JavaFile brew<span class="hljs-constructor">Java(<span class="hljs-params">int</span> <span class="hljs-params">sdk</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">debuggable</span>)</span> {<br>    TypeSpec bindingConfiguration = create<span class="hljs-constructor">Type(<span class="hljs-params">sdk</span>, <span class="hljs-params">debuggable</span>)</span>;<br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JavaFile</span>.</span></span>builder(bindingClassName.package<span class="hljs-constructor">Name()</span>, bindingConfiguration)<br>    .add<span class="hljs-constructor">FileComment(<span class="hljs-string">"Generated code from Butter Knife. Do not modify!"</span>)</span><br>    .build<span class="hljs-literal">()</span>;<br>}<br><br><span class="hljs-keyword">private</span> TypeSpec create<span class="hljs-constructor">Type(<span class="hljs-params">int</span> <span class="hljs-params">sdk</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">debuggable</span>)</span> {<br>    TypeSpec.Builder result = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TypeSpec</span>.</span></span><span class="hljs-keyword">class</span><span class="hljs-constructor">Builder(<span class="hljs-params">bindingClassName</span>.<span class="hljs-params">simpleName</span>()</span>)<br>    .add<span class="hljs-constructor">Modifiers(PUBLIC)</span>;<br>    <span class="hljs-keyword">if</span> (isFinal) {<br>        result.add<span class="hljs-constructor">Modifiers(FINAL)</span>;<br>    }<br><br>    <span class="hljs-keyword">if</span> (parentBinding != null) {<br>        result.superclass(parentBinding.bindingClassName);<br>    } <span class="hljs-keyword">else</span> {<br>        result.add<span class="hljs-constructor">Superinterface(UNBINDER)</span>;<br>    }<br><br>    <span class="hljs-keyword">if</span> (has<span class="hljs-constructor">TargetField()</span>) {<br>        result.add<span class="hljs-constructor">Field(<span class="hljs-params">targetTypeName</span>, <span class="hljs-string">"target"</span>, PRIVATE)</span>;<br>    }<br><br>    <span class="hljs-keyword">if</span> (isView) {<br>        result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingConstructorForView</span>()</span>);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isActivity) {<br>        result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingConstructorForActivity</span>()</span>);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDialog) {<br>        result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingConstructorForDialog</span>()</span>);<br>    }<br>    <span class="hljs-keyword">if</span> (!constructor<span class="hljs-constructor">NeedsView()</span>) {<br>        <span class="hljs-comment">// Add a delegating constructor with a target type + view signature for reflective use.</span><br>        result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingViewDelegateConstructor</span>()</span>);<br>    }<br>    result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingConstructor</span>(<span class="hljs-params">sdk</span>, <span class="hljs-params">debuggable</span>)</span>);<br><br>    <span class="hljs-keyword">if</span> (has<span class="hljs-constructor">ViewBindings()</span><span class="hljs-operator"> || </span>parentBinding<span class="hljs-operator"> == </span>null) {<br>        result.add<span class="hljs-constructor">Method(<span class="hljs-params">createBindingUnbindMethod</span>(<span class="hljs-params">result</span>)</span>);<br>    }<br><br>    return result.build<span class="hljs-literal">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在createType()方法里面使用了java中的javapoet技术生成了一个bindingConfiguration对象，很显然，它里面*<br>*保存了所有的绑定配置信息。然后，通过javapoet的builder构造器将上面得到的bindingConfiguration对象构建生成一个JavaFile对象，最终，通过javaFile.writeTo(<br>filer)生成了java源文件**。</p><blockquote><p>从上面的源码分析来看，ButterKnife的执行流程总体可以分为如下两步：</p></blockquote><ol><li><p><strong>在编译的时候扫描注解，并通过自定义的ButterKnifeProcessor做相应的处理解析得到bindingMap对象，最后，调用 javapoet<br>库生成java模板代码</strong>。</p></li><li><p><strong>当我们调用 ButterKnife的bind()方法的时候，它会根据类的全限定类型，找到相应的模板代码，并在其中完成 findViewById 和<br>setOnClick ，setOnLongClick 等操作</strong>。</p></li></ol><h1 id="Dagger-2"><a href="#Dagger-2" class="headerlink" title="Dagger 2"></a>Dagger 2</h1><h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><h3 id="Inject"><a href="#Inject" class="headerlink" title="@Inject"></a>@Inject</h3><p>告诉dagger这个字段或类需要依赖注入，然后在需要依赖的地方使用这个注解，dagger会自动生成这个构造器的实例。</p><h4 id="获取所需依赖："><a href="#获取所需依赖：" class="headerlink" title="获取所需依赖："></a>获取所需依赖：</h4><ul><li>全局变量注入</li><li>方法注入</li></ul><h4 id="提供所需实例："><a href="#提供所需实例：" class="headerlink" title="提供所需实例："></a>提供所需实例：</h4><ul><li>构造器注入（如果有多个构造函数，只能注解一个，否则编译报错）</li></ul><h3 id="Module"><a href="#Module" class="headerlink" title="@Module"></a>@Module</h3><p>类注解，表示此类的方法是提供依赖的，它告诉dagger在哪可以找到依赖。用于不能用@Inject提供依赖的地方，如第三方库提供的类，基本数据类型等不能修改源码的情况。</p><p>注意：<strong>Dagger2会优先在@Module注解的类上查找依赖，没有的情况才会去查询类的@Inject构造方法</strong></p><h3 id="Singleton"><a href="#Singleton" class="headerlink" title="@Singleton"></a>@Singleton</h3><p>声明这是一个单例，<strong>在确保只有一个Component并且不再重新build()之后，对象只会被初始化一次，之后的每次都会被注入相同的对象</strong><br>，它就是一个内置的作用域。</p><p>对于@Singleton，大家可能会产生一些误解，这里详细阐述下：</p><ul><li>Singleton容易给人造成一种误解就是用Singleton注解后在整个Java代码中都是单例，但**实际上他和Scope一样，只是在同一个Component是单例<br>**。也就是说，如果重新调用了component的build（）方法，即使使用了Singleton注解了，但仍然获取的是不同的对象。</li><li>它表明了**@Singleton注解只是声明了这是一个单例，为的只是提高代码可读性，其实真正控制对象生命周期的还是Component**<br>。同理，自定义的@ActivityScope 、@ApplicationScope也仅仅是一个声明的作用，<strong>真正控制对象生命周期的还是Component</strong>。</li></ul><h3 id="Providers"><a href="#Providers" class="headerlink" title="@Providers"></a>@Providers</h3><p>只在@Module中使用，用于提供构造好的实例。一般与@Singleton搭配，用单例方法的形式对外提供依赖,是一种替代@Inject注解构造方法的方式。</p><p>注意：</p><ul><li>使用了@Providers的方法应使用provide作为前缀，使用了@Module的类应使用Module作为后缀。</li><li>**如果@Providers方法或@Inject构造方法有参数，要保证它能够被dagger获取到，比如通过其它@Providers方法或者@Inject注解构造器的形式得到<br>**。</li></ul><h3 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h3><p>**@Component作为Dagger2的容器总管，它拥有着@Inject与@Module的所有依赖。同时，它也是一枚注射器，用于获取所需依赖和提供所需依赖的桥梁<br>**。这里的桥梁即指@Inject和@Module（或@Inject构造方法）之间的桥梁。定义时需要列出响应的Module组成，此外，还可以使用dependencies继承父Component。</p><h4 id="Component与Module的区别："><a href="#Component与Module的区别：" class="headerlink" title="Component与Module的区别："></a>Component与Module的区别：</h4><p>Component既是注射器也是一个容器总管，而module则是作为容器总管Component的子容器，实质是一个用于提供依赖的模块。</p><h3 id="Scope"><a href="#Scope" class="headerlink" title="@Scope"></a>@Scope</h3><p>注解作用域，通过自定义注解<strong>限定对象作用范围，增强可读性</strong>。</p><p>@Scope有两种常用的使用场景：</p><ul><li><strong>模拟Singleton代表全局单例，与Component生命周期关联</strong>。</li><li><strong>模拟局部单例，如登录到退出登录期间</strong>。</li></ul><h3 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h3><p>限定符，利用它<strong>定义注解类以用于区分类的不同实例</strong>。例如：2个方法返回不同的Person对象，比如说小明和小华，为了区分，使用@Qualifier定义的注解类。</p><h3 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h3><p>使用它表示ChildComponent依赖于FatherComponent，如下所示：</p><figure class="highlight d"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs d"><span class="hljs-keyword">@Component</span>(modules = ChildModule.<span class="hljs-keyword">class</span>, dependencies = FatherComponent.<span class="hljs-keyword">class</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> ChildComponent {<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="SubComponent"><a href="#SubComponent" class="headerlink" title="@SubComponent"></a>@SubComponent</h3><p>表示是一个子@Component，它能<strong>将应用的不同部分封装起来，用来替代@Dependencies</strong>。</p><h2 id="简单示例-2"><a href="#简单示例-2" class="headerlink" title="简单示例"></a>简单示例</h2><h3 id="首先，创建一个BaseActivityComponent的Subcomponent："><a href="#首先，创建一个BaseActivityComponent的Subcomponent：" class="headerlink" title="首先，创建一个BaseActivityComponent的Subcomponent："></a>首先，创建一个BaseActivityComponent的Subcomponent：</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-meta">@Subcomponent</span>(modules = {<span class="hljs-type">AndroidInjectionModule</span>.<span class="hljs-keyword">class</span>})<br>public interface <span class="hljs-type">BaseActivityComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-type">AndroidInjector</span>&lt;<span class="hljs-type">BaseActivity</span>&gt; {<br><br>    <span class="hljs-meta">@Subcomponent</span>.<span class="hljs-type">Builder</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AndroidInjector</span>.<span class="hljs-title">Builder&lt;BaseActivity&gt;</span></span>{<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里必须要注解成@Subcomponent.Builder表示是顶级@Subcomponent的内部类。AndroidInjector.Builder的泛型指定了BaseActivity，即表示每一个继承于BaseActivity的Activity都继承于同一个子组件（BaseActivityComponent）。</p><h3 id="然后，创建一个将会导入Subcomponent的公有Module。"><a href="#然后，创建一个将会导入Subcomponent的公有Module。" class="headerlink" title="然后，创建一个将会导入Subcomponent的公有Module。"></a>然后，创建一个将会导入Subcomponent的公有Module。</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1</span><br><span class="hljs-meta">@Module(subcomponents = {BaseActivityComponent.class})</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAllActivityModule</span> {<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = MainActivityModule.class)</span><br>    <span class="hljs-keyword">abstract</span> MainActivity <span class="hljs-title function_">contributesMainActivityInjector</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = SplashActivityModule.class)</span><br>    <span class="hljs-keyword">abstract</span> SplashActivity <span class="hljs-title function_">contributesSplashActivityInjector</span><span class="hljs-params">()</span>;<br>    <br>    <span class="hljs-comment">// 一系列的对应Activity的contributesxxxActivityInjector</span><br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处用subcomponents来表示开放全部依赖给AbstractAllActivityModule，使用Subcomponent的重要原因是它将应用的不同部分封装起来了。<br><strong>@AppComponent负责维护共享的数据和对象，而不同处则由各自的@Subcomponent维护</strong>。</p><h3 id="接着，配置项目的Application。"><a href="#接着，配置项目的Application。" class="headerlink" title="接着，配置项目的Application。"></a>接着，配置项目的Application。</h3><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WanAndroidApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Application</span> <span class="hljs-title">implements</span> <span class="hljs-title">HasActivityInjector</span> </span>{<br><br>    <span class="hljs-comment">// 3</span><br>    <span class="hljs-meta">@Inject</span><br>    <span class="hljs-type">DispatchingAndroidInjector</span>&lt;<span class="hljs-type">Activity</span>&gt; mAndroidInjector;<br><br>    <span class="hljs-keyword">private</span> static volatile <span class="hljs-type">AppComponent</span> appComponent;<br>    <br>    <span class="hljs-meta">@Override</span><br>    public void onCreate() {<br>        <span class="hljs-keyword">super</span>.onCreate();<br>        <br>        ...<br>        <span class="hljs-comment">// 1</span><br>        appComponent = <span class="hljs-type">DaggerAppComponent</span>.builder()<br>            .build();<br>        <span class="hljs-comment">// 2</span><br>        appComponent.inject(<span class="hljs-keyword">this</span>);<br>        <br>        ...<br>        <br>    }<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 4</span><br>    <span class="hljs-meta">@Override</span><br>    public <span class="hljs-type">AndroidInjector</span>&lt;<span class="hljs-type">Activity</span>&gt; activityInjector() {<br>        <span class="hljs-keyword">return</span> mAndroidInjector;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，使用AppModule模块和httpModule模块构建出AppComponent的实现类DaggerAppComponent。这里看一下AppComponent的配置代码：</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Singleton</span><br><span class="hljs-variable">@Component</span>(modules = {AndroidInjectionModule.class,<br>        AndroidSupportInjectionModule.class,<br>        AbstractAllActivityModule.class,<br>        AbstractAllFragmentModule.class,<br>        AbstractAllDialogFragmentModule.class}<br>    )<br>public interface AppComponent {<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 注入WanAndroidApp实例</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * @param wanAndroidApp WanAndroidApp</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">inject</span>(WanAndroidApp wanAndroidApp);<br>    <br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，AppComponent依赖了AndroidInjectionModule模块，它包含了一些基础配置的绑定设置，如activityInjectorFactories、fragmentInjectorFactories等等，而AndroidSupportInjectionModule模块显然就是多了一个supportFragmentInjectorFactories的绑定设置，activityInjectorFactories的内容如所示：</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Beta</span><br><span class="hljs-variable">@Module</span><br>public abstract class AndroidInjectionModule {<br>    <span class="hljs-variable">@Multibinds</span><br>    abstract Map&lt;Class&lt;? extends Activity&gt;, AndroidInjector.Factory&lt;? extends Activity&gt;&gt;<br>        <span class="hljs-built_in">activityInjectorFactories</span>();<br>    <br>    <span class="hljs-variable">@Multibinds</span><br>    abstract Map&lt;Class&lt;? extends Fragment&gt;, AndroidInjector.Factory&lt;? extends Fragment&gt;&gt;<br>        <span class="hljs-built_in">fragmentInjectorFactories</span>();<br>    <br>    ...<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>接着，下面依赖的AbstractAllActivityModule、<br>AbstractAllFragmentModule、AbstractAllDialogFragmentModule则是为项目的所有Activity、Fragment、DialogFragment提供的统一基类抽象Module，这里看下AbstractAllActivityModule的配置：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Module(subcomponents = {BaseActivityComponent.class})</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAllActivityModule</span> {<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = MainActivityModule.class)</span><br>    <span class="hljs-keyword">abstract</span> MainActivity <span class="hljs-title function_">contributesMainActivityInjector</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = SplashActivityModule.class)</span><br>    <span class="hljs-keyword">abstract</span> SplashActivity <span class="hljs-title function_">contributesSplashActivityInjector</span><span class="hljs-params">()</span>;<br>    <br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，项目下的所有xxxActiviity都有对应的contributesxxxActivityInjector()<br>方法提供实例注入。并且，注意到AbstractAllActivityModule这个模块依赖的<br>subcomponents为BaseActivityComponent，前面说过了，每一个继承于BaseActivity的Activity都继承于BaseActivityComponent这一个subcomponents。同理，AbstractAllFragmentModule与AbstractAllDialogFragmentModule也是类似的实现模式，如下所示：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1</span><br><span class="hljs-meta">@Module(c = BaseFragmentComponent.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAllFragmentModule</span> {<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = CollectFragmentModule.class)</span><br>    <span class="hljs-keyword">abstract</span> CollectFragment <span class="hljs-title function_">contributesCollectFragmentInject</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = KnowledgeFragmentModule.class)</span><br>    <span class="hljs-keyword">abstract</span> KnowledgeHierarchyFragment <span class="hljs-title function_">contributesKnowledgeHierarchyFragmentInject</span><span class="hljs-params">()</span>;<br>    <br>    ...<br>    <br>}<br><br><br><span class="hljs-comment">// 2</span><br><span class="hljs-meta">@Module(subcomponents = BaseDialogFragmentComponent.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAllDialogFragmentModule</span> {<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = SearchDialogFragmentModule.class)</span><br>    <span class="hljs-keyword">abstract</span> SearchDialogFragment <span class="hljs-title function_">contributesSearchDialogFragmentInject</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@ContributesAndroidInjector(modules = UsageDialogFragmentModule.class)</span><br>    <span class="hljs-keyword">abstract</span> UsageDialogFragment <span class="hljs-title function_">contributesUsageDialogFragmentInject</span><span class="hljs-params">()</span>;<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>注意到注释1和注释2处的代码，AbstractAllFragmentModule和AbstractAllDialogFragmentModule的subcomponents为BaseFragmentComponent、BaseDialogFragmentComponent，很显然，同AbstractAllActivityModule的子组件BaseActivityComponent一样，它们都是作为一个通用的子组件。</p><p>然后，回到我们配置项目下的Application下面的注释2处的代码，在这里使用了第一步Dagger为我们构建的DaggerAppComponent对象将当期的Application实例注入了进去，交给了Dagger这个依赖大管家去管理。最终，</p><ul><li></li></ul><p><em>Dagger2内部创建的mAndroidInjector对象会在注释3处的地方进行实例赋值。在注释4处，实现HasActivityInjector接口，重写activityInjector()<br>方法，将我们上面得到的mAndroidInjector对象返回</em>*<br>。这里的mAndroidInjector是一个类型为DispatchingAndroidInjector的对象，可以这样理解它：它能够执行Android框架下的核心成员如Activity、Fragment的成员注入，在我们项目下的Application中将DispatchingAndroidInjector的泛型指定为Activity就说明它承担起了所有Activity成员依赖的注入。那么，如何指定某一个Activity能被纳入DispatchingAndroidInjector这个所有Activity的依赖总管的口袋中呢？接着看使用步骤4。</p><h3 id="最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。"><a href="#最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。" class="headerlink" title="最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。"></a>最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。</h3><p>很简单，只需在目标Activity的onCreate()方法前的super.onCreate(savedInstanceState)前配置一行代码 AndroidInjection.inject(<br>this)，如下所示：</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseActivity&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractPresenter&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSimpleActivity</span> <span class="hljs-title">implements</span></span><br>    <span class="hljs-type">AbstractView</span> {<br><br>    ...<br>    <span class="hljs-meta">@Inject</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">T</span> mPresenter;<br>    <br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Bundle</span> savedInstanceState) {<br>        <span class="hljs-type">AndroidInjection</span>.inject(<span class="hljs-keyword">this</span>);<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>    }<br><br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>这里使用了@Inject表明了需要注入mPresenter实例，然后，我们需要在具体的Presenter类的构造方法上使用@Inject提供基于当前构造方法的mPresenter实例，如下所示：</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainPresenter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePresenter&lt;MainContract</span>.<span class="hljs-title">View&gt;</span> <span class="hljs-title">implements</span> <span class="hljs-title">MainContract</span>.<span class="hljs-title">Presenter</span> </span>{<br><br>    ...<br><br>    <span class="hljs-meta">@Inject</span><br>    <span class="hljs-type">MainPresenter</span>(<span class="hljs-type">DataManager</span> dataManager) {<br>        <span class="hljs-keyword">super</span>(dataManager);<br>        <span class="hljs-keyword">this</span>.mDataManager = dataManager;<br>    }<br><br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面的使用流程中，有三个关键的核心实现是我们需要了解的，如下所示：</p><ul><li>1、appComponent = DaggerAppComponent.builder().build()这句代码如何构建出DaggerAPPComponent的？</li><li>2、appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？</li><li>3、在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？</li></ul><p>下面我们逐个地来探索其中的奥妙~</p><h2 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="DaggerAppComponent-builder-build-是如何构建出DaggerAPPComponent的？"><a href="#DaggerAppComponent-builder-build-是如何构建出DaggerAPPComponent的？" class="headerlink" title="DaggerAppComponent.builder().build()是如何构建出DaggerAPPComponent的？"></a>DaggerAppComponent.builder().build()是如何构建出DaggerAPPComponent的？</h3><p>首先，看到DaggerAppComponent的builder()方法：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Builder <span class="hljs-title">builder</span>()</span> {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Builder();<br>}<br></code></pre></td></tr></tbody></table></figure><p>里面直接返回了一个新建的Builder静态内部类对象，看看它的构造方法中做了什么：</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Builder</span><span class="hljs-params">()</span> </span>{}<br>    <br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>看来，Builder的默认构造方法什么也没有做，那么，真正的实现肯定在Builder对象的build()方法中，接着看到build()方法。</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {<br><br>    ...<br> <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> AppComponent <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>{<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">DaggerAppComponent</span>(<span class="hljs-keyword">this</span>);<br>    }<br><br>    ...<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>在Builder的build()方法中直接返回了新建的DaggerAppComponent对象。下面，看看DaggerAppComponent的构造方法:</p><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">private <span class="hljs-built_in">DaggerAppComponent</span>(Builder builder) {<br>    <span class="hljs-built_in">initialize</span>(builder);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在DaggerAppComponent的构造方法中调用了initialize方法，顾名思义，它就是真正初始化项目全局依赖配置的地方了，下面，来看看它内部的实现：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">final Builder builder</span>) {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainActivitySubcomponentBuilderProvider</span> =<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Provider</span>&lt;<br>            <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector.<span class="hljs-property">MainActivitySubcomponent</span><br>                .<span class="hljs-property">Builder</span>&gt;() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector.<span class="hljs-property">MainActivitySubcomponent</span><br>                .<span class="hljs-property">Builder</span><br>            <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) {<br>                <span class="hljs-comment">// 2</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainActivitySubcomponentBuilder</span>();<br>            }<br>        };<br><br>    <span class="hljs-comment">// 一系列xxxActivitySubcomponentBuilderProvider的创建赋值代码块</span><br>    ...<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，新建了一个mainActivit的子组件构造器实例提供者Provider。在注释2处，使用匿名内部类的方式重写了该Provider的get()<br>方法，返回一个新创建好的MainActivitySubcomponentBuilder对象。很显然，它就是负责创建管理MAinActivity中所需依赖的Subcomponent建造者。接下来重点来分析下MainActivitySubcomponentBuilder这个类的作用。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivitySubcomponentBuilder</span><br>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAllActivityModule_ContributesMainActivityInjector</span>.MainActivitySubcomponent<br>      .Builder {<br>    <span class="hljs-keyword">private</span> MainActivity seedInstance;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AbstractAllActivityModule_ContributesMainActivityInjector.MainActivitySubcomponent<br>        <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {<br>      <span class="hljs-keyword">if</span> (seedInstance == <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(MainActivity.class.getCanonicalName() + <span class="hljs-string">" must be set"</span>);<br>      }<br>      <span class="hljs-comment">// 2</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainActivitySubcomponentImpl</span>(<span class="hljs-built_in">this</span>);<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seedInstance</span><span class="hljs-params">(MainActivity arg0)</span> {<br>      <span class="hljs-comment">// 3</span><br>      <span class="hljs-built_in">this</span>.seedInstance = Preconditions.checkNotNull(arg0);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，MainActivitySubcomponentBuilder继承了AbstractAllActivityModule_ContributesMainActivityInjector内部的子组件MainActivitySubcomponent的内部的子组件建造者类Builder，如下所示：</p><figure class="highlight scala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-meta">@Subcomponent</span>(modules = <span class="hljs-type">MainActivityModule</span>.<span class="hljs-keyword">class</span>)<br>public interface <span class="hljs-type">MainActivitySubcomponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-type">AndroidInjector</span>&lt;<span class="hljs-type">MainActivity</span>&gt; {<br>    <span class="hljs-meta">@Subcomponent</span>.<span class="hljs-type">Builder</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span> <span class="hljs-keyword">extends</span></span><br>    <span class="hljs-type">AndroidInjector</span>.<span class="hljs-type">Builder</span>&lt;<span class="hljs-type">MainActivity</span>&gt; {}<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这个子组件建造者Builder又继承了AndroidInjector的抽象内部类Builder，那么，这个AndroidInjector到底是什么呢？</p><p>顾名思义，<strong>AndroidInjector</strong>是一个Android注射器，它**为每一个具体的子类型，即核心Android类型Activity和Fragment执行成员注入。<br>**</p><p>接下来分析下AndroidInjector的内部实现，源码如下所示：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">AndroidInjector</span>&lt;<span class="hljs-title">T</span>&gt; {<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">inject</span>(<span class="hljs-params">T instance</span>)</span>;<br>    <br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">interface</span> <span class="hljs-title">Factory</span>&lt;<span class="hljs-title">T</span>&gt; {<br>        <span class="hljs-function">AndroidInjector&lt;T&gt; <span class="hljs-title">create</span>(<span class="hljs-params">T instance</span>)</span>;<br>    }<br>    <br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">AndroidInjector.Factory</span>&lt;<span class="hljs-title">T</span>&gt; {<br>        @Override<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> final AndroidInjector&lt;T&gt; <span class="hljs-title">create</span>(<span class="hljs-params">T instance</span>)</span> {<br>            seedInstance(instance);<br>            <span class="hljs-keyword">return</span> build();<br>        }<br>    <br>        @BindsInstance<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">seedInstance</span>(<span class="hljs-params">T instance</span>)</span>;<br>    <br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> AndroidInjector&lt;T&gt; <span class="hljs-title">build</span>()</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，使用了抽象工厂模式，用来创建一个具体的Activity或Fragment类型的AndroidInjector实例。注释2处，Builder实现了AndroidInjector.Factory，它是一种Subcomponent.Builder的通用实现模式，在重写的create()<br>方法中，进行了实例保存seedInstance()和具体Android核心类型的构建。</p><p>接着，我们回到MainActivitySubcomponentBuilder类，可以看到，它实现了AndroidInjector.Builder的seedInstance()和build()<br>方法。在注释3处首先播种了MainActivity的实例，然后<br>在注释2处新建了一个MainActivitySubcomponentImpl对象返回。我们看看MainActivitySubcomponentImpl这个类是如何将mPresenter依赖注入的，相关源码如下：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> final <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivitySubcomponentImpl</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector<br>    .<span class="hljs-property">MainActivitySubcomponent</span> {<br>      <br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MainPresenter</span> <span class="hljs-title function_">getMainPresenter</span>(<span class="hljs-params"></span>) {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">MainPresenter</span>_Factory.<span class="hljs-title function_">newMainPresenter</span>(<br>        <span class="hljs-title class_">DaggerAppComponent</span>.<span class="hljs-property">this</span>.<span class="hljs-property">provideDataManagerProvider</span>.<span class="hljs-title function_">get</span>());<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params">MainActivity arg0</span>) {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-title function_">injectMainActivity</span>(arg0);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-title function_">injectMainActivity</span>(<span class="hljs-params">MainActivity instance</span>) {<br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-title class_">BaseActivity</span>_MembersInjector<br>        .<span class="hljs-title function_">injectMPresenter</span>(instance, <span class="hljs-title function_">getMainPresenter</span>());<br>        <span class="hljs-keyword">return</span> instance;<br>    }<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，MainActivitySubcomponentImpl实现了AndroidInjector接口的inject()方法，<strong>在injectMainActivity()<br>首先调用getMainPresenter()方法从MainPresenter_Factory工厂类中新建了一个MainPresenter对象</strong><br>。我们看看MainPresenter的newMainPresenter()方法：</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MainPresenter <span class="hljs-keyword">new</span><span class="hljs-type">MainPresenter</span>(DataManager dataManager) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">MainPresenter</span>(dataManager);<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里直接新建了一个MainPresenter。然后我们回到MainActivitySubcomponentImpl类的注释3处，继续调用了*<br><em>BaseActivity_MembersInjector的injectMPresenter()方法</em>*<br>，顾名思义，可以猜到，它是BaseActivity的成员注射器，继续看看injectMPresenter()内部：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPresenter</span>&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">injectMPresenter</span>(<span class="hljs-params"></span><br><span class="hljs-params">  BaseActivity&lt;T&gt; instance, T mPresenter</span>) {<br>    instance.<span class="hljs-property">mPresenter</span> = mPresenter;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里直接将需要的mPresenter实例赋值给了BaseActivity的mPresenter，当然，这里其实是指的BaseActivity的子类MainActivity，其它的xxxActivity的依赖管理机制都是如此。</p><h3 id="appComponent-inject-this-是如何将mAndroidInjector实例赋值给当前的Application的？"><a href="#appComponent-inject-this-是如何将mAndroidInjector实例赋值给当前的Application的？" class="headerlink" title="appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？"></a>appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？</h3><p>我们继续查看appComponent的inject()方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params">WanAndroidApp wanAndroidApp</span>) {<br>  <span class="hljs-title function_">injectWanAndroidApp</span>(wanAndroidApp);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在inject()方法里调用了injectWanAndroidApp()，继续查看injectWanAndroidApp()方法：</p><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">private</span> <span class="hljs-type">WanAndroidApp</span> injectWanAndroidApp(<span class="hljs-type">WanAndroidApp</span> <span class="hljs-keyword">instance</span>) {<br>    <span class="hljs-type">WanAndroidApp_MembersInjector</span>.injectMAndroidInjector(<br><span class="hljs-class">        <span class="hljs-keyword">instance</span>,</span><br><span class="hljs-class">        getDispatchingAndroidInjectorOfActivity());</span><br><span class="hljs-class">    return <span class="hljs-keyword">instance</span>;</span><br><span class="hljs-class">}</span><br></code></pre></td></tr></tbody></table></figure><p>首先，执行getDispatchingAndroidInjectorOfActivity()<br>方法得到了一个Activity类型的DispatchingAndroidInjector对象，继续查看getDispatchingAndroidInjectorOfActivity()方法：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> DispatchingAndroidInjector&lt;Activity&gt; <span class="hljs-title">getDispatchingAndroidInjectorOfActivity</span>()</span> {<br>    <span class="hljs-keyword">return</span> DispatchingAndroidInjector_Factory.newDispatchingAndroidInjector(<br>    getMapOfClassOfAndProviderOfFactoryOf());<br>}<br></code></pre></td></tr></tbody></table></figure><p>在getDispatchingAndroidInjectorOfActivity()方法里面，首先调用了getMapOfClassOfAndProviderOfFactoryOf()方法，我们看到这个方法：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> Map&lt;Class&lt;? extends Activity&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends Activity&gt;&gt;&gt;<br>  get<span class="hljs-constructor">MapOfClassOfAndProviderOfFactoryOf()</span> {<br>    return MapBuilder<br>        .&lt;Class&lt;? extends Activity&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends Activity&gt;&gt;&gt;<br>        <span class="hljs-keyword">new</span><span class="hljs-constructor">MapBuilder(8)</span><br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MainActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) mainActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SplashActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) splashActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ArticleDetailActivity</span>.</span></span><span class="hljs-keyword">class</span>,<br>            (Provider) articleDetailActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">KnowledgeHierarchyDetailActivity</span>.</span></span><span class="hljs-keyword">class</span>,<br>            (Provider) knowledgeHierarchyDetailActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LoginActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) loginActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RegisterActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) registerActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AboutUsActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) aboutUsActivitySubcomponentBuilderProvider)<br>        .put(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SearchListActivity</span>.</span></span><span class="hljs-keyword">class</span>, (Provider) searchListActivitySubcomponentBuilderProvider)<br>        .build<span class="hljs-literal">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里新建了一个建造者模式实现的MapBuilder，并且同时制定了固定容量为8，将项目下使用了AndroidInjection.inject(<br>mActivity)方法的8个Activity对应的xxxActivitySubcomponentBuilderProvider保存起来。</p><p>我们再回到getDispatchingAndroidInjectorOfActivity()<br>方法，这里将上面得到的Map容器传入了DispatchingAndroidInjector_Factory的newDispatchingAndroidInjector()<br>方法中，这里应该就是新建DispatchingAndroidInjector的地方了。我们点进去看看：</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">DispatchingAndroidInjector</span>&lt;<span class="hljs-type">T</span>&gt; newDispatchingAndroidInjector(<br>  <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">T</span>&gt;, <span class="hljs-type">Provider</span>&lt;<span class="hljs-type">AndroidInjector</span>.<span class="hljs-type">Factory</span>&lt;? extends <span class="hljs-type">T</span>&gt;&gt;&gt; injectorFactories) {<br>    <span class="hljs-keyword">return</span> new <span class="hljs-type">DispatchingAndroidInjector</span>&lt;<span class="hljs-type">T</span>&gt;(injectorFactories);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在这里，果然新建了一个DispatchingAndroidInjector对象。继续看看DispatchingAndroidInjector的构造方法：</p><figure class="highlight dart"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-meta">@Inject</span><br>DispatchingAndroidInjector(<br>  <span class="hljs-built_in">Map</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> T&gt;, Provider&lt;AndroidInjector.Factory&lt;? <span class="hljs-keyword">extends</span> T&gt;&gt;&gt; injectorFactories) {<br>    <span class="hljs-keyword">this</span>.injectorFactories = injectorFactories;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这里仅仅是将传进来的Map容器保存起来了。</p><p>我们再回到WanAndroidApp_MembersInjector的injectMAndroidInjector()<br>方法，将上面得到的DispatchingAndroidInjector实例传入，继续查看injectMAndroidInjector()这个方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">injectMAndroidInjector</span>(<span class="hljs-params"></span><br><span class="hljs-params">  WanAndroidApp instance, DispatchingAndroidInjector&lt;Activity&gt; mAndroidInjector</span>) {<br>    instance.<span class="hljs-property">mAndroidInjector</span> = mAndroidInjector;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，最后在WanAndroidApp_MembersInjector的injectMAndroidInjector()<br>方法中，直接将新建好的DispatchingAndroidInjector实例赋值给了WanAndroidApp的mAndroidInjector。</p><h3 id="在目标Activity下的AndroidInjection-inject-this-这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？"><a href="#在目标Activity下的AndroidInjection-inject-this-这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？" class="headerlink" title="在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？"></a>在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？</h3><p>首先，我们看到AndroidInjection.inject(this)这个方法：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-keyword">inject</span>(Activity activity) {<br>    checkNotNull(activity, <span class="hljs-string">"activity"</span>);<br>    <br>    <span class="hljs-comment">// 1</span><br>    Application application = activity.getApplication();<br>    <span class="hljs-keyword">if</span> (!(application <span class="hljs-keyword">instanceof</span> HasActivityInjector)) {<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>        String.format(<br>            <span class="hljs-string">"%s does not implement %s"</span>,<br>            application.getClass().getCanonicalName(), <br>            HasActivityInjector.<span class="hljs-keyword">class</span>.getCanonicalName()));<br>    }<br><br>    <span class="hljs-comment">// 2</span><br>    AndroidInjector&lt;Activity&gt; activityInjector =<br>        ((HasActivityInjector) application).activityInjector();<br>        <br>    checkNotNull(activityInjector, <span class="hljs-string">"%s.activityInjector() returned null"</span>, application.getClass());<br><br>    <span class="hljs-comment">// 3</span><br>    activityInjector.<span class="hljs-keyword">inject</span>(activity);<br></code></pre></td></tr></tbody></table></figure><p>}</p><p>在注释1处，会先判断当前的application是否实现了HasActivityInjector这个接口，如果没有，则抛出RuntimeException。如果有，会继续在注释2处调用application的activityInjector()<br>方法得到DispatchingAndroidInjector实例。最后，在注释3处，会将当前的activity实例传入activityInjector的inject()<br>方法中。我们继续查看inject()方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params">T instance</span>) {<br>    <span class="hljs-built_in">boolean</span> wasInjected = <span class="hljs-title function_">maybeInject</span>(instance);<br>    <span class="hljs-keyword">if</span> (!wasInjected) {<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-title function_">errorMessageSuggestions</span>(instance));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>DispatchingAndroidInjector的inject()方法，它的作用就是给传入的instance实例执行成员注入</strong><br>。具体在这个案例中，其实就是负责将创建好的Presenter实例赋值给BaseActivity对象 的mPresenter全局变量。在inject()<br>方法中，又调用了maybeInject()方法，我们继续查看它：</p><figure class="highlight dart"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-meta">@CanIgnoreReturnValue</span><br>public boolean maybeInject(T instance) {<br>    <span class="hljs-comment">// 1</span><br>    Provider&lt;AndroidInjector.Factory&lt;? <span class="hljs-keyword">extends</span> T&gt;&gt; factoryProvider =<br>    injectorFactories.<span class="hljs-keyword">get</span>(instance.getClass());<br>    <span class="hljs-keyword">if</span> (factoryProvider == <span class="hljs-keyword">null</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    }<br><br>    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)<br>    <span class="hljs-comment">// 2</span><br>    AndroidInjector.Factory&lt;T&gt; <span class="hljs-keyword">factory</span> = (AndroidInjector.Factory&lt;T&gt;) factoryProvider.<span class="hljs-keyword">get</span>();<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 3</span><br>        AndroidInjector&lt;T&gt; injector =<br>            checkNotNull(<br>                <span class="hljs-keyword">factory</span>.create(instance), <span class="hljs-string">"%s.create(I) should not return null."</span>, <span class="hljs-keyword">factory</span>.getClass());<br>        <span class="hljs-comment">// 4</span><br>        injector.inject(instance);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    } <span class="hljs-keyword">catch</span> (ClassCastException e) {<br>        ...<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，我们从injectorFactories（前面得到的Map容器）中根据当前Activity实例拿到了factoryProvider对象，这里我们具体一点，看到MainActivity对应的factoryProvider，也就是我们研究的第一个问题中的mainActivitySubcomponentBuilderProvider：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">final Builder builder</span>) {<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainActivitySubcomponentBuilderProvider</span> =<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Provider</span>&lt;<br>            <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector.<span class="hljs-property">MainActivitySubcomponent</span><br>            .<span class="hljs-property">Builder</span>&gt;() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector.<span class="hljs-property">MainActivitySubcomponent</span><br>                .<span class="hljs-property">Builder</span><br>            <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) {<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainActivitySubcomponentBuilder</span>();<br>            }<br>        };<br><br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>在maybeInject()方法的注释2处，调用了mainActivitySubcomponentBuilderProvider的get()<br>方法得到了一个新建的MainActivitySubcomponentBuilder对象。在注释3处执行了它的create方法，create()<br>方法的具体实现在AndroidInjector的内部类Builder中：</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Builder</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">AndroidInjector</span>.<span class="hljs-title">Factory</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> AndroidInjector&lt;T&gt; create(T instance) {<br>        seedInstance(instance);<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>;<br>    }<br></code></pre></td></tr></tbody></table></figure><p>看到这里，我相信看过第一个问题的同学已经明白后面是怎么回事了。在create()<br>方法中，我们首先MainActivitySubcomponentBuilder的seedInstance()将MainActivity实例注入，然后再调用它的build()<br>方法新建了一个MainActivitySubcomponentImpl实例返回。</p><p>最后，在注释4处，执行了MainActivitySubcomponentImpl的inject()方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> final <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivitySubcomponentImpl</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AbstractAllActivityModule</span>_ContributesMainActivityInjector<br>    .<span class="hljs-property">MainActivitySubcomponent</span> {<br>      <br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MainPresenter</span> <span class="hljs-title function_">getMainPresenter</span>(<span class="hljs-params"></span>) {<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">MainPresenter</span>_Factory.<span class="hljs-title function_">newMainPresenter</span>(<br>        <span class="hljs-title class_">DaggerAppComponent</span>.<span class="hljs-property">this</span>.<span class="hljs-property">provideDataManagerProvider</span>.<span class="hljs-title function_">get</span>());<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params">MainActivity arg0</span>) {<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-title function_">injectMainActivity</span>(arg0);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-title function_">injectMainActivity</span>(<span class="hljs-params">MainActivity instance</span>) {<br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-title class_">BaseActivity</span>_MembersInjector<br>        .<span class="hljs-title function_">injectMPresenter</span>(instance, <span class="hljs-title function_">getMainPresenter</span>());<br>        <span class="hljs-keyword">return</span> instance;<br>    }<br></code></pre></td></tr></tbody></table></figure><p>这里的逻辑已经在问题一的最后部分详细讲解了，最后，会在注释3处调用BaseActivity_MembersInjector的injectMPresenter()方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPresenter</span>&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">injectMPresenter</span>(<span class="hljs-params"></span><br><span class="hljs-params">  BaseActivity&lt;T&gt; instance, T mPresenter</span>) {<br>    instance.<span class="hljs-property">mPresenter</span> = mPresenter;<br>}<br></code></pre></td></tr></tbody></table></figure><p>这样，就将mPresenter对象赋值给了当前Activity对象的mPresenter全局变量中了。至此，Dagger.Android的核心源码分析就结束了。</p><blockquote><p>相比于ButterKnife，Dagger是一个<strong>锋利的全局依赖注入管理框架</strong>，它主要用来<strong>管理对象的依赖关系和生命周期</strong></p></blockquote><p>，当项目越来越大时，类之间的调用层次会越来越深，并且有些类是Activity或Fragment，有些是单例，而且它们的生命周期不一致，所以创建所需对象时需要处理的各个对象的依赖关系和生命周期时的任务会很繁重。因此，使用Dagger会大大减轻这方面的工作量。虽然它的学习成本比较高，而且需要写一定的模板类，但是，<br><strong>对于越大的项目来说，Dagger越值得被需要</strong>。</p><h1 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h1><h2 id="简单示例-3"><a href="#简单示例-3" class="headerlink" title="简单示例"></a>简单示例</h2><h3 id="首先，定义要传递的事件实体"><a href="#首先，定义要传递的事件实体" class="headerlink" title="首先，定义要传递的事件实体"></a>首先，定义要传递的事件实体</h3><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">CollectEvent</span> { ... }<br></code></pre></td></tr></tbody></table></figure><h3 id="准备订阅者：声明并注解你的订阅方法"><a href="#准备订阅者：声明并注解你的订阅方法" class="headerlink" title="准备订阅者：声明并注解你的订阅方法"></a>准备订阅者：声明并注解你的订阅方法</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Subscribe(threadMode = ThreadMode.MAIN)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessageEvent</span><span class="hljs-params">(CollectEvent event)</span> {<br>    LogHelper.d(<span class="hljs-string">"OK"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="在2中，也就是订阅中所在的类中，注册和解注册你的订阅者"><a href="#在2中，也就是订阅中所在的类中，注册和解注册你的订阅者" class="headerlink" title="在2中，也就是订阅中所在的类中，注册和解注册你的订阅者"></a>在2中，也就是订阅中所在的类中，注册和解注册你的订阅者</h3><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onStart</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onStart</span>();<br>    <span class="hljs-title class_">EventBus</span>.<span class="hljs-title function_">getDefault</span>().<span class="hljs-title function_">register</span>(<span class="hljs-variable language_">this</span>);<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onStop</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onStop</span>();<br>    <span class="hljs-title class_">EventBus</span>.<span class="hljs-title function_">getDefault</span>().<span class="hljs-title function_">unregister</span>(<span class="hljs-variable language_">this</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h3><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EventBus</span>.</span></span>get<span class="hljs-constructor">Default()</span>.post(<span class="hljs-keyword">new</span> <span class="hljs-constructor">CollectEvent()</span>);<br></code></pre></td></tr></tbody></table></figure><p>在正式讲解之前需要对一些基础性的概念进行详细的讲解。众所周知，EventBus没出现之前，那时候的开发者一般是使用Android四大组件中的广播进行组件间的消息传递，那么我们<br><strong>为什么要使用事件总线机制来替代广播呢</strong>？</p><p>主要是因为：</p><ul><li>广播：耗时、容易被捕获（不安全）。</li><li>事件总线：更节省资源、更高效，能将信息传递给原生以外的各种对象。</li></ul><p>那么，话又说回来了，<strong>事件总线又是什么呢？</strong></p><p>如下图所示，事件总线机制通过记录对象、使用观察者模式来通知对象各种事件。（当然，你也可以发送基本数据类型如 int，String<br>等作为一个事件）</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ada0907b50b75?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p><p>对于<strong>事件总线EventBus</strong>而言，它的<strong>优缺点</strong>又是如何？这里简单总结下：</p><ul><li>优点：开销小，代码更优雅、简洁，解耦发送者和接收者，可动态设置事件处理线程和优先级。</li><li>缺点：每个事件必须自定义一个事件类，增加了维护成本。</li></ul><p>EventBus是基于观察者模式扩展而来的，我们先了解一下观察者模式是什么？</p><p>观察者模式又可称为<strong>发布 - 订阅模式</strong>，它定义了对象间的一种1对多的依赖关系，每当这个对象的状态改变时，其它的对象都会接收到通知并被自动更新。</p><p>观察者模式有以下角色：</p><ul><li>抽象被观察者：将所有已注册的观察者对象保存在一个集合中。</li><li>具体被观察者：当内部状态发生变化时，将会通知所有已注册的观察者。</li><li>抽象观察者：定义了一个更新接口，当被观察者状态改变时更新自己。</li><li>具体观察者：实现抽象观察者的更新接口。</li></ul><p>这里给出一个简单的示例来让大家更深一步理解观察者模式的思想：</p><p>1、首先，创建抽象观察者</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-symbol">observer</span> {<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> update(String message);<br>}<br></code></pre></td></tr></tbody></table></figure><p>2、接着，创建具体观察者</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeXinUser</span> <span class="hljs-keyword">implements</span> observer {<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">WeXinUser</span>(<span class="hljs-title class_">String</span> name) {<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {<br>        ...<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>3、然后，创建抽象被观察者</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> interface observable {<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">addWeXinUser</span><span class="hljs-params">(WeXinUser weXinUser)</span></span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">removeWeXinUser</span><span class="hljs-params">(WeXinUser weXinUser)</span></span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">notify</span><span class="hljs-params">(<span class="hljs-type">String</span> message)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>4、最后，创建具体被观察者</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Subscription</span> <span class="hljs-keyword">implements</span> observable {<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">WeXinUser</span>&gt; mUserList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addWeXinUser</span>(<span class="hljs-params">WeXinUser weXinUser</span>) {<br>        mUserList.<span class="hljs-title function_">add</span>(weXinUser);<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeWeXinUser</span>(<span class="hljs-params">WeXinUser weXinUser</span>) {<br>        mUserList.<span class="hljs-title function_">remove</span>(weXinUser);<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">notify</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {<br>        <span class="hljs-keyword">for</span>(<span class="hljs-title class_">WeXinUser</span> weXinUser : mUserList) {<br>            weXinUser.<span class="hljs-title function_">update</span>(message);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在具体使用时，我们便可以这样使用，如下所示：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Subscription subscription = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Subscription()</span>;<br><br>WeXinUser hongYang = <span class="hljs-keyword">new</span> <span class="hljs-constructor">WeXinUser(<span class="hljs-string">"HongYang"</span>)</span>;<br>WeXinUser rengYuGang = <span class="hljs-keyword">new</span> <span class="hljs-constructor">WeXinUser(<span class="hljs-string">"RengYuGang"</span>)</span>;<br>WeXinUser liuWangShu = <span class="hljs-keyword">new</span> <span class="hljs-constructor">WeXinUser(<span class="hljs-string">"LiuWangShu"</span>)</span>;<br><br>subscription.add<span class="hljs-constructor">WeiXinUser(<span class="hljs-params">hongYang</span>)</span>;<br>subscription.add<span class="hljs-constructor">WeiXinUser(<span class="hljs-params">rengYuGang</span>)</span>;<br>subscription.add<span class="hljs-constructor">WeiXinUser(<span class="hljs-params">liuWangShu</span>)</span>;<br>subscription.notify(<span class="hljs-string">"New article coming"</span>);<br></code></pre></td></tr></tbody></table></figure><p>在这里，hongYang、rengYuGang、liuWangShu等大神都订阅了我的微信公众号，每当我的公众号发表文章时（subscription.notify())<br>，他们就会接收到最新的文章信息（weXinUser.update()）。（ps：当然，这一切都是YY~）</p><p>当然，EventBus的观察者模式和一般的观察者模式不同，它使用了**扩展的观察者模式对事件进行订阅和分发，其实这里的扩展就是指的使用了EventBus来作为中介者，抽离了许多职责<br>**，如下是它的官方原理图：</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/6/170ada0907c082ed?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p><p>在得知了EventBus的原理之后，我们注意到，每次我们在register之后，都必须进行一次unregister，这是为什么呢？</p><p><strong>因为register是强引用，它会让对象无法得到内存回收，导致内存泄露。所以必须在unregister方法中释放对象所占的内存</strong>。</p><p>有些同学可能之前使用的是EventBus2.x的版本，那么它又与EventBus3.x的版本有哪些区别呢？</p><ol><li><p>EventBus2.x使用的是**运行时注解，它采用了反射的方式对整个注册的类的所有方法进行扫描来完成注册，因而会对性能有一定影响<br>**。</p></li><li><p>EventBus3.x使用的是*</p><ul><li>编译时注解，Java文件会编译成.class文件，再对class文件进行打包等一系列处理。在编译成.class文件时，EventBus会使用EventBusAnnotationProcessor注解处理器读取@Subscribe()<br>注解并解析、处理其中的信息，然后生成Java类来保存所有订阅者的订阅信息。这样就创建出了对文件或类的索引关系，并将其编入到apk中<br>**。</li></ul></li><li><p>从EventBus3.0开始<strong>使用了对象池缓存减少了创建对象的开销</strong>。</p></li></ol><p>除了EventBus，其实现在比较流行的事件总线还有RxBus，那么，它与EventBus相比又如何呢？</p><ol><li><p><strong>RxJava的Observable有onError、onComplete等状态回调</strong>。</p></li><li><p><strong>Rxjava使用组合而非嵌套的方式，避免了回调地狱</strong>。</p></li><li><p><strong>Rxjava的线程调度设计的更加优秀，更简单易用</strong>。</p></li><li><p><strong>Rxjava可使用多种操作符来进行链式调用来实现复杂的逻辑</strong>。</p></li><li><p><strong>Rxjava的信息效率高于EventBus2.x，低于EventBus3.x</strong>。</p></li></ol><p>在了解了EventBus和RxBus的区别之后，那么，对待新项目的事件总线选型时，我们该如何考量？</p><p>很简单，<strong>如果项目中使用了RxJava，则使用RxBus，否则使用EventBus3.x</strong>。</p><h2 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h2><p>接下来将按以下顺序来进行EventBus的源码分析：</p><ol><li><p>订阅者：EventBus.getDefault().register(this)；</p></li><li><p>发布者：EventBus.getDefault().post(new CollectEvent())；</p></li><li><p>订阅者：EventBus.getDefault().unregister(this)。</p></li></ol><h3 id="EventBus-getDefault-register-this"><a href="#EventBus-getDefault-register-this" class="headerlink" title="EventBus.getDefault().register(this)"></a>EventBus.getDefault().register(this)</h3><p>首先，从获取EventBus实例的方法getDefault()开始分析：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EventBus <span class="hljs-title">getDefault</span>()</span> {<br>    <span class="hljs-keyword">if</span> (defaultInstance == <span class="hljs-literal">null</span>) {<br>        synchronized (EventBus.<span class="hljs-keyword">class</span>) {<br>            <span class="hljs-keyword">if</span> (defaultInstance == <span class="hljs-literal">null</span>) {<br>                defaultInstance = <span class="hljs-keyword">new</span> EventBus();<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">return</span> defaultInstance;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在getDefault()中使用了双重校验并加锁的单例模式来创建EventBus实例。</p><p>接着，看到EventBus的默认构造方法中做了什么:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">EventBusBuilder</span> <span class="hljs-variable">DEFAULT_BUILDER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventBusBuilder</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">EventBus</span><span class="hljs-params">()</span> {<br>    <span class="hljs-built_in">this</span>(DEFAULT_BUILDER);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在EventBus的默认构造方法中又调用了它的另一个有参构造方法，将一个类型为EventBusBuilder的DEFAULT_BUILDER对象传递进去了。这里的EventBusBuilder很明显是一个EventBus的建造器，以便于EventBus能够添加自定义的参数和安装一个自定义的默认EventBus实例。</p><p>再看一下EventBusBuilder的构造方法：</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">EventBusBuilder</span> {<br><br>    ...<br><br>    EventBusBuilder() {<br>    }<br>    <br>    ...<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><p>EventBusBuilder的构造方法中什么也没有做，那继续查看EventBus的这个有参构造方法：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-keyword">Class</span>&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Object, List&lt;<span class="hljs-keyword">Class</span>&lt;?&gt;&gt;&gt; typesBySubscriber;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-keyword">Class</span>&lt;?&gt;, Object&gt; stickyEvents;<br><br>EventBus(EventBusBuilder builder) {<br>    ...<br>    <br>    <span class="hljs-comment">// 1</span><br>    subscriptionsByEventType = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 2</span><br>    typesBySubscriber = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 3</span><br>    stickyEvents = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 4</span><br>    mainThreadSupport = builder.getMainThreadSupport();<br>    mainThreadPoster = mainThreadSupport != <span class="hljs-keyword">null</span> ? mainThreadSupport.createPoster(<span class="hljs-keyword">this</span>) : <span class="hljs-keyword">null</span>;<br>    backgroundPoster = <span class="hljs-keyword">new</span> BackgroundPoster(<span class="hljs-keyword">this</span>);<br>    asyncPoster = <span class="hljs-keyword">new</span> AsyncPoster(<span class="hljs-keyword">this</span>);<br>    <br>    ...<br>    <br>    <span class="hljs-comment">// 5</span><br>    subscriberMethodFinder = <span class="hljs-keyword">new</span> SubscriberMethodFinder(builder.subscriberInfoIndexes,<br>            builder.strictMethodVerification, builder.ignoreGeneratedIndex);<br>   <br>    <span class="hljs-comment">// 从builder取中一些列订阅相关信息进行赋值</span><br>    ...<br>   <br>    <span class="hljs-comment">// 6</span><br>    executorService = builder.executorService;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，创建了一个subscriptionsByEventType对象，可以看到它是一个类型为HashMap的subscriptionsByEventType对象，并且其key为<br>Event 类型，value为 Subscription链表。这里的Subscription是一个订阅信息对象，它里面保存了两个重要的字段，一个是类型为 Object<br>的 subscriber，该字段即为注册的对象（在 Android 中时通常是 Activity对象）；另一个是 类型为SubscriberMethod 的<br>subscriberMethod，它就是被@Subscribe注解的那个订阅方法，里面保存了一个重要的字段eventType，它是 Class&lt;?&gt; 类型的，代表了<br>Event 的类型。在注释2处，新建了一个类型为 Map 的typesBySubscriber对象，它的key为subscriber对象，value为subscriber对象中所有的<br>Event<br>类型链表，日常使用中仅用于判断某个对象是否注册过。在注释3处新建了一个类型为ConcurrentHashMap的stickyEvents对象，它是专用于粘性事件处理的一个字段，key为事件的Class对象，value为当前的事件。可能有的同学不了解sticky<br>event，这里解释下：</p><ul><li>我们都知道**普通事件是先注册，然后发送事件才能收到；而粘性事件，在发送事件之后再订阅该事件也能收到。并且，粘性事件会保存在内存中，每次进入都会去内存中查找获取最新的粘性事件，除非你手动解除注册<br>**。</li></ul><p>在注释4处，新建了三个不同类型的事件发送器，这里总结下：</p><ul><li>mainThreadPoster：主线程事件发送器，通过它的mainThreadPoster.enqueue(subscription, event)方法可以将订阅信息和对应的事件进行入队，然后通过<br>handler 去发送一个消息，在 handler 的 handleMessage 中去执行方法。</li><li>backgroundPoster：后台事件发送器，通过它的enqueue() 将方法加入到后台的一个队列，最后通过线程池去执行，注意，它在<br>Executor的execute()方法 上添加了 synchronized关键字 并设立 了控制标记flag，保证任一时间只且仅能有一个任务会被线程池执行。</li><li>asyncPoster：实现逻辑类似于backgroundPoster，不同于backgroundPoster的保证任一时间只且仅能有一个任务会被线程池执行的特性，asyncPoster则是异步运行的，可以同时接收多个任务。</li></ul><p>我们再回到注释5这行代码，这里新建了一个subscriberMethodFinder对象，这是从EventBus中抽离出的订阅方法查询的一个对象，在优秀的源码中，我们经常能看到<br><strong>组合优于继承</strong>的这种实现思想。在注释6处，从builder中取出了一个默认的线程池对象，它由**Executors的newCachedThreadPool()*<br>*方法创建，它是一个**有则用、无则创建、无数量上限**的线程池。</p><p>分析完这些核心的字段之后，后面的讲解就比较轻松了，接着查看EventBus的regist()方法：</p><figure class="highlight wren"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-variable">public</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">Object</span> <span class="hljs-params">subscriber</span>) {<br>    <span class="hljs-title class_">Class</span><span class="hljs-operator">&lt;</span>?<span class="hljs-operator">&gt;</span> <span class="hljs-variable">subscriberClass</span> <span class="hljs-operator">=</span> <span class="hljs-variable">subscriber</span>.<span class="hljs-property">getClass</span>();<br>    <br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-title class_">List</span><span class="hljs-operator">&lt;</span><span class="hljs-title class_">SubscriberMethod</span><span class="hljs-operator">&gt;</span> <span class="hljs-variable">subscriberMethods</span> <span class="hljs-operator">=</span> <span class="hljs-variable">subscriberMethodFinder</span>.<span class="hljs-property">findSubscriberMethods</span>(<span class="hljs-variable">subscriberClass</span>);<br>    <span class="hljs-title function_">synchronized</span> (<span class="hljs-variable language_">this</span>) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">SubscriberMethod</span> <span class="hljs-variable">subscriberMethod</span> : <span class="hljs-variable">subscriberMethods</span>) {<br>            <span class="hljs-comment">// 2</span><br>            <span class="hljs-title function_">subscribe</span>(<span class="hljs-variable">subscriber</span>, <span class="hljs-variable">subscriberMethod</span>);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，根据当前注册类获取 subscriberMethods这个订阅方法列表 。在注释2处，使用了增强for循环令subsciber对象 对<br>subscriberMethods 中每个 SubscriberMethod 进行订阅。</p><p>接着查看SubscriberMethodFinder的findSubscriberMethods()方法：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function">List&lt;SubscriberMethod&gt; <span class="hljs-title">findSubscriberMethods</span>(<span class="hljs-params">Class&lt;?&gt; subscriberClass</span>)</span> {<br>    <span class="hljs-comment">// 1</span><br>    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.<span class="hljs-keyword">get</span>(subscriberClass);<br>    <span class="hljs-keyword">if</span> (subscriberMethods != <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">return</span> subscriberMethods;<br>    }<br><br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">if</span> (ignoreGeneratedIndex) {<br>        subscriberMethods = findUsingReflection(subscriberClass);<br>    } <span class="hljs-keyword">else</span> {<br>        subscriberMethods = findUsingInfo(subscriberClass);<br>    }<br>    <span class="hljs-keyword">if</span> (subscriberMethods.isEmpty()) {<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> EventBusException(<span class="hljs-string">"Subscriber "</span> + subscriberClass<br>                + <span class="hljs-string">" and its super classes have no public methods with the @Subscribe annotation"</span>);<br>    } <span class="hljs-keyword">else</span> {<br>        METHOD_CACHE.put(subscriberClass, subscriberMethods);<br>        <span class="hljs-keyword">return</span> subscriberMethods;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，如果缓存中有subscriberClass对象对应 的订阅方法列表，则直接返回。注释2处，先详细说说这个<strong>ignoreGeneratedIndex</strong><br>字段， 它用来<strong>判断是否使用生成的 APT 代码去优化寻找接收事件的过程，如果开启了的话，那么将会通过 subscriberInfoIndexes<br>来快速得到接收事件方法的相关信息</strong>。如果我们没有在项目中接入 EventBus 的 APT，那么可以将 ignoreGeneratedIndex 字段设为<br>false 以提高性能。这里ignoreGeneratedIndex 默认为false，所以会执行findUsingInfo()方法，后面生成 subscriberMethods<br>成功的话会加入到缓存中，失败的话会 抛出异常。</p><p>接着查看SubscriberMethodFinder的findUsingInfo()方法：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> List&lt;SubscriberMethod&gt; find<span class="hljs-constructor">UsingInfo(Class&lt;?&gt; <span class="hljs-params">subscriberClass</span>)</span> {<br>    <span class="hljs-comment">// 1</span><br>    FindState findState = prepare<span class="hljs-constructor">FindState()</span>;<br>    findState.init<span class="hljs-constructor">ForSubscriber(<span class="hljs-params">subscriberClass</span>)</span>;<br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">while</span> (findState.clazz != null) {<br>        findState.subscriberInfo = get<span class="hljs-constructor">SubscriberInfo(<span class="hljs-params">findState</span>)</span>;<br>        <span class="hljs-keyword">if</span> (findState.subscriberInfo != null) {<br>            SubscriberMethod<span class="hljs-literal">[]</span> <span class="hljs-built_in">array</span> = findState.subscriberInfo.get<span class="hljs-constructor">SubscriberMethods()</span>;<br>            <span class="hljs-keyword">for</span> (SubscriberMethod subscriberMethod: <span class="hljs-built_in">array</span>) {<br>                <span class="hljs-keyword">if</span> (findState.check<span class="hljs-constructor">Add(<span class="hljs-params">subscriberMethod</span>.<span class="hljs-params">method</span>, <span class="hljs-params">subscriberMethod</span>.<span class="hljs-params">eventType</span>)</span>) {<br>                    findState.subscriberMethods.add(subscriberMethod);<br>                }<br>            }<br>        } <span class="hljs-keyword">else</span> {<br>             <span class="hljs-comment">// 3</span><br>             find<span class="hljs-constructor">UsingReflectionInSingleClass(<span class="hljs-params">findState</span>)</span>;<br>        }<br>        findState.move<span class="hljs-constructor">ToSuperclass()</span>;<br>    }<br>    <span class="hljs-comment">// 4</span><br>    return get<span class="hljs-constructor">MethodsAndRelease(<span class="hljs-params">findState</span>)</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，调用了SubscriberMethodFinder的prepareFindState()方法创建了一个新的 FindState 类，来看看这个方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FindState[] FIND_STATE_POOL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FindState</span>[POOL_SIZE];<br><span class="hljs-keyword">private</span> FindState <span class="hljs-title function_">prepareFindState</span><span class="hljs-params">()</span> {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">synchronized</span>(FIND_STATE_POOL) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {<br>            <span class="hljs-type">FindState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> FIND_STATE_POOL[i];<br>            <span class="hljs-keyword">if</span> (state != <span class="hljs-literal">null</span>) {<br>                FIND_STATE_POOL[i] = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">return</span> state;<br>            }<br>        }<br>    }<br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FindState</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，会先从 FIND_STATE_POOL 即 FindState 池中取出可用的 FindState（这里的POOL_SIZE为4），如果没有的话，则通过注释2处的代码直接新建<br>一个新的 FindState 对象。</p><p>接着来分析下FindState这个类：</p><figure class="highlight wren"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FindState</span> {<br>    <span class="hljs-operator">...</span>.<br>    <span class="hljs-variable">void</span> <span class="hljs-title function_">initForSubscriber</span>(<span class="hljs-params">Class</span>&lt;?&gt; <span class="hljs-params">subscriberClass</span>) {<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriberClass</span> <span class="hljs-operator">=</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-variable">subscriberClass</span>;<br>        <span class="hljs-variable">skipSuperClasses</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-variable">subscriberInfo</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    }<br>    <span class="hljs-operator">...</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>它是 SubscriberMethodFinder 的内部类，这个方法主要做一个初始化、回收对象等工作。</p><p>接着回到SubscriberMethodFinder的注释2处的SubscriberMethodFinder()方法：</p><figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">private</span> SubscriberInfo getSubscriberInfo(FindState findState) {<br>    <span class="hljs-attribute">if</span> (findState.subscriberInfo != null &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != null) {<br>        <span class="hljs-attribute">SubscriberInfo</span> superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo();<br>        <span class="hljs-attribute">if</span> (findState.clazz == superclassInfo.getSubscriberClass()) {<br>            <span class="hljs-attribute">return</span> superclassInfo;<br>        }<br>    }<br>    <span class="hljs-attribute">if</span> (subscriberInfoIndexes != null) {<br>        <span class="hljs-attribute">for</span> (SubscriberInfoIndex index: subscriberInfoIndexes) {<br>            <span class="hljs-attribute">SubscriberInfo</span> <span class="hljs-literal">info</span> = index.getSubscriberInfo(findState.clazz);<br>            <span class="hljs-attribute">if</span> (<span class="hljs-literal">info</span> != null) {<br>                <span class="hljs-attribute">return</span> <span class="hljs-literal">info</span>;<br>            }<br>        }<br>    }<br>    <span class="hljs-attribute">return</span> null;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在前面初始化的时候，findState的subscriberInfo和subscriberInfoIndexes 这两个字段为空，所以这里直接返回 null。</p><p>接着查看注释3处的findUsingReflectionInSingleClass()方法：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void find<span class="hljs-constructor">UsingReflectionInSingleClass(FindState <span class="hljs-params">findState</span>)</span> {<br>    Method<span class="hljs-literal">[]</span> methods;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span><br>        methods = findState.clazz.get<span class="hljs-constructor">DeclaredMethods()</span>;<br>    } catch (Throwable th) {<br>        methods = findState.clazz.get<span class="hljs-constructor">Methods()</span>;<br>        findState.skipSuperClasses = <span class="hljs-literal">true</span>;<br>    }<br>    <span class="hljs-keyword">for</span> (Method <span class="hljs-keyword">method</span>: methods) {<br>        <span class="hljs-built_in">int</span> modifiers = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">Modifiers()</span>;<br>        <span class="hljs-keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="hljs-number">0</span><span class="hljs-operator"> &amp;&amp; </span>(modifiers &amp; MODIFIERS_IGNORE)<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) {<br>            Class&lt;?&gt; <span class="hljs-literal">[]</span> parameterTypes = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">ParameterTypes()</span>;<br>            <span class="hljs-keyword">if</span> (parameterTypes.length<span class="hljs-operator"> == </span><span class="hljs-number">1</span>) {<br>                Subscribe subscribeAnnotation = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">Annotation(Subscribe.<span class="hljs-params">class</span>)</span>;<br>                <span class="hljs-keyword">if</span> (subscribeAnnotation != null) {<br>                    <span class="hljs-comment">// 重点</span><br>                    Class&lt;?&gt; eventType = parameterTypes<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>;<br>                    <span class="hljs-keyword">if</span> (findState.check<span class="hljs-constructor">Add(<span class="hljs-params">method</span>, <span class="hljs-params">eventType</span>)</span>) {<br>                        ThreadMode threadMode = subscribeAnnotation.thread<span class="hljs-constructor">Mode()</span>;<br>                        findState.subscriberMethods.add(<span class="hljs-keyword">new</span> <span class="hljs-constructor">SubscriberMethod(<span class="hljs-params">method</span>, <span class="hljs-params">eventType</span>, <span class="hljs-params">threadMode</span>, <span class="hljs-params">subscribeAnnotation</span>.<span class="hljs-params">priority</span>()</span>,  subscribeAnnotation.sticky<span class="hljs-literal">()</span>));<br>                    }<br>                }<br>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strictMethodVerification<span class="hljs-operator"> &amp;&amp;     </span><span class="hljs-keyword">method</span>.is<span class="hljs-constructor">AnnotationPresent(Subscribe.<span class="hljs-params">class</span>)</span>) {<br>            String methodName = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">DeclaringClass()</span>.get<span class="hljs-constructor">Name()</span> + <span class="hljs-string">"."</span> + <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">Name()</span>;<br>            throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">EventBusException(<span class="hljs-string">"@Subscribe method "</span> + <span class="hljs-params">methodName</span> + <span class="hljs-string">"must have exactly 1 parameter but has "</span> + <span class="hljs-params">parameterTypes</span>.<span class="hljs-params">length</span>)</span>;<br>            }<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strictMethodVerification<span class="hljs-operator"> &amp;&amp; </span><span class="hljs-keyword">method</span>.is<span class="hljs-constructor">AnnotationPresent(Subscribe.<span class="hljs-params">class</span>)</span>) {<br>            String methodName = <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">DeclaringClass()</span>.get<span class="hljs-constructor">Name()</span> + <span class="hljs-string">"."</span> + <span class="hljs-keyword">method</span>.get<span class="hljs-constructor">Name()</span>;<br>            throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">EventBusException(<span class="hljs-params">methodName</span> + <span class="hljs-string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>)</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>这个方法很长，大概做的事情是：</p><ol><li><p><strong>通过反射的方式获取订阅者类中的所有声明方法，然后在这些方法里面寻找以 @Subscribe作为注解的方法进行处理</strong>。</p></li><li><p><strong>在经过经过一轮检查，看看 findState.subscriberMethods是否存在，如果没有，将方法名，threadMode，优先级，是否为 sticky<br>方法等信息封装到 SubscriberMethod 对象中，最后添加到 subscriberMethods 列表中</strong>。</p></li></ol><p>最后，继续查看注释4处的getMethodsAndRelease()方法：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SubscriberMethod</span>&gt; <span class="hljs-title function_">getMethodsAndRelease</span>(<span class="hljs-params">FindState findState</span>) {<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SubscriberMethod</span>&gt; subscriberMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(findState.<span class="hljs-property">subscriberMethods</span>);<br>    <span class="hljs-comment">// 2</span><br>    findState.<span class="hljs-title function_">recycle</span>();<br>    <span class="hljs-comment">// 3</span><br>    <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">FIND_STATE_POOL</span>) {<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">POOL_SIZE</span>; i++) {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">FIND_STATE_POOL</span>[i] == <span class="hljs-literal">null</span>) {<br>                <span class="hljs-variable constant_">FIND_STATE_POOL</span>[i] = findState;<br>                <span class="hljs-keyword">break</span>;<br>            }<br>        }<br>    }<br>    <span class="hljs-comment">// 4</span><br>    <span class="hljs-keyword">return</span> subscriberMethods;<br>}<br></code></pre></td></tr></tbody></table></figure><p>在这里，首先在注释1处，从findState中取出了保存的subscriberMethods。在注释2处，将findState里的保存的所有对象进行回收。在注释3处，把findState存储在<br>FindState 池中方便下一次使用，以提高性能。最后，在注释4处，返回subscriberMethods。接着，<strong>在EventBus的 register() 方法的最后会调用<br>subscribe 方法</strong>：</p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">public void register(Object <span class="hljs-keyword">subscriber) </span>{<br>    Class&lt;?&gt; <span class="hljs-keyword">subscriberClass </span>= <span class="hljs-keyword">subscriber.getClass();</span><br><span class="hljs-keyword"></span>    List&lt;<span class="hljs-keyword">SubscriberMethod&gt; </span><span class="hljs-keyword">subscriberMethods </span>= <span class="hljs-keyword">subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="hljs-keyword"></span>    <span class="hljs-keyword">synchronized </span>(this) {<br>        for (<span class="hljs-keyword">SubscriberMethod </span><span class="hljs-keyword">subscriberMethod </span>: <span class="hljs-keyword">subscriberMethods) </span>{<br>            <span class="hljs-keyword">subscribe(subscriber, </span><span class="hljs-keyword">subscriberMethod);</span><br><span class="hljs-keyword"></span>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>继续看看这个subscribe()方法做的事情：</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">private</span> void subscribe(Object subscriber, SubscriberMethod subscriberMethod) {<br>    Class&lt;?&gt; eventType = subscriberMethod.eventType;<br>    Subscription <span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">Subscription</span>(subscriber, subscriberMethod);<br>    <br>    <span class="hljs-comment">// 1</span><br>    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.<span class="hljs-keyword">get</span>(eventType);<br>    <span class="hljs-keyword">if</span> (subscriptions == <span class="hljs-literal">null</span>) {<br>        subscriptions = <span class="hljs-keyword">new</span> <span class="hljs-type">CopyOnWriteArrayList</span> &lt;&gt; ();<br>        subscriptionsByEventType.put(eventType, subscriptions);<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">if</span> (subscriptions.contains(<span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span>)) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">EventBusException</span>(<span class="hljs-string">"Subscriber "</span> + subscriber.getClass() + <span class="hljs-string">" already registered to event "</span> + eventType);<br>        }<br>    }<br>    int size = subscriptions.size();<br>    <br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt;= size; i++) {<br>        <span class="hljs-keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.<span class="hljs-keyword">get</span>(i).subscriberMethod.priority) {<br>            subscriptions.add(i, <span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span>);<br>            <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>    <br>    <span class="hljs-comment">// 3</span><br>    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.<span class="hljs-keyword">get</span>(subscriber);<br>    <span class="hljs-keyword">if</span> (subscribedEvents == <span class="hljs-literal">null</span>) {<br>        subscribedEvents = <span class="hljs-keyword">new</span> <span class="hljs-type">ArrayList</span>&lt;&gt;();<br>        typesBySubscriber.put(subscriber, subscribedEvents);<br>    }<br>    subscribedEvents.add(eventType);<br>    <span class="hljs-comment">// 4</span><br>    <span class="hljs-keyword">if</span> (subscriberMethod.sticky) {<br>        <span class="hljs-keyword">if</span> (eventInheritance) {<br>            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : <span class="hljs-type">entries</span>) {<br>                Class&lt;?&gt; candidateEventType = entry.getKey();<br>                <span class="hljs-keyword">if</span>(eventType.isAssignableFrom(candidateEventType)) {<br>                Object stickyEvent = entry.getValue();<br>                    checkPostStickyEventToSubscription(<span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span>, stickyEvent);<br>                }<br>            }<br>        } <span class="hljs-keyword">else</span> {<br>            Object stickyEvent = stickyEvents.<span class="hljs-keyword">get</span>(eventType);<br>            checkPostStickyEventToSubscription(<span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span>, stickyEvent);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，会根据 subscriberMethod的eventType，在 subscriptionsByEventType 去查找一个 CopyOnWriteArrayList<br>，如果没有则创建一个新的 CopyOnWriteArrayList，然后将这个 CopyOnWriteArrayList 放入 subscriptionsByEventType 中。在注释2处，<br><strong>添加 newSubscription对象，它是一个 Subscription 类，里面包含着 subscriber 和 subscriberMethod<br>等信息，并且这里有一个优先级的判断，说明它是按照优先级添加的。优先级越高，会插到在当前 List 靠前面的位置</strong><br>。在注释3处，对typesBySubscriber 进行添加，这主要是在EventBus的isRegister()方法中去使用的，目的是用来判断这个 Subscriber对象<br>是否已被注册过。最后，在注释4处，会判断是否是 sticky事件。如果是sticky事件的话，会调用 checkPostStickyEventToSubscription()<br>方法。</p><p>接着查看这个checkPostStickyEventToSubscription()方法：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void check<span class="hljs-constructor">PostStickyEventToSubscription(Subscription <span class="hljs-params">newSubscription</span>, Object <span class="hljs-params">stickyEvent</span>)</span> {<br>    <span class="hljs-keyword">if</span> (stickyEvent != null) {<br>        post<span class="hljs-constructor">ToSubscription(<span class="hljs-params">newSubscription</span>, <span class="hljs-params">stickyEvent</span>, <span class="hljs-params">isMainThread</span>()</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到最终是<strong>调用了postToSubscription()这个方法来进行粘性事件的发送</strong>，对于粘性事件的处理，最后再分析，接下来看看事件是如何post的。</p><h3 id="EventBus-getDefault-post-new-CollectEvent"><a href="#EventBus-getDefault-post-new-CollectEvent" class="headerlink" title="EventBus.getDefault().post(new CollectEvent())"></a>EventBus.getDefault().post(new CollectEvent())</h3><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">post</span>(<span class="hljs-params">Object <span class="hljs-keyword">event</span></span>)</span> {<br>    <span class="hljs-comment">// 1</span><br>    PostingThreadState postingState = currentPostingThreadState.<span class="hljs-keyword">get</span>();<br>    List &lt;Object&gt; eventQueue = postingState.eventQueue;<br>    eventQueue.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">event</span>);<br>    <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">if</span> (!postingState.isPosting) {<br>        postingState.isMainThread = isMainThread();<br>        postingState.isPosting = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (postingState.canceled) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> EventBusException(<span class="hljs-string">"Internal error. Abort state was not reset"</span>);<br>        }<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">while</span> (!eventQueue.isEmpty()) {<br>                postSingleEvent(eventQueue.<span class="hljs-keyword">remove</span>(<span class="hljs-number">0</span>), postingState);<br>            }<br>        } <span class="hljs-keyword">finally</span> {<br>            postingState.isPosting = <span class="hljs-literal">false</span>;<br>            postingState.isMainThread = <span class="hljs-literal">false</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>注释1处，这里的currentPostingThreadState 是一个 ThreadLocal 类型的对象，里面存储了 PostingThreadState，而<br>PostingThreadState 中包含了一个 eventQueue 和其他一些标志位，相关的源码如下：</p><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadLocal &lt;PostingThreadState&gt; currentPostingThreadState = <span class="hljs-keyword">new</span> ThreadLocal &lt;PostingThreadState&gt; () {<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function">PostingThreadState <span class="hljs-title">initialValue</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PostingThreadState();<br>}<br>};<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostingThreadState</span> </span>{<br>    <span class="hljs-keyword">final</span> List &lt;Object&gt; eventQueue = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    <span class="hljs-keyword">boolean</span> isPosting;<br>    <span class="hljs-keyword">boolean</span> isMainThread;<br>    Subscription subscription;<br>    Object event;<br>    <span class="hljs-keyword">boolean</span> canceled;<br>}<br></code></pre></td></tr></tbody></table></figure><p>接着把传入的 event，保存到了当前线程中的一个变量 PostingThreadState 的 eventQueue 中。在注释2处，最后调用了<br>postSingleEvent() 方法，我们继续查看这个方法：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void post<span class="hljs-constructor">SingleEvent(Object <span class="hljs-params">event</span>, PostingThreadState <span class="hljs-params">postingState</span>)</span> throws Error {<br>    Class&lt;?&gt; eventClass = event.get<span class="hljs-constructor">Class()</span>;<br>    boolean subscriptionFound = <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">if</span> (eventInheritance) {<br>        <span class="hljs-comment">// 2</span><br>        List&lt;Class&lt;?&gt;&gt; eventTypes = lookup<span class="hljs-constructor">AllEventTypes(<span class="hljs-params">eventClass</span>)</span>;<br>        <span class="hljs-built_in">int</span> countTypes = eventTypes.size<span class="hljs-literal">()</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> h = <span class="hljs-number">0</span>; h &lt; countTypes; h++) {<br>            Class&lt;?&gt; clazz = eventTypes.get(h);<br>            subscriptionFound <span class="hljs-pattern-match">|=</span><br><span class="hljs-pattern-match">            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 3</span><br><span class="hljs-pattern-match">            post<span class="hljs-constructor">SingleEventForEventType(<span class="hljs-params">event</span>, <span class="hljs-params">postingState</span>, <span class="hljs-params">clazz</span>)</span>;</span><br><span class="hljs-pattern-match">        }</span><br><span class="hljs-pattern-match">    } <span class="hljs-keyword">else</span> {</span><br><span class="hljs-pattern-match">        subscription<span class="hljs-constructor">Found</span> = post<span class="hljs-constructor">SingleEventForEventType(<span class="hljs-params">event</span>, <span class="hljs-params">postingState</span>, <span class="hljs-params">eventClass</span>)</span>;</span><br><span class="hljs-pattern-match">    }</span><br><span class="hljs-pattern-match">    <span class="hljs-keyword">if</span> (!subscription<span class="hljs-constructor">Found</span>) {</span><br><span class="hljs-pattern-match">        <span class="hljs-operator">...</span></span><br><span class="hljs-pattern-match">    }</span><br><span class="hljs-pattern-match">}</span><br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，首先取出 Event 的 class 类型，接着<strong>会对 eventInheritance 标志位 判断，它默认为true，如果设为 true<br>的话，它会在发射事件的时候判断是否需要发射父类事件，设为 false，能够提高一些性能</strong><br>。接着，在注释2处，会调用lookupAllEventTypes() 方法，它的作用就是取出 Event 及其父类和接口的 class 列表，当然重复取的话会影响性能，所以它也做了一个<br>eventTypesCache 的缓存，这样就不用重复调用 getSuperclass() 方法。最后，在注释3处会调用postSingleEventForEventType()<br>方法，看下这个方法：</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">private <span class="hljs-type">boolean</span> postSingleEventForEventType(<span class="hljs-keyword">Object</span> event, PostingThreadState postingState, <span class="hljs-keyword">Class</span> &lt;?&gt; eventClass) {<br>    CopyOnWriteArrayList &lt;<span class="hljs-keyword">Subscription</span>&gt; subscriptions;<br>    synchronized(this) {<br>        subscriptions = subscriptionsByEventType.<span class="hljs-keyword">get</span>(eventClass);<br>    }<br>    <span class="hljs-keyword">if</span> (subscriptions != <span class="hljs-keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">Subscription</span> <span class="hljs-keyword">subscription</span>: subscriptions) {<br>            postingState.event = event;<br>            postingState.<span class="hljs-keyword">subscription</span> = <span class="hljs-keyword">subscription</span>;<br>            <span class="hljs-type">boolean</span> aborted = <span class="hljs-keyword">false</span>;<br>            try {<br>                postToSubscription(<span class="hljs-keyword">subscription</span>, event, postingState.isMainThread);<br>                aborted = postingState.canceled;<br>            } finally {<br>                postingState.event = <span class="hljs-keyword">null</span>;<br>                postingState.<span class="hljs-keyword">subscription</span> = <span class="hljs-keyword">null</span>;<br>                postingState.canceled = <span class="hljs-keyword">false</span>;<br>            }<br>            <span class="hljs-keyword">if</span> (aborted) {<br>                break;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，这里直接根据 Event 类型从 subscriptionsByEventType 中取出对应的 subscriptions对象，最后调用了<br>postToSubscription() 方法。</p><p>这个时候再看看这个postToSubscription()方法：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postToSubscription</span>(<span class="hljs-params">Subscription subscription, Object <span class="hljs-keyword">event</span>, boolean isMainThread</span>)</span> {<br>    <span class="hljs-keyword">switch</span> (subscription.subscriberMethod.threadMode) {<br>        <span class="hljs-keyword">case</span> POSTING:<br>            invokeSubscriber(subscription, <span class="hljs-keyword">event</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> MAIN:<br>            <span class="hljs-keyword">if</span> (isMainThread) {<br>                invokeSubscriber(subscription, <span class="hljs-keyword">event</span>);<br>            } <span class="hljs-keyword">else</span> {<br>                mainThreadPoster.enqueue(subscription, <span class="hljs-keyword">event</span>);<br>            }<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> MAIN_ORDERED:<br>            <span class="hljs-keyword">if</span> (mainThreadPoster != <span class="hljs-literal">null</span>) {<br>                mainThreadPoster.enqueue(subscription, <span class="hljs-keyword">event</span>);<br>            } <span class="hljs-keyword">else</span> {<br>                invokeSubscriber(subscription, <span class="hljs-keyword">event</span>);<br>            }<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> BACKGROUND:<br>            <span class="hljs-keyword">if</span> (isMainThread) {<br>                backgroundPoster.enqueue(subscription, <span class="hljs-keyword">event</span>);<br>            } <span class="hljs-keyword">else</span> {<br>                invokeSubscriber(subscription, <span class="hljs-keyword">event</span>);<br>            }<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> ASYNC:<br>            asyncPoster.enqueue(subscription, <span class="hljs-keyword">event</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-literal">default</span>:<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Unknow thread mode: "</span> + subscription.subscriberMethod.threadMode);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面可以看出，这里通过threadMode 来判断在哪个线程中去执行方法：</p><ol><li><p>POSTING：执行 invokeSubscriber() 方法，内部<strong>直接采用反射调用</strong>。</p></li><li><p>MAIN：<strong>首先去判断当前是否在 UI 线程，如果是的话则直接反射调用，否则调用mainThreadPoster的enqueue()<br>方法，即把当前的方法加入到队列之中，然后通过 handler 去发送一个消息，在 handler 的 handleMessage 中去执行方法</strong>。</p></li><li><p>MAIN_ORDERED：<strong>与MAIN类似，不过是确保是顺序执行的</strong>。</p></li><li><p>BACKGROUND：<strong>判断当前是否在 UI 线程，如果不是的话则直接反射调用，是的话通过backgroundPoster的enqueue()方法<br>将方法加入到后台的一个队列，最后通过线程池去执行。注意，backgroundPoster在 Executor的execute()方法 上添加了<br>synchronized关键字 并设立 了控制标记flag，保证任一时间只且仅能有一个任务会被线程池执行</strong>。</p></li><li><p>ASYNC：**逻辑实现类似于BACKGROUND，将任务加入到后台的一个队列，最终由Eventbus 中的一个线程池去调用，这里的线程池与<br>BACKGROUND 逻辑中的线程池用的是同一个，即使用Executors的newCachedThreadPool()<br>方法创建的线程池，它是一个有则用、无则创建、无数量上限的线程池。不同于backgroundPoster的保证任一时间只且仅能有一个任务会被线程池执行的特性，这里asyncPoster则是异步运行的，可以同时接收多个任务<br>**。</p></li></ol><p>分析完EventBus的post()方法值，接着看看它的unregister()。</p><h3 id="EventBus-getDefault-unregister-this"><a href="#EventBus-getDefault-unregister-this" class="headerlink" title="EventBus.getDefault().unregister(this)"></a>EventBus.getDefault().unregister(this)</h3><p>它的核心源码如下所示：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">unregister</span>(<span class="hljs-params">Object subscriber</span>)</span> {<br>    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.<span class="hljs-keyword">get</span>(subscriber);<br>    <span class="hljs-keyword">if</span> (subscribedTypes != <span class="hljs-literal">null</span>) {<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) {<br>            <span class="hljs-comment">//1</span><br>            unsubscribeByEventType(subscriber, eventType);<br>        }<br>        <span class="hljs-comment">// 2</span><br>        typesBySubscriber.<span class="hljs-keyword">remove</span>(subscriber);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先，在注释1处，<strong>unsubscribeByEventType() 方法中对 subscriptionsByEventType 移除了该 subscriber 的所有订阅信息</strong><br>。最后，在注释2处，<strong>移除了注册对象和其对应的所有 Event 事件链表</strong>。</p><p>最后，再来分析下EventBus中对粘性事件的处理。</p><h3 id="EventBus-getDefault-postSticky-new-CollectEvent"><a href="#EventBus-getDefault-postSticky-new-CollectEvent" class="headerlink" title="EventBus.getDefault.postSticky(new CollectEvent())"></a>EventBus.getDefault.postSticky(new CollectEvent())</h3><p>如果想要发射 sticky 事件需要通过 EventBus的postSticky() 方法，内部源码如下所示：</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postSticky</span>(<span class="hljs-params">Object <span class="hljs-keyword">event</span></span>)</span> {<br>    synchronized (stickyEvents) {<br>        <span class="hljs-comment">// 1</span><br>        stickyEvents.put(<span class="hljs-keyword">event</span>.getClass(), <span class="hljs-keyword">event</span>);<br>    }<br>    <span class="hljs-comment">// 2</span><br>    post(<span class="hljs-keyword">event</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>在注释1处，先将该事件放入 stickyEvents 中，接着在注释2处使用post()发送事件。前面我们在分析register()方法的最后部分时，其中有关粘性事件的源码如下：</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">if</span> (subscriberMethod.sticky) {<br>    Object stickyEvent = stickyEvents.<span class="hljs-keyword">get</span>(eventType);<br>    <span class="hljs-keyword">if</span> (stickyEvent != <span class="hljs-literal">null</span>) {<br>        postToSubscription(<span class="hljs-keyword">new</span><span class="hljs-type">Subscription</span>, stickyEvent, isMainThread());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以看到，在这里**会判断当前事件是否是 sticky 事件，如果是，则从 stickyEvents 中拿出该事件并执行 postToSubscription() 方法<br>**。</p><blockquote><p>EventBus 的源码在Android主流三方库源码分析系列中可以说是除了ButterKnife之外，算是比较简单的了。但是，它其中的一些思想和设计是值得借鉴的。比如<br><strong>它使用 FindState 复用池来复用 FindState 对象，在各处使用了 synchronized 关键字进行代码块同步的一些优化操作</strong><br>。其中上面分析了这么多，<strong>EventBus最核心的逻辑就是利用了 subscriptionsByEventType<br>这个重要的列表，将订阅对象，即接收事件的方法存储在这个列表，发布事件的时候在列表中查询出相对应的方法并执行</strong>。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>性能优化知识点汇总</title>
    <link href="/2023/08/24/docs/android/zhi-shi-hui-zong/xing-neng-you-hua-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/24/docs/android/zhi-shi-hui-zong/xing-neng-you-hua-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96">启动优化</a><ul><li><a href="#%E8%A7%86%E8%A7%89%E4%BC%98%E5%8C%96">视觉优化</a><ul><li><a href="#%E5%90%AF%E5%8A%A8%E4%B8%BB%E9%A2%98%E4%BC%98%E5%8C%96">启动主题优化</a></li></ul></li><li><a href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96">代码优化</a><ul><li><a href="#%E5%86%B7%E5%90%AF%E5%8A%A8%E8%80%97%E6%97%B6%E7%BB%9F%E8%AE%A1">冷启动耗时统计</a></li><li><a href="#Application-%E4%BC%98%E5%8C%96">Application 优化</a></li><li><a href="#%E9%97%AA%E5%B1%8F%E9%A1%B5%E4%B8%9A%E5%8A%A1%E4%BC%98%E5%8C%96">闪屏页业务优化</a></li><li><a href="#%E5%B9%BF%E5%91%8A%E9%A1%B5%E4%BC%98%E5%8C%96">广告页优化</a></li></ul></li><li><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C">优化效果</a></li><li><a href="#%E5%90%AF%E5%8A%A8%E7%AA%97%E5%8F%A3">启动窗口</a></li></ul></li><li><a href="#UI%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96">UI渲染优化</a><ul><li><a href="#CPUGPU%E7%9A%84%E8%81%8C%E8%B4%A3">CPU、GPU的职责</a></li><li><a href="#%E6%9F%A5%E6%89%BEOverdraw">查找Overdraw</a></li><li><a href="#clipRect%E8%A7%A3%E5%86%B3%E8%87%AA%E5%AE%9A%E4%B9%89View%E7%9A%84OverDraw">clipRect解决自定义View的OverDraw</a></li><li><a href="#Hierarchy-Viewer%E7%9A%84%E4%BD%BF%E7%94%A8">Hierarchy Viewer的使用</a></li><li><a href="#%E5%86%85%E5%AD%98%E6%8A%96%E5%8A%A8%E7%8E%B0%E8%B1%A1">内存抖动现象</a></li></ul></li><li><a href="#%E5%B4%A9%E6%BA%83%E4%BC%98%E5%8C%96">崩溃优化</a><ul><li><a href="#%E5%B4%A9%E6%BA%83">崩溃</a><ul><li><a href="#%E5%B4%A9%E6%BA%83%E7%9A%84%E6%94%B6%E9%9B%86">崩溃的收集</a></li><li><a href="#ANR">ANR</a></li><li><a href="#%E5%BA%94%E7%94%A8%E9%80%80%E5%87%BA">应用退出</a></li></ul></li><li><a href="#%E5%B4%A9%E6%BA%83%E5%A4%84%E7%90%86">崩溃处理</a><ul><li><a href="#%E5%B4%A9%E6%BA%83%E7%8E%B0%E5%9C%BA">崩溃现场</a></li><li><a href="#%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90">崩溃分析</a></li><li><a href="#%E7%B3%BB%E7%BB%9F%E5%B4%A9%E6%BA%83">系统崩溃</a></li></ul></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96">内存优化</a><ul><li><a href="#%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7">优化工具</a><ul><li><a href="#Memory-Profiler">Memory Profiler</a></li><li><a href="#Memory-AnalyzerMAT">Memory Analyzer（MAT）</a></li><li><a href="#LeakCannary">LeakCannary</a></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">内存管理</a><ul><li><a href="#%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F">内存区域</a></li><li><a href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E6%B4%BB%E5%88%A4%E6%96%AD">对象存活判断</a></li><li><a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95">垃圾回收算法</a></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E6%8A%96%E5%8A%A8">内存抖动</a><ul><li><a href="#%E6%A8%A1%E6%8B%9F%E5%86%85%E5%AD%98%E6%8A%96%E5%8A%A8">模拟内存抖动</a></li><li><a href="#%E5%88%86%E6%9E%90%E5%B9%B6%E5%AE%9A%E4%BD%8D">分析并定位</a></li></ul></li><li><a href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2">内存泄露</a><ul><li><a href="#%E6%A8%A1%E6%8B%9F%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2">模拟内存泄露</a></li><li><a href="#%E5%88%86%E6%9E%90%E5%B9%B6%E5%AE%9A%E4%BD%8D-1">分析并定位</a></li></ul></li><li><a href="#MAT%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7">MAT分析工具</a><ul><li><a href="#Overview">Overview</a></li><li><a href="#Histogram">Histogram</a></li><li><a href="#Dominator_tree">Dominator_tree</a></li><li><a href="#SQL">SQL</a></li><li><a href="#Thread_overview">Thread_overview</a></li><li><a href="#Top-Consumers">Top Consumers</a></li><li><a href="#Leak-Suspects">Leak Suspects</a></li></ul></li><li><a href="#%E9%80%9A%E8%BF%87ARTHook%E6%A3%80%E6%B5%8B%E4%B8%8D%E5%90%88%E7%90%86%E5%9B%BE%E7%89%87">通过ARTHook检测不合理图片</a><ul><li><a href="#%E8%8E%B7%E5%8F%96Bitmap%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98">获取Bitmap占用内存</a></li><li><a href="#%E6%A3%80%E6%B5%8B%E5%A4%A7%E5%9B%BE">检测大图</a></li></ul></li><li><a href="#%E7%BA%BF%E4%B8%8A%E5%86%85%E5%AD%98%E7%9B%91%E6%8E%A7">线上内存监控</a><ul><li><a href="#%E5%B8%B8%E8%A7%84%E6%96%B9%E6%A1%88">常规方案</a></li><li><a href="#LeakCannary%E5%AE%9A%E5%88%B6%E6%94%B9%E9%80%A0">LeakCannary定制改造</a></li><li><a href="#%E5%AE%8C%E6%95%B4%E6%96%B9%E6%A1%88">完整方案</a></li></ul></li></ul></li><li><a href="#%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96">卡顿优化</a><ul><li><a href="#%E5%8D%A1%E9%A1%BF">卡顿</a></li><li><a href="#%E5%B8%A7%E7%8E%87">帧率</a></li><li><a href="#%E5%8D%A1%E9%A1%BF%E5%8E%9F%E5%9B%A0">卡顿原因</a></li><li><a href="#%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B">卡顿检测</a><ul><li><a href="#%E4%BD%BF%E7%94%A8dumpsys-gfxinfo">使用dumpsys gfxinfo</a></li><li><a href="#%E4%BD%BF%E7%94%A8systrace">使用systrace</a></li><li><a href="#%E4%BD%BF%E7%94%A8BlockCanary">使用BlockCanary</a></li><li><a href="#%E4%BD%BF%E7%94%A8Choreographer">使用Choreographer</a></li></ul></li><li><a href="#%E4%BC%98%E5%8C%96">优化</a></li></ul></li><li><a href="#%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96">存储优化</a><ul><li><a href="#%E4%BA%A4%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F">交换数据格式</a></li><li><a href="#SharePreferences-%E4%BC%98%E5%8C%96">SharePreferences 优化</a></li><li><a href="Bitmap-%E8%A7%A3%E7%A0%81">Bitmap 解码</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96">数据库优化</a><ul><li><a href="#%E4%BA%8B%E5%8A%A1">事务</a></li><li><a href="#SQLiteStatement">SQLiteStatement</a></li><li><a href="#%E7%B4%A2%E5%BC%95">索引</a></li></ul></li><li><a href="#%E5%85%B6%E5%AE%83%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96">其它通用优化</a></li></ul></li><li><a href="#%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96">网络优化</a><ul><li><a href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E5%AF%B9%E7%94%A8%E6%88%B7%E7%9A%84%E5%BD%B1%E5%93%8D">网络连接对用户的影响</a></li><li><a href="#%E5%88%86%E6%9E%90%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%B7%A5%E5%85%B7">分析网络连接的工具</a><ul><li><a href="#Network-Monitor">Network Monitor</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%E5%B7%A5%E5%85%B7">网络代理工具</a></li></ul></li><li><a href="#%E4%BB%8E%E5%93%AA%E4%BA%9B%E6%96%B9%E9%9D%A2%E4%BC%98%E5%8C%96%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5">从哪些方面优化网络连接</a><ul><li><a href="#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1">接口设计</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E7%BC%93%E5%AD%98">网络缓存</a></li><li><a href="#%E5%BC%B1%E7%BD%91%E6%B5%8B%E8%AF%95&amp;%E4%BC%98%E5%8C%96">弱网测试&amp;优化</a></li></ul></li></ul></li><li><a href="#%E8%80%97%E7%94%B5%E4%BC%98%E5%8C%96">耗电优化</a><ul><li><a href="#%E8%80%97%E7%94%B5%E7%9B%91%E6%8E%A7">耗电监控</a><ul><li><a href="#Android-Vitals">Android Vitals</a></li></ul></li><li><a href="#%E8%80%97%E7%94%B5%E7%9B%91%E6%8E%A7%E9%83%BD%E7%9B%91%E6%8E%A7%E4%BB%80%E4%B9%88">耗电监控都监控什么</a></li><li><a href="#%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7%E8%80%97%E7%94%B5">如何监控耗电</a><ul><li><a href="#Java-Hook">Java Hook</a></li><li><a href="#%E6%8F%92%E6%A1%A9">插桩</a></li></ul></li></ul></li><li><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96">多线程并发优化</a><ul><li><a href="#Thread-%E4%BD%BF%E7%94%A8">Thread 使用</a><ul><li><a href="#Thread-%E4%B8%AD%E6%96%AD">Thread 中断</a></li><li><a href="#%E5%90%8C%E6%AD%A5">同步</a></li></ul></li><li><a href="#Android-Threading">Android Threading</a><ul><li><a href="#AsyncTask">AsyncTask</a></li><li><a href="#HandlerThread">HandlerThread</a></li><li><a href="#IntentService">IntentService</a></li><li><a href="#Loader">Loader</a></li><li><a href="#ThreadPool">ThreadPool</a></li></ul></li><li><a href="#%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7">线程优先级</a></li></ul></li><li><a href="#%E5%AE%89%E8%A3%85%E5%8C%85%E4%BC%98%E5%8C%96">安装包优化</a><ul><li><a href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F">常用的优化方式</a><ul><li><a href="#%E6%B8%85%E7%90%86%E6%97%A0%E7%94%A8%E8%B5%84%E6%BA%90">清理无用资源</a></li><li><a href="#%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96">图片资源优化</a></li><li><a href="#%E8%B5%84%E6%BA%90%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD">资源动态加载</a></li><li><a href="#lib%E5%BA%93%E4%BC%98%E5%8C%96">lib库优化</a></li><li><a href="#7zip%E5%8E%8B%E7%BC%A9%E8%B5%84%E6%BA%90">7zip压缩资源</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86">代码混淆</a></li><li><a href="#%E8%B5%84%E6%BA%90res%E6%B7%B7%E6%B7%86">资源(res)混淆</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E5%BE%AE%E4%BF%A1AndResGuard">使用微信AndResGuard</a></li><li><a href="#Facebook%E7%9A%84redex%E4%BC%98%E5%8C%96%E5%AD%97%E8%8A%82%E7%A0%81">Facebook的redex优化字节码</a></li></ul></li></ul></li></ul><h1 id="启动优化"><a href="#启动优化" class="headerlink" title="启动优化"></a>启动优化</h1><p>一个应用App的启动速度能够影响用户的首次体验，启动速度较慢(感官上)的应用可能导致用户再次开启App的意图下降，或者卸载放弃该应用程序。</p><h2 id="视觉优化"><a href="#视觉优化" class="headerlink" title="视觉优化"></a>视觉优化</h2><p>应用程序启动有三种状态，每种状态都会影响应用程序对用户可见所需的时间：冷启动，热启动和温启动。</p><blockquote><p>在冷启动时，应用程序从头开始。在其他状态下，系统需要将正在运行的应用程序从后台运行到前台。我们建议您始终根据冷启动的假设进行优化。这样做也可以改善热启动和温启动的性能。</p></blockquote><p>在冷启动开始时，系统有三个任务。这些任务是：</p><ol><li>加载并启动应用程序。</li><li>启动后立即显示应用程序空白的启动窗口。</li><li>创建应用程序进程。</li></ol><blockquote><p>一旦系统创建应用程序进程，应用程序进程就会负责下一阶段。这些阶段是：</p></blockquote><ol><li>创建app对象.</li><li>启动主线程(main thread).</li><li>创建应用入口的Activity对象.</li><li>填充加载布局Views</li><li>在屏幕上执行View的绘制过程.measure -&gt; layout -&gt; draw</li></ol><blockquote><p>应用程序进程完成第一次绘制后，系统进程会交换当前显示的背景窗口，将其替换为主活动。此时，用户可以开始使用该应用程序。</p></blockquote><p><img src="https://img-blog.csdn.net/20180821203949125?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>因为App应用进程的创建过程是由手机的软硬件决定的，所以我们只能在这个创建过程中视觉优化。</p><h3 id="启动主题优化"><a href="#启动主题优化" class="headerlink" title="启动主题优化"></a>启动主题优化</h3><p>冷启动阶段 :</p><ol><li>加载并启动应用程序。</li><li>启动后立即显示应用程序空白的启动窗口。</li><li>创建应用程序进程。<br>所谓的主题优化，就是应用程序在冷启动的时候(1~2阶段)，设置启动窗口的主题。</li></ol><p>因为现在 App 应用启动都会先进入一个闪屏页(LaunchActivity) 来展示应用信息。</p><ul><li><strong>默认情况</strong></li></ul><p>如果我们对App没有做处理(设置了默认主题)，并且在 Application 初始化了其它第三方的服务(假设需要加载2000ms)<br>，那么冷启动过程就会如下图 ：</p><p><img src="https://img-blog.csdn.net/20180821174737118?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>系统默认会在启动应用程序的时候<strong>启动空白窗口</strong>，直到 App 应用程序的入口 Activity 创建成功，视图绘制完毕。(<br>大概是onWindowFocusChanged方法回调的时候 )</p><ul><li><strong>透明主题优化</strong></li></ul><p>为了解决启动窗口白屏问题，许多开发者使用透明主题来解决这个问题，但是治标不治本。<br>虽然解决了上面这个问题，但是仍然有些不足。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">    &lt;!--Base application theme.--&gt;<br>&lt;style name=<span class="hljs-string">"AppTheme"</span>parent=<span class="hljs-string">"Theme.AppCompat.Light.DarkActionBar"</span>&gt;<br>&lt;item name=<span class="hljs-string">"android:windowFullscreen"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<br>&lt;item name=<span class="hljs-string">"android:windowIsTranslucent"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<br>&lt;/style&gt;<br></code></pre></td></tr></tbody></table></figure><p><img src="https://img-blog.csdn.net/2018082120304024?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>(无白屏,不过从点击到App仍然存在视觉延迟~)</p><ul><li><strong>设置闪屏图片主题</strong></li></ul><p>为了更顺滑无缝衔接我们的闪屏页，可以在启动 Activity 的 Theme中设置闪屏页图片，这样启动窗口的图片就会是闪屏页图片，而不是白屏。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">    &lt;style name=<span class="hljs-string">"AppTheme"</span>parent=<span class="hljs-string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;<br>&lt;item name=<span class="hljs-string">"android:windowBackground"</span>&gt;<span class="hljs-meta">@drawable</span>/lunch&lt;/item&gt;  <span class="hljs-comment">//闪屏页图片</span><br>&lt;item name=<span class="hljs-string">"android:windowFullscreen"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<br>&lt;item name=<span class="hljs-string">"android:windowDrawsSystemBarBackgrounds"</span>&gt;<span class="hljs-literal">false</span>&lt;/item&gt;&lt;!--显示虚拟按键，并腾出空间--&gt;<br>&lt;/style&gt;<br></code></pre></td></tr></tbody></table></figure><p><img src="https://img-blog.csdn.net/20180821204758547?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>这样设置的话，就会在冷启动的时候，展示闪屏页的图片，等App进程初始化加载入口 Activity (也是闪屏页) 就可以无缝衔接。</p><p>其实这种方式并没有真正的加速应用进程的启动速度，而只是通过用户视觉效果带来的优化体验。</p><h2 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h2><p>当然上面使用设置主题的方式优化用户体验效果治标不治本，关键还在于对代码的优化。</p><p>首先统计一下应用冷启动的时间。</p><h3 id="冷启动耗时统计"><a href="#冷启动耗时统计" class="headerlink" title="冷启动耗时统计"></a>冷启动耗时统计</h3><ul><li><strong>adb 命令统计</strong></li></ul><p>adb命令 :<code>adb shell am start -S -W 包名/启动类的全限定名</code>， -S 表示重启当前应用</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">C:\Android\Demo&gt;adb shell am start-S-W com.example.moneyqian.demo/com.example.moneyqian.demo.MainActivity<br>        Stopping:com.example.moneyqian.demo<br>        Starting:Intent{act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER]cmp=com.example.moneyqian.demo/.MainActivity}<br>        Status:ok<br>        Activity:com.example.moneyqian.demo/.MainActivity<br>        ThisTime:<span class="hljs-number">2247</span><br>        TotalTime:<span class="hljs-number">2247</span><br>        WaitTime:<span class="hljs-number">2278</span><br>        Complete<br></code></pre></td></tr></tbody></table></figure><ul><li><p>ThisTime : 最后一个 Activity 的启动耗时(例如从 LaunchActivity - &gt;MainActivity「adb命令输入的Activity」 , 只统计<br>MainActivity 的启动耗时)</p></li><li><p>TotalTime : 启动一连串的 Activity 总耗时.(有几个Activity 就统计几个)</p></li><li><p>WaitTime : 应用进程的创建过程 + TotalTime .</p></li></ul><p><img src="https://img-blog.csdn.net/20180823165453780?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><ul><li><p>在第①个时间段内，AMS 创建 ActivityRecord 记录块和选择合理的 Task、将当前Resume 的 Activity 进行 pause.</p></li><li><p>在第②个时间段内，启动进程、调用无界面 Activity 的 onCreate() 等、 pause/finish 无界面的 Activity.</p></li><li><p>在第③个时间段内，调用有界面 Activity 的 onCreate、onResume.</p></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ActivityRecord</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reportLaunchTimeLocked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> curTime)</span>{<br>        ``````<br><span class="hljs-keyword">final</span> <span class="hljs-type">long</span> thisTime=curTime-displayStartTime;<br><span class="hljs-keyword">final</span> <span class="hljs-type">long</span> totalTime=stack.mLaunchStartTime!=<span class="hljs-number">0</span>?(curTime-stack.mLaunchStartTime):thisTime;<br>        }<br></code></pre></td></tr></tbody></table></figure><p>如果需要统计从点击桌面图标到 Activity 启动完毕，可以用WaitTime作为标准，但是系统的启动时间优化不了，所以优化冷启动只要在意*<br>*ThisTime**即可。</p><ul><li><strong>系统日志统计</strong></li></ul><p>也可以根据系统日志来统计启动耗时，在Android Studio中查找已用时间，必须在logcat视图中禁用过滤器(No Filters)<br>。因为这个是系统的日志输出，而不是应用程序的。你也可以查看其它应用程序的启动耗时。</p><p>过滤<code>displayed</code>输出的启动日志.</p><p><img src="https://img-blog.csdn.net/20180823173958565?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>根据上面启动时间的输出统计，就可以先记录优化前的冷启动耗时，然后再对比优化之后的启动时间。</p><h3 id="Application-优化"><a href="#Application-优化" class="headerlink" title="Application 优化"></a>Application 优化</h3><p>Application 作为 应用程序的整个初始化配置入口，时常担负着它不应该有的负担</p><p>有很多第三方组件（包括App应用本身）都在 Application 中抢占先机，完成初始化操作。</p><p>但是在 Application 中完成繁重的初始化操作和复杂的逻辑就会影响到<strong>应用的启动性能</strong></p><p>通常，有机会优化这些工作以实现性能改进，这些常见问题包括：</p><ol><li>复杂繁琐的布局初始化</li><li>阻塞主线程 UI 绘制的操作，如 I/O 读写或者是网络访问.</li><li>Bitmap 大图片或者 VectorDrawable加载</li><li>其它占用主线程的操作</li></ol><p>我们可以根据这些组件的轻重缓急之分，对初始化做一下分类 ：</p><ol><li>必要的组件一定要在<strong>主线程中立即</strong>初始化(入口 Activity 可能立即会用到)</li><li>组件一定要在<strong>主线程</strong>中初始化，但是可以延迟初始化。</li><li>组件可以在<strong>子线程</strong>中初始化。</li></ol><p><strong>放在子线程的组件初始化建议延迟初始化</strong>，这样就可以了解是否会对项目造成影响！</p><p>所以对于上面的分析，可以在项目中 Application 的加载组件进行如下优化 ：</p><ul><li><strong>将Bugly，x5内核初始化，SP的读写，友盟等组件放到子线程中初始化。</strong>（子线程初始化不能影响到组件的使用）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        <span class="hljs-comment">//设置线程的优先级，不与主线程抢资源</span><br>        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);<br>        <span class="hljs-comment">//子线程初始化第三方组件</span><br>        Thread.sleep(<span class="hljs-number">5000</span>);<span class="hljs-comment">//建议延迟初始化，可以发现是否影响其它功能，或者是崩溃！</span><br>        }<br>        }).start();<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>将需要在主线程中初始化但是可以不用立即完成的动作延迟加载</strong>（原本是想在入口 Activity 中进行此项操作，不过组件的初始化放在<br>Application 中统一管理为妙.）</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">        handler.postDelayed(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        <span class="hljs-comment">//延迟初始化组件</span><br>        }<br>        },<span class="hljs-number">3000</span>);<br></code></pre></td></tr></tbody></table></figure><h3 id="闪屏页业务优化"><a href="#闪屏页业务优化" class="headerlink" title="闪屏页业务优化"></a>闪屏页业务优化</h3><p>最后还剩下那些为数不多的组件在主线程初始化动作，例如<strong>埋点，点击流，数据库初始化</strong>等，不过这些消耗的时间可以在其它地方**相抵<br>**。</p><p><strong>需求背景</strong>： 应用App通常会设置一个固定的闪屏页展示时间，例如2000ms，所以我们可以根据用户手机的运行速度，对展示时间做出调整，但是总时间仍然为<br>2000ms。</p><p><strong>闪屏页政展示总时间</strong> = <strong>组件初始化时间</strong> + <strong>剩余展示时间</strong>。</p><p>也就是2000ms的总时间，组件初始化了800ms，那么就再展示1200ms即可。</p><p>先了解一下 Application的启动过程<br>虽然这个以下图片的源码并不是最新源码（5.0源码），不过不影响整体流程。（7.0,8.0方法名会有所改变）。</p><p><img src="https://img-blog.csdn.net/20180823215319329?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p><img src="https://img-blog.csdn.net/20180826181521975?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>冷启动的过程中系统会初始化应用程序进程，创建Application等任务，这时候会展示一个<strong>启动窗口</strong> Starting<br>Window，如果没有优化主题的话，那么就是白屏。</p><p>分析源码后，我们可以知道 Application 初始化后会调用<code>attachBaseContext()</code>方法，再调用 Application 的<code>onCreate()</code>，再到入口<br>Activity的创建和执行<code>onCreate()</code>方法。所以我们就可以在 Application 中记录启动时间。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Application</span><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span>{<br>        <span class="hljs-built_in">super</span>.attachBaseContext(base);<br>        SPUtil.putLong(<span class="hljs-string">"application_attach_time"</span>,System.currentTimeMillis());<span class="hljs-comment">//记录Application初始化时间</span><br>        }<br></code></pre></td></tr></tbody></table></figure><p>有了启动时间，我们得知道入口的 Acitivty 显示给用户的时间（View绘制完毕），在<code>onWindowFocusChanged()</code><br>的回调时机中表示可以获取用户的触摸时间和View的流程绘制完毕，所以可以在这个方法里记录显示时间。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//入口Activity</span><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onWindowFocusChanged</span><span class="hljs-params">(<span class="hljs-type">boolean</span> hasFocus)</span>{<br>        <span class="hljs-built_in">super</span>.onWindowFocusChanged(hasFocus);<br><br>        <span class="hljs-type">long</span> appAttachTime=SPUtil.getLong(<span class="hljs-string">"application_attach_time"</span>);<br>        <span class="hljs-type">long</span> diffTime=System.currentTimeMillis()-appAttachTime;<span class="hljs-comment">//从application到入口Acitity的时间</span><br><br>        <span class="hljs-comment">//所以闪屏页展示的时间为 2000ms - diffTime.</span><br>        }<br></code></pre></td></tr></tbody></table></figure><p>所以就可以动态的设置应用闪屏的显示时间，尽量让每一部手机展示的时间一致，这样就不会让手机配置较低的用户感觉漫长难熬的闪屏页时间（例如初始化了2000ms，又要展示2000ms的闪屏页时间.），优化用户体验。</p><h3 id="广告页优化"><a href="#广告页优化" class="headerlink" title="广告页优化"></a>广告页优化</h3><p>闪屏页过后就要展示金主爸爸们的广告页了。</p><p>因为项目中广告页图片有可能是大图，APng动态图片，所以需要将这些图片下载到本地文件，下载完成后再显示，这个过程往往会遇到以下两个问题 ：</p><ul><li>广告页的下载，由于这个是一个异步过程，所以往往不知道加载到页面的合适时机。</li><li>广告页的保存，因为保存是 I/O 流操作，很有可能被用户中断，下次拿到破损的图片。</li></ul><p>因为不清楚用户的网络环境，有些用户下载广告页可能需要一段时间，这时候又不可能无限的等候。所以针对这个问题可以开启<code>IntentService</code><br>用来下载广告页图片。</p><ul><li>在入口 Acitivity 中开启<strong>IntentService</strong>来下载广告页。 或者是其它异步下载操作。</li><li>在广告页图片<strong>文件流完全写入后</strong>记录图片大小，或者记录一个标识。</li></ul><p>在下次的广告页加载中可以<strong>判断是否已经下载</strong>好了广告页图片以及图片<strong>是否完整</strong>，否则删除并且再次下载图片。</p><p>另外因为在闪屏页中仍然有<strong>剩余展示时间</strong>，所以在这个时间段里如果用户已经下载好了图片并且图片完整，就可以显示广告页。否则进入主<br>Activity ， 因为<code>IntentService</code>仍然在后台继续默默的下载并保存图片~</p><h2 id="优化效果"><a href="#优化效果" class="headerlink" title="优化效果"></a>优化效果</h2><p>优化前 ： （小米6）</p><table><thead><tr><th align="center">Displayed</th><th align="center">LaunchActivity</th><th align="center">MainActivity</th></tr></thead><tbody><tr><td align="center"></td><td align="center">+2s526ms</td><td align="center">+1s583ms</td></tr><tr><td align="center"></td><td align="center">+2s603ms</td><td align="center">+1s533ms</td></tr><tr><td align="center"></td><td align="center">+2s372ms</td><td align="center">+1s556ms</td></tr></tbody></table><p>优化后 ： （小米6）</p><table><thead><tr><th align="center">Displayed</th><th align="center">LaunchActivity</th><th align="center">MainActivity</th></tr></thead><tbody><tr><td align="center"></td><td align="center">+995ms</td><td align="center">+1s191ms</td></tr><tr><td align="center"></td><td align="center">+911ms</td><td align="center">+1s101ms</td></tr><tr><td align="center"></td><td align="center">+903ms</td><td align="center">+1s187ms</td></tr></tbody></table><p>通过手上 小米6，小米 mix2s，还有小米 2s的启动测试，发现优化后App冷启动的启动速度均提升了 60% !!!<br>，并且可以再看一下手机冷启动时候的内存情况 ：</p><p>优化前 ： 伴随着大量对象的创建回收，15s内系统GC 5次。内存使用波澜荡漾。</p><p><img src="https://img-blog.csdn.net/20180825150849193?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>优化后 ： 趋于平稳上升状态创建对象，15s内系统GC 2次。（后期业务拓展加入新功能，所以代码量增加。）之后总内存使用平缓下降。</p><p><img src="https://img-blog.csdn.net/20180825151003130?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><ul><li><strong>Other</strong>：应用使用的系统不确定如何分类的内存。</li><li><strong>Code</strong>：应用用于处理代码和资源（如 dex 字节码、已优化或已编译的 dex 码、.so 库和字体）的内存。</li><li><strong>Stack</strong>： 应用中的原生堆栈和 Java 堆栈使用的内存。 这通常与您的应用运行多少线程有关。</li><li><strong>Graphics</strong>：图形缓冲区队列向屏幕显示像素（包括 GL 表面、GL 纹理等等）所使用的内存。 （请注意，这是与 CPU 共享的内存，不是<br>GPU 专用内存。）</li><li><strong>Native</strong>：从 C 或 C++ 代码分配的对象内存。即使应用中不使用 C++，也可能会看到此处使用的一些原生内存，因为 Android<br>框架使用原生内存代表处理各种任务，如处理图像资源和其他图形时，即使编写的代码采用 Java 或 Kotlin 语言。</li><li><strong>Java</strong>：从 Java 或 Kotlin 代码分配的对象内存。</li><li><strong>Allocated</strong>：应用分配的 Java/Kotlin 对象数。 它没有计入 C 或 C++ 中分配的对象。</li></ul><h2 id="启动窗口"><a href="#启动窗口" class="headerlink" title="启动窗口"></a>启动窗口</h2><p>优化完代码后，分析一下启动窗口的源码。基于 android-25 (7.1.1)</p><p>启动窗口是由 <code>WindowManagerService</code> 统一管理的 <code>Window</code> 窗口，一般作为冷启动页入口 Activity<br>的预览窗口，启动窗口由 <code>ActivityManagerService</code> 来决定是否显示的，并不是每一个 Activity 的启动和跳转都会显示这个窗口。</p><p><code>WindowManagerService</code> 通过窗口管理策略类 <code>PhoneWindowManager</code> 来创建启动窗口。<br><img src="https://img-blog.csdn.net/2018082515534691?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p><strong>AMS启动Activity流程</strong></p><p><img src="https://img-blog.csdn.net/2018082516213539?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>在 <code>ActivityStarter</code> 的 <code>startActivityUnchecked()</code> 方法中，调用了 <code>ActivityStack</code> （Activity<br>状态管理）的 <code>startActivityLocked()</code> 方法。此时Activity 还在启动过程中，窗口并未显示。</p><p><strong>启动窗口的显示过程</strong></p><p><img src="https://img-blog.csdn.net/20180825170000818?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpYW41MjBhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>首先，由 Activity 状态管理者 <code>ActivityStack</code> 开始执行显示启动窗口的流程。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ActivityStack</span><br><br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivityLocked</span><span class="hljs-params">(ActivityRecord r,<span class="hljs-type">boolean</span> newTask,<span class="hljs-type">boolean</span> keepCurTransition,</span><br><span class="hljs-params">        ActivityOptions options)</span>{<br><br>        ``````<br>        <span class="hljs-keyword">if</span>(!isHomeStack()||numActivities()&gt;<span class="hljs-number">0</span>){<span class="hljs-comment">//HOME_STACK表示Launcher桌面所在的Stack</span><br>        <span class="hljs-comment">// 1.首先当前启动栈不在Launcher的桌面栈里,并且当前系统已经有激活过Activity</span><br><br>        <span class="hljs-comment">// We want to show the starting preview window if we are</span><br>        <span class="hljs-comment">// switching to a new task, or the next activity's process is</span><br>        <span class="hljs-comment">// not currently running.</span><br><br>        <span class="hljs-type">boolean</span> doShow=<span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(newTask){<br>        <span class="hljs-comment">// 2.要将该Activity组件放在一个新的任务栈中启动</span><br><br>        <span class="hljs-comment">// Even though this activity is starting fresh, we still need</span><br>        <span class="hljs-comment">// to reset it to make sure we apply affinities to move any</span><br>        <span class="hljs-comment">// existing activities from other tasks in to it.</span><br>        <span class="hljs-keyword">if</span>((r.intent.getFlags()&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED)!=<span class="hljs-number">0</span>){<br>        resetTaskIfNeededLocked(r,r);<br>        doShow=topRunningNonDelayedActivityLocked(<span class="hljs-literal">null</span>)==r;<br>        }<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options!=<span class="hljs-literal">null</span>&amp;&amp;options.getAnimationType()<br>        ==ActivityOptions.ANIM_SCENE_TRANSITION){<br>        doShow=<span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(r.mLaunchTaskBehind){<br>        <span class="hljs-comment">//3. 热启动，不需要启动窗口</span><br><br>        <span class="hljs-comment">// Don't do a starting window for mLaunchTaskBehind. More importantly make sure we</span><br>        <span class="hljs-comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span><br>        mWindowManager.setAppVisibility(r.appToken,<span class="hljs-literal">true</span>);<br>        ensureActivitiesVisibleLocked(<span class="hljs-literal">null</span>,<span class="hljs-number">0</span>,!PRESERVE_WINDOWS);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(SHOW_APP_STARTING_PREVIEW&amp;&amp;doShow){<br><br>        ``````<br>        <span class="hljs-comment">//4. 显示启动窗口</span><br>        r.showStartingWindow(prev,showStartingIcon);<br>        }<br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// 当前启动的是桌面Launcher (开机启动)</span><br>        <span class="hljs-comment">// If this is the first activity, don't do any fancy animations,</span><br>        <span class="hljs-comment">// because there is nothing for it to animate on top of.</span><br>        ``````<br>        }<br><br>        }<br></code></pre></td></tr></tbody></table></figure><ol><li>首先判断当前要启动的 Activity 不在Launcher栈里</li><li>要启动的 Activity 是否处于新的 Task 里，并且没有转场动画</li><li>如果是热/温启动则不需要启动窗口，直接设置App的Visibility</li></ol><p>接下来调用 <code>ActivityRecord</code> 的 <code>showStartingWindow()</code> 方法来设置启动窗口并且改变当前窗口的状态。</p><p>如果 App 的应用进程创建完成，并且入口 Activity 准备就绪，就可以根据 <code>mStartingWindowState</code> 来判断是否需要关闭启动窗口。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ActivityRecord</span><br><br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">showStartingWindow</span><span class="hljs-params">(ActivityRecord prev,<span class="hljs-type">boolean</span> createIfNeeded)</span>{<br><span class="hljs-keyword">final</span> CompatibilityInfo compatInfo=<br>        service.compatibilityInfoForPackageLocked(info.applicationInfo);<br><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> shown=service.mWindowManager.setAppStartingWindow(<br>        appToken,packageName,theme,compatInfo,nonLocalizedLabel,labelRes,icon,<br>        logo,windowFlags,prev!=<span class="hljs-literal">null</span>?prev.appToken:<span class="hljs-literal">null</span>,createIfNeeded);<br>        <span class="hljs-keyword">if</span>(shown){<br>        mStartingWindowState=STARTING_WINDOW_SHOWN;<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><p>WindowManagerService 会对当前 Activity 的token和主题进行判断。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//WindowManagerService</span><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setAppStartingWindow</span><span class="hljs-params">(IBinder token,String pkg,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> theme,CompatibilityInfo compatInfo,</span><br><span class="hljs-params">        CharSequence nonLocalizedLabel,<span class="hljs-type">int</span> labelRes,<span class="hljs-type">int</span> icon,<span class="hljs-type">int</span> logo,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> windowFlags,IBinder transferFrom,<span class="hljs-type">boolean</span> createIfNeeded)</span>{<br><br><span class="hljs-keyword">synchronized</span>(mWindowMap){<br><br>        <span class="hljs-comment">//1. 启动窗口也是需要token的</span><br>        AppWindowToken wtoken=findAppWindowToken(token);<br><br>        <span class="hljs-comment">//2. 如果已经设置过启动窗口了，不继续处理</span><br>        <span class="hljs-keyword">if</span>(wtoken.startingData!=<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br><br>        <span class="hljs-comment">// If this is a translucent window, then don't</span><br>        <span class="hljs-comment">// show a starting window -- the current effect (a full-screen</span><br>        <span class="hljs-comment">// opaque starting window that fades away to the real contents</span><br>        <span class="hljs-comment">// when it is ready) does not work for this.</span><br>        <span class="hljs-keyword">if</span>(theme!=<span class="hljs-number">0</span>){<br>        AttributeCache.Entry ent=AttributeCache.instance().get(pkg,theme,<br>        com.android.internal.R.styleable.Window,mCurrentUserId);<br><br>        <span class="hljs-comment">//3. 一堆代码对主题判断，不符合要求则不显示启动窗口（如透明主题）</span><br>        <span class="hljs-keyword">if</span>(windowIsTranslucent){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-keyword">if</span>(windowIsFloating||windowDisableStarting){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        ``````<br>        }<br><br>        <span class="hljs-comment">//4. 创建StartingData，并且通过Handler发送消息</span><br><br>        wtoken.startingData=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StartingData</span>(pkg,theme,compatInfo,nonLocalizedLabel,<br>        labelRes,icon,logo,windowFlags);<br>        Message m=mH.obtainMessage(H.ADD_STARTING,wtoken);<br>        <span class="hljs-comment">// Note: we really want to do sendMessageAtFrontOfQueue() because we</span><br>        <span class="hljs-comment">// want to process the message ASAP, before any other queued</span><br>        <span class="hljs-comment">// messages.</span><br><br>        mH.sendMessageAtFrontOfQueue(m);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><ol><li>启动窗口也需要和 Activity 拥有同样令牌 token ，虽然启动窗口可能是白屏，或者一张图片，但是仍然需要走绘制流程已经通过WMS显示窗口。</li><li>StartingData对象用来表示启动窗口的相关数据，描述了启动窗口的视图信息。</li><li>如果当前 Activity 是透明主题或者是浮动窗口等，那么就不需要启动窗口来过渡启动过程，所以在上面视觉优化中的设置透明主题就没有显示白色的启动窗口。</li><li>显示启动窗口也是一件心急火燎的事情，WMS的内部类H (handler) 处于主线程处理消息，所以需要将当前Message放置队列头部。</li></ol><p><strong>为什么需要通过 Handler 发送消息 ？</strong></p><p>你可以在各大服务Service中见到 Handler 的身影，并且它们可能都有一个很吊的命名 <code>H</code> ，因为可能调用这个服务的某个执行方法处于子线程中，所以<br>Handler 的职责就是将它们切换到主线程中，并且也可以统一管理调度。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//WindowManagerService --&gt; H </span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span>{<br>        <span class="hljs-keyword">switch</span>(msg.what){<br><br>        <span class="hljs-keyword">case</span> ADD_STARTING:{<br><span class="hljs-keyword">final</span> AppWindowToken wtoken=(AppWindowToken)msg.obj;<br><span class="hljs-keyword">final</span> StartingData sd=wtoken.startingData;<br><br>        View view=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span>{<br><span class="hljs-keyword">final</span> Configuration overrideConfig=wtoken!=<span class="hljs-literal">null</span>&amp;&amp;wtoken.mTask!=<span class="hljs-literal">null</span><br>        ?wtoken.mTask.mOverrideConfig:<span class="hljs-literal">null</span>;<br>        view=mPolicy.addStartingWindow(wtoken.token,sd.pkg,sd.theme,<br>        sd.compatInfo,sd.nonLocalizedLabel,sd.labelRes,sd.icon,sd.logo,<br>        sd.windowFlags,overrideConfig);<br>        }<span class="hljs-keyword">catch</span>(Exception e){<br>        Slog.w(TAG_WM,<span class="hljs-string">"Exception when adding starting window"</span>,e);<br>        }<br><br>        ``````<br><br>        }<span class="hljs-keyword">break</span>;<br>        }     <br></code></pre></td></tr></tbody></table></figure><p>在当前的 <code>handleMessage</code><br>方法中，会处于主线程处理消息，拿到token和StartingData启动数据后，便通过 <code>mPolicy.addStartingWindow()</code> 方法将启动窗口添加到WIndow上。</p><p><code>mPolicy</code> 为 <code>PhoneWindowManager</code> ，控制着启动窗口的添加删除和修改。</p><p>在PhoneWindowManager对启动窗口进行配置，获取当前Activity设置的主题和资源信息，设置到启动窗口中。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PhoneWindowManager</span><br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> View <span class="hljs-title function_">addStartingWindow</span><span class="hljs-params">(IBinder appToken,String packageName,<span class="hljs-type">int</span> theme,</span><br><span class="hljs-params">        CompatibilityInfo compatInfo,CharSequence nonLocalizedLabel,<span class="hljs-type">int</span> labelRes,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> icon,<span class="hljs-type">int</span> logo,<span class="hljs-type">int</span> windowFlags,Configuration overrideConfig)</span>{<br><br>        <span class="hljs-comment">//可以通过SHOW_STARTING_ANIMATIONS设置不显示启动窗口</span><br>        <span class="hljs-keyword">if</span>(!SHOW_STARTING_ANIMATIONS){<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        WindowManager wm=<span class="hljs-literal">null</span>;<br>        View view=<span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span>{<br>        <span class="hljs-comment">//1. 获取上下文Context和主题theme以及标题</span><br>        Context context=mContext;<br>        <span class="hljs-keyword">if</span>(theme!=context.getThemeResId()||labelRes!=<span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">try</span>{<br>        context=context.createPackageContext(packageName,<span class="hljs-number">0</span>);<br>        context.setTheme(theme);<br>        }<span class="hljs-keyword">catch</span>(PackageManager.NameNotFoundException e){<br>        <span class="hljs-comment">// Ignore</span><br>        }<br>        }<br><br><span class="hljs-comment">//2. 创建PhoneWindow 用来显示</span><br><span class="hljs-keyword">final</span> PhoneWindow win=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(context);<br>        win.setIsStartingWindow(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">//3. 设置当前窗口type和flag,源码注释中描述的很清晰...</span><br>        win.setType(<br>        WindowManager.LayoutParams.TYPE_APPLICATION_STARTING);<br><br>        <span class="hljs-comment">// Force the window flags: this is a fake window, so it is not really</span><br>        <span class="hljs-comment">// touchable or focusable by the user.  We also add in the ALT_FOCUSABLE_IM</span><br>        <span class="hljs-comment">// flag because we do know that the next window will take input</span><br>        <span class="hljs-comment">// focus, so we want to get the IME window up on top of us right away.</span><br>        win.setFlags(<br>        windowFlags|<br>        WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE|<br>        WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE|<br>        WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM,<br>        windowFlags|<br>        WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE|<br>        WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE|<br>        WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM);<br><br>        win.setLayout(WindowManager.LayoutParams.MATCH_PARENT,<br>        WindowManager.LayoutParams.MATCH_PARENT);<br><br>        ``````<br><br>        view=win.getDecorView();<br><br>        <span class="hljs-comment">//4. WindowManager的绘制流程</span><br>        wm.addView(view,params);<br><br>        <span class="hljs-keyword">return</span> view.getParent()!=<span class="hljs-literal">null</span>?view:<span class="hljs-literal">null</span>;<br>        }<span class="hljs-keyword">catch</span>(WindowManager.BadTokenException e){<br>        <span class="hljs-comment">// ignore</span><br>        }<span class="hljs-keyword">catch</span>(RuntimeException e){<br>        <span class="hljs-comment">// don't crash if something else bad happens, for example a</span><br>        <span class="hljs-comment">// failure loading resources because we are loading from an app</span><br>        <span class="hljs-comment">// on external storage that has been unmounted.</span><br>        Log.w(TAG,appToken+<span class="hljs-string">" failed creating starting window"</span>,e);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><ol><li>如果theme和labelRes的值不为0，那么说明开发者指定了启动窗口的主题和标题，那么就需要从当前要启动的Activity中获取这些信息，并设置到启动窗口中。</li><li>和其它窗口一样，启动窗口也需要通过PhoneWindow来设置布局信息DecorView。所以在上面视觉优化中的设置闪屏图片主题的启动窗口显示的就是图片内容。</li><li>启动窗口和普通窗口的不同之处在于它是 fake window ，不需要触摸事件</li><li>最后通过WindowManger走View的绘制流程(measure-layout-draw)<br>将启动窗口显示出来，最后会请求WindowManagerService为启动窗口添加一个WindowState对象，真正的将启动窗口显示给用户，并且可以对启动窗口进行管理。</li></ol><h1 id="UI渲染优化"><a href="#UI渲染优化" class="headerlink" title="UI渲染优化"></a>UI渲染优化</h1><p>理解工作中常用的UI渲染性能优化及调试方法对于我们编写高质量代码也是很有帮助的</p><h2 id="CPU、GPU的职责"><a href="#CPU、GPU的职责" class="headerlink" title="CPU、GPU的职责"></a>CPU、GPU的职责</h2><p>对于大多数手机的屏幕刷新频率是60hz，也就是如果在1000/60=16.67ms内没有把这一帧的任务执行完毕，就会发生丢帧的现象，丢帧是造成界面卡顿的直接原因，渲染操作通常依赖于两个核心组件：CPU与GPU。CPU负责包括Measure，Layout等计算操作，GPU负责Rasterization(<br>栅格化)操作(<br>所谓栅格化就是将矢量图形转换为位图的过程，手机上显示是按照一个个像素来显示的，栅格化再普通一些的说法就是将一个Button,TextView等组件拆分到一个个像素上去显示)。</p><p>UI渲染优化的目的就是减轻CPU,GPU的压力，除去不必要的操作，保证每帧16ms以内处理完所有的CPU与GPU的计算，绘制，渲染等等操作，使UI顺滑，流畅的展示出来。</p><h2 id="查找Overdraw"><a href="#查找Overdraw" class="headerlink" title="查找Overdraw"></a>查找Overdraw</h2><p>Overdraw(过度绘制)描述的是屏幕上的某个像素在同一帧的时间内被绘制了多次。在重叠的UI布局中，如果不可见的UI也在做绘制的操作或者后一个控件将前一个控件遮挡，会导致某些像素区域被绘制了多次，从而增加了CPU,GPU的压力。</p><p>那么如何找出布局中Overdraw的地方呢？很简单，一般手机里面开发者选项都有调试GPU过度绘制的开关，打开即可。</p><p>以小米4手机为例，依次找到<code>设置-&gt;更多设置-&gt;开发者选项-&gt;调试GPU过度绘制开关</code>，打开就可以了。</p><p>打开调试GPU过度绘制开关之后，再次回到自己开发的应用发现界面怎么多了一些花花绿绿的玩意，没错，不同的颜色代表过度绘制的程度，具体如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180420104948203-194071555.png"></p><p>蓝色，淡绿，淡红，深红代表了4种不同程度的Overdraw情况，1x,2x,3x,4x分别表示同一像素上同一帧的时间内被绘制了多次，1x就表示一次(<br>最理想情况)，4x表示4次(最差的情况)，我们要做的就是尽量减少3x,4x的情况出现。</p><p>下面以一个简单demo来进一步说明一下，比如我们开发好一个界面，如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180426174522016-785166152.jpg"></p><p>很简单的功能，功能做完了，能不能做下优化呢？打开OverDraw功能，再次查看界面，如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180426175106185-12883163.jpg"></p><p>咦？怎么大部分都是浅绿色呢？也就是说同一像素上同一帧的时间内被绘制了2次，这是怎么回事？这时我们需要看下UI布局了，看哪些地方可以优化一下。</p><p>主界面布局如下：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">ListView</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/list_view"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:divider</span>=<span class="hljs-string">"#F1F1F1"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:dividerHeight</span>=<span class="hljs-string">"1dp"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:background</span>=<span class="hljs-string">"@android:color/white"</span></span><br><span class="hljs-tag"><span class="hljs-attr">android:scrollbars</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ListView</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>ListView每个条目布局如下：</p><figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;<br>&lt;RelativeLayout xmlns:android=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"match_parent"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"52dp"</span><br><span class="hljs-symbol">android:</span>background=<span class="hljs-string">"@drawable/ts_account_list_selector"</span>&gt;<br><br>&lt;TextView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_has_login_account"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_marginLeft=<span class="hljs-string">"10dp"</span><br><span class="hljs-symbol">android:</span>layout_marginTop=<span class="hljs-string">"4dp"</span><br><span class="hljs-symbol">android:</span>gravity=<span class="hljs-string">"center"</span><br><span class="hljs-symbol">android:</span><span class="hljs-keyword">text</span>=<span class="hljs-string">"12345678999"</span><br><span class="hljs-symbol">android:</span>textColor=<span class="hljs-string">"@android:color/black"</span><br><span class="hljs-symbol">android:</span>textSize=<span class="hljs-string">"16sp"</span> /&gt;<br><br>&lt;LinearLayout<br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"20dp"</span><br><span class="hljs-symbol">android:</span>layout_alignParentBottom=<span class="hljs-string">"true"</span><br><span class="hljs-symbol">android:</span>layout_marginBottom=<span class="hljs-string">"3dp"</span><br><span class="hljs-symbol">android:</span>layout_marginLeft=<span class="hljs-string">"10dp"</span><br><span class="hljs-symbol">android:</span>gravity=<span class="hljs-string">"center_vertical"</span> &gt;<br><br>&lt;ImageView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_time_clock_image"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"12dp"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"12dp"</span><br><span class="hljs-symbol">android:</span>src=<span class="hljs-string">"@mipmap/ts_login_clock"</span> /&gt;<br><br>&lt;TextView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_last_login_time"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_marginLeft=<span class="hljs-string">"5dp"</span><br><span class="hljs-symbol">android:</span>layout_toRightOf=<span class="hljs-string">"@id/ts_item_time_clock_image"</span><br><span class="hljs-symbol">android:</span><span class="hljs-keyword">text</span>=<span class="hljs-string">"上次登录"</span><br><span class="hljs-symbol">android:</span>textColor=<span class="hljs-string">"@android:color/darker_gray"</span><br><span class="hljs-symbol">android:</span>textSize=<span class="hljs-string">"11sp"</span> /&gt;<br><br>&lt;TextView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_login_time"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_marginLeft=<span class="hljs-string">"5dp"</span><br><span class="hljs-symbol">android:</span>layout_toRightOf=<span class="hljs-string">"@id/ts_item_last_login_time"</span><br><span class="hljs-symbol">android:</span><span class="hljs-keyword">text</span>=<span class="hljs-string">"59分钟前"</span><br><span class="hljs-symbol">android:</span>textColor=<span class="hljs-string">"@android:color/darker_gray"</span><br><span class="hljs-symbol">android:</span>textSize=<span class="hljs-string">"11sp"</span> /&gt;<br>&lt;/LinearLayout&gt;<br><br>&lt;TextView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_always_account_image_tips"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"wrap_content"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"13dp"</span><br><span class="hljs-symbol">android:</span>layout_alignParentRight=<span class="hljs-string">"true"</span><br><span class="hljs-symbol">android:</span>layout_marginTop=<span class="hljs-string">"2dp"</span><br><span class="hljs-symbol">android:</span>background=<span class="hljs-string">"@mipmap/ts_always_account_bg"</span><br><span class="hljs-symbol">android:</span>gravity=<span class="hljs-string">"center"</span><br><span class="hljs-symbol">android:</span><span class="hljs-keyword">text</span>=<span class="hljs-string">"常用"</span><br><span class="hljs-symbol">android:</span>textColor=<span class="hljs-string">"@android:color/white"</span><br><span class="hljs-symbol">android:</span>textSize=<span class="hljs-string">"9sp"</span> /&gt;<br><br>&lt;ImageView<br><span class="hljs-symbol">android:</span>id=<span class="hljs-string">"@+id/ts_item_delete_account_image"</span><br><span class="hljs-symbol">android:</span>layout_width=<span class="hljs-string">"12dp"</span><br><span class="hljs-symbol">android:</span>layout_height=<span class="hljs-string">"12dp"</span><br><span class="hljs-symbol">android:</span>layout_alignParentRight=<span class="hljs-string">"true"</span><br><span class="hljs-symbol">android:</span>layout_marginTop=<span class="hljs-string">"2dp"</span><br><span class="hljs-symbol">android:</span>layout_marginRight=<span class="hljs-string">"13dp"</span><br><span class="hljs-symbol">android:</span>layout_centerVertical=<span class="hljs-string">"true"</span><br><span class="hljs-symbol">android:</span>src=<span class="hljs-string">"@mipmap/ts_close"</span> /&gt;<br><br>&lt;/RelativeLayout&gt;<br></code></pre></td></tr></tbody></table></figure><p>发现哪里有问题了吗？问题在于ListView多余设置了背景：<code>android:background="@android:color/white"</code><br>，设置此背景对于我们这个需求根本就没有用，显示不出来并且增加GPU额外压力，去掉ListView背景之后再次观察如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427104105612-986672707.jpg"></p><p>渲染性能提升了一个档次，在实际工作中情况会复杂很多，为了实现一个效果会不得不牺牲性能，这就需要自己团队权衡了。</p><h2 id="clipRect解决自定义View的OverDraw"><a href="#clipRect解决自定义View的OverDraw" class="headerlink" title="clipRect解决自定义View的OverDraw"></a>clipRect解决自定义View的OverDraw</h2><p>平时写自定义View的时候有时会重写onDraw方法，但是Android系统是无法检测onDraw里面具体会执行什么操作，从而系统无法为我们做一些优化。这样对编程人员要求就高了，如果我们自己写的View有大量重叠的地方就造成了CPU,GPU资源的浪费，但是我们可以通过<code>canvas.clipRect()</code><br>来帮助系统识别那些可见的区域。这个方法可以指定一块矩形区域，只有在这个区域内才会被绘制，其他的区域会被忽视，下面我们通过谷歌提供的一个小demo进一步说明。实现效果如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427134333601-937366791.png"></p><p>主要就是卡片重叠效果，优化前代码实现如下：</p><p>DroidCard类封装要绘制的一个个卡片的信息：</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroidCard</span> {<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> x;<span class="hljs-comment">//左侧绘制起点</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> width;<br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> height;<br><span class="hljs-keyword">public</span> Bitmap bitmap;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DroidCard</span><span class="hljs-params">(Resources res,<span class="hljs-type">int</span> resId,<span class="hljs-type">int</span> x)</span></span>{<br><span class="hljs-keyword">this</span>.bitmap = BitmapFactory.<span class="hljs-built_in">decodeResource</span>(res,resId);<br><span class="hljs-keyword">this</span>.x = x;<br><span class="hljs-keyword">this</span>.width = <span class="hljs-keyword">this</span>.bitmap.<span class="hljs-built_in">getWidth</span>();<br><span class="hljs-keyword">this</span>.height = <span class="hljs-keyword">this</span>.bitmap.<span class="hljs-built_in">getHeight</span>();<br>}<br>}<br></code></pre></td></tr></tbody></table></figure><p>DroidCardsView为真正的自定义View:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroidCardsView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {<br><span class="hljs-comment">//图片与图片之间的间距</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mCardSpacing</span> <span class="hljs-operator">=</span> <span class="hljs-number">150</span>;<br><span class="hljs-comment">//图片与左侧距离的记录</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mCardLeft</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">private</span> List&lt;DroidCard&gt; mDroidCards = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DroidCard&gt;();<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">Paint</span> <span class="hljs-variable">paint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Paint</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DroidCardsView</span><span class="hljs-params">(Context context)</span> {<br><span class="hljs-built_in">super</span>(context);<br>initCards();<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DroidCardsView</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {<br><span class="hljs-built_in">super</span>(context, attrs);<br>initCards();<br>}<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 初始化卡片集合</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCards</span><span class="hljs-params">()</span>{<br><span class="hljs-type">Resources</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> getResources();<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res,R.drawable.alex,mCardLeft));<br><br>mCardLeft+=mCardSpacing;<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res,R.drawable.claire,mCardLeft));<br><br>mCardLeft+=mCardSpacing;<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res,R.drawable.kathryn,mCardLeft));<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDraw</span><span class="hljs-params">(Canvas canvas)</span> {<br><span class="hljs-built_in">super</span>.onDraw(canvas);<br><span class="hljs-keyword">for</span> (DroidCard c : mDroidCards){<br>drawDroidCard(canvas, c);<br>}<br>invalidate();<br>}<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 绘制DroidCard</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawDroidCard</span><span class="hljs-params">(Canvas canvas, DroidCard c)</span> {<br>canvas.drawBitmap(c.bitmap,c.x,<span class="hljs-number">0f</span>,paint);<br>}<br>}<br></code></pre></td></tr></tbody></table></figure><p>代码不是重点，不过也不难，自行查看就可以了。我们打开overdraw开关，效果如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427135142525-619373111.png"></p><p>淡红色区域明显被绘制了三次（三张图片重合的地方），其实下面的图片完全没必要完全绘制，只需要绘制三分之一即可，接下来我们就需要对其优化，保证最下面两张图片只需要回执其三分之一最上面图片完全绘制出来就可。</p><p>DroidCardsView代码优化为：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroidCardsView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {<br><br><span class="hljs-comment">//图片与图片之间的间距</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mCardSpacing</span> <span class="hljs-operator">=</span> <span class="hljs-number">150</span>;<br><span class="hljs-comment">//图片与左侧距离的记录</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mCardLeft</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">private</span> List&lt;DroidCard&gt; mDroidCards = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DroidCard&gt;();<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">Paint</span> <span class="hljs-variable">paint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Paint</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DroidCardsView</span><span class="hljs-params">(Context context)</span> {<br><span class="hljs-built_in">super</span>(context);<br>initCards();<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">DroidCardsView</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {<br><span class="hljs-built_in">super</span>(context, attrs);<br>initCards();<br>}<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 初始化卡片集合</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCards</span><span class="hljs-params">()</span>{<br><span class="hljs-type">Resources</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> getResources();<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res, R.drawable.alex,mCardLeft));<br><br>mCardLeft+=mCardSpacing;<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res, R.drawable.claire,mCardLeft));<br><br>mCardLeft+=mCardSpacing;<br>mDroidCards.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DroidCard</span>(res, R.drawable.kathryn,mCardLeft));<br>}<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDraw</span><span class="hljs-params">(Canvas canvas)</span> {<br><span class="hljs-built_in">super</span>.onDraw(canvas);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mDroidCards.size() - <span class="hljs-number">1</span>; i++){<br>drawDroidCard(canvas, mDroidCards,i);<br>}<br>drawLastDroidCard(canvas,mDroidCards.get(mDroidCards.size()-<span class="hljs-number">1</span>));<br>invalidate();<br>}<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 绘制最后一个DroidCard</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> canvas</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> c</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawLastDroidCard</span><span class="hljs-params">(Canvas canvas,DroidCard c)</span> {<br>canvas.drawBitmap(c.bitmap,c.x,<span class="hljs-number">0f</span>,paint);<br>}<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 绘制DroidCard</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> canvas</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> mDroidCards</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> i</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawDroidCard</span><span class="hljs-params">(Canvas canvas,List&lt;DroidCard&gt; mDroidCards,<span class="hljs-type">int</span> i)</span> {<br><span class="hljs-type">DroidCard</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> mDroidCards.get(i);<br>canvas.save();<br>canvas.clipRect((<span class="hljs-type">float</span>)c.x,<span class="hljs-number">0f</span>,(<span class="hljs-type">float</span>)(mDroidCards.get(i+<span class="hljs-number">1</span>).x),(<span class="hljs-type">float</span>)c.height);<br>canvas.drawBitmap(c.bitmap,c.x,<span class="hljs-number">0f</span>,paint);<br>canvas.restore();<br>}<br>}<br></code></pre></td></tr></tbody></table></figure><p>主要就是使用Canvas的clipRect方法，绘制之前裁剪出一个区域，这样绘制的时候只在这区域内绘制，超出部分不会绘制出来。</p><p>重新执行程序，效果如下：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427140830588-1561624230.png"></p><p>处理后性能就提升了一丝丝，此外我们还可以使用canvas.quickReject方法来判断是否没和某个矩形相交，从而跳过那些非矩形区域内的绘制操作。</p><h2 id="Hierarchy-Viewer的使用"><a href="#Hierarchy-Viewer的使用" class="headerlink" title="Hierarchy Viewer的使用"></a>Hierarchy Viewer的使用</h2><p>Hierarchy Viewer可以很直观的呈现布局的层次关系。我们可以通过红，黄，绿三种不同的颜色来区分布局的Measure，Layout，Executive的相对性能表现如何</p><p>提升布局性能的关键点是尽量保持布局层级的扁平化，避免出现重复的嵌套布局。如果我们写的布局层级比较深会严重增加CPU的负担，造成性能的严重卡顿，关于Hierarchy<br>Viewer的使用举例这里就不列举了。</p><h2 id="内存抖动现象"><a href="#内存抖动现象" class="headerlink" title="内存抖动现象"></a>内存抖动现象</h2><p>在我们优化过view的树形结构和overdraw之后，可能还是感觉自己的app有卡顿和丢帧，或者滑动慢：卡顿还是存在。这时我们就要查看一下是否存在内存抖动情况了</p><p>Android有自动管理内存的机制，但是对内存的不恰当使用仍然容易引起严重的性能问题。在同一帧里面创建过多的对象是件需要特别引起注意的事情，在同一帧里创建大量对象可能引起GC的不停操作，执行GC操作的时候，所有线程的任何操作都会需要暂停，直到GC操作完成。大量不停的GC操作则会显著占用帧间隔时间。</p><p>如果在帧间隔时间里面做了过多的GC操作，那么自然其他类似计算，渲染等操作的可用时间就变得少了，严重时可能引起卡顿：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427152217272-597281776.png"></p><p>导致GC频繁操作有两个主要原因：</p><ol><li>内存抖动，所谓内存抖动就是短时间产生大量对象又在短时间内马上释放。</li><li>短时间产生大量对象超出阈值，内存不够，同样会触发GC操作。</li></ol><p>观察内存抖动我们可以借助android studio中的工具，3.0以前可以使用android monitor,3.0以后被替换为android Profiler。</p><p>如果工具里面查看到短时间发生了多次内存的涨跌，这意味着很有可能发生了内存抖动，如图：</p><p><img src="https://images2018.cnblogs.com/blog/794139/201804/794139-20180427153938668-1405877845.png"></p><p>为了避免发生内存抖动，我们需要避免在for循环里面分配对象占用内存，需要尝试把对象的创建移到循环体之外，自定义View中的onDraw方法也需要引起注意，每次屏幕发生绘制以及动画执行过程中，onDraw方法都会被调用到，避免在onDraw方法里面执行复杂的操作，避免创建对象。对于那些无法避免需要创建对象的情况，我们可以考虑对象池模型，通过对象池来解决频繁创建与销毁的问题，但是这里需要注意结束使用之后，需要手动释放对象池中的对象。</p><h1 id="崩溃优化"><a href="#崩溃优化" class="headerlink" title="崩溃优化"></a>崩溃优化</h1><h2 id="崩溃"><a href="#崩溃" class="headerlink" title="崩溃"></a>崩溃</h2><p>崩溃率是衡量一个应用质量高低的基本指标，那么，该怎样客观地衡量崩溃这个指标，以及又该如何看待和崩溃相关的稳定性。</p><p>Android 的两种崩溃：</p><ol><li>Java 崩溃</li><li>Native 崩溃</li></ol><p>简单来说，Java 崩溃就是在 Java 代码中，出现了未捕获异常，导致程序异常退出。那 Native 崩溃一般都是因为在 Native<br>代码中访问非法地址，也可能是地址对齐出现了问题，或者发生了程序主动 Abort，这些都会产生相应的 Signal 信号，导致程序异常退出。</p><h3 id="崩溃的收集"><a href="#崩溃的收集" class="headerlink" title="崩溃的收集"></a>崩溃的收集</h3><p>“崩溃”就是程序出现异常，而一个产品的崩溃率，跟我们如何捕获、处理这些异常有比较大的关系。对于很多中小型公司来说，可以选择一些第三方的服务。目前各种平台也是百花齐放，包括阿里的友盟、腾讯的Bugly、网易云捕、Google<br>的 Firebase 等等。要懂得借力！</p><h3 id="ANR"><a href="#ANR" class="headerlink" title="ANR"></a>ANR</h3><p>崩溃率是不是就能完全等价于应用的稳定性呢？答案是肯定不行。处理了崩溃，我们还会经常遇到 ANR（Application Not<br>Responding，程序没有响应）这个问题。</p><p>出现 ANR 的时候，系统还会弹出对话框打断用户的操作，这是用户非常不能忍受的。</p><blockquote><p>ANR处理方法：<br>使用 FileObserver 监听 /data/anr/traces.txt 的变化。非常不幸的是，很多高版本的 ROM，已经没有读取这个文件的权限了。这个时候你可能只能思考其他路径，海外可以使用<br>Google Play 服务，而国内微信利用Hardcoder框架（HC 框架是一套独立于安卓系统实现的通信框架，它让 App 和厂商 ROM<br>能够实时“对话”了，目标就是充分调度系统资源来提升 App 的运行速度和画质，切实提高大家的手机使用体验）向厂商获取了更大的权限。也可以将手机<br>ROOT 掉，然后取得 traces.txt 文件。</p></blockquote><h3 id="应用退出"><a href="#应用退出" class="headerlink" title="应用退出"></a>应用退出</h3><p>除了常见的崩溃，还有一些会导致应用异常退出的情况，例如：</p><ol><li>主动自杀。Process.killProcess()、exit() 等</li><li>崩溃。出现了 Java 或 Native 崩溃</li><li>系统重启。系统出现异常、断电、用户主动重启等，我们可以通过比较应用开机运行时间是否比之前记录的值更小</li><li>被系统杀死。被 low memory killer 杀掉、从系统的任务管理器中划掉等</li><li>ANR</li></ol><p>我们可以在应用启动的时候设定一个标志，在主动自杀或崩溃后更新标志，这样下次启动时通过检测这个标志就能确认运行期间是否发生过异常退出。对应上面的五种退出场景，我们排除掉主动自杀和崩溃（崩溃会单独的统计）这两种场景，希望可以监控到剩下三种的异常退出，理论上这个异常捕获机制是可以达到<br>100% 覆盖的。</p><p>通过这个异常退出的检测，可以反映如 ANR、low memory<br>killer、系统强杀、死机、断电等其他无法正常捕获到的问题。当然异常率会存在一些误报，比如用户从系统的任务管理器中划掉应用。对于线上的大数据来说，还是可以帮助我们发现代码中的一些隐藏问题。</p><p>根据应用的前后台状态，我们可以把异常退出分为前台异常退出和后台异常退出。“被系统杀死” 是后台异常退出的主要原因，当然我们会更关注前台的异常退出的情况，这会跟<br>ANR、OOM 等异常情况有更大的关联。</p><h2 id="崩溃处理"><a href="#崩溃处理" class="headerlink" title="崩溃处理"></a>崩溃处理</h2><p>我们每天工作也会遇到各种各样的疑难问题，“崩溃”就是其中比较常见的一种问题。解决问题跟破案一样需要经验，我们分析的问题越多越熟练，定位问题就会越快越准。</p><p>当然这里也有很多套路，比如：</p><blockquote><ol><li>对于 “案发现场” 我们应该留意哪些信息？</li><li>怎样找到更多的 “证人” 和 “线索” ？</li><li>“侦查案件” 的一般流程是什么？</li><li>对不同类型的 “案件” 分别应该使用什么样的调查方式？</li></ol></blockquote><p>要相信 “真相永远只有一个”，崩溃也并不可怕。</p><h3 id="崩溃现场"><a href="#崩溃现场" class="headerlink" title="崩溃现场"></a>崩溃现场</h3><p>崩溃现场是我们的“第一案发现场”，它保留着很多有价值的线索。现在可以挖掘到的信息越多，下一步分析的方向就越清晰，而不是去靠盲目猜测。</p><p><strong>崩溃信息</strong></p><p>从崩溃的基本信息，我们可以对崩溃有初步的判断。进程名、线程名。崩溃的进程是前台进程还是后台进程，崩溃是不是发生在 UI 线程。</p><p>崩溃堆栈和类型。崩溃是属于 Java 崩溃、Native 崩溃，还是 ANR，对于不同类型的崩溃关注的点也不太一样。特别需要看崩溃堆栈的栈顶，看具体崩溃在系统的代码，还是<br>APP 代码里面。</p><p><strong>关键字：FATAL</strong></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">FATAL EXCEPTION: <span class="hljs-selector-tag">main</span><br>Process: com<span class="hljs-selector-class">.cchip</span><span class="hljs-selector-class">.csmart</span>, PID: <span class="hljs-number">27456</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.NullPointerException</span>: Attempt to invoke virtual method <span class="hljs-string">'void android.widget.TextView.setText(int)'</span> on <span class="hljs-selector-tag">a</span> null <span class="hljs-selector-tag">object</span> reference<br>at com<span class="hljs-selector-class">.cchip</span><span class="hljs-selector-class">.alicsmart</span><span class="hljs-selector-class">.activity</span>.SplashActivity$<span class="hljs-number">1</span><span class="hljs-selector-class">.handleMessage</span>(SplashActivity<span class="hljs-selector-class">.java</span>:<span class="hljs-number">67</span>)<br>at android<span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.Handler</span><span class="hljs-selector-class">.dispatchMessage</span>(Handler<span class="hljs-selector-class">.java</span>:<span class="hljs-number">102</span>)<br>at android<span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.Looper</span><span class="hljs-selector-class">.loop</span>(Looper<span class="hljs-selector-class">.java</span>:<span class="hljs-number">179</span>)<br>at android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ActivityThread</span><span class="hljs-selector-class">.main</span>(ActivityThread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">5672</span>)<br>at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Native Method)<br>at com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.os</span>.ZygoteInit<span class="hljs-variable">$MethodAndArgsCaller</span><span class="hljs-selector-class">.run</span>(ZygoteInit<span class="hljs-selector-class">.java</span>:<span class="hljs-number">784</span>)<br>at com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.ZygoteInit</span><span class="hljs-selector-class">.main</span>(ZygoteInit<span class="hljs-selector-class">.java</span>:<span class="hljs-number">674</span>)<br></code></pre></td></tr></tbody></table></figure><p><strong>系统信息</strong></p><p>系统的信息有时候会带有一些关键的线索，对我们解决问题有非常大的帮助。</p><p>Logcat。这里包括应用、系统的运行日志。由于系统权限问题，获取到的 Logcat 可能只包含与当前 APP 相关的。其中系统的 event logcat<br>会记录 APP 运行的一些基本情况，记录在文件 /system/etc/event-log-tags 中。</p><figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns">//system logcat:<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">788 21430</span> <span class="hljs-number">21430</span> D dalvikvm: Trying to load lib ...<br><br>//event logcat:<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">788 21430</span> <span class="hljs-number">21430</span> I am_on_resume_called: 生命周期<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">788 21430</span> <span class="hljs-number">21430</span> I am_low_memory: 系统内存不足<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">788 21430</span> <span class="hljs-number">21430</span> I am_destroy_activity: 销毁 Activty<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">888 21430</span> <span class="hljs-number">21430</span> I am_anr: ANR 以及原因<br><span class="hljs-number">10-25 17:13</span>:<span class="hljs-number">47</span>.<span class="hljs-number">888 21430</span> <span class="hljs-number">21430</span> I am_kill: APP 被杀以及原因<br></code></pre></td></tr></tbody></table></figure><p>机型、系统、厂商、CPU、ABI、Linux 版本等。通过采集多达几十个维度，这对寻找共性问题会很有帮助。</p><p><strong>内存信息</strong></p><p>OOM、ANR、虚拟内存耗尽等，很多崩溃都跟内存有直接关系。如果把用户的手机内存分为“2GB 以下”和“2GB 以上”两个区，就会发现“2GB<br>以下”用户的崩溃率是“2GB 以上”用户的几倍。</p><p>系统剩余内存。关于系统内存状态，可以直接读取文件 /proc/meminfo。当系统可用内存很小（低于 MemTotal 的 10%）时，OOM、大量<br>GC、系统频繁自杀拉起等问题都非常容易出现。</p><p>应用使用内存。包括 Java 内存、RSS（Resident Set Size）、PSS（Proportional Set Size），我们可以得出应用本身内存的占用大小和分布。PSS<br>和 RSS 通过 /proc/self/smap 计算，可以进一步得到例如 apk、dex、so 等更加详细的分类统计。</p><p>虚拟内存。虚拟内存可以通过 /proc/self/status 得到，通过 /proc/self/maps 文件可以得到具体的分布情况。有时候我们一般不太重视虚拟内存，但是很多类似<br>OOM、tgkill 等问题都是虚拟内存不足导致的。</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">Name: com.xmamiga.name <span class="hljs-regexp">//</span> 进程名<br>FDSize: <span class="hljs-number">800</span> <span class="hljs-regexp">//</span> 当前进程申请的文件句柄个数<br>VmPeak: <span class="hljs-number">3004628</span> kB <span class="hljs-regexp">//</span> 当前进程的虚拟内存峰值大小<br>VmSize: <span class="hljs-number">2997032</span> kB <span class="hljs-regexp">//</span> 当前进程的虚拟内存大小<br>Threads: <span class="hljs-number">600</span> <span class="hljs-regexp">//</span> 当前进程包含的线程个数<br></code></pre></td></tr></tbody></table></figure><p>一般来说，对于 32 位进程，如果是 32 位的 CPU，虚拟内存达到 3GB 就可能会引起内存申请失败的问题。如果是 64 位的 CPU，虚拟内存一般在<br>3～4GB 之间。当然如果我们支持 64 位进程，虚拟内存就不会成为问题。Google Play 要求 2019 年 8 月一定要支持 64 位，在国内虽然支持<br>64 位的设备已经在 90% 以上了，但是商店都不支持区分 CPU 架构类型发布，普及起来需要更长的时间。</p><p><strong>资源信息</strong></p><p>有的时候会发现应用堆内存和设备内存都非常充足，还是会出现内存分配失败的情况，这跟资源泄漏可能有比较大的关系。</p><p>文件句柄 fd。文件句柄的限制可以通过 /proc/self/limits 获得，一般单个进程允许打开的最大文件句柄个数为 1024。但是如果文件句柄超过<br>800 个就比较危险，需要将所有的 fd 以及对应的文件名输出到日志中，进一步排查是否出现了有文件或者线程的泄漏。</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">opened files <span class="hljs-keyword">count</span> <span class="hljs-number">812</span>:<br><span class="hljs-number">0</span> -&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br><span class="hljs-number">1</span> -&gt; <span class="hljs-regexp">/dev/</span>log/main4<br><span class="hljs-number">2</span> -&gt; <span class="hljs-regexp">/dev/</span>binder<br><span class="hljs-number">3</span> -&gt; <span class="hljs-regexp">/data/</span>data<span class="hljs-regexp">/com.xmamiga.sample/</span>files/test.conf<br>...<br></code></pre></td></tr></tbody></table></figure><p>线程数。当前线程数大小可以通过上面的 status 文件得到，一个线程可能就占 2MB 的虚拟内存，过多的线程会对虚拟内存和文件句柄带来压力。根据我的经验来说，如果线程数超过<br>400 个就比较危险。需要将所有的线程 id 以及对应的线程名输出到日志中，进一步排查是否出现了线程相关的问题。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">threads count 412:</span><br><span class="hljs-number">1820 </span><span class="hljs-string">com.xmamiga.crashsdk</span><br><span class="hljs-number">1844 </span><span class="hljs-string">ReferenceQueueD</span><br><span class="hljs-number">1869 </span><span class="hljs-string">FinalizerDaemon</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></tbody></table></figure><p>JNI。使用 JNI 时，如果不注意很容易出现引用失效、引用爆表等一些崩溃。</p><p><strong>应用信息</strong></p><p>除了系统，其实我们的应用更懂自己，可以留下很多相关的信息。崩溃场景。崩溃发生在哪个 Activity 或 Fragment，发生在哪个业务中;<br>关键操作路径，不同于开发过程详细的打点日志，我们可以记录关键的用户操作路径，这对我们复现崩溃会有比较大的帮助。其他自定义信息。不同的应用关心的重点可能不太一样。</p><h3 id="崩溃分析"><a href="#崩溃分析" class="headerlink" title="崩溃分析"></a>崩溃分析</h3><p>有了这么多现场信息之后，就可以开始真正的“破案”之旅了。绝大部分的 “案件”<br>只要肯花功夫，最后都能真相大白。不要畏惧问题，经过耐心和细心地分析，总能敏锐地发现一些异常或关键点，并且还要敢于怀疑和验证。</p><p><strong>第一步：确定重点</strong></p><p>确认和分析重点，关键在于终过日志中找到重要的信息，对问题有一个大致判断。一般来说，我建议在确定重点这一步可以关注以下几点。</p><blockquote><ol><li><p>确认严重程度。解决崩溃也要看性价比，我们优先解决 Top 崩溃或者对业务有重大影响，例如主要功能的崩溃。不要花几天去解决了一个边角的崩溃，有可能下个版本就把功能删除了。</p></li><li><p>崩溃基本信息。确定崩溃的类型以及异常描述，对崩溃有大致的判断。</p><p>一般来说，大部分的简单崩溃经过这一步已经可以得到结论。</p></li></ol></blockquote><p>Java 崩溃。Java 崩溃类型比较明显，比如 NullPointerException 是空指针，OutOfMemoryError 是资源不足，这个时候需要去进一步查看日志中的<br>“内存信息”和“资源信息”。</p><p>Native 崩溃。需要观察 signal、code、fault addr 等内容，以及崩溃时 Java 的堆栈。关于各 signal 含义的介绍，你可以查看崩溃信号介绍。比较常见的是有<br>SIGSEGV 和 SIGABRT，前者一般是由于空指针、非法指针造成，后者主要因为 ANR 和调用 abort() 退出所导致。</p><p>ANR。先看看主线程的堆栈，是否是因为锁等待导致。接着看看 ANR 日志中 iowait、CPU、GC、system server 等信息，进一步确定是 I/O<br>问题，或是 CPU 竞争问题，还是由于大量 GC 导致卡死。</p><p><strong>第二步：查找共性</strong></p><p>如果使用了上面的方法还是不能有效定位问题，我们可以尝试查找这类崩溃有没有什么共性。找到了共性，也就可以进一步找到差异，离解决问题也就更进一步。</p><p>机型、系统、ROM、厂商、ABI，这些采集到的系统信息都可以作为维度聚合，共性问题例如是不是只出现在 x86 的手机，是不是只有三星这款机型，是不是只在<br>Android 8.0 的系统上。应用信息也可以作为维度来聚合，比如正在打开的链接、正在播放的视频、国家、地区等。</p><p>找到了共性，可以对你下一步复现问题有更明确的指引。</p><p><strong>第三步：尝试复现</strong></p><p>如果我们已经大概知道了崩溃的原因，为了进一步确认更多信息，就需要尝试复现崩溃。如果我们对崩溃完全没有头绪，也希望通过用户操作路径来尝试重现，然后再去分析崩溃原因。</p><p>“只要能本地复现，我就能解”，相信这是很多开发跟测试说过的话。有这样的底气主要是因为在稳定的复现路径上面，我们可以采用增加日志或使用<br>Debugger、GDB 等各种各样的手段或工具做进一步分析。</p><p>我们可能会遇到了各种各样的奇葩问题。比如某个厂商改了底层实现、新的 Android 系统实现有所更改，都需要去<br>Google、翻源码，有时候还需要去抠厂商的 ROM 或手动刷 ROM。很多疑难问题需要我们耐得住寂寞，反复猜测、反复发灰度、反复验证。–但这种问题还是要看问题的严重程序，不可捡了芝麻丢了西瓜。</p><h3 id="系统崩溃"><a href="#系统崩溃" class="headerlink" title="系统崩溃"></a>系统崩溃</h3><p>系统崩溃常常令我们感到非常无助，它可能是某个 Android 版本的 Bug，也可能是某个厂商修改 ROM<br>导致。这种情况下的崩溃堆栈可能完全没有我们自己的代码，很难直接定位问题。能做的有：</p><blockquote><ol><li><p>查找可能的原因。通过上面的共性归类，我们先看看是某个系统版本的问题，还是某个厂商特定 ROM<br>  的问题。虽然崩溃日志可能没有我们自己的代码，但通过操作路径和日志，可以找到一些怀疑的点。</p></li><li><p>尝试规避。查看可疑的代码调用，是否使用了不恰当的 API，是否可以更换其他的实现方式规避。</p></li><li><p>Hook 解决。这里分为 Java Hook 和 Native Hook。它可能只出现在 Android 7.0 的系统中，参考 Android 8.0 的做法，直接 catch<br> 住这个异常。</p><p>如果做到了上面说的这些，以上大部分的崩溃应该都能解决或者规避，大部分的系统崩溃也是如此。当然总有一些疑难问题需要依赖到用户的真实环境，这些需要具备类似动态跟踪和调试的能力。</p></li></ol></blockquote><p>崩溃攻防是一个长期的过程，我们尽可能地提前预防崩溃的发生，将它消灭在萌芽阶段。作为技术人员，我们不应该盲目追求崩溃率这一个数字，应该以用户体验为先，如果强行去掩盖一些问题往往更加适得其反。我们不应该随意使用<br>try catch 去隐藏真正的问题，要从源头入手，了解崩溃的本质原因，保证后面的运行流程。在解决崩溃的过程，也要做到由点到面，不能只针对这个崩溃去解决，而应该要考虑这一类崩溃怎么解决和预防。</p><h1 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h1><p>在内存管理上，JVM拥有垃圾内存回收的机制，自身会在虚拟机层面自动分配和释放内存，因此不需要像使用C/C++一样在代码中分配和释放某一块内存。Android系统的内存管理类似于JVM，通过new关键字来为对象分配内存，内存的释放由GC来回收。并且Android系统在内存管理上有一个Generational<br>Heap Memory模型，当内存达到某一个阈值时，系统会根据不同的规则自动释放可以释放的内存。即便有了内存管理机制，但是，如果不合理地使用内存，也会造成一系列的性能问题，比如内存泄漏、内存抖动、短时间内分配大量的内存对象等等。</p><h2 id="优化工具"><a href="#优化工具" class="headerlink" title="优化工具"></a>优化工具</h2><h3 id="Memory-Profiler"><a href="#Memory-Profiler" class="headerlink" title="Memory Profiler"></a>Memory Profiler</h3><p>Memory profiler是Android Studio自带的一个内存检测工具，通过实时图表的方式展示内存信息，具有可以识别内存泄露，内存抖动等现象，并可以将捕获到的内存信息进行堆转储、强制GC以及跟踪内存分配的能力。</p><p>Android Studio打开Profiler工具</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f47365d43d"></p><p>观察Memory曲线，比较平缓即为内存分配正常，如果出现大的波动有可能发生了内存泄露。</p><blockquote><p>GC：可手动触发GC</p><p>Dump：Dump出当前Java Heap信息</p><p>Record：记录一段时间内的内存信息</p></blockquote><p><strong>点击Dump后</strong></p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40e18dca203"></p><p>可查看当前内存分配对象</p><blockquote><p>Allocations：分配对象个数</p><p>Native Size：Native内存大小</p><p>Shallow Size：对象本身占用内存的大小，不包含其引用的对象</p></blockquote><blockquote><p>Retained Size: 对象的Retained Size = 对象本身的Shallow Size + 对象能直接或间接访问到的对象的Shallow Size，也就是说<br>Retained Size 就是该对象被 Gc 之后所能回收内存的总和</p></blockquote><p>点击Bitmap Preview可以进行预览图片，对查看图片占用内存情况比较有帮助</p><p><strong>点击Record后</strong></p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f5189df885"></p><p>可以记录一段时间内内存分配情况，可查看各对象分配大小及调用栈、对象生成位置</p><h3 id="Memory-Analyzer（MAT）"><a href="#Memory-Analyzer（MAT）" class="headerlink" title="Memory Analyzer（MAT）"></a>Memory Analyzer（MAT）</h3><p>比Memory Profiler更强大的Java Heap分析工具，可以准确查找内存泄露以及内存占用情况，还可以生成整体报告，用来分析问题等。</p><p>MAT一般用来线下结合Memory Profiler分析问题使用，Memory Profiler可以直观看出内存抖动，然后生成的hdprof文件，通过MAT深入分析及定位内存泄露问题。</p><h3 id="LeakCannary"><a href="#LeakCannary" class="headerlink" title="LeakCannary"></a>LeakCannary</h3><p>Leak Cannary是一个能自动监测内存泄露的线下监测工具。</p><h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><h3 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a>内存区域</h3><p>Java内存划分为方法区、堆、程序计数器、本地方法栈、虚拟机栈五个区域；</p><p>线程维度分为线程共享区和线程隔离区，方法区和堆是线程共享的，程序计数器、本地方法栈、虚拟机栈是线程隔离的，如下图</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f4abba75fe"></p><p><strong>方法区</strong></p><ul><li>线程共享区域，用于存储类信息、静态变量、常量、即时编译器编译出来的代码数据</li><li>无法满足内存分配需求时会发生OOM</li></ul><p><strong>堆</strong></p><ul><li>线程共享区域，是JAVA虚拟机管理的内存中最大的一块，在虚拟机启动时创建</li><li>存放对象实例，几乎所有的对象实例都在堆上分配，GC管理的主要区域</li></ul><p><strong>虚拟机栈</strong></p><ul><li>线程私有区域，每个java方法在执行的时候会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。方法从执行开始到结束过程就是栈帧在虚拟机栈中入栈出栈过程</li><li>局部变量表存放编译期可知的基本数据类型、对象引用、returnAddress类型。所需的内存空间会在编译期间完成分配，进入一个方法时在帧中局部变量表的空间是完全确定的，不需要运行时改变</li><li>若线程申请的栈深度大于虚拟机允许的最大深度，会抛出SatckOverFlowError错误</li><li>虚拟机动态扩展时，若无法申请到足够内存，会抛出OutOfMemoryError错误</li></ul><p><strong>本地方法栈</strong></p><ul><li>为虚拟机中Native方法服务，对本地方法栈中使用的语言、数据结构、使用方式没有强制规定，虚拟机可自有实现</li><li>占用的内存区大小是不固定的，可根据需要动态扩展</li></ul><p><strong>程序计数器</strong></p><ul><li>一块较小的内存空间，线程私有，存储当前线程执行的字节码行号指示器</li><li>字节码解释器通过改变这个计数器的值来选取下一条需要执行的字节码指令：分支、循环、跳转等</li><li>每个线程都有一个独立的程序计数器</li><li>唯一一个在java虚拟机中不会OOM的区域</li></ul><h3 id="对象存活判断"><a href="#对象存活判断" class="headerlink" title="对象存活判断"></a>对象存活判断</h3><p><strong>引用计数法</strong></p><ul><li>给对象添加引用计数器，每当一个地方引用时，计数器加1，引用失效时计数器减1；当引用计数器为0时即为对象不可用</li><li>实现简单，效率高，但是无法解决相互引用问题，主流虚拟机一般不使用此方法判断对象是否存活</li></ul><p><strong>可达性分析法</strong></p><ul><li>从一些称为”GC Roots”的对象作为起点，向下搜索，搜索走过的路径称为引用链，当一个对象到GC Roots没有任何引用链时即为对象不可用，可被回收的</li><li>可被称为GC Roots的对象：虚拟机栈中引用的对象、方法区中类静态属性引用的对象、方法区中常量引用的对象、本地方法栈中引用的对象</li></ul><p><strong>GC Root有以下几种：</strong></p><ol><li>Class-由系统ClassLoader加载的对象</li><li>Thread-活着的线程</li><li>Stack Local-Java方法的local变量或参数</li><li>JNI Local – JNI方法的local变量或参数</li><li>JNI Global – 全局JNI引用</li><li>Monitor Used – 用于同步的监控对象</li></ol><h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h3><p><strong>标记清除算法</strong></p><p>标记清除算法有两个阶段，首先标记出需要回收的对象，在标记完成后统一回收所有标记的对象；</p><p>缺点：</p><ul><li>效率问题：标记和清除两个过程效率都不高</li><li>空间问题：标记清除之后会导致很多不连续的内存碎片，会导致需要分配大对象时无法找到足够的连续空间而不得不触发GC的问题</li></ul><p><strong>复制算法</strong></p><p>将可用内存按空间分为大小相同的两小块，每次只使用其中的一块，等这块内存使用完了将还存活的对象复制到另一块内存上，然后将这块内存区域对象整体清除掉。每次对整个半区进行内存回收，不会导致碎片问题，实现简单高效。</p><p>缺点：</p><ul><li>需要将内存缩小为原来的一半，空间代价太高</li></ul><p><strong>标记整理算法</strong></p><p>标记整理算法标记过程和标记清除算法一样，但清除过程并不是对可回收对象直接清理，而是将所有存活对象像一端移动，然后集中清理到端边界以外的内存。</p><p><strong>分代收集算法</strong></p><p>当代虚拟机垃圾回收算法都采用分代收集算法来收集，根据对象存活周期不同将内存划分为新生代和老年代，再根据每个年代的特点采用最合适的算法。</p><ul><li>新生代存活对象较少，每次垃圾回收都有大量对象死去，一般采用复制算法，只需要付出复制少量存活对象的成本就可以实现垃圾回收；</li><li>老年代存活对象较多，没有额外空间进行分配担保，就必须采用标记清除算法和标记整理算法进行回收；</li></ul><h2 id="内存抖动"><a href="#内存抖动" class="headerlink" title="内存抖动"></a>内存抖动</h2><p>内存频繁分配和回收导致内存不稳定</p><ul><li>频繁GC，内存曲线呈现锯齿状，会导致卡顿</li><li>频繁的创建对象会导致内存不足及碎片</li><li>不连续的内存碎片无法被释放，导致OOM</li></ul><h3 id="模拟内存抖动"><a href="#模拟内存抖动" class="headerlink" title="模拟内存抖动"></a>模拟内存抖动</h3><p>执行此段代码</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Handler</span> mShakeHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">Message msg</span>) {<br>        <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">handleMessage</span>(msg);<br>        <span class="hljs-comment">// 频繁创建对象，模拟内存抖动</span><br>        <span class="hljs-keyword">for</span>(int index = <span class="hljs-number">0</span>;index &lt;= <span class="hljs-number">100</span>;index ++) {<br>            <span class="hljs-title class_">String</span> strArray[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">100000</span>];<br>        }<br>        mShakeHandler.<span class="hljs-title function_">sendEmptyMessageDelayed</span>(<span class="hljs-number">0</span>,<span class="hljs-number">30</span>);<br>    }<br>};<br></code></pre></td></tr></tbody></table></figure><h3 id="分析并定位"><a href="#分析并定位" class="headerlink" title="分析并定位"></a>分析并定位</h3><p>利用Memory Profiler工具查看内存信息</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f4b2e12bbc"></p><p>发现内存曲线由原来的平稳曲线变成锯齿状</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f4bd27aed8"></p><p>点击record记录内存信息，查找发生内存抖动位置，发现String对象ShallowSize非常异常，可直接通过Jump to Source定位到代码位置</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab428ac88b8cf"></p><h2 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h2><p><strong>定义</strong>：内存中存在已经没有用确无法回收的对象</p><p><strong>现象</strong>：会导致内存抖动，可用内存减少，进而导致GC频繁、卡顿、OOM</p><h3 id="模拟内存泄露"><a href="#模拟内存泄露" class="headerlink" title="模拟内存泄露"></a>模拟内存泄露</h3><p>模拟内存泄露代码，反复进入退出该Activity</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 模拟内存泄露的Activity</span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> MemoryLeakActivity extends AppCompatActivity implements CallBack{<br>    @Override<br>    protected void on<span class="hljs-constructor">Create(@Nullable Bundle <span class="hljs-params">savedInstanceState</span>)</span> {<br>        super.on<span class="hljs-constructor">Create(<span class="hljs-params">savedInstanceState</span>)</span>;<br>        set<span class="hljs-constructor">ContentView(R.<span class="hljs-params">layout</span>.<span class="hljs-params">activity_memoryleak</span>)</span>;<br>        ImageView imageView = find<span class="hljs-constructor">ViewById(R.<span class="hljs-params">id</span>.<span class="hljs-params">iv_memoryleak</span>)</span>;<br>        Bitmap bitmap = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BitmapFactory</span>.</span></span>decode<span class="hljs-constructor">Resource(<span class="hljs-params">getResources</span>()</span>, <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">R</span>.</span></span>mipmap.splash);<br>        imageView.set<span class="hljs-constructor">ImageBitmap(<span class="hljs-params">bitmap</span>)</span>;<br>        <br>        <span class="hljs-comment">// 添加静态类引用</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">CallBackManager</span>.</span></span>add<span class="hljs-constructor">CallBack(<span class="hljs-params">this</span>)</span>;<br>    }<br>    @Override<br>    protected void on<span class="hljs-constructor">Destroy()</span> {<br>        super.on<span class="hljs-constructor">Destroy()</span>;<br><span class="hljs-comment">//        CallBackManager.removeCallBack(this);</span><br>    }<br>    @Override<br>    public void dp<span class="hljs-constructor">Operate()</span> {<br>        <span class="hljs-comment">// do sth</span><br>    }<br></code></pre></td></tr></tbody></table></figure><h3 id="分析并定位-1"><a href="#分析并定位-1" class="headerlink" title="分析并定位"></a>分析并定位</h3><p>通过Memory Profiler工具查看内存曲线，发现内存在不断的上升</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40e2d62dbc7"></p><p>如果想分析定位具体发生内存泄露位置需要借助MAT工具</p><p>首先生成hprof文件</p><p>点击dump将当前内存信息转成hprof文件，需要对生成的文件转换成MAT可读取文件</p><p>执行一下转换命令（Android/sdk/platorm-tools路径下）</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">hprof-conv 刚刚生成的hprof文件 <span class="hljs-keyword">memory</span>-<span class="hljs-keyword">mat</span>.hprof<br></code></pre></td></tr></tbody></table></figure><p>使用mat打开刚刚转换的hprof文件</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40de67d9377"></p><p>点击Historygram，搜索MemoryLeakActivity</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3f7b7828c99"></p><p>可以看到有8个MemoryLeakActivity未释放</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fa542aa377"></p><p>查看所有引用对象</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fb31c51990"></p><p>查看到GC Roots的引用链</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab415cc3f2f0f"></p><p>可以看到GC Roots是CallBackManager</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fd8e85b3d9"></p><p>解决问题，当Activity销毁时将当前引用移除</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {<br>    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onDestroy</span>();<br>    <span class="hljs-title class_">CallBackManager</span>.<span class="hljs-title function_">removeCallBack</span>(<span class="hljs-variable language_">this</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="MAT分析工具"><a href="#MAT分析工具" class="headerlink" title="MAT分析工具"></a>MAT分析工具</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>当前内存整体信息</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fd96215a96"></p><h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>列举对象所有的实例及实例所占大小，可按package排序</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fde16df094"></p><p>可以查看应用包名下Activity存在实例个数，可以查看是否存在内存泄露，这里发现内存中有8个Activity实例未释放</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40e2ebdfd30"></p><p>查看未被释放的Activity的引用链</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab3fea58ec50a"></p><h3 id="Dominator-tree"><a href="#Dominator-tree" class="headerlink" title="Dominator_tree"></a>Dominator_tree</h3><p>当前所有实例的支配树，和Histogram区别时Histogram是类维度，dominator_tree是实例维度，可以查看所有实例的所占百分比和引用链</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab400fb3064a1"></p><h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p>通过sql语句查询相关类信息</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40f7375b7b4"></p><h3 id="Thread-overview"><a href="#Thread-overview" class="headerlink" title="Thread_overview"></a>Thread_overview</h3><p>查看当前所有线程信息</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40fed68db9e"></p><h3 id="Top-Consumers"><a href="#Top-Consumers" class="headerlink" title="Top Consumers"></a>Top Consumers</h3><p>通过图形方式展示占用内存较高的对象，对降低内存栈优化可用内存比较有帮助</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab402bef16ff2"></p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab40ffa3c75d1"></p><h3 id="Leak-Suspects"><a href="#Leak-Suspects" class="headerlink" title="Leak Suspects"></a>Leak Suspects</h3><p>内存泄露分析页面</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab4034a3f9c59"></p><p>直接定位到内存泄露位置</p><p><img src="https://user-gold-cdn.xitu.io/2020/3/5/170ab4038d5229f9"></p><h2 id="通过ARTHook检测不合理图片"><a href="#通过ARTHook检测不合理图片" class="headerlink" title="通过ARTHook检测不合理图片"></a>通过ARTHook检测不合理图片</h2><h3 id="获取Bitmap占用内存"><a href="#获取Bitmap占用内存" class="headerlink" title="获取Bitmap占用内存"></a>获取Bitmap占用内存</h3><ul><li>通过getByteCount方法，但是需要在运行时获取</li><li>width * height * 一个像素所占内存 * 图片所在资源目录压缩比</li></ul><h3 id="检测大图"><a href="#检测大图" class="headerlink" title="检测大图"></a>检测大图</h3><p>当图片控件load图片大小超过控件自身大小时会造成内存浪费，所以检测出不合理图片对内存优化是很重要的。</p><p><strong>ARTHook方式检测不合理图片</strong></p><p>通过ARTHook方法可以优雅的获取不合理图片，侵入性低，但是因为兼容性问题一般在线下使用。</p><p>引入epic开源库</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">implementation</span> 'me.weishu:epic:<span class="hljs-number">0</span>.<span class="hljs-number">3</span>.<span class="hljs-number">6</span>'<br></code></pre></td></tr></tbody></table></figure><p>实现Hook方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckBitmapHook</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">XC_MethodHook</span> {<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable {<br>        <span class="hljs-built_in">super</span>.afterHookedMethod(param);<br>        <span class="hljs-type">ImageView</span> <span class="hljs-variable">imageView</span> <span class="hljs-operator">=</span> (ImageView)param.thisObject;<br>        checkBitmap(imageView,imageView.getDrawable());<br>    }<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkBitmap</span><span class="hljs-params">(Object o,Drawable drawable)</span> {<br>        <span class="hljs-keyword">if</span>(drawable <span class="hljs-keyword">instanceof</span> BitmapDrawable &amp;&amp; o <span class="hljs-keyword">instanceof</span> View) {<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Bitmap</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> ((BitmapDrawable) drawable).getBitmap();<br>            <span class="hljs-keyword">if</span>(bitmap != <span class="hljs-literal">null</span>) {<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> (View)o;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> view.getWidth();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> view.getHeight();<br>                <span class="hljs-keyword">if</span>(width &gt; <span class="hljs-number">0</span> &amp;&amp; height &gt; <span class="hljs-number">0</span>) {<br>                    <span class="hljs-keyword">if</span>(bitmap.getWidth() &gt; (width &lt;&lt;<span class="hljs-number">1</span>) &amp;&amp; bitmap.getHeight() &gt; (height &lt;&lt; <span class="hljs-number">1</span>)) {<br>                        warn(bitmap.getWidth(),bitmap.getHeight(),width,height,<br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Bitmap size is too large"</span>));<br>                    }<br>                } <span class="hljs-keyword">else</span> {<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">Throwable</span> <span class="hljs-variable">stacktrace</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>                    view.getViewTreeObserver().addOnPreDrawListener(<br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewTreeObserver</span>.OnPreDrawListener() {<br>                                <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onPreDraw</span><span class="hljs-params">()</span> {<br>                                    <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> view.getWidth();<br>                                    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> view.getHeight();<br>                                    <span class="hljs-keyword">if</span>(w &gt; <span class="hljs-number">0</span> &amp;&amp; h &gt; <span class="hljs-number">0</span>) {<br>                                        <span class="hljs-keyword">if</span> (bitmap.getWidth() &gt;= (w &lt;&lt; <span class="hljs-number">1</span>)<br>                                                &amp;&amp; bitmap.getHeight() &gt;= (h &lt;&lt; <span class="hljs-number">1</span>)) {<br>                                            warn(bitmap.getWidth(), bitmap.getHeight(), w, h, stacktrace);<br>                                        }<br>                                        view.getViewTreeObserver().removeOnPreDrawListener(<span class="hljs-built_in">this</span>);<br>                                    }<br>                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                                }<br>                            });<br>                }<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(<span class="hljs-type">int</span> bitmapWidth, <span class="hljs-type">int</span> bitmapHeight, <span class="hljs-type">int</span> viewWidth, <span class="hljs-type">int</span> viewHeight, Throwable t)</span> {<br>        <span class="hljs-type">String</span> <span class="hljs-variable">warnInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"Bitmap size too large: "</span>)<br>                .append(<span class="hljs-string">"\n real size: ("</span>).append(bitmapWidth).append(<span class="hljs-string">','</span>).append(bitmapHeight).append(<span class="hljs-string">')'</span>)<br>                .append(<span class="hljs-string">"\n desired size: ("</span>).append(viewWidth).append(<span class="hljs-string">','</span>).append(viewHeight).append(<span class="hljs-string">')'</span>)<br>                .append(<span class="hljs-string">"\n call stack trace: \n"</span>).append(Log.getStackTraceString(t)).append(<span class="hljs-string">'\n'</span>)<br>                .toString();<br>        LogUtils.i(warnInfo);<br></code></pre></td></tr></tbody></table></figure><p>Application初始化时注入Hook</p><figure class="highlight d"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs d">DexposedBridge.hookAllConstructors(ImageView.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> XC_MethodHook() {<br>    <span class="hljs-keyword">@Override</span> <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> afterHookedMethod(MethodHookParam param) throws Throwable {<br>        <span class="hljs-keyword">super</span>.afterHookedMethod(param);<br>        DexposedBridge.findAndHookMethod(ImageView.<span class="hljs-keyword">class</span>,<span class="hljs-string">"setImageBitmap"</span>, Bitmap.<span class="hljs-keyword">class</span>,<br>                <span class="hljs-keyword">new</span> CheckBitmapHook());<br>    }<br>});<br></code></pre></td></tr></tbody></table></figure><h2 id="线上内存监控"><a href="#线上内存监控" class="headerlink" title="线上内存监控"></a>线上内存监控</h2><h3 id="常规方案"><a href="#常规方案" class="headerlink" title="常规方案"></a>常规方案</h3><p><strong>常规方案一</strong></p><p>在特定场景中获取当前占用内存大小，如果当前内存大小超过系统最大内存80%，对当前内存进行一次Dump（Debug.dumpHprofData()<br>），选择合适时间将hprof文件进行上传，然后通过MAT工具手动分析该文件。</p><p>缺点：</p><ul><li>Dump文件比较大，和用户使用时间、对象树正相关</li><li>文件较大导致上传失败率较高，分析困难</li></ul><p><strong>常规方案二</strong></p><p>将LeakCannary带到线上，添加预设怀疑点，对怀疑点进行内存泄露监控，发现内存泄露回传到server。</p><p>缺点：</p><ul><li>通用性较低，需要预设怀疑点，对没有预设怀疑点的地方监控不到</li><li>LeakCanary分析比较耗时、耗内存，有可能会发生OOM</li></ul><h3 id="LeakCannary定制改造"><a href="#LeakCannary定制改造" class="headerlink" title="LeakCannary定制改造"></a>LeakCannary定制改造</h3><ol><li>将需要预设怀疑点改为自动寻找怀疑点，自动将前内存中所占内存较大的对象类中设置怀疑点。</li><li>LeakCanary分析泄露链路比较慢，改造为只分析Retain size大的对象。</li><li>分析过程会OOM，是因为LeakCannary分析时会将分析对象全部加载到内存当中，我们可以记录下分析对象的个数和占用大小，对分析对象进行裁剪，不全部加载到内存当中。</li></ol><h3 id="完整方案"><a href="#完整方案" class="headerlink" title="完整方案"></a>完整方案</h3><ol><li>监控常规指标：待机内存、重点模块占用内存、OOM率</li><li>监控APP一个生命周期内和重点模块界面的生命周期内的GC次数、GC时间等</li><li>将定制的LeakCanary带到线上，自动化分析线上的内存泄露</li></ol><h1 id="卡顿优化"><a href="#卡顿优化" class="headerlink" title="卡顿优化"></a>卡顿优化</h1><h2 id="卡顿"><a href="#卡顿" class="headerlink" title="卡顿"></a>卡顿</h2><p>在应用开发中如果留意到log的话有时候可能会发下下面的log信息：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">I/Choreographer(<span class="hljs-number">1200</span>):Skipped 60frames!The application may be doing too much work on its main thread.<br></code></pre></td></tr></tbody></table></figure><p>在大部分Android平台的设备上，Android系统是16ms刷新一次，也就是一秒钟60帧。要达到这种刷新速度就要求在ui线程中处理的任务时间必须要小于16ms，如果ui线程中处理时间长，就会导致跳过帧的渲染，也就是导致界面看起来不流畅，卡顿。如果用户点击事件5s中没反应就会导致ANR。</p><h2 id="帧率"><a href="#帧率" class="headerlink" title="帧率"></a>帧率</h2><p>即 Frame Rate，单位 fps，是指 gpu 生成帧的速率，60fps，Android中更帧率相关的类是SurfaceFlinger。</p><p><strong>SurfaceFlinger</strong><br>surfaceflinger作用是接受多个来源的图形显示数据，将他们合成，然后发送到显示设备。比如打开应用，常见的有三层显示，顶部的statusbar底部或者侧面的导航栏以及应用的界面，每个层是单独更新和渲染，这些界面都是有surfaceflinger合成一个刷新到硬件显示。<br><img src="https://img-blog.csdnimg.cn/20200617103126541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>在显示过程中使用到了bufferqueue，surfaceflinger作为consumer方，比如windowmanager管理的surface作为生产方产生页面，交由surfaceflinger进行合成。</p><p><img src="https://img-blog.csdnimg.cn/20200617101750496.png" alt="在这里插入图片描述"><br><strong>VSync</strong></p><p>Android系统每隔16ms发出VSYNC信号，触发对UI进行渲染，VSync是Vertical Synchronization(垂直同步)<br>的缩写，是一种在PC上很早就广泛使用的技术，可以简单的把它认为是一种定时中断。而在Android 4.1(JB)<br>中已经开始引入VSync机制，用来同步渲染，让UI和SurfaceFlinger可以按硬件产生的VSync节奏进行工作。</p><p>安卓系统中有 2 种 VSync 信号：<br>1、屏幕产生的硬件 VSync： 硬件 VSync 是一个脉冲信号，起到开关或触发某种操作的作用。<br>2、由 SurfaceFlinger 将其转成的软件 Vsync 信号：经由 Binder 传递给 Choreographer。</p><p>除了Vsync的机制，Android还使用了多级缓冲的手段以优化UI流程度，例如双缓冲(A+B)，在显示buffer A的数据时，CPU/GPU就开始在buffer<br>B中准备下一帧数据：但是不能保证每一帧CPU、GPU都运行状态良好，可能由于资源抢占等性能问题导致某一帧GPU掉链子，vsync信号到来时buffer<br>B的数据还没准备好，而此时Display又在显示buffer A的数据，导致后面CPU/GPU没有新的buffer着手准备数据，导致卡顿（jank）。<br><img src="https://img-blog.csdnimg.cn/20200619101533702.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="卡顿原因"><a href="#卡顿原因" class="headerlink" title="卡顿原因"></a>卡顿原因</h2><p>从系统层面上看主要以下几个方面的原因会导致卡顿：<br><strong>1. SurfaceFlinger 主线程耗时</strong></p><p>SurfaceFlinger 负责 Surface 的合成 , 一旦 SurfaceFlinger 主线程调用超时 , 就会产生掉帧 .<br>SurfaceFlinger 主线程耗时会也会导致 hwc service 和 crtc 不能及时完成, 也会阻塞应用的 binder 调用, 如 dequeueBuffer <br>queueBuffer 等.</p><p><strong>2. 后台活动进程太多导致系统繁忙</strong></p><p>后台进程活动太多,会导致系统非常繁忙, cpu \ io \ memory 等资源都会被占用, 这时候很容易出现卡顿问题 , 这也是系统这边经常会碰到的问题。<br><strong>dumpsys cpuinfo 可以查看一段时间内 cpu 的使用情况：</strong><br><img src="https://img-blog.csdnimg.cn/20200619101827920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>3.主线程调度不到 , 处于 Runnable 状态</strong></p><p>当线程为 Runnable 状态的时候 , 调度器如果迟迟不能对齐进行调度 , 那么就会产生长时间的 Runnable 线程状态 , 导致错过 Vsync<br>而产生流畅性问题。</p><p><strong>4、System 锁</strong></p><p>system_server 的 AMS 锁和 WMS 锁 , 在系统异常的情况下 , 会变得非常严重 , 如下图所示 , 许多系统的关键任务都被阻塞 ,<br>等待锁的释放 , 这时候如果有 App 发来的 Binder 请求带锁 , 那么也会进入等待状态 , 这时候 App 就会产生性能问题 ; 如果此时做<br>Window 动画 , 那么 system_server 的这些锁也会导致窗口动画卡顿<br><img src="https://img-blog.csdnimg.cn/20200619102031218.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>5、Layer过多导致 SurfaceFlinger Layer Compute 耗时</strong></p><p>Android P 修改了 Layer 的计算方法 , 把这部分放到了 SurfaceFlinger 主线程去执行, 如果后台 Layer 过多, 就会导致<br>SurfaceFlinger 在执行 rebuildLayerStacks 的时候耗时 , 导致 SurfaceFlinger 主线程执行时间过长。<br><img src="https://img-blog.csdnimg.cn/20200619102324220.png" alt="在这里插入图片描述"><br>从应用层来看以下会导致卡顿：</p><p><strong>1、主线程执行时间长</strong><br>主线程执行 Input \ Animation \ Measure \ Layout \ Draw \ decodeBitmap 等操作超时都会导致卡顿 。</p><ul><li>1、Measure \ Layout 耗时\超时</li></ul><p><img src="https://img-blog.csdnimg.cn/20200619103556294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>2、draw耗时</li></ul><p><img src="https://img-blog.csdnimg.cn/20200619103632673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>3、Animation回调耗时</li></ul><p><img src="https://img-blog.csdnimg.cn/20200619103717321.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>4、View 初始化耗时</li></ul><p><img src="https://img-blog.csdnimg.cn/20200619103810150.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>5、List Item 初始化耗时</li></ul><p><img src="https://img-blog.csdnimg.cn/20200619103839118.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>6、主线程操作数据库</li></ul><p><strong>2、主线程 Binder 耗时</strong></p><p>Activity resume 的时候, 与 AMS 通信要持有 AMS 锁, 这时候如果碰到后台比较繁忙的时候, 等锁操作就会比较耗时, 导致部分场景因为这个卡顿,<br>比如多任务手势操作。<br><img src="https://img-blog.csdnimg.cn/2020061910395626.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p><strong>3、WebView 性能不足</strong></p><p>应用里面涉及到 WebView 的时候, 如果页面比较复杂, WebView 的性能就会比较差, 从而造成卡顿<br><img src="https://img-blog.csdnimg.cn/20200619104046115.png" alt="在这里插入图片描述"></p><p><strong>4、帧率与刷新率不匹配</strong></p><p>如果屏幕帧率和系统的 fps 不相符 , 那么有可能会导致画面不是那么顺畅. 比如使用 90 Hz 的屏幕搭配 60 fps 的动画。<br><img src="https://img-blog.csdnimg.cn/20200619104123839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="卡顿检测"><a href="#卡顿检测" class="headerlink" title="卡顿检测"></a>卡顿检测</h2><p>卡顿检测可以使用以下多种方法同时进行：<br><strong>1、使用dumpsys gfxinfo</strong><br><strong>2、使用Systrace获取相关信息</strong><br><strong>3、使用LayoutInspect 检测布局层次</strong><br><strong>4、使用BlockCanary</strong><br><strong>5、利用Choreographer。</strong><br><strong>6、使用严格模式（StrictMode ）。</strong></p><h3 id="使用dumpsys-gfxinfo"><a href="#使用dumpsys-gfxinfo" class="headerlink" title="使用dumpsys gfxinfo"></a>使用dumpsys gfxinfo</h3><p>在开发过程中发现有卡顿发生时可以使用下面的命令来获取卡顿相关的信息：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">adb shell dumpsys gfxinfo[PACKAGE_NAME]<br></code></pre></td></tr></tbody></table></figure><p>输入这个命令后可能会打印下面的信息：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">Applications Graphics Acceleration Info:<br>        Uptime:102809662Realtime:<span class="hljs-number">196891968</span><br>        **Graphics info <span class="hljs-keyword">for</span> pid <span class="hljs-number">31148</span>[com.android.settings]**<br>        Stats since:524615985046231ns<br>        Total frames rendered:<span class="hljs-number">8325</span><br>        Janky frames:<span class="hljs-number">729</span>(<span class="hljs-number">8.76</span>%)<br>        90th percentile:13ms<br>        95th percentile:20ms<br>        99th percentile:73ms<br>        Number Missed Vsync:<span class="hljs-number">294</span><br>        Number High input latency:<span class="hljs-number">47</span><br>        Number Slow UI thread:<span class="hljs-number">502</span><br>        Number Slow bitmap uploads:<span class="hljs-number">44</span><br>        Number Slow issue draw commands:<span class="hljs-number">135</span><br></code></pre></td></tr></tbody></table></figure><p>上面参数说明：</p><p><strong>Graphics info for pid 31148 [com.android.settings]</strong>: 表明当前dump的为设置界面的帧信息，pid为31148<br><strong>Total frames rendered</strong>: 8325 本次dump搜集了8325帧的信息</p><p><strong>Janky frames</strong> :729 (8.76%)出现卡顿的帧数有729帧，占8.76%</p><p><strong>Number Missed Vsync</strong>: 294 垂直同步失败的帧</p><p><strong>Number Slow UI thread</strong>: 502 因UI线程上的工作导致超时的帧数</p><p><strong>Number Slow bitmap uploads</strong>: 44 因bitmap的加载耗时的帧数</p><p><strong>Number Slow issue draw commands</strong>: 135 因绘制导致耗时的帧数</p><h3 id="使用systrace"><a href="#使用systrace" class="headerlink" title="使用systrace"></a>使用systrace</h3><p>上面使用的dumpsys是能发现问题或者判断问题的严重性，但无法定位真正的原因。如果要定位原因，应当配合systrace工具使用。</p><p><strong>systrace使用</strong></p><p>Systrace可以帮助分析应用是如何设备上运行起来的，它将系统和应用程序线程集中在一个共同的时间轴上，分析systrace的第一步需要在程序运行的时间段中抓取trace<br>log，在抓取到的trace文件中，包含了这段时间中想要的关键信息，交互情况。<br><img src="https://img-blog.csdnimg.cn/2020061911445373.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>图1显示的是当一个app在滑动时出现了卡顿的现象，默认的界面下，横轴是时间，纵向为trace event，trace event<br>先按进程分组，然后再按线程分组.从上到下的信息分别为Kernel，SurfaceFlinger，应用包名。通过配置trace的分类，可以根据配置情况记录每个应用程序的所有线程信息以及trace<br>event的层次结构信息。</p><p><strong>Android studio中使用systrace</strong></p><p>1、在android设备的 设置 – 开发者选项 – 监控 – 开启traces。<br>2、选择要追中的类别，并且点击确定。</p><p>完成以上配置后，开始抓trace文件</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$ python systrace.py--cpu-freq--cpu-load--time=<span class="hljs-number">10</span>-o mytracefile.html<br></code></pre></td></tr></tbody></table></figure><p><strong>分析trace文件</strong><br>抓到trace.html文件后，通过web浏览器打开</p><p>检查Frames<br>每个应用程序都有一排代表渲染帧的圆圈，通常为绿色，如果绘制的时间超过16.6毫秒则显示黄色或红色。通过“W”键查看帧。<br><img src="https://img-blog.csdnimg.cn/20200619114729357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>trace应用程序代码</strong><br>在framework中的trace marker并没有覆盖到所有代码，因此有些时候需要自己去定义trace<br>marker。在Android4.3之后，可以通过Trace类在代码中添加标记，这样将能够看到在指定时间内应用的线程在做哪些工作，当然，trace<br>的begin和end操作也会增加一些额外的开销，但都只有几微秒左右。<br>通过下面的例子来说明Trace类的 用法。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;MyViewHolder&gt; {<br><br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MyViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> {<br>        Trace.beginSection(<span class="hljs-string">"MyAdapter.onCreateViewHolder"</span>);<br>        MyViewHolder myViewHolder;<br>        <span class="hljs-keyword">try</span> {<br>            myViewHolder = MyViewHolder.newInstance(parent);<br>        } <span class="hljs-keyword">finally</span> {<br>            Trace.endSection();<br>        }<br>        <span class="hljs-keyword">return</span> myViewHolder;<br>    }<br><br>   <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">(MyViewHolder holder, <span class="hljs-type">int</span> position)</span> {<br>        Trace.beginSection(<span class="hljs-string">"MyAdapter.onBindViewHolder"</span>);<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">try</span> {<br>                Trace.beginSection(<span class="hljs-string">"MyAdapter.queryDatabase"</span>);<br>                <span class="hljs-type">RowItem</span> <span class="hljs-variable">rowItem</span> <span class="hljs-operator">=</span> queryDatabase(position);<br>                mDataset.add(rowItem);<br>            } <span class="hljs-keyword">finally</span> {<br>                Trace.endSection();<br>            }<br>            holder.bind(mDataset.get(position));<br>        } <span class="hljs-keyword">finally</span> {<br>            Trace.endSection();<br>        }<br>    }<br><br>…<br><br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="使用BlockCanary"><a href="#使用BlockCanary" class="headerlink" title="使用BlockCanary"></a>使用BlockCanary</h3><p>BlockCanary是国内开发者MarkZhai开发的一套性能监控组件，它对主线程操作进行了完全透明的监控，并能输出有效的信息，帮助开发分析、定位到问题所在，迅速优化应用。<br>其特点有：<br><strong>1、非侵入式，简单的两行就打开监控，不需要到处打点，破坏代码优雅性。</strong><br><strong>2、精准，输出的信息可以帮助定位到问题所在（精确到行），不需要像Logcat一样，慢慢去找。</strong><br><strong>3、目前包括了核心监控输出文件，以及UI显示卡顿信息功能</strong></p><p><strong>BlockCanary基本原理</strong></p><p>android应用程序只有一个主线程ActivityThread，这个主线程会创建一个Looper(Looper.prepare)<br>，而Looper又会关联一个MessageQueue，主线程Looper会在应用的生命周期内不断轮询(Looper.loop)，从MessageQueue取出Message 更新UI。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>{<br>        ...<br>        <span class="hljs-keyword">for</span>(;;){<br>        ...<br>        <span class="hljs-comment">// This must be in a local variable, in case a UI event sets the logger</span><br>        Printer logging=me.mLogging;<br>        <span class="hljs-keyword">if</span>(logging!=<span class="hljs-literal">null</span>){<br>        logging.println(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span>+msg.target+<span class="hljs-string">" "</span>+<br>        msg.callback+<span class="hljs-string">": "</span>+msg.what);<br>        }<br>        msg.target.dispatchMessage(msg);<br>        <span class="hljs-keyword">if</span>(logging!=<span class="hljs-literal">null</span>){<br>        logging.println(<span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span>+msg.target+<span class="hljs-string">" "</span>+msg.callback);<br>        }<br>        ...<br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><p>BlockCanary主要是检测<code>msg.target.dispatchMessage(msg);</code>之前的<code>&gt;&gt;&gt;&gt;&gt; Dispatching to</code> 和之后的<code>&lt;&lt;&lt;&lt;&lt; Finished to</code>的间隔时间。<br>应用发生卡顿，一定是在dispatchMessage中执行了耗时操作。通过给主线程的Looper设置一个Printer，打点统计dispatchMessage方法执行的时间，如果超出阀值，表示发生卡顿，则dump出各种信息，提供开发者分析性能瓶颈。</p><h3 id="使用Choreographer"><a href="#使用Choreographer" class="headerlink" title="使用Choreographer"></a>使用Choreographer</h3><p>Android 主线程运行的本质，其实就是 Message 的处理过程，我们的各种操作，包括每一帧的渲染操作 ，都是通过 Message 的形式发给主线程的<br>MessageQueue ，MessageQueue 处理完消息继续等下一个消息。<br><img src="https://img-blog.csdnimg.cn/20200619115744338.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>Choreographer 的引入，主要是配合 Vsync ，给上层 App 的渲染提供一个稳定的 Message 处理的时机，也就是 Vsync 到来的时候 ，系统通过对<br>Vsync 信号周期的调整，来控制每一帧绘制操作的时机. 目前大部分手机都是 60Hz 的刷新率，也就是 16.6ms 刷新一次，系统为了配合屏幕的刷新频率，将<br>Vsync 的周期也设置为 16.6 ms，每个 16.6 ms ， Vsync 信号唤醒 Choreographer 来做 App 的绘制操作 ，这就是引入 Choreographer<br>的主要作用。</p><p><strong>Choreographer 两个主要作用</strong></p><p>1、承上：负责接收和处理 App 的各种更新消息和回调，等到 Vsync 到来的时候统一处理。比如集中处理 Input(主要是 Input 事件的处理)<br>、Animation(动画相关)、Traversal(包括 measure、layout、draw 等操作) ，判断卡顿掉帧情况，记录 CallBack 耗时等。</p><p>2、启下：负责请求和接收 Vsync 信号。接收 Vsync 事件回调(通过 FrameDisplayEventReceiver.onVsync )；请求 Vsync(<br>FrameDisplayEventReceiver.scheduleVsync) .</p><p><strong>使用Choreographer 计算帧率</strong></p><p>Choreographer 处理绘制的逻辑核心在 Choreographer.doFrame 函数中，从下图可以看到，FrameDisplayEventReceiver.onVsync post<br>了自己，其 run 方法直接调用了 doFrame 开始一帧的逻辑处理：<br><img src="https://img-blog.csdnimg.cn/20200619120044126.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>Choreographer周期性的在UI重绘时候触发，在代码中记录上一次和下一次绘制的时间间隔，如果超过16ms，就意味着一次UI线程重绘的“丢帧”。丢帧的数量为间隔时间除以16，如果超过3，就开始有卡顿的感知。<br>使用Choreographer检测帧的代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyFrameCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Choreographer</span>.FrameCallback {<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"性能检测"</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">lastTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFrame</span><span class="hljs-params">(<span class="hljs-type">long</span> frameTimeNanos)</span> {<br>            <span class="hljs-keyword">if</span> (lastTime == <span class="hljs-number">0</span>) {<br>                <span class="hljs-comment">//代码第一次初始化。不做检测统计。</span><br>                lastTime = frameTimeNanos;<br>            } <span class="hljs-keyword">else</span> {<br>                <span class="hljs-type">long</span> <span class="hljs-variable">times</span> <span class="hljs-operator">=</span> (frameTimeNanos - lastTime) / <span class="hljs-number">1000000</span>;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">frames</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (times / <span class="hljs-number">16</span>);<br><br>                <span class="hljs-keyword">if</span> (times &gt; <span class="hljs-number">16</span>) {<br>                    Log.w(TAG, <span class="hljs-string">"UI线程超时(超过16ms):"</span> + times + <span class="hljs-string">"ms"</span> + <span class="hljs-string">" , 丢帧:"</span> + frames);<br>                }<br><br>                lastTime = frameTimeNanos;<br>            }<br><br>            Choreographer.getInstance().postFrameCallback(mFrameCallback);<br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>由上面的分析可知<strong>对象分配</strong>、<strong>垃圾回收</strong>(GC)、<strong>线程调度</strong>以及<strong>Binder调用</strong><br>是Android系统中常见的卡顿原因，因此卡顿优化主要以下几种方法，更多的要结合具体的应用来进行：</p><p><strong>1、布局优化</strong></p><ul><li>通过减少冗余或者嵌套布局来降低视图层次结构。比如使用约束布局代替线性布局和相对布局。</li><li>用 ViewStub 替代在启动过程中不需要显示的 UI 控件。</li><li>使用自定义 View 替代复杂的 View 叠加。</li><li></li></ul><p><strong>2、减少主线程耗时操作</strong></p><ul><li>主线程中不要直接操作数据库，数据库的操作应该放在数据库线程中完成。</li><li>sharepreference尽量使用apply，少使用commit，可以使用MMKV框架来代替sharepreference。</li><li>网络请求回来的数据解析尽量放在子线程中，不要在主线程中进行复制的数据解析操作。</li><li>不要在activity的onResume和onCreate中进行耗时操作，比如大量的计算等。</li></ul><p><strong>3、减少过度绘制</strong><br>过度绘制是同一个像素点上被多次绘制，减少过度绘制一般减少布局背景叠加等方式，如下图所示右边是过度绘制的图片。<br><img src="https://img-blog.csdnimg.cn/20200619153239362.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMDk4NzA=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>4、列表优化</strong></p><ul><li>RecyclerView使用优化，使用DiffUtil和notifyItemDataSetChanged进行局部更新等。</li></ul><p><strong>5、对象分配和回收优化</strong></p><p>自从Android引入 ART 并且在Android 5.0上成为默认的运行时之后，对象分配和垃圾回收（GC）造成的卡顿已经显著降低了，但是由于对象分配和GC有额外的开销，它依然又可能使线程负载过重。<br>在一个调用不频繁的地方（比如按钮点击）分配对象是没有问题的，但如果在在一个被频繁调用的紧密的循环里，就需要避免对象分配来降低GC的压力。</p><ul><li>减少小对象的频繁分配和回收操作。</li></ul><h1 id="存储优化"><a href="#存储优化" class="headerlink" title="存储优化"></a>存储优化</h1><h2 id="交换数据格式"><a href="#交换数据格式" class="headerlink" title="交换数据格式"></a>交换数据格式</h2><p>Google 推出的 <a href="https://developers.google.com/protocol-buffers/">Protocal Buffers</a> 是一种更轻便高效的存储结构，但消耗内存较大。</p><p><a href="https://github.com/google/flatbuffers">FlatBuffers</a> 同样由 Google 推出，专注性能，适合移动端。占用存储比 Protocal 要大。</p><h2 id="SharePreferences-优化"><a href="#SharePreferences-优化" class="headerlink" title="SharePreferences 优化"></a>SharePreferences 优化</h2><ul><li>当 SharedPreferences 文件还没有被加载到内存时，调用 getSharedPreferences 方法会初始化文件并读入内存，这容易导致 耗时更长。</li><li>Editor 的 commit 或者 apply 方法的区别在于同步写入和异步 写入，以及是否需要返回值。在不需要返回值的情况下，<strong>使用 apply<br>方法可以极大提高性能</strong>。</li><li>SharedPreferences 类 中的 commitToMemory() 会锁定 SharedPreference 对象，put() 和 getEditor() 方法会锁定 Editor<br>对象，在写入磁盘时更会锁定一个写入锁。因此，最好的优化方法就是避免频繁地读写 SharedPreferences，减少无谓的调用。对于<br>SharedPreferences 的批量操作，最好先获取一个 editor 进行批量操作，然后调用 apply 方法。</li></ul><h2 id="Bitmap-解码"><a href="#Bitmap-解码" class="headerlink" title="Bitmap 解码"></a>Bitmap 解码</h2><ul><li>4.4 以上 decodeFile 内部没有使用缓存，效率不高。要使用 decodeStream，同时传入的文件流为 BufferedInputStream。</li><li>decodeResource 同样存在性能问题，用 decodeResourceStream。</li></ul><h2 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h2><ol><li><p>使用 StringBuilder 代替 String</p></li><li><p>查询时返回更少的结果集及更少的字段</p><p>查询时只取需要的字段和结果集，更多的结果集会消耗更多的时间及内存，更多的字段会导致更多的内存消耗。</p></li><li><p>少用 cursor.getColumnIndex</p><p>根据性能调优过程中的观察 cursor.getColumnIndex 的时间消耗跟 cursor.getInt 相差无几。可以在建表的时候用 static 变量记住某列的<br>index，直接调用相应 index 而不是每次查询。</p></li><li><p>异步线程</p><p>Android 中数据不多时表查询可能耗时不多，不会导致 ANR，不过大于 100ms 时同样会让用户感觉到延时和卡顿，可以放在线程中运行，但<br>sqlite 在并发方面存在局限，多线程控制较麻烦，这时候可使用单线程池，在任务中执行 db 操作，通过 handler 返回结果和 UI<br>线程交互，既不会影响 UI 线程，同时也能防止并发带来的异常。</p></li><li><p>SQLiteOpenHelper <strong>维持一个单例</strong></p><p>因为 SQLite 对多线程的支持并不是很完善，如果两个线程同时操作数据库，因为数据库被另一个线程占用， 这种情况下会报“Database<br>is locked” 的异常。所以在数据库管理类中使用单例模式，就可以保证无论在哪个线程中获取数据库对象，都是同一个。</p><p>最好的方法是所有的数据库<strong>操作统一到同一个线程队列管理</strong>，而业务层使用缓存同步，这样可以完全避免多线程操作数据库导致的不同步和死锁问题。</p></li><li><p>Application 中初始化</p></li></ol><ul><li>使用 Application 的 Context 创建数据库，在 Application 生命周期结束时再关闭。</li><li>在应用启动过程中最先初始化完数据库，避免进入应用后再初始化导致相关操作时间变长。</li></ul><ol start="7"><li><p>少用 AUTOINCREMENT</p><p>主键加上 AUTOINCREMENT 后，可以保证主键严格递增，但并不能保证每次都加 1，因为在插入失败后，失败的行号不会被复用，会造成主键有间隔，继而使<br>INSERT 耗时 1 倍以上。</p><p>这个 AUTOINCREMENT 关键词会增加 CPU，内存，磁盘空间和磁盘 I/O 的负担，所以 尽量不要用，除非必需。通常情况下都不是必需的。</p></li></ol><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>使用事务的两大好处是原子提交和更优性能：</p><ul><li>原子提交：意味着同一事务内的所有修改要么都完成要么都不做，如果某个修改失败，会自动回滚使得所有修改不生效。</li><li>更优性能：Sqlite 默认会为每个插入、更新操作创建一个事务，并且在每次插入、更新后立即提交。这样如果连续插入 100<br>次数据实际是创建事务、执行语句、提交这个过程被重复执行了 100 次。如果显式的创建事务，这个过程只做一次，通过这种一次性事务可以使得性能大幅提升。尤其当数据库位于<br>sd 卡时，时间上能节省两个数量级左右。</li></ul><p>主要三个方法：beginTransaction，setTransactionSuccessful，endTransaction。</p><h3 id="SQLiteStatement"><a href="#SQLiteStatement" class="headerlink" title="SQLiteStatement"></a>SQLiteStatement</h3><p>使用 Android 系统提供的 SQLiteStatement 来插入数据，在性能上有一定的提高，并且也解决了 SQL 注入的问题。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">SQLiteStatement statement=dbOpenHelper.getWritableDatabase().compileStatement(<span class="hljs-string">"INSERT INTO EMPERORS(name, dynasty, start_year) values(?,?,?)"</span>);<br>        statement.clearBindings();<br>        statement.bindString(<span class="hljs-number">1</span>,<span class="hljs-string">"Max"</span>);<br>        statement.bindString(<span class="hljs-number">2</span>,<span class="hljs-string">"Luk"</span>);<br>        statement.bindString(<span class="hljs-number">3</span>,<span class="hljs-string">"1998"</span>);<br>        statement.executeInsert();<br></code></pre></td></tr></tbody></table></figure><p>SQLiteStatement 只能插入一个表中的数据，在插入前要清除上一次的数据。</p><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>索引就像书本的目录，目录可以快速找到所在页数，数据库中索引可以帮助快速找到数据，而不用全表扫描，合适的索引可以大大提高数据库查询的效率。</p><p>优点：大大加快了数据库检索的速度，包括对单表查询、连表查询、分组查询、排序查询。经常是一到两个数量级的性能提升，且随着数据数量级增长。</p><p>缺点：</p><ul><li>索引的创建和维护存在消耗，索引会占用物理空间，且随着数据量的增加而增加。</li><li>在对数据库进行增删改时需要维护索引，所以会对增删改的性能存在影响。</li></ul><p><strong>分类</strong></p><ol><li>直接创建索引和间接创建索引</li></ol><ul><li>直接创建: 使用 sql 语句创建，Android 中可以在 SQLiteOpenHelper 的 onCreate 或是 onUpgrade 中直接 excuSql<br>创建语句，如 <code>CREATE INDEX mycolumn_index ON mytable (myclumn)</code></li><li>间接创建: 定义主键约束或者唯一性键约束，可以间接创建索引，主键默认为唯一索引。</li></ul><ol start="2"><li>普通索引和唯一性索引</li></ol><ul><li>普通索引：<code>CREATEINDEXmycolumn_indexONmytable(myclumn)</code></li><li>唯一性索引：保证在索引列中的全部数据是唯一的，对聚簇索引和非聚簇索引都可以使用，语句为 <code>CREATE UNIQUE COUSTERED INDEX myclumn_cindex ON mytable(mycolumn)</code></li></ul><ol start="3"><li>单个索引和复合索引</li></ol><ul><li>单个索引：索引建立语句中仅包含单个字段，如上面的普通索引和唯一性索引创建示例。</li><li>复合索引：又叫组合索引，在索引建立语句中同时包含多个字段，如 <code>CREATEINDEXname_indexONusername(firstname,lastname)</code>，其中<br>firstname 为前导列。</li></ul><ol start="4"><li><h2 id="聚簇索引和非聚簇索引-聚集索引，群集索引"><a href="#聚簇索引和非聚簇索引-聚集索引，群集索引" class="headerlink" title="聚簇索引和非聚簇索引 (聚集索引，群集索引)"></a>聚簇索引和非聚簇索引 (聚集索引，群集索引)</h2>聚簇索引：物理索引，与基表的物理顺序相同，数据值的顺序总是按照顺序排列，如 <code>CREATE CLUSTERED INDEX mycolumn_cindex ON mytable(mycolumn) WITH ALLOW_DUP_ROW</code><br>，其中 <code>WITH ALLOW_DUP_ROW</code> 表示允许有重复记录的聚簇索引</li></ol><ul><li>非聚簇索引：<code>CREATEUNCLUSTEREDINDEXmycolumn_cindexONmytable(mycolumn)</code>，索引默认为非聚簇索引</li></ul><p><strong>使用场景</strong></p><ol><li>当某字段数据更新频率较低，查询频率较高，经常有范围查询 <code>(&gt;, &lt;, =,&gt;=, &lt;=)</code> 或 <code>order by</code>、<code>group by</code><br>发生时建议使用索引。并且选择度（一个字段中唯一值的数量 / 总的数量）越大，建索引越有优势</li><li>经常同时存取多列，且每列都含有重复值可考虑建立复合索引</li></ol><p><strong>使用规则</strong></p><ol><li>对于复合索引，把使用最频繁的列做为前导列 (索引中第一个字段)<br>。如果查询时前导列不在查询条件中则该复合索引不会被使用。如 <code>create unique index PK_GRADE_CLASS on student (grade, class)</code>，<code>select * from student where class = 2</code><br>未使用到索引，<code>select * from dept where grade = 3</code> 使用到了索引</li><li>避免对索引列进行计算，对 where<br>子句列的任何计算如果不能被编译优化，都会导致查询时索引失效 <code>select * from student where tochar(grade)=’2</code></li><li>比较值避免使用 NULL</li><li></li></ol><p>多表查询时要注意是选择合适的表做为内表。连接条件要充份考虑带有索引的表、行数多的表，内外表的选择可由公式：外层表中的匹配行数 <code>*</code><br>内层表中每一次查找的次数确定，乘积最小为最佳方案。实际多表操作在被实际执行前，查询优化器会根据连接条件，列出几组可能的连接方案并从中找出系统开销最小的最佳方案<br>5. 查询列与索引列次序一致<br>6. 用多表连接代替 EXISTS 子句<br>7. 把过滤记录数最多的条件放在最前面<br>8. 善于使用存储过程，它使 sql 变得更加灵活和高效 (Sqlite 不支持存储过程)</p><h2 id="其它通用优化"><a href="#其它通用优化" class="headerlink" title="其它通用优化"></a>其它通用优化</h2><ul><li>经常用的数据读取后缓存起来，以免多次重复读写造成“写入放大”</li><li>子线程读写数据</li><li>ObjectOutputStream 在序列化磁盘时，会把内存中的每个对象保存到磁盘，在保存对象的 时候，每个数据成员会带来一次 I/O 操作。在<br>ObjectOutputStream 上面再封装一个输出流 ByteArrayOutputStream 或<br>BufferedOutputStream，先将对象序列化后的信息写到缓存区中，然后再一次性地写到磁盘上；相应的，用 ByteArrayInputStream 或<br>BufferedInputStream 替代 ObjectInputStream。</li><li>合理选择缓冲区 Buffer 的大小。太小导致 I/O 操作次数增多，太大导致申请时间变长。比如 4-8 KB。</li></ul><h1 id="网络优化"><a href="#网络优化" class="headerlink" title="网络优化"></a>网络优化</h1><p>互联网时代, App作为于用户交互的端, 可以说实际上是一个界面, 产品的业务, 服务都是由Server提供的. 而App与Server的交互依赖于网络,<br>故而网络优化, 也是我们的App优化中不可缺少的一个优化项。除了客户端, 接口的优化外, 很多一部分优化还依赖于服务器端,<br>包括服务器端的代码开发, 部署方式等。</p><h2 id="网络连接对用户的影响"><a href="#网络连接对用户的影响" class="headerlink" title="网络连接对用户的影响"></a>网络连接对用户的影响</h2><p>App的网络连接对于用户来说, 影响很多, 且多数情况下都很直观, 直接影响用户对这个App的使用体验. 其中较为重要的几点:</p><ul><li><strong>流量</strong><br>App的流量消耗对用户来说是比较敏感的, 毕竟流量是花钱的嘛. 现在大部分人的手机上都有安装流量监控的工具App, 用来监控App的流量使用.<br>如果我们的App这方面没有控制好, 会给用户不好的使用体验.</li><li><strong>电量</strong><br>电量相对于用户来说, 没有那么明显. 一般用户可能不会太注意. 但是如电量优化中的那样, 网络连接(radio)是对电量影响很大的一个因素.<br>所以我们也要加以注意.</li><li><strong>用户等待</strong><br>也就是用户体验, 良好的用户体验, 才是我们留住用户的第一步. 如果App请求等待时间长, 会给用户网络卡, 应用反应慢的感觉,<br>如果有对比, 有替代品, 我们的App很可能就会被用户无情抛弃.</li></ul><h2 id="分析网络连接的工具"><a href="#分析网络连接的工具" class="headerlink" title="分析网络连接的工具"></a>分析网络连接的工具</h2><h3 id="Network-Monitor"><a href="#Network-Monitor" class="headerlink" title="Network Monitor"></a>Network Monitor</h3><p>Android Studio内置的Monitor工具中就有一个Network Monitor:</p><p><img src="https://img-blog.csdn.net/20180910062232358?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2F1Z2Z1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p>其中:</p><ul><li>Rx — R(ecive) 表示下行流量, 即下载接收.</li><li>Tx — T(ransmit) 表示上行流量, 即上传发送.</li></ul><p><strong>怎么使用Network Monitor?</strong></p><p>Network monitor实时跟踪选定应用的数据请求情况. 我们可以连上手机, 选定调试应用进程, 然后在App上操作我们需要分析的页面请求.</p><p>例如, 上图就是以<a href="https://github.com/mingjunli/GithubApp">CoderPub</a>为例, 针对从repo列表界面进入repo详情界面的监控数据.</p><p>可以看到从10s到30s之间, 20s时间内发生了多次数据请求, 且22s到27s之间的请求数据量还很大.</p><p>分析代码可以看到, 在请求repo详情的时候是打包了很多请求的:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Observable&lt;RepoDetail&gt; <span class="hljs-title function_">getRepoDetail</span><span class="hljs-params">(String owner,String name)</span>{<br>        <span class="hljs-keyword">return</span> Observable.zip(mRepoService.get(owner,name),<br>        mRepoService.contributors(owner,name),<br>        mRepoService.listForks(owner,name,<span class="hljs-string">"newest"</span>),<br>        mRepoService.readme(owner,name),<br>        isStarred(owner,name),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Func5</span>&lt;Repo, ArrayList&lt;User&gt;,ArrayList&lt;Repo&gt;,Content,Boolean,RepoDetail&gt;(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> RepoDetail <span class="hljs-title function_">call</span><span class="hljs-params">(Repo repo,ArrayList&lt;User&gt; users,ArrayList&lt;Repo&gt; forks,Content readme,Boolean isStarred)</span>{<br>        RepoDetail detail=<span class="hljs-keyword">new</span> <span class="hljs-title class_">RepoDetail</span>();<br><br>        repo.setStarred(isStarred);<br>        detail.setBaseRepo(repo);<br>        detail.setForks(forks);<br><br>        <span class="hljs-comment">// because the readme content is encode with Base64 by github.</span><br>        readme.content=StringUtil.base64Decode(readme.content);<br>        detail.setReadme(readme);<br><br>        detail.setContributors(users);<br>        <span class="hljs-keyword">return</span> detail;<br>        }<br>        });<br>        }<br></code></pre></td></tr></tbody></table></figure><p>这也验证了14s到20s间的四次数据请求, 另外由于repo详情界面会显示作者以及贡献者的图片, 而图片的数据量相对大,<br>故而23s到27s间有多次数据量很大的请求发生.</p><h3 id="网络代理工具"><a href="#网络代理工具" class="headerlink" title="网络代理工具"></a>网络代理工具</h3><p>一般来说, 网络代理工具有两个作用:</p><ol><li>截获网络请求响应包, 分析网络请求</li><li>设置代理网络, 移动App开发中一般用来做不同网络环境的测试, 例如Wifi/4G/3G/弱网等.</li></ol><p>代理工具很多,<br>诸如<a href="https://www.wireshark.org/">Wireshark</a>, <a href="https://www.telerik.com/fiddler">Fiddler</a>, <a href="https://www.charlesproxy.com/">Charles</a><br>等, 在此不一一细说了, 使用方法自行问谷歌度娘. :)</p><h2 id="从哪些方面优化网络连接"><a href="#从哪些方面优化网络连接" class="headerlink" title="从哪些方面优化网络连接"></a>从哪些方面优化网络连接</h2><p>简单来说, 两个方面:</p><ul><li><strong>减少Radio活跃时间</strong><ul><li>也就是减少网络数据获取的频次.</li><li>这就减少了radio的电量消耗, 控制电量使用.</li></ul></li><li><strong>减少获取数据包的大小</strong><ul><li>可以减少流量消耗</li><li>也可以让每次请求更快, 在网络情况不好的情况下也有良好表现, 提升用户体验.</li></ul></li></ul><h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><p><strong>API设计</strong></p><p>App与Server之间的API设计要考虑网络请求的频次, 资源的状态等. 以便App可以以较少的请求来完成业务需求和界面的展示.</p><p>例如, 注册登录. 正常会有两个API, 注册和登录, 但是设计API时我们应该给注册接口包含一个隐式的登录.<br>来避免App在注册后还得请求一次登录接口(有可能失败, 从而导致业务流程失败).</p><p>例如, 之前提到的获取repo详情, 实际上请求了4个接口, 请求了repo的信息, forks列表, contributors列表, readme,<br>这是因为github提供的接口是尽量单一职责的. 然而在我们的实际开发中, 我们的Server除了提供这些单一职责的小接口外,<br>最好还能组合一个满足客户端业务需求的repo详情接口出来.</p><p><strong>Gzip压缩</strong></p><p>使用Gzip来压缩request和response, 减少传输数据量, 从而减少流量消耗.</p><p><strong>考虑使用Protocol Buffer代替JSON</strong></p><p>以前我们传输数据使用XML, 后来使用JSON代替了XML, 很大程度上也是为了可读性和减少数据量(当然还有映射成POJO的方便程度).</p><p><a href="https://github.com/google/protobuf/">Protocol Buffer</a>是Google推出的一种数据交换格式.</p><p>如果我们的接口每次传输的数据量很大的话, 可以考虑下protobuf, 会比JSON数据量小很多.</p><p>当然相比来说, JSON也有其优势, 可读性更高.</p><blockquote><p>本节以网络流量优化的角度推荐protobuf作为一个选择, 具体还需更具实际情况考虑.</p></blockquote><p><strong>图片的Size</strong></p><p>上面Network Monitor中看到的22s到27s之间的有多次请求, 且数据量还很大. 就是在获取图片资源.</p><p>图片相对于接口请求来说, 数据量要大得多. 故而也是我们需要优化的一个点.</p><p>我们可以在获取图片时告知服务器需要的图片的宽高, 以便服务器给出合适的图片, 避免浪费.</p><p>我们现在很多公司的图片资源都是使用第三方的云存储服务的(七牛, 阿里云存储之类的).</p><p>以七牛为例, 可以在请求图片的url中添加诸如质量, 格式, width, height等path来获取合适的图片资源:</p><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arcade">imageView2/&lt;mode&gt;<span class="hljs-regexp">/w/</span>&lt;LongEdge&gt;<br>                 <span class="hljs-regexp">/h/</span>&lt;ShortEdge&gt;<br>                 <span class="hljs-regexp">/format/</span>&lt;Format&gt;<br>                 <span class="hljs-regexp">/interlace/</span>&lt;Interlace&gt;<br>                 <span class="hljs-regexp">/q/</span>&lt;Quality&gt;<br>                 <span class="hljs-regexp">/ignore-error/</span>&lt;ignoreError&gt;<br></code></pre></td></tr></tbody></table></figure><h3 id="网络缓存"><a href="#网络缓存" class="headerlink" title="网络缓存"></a>网络缓存</h3><p>适当的缓存, 既可以让我们的应用看起来更快, 也能避免一些不必要的流量消耗.</p><p><strong>打包网络请求</strong></p><p>当接口设计不能满足我们的业务需求时. 例如可能一个界面需要请求多个接口, 或是网络良好, 处于Wifi状态下时我们想获取更多的数据等.</p><p>这时就可以打包一些网络请求, 例如请求列表的同时, 获取Header点击率较高的的item项的详情数据.</p><blockquote><p>可以通过一些统计数据来帮助我们定位用户接下来的操作是高概率的, 提前获取这部分的数据.</p></blockquote><p><strong>监听相关状态</strong></p><p>通过监听设备的状态:</p><ul><li>休眠状态</li><li>充电状态</li><li>网络状态</li></ul><p>结合<a href="https://developer.android.com/reference/android/app/job/JobScheduler.html">JobScheduler</a>来根据实际情况做网络请求.<br>比方说Splash闪屏广告图片, 我们可以在连接到Wifi时下载缓存到本地; 新闻类的App可以在充电, Wifi状态下做离线缓存.</p><h3 id="弱网测试-优化"><a href="#弱网测试-优化" class="headerlink" title="弱网测试&amp;优化"></a>弱网测试&amp;优化</h3><p>除了正常的网络优化, 我们还需考虑到弱网情况下, App的表现.</p><p><strong>弱网测试</strong></p><p>有几种方式来模拟弱网进行测试.</p><p>Android Emulator</p><p>创建和启动Android模拟器可以设置网络速度和延迟:</p><p><strong>创建时</strong>:</p><p><img src="https://img-blog.csdn.net/20180910062617283?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2F1Z2Z1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p><strong>启动时</strong>, 使用emulator命令:</p><figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-keyword">$emulator</span> -netdelay gprs -netspeed gsm -avd Nexus_5_API_22</span><br></code></pre></td></tr></tbody></table></figure><p>具体参数参考<a href="https://developer.android.com/studio/run/emulator-commandline.html#netdelay">这里</a><br>和<a href="https://developer.android.com/studio/run/emulator-commandline.html#netspeed">这里</a>, 需要翻墙.</p><p>使用网络代理工具</p><p>以<a href="https://www.charlesproxy.com/">Charles</a>为例:<br>保持手机和PC处于同一个局域网, 在手机端wifi设置高级设置中设置代理方式为手动, 代理ip填写PC端ip地址, 端口号默认8888.</p><p><img src="https://img-blog.csdn.net/2018091006274452?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2F1Z2Z1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p><img src="https://img-blog.csdn.net/20180910062757452?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2F1Z2Z1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p><strong>其他模拟弱网方式</strong></p><p>如果你恰好也是iOS的开发者, Apple提供了<a href="http://nshipster.cn/network-link-conditioner/">Network Link Conditioner</a>, 非常好用.</p><p>可以模拟的网络情况与上述类似:</p><p>​                            <img src="https://img-blog.csdn.net/20180910062859260?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2F1Z2Z1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p><p>如果你使用Linux环境开发, 还可以试下facebook出的<a href="http://facebook.github.io/augmented-traffic-control/">ATC</a>.</p><p><strong>弱网优化</strong></p><p>利用上述工具模拟弱网, 在弱网情况下体验我们的App. 一般来说, 网络延迟在60ms内, 是OK的, 超过200ms就比较糟糕了.<br>我们需要做的是在比较糟糕的网络环境下还能给用户较好的体验.</p><p>弱网优化, 本质上是在弱网的情况下能让用户流畅的使用我们的App. 我们要做的就是结合上述的优化项:</p><ul><li>压缩/减少数据传输量</li><li>利用缓存减少网络传输</li><li>针对弱网(移动网络), 不自动加载图片</li><li>界面先反馈, 请求延迟提交<br>例如, 用户点赞操作, 可以直接给出界面的点赞成功的反馈, 使用<a href="https://developer.android.com/reference/android/app/job/JobScheduler.html">**JobScheduler<br>**</a>在网络情况较好的时候打包请求.</li></ul><h1 id="耗电优化"><a href="#耗电优化" class="headerlink" title="耗电优化"></a>耗电优化</h1><p>实践中，如果我们的应用需要播放视频、需要获取 GPS 信息、需要拍照，这些耗电看起来是无法避免的。</p><p>如何判断哪些耗电是可以避免，或者是需要去优化的呢？可以看下面这张图，当用户去看耗电排行榜的时候，发现“王者荣耀”使用了 7<br>个多小时，这时用户对“王者荣耀”的耗电是有预期的。</p><p><img src="https://static001.geekbang.org/resource/image/5f/90/5f98c8a117745ce2fd7ef8f873894090.png" alt="image"></p><p>假设这个时候发现某个应用他根本没怎么使用（前台时间很少），但是耗电却非常多。这种情况会跟用户的预期差别很大，他可能就会想去投诉。</p><p><strong>所以耗电优化的第一个方向是优化应用的后台耗电。</strong></p><p>知道了系统是如何计算耗电的，那反过来看，我们也就可以知道应用在后台不应该做什么，例如长时间获取 WakeLock、WiFi<br>和蓝牙的扫描等。为什么说耗电优化第一个方向就是优化应用后台耗电，因为大部分厂商预装项目要求最严格的正是应用后台待机耗电。</p><p><img src="https://static001.geekbang.org/resource/image/b0/2b/b01e359b45d22bd80efda51eee2f5f2b.png" alt="image"></p><p>当然前台耗电我们不会完全不管，但是标准会放松很多。再来看看下面这张图，如果系统对你的应用弹出这个对话框，可能对于微信来说，用户还可以忍受，但是对其他大多数的应用来说，可能很多用户就直接把你加入到后台限制的名单中了</p><p><img src="https://static001.geekbang.org/resource/image/c6/1b/c6d2c20c09e84190c7b4a64578d0cc1b.png" alt="image"></p><p><strong>耗电优化的第二个方向是符合系统的规则，让系统认为你耗电是正常的。</strong></p><p>而 Android P 是通过 Android Vitals 监控后台耗电，所以我们需要符合 Android Vitals 的规则，目前它的具体规则如下：</p><p><img src="https://static001.geekbang.org/resource/image/62/15/620748a58e45e50fdea1098f15c77d15.png" alt="image"></p><p>虽然上面的标准可能随时会改变，但是可以看到，Android 系统目前比较关心后台 Alarm 唤醒、后台网络、后台 WiFi 扫描以及部分长时间<br>WakeLock 阻止系统后台休眠。</p><h2 id="耗电监控"><a href="#耗电监控" class="headerlink" title="耗电监控"></a>耗电监控</h2><p>对于耗电监控也是如此，我们首先需要抽象出具体的规则，然后收集尽量多的辅助信息，帮助问题的排查。</p><h3 id="Android-Vitals"><a href="#Android-Vitals" class="headerlink" title="Android Vitals"></a>Android Vitals</h3><p>Android Vitals 的几个关于电量的监控方案与规则：</p><ul><li><a href="https://developer.android.com/topic/performance/vitals/wakeup">Alarm Manager wakeup 唤醒过多</a></li><li><a href="https://developer.android.google.cn/topic/performance/vitals/wakelock">频繁使用局部唤醒锁</a></li><li><a href="https://developer.android.com/topic/performance/vitals/bg-network-usage">后台网络使用量过高</a></li><li><a href="https://developer.android.com/topic/performance/vitals/bg-wifi">后台 WiFi scans 过多</a></li></ul><p>在使用了一段时间之后，我发现它并不是那么好用。以 Alarm wakeup 为例，Vitals 以每小时超过 10<br>次作为规则。由于这个规则无法做修改，很多时候我们可能希望针对不同的系统版本做更加细致的区分。</p><p>其次跟 Battery Historian 一样，我们只能拿到 wakeup 的标记的组件，拿不到申请的堆栈，也拿不到当时手机是否在充电、剩余电量等信息。<br><img src="https://static001.geekbang.org/resource/image/33/1d/33aa19f951d577b759527c717c7d6e1d.png" alt="image"></p><p>对于网络、WiFi scans 以及 WakeLock 也是如此。虽然 Vitals 帮助我们缩小了排查的范围，但是依然需要在茫茫的代码中寻找对应的可疑代码。</p><h2 id="耗电监控都监控什么"><a href="#耗电监控都监控什么" class="headerlink" title="耗电监控都监控什么"></a>耗电监控都监控什么</h2><p>Android Vitals并不是那么好用，而且对于国内的应用来说其实也根本无法使用。不管怎样，我们还是需要搭建自己的耗电监控系统。</p><p>那我们的耗电监控系统应该监控哪些内容，怎么样才能比 Android Vitals 做得更好呢？</p><ul><li><strong>监控信息</strong>。简单来说系统关心什么，我们就监控什么，而且应该以后台耗电监控为主。类似 Alarm wakeup、WakeLock、WiFi<br>scans、Network 都是必须的，其他的可以根据应用的实际情况。如果是地图应用，后台获取 GPS 是被允许的；如果是计步器应用，后台获取<br>Sensor 也没有太大问题。</li><li><strong>现场信息</strong>。监控系统希望可以获得完整的堆栈信息，比如哪一行代码发起了 WiFi scans、哪一行代码申请了 WakeLock<br>等。还有当时手机是否在充电、手机的电量水平、应用前台和后台时间、CPU 状态等一些信息也可以帮助我们排查某些问题。</li><li><strong>提炼规则</strong>。最后我们需要将监控的内容抽象成规则，当然不同应用监控的事项或者参数都不太一样。<br>由于每个应用的具体情况都不太一样，下面是一些可以用来参考的简单规则。</li></ul><p><img src="https://static001.geekbang.org/resource/image/d4/be/d48b7e4d3fdceb101fa7716b5892b0be.png" alt="image"></p><p>在安卓绿色联盟的会议中，华为公开过他们后台资源使用的“红线”，你也可以参考里面的一些规则：<br><img src="https://static001.geekbang.org/resource/image/86/ff/86a65ea0d9216a11a341d7224fce93ff.png" alt="image"></p><h2 id="如何监控耗电"><a href="#如何监控耗电" class="headerlink" title="如何监控耗电"></a>如何监控耗电</h2><p>明确了我们需要监控什么以及具体的规则之后，就可以来到实现这个环节了。跟 I/O 监控、网络监控一样，我首先想到的还是 Hook 方案。</p><h3 id="Java-Hook"><a href="#Java-Hook" class="headerlink" title="Java Hook"></a>Java Hook</h3><p>Hook 方案的好处在于使用者接入非常简单，不需要去修改自己的代码。下面我以几个比较常用的规则为例，看看如果使用 Java Hook<br>达到监控的目的。</p><ul><li><a href="https://developer.android.com/training/scheduling/wakelock">WakeLock</a>。WakeLock 用来阻止 CPU、屏幕甚至是键盘的休眠。类似<br>Alarm、JobService 也会申请 WakeLock 来完成后台 CPU 操作。WakeLock<br>的核心控制代码都在<a href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java">PowerManagerService</a><br>中，实现的方法非常简单。</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 代理 PowerManagerService</span><br>ProxyHook().proxyHook(context.getSystemService(Context.POWER_SERVICE),<span class="hljs-string">"mService"</span>,<span class="hljs-built_in">this</span>)；<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeInvoke</span><span class="hljs-params">(Method method,Object[]args)</span>{<br>        <span class="hljs-comment">// 申请 Wakelock</span><br>        <span class="hljs-keyword">if</span>(method.getName().equals(<span class="hljs-string">"acquireWakeLock"</span>)){<br>        <span class="hljs-keyword">if</span>(isAppBackground()){<br>        <span class="hljs-comment">// 应用后台逻辑，获取应用堆栈等等     </span><br>        }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">// 应用前台逻辑，获取应用堆栈等等</span><br>        }<br>        <span class="hljs-comment">// 释放 Wakelock</span><br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(method.getName().equals(<span class="hljs-string">"releaseWakeLock"</span>)){<br>        <span class="hljs-comment">// 释放的逻辑    </span><br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><ul><li><a href="https://developer.android.com/training/scheduling/alarms">Alarm</a>。Alarm<br>用来做一些定时的重复任务，它一共有四个类型，其中<a href="https://developer.android.com/reference/android/app/AlarmManager.html#ELAPSED_REALTIME_WAKEUP">ELAPSED_REALTIME_WAKEUP</a><br>和<a href="https://developer.android.com/reference/android/app/AlarmManager.html#RTC_WAKEUP">RTC_WAKEUP</a>类型都会唤醒设备。同样，Alarm<br>的核心控制逻辑都在<a href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java">AlarmManagerService</a><br>中，实现如下：</li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 代理 AlarmManagerService</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyHook</span>().proxyHook(context.getSystemService<br>        (Context.ALARM_SERVICE),<span class="hljs-string">"mService"</span>,<span class="hljs-built_in">this</span>)；<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeInvoke</span><span class="hljs-params">(Method method,Object[]args)</span>{<br>        <span class="hljs-comment">// 设置 Alarm</span><br>        <span class="hljs-keyword">if</span>(method.getName().equals(<span class="hljs-string">"set"</span>)){<br>        <span class="hljs-comment">// 不同版本参数类型的适配，获取应用堆栈等等</span><br>        <span class="hljs-comment">// 清除 Alarm</span><br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(method.getName().equals(<span class="hljs-string">"remove"</span>)){<br>        <span class="hljs-comment">// 清除的逻辑</span><br>        }<br>        }<br></code></pre></td></tr></tbody></table></figure><ul><li>其他。对于后台 CPU，我们可以使用卡顿监控相关的方法。对于后台网络，同样我们可以通过网络监控相关的方法。对于 GPS 监控，我们可以通过<br>Hook<br>代理<a href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/services/core/java/com/android/server/LocationManagerService.java">LOCATION_SERVICE</a><br>。对于 Sensor，我们通过<br>Hook <a href="http://androidxref.com/7.0.0_r1/xref/frameworks/base/core/java/android/hardware/SystemSensorManager.java">SENSOR_SERVICE</a><br>中的“mSensorListeners”，可以拿到部分信息。</li><li><strong>通过 Hook，我们可以在申请资源的时候将堆栈信息保存起来。当我们触发某个规则上报问题的时候，可以将收集到的堆栈信息、电池是否充电、CPU<br>信息、应用前后台时间等辅助信息也一起带上。</strong></li></ul><h3 id="插桩"><a href="#插桩" class="headerlink" title="插桩"></a>插桩</h3><p>虽然使用 Hook 非常简单，但是某些规则可能不太容易找到合适的 Hook 点。而且在 Android P 之后，很多的 Hook 点都不支持了。</p><p>出于兼容性考虑，我首先想到的是写一个基础类，然后在统一的调用接口中增加监控逻辑。以 WakeLock 为例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WakelockMetrics</span> {<br>    <span class="hljs-comment">// Wakelock 申请</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(PowerManager.WakeLock wakelock)</span> {<br>        wakeLock.acquire();<br>        <span class="hljs-comment">// 在这里增加 Wakelock 申请监控逻辑</span><br>    }<br>    <span class="hljs-comment">// Wakelock 释放</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(PowerManager.WakeLock wakelock, <span class="hljs-type">int</span> flags)</span> {<br>        wakelock.release();<br>        <span class="hljs-comment">// 在这里增加 Wakelock 释放监控逻辑</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>Facebook 也有一个耗电监控的开源库Battery-Metrics，它监控的数据非常全，包括 Alarm、WakeLock、Camera、CPU、Network<br>等，而且也有收集电量充电状态、电量水平等信息。</p><p>Battery-Metrics 只是提供了一系列的基础类，在实际使用中，接入者可能需要修改大量的源码。但对于一些第三方 SDK<br>或者后续增加的代码，我们可能就不太能保证可以监控到了。这些场景也就无法监控了，所以 Facebook 内部是使用插桩来动态替换。</p><p>遗憾的是，Facebook<br>并没有开源它们内部的插桩具体实现方案。不过这实现起来其实并不困难，事实上在 <a href="https://github.com/AndroidAdvanceWithGeektime/Chapter19">Sample</a><br>中，已经使用过 ASM、Aspectj 这两种插桩方案了。</p><p>插桩方案使用起来兼容性非常好，并且使用者也没有太大的接入成本。但是它并不是完美无缺的，对于系统的代码插桩方案是无法替换的，例如<br>JobService 申请 PARTIAL_WAKE_LOCK 的场景。</p><h1 id="多线程并发优化"><a href="#多线程并发优化" class="headerlink" title="多线程并发优化"></a>多线程并发优化</h1><p>在程序开发的实践当中，为了让程序表现得更加流畅，我们肯定会需要使用到多线程来提升程序的并发执行性能。但是编写多线程并发的代码一直以来都是一个相对棘手的问题，所以想要获得更佳的程序性能，非常有必要掌握多线程并发编程的基础技能。</p><h2 id="Thread-使用"><a href="#Thread-使用" class="headerlink" title="Thread 使用"></a>Thread 使用</h2><p>Thread使用需要注意的点：</p><h3 id="Thread-中断"><a href="#Thread-中断" class="headerlink" title="Thread 中断"></a>Thread 中断</h3><p>常用的有两种方式：</p><p><strong>(1).通过抛出InterruptedException来中断线程</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span>  <span class="hljs-keyword">class</span>  <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>{<br>    <span class="hljs-keyword">private</span>  <span class="hljs-type">int</span> count=<span class="hljs-number">0</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>        <span class="hljs-built_in">super</span>.run();<br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){<br>                    count++;<br>                    System.out.println(<span class="hljs-string">"count value:"</span>+count);<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.interrupted() || <span class="hljs-built_in">this</span>.isInterrupted()){<br>                        System.out.println(<span class="hljs-string">"check interrupted show!"</span>);<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>                    }<br>            }<br>        }<span class="hljs-keyword">catch</span> ( InterruptedException e) {<br>            System.out.println(<span class="hljs-string">"thread is stop!"</span>);<br>            e.printStackTrace();<br>        }<br>    }<br>    <br>} <br></code></pre></td></tr></tbody></table></figure><p><strong>(2).通过变量来中断（常用）</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span>  <span class="hljs-keyword">class</span>  <span class="hljs-title class_">CustomThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>{<br>    <span class="hljs-keyword">private</span>  <span class="hljs-type">int</span> count=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isCancel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>        <span class="hljs-built_in">super</span>.run();<br>        <span class="hljs-keyword">while</span>(!isCancel){<br>                count++;<br>                System.out.println(<span class="hljs-string">"count value:"</span>+count);<br>        }<br>    }<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>{<br>        isCancel = <span class="hljs-literal">true</span>;<br>    }<br>} <br></code></pre></td></tr></tbody></table></figure><h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p>分变量同步和代码块同步两个方面来讲解</p><p><strong>(1).变量同步</strong></p><p>使用volatile关键字</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 主内存和线程内存缓存进行同步</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> val = <span class="hljs-number">5</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getVal</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">return</span> val;<br>}<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setVal</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>{<br>    <span class="hljs-keyword">this</span>.val = val;<br>}<br></code></pre></td></tr></tbody></table></figure><p>使用synchronized关键字</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">val2</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 使用一个motinor来监听（实现资源由一个线程进行操作）</span><br><span class="hljs-comment"> * 主内存和线程内存缓存进行同步</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getVal2</span><span class="hljs-params">()</span> {<br>    <span class="hljs-keyword">return</span> val2;<br>}<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">setVal2</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> {<br>    <span class="hljs-built_in">this</span>.val2 = val;<br>}<br></code></pre></td></tr></tbody></table></figure><p>使用关键字AtomicXXXXX</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp">AtomicInteger mAtomicValue = <span class="hljs-keyword">new</span>  AtomicInteger(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAtomicValue</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span></span>)</span>{<br>    mAtomicValue.getAndSet(<span class="hljs-keyword">value</span>);<br>}<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getAtomicValue</span>()</span>{<br>    <span class="hljs-keyword">return</span> mAtomicValue.<span class="hljs-keyword">get</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>(2).代码块同步</strong></p><p>代码块同步分乐观锁和悲观锁来讲解</p><p>使用悲观锁时，其他线程等待，进入睡眠，频繁切换任务，消耗cpu资源</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>){<br>    .....<br>    }<br></code></pre></td></tr></tbody></table></figure><p>使用乐观锁时，失败重试，避免任务重复切换，减少cpu消耗</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span>  ReentrantLock();<br><span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();<br>......<br><span class="hljs-keyword">lock</span>.unlock();<br></code></pre></td></tr></tbody></table></figure><h2 id="Android-Threading"><a href="#Android-Threading" class="headerlink" title="Android Threading"></a>Android Threading</h2><p>android中很多操作需要在主线程中执行，比如UI的操作，点击事件等等，但是如果主线程操作太多，占有的执行时间过长就会出现前面我们说的卡顿现象：</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-d4e4ae18dd8cd437.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/661/format/webp" alt="img"></p><p>为了减轻主线程操作过多，避免出现卡顿的现象，我们把一些操作复杂的消耗时间长的任务放到线程池中去执行。下面我们就来介绍android中几种线程的类。</p><h3 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h3><p>为UI线程与工作线程之间进行快速的切换提供一种简单便捷的机制。适用于当下立即需要启动，但是异步执行的生命周期短暂的使用场景。<br>它提供了一种简便的异步处理机制，但是它又同时引入了一些令人厌恶的麻烦。一旦对AsyncTask使用不当，很可能对程序的性能带来负面影响，同时还可能导致内存泄露。(<br>关于内存泄漏在上面已经讲过)</p><p><strong>使用AsyncTask需要注意的问题?</strong></p><p>(1).在AsyncTask中所有的任务都是被线性调度执行的，他们处在同一个任务队列当中，按顺序逐个执行。一旦有任务执行时间过长，队列中其他任务就会阻塞。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-713e085214020903.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/559/format/webp" alt="img"></p><p>对于上面的问题，我们可以使用AsyncTask.executeOnExecutor()让AsyncTask变成并发调度。</p><p>(2).AsyncTask对正在执行的任务不具备取消的功能，所以我们要在任务代码中添加取消的逻辑（和上面Thread类似）</p><p>(3).AsyncTask使用不当会导致内存泄漏（可以参考内存泄漏一章）</p><h3 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h3><p>为某些回调方法或者等待某些任务的执行设置一个专属的线程，并提供线程任务的调度机制。<br>先来了解下Looper，Handler，MessageQueue<br><strong>Looper:</strong> 能够确保线程持续存活并且可以不断的从任务队列中获取任务并进行执行。<br><strong>Handler:</strong> 能够帮助实现队列任务的管理，不仅仅能够把任务插入到队列的头部，尾部，还可以按照一定的时间延迟来确保任务从队列中能够来得及被取消掉。<br><strong>MessageQueue:</strong> 使用Intent，Message，Runnable作为任务的载体在不同的线程之间进行传递。<br>把上面三个组件打包到一起进行协作，这就是HandlerThread</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-e88d1a439d37bf38.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/622/format/webp" alt="img"></p><p>我们先来看下源码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HandlerThread</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> priority)</span> {<br>        <span class="hljs-built_in">super</span>(name);<br>        mPriority = priority;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br>        mTid = Process.myTid();<br>        Looper.prepare();<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {<br>            mLooper = Looper.myLooper();<br>            notifyAll();<br>        }<br>        Process.setThreadPriority(mPriority);<br>        onLooperPrepared();<br>        Looper.loop();<br>        mTid = -<span class="hljs-number">1</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> Looper <span class="hljs-title function_">getLooper</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">if</span> (!isAlive()) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>        <span class="hljs-comment">// If the thread has been started, wait until the looper has been created.</span><br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {<br>            <span class="hljs-keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="hljs-literal">null</span>) {<br>                <span class="hljs-keyword">try</span> {<br>                    wait();<br>                } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                }<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> mLooper;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面的源码发现，HandlerThread其实就是在线程中维持一个消息循环队列。下面我们看下使用：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">    HandlerThread mHanderThread=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">"hanlderThreadTest"</span>,Process.THREAD_PRIORITY_BACKGROUND);<br>        mHanderThread.run();<br>        Looper mHanderThreadLooper=mHanderThread.getLooper();<br><br>        Handler mHandler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(mHanderThreadLooper){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span>{<br>        <span class="hljs-built_in">super</span>.handleMessage(msg);<br>        <span class="hljs-comment">//子线程中执行</span><br>        ...<br>        }<br>        };<br>        <span class="hljs-comment">//发送消息</span><br>        mHandler.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>(){<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        ...<br>        }<br>        });  <br></code></pre></td></tr></tbody></table></figure><h3 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h3><p>适合于执行由UI触发的后台Service任务，并可以把后台任务执行的情况通过一定的机制反馈给UI。<br>默认的Service是执行在主线程的，可是通常情况下，这很容易影响到程序的绘制性能(抢占了主线程的资源)<br>。除了前面介绍过的AsyncTask与HandlerThread，我们还可以选择使用IntentService来实现异步操作。IntentService继承自普通Service同时又在内部创建了一个HandlerThread，在onHandlerIntent()<br>的回调里面处理扔到IntentService的任务。所以IntentService就不仅仅具备了异步线程的特性，还同时保留了Service不受主页面生命周期影响的特点。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-b85e16cfc4e1ebf4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/744/format/webp" alt="img"></p><p><strong>使用IntentService需要特别注意的点：</strong></p><p>(1).因为IntentService内置的是HandlerThread作为异步线程，所以每一个交给IntentService的任务都将以队列的方式逐个被执行到，一旦队列中有某个任务执行时间过长，那么就会导致后续的任务都会被延迟处理。</p><p>(2)<br>.通常使用到IntentService的时候，我们会结合使用BroadcastReceiver把工作线程的任务执行结果返回给主UI线程。使用广播容易引起性能问题，我们可以使用LocalBroadcastManager来发送只在程序内部传递的广播，从而提升广播的性能。我们也可以使用runOnUiThread()<br>快速回调到主UI线程。</p><p>(3).包含正在运行的IntentService的程序相比起纯粹的后台程序更不容易被系统杀死，该程序的优先级是介于前台程序与纯后台程序之间的。</p><h3 id="Loader"><a href="#Loader" class="headerlink" title="Loader"></a>Loader</h3><p>对于3.0后ContentProvider中的耗时操作，推荐使用Loader异步加载数据机制。相对其他加载机制，Loader有那些优点呢？</p><ul><li><p>提供异步加载数据机制</p></li><li><p>对数据源变化进行监听，实时更新数据</p></li><li><p>在Activity配置发生变化（如横竖屏切换）时不用重复加载数据</p></li><li><p>适用于任何Activity和Fragment</p></li></ul><p>下面我们来看下Loader的具体使用：<br>我们以获得手机中所有的图片为例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">    getLoaderManager().initLoader(LOADER_TYPE,<span class="hljs-literal">null</span>,mLoaderCallback);<br>        LoaderManager.LoaderCallbacks&lt;Cursor&gt; mLoaderCallback=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoaderManager</span>.LoaderCallbacks&lt;Cursor&gt;(){<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[]IMAGE_COLUMNS={<br>        MediaStore.Images.Media.DATA,<span class="hljs-comment">//图片路径</span><br>        MediaStore.Images.Media.DISPLAY_NAME,<span class="hljs-comment">//显示的名字</span><br>        MediaStore.Images.Media.DATE_ADDED,<span class="hljs-comment">//添加时间</span><br>        MediaStore.Images.Media.MIME_TYPE,<span class="hljs-comment">//图片扩展类型</span><br>        MediaStore.Images.Media.SIZE,<span class="hljs-comment">//图片大小</span><br>        MediaStore.Images.Media._ID,<span class="hljs-comment">//图片id</span><br>        };<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Loader&lt;Cursor&gt; <span class="hljs-title function_">onCreateLoader</span><span class="hljs-params">(<span class="hljs-type">int</span> id,Bundle args)</span>{<br>        toggleShowLoading(<span class="hljs-literal">true</span>,getString(R.string.common_loading));<br><br>        CursorLoader cursorLoader=<span class="hljs-keyword">new</span> <span class="hljs-title class_">CursorLoader</span>(ImageSelectActivity.<span class="hljs-built_in">this</span>,MediaStore.Images.Media.EXTERNAL_CONTENT_URI,IMAGE_COLUMNS,<br>        IMAGE_COLUMNS[<span class="hljs-number">4</span>]+<span class="hljs-string">" &gt; 0 AND "</span>+IMAGE_COLUMNS[<span class="hljs-number">3</span>]+<span class="hljs-string">" =? OR "</span>+IMAGE_COLUMNS[<span class="hljs-number">3</span>]+<span class="hljs-string">" =? "</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"image/jpeg"</span>,<span class="hljs-string">"image/png"</span>},IMAGE_COLUMNS[<span class="hljs-number">2</span>]+<span class="hljs-string">" DESC"</span>);<br>        <span class="hljs-keyword">return</span> cursorLoader;<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoadFinished</span><span class="hljs-params">(Loader&lt;Cursor&gt; loader,Cursor data)</span>{<br>        <span class="hljs-keyword">if</span>(data!=<span class="hljs-literal">null</span>&amp;&amp;data.getCount()&gt;<span class="hljs-number">0</span>){<br>        ArrayList&lt;String&gt; imageList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">if</span>(mShowCamera){<br>        imageList.add(<span class="hljs-string">""</span>);<br>        }<br>        <span class="hljs-keyword">while</span>(data.moveToNext()){<br>        String path=data.getString(data.getColumnIndexOrThrow(IMAGE_COLUMNS[<span class="hljs-number">0</span>]));<br>        imageList.add(path);<br>        Log.e(<span class="hljs-string">"ImageSelect"</span>,<span class="hljs-string">"IIIIIIIIIIIIIIIIIIII=====&gt;"</span>+path);<br>        }<br>        <span class="hljs-comment">//显示数据</span><br>        showListData(imageList);<br>        toggleShowLoading(<span class="hljs-literal">false</span>,getString(R.string.common_loading));<br>        }<br>        }<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoaderReset</span><span class="hljs-params">(Loader&lt;Cursor&gt; loader)</span>{<br>        }   <br></code></pre></td></tr></tbody></table></figure><p>onCreateLoader()  实例化并返回一个新创建给定ID的Loader对象<br>onLoadFinished() 当创建好的Loader完成了数据的load之后回调此方法<br>onLoaderReset() 当创建好的Loader被reset时调用此方法，这样保证它的数据无效<br>LoaderManager会对查询的操作进行缓存，只要对应Cursor上的数据源没有发生变化，在配置信息发生改变的时候(例如屏幕的旋转)<br>，Loader可以直接把缓存的数据回调到onLoadFinished()，从而避免重新查询数据。另外系统会在Loader不再需要使用到的时候(<br>例如使用Back按钮退出当前页面)回调onLoaderReset()方法，我们可以在这里做数据的清除等等操作。</p><h3 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h3><p>把任务分解成不同的单元，分发到各个不同的线程上，进行同时并发处理。<br>线程池适合用在把任务进行分解，并发进行执行的场景。<br>系统提供ThreadPoolExecutor帮助类来帮助我们简化实现线程池。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-91d21d03a19a7610.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/670/format/webp" alt="img"></p><p>使用线程池需要特别注意同时并发线程数量的控制，理论上来说，我们可以设置任意你想要的并发数量，但是这样做非常的不好。因为CPU只能同时执行固定数量的线程数，一旦同时并发的线程数量超过CPU能够同时执行的阈值，CPU就需要花费精力来判断到底哪些线程的优先级比较高，需要在不同的线程之间进行调度切换。<br>一旦同时并发的线程数量达到一定的量级，这个时候CPU在不同线程之间进行调度的时间就可能过长，反而导致性能严重下降。另外需要关注的一点是，每开一个新的线程，都会耗费至少64K+的内存。为了能够方便的对线程数量进行控制，ThreadPoolExecutor为我们提供了初始化的并发线程数量，以及最大的并发数量进行设置。</p><figure class="highlight dart"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment"><span class="language-markdown">/**</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 核心线程数</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 最大线程数</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 保活时间</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 时间单位</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 任务队列</span></span><br><span class="language-markdown"><span class="hljs-comment"><span class="hljs-bullet"> *</span> 线程工厂</span></span><br><span class="language-markdown"><span class="hljs-comment"> <span class="hljs-emphasis">*/</span></span></span><br>threadPoolExecutor = <span class="hljs-keyword">new</span> ThreadPoolExecutor(<br>        CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,<br>        linkedBlockingQueue, sThreadFactory);<br>threadPoolExecutor.execute(runnable);<br></code></pre></td></tr></tbody></table></figure><p>我们知道系统还提供了Executors类中几种线程池，下面我们来看下这些线程池的缺点：</p><p>**newFixedThreadPool 和 newSingleThreadExecutor:**主要问题是堆积的请求处理队列可能会耗费非常大的内存，甚至 OOM。<br>**newCachedThreadPool 和 newScheduledThreadPool:**主要问题是线程数最大数是 Integer.MAX_VALUE，可能会创建数量非常多的线程，甚至<br>OOM</p><p>我们看到这些线程池但是有缺点的，所以具体使用那种方式实现要根据我们的需求来选择。</p><p>如果想要避开上面的问题，可以参考OKHttp中线程池的实现，OKHttp中队线程调度又封装了一层，使用安全且方便，有兴趣的可以去看看源码。</p><h2 id="线程优先级"><a href="#线程优先级" class="headerlink" title="线程优先级"></a>线程优先级</h2><p>Android系统会根据当前运行的可见的程序和不可见的后台程序对线程进行归类，划分为forground的那部分线程会大致占用掉CPU的90%左右的时间片，background的那部分线程就总共只能分享到5%-10%左右的时间片。之所以设计成这样是因为forground的程序本身的优先级就更高，理应得到更多的执行时间。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-fedda45234d2551d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/574/format/webp" alt="img"></p><p>默认情况下，新创建的线程的优先级默认和创建它的母线程保持一致。如果主UI线程创建出了几十个工作线程，这些工作线程的优先级就默认和主线程保持一致了，为了不让新创建的工作线程和主线程抢占CPU资源，需要把这些线程的优先级进行降低处理，这样才能给帮组CPU识别主次，提高主线程所能得到的系统资源。</p><p>在Android系统里面，我们可以通过android.os.Process.setThreadPriority(int)<br>设置线程的优先级，参数范围从-20到24，数值越小优先级越高。Android系统还为我们提供了以下的一些预设值，我们可以通过给不同的工作线程设置不同数值的优先级来达到更细粒度的控制。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-1f22773258ff2ed1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/525/format/webp" alt="img"></p><p>大多数情况下，新创建的线程优先级会被设置为默认的0，主线程设置为0的时候，新创建的线程还可以利用THREAD_PRIORITY_LESS_FAVORABLE或者THREAD_PRIORITY_MORE_FAVORABLE来控制线程的优先级。</p><h1 id="安装包优化"><a href="#安装包优化" class="headerlink" title="安装包优化"></a>安装包优化</h1><p>安装包优化的主要方向就是APP瘦身，那么App瘦身带来哪些好处呢？<br>(1).下载时省流量<br>(2).用户好的体验，下载更快，安装更快</p><h2 id="常用的优化方式"><a href="#常用的优化方式" class="headerlink" title="常用的优化方式"></a>常用的优化方式</h2><h3 id="清理无用资源"><a href="#清理无用资源" class="headerlink" title="清理无用资源"></a>清理无用资源</h3><p>在我们应用版本的迭代中，肯定有废弃的代码和资源，我们要及时地清理，来减小App体积。</p><p>清理的方法：</p><p><strong>(1).使用Refactor-&gt;Remove unused Resource</strong></p><p>这个一键清除的小功能不是特别的又用，因为资源是经过反射或字符拼接等方式获取，所以检查不完全，需要我们不断的实验。</p><p><img src="https://upload-images.jianshu.io/upload_images/5748654-8e0439bf866e6a33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/408/format/webp" alt="img"></p><p><strong>(2).使用Lint工具</strong></p><p>lint工具还是很有用的，它给我们需要优化的点</p><p>需要注意的点：</p><ul><li><p>检测没有用的布局并且删除</p></li><li><p>把未使用到的资源删除</p></li><li><p>建议String.xml有一些没有用到的字符也删除掉</p></li></ul><p><strong>(3).开启shrinkResources去除无用资源</strong></p><p>在build.gradle 里面配置shrinkResources<br>true，在打包的时候会自动清除掉无用的资源，但经过实验发现打出的包并不会，而是会把部分无用资源用更小的东西代替掉。注意，这里的“无用”是指调用图片的所有父级函数最终是废弃代码，而shrinkResources<br>true 只能去除没有任何父函数调用的情况.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">android {<br>    buildTypes {<br>        release {<br>            shrinkResources <span class="hljs-literal">true</span><br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>(4).删除无用的语言资源</strong></p><p>大部分应用其实并不需要支持几十种语言的国际化支持。比如我们只是保存中文支持：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">android {<br>    defaultConfig {<br>        resConfigs <span class="hljs-string">"zh"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>(5).清理第三方库中冗余代码</strong></p><p>对于第三方库，可能我们只是用到库中的一个功能，那么我们就可以导入源码，并且删除无关的代码，来减小体积。</p><h3 id="图片资源优化"><a href="#图片资源优化" class="headerlink" title="图片资源优化"></a>图片资源优化</h3><p>图片是占用空间比较大的资源，这是我们要重点优化的地方。</p><p><strong>(1).使用压缩过的图片</strong></p><p>这个点在这里就不再累赘。</p><p><strong>(2).只用一套图片</strong></p><p>对于绝大对数APP来说，只需要取一套设计图就足够了。从内存占用和适配的角度考虑，这一套图建议放在xhdpi文件夹下；</p><p><strong>(3).使用不带alpha值的jpg图片</strong></p><p>对于非透明的大图，jpg将会比png的大小有显著的优势，虽然不是绝对的，但是通常会减小到一半都不止。</p><p><strong>(4).使用tinypng有损压缩</strong></p><p>支持上传PNG图片到官网上压缩，然后下载保存，在保持alpha通道的情况下对PNG的压缩可以达到1/3之内，而且用肉眼基本上分辨不出压缩的损失.</p><p><strong>(5).使用webp格式</strong></p><p>webp支持透明度，压缩比比jpg更高但显示效果却不输于jpg,从Android 4.0+开始原生支持，但是不支持包含透明度，直到Android<br>4.2.1+才支持显示含透明度的webp，使用的时候要特别注意。</p><p><strong>(6).使用svg</strong></p><p>矢量图是由点与线组成,和位图不一样,它再放大也能保持清晰度，而且使用矢量图比位图设计方案能节约30～40%的空间，现在谷歌一直在强调扁平化方式，矢量图可很好的契合该设计理念。</p><ul><li><p>占用存储空间小</p></li><li><p>无极拉伸不会出现锯齿，可以照顾不同尺寸的机型</p></li><li><p>Android Studio自带很多资源</p></li></ul><p><strong>(7).使用shape</strong></p><p>特别是在扁平化盛行的当下，很多纯色的渐变的圆角的图片都可以用shape实现，代码灵活可控，省去了大量的背景图片。</p><p><strong>(8).使用着色方案</strong></p><p>相信你的工程里也有很多selector文件，也有很多相似的图片只是颜色不同，通过着色方案我们能大大减轻这样的工作量，减少这样的文件。</p><p><strong>(9).对打包后的图片进行压缩</strong></p><p>使用7zip压缩方式对图片进行压缩,建议使用微信的<a href="https://github.com/shwenzhang/AndResGuard">AndResGuard</a></p><h3 id="资源动态加载"><a href="#资源动态加载" class="headerlink" title="资源动态加载"></a>资源动态加载</h3><p>资源可以动态加载，减小apk体积。</p><p><strong>(1).在线化素材库</strong></p><p>如果你的APP支持素材库(比如聊天表情库)的话，考虑在线加载模式，因为往往素材库都有不小的体积</p><p><strong>(2).皮肤加载</strong></p><p>有的app用到皮肤库，这是就可以使用动态加载。</p><p><strong>(3).模块插件化</strong></p><p>如果模块过多，apk体积过大，可以考虑插件化，来减少体积。</p><h3 id="lib库优化"><a href="#lib库优化" class="headerlink" title="lib库优化"></a>lib库优化</h3><p>只提供对主流架构的支持，比如arm，对于mips和x86架构可以考虑不支持，这样可以大大减小APK的体积.</p><h3 id="7zip压缩资源"><a href="#7zip压缩资源" class="headerlink" title="7zip压缩资源"></a>7zip压缩资源</h3><p>对于assets或者raw文件夹中的资源，可以使用7zip压缩，使用时进行解压。</p><h3 id="代码混淆"><a href="#代码混淆" class="headerlink" title="代码混淆"></a>代码混淆</h3><p>在gradle使用minifyEnabled进行Proguard混淆的配置.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">android {<br>    buildTypes {<br>        release {<br>            minifyEnabled <span class="hljs-literal">true</span><br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>为什么代码混淆可以让apk变小?</li></ul><ol><li>可以删除注释和不用的代码。</li><li>将java文件名改成短名</li><li>将方法名改成短名</li></ol><h3 id="资源-res-混淆"><a href="#资源-res-混淆" class="headerlink" title="资源(res)混淆"></a>资源(res)混淆</h3><p>资源混淆简单来说希望实现将res/drawable/icon,png变成res/drawable/a.png,或我们甚至可以将文件路径也同时混淆，改成r/s/a.png。<br>建议使用微信的<a href="https://github.com/shwenzhang/AndResGuard">AndResGuard</a></p><h3 id="使用微信AndResGuard"><a href="#使用微信AndResGuard" class="headerlink" title="使用微信AndResGuard"></a>使用微信AndResGuard</h3><p>使用微信AndResGuard对资源混淆并且压缩图片res等资源</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs csharp">apply plugin: <span class="hljs-string">'AndResGuard'</span><br>buildscript {<br>    dependencies {<br>        classpath <span class="hljs-string">'com.tencent.mm:AndResGuard-gradle-plugin:1.1.7'</span><br>    }<br>}<br>andResGuard {<br>    mappingFile = <span class="hljs-literal">null</span><br>    use7zip = <span class="hljs-literal">true</span><br>    useSign = <span class="hljs-literal">true</span><br>    keepRoot = <span class="hljs-literal">false</span><br>    <span class="hljs-comment">// add &lt;your_application_id&gt;.R.drawable.icon into whitelist.</span><br>    <span class="hljs-comment">// because the launcher will get thgge icon with his name</span><br>    def packageName = &lt;your_application_id&gt;<br>            whiteList = [<br>    <span class="hljs-comment">//for your icon</span><br>    packageName + <span class="hljs-string">".R.drawable.icon"</span>,<br>            <span class="hljs-comment">//for fabric</span><br>            packageName + <span class="hljs-string">".R.string.com.crashlytics.*"</span>,<br>            <span class="hljs-comment">//for umeng update</span><br>            packageName + <span class="hljs-string">".R.string.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.string.UM*"</span>,<br>            packageName + <span class="hljs-string">".R.string.tb_*"</span>,<br>            packageName + <span class="hljs-string">".R.layout.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.layout.tb_*"</span>,<br>            packageName + <span class="hljs-string">".R.drawable.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.drawable.tb_*"</span>,<br>            packageName + <span class="hljs-string">".R.anim.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.color.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.color.tb_*"</span>,<br>            packageName + <span class="hljs-string">".R.style.*UM*"</span>,<br>            packageName + <span class="hljs-string">".R.style.umeng*"</span>,<br>            packageName + <span class="hljs-string">".R.id.umeng*"</span><br>    ]<br>    compressFilePattern = [<br>    <span class="hljs-string">"*.png"</span>,<br>            <span class="hljs-string">"*.jpg"</span>,<br>            <span class="hljs-string">"*.jpeg"</span>,<br>            <span class="hljs-string">"*.gif"</span>,<br>            <span class="hljs-string">"resources.arsc"</span><br>    ]<br>    sevenzip {<br>        artifact = <span class="hljs-string">'com.tencent.mm:SevenZip:1.1.7'</span><br>        <span class="hljs-comment">//path = "/usr/local/bin/7za"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="Facebook的redex优化字节码"><a href="#Facebook的redex优化字节码" class="headerlink" title="Facebook的redex优化字节码"></a>Facebook的redex优化字节码</h3><p>redex是facebook发布的一款android字节码的优化工具.<br><a href="https://github.com/facebook/redex">redex</a></p>]]></content>
    
    
    <categories>
      
      <category>Android</category>
      
      <category>知识汇总</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git免密拉取(包括ssh,http方式)</title>
    <link href="/2023/08/23/docs/git/git-mian-mi-la-qu-bao-gua-ssh-http-fang-shi/"/>
    <url>/2023/08/23/docs/git/git-mian-mi-la-qu-bao-gua-ssh-http-fang-shi/</url>
    
    <content type="html"><![CDATA[<h2 id="配置Git免密拉取"><a href="#配置Git免密拉取" class="headerlink" title="配置Git免密拉取"></a>配置Git免密拉取</h2><h3 id="基础安装配置"><a href="#基础安装配置" class="headerlink" title="基础安装配置"></a>基础安装配置</h3><p>已安装配置好的可以略过</p><ol><li>先配置一下用户名和邮箱<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">'username'</span><br>git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.email</span> <span class="hljs-string">'xxx@xxx.com'</span><br></code></pre></td></tr></tbody></table></figure></li><li>生成ssh公钥：<figure class="highlight excel"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">ssh-keygen -<span class="hljs-built_in">t</span> rsa -C <span class="hljs-string">"xxx@xxx.com"</span><br></code></pre></td></tr></tbody></table></figure></li></ol><h3 id="ssh免密拉取配置"><a href="#ssh免密拉取配置" class="headerlink" title="ssh免密拉取配置"></a>ssh免密拉取配置</h3><ol><li><p>将  <code>~/.ssh/id_rsa.pub</code> 公钥文件内容粘贴到GitLab的ssh公钥管理处</p></li><li><p>使用</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">git</span>@xxx:xxx.git<br></code></pre></td></tr></tbody></table></figure><p>测试一下，一般可以直接拉取成功。</p><p>但是有些私有云上部署的GitLab不支持使用ssh方式拉取仓库，所以只能用http方式拉取，类似这样</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">http</span>://XXX/XXX.git<br></code></pre></td></tr></tbody></table></figure><p>使用http拉取的话默认又需要每次都输入用户名，密码。</p></li></ol><h3 id="http免密拉取配置"><a href="#http免密拉取配置" class="headerlink" title="http免密拉取配置"></a>http免密拉取配置</h3><ol><li><p>执行</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git config --global credential.helper store<br></code></pre></td></tr></tbody></table></figure><p>执行后再查看一下<code>~/.gitconfig</code>文件，会发现多了这样的内容</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[credential]</span><br> <span class="hljs-attr">helper</span> = store<br></code></pre></td></tr></tbody></table></figure><p>也可以不执行命令，手动将上面的内容加到 <code>~/.gitconfig</code> 文件中</p><p>注意：这一步必须要做，下面步骤其实也可以省略。这一步执行完成之后下次首次使用http拉取时会提示输入账号名密码，输入后会自动将相关信息保存到<code>.git-credentials</code><br>文件中，再次拉取时就不需要账号密码了，也可以手动修改<code>.git-credentials</code>文件中的内容，首次使用http拉取时也可以直接免密拉取</p></li><li><p>cd到用户根目录 <code>~/</code> 下，查看有没有 <code>.git-credentials</code> 文件，没有的话则创建一个</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> .git-credentials<br></code></pre></td></tr></tbody></table></figure><p>打开<code>.git-credentials</code>文件，在里面根据自己的配置添加以下内容</p><figure class="highlight dust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">https://</span><span class="hljs-template-variable">{username}</span><span class="language-xml">:</span><span class="hljs-template-variable">{password}</span><span class="language-xml">@</span><span class="hljs-template-variable">{git地址}</span><br></code></pre></td></tr></tbody></table></figure><p><code>{username}</code> 指的是git的账号名</p><p><code>{password}</code> 指的是git账号名的密码</p><p><code>{git地址}</code> 指的是git仓库的域名或IP和端口号</p><p>类似下面这样</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://name:pw12345@git.gitxx.com<br><span class="hljs-attribute">http</span>://name:pw12345@<span class="hljs-number">123</span>.<span class="hljs-number">456</span>.<span class="hljs-number">789</span>:<span class="hljs-number">1234</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>这时候再用http的方式拉取仓库就不需要输入用户名和密码了</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GIT</title>
    <link href="/2023/08/23/docs/git/git/"/>
    <url>/2023/08/23/docs/git/git/</url>
    
    <content type="html"><![CDATA[<h4 id="版本控制的作用"><a href="#版本控制的作用" class="headerlink" title="版本控制的作用"></a>版本控制的作用</h4><ul><li>备份<ul><li>避免万一机器挂了,磁盘坏了等原因导致代码丢失.</li></ul></li><li>多人协作<ul><li>提交 (push/commit),拉取 (pull/update)</li><li>分支 (branch)</li><li>重置 (revert)</li><li>日志 (log)</li><li>…</li></ul></li></ul><h4 id="Git-简史"><a href="#Git-简史" class="headerlink" title="Git 简史"></a>Git 简史</h4><p><a href="https://git-scm.com/book/zh/v1/%E8%B5%B7%E6%AD%A5-Git-%E7%AE%80%E5%8F%B2">https://git-scm.com/book/zh/v1/起步-Git-简史</a></p><p>同生活中的许多伟大事件一样，Git 诞生于一个极富纷争大举创新的年代。Linux 内核开源项目有着为数众广的参与者。绝大多数的 Linux<br>内核维护工作都花在了提交补丁和保存归档的繁琐事务上（1991－2002年间）。到 2002 年，整个项目组开始启用分布式版本控制系统<br>BitKeeper 来管理和维护代码。</p><p>到了 2005 年，开发 BitKeeper 的商业公司同 Linux 内核开源社区的合作关系结束，他们收回了免费使用 BitKeeper 的权力。这就迫使<br>Linux 开源社区（特别是 Linux 的缔造者 Linus Torvalds ）不得不吸取教训，只有开发一套属于自己的版本控制系统才不至于重蹈覆辙。他们对新的系统制订了若干目标：</p><ul><li>速度</li><li>简单的设计</li><li>对非线性开发模式的强力支持（允许上千个并行开发的分支）</li><li>完全分布式</li><li>有能力高效管理类似 Linux 内核一样的超大规模项目（速度和数据量）</li></ul><p>自诞生于 2005 年以来，Git 日臻成熟完善，在高度易用的同时，仍然保留着初期设定的目标。它的速度飞快，极其适合管理大项目，它还有着令人难以置信的非线性分支管理系统（见第三章），可以应付各种复杂的项目开发需求。</p><h4 id="GIT-基本"><a href="#GIT-基本" class="headerlink" title="GIT 基本"></a>GIT 基本</h4><ul><li><p>git 是分布式去中心化的 ,意味着”服务器端”的文档结构,管理方法跟客户端完全一致(其实并没有服务器这一说)</p></li><li><p>git init  <code>初始化一个 git 仓库(创建.git 目录)</code></p></li><li><p>.gitignore  <code>类似svn ignore.更灵活,不同的工程有不同的配置</code></p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 此为注释 – 将被 Git 忽略</span><br><span class="hljs-comment"># 忽略所有 .a 结尾的文件</span><br>*<span class="hljs-string">.a</span><br><span class="hljs-comment"># 但 lib.a 除外</span><br>!lib.a<br><span class="hljs-comment"># 仅仅忽略项目根目录下的 TODO 文件，不包括 subdir/TODO</span><br><span class="hljs-string">/TODO</span><br><span class="hljs-comment"># 忽略 build/ 目录下的所有文件</span><br>build/<br><span class="hljs-comment"># 会忽略 doc/notes.txt 但不包括 doc/server/arch.txt</span><br>doc/*<span class="hljs-string">.txt</span><br><span class="hljs-comment"># 忽略 doc/ 目录下所有扩展名为 txt 的文件</span><br>doc/**/*<span class="hljs-string">.txt</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>git add   <code>跟踪文件,并将其放到暂存</code></p><ul><li>git add *   <code>暂存当前目录下所有文件</code></li><li>git add *.c <code>暂存所有.c 文件</code></li><li>git add README  <code>暂存README 文件</code></li></ul></li><li><p>git commit    <code>提交暂存</code></p><ul><li>git commit -a   <code>提交所有,包括未暂存但是已跟踪的.</code></li></ul></li><li><p>git clone   <code>类似 svn checkout,用来 clone 一个仓库</code></p></li><li><p>git status    <code>类似svn status 查看当前工作目录的状态</code></p></li><li><pre><code class="hljs">On branch dev_ftd_ftrChanges not staged for commit:  (use "git add &lt;file&gt;..." to update what will be committed)  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)        modified:   app/build.gradle        modified:   app/src/main/java/com/tsinglink/android/mpu/fragment/VideoSettingFragment.java        modified:   app/src/main/res/layout/fragment_video_setting.xml        modified:   app/src/main/res/values-en/strings.xml        modified:   app/src/main/res/values/strings.xmlUntracked files:  (use "git add &lt;file&gt;..." to include in what will be committed)        app/TSP210_D_LA1_1H/no changes added to commit (use "git add" and/or "git commit -a")<figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-section">#### git分支</span><br><br><span class="hljs-bullet">-</span> git 项目结构<br><br>  如下图所示,当前项目有两个分支:<span class="hljs-code">`master`</span>分支和 <span class="hljs-code">`v1.0`</span>分支<br><br>  有个 <span class="hljs-code">`HEAD`</span> 指针始终指着当前工作目录所在的分支.<br><br>  Git 的 “master” 分支并不是一个特殊分支。 它就跟其它分支完全没有区别。 之所以几乎每一个仓库都有 master 分支，是因为 git<br>  init 命令默认创建它，并且大多数人都懒得去改动它。<br><br>  ![<span class="hljs-string">image</span>](<span class="hljs-link">https://git-scm.com/book/en/v2/images/branch-and-history.png</span>)<br><span class="hljs-bullet">-</span> git branch <span class="hljs-code">`branch_name`</span>   <span class="hljs-code">`创建一个分支`</span><br></code></pre></td></tr></tbody></table></figure>  git branch testing  <figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs awk">  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/head-to-master.png)<br><br>  创建分支后,从当前最新的 HEAD 分支处两条支流,但是 HEAD还是指向 master.<br>- git checkout testing    `切换到某个分支`<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/head-to-testing.png)<br>- 分支前移<br><br>  再做一次提交后,HEAD 随着 testing 都向前移动了.<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/advance-testing.png)<br><br>- 再切到 master  `git checkout master`<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/checkout-master.png)<br><br>- 再做修改并commit<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/advance-master.png)<br>- 合并分支<br><br>  `git merge`<br><br>    - 快进合并(fast-forward)<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/basic-branching-<span class="hljs-number">4</span>.png)<br><br>  ![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/basic-branching-<span class="hljs-number">5</span>.png)<br><br>    - git branch -d `branch_name`  [删除分支]<br></code></pre></td></tr></tbody></table></figure>  git branch -d hotfix  Deleted branch hotfix (3a0874c).  <figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/basic-branching-<span class="hljs-number">6</span>.png)<br><br>  - 找到共同祖先再合并<br><br>![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/basic-merging-<span class="hljs-number">2</span>.png)<br><br>  - 遇到冲突<br></code></pre></td></tr></tbody></table></figure>  git merge iss53  Auto-merging index.html  CONFLICT (content): Merge conflict in index.html  Automatic merge failed; fix conflicts and then commit the result.  <figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>冲突<br></code></pre></td></tr></tbody></table></figure>  &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD  first file change from master  =======  first file change from dev_fix_bug1  &gt;&gt;&gt;&gt;&gt;&gt;&gt; dev_fix_bug1  <figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs diff"><br>  这表示 HEAD 所指示的版本（也就是你的 master 分支所在的位置）在这个区段的上半部分（<span class="hljs-comment">======= 的上半部分），而 dev_fix_bug1</span><br>  分支所指示的版本在 <span class="hljs-comment">======= 的下半部分。</span><br>  这里可以选择使用上半部分还是下半部分,或者重新来写这一行,只要 &lt;&lt;&lt;&lt;&lt;&lt;&lt; , <span class="hljs-comment">======= , 和 &gt;&gt;&gt;&gt;&gt;&gt;&gt; 这些行被完全删除后,就没有冲突了。</span><br><br><br><span class="hljs-deletion">- git branch `查看所有分支`</span><br></code></pre></td></tr></tbody></table></figure>  // 查看所有分支的最后一次提交记录  git branch -v    iss53   93b412c fix javascript issue  * master  7a98805 Merge branch 'iss53'    testing 782fd34 add scott to the author list in the readmes  <figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br><span class="hljs-comment">#### 远程分支和本地分支</span><br><br>多个人同时开发时,会产生不同的分支.本地的称为本地分支,其他人提交过的分支,成为远程分支.远程分支以**指针<br>** `origin/[分支名]`来表示.<br><br>`f4265`是本地从服务器 clone 时的提交点.<br>![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/remote-branches-<span class="hljs-number">1</span>.png)<br><br>在此之后,本地和远程各提交了两次,形成如下情况:<br><br>![image](https:<span class="hljs-regexp">//gi</span>t-scm.com<span class="hljs-regexp">/book/</span>en<span class="hljs-regexp">/v2/im</span>ages/remote-branches-<span class="hljs-number">3</span>.png)<br><br>拉取远程仓库<br>git fetch<br><br></code></pre></td></tr></tbody></table></figure></code></pre></li></ul><p>见上图</p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs"><br>拉取远程仓库并与本地合并<br><br></code></pre></td></tr></tbody></table></figure><pre><code class="hljs">                 A---B---C master on origin                /           D---E---F---G master               ^               origin/master in your repository                                              A---B---C origin/master                /         \           D---E---F---G---H master</code></pre><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs"><br>推送本地分支到远程<br><br></code></pre></td></tr></tbody></table></figure><p>$ git push origin serverfix<br>Counting objects: 24, done.<br>Delta compression using up to 8 threads.<br>Compressing objects: 100% (15/15), done.<br>Writing objects: 100% (24/24), 1.91 KiB | 0 bytes/s, done.<br>Total 24 (delta 2), reused 0 (delta 0)<br>To <a href="https://github.com/schacon/simplegit">https://github.com/schacon/simplegit</a></p><ul><li>[new branch]      serverfix -&gt; serverfix<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs"><br>删除远程分支<br><br></code></pre></td></tr></tbody></table></figure>$ git push origin –delete serverfix<br>To <a href="https://github.com/schacon/simplegit">https://github.com/schacon/simplegit</a></li></ul><ul><li>[deleted]         serverfix<figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs clean"><br>#### 标签<br><br>Git 可以给历史中的某一个提交打上标签，以示重要。 比较有代表性的是人们会使用这个功能来标记发布结点（v1<span class="hljs-number">.0</span> 等等）。<br><br><span class="hljs-number">1.</span> 列出所有标签<br><br></code></pre></td></tr></tbody></table></figure>git tag<figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-bullet">2.</span> 给当前提交打上轻量级标签<br><br></code></pre></td></tr></tbody></table></figure>git tag v1.0<figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-bullet">3.</span> 附注标签<br><br></code></pre></td></tr></tbody></table></figure>git tag -a v1.4 -m “提交 v1.4版本.修改记录如下:xxxxx”<figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-bullet">4.</span> 给历史提交打标签<br><br></code></pre></td></tr></tbody></table></figure>git tag -a v1.2 9fceb02<figure class="highlight node-repl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs node-repl"><br>#### 分支应用<br><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">由于 <span class="hljs-title class_">Git</span> 的分支实质上仅是包含所指对象校验和（长度为 <span class="hljs-number">40</span> 的 <span class="hljs-variable constant_">SHA</span>-<span class="hljs-number">1</span> 值字符串）的文件，所以它的创建和销毁都异常高效。</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">创建一个新分支就相当于往一个文件中写入 <span class="hljs-number">41</span> 个字节（<span class="hljs-number">40</span> 个字符和 <span class="hljs-number">1</span> 个换行符），如此的简单能不快吗？</span><br><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">这与过去大多数版本控制系统形成了鲜明的对比，它们在创建分支时，将所有的项目文件都复制一遍，并保存到一个特定的目录。</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">完成这样繁琐的过程通常需要好几秒钟，有时甚至需要好几分钟。所需时间的长短，完全取决于项目的规模。而在 <span class="hljs-title class_">Git</span></span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">中，任何规模的项目都能在瞬间创建新分支。 同时，由于每次提交都会记录父对象，所以寻找恰当的合并基础（译注：即共同祖先）也是同样的简单和高效。</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">这些高效的特性使得 <span class="hljs-title class_">Git</span> 鼓励开发人员频繁地创建和使用分支。</span><br><br><br>比如我们安卓开发过程中,使用SVN 分支的时候,要拷贝一份工作副本到本地,首先拷贝的过程就很慢,还浪费磁盘空间,拖累电脑速度.<br><br>Android studio 在打开一个新的工程时,需要建立文件索引,会很慢,还会生成大量临时文件,这些临时文件都上<br>G的.由于每个分支都是不同的副本,加起来体积就很大了,磁盘很快被塞满.另外很多的分支还会导致工程目录太多,不好管理.<br><br>另外svn 的分支合并也不太友好.涉及到多个文件夹之间切来切去的.<br><br>第三方工程 GIT 分支参考<br><br>- ffmpeg 29 个分支<br><br>  https://github.com/FFmpeg/FFmpeg<br><br>- 微软的vscode 366 个分支<br><br>  https://github.com/microsoft/vscode<br><br>分支开发模式<br><br>1. 根据开发进度分支<br><br>   一个模块开发之前,先创建一个分支.开发,测试完成后,合并到主分支.<br><br>   每一次发布,都打上一个标签, 当线上项目有 bug 需要紧急修复,在标签基础上创建临时分支来修补这个<br>   bug.修补完成再合并到当前分支和主分支.最后若有必要,删除临时分支<br><br>2. 根据产品分支<br><br>   主分支是公共项目,或者第一个产品项目;其他分支是在主分支基础上后来衍生出来的其他产品项目<br></code></pre></td></tr></tbody></table></figure> git branch<br>   210b<br>   210c<br>   210d<br>   210e<ul><li>master <figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs clean">   每个产品分支都可以使用第一条开发进度来衍生分支<br><br>#### 服务器上的 Git - 协议<br><br>远程仓库跟本地仓库没有本质区别.服务器上的 git 结构与本地也没有什么不同.<br><br>服务器的架设要考虑的实际上是用何种协议来将 git 仓库 与本地仓库保持同步,以及对应的用户权限.<br><br>git 支持 <span class="hljs-number">4</span> 中种协议来实现同步.<br><br>- 本地协议 **本地用**<br><br></code></pre></td></tr></tbody></table></figure>// 从一个已有仓库 clone<br>git clone ../gittest<br>Cloning into ‘gittest’…<br>done.</li></ul></li></ul><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></tbody></table></figure><p>// 将本地仓库推送到 git 项目<br>git remote add local_proj /opt/git/project.git</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">- </span>HTTP 协议 <span class="hljs-strong">**配置 HTTP 服务**</span><br><br></code></pre></td></tr></tbody></table></figure><p>$ git clone <a href="https://example.com/gitproject.git">https://example.com/gitproject.git</a></p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">- </span>SSH 协议  <span class="hljs-strong">**服务器端最简单了**</span><br><br></code></pre></td></tr></tbody></table></figure><p>git clone ssh://user@server/project.git</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">- </span>GIT 协议<br><br></code></pre></td></tr></tbody></table></figure><p>一般不用,略…</p><pre><code class="hljs">搭建方式:https://git-scm.com/book/zh/v2/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-%E5%8D%8F%E8%AE%AE建议:大型项目使用 ssh 协议;小型项目使用第三方托管.托管服务:github  oschina 国内的 github阿里云      腾讯云https://blog.csdn.net/lrcoop/article/details/88599487#### GIT CUIhttps://git-scm.com/downloads/guis</code></pre>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git基础</title>
    <link href="/2023/08/23/docs/git/git-ji-chu/"/>
    <url>/2023/08/23/docs/git/git-ji-chu/</url>
    
    <content type="html"><![CDATA[<h1 id="Git-基础"><a href="#Git-基础" class="headerlink" title="Git 基础"></a>Git 基础</h1><p>Git 是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。</p><p>Git<br>采用了分布式版本库的方式，不必服务器端软件支持，最终可以使得任何代码的提交者都可以成为“中央代码库”。Git的根本思想和基本工作原理主要是在本地复制一个“代码库”，每次提交的代码均是推送到本地代码库中，节约了由于网络带宽所带来的限制，不至于出现提交一次代码要等待很久的情况。另一方面，一旦中央代码库的服务器出现“崩溃”，那么任何“本地库”均可以还原中央代码库。</p><h1 id="Git-安装配置"><a href="#Git-安装配置" class="headerlink" title="Git 安装配置"></a>Git 安装配置</h1><p>在使用Git前我们需要先安装 Git。Git 目前支持 Linux/Unix、Solaris、Mac和 Windows 平台上运行。</p><p>Git 各平台安装包下载地址为：<a href="http://git-scm.com/downloads">http://git-scm.com/downloads</a></p><h2 id="Windows-平台上安装"><a href="#Windows-平台上安装" class="headerlink" title="Windows 平台上安装."></a>Windows 平台上安装.</h2><p>安装包下载地址：<a href="http://git-scm.com/download/win">http://git-scm.com/download/win</a></p><p>下载完成根据引导安装即可，安装选项根据需求选择，大部分安装选项保持默认的即可</p><h1 id="Git-配置"><a href="#Git-配置" class="headerlink" title="Git 配置"></a>Git 配置</h1><p>Git 仓库中有个 config 文件，专门用来配置或读取相应的工作环境变量，目录是当前仓库下 .git\config 文件。</p><p>在 Windows 一般都是C:\Users\userName\ .gitconfig</p><h2 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h2><p>配置个人的用户名称和电子邮件地址：</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">$ git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">"name"</span><br>$ git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.email</span> test@mail.com<br></code></pre></td></tr></tbody></table></figure><p>如果用了 <strong>–global</strong> 选项，那么更改的配置文件就是全局文件，以后你所有的项目都会默认使用这里配置的用户信息。</p><p>如果要在某个特定的项目中使用其他名字或者电邮，只要去掉 –global 选项重新配置即可，新的设定保存在当前项目的 .git/config<br>文件里。</p><h2 id="查看配置信息"><a href="#查看配置信息" class="headerlink" title="查看配置信息"></a>查看配置信息</h2><p>要检查已有的配置信息，可以使用 git config –list 命令：</p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">$ git <span class="hljs-built_in">config</span> <span class="hljs-comment">--list</span><br></code></pre></td></tr></tbody></table></figure><h1 id="Git-工作流程"><a href="#Git-工作流程" class="headerlink" title="Git 工作流程"></a>Git 工作流程</h1><p>一般工作流程如下：</p><ul><li>克隆 Git 资源作为工作目录。</li><li>在克隆的资源上添加或修改文件。</li><li>如果其他人修改了，你可以更新资源。</li><li>在提交前查看修改。</li><li>提交修改。</li><li>在修改完成后，如果发现错误，可以撤回提交并再次修改并提交。</li></ul><p>下图展示了 Git 的工作流程：</p><p><img src="https://www.runoob.com/wp-content/uploads/2015/02/git-process.png" alt="img"></p><h1 id="Git-创建仓库"><a href="#Git-创建仓库" class="headerlink" title="Git 创建仓库"></a>Git 创建仓库</h1><h2 id="git-init"><a href="#git-init" class="headerlink" title="git init"></a>git init</h2><p>Git 使用 <strong>git init</strong> 命令来初始化一个 Git 仓库，Git 的很多命令都需要在 Git 的仓库中运行，所以 <strong>git init</strong> 是使用 Git<br>的第一个命令。</p><p>在执行完成 <strong>git init</strong> 命令后，Git 仓库会生成一个 .git 目录，该目录包含了资源的所有元数据，其他的项目目录保持不变。</p><p>使用当前目录作为Git仓库，我们只需使它初始化。</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">git <span class="hljs-keyword">init</span><br></code></pre></td></tr></tbody></table></figure><p>该命令执行完后会在当前目录生成一个 .git 目录。</p><p>使用我们指定目录作为Git仓库。</p><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">git <span class="hljs-keyword">init</span> newrepo<br></code></pre></td></tr></tbody></table></figure><p>如果当前目录下有几个文件想要纳入版本控制，需要先用 git add 命令告诉 Git 开始对这些文件进行跟踪，然后提交：</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ git <span class="hljs-built_in">add</span> *.java<br>$ git <span class="hljs-built_in">add</span> README<br>$ git commit -m <span class="hljs-string">'初始化项目版本'</span><br></code></pre></td></tr></tbody></table></figure><p>以上命令将目录下以 .java结尾及 README 文件提交到仓库中。</p><h2 id="git-clone"><a href="#git-clone" class="headerlink" title="git clone"></a>git clone</h2><p>我们使用 <strong>git clone</strong> 从现有 Git 仓库中拷贝项目。</p><p>克隆仓库的命令格式为：</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">&lt;repo</span>&gt;<br></code></pre></td></tr></tbody></table></figure><p>如果我们需要克隆到指定的目录，可以使用以下命令格式：</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">&lt;repo</span>&gt; <span class="hljs-tag">&lt;directory&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>比如，要克隆 MPU_MVS_25A1 项目：</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ git <span class="hljs-keyword">clone</span> <span class="hljs-title">git</span>@codeup.aliyun.com:<span class="hljs-number">5</span>ee35787f0e06f96cfd22c79/MVS/MPU_MVS_25A1.git<br></code></pre></td></tr></tbody></table></figure><p>执行该命令后，会在当前目录下创建一个名为 MPU_MVS_25A1 的目录，其中包含一个 .git 的目录，用于保存下载下来的所有版本记录。</p><p>如果要自己定义要新建的项目目录名称，可以在上面的命令末尾指定新的名字：</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ git <span class="hljs-keyword">clone</span> <span class="hljs-title">git</span>@codeup.aliyun.com:<span class="hljs-number">5</span>ee35787f0e06f96cfd22c79/MVS/MPU_MVS_25A1.git MPU_MVS_25A1_RENAME<br></code></pre></td></tr></tbody></table></figure><h1 id="Git-基本操作"><a href="#Git-基本操作" class="headerlink" title="Git 基本操作"></a>Git 基本操作</h1><p>Git 常用的是以下 6 个命令：<strong>git clone</strong>、<strong>git push</strong>、<strong>git add</strong> 、<strong>git commit</strong>、<strong>git checkout</strong>、<strong>git pull</strong>。</p><p><img src="https://www.runoob.com/wp-content/uploads/2015/02/git-command.jpg" alt="img"></p><p><strong>说明：</strong></p><ul><li>workspace：工作区</li><li>staging area：暂存区/缓存区</li><li>local repository：版本库或本地仓库</li><li>remote repository：远程仓库</li></ul><p>一个简单的操作步骤：</p><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>git init    <br><span class="hljs-variable">$ </span>git add .    <br><span class="hljs-variable">$ </span>git commit  <br></code></pre></td></tr></tbody></table></figure><ul><li>git init - 初始化仓库。</li><li>git add . - 添加文件到暂存区。</li><li>git commit - 将暂存区内容添加到仓库中</li></ul><h2 id="提交与修改"><a href="#提交与修改" class="headerlink" title="提交与修改"></a>提交与修改</h2><p>Git 的工作就是创建和保存你的项目的快照及与之后的快照进行对比。</p><p>下表列出了有关创建与提交你的项目的快照的命令：</p><table><thead><tr><th align="left">命令</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>git add</code></td><td align="left">添加文件到仓库</td></tr><tr><td align="left"><code>git status</code></td><td align="left">查看仓库当前的状态，显示有变更的文件。</td></tr><tr><td align="left"><code>git diff</code></td><td align="left">比较文件的不同，即暂存区和工作区的差异。</td></tr><tr><td align="left"><code>git commit</code></td><td align="left">提交暂存区到本地仓库。</td></tr><tr><td align="left"><code>git reset</code></td><td align="left">回退版本。</td></tr><tr><td align="left"><code>git rm</code></td><td align="left">删除工作区文件。</td></tr><tr><td align="left"><code>git mv</code></td><td align="left">移动或重命名工作区文件。</td></tr></tbody></table><h2 id="提交日志"><a href="#提交日志" class="headerlink" title="提交日志"></a>提交日志</h2><table><thead><tr><th align="left">命令</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>git log</code></td><td align="left">查看历史提交记录</td></tr><tr><td align="left"><code>git blame &lt;file&gt;</code></td><td align="left">以列表形式查看指定文件的历史修改记录</td></tr></tbody></table><h2 id="远程操作"><a href="#远程操作" class="headerlink" title="远程操作"></a>远程操作</h2><table><thead><tr><th align="left">命令</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>git remote</code></td><td align="left">远程仓库操作</td></tr><tr><td align="left"><code>git fetch</code></td><td align="left">从远程获取代码库</td></tr><tr><td align="left"><code>git pull</code></td><td align="left">下载远程代码并合并</td></tr><tr><td align="left"><code>git push</code></td><td align="left">上传远程代码并合并</td></tr></tbody></table><h1 id="Git-分支管理"><a href="#Git-分支管理" class="headerlink" title="Git 分支管理"></a>Git 分支管理</h1><p>几乎每一种版本控制系统都以某种形式支持分支。使用分支意味着你可以从开发主线上分离开来，然后在不影响主线的同时继续工作。</p><p>创建分支命令：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">git <span class="hljs-title function_">branch</span> <span class="hljs-params">(branchname)</span><br></code></pre></td></tr></tbody></table></figure><p>切换分支命令:</p><figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">git checkout <span class="hljs-comment">(branchname)</span><br></code></pre></td></tr></tbody></table></figure><p>当你切换分支的时候，Git 会用该分支的最后提交的快照替换你的工作目录的内容， 所以多个分支不需要多个目录。</p><p>合并分支命令:</p><figure class="highlight cos"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">git <span class="hljs-keyword">merge</span> <br></code></pre></td></tr></tbody></table></figure><p>你可以多次合并到统一分支， 也可以选择在合并之后直接删除被并入的分支。</p><p>开始前我们先创建一个测试目录：</p><figure class="highlight maxima"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs maxima">$ <span class="hljs-built_in">mkdir</span> gitdemo<br>$ cd gitdemo/<br>$ git init<br>Initialized empty Git repository...<br>$ touch README<br>$ git add README<br>$ git commit -m '第一次版本提交'<br>[master (root-commit) <span class="hljs-number">3b58100</span>] 第一次版本提交<br> <span class="hljs-number">1</span> file changed, <span class="hljs-number">0</span> insertions(+), <span class="hljs-number">0</span> deletions(-)<br> create mode <span class="hljs-number">100644</span> README<br></code></pre></td></tr></tbody></table></figure><hr><h2 id="Git-分支管理-1"><a href="#Git-分支管理-1" class="headerlink" title="Git 分支管理"></a>Git 分支管理</h2><h3 id="列出分支"><a href="#列出分支" class="headerlink" title="列出分支"></a>列出分支</h3><p>列出分支基本命令：</p><figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git branch</span><br></code></pre></td></tr></tbody></table></figure><p>没有参数时，<strong>git branch</strong> 会列出你在本地的分支。</p><figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span> git branch<br><span class="hljs-comment">* master</span><br></code></pre></td></tr></tbody></table></figure><p>此例的意思就是，我们有一个叫做 <strong>master</strong> 的分支，并且该分支是当前分支。</p><p>当你执行 <strong>git init</strong> 的时候，默认情况下 Git 就会为你创建 <strong>master</strong> 分支。</p><p>如果我们要手动创建一个分支。执行 <strong>git branch (branchname)</strong> 即可。</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ git branch testing<br>$ git branch<br>* <span class="hljs-keyword">master</span><br>  <span class="hljs-title">testing</span><br></code></pre></td></tr></tbody></table></figure><p>现在我们可以看到，有了一个新分支 <strong>testing</strong>。</p><p>当你以此方式在上次提交更新之后创建了新分支，如果后来又有更新提交， 然后又切换到了 <strong>testing</strong> 分支，Git<br>将还原你的工作目录到你创建分支时候的样子。</p><p>接下来演示如何切换分支，我们用 git checkout (branch) 切换到我们要修改的分支。</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">ls</span><br>README<br><span class="hljs-variable">$</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">'runoob.com'</span> &gt; test.txt<br><span class="hljs-variable">$</span> git add .<br><span class="hljs-variable">$</span> git commit <span class="hljs-literal">-m</span> <span class="hljs-string">'add test.txt'</span><br>[<span class="hljs-type">master</span> <span class="hljs-number">3</span><span class="hljs-type">e92c19</span>] add test.txt<br> <span class="hljs-number">1</span> file changed, <span class="hljs-number">1</span> insertion(+)<br> create mode <span class="hljs-number">100644</span> test.txt<br><span class="hljs-variable">$</span> <span class="hljs-built_in">ls</span><br>README        test.txt<br><span class="hljs-variable">$</span> git checkout testing<br>Switched to branch <span class="hljs-string">'testing'</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">ls</span><br>README<br></code></pre></td></tr></tbody></table></figure><p>当我们切换到 <strong>testing</strong> 分支的时候，我们添加的新文件 test.txt 被移除了。切换回 <strong>master</strong> 分支的时候，它们又重新出现了。</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ git checkout <span class="hljs-keyword">master</span><br><span class="hljs-title">Switched</span> to branch '<span class="hljs-literal">master</span>'<br>$ ls<br>README        test.txt<br></code></pre></td></tr></tbody></table></figure><p>我们也可以使用 git checkout -b (branchname) 命令来创建新分支并立即切换到该分支下，从而在该分支中操作。</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs haxe">$ git checkout -b <span class="hljs-keyword">new</span><span class="hljs-type">test</span><br>Switched to a <span class="hljs-keyword">new</span> <span class="hljs-type">branch</span> <span class="hljs-string">'newtest'</span><br>$ git rm test.txt <br>rm <span class="hljs-string">'test.txt'</span><br>$ ls<br>README<br>$ touch <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt<br>$ git add .<br>$ git commit -am <span class="hljs-string">'removed test.txt、add newText.txt'</span><br>[<span class="hljs-keyword">new</span><span class="hljs-type">test</span> c1501a2] removed test.txt、add <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt<br> <span class="hljs-number">2</span> files changed, <span class="hljs-number">1</span> deletion(-)<br> create mode <span class="hljs-number">100644</span> <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt<br> delete mode <span class="hljs-number">100644</span> test.txt<br>$ ls<br>README        <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt<br>$ git checkout master<br>Switched to branch <span class="hljs-string">'master'</span><br>$ ls<br>README        test.txt<br></code></pre></td></tr></tbody></table></figure><p>如你所见，我们创建了一个分支，在该分支的上移除了一些文件 test.txt，并添加了 newText.txt 文件，然后切换回我们的主分支，删除的<br>test.txt 文件又回来了，且新增加的 newText.txt不存在主分支中。</p><p>使用分支将工作切分开来，从而让我们能够在不同开发环境中做事，并来回切换。</p><h3 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h3><p>删除分支命令：</p><figure class="highlight lisp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">git branch -d (<span class="hljs-name">branchname</span>)<br></code></pre></td></tr></tbody></table></figure><p>例如我们要删除 testing 分支：</p><figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span> git branch<br><span class="hljs-comment">* master</span><br>  testing<br><span class="hljs-symbol">$</span> git branch -d testing<br>Deleted branch testing (was <span class="hljs-number">85</span>fc7e7).<br><span class="hljs-symbol">$</span> git branch<br><span class="hljs-comment">* master</span><br></code></pre></td></tr></tbody></table></figure><h3 id="分支合并"><a href="#分支合并" class="headerlink" title="分支合并"></a>分支合并</h3><p>某分支的独立内容，你希望将它合并回到你的主分支。 你可以使用以 <code>git merge </code>命令将任何分支合并到当前分支中去：</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs haxe">$ git branch<br>* master<br>  <span class="hljs-keyword">new</span><span class="hljs-type">test</span><br>$ ls<br>README        test.txt<br>$ git merge <span class="hljs-keyword">new</span><span class="hljs-type">test</span><br>Updating <span class="hljs-number">3e92</span>c19..c1501a2<br>Fast-forward<br> <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt  | <span class="hljs-number">0</span><br> test.txt   | <span class="hljs-number">1</span> -<br> <span class="hljs-number">2</span> files changed, <span class="hljs-number">1</span> deletion(-)<br> create mode <span class="hljs-number">100644</span> <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt <br> delete mode <span class="hljs-number">100644</span> test.txt<br>$ ls<br>README        <span class="hljs-keyword">new</span><span class="hljs-type">Text</span>.txt<br></code></pre></td></tr></tbody></table></figure><p>以上实例中我们将 newtest 分支合并到主分支去，test.txt 文件被删除。</p><p>合并完后就可以删除分支:</p><figure class="highlight haxe"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haxe">$ git branch -d <span class="hljs-keyword">new</span><span class="hljs-type">test</span><br>Deleted branch <span class="hljs-keyword">new</span><span class="hljs-type">test</span> (was c1501a2).<br></code></pre></td></tr></tbody></table></figure><p>删除后， 就只剩下 master 分支了：</p><figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span> git branch<br><span class="hljs-comment">* master</span><br></code></pre></td></tr></tbody></table></figure><h3 id="合并冲突"><a href="#合并冲突" class="headerlink" title="合并冲突"></a>合并冲突</h3><p>合并并不仅仅是简单的文件添加、移除的操作，Git 也会合并文件的修改。</p><p>执行合并操作时，两个分支中的文件都有修改时，git合并时也会将文件合并，但是如果两个分支都修改了同一个文件的同一部分，那么合并时就很有可能会发生冲突，因为它无法判断哪一个修改是需要的。</p><p>比如master分支中 test.txt 文件第一行文本是“11111”，test分支中test.txt 文件第一行文本是“test”，这时在test分支上将master分支合并过来便会冲突。</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">$ git merge master<br><span class="hljs-keyword">CONFLICT</span> (<span class="hljs-keyword">add</span>/<span class="hljs-keyword">add</span>): Merge <span class="hljs-keyword">conflict</span> <span class="hljs-keyword">in</span> test.txt<br>Auto-merging test.txt<br>Automatic merge failed; fix conflicts <span class="hljs-keyword">and</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">commit</span> the result.<br></code></pre></td></tr></tbody></table></figure><p>这时候我们就需要自己合并冲突的文件了，打开冲突的文件：</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br><span class="hljs-section">test</span><br><span class="hljs-section">=======</span><br>11111<br>&gt;&gt;&gt;&gt;&gt;&gt;&gt; master<br></code></pre></td></tr></tbody></table></figure><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt;  到 ======= 之间的部分是当前的修改，======= 到 &gt;&gt;&gt;&gt;&gt;&gt;&gt;之间的部分是传入的修改，此时就需要我们自己判断需要哪一个修改，修改完成，删除这三段标记，然后保存文件。</p><p>比如我们只保留master分支传进来的修改，则把文件内容改成这样:</p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">11111<br></code></pre></td></tr></tbody></table></figure><p>保存文件后，可以用 <code>git add</code> 来告诉Git文件冲突已经解决，然后再提交：</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">git <span class="hljs-keyword">add</span> test.text<br>git <span class="hljs-keyword">commit</span><br></code></pre></td></tr></tbody></table></figure><p>也可以使用其他工具来处理合并冲突，比如电脑里如果装了VisualStudioCode的话，则可以用该程序打开冲突的文件，冲突的地方会高亮显示，而且可以快速选择合并修改的方式（使用当前修改、使用传入的修改、保留双方修改）</p><h1 id="Git-查看提交历史"><a href="#Git-查看提交历史" class="headerlink" title="Git 查看提交历史"></a>Git 查看提交历史</h1><p>Git 提交历史一般常用两个命令：</p><ul><li><p><strong>git log</strong> - 查看历史提交记录。</p></li><li><p><strong>git blame <file></file></strong> - 以列表形式查看指定文件的历史修改记录。</p></li><li><h3 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a>git log</h3></li><li><p>在使用 Git 提交了若干更新之后，又或者克隆了某个项目，想回顾下提交历史，我们可以使用 <strong>git log</strong> 命令查看。</p></li><li><p>针对我们前一章节的操作，使用 <strong>git log</strong> 命令列出历史提交记录如下：</p></li><li><pre><code class="hljs">$ git log<figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><br>- 我们可以用 <span class="hljs-comment">--oneline 选项来查看历史记录的简洁的版本。</span><br><br>- ```<br>  $ git <span class="hljs-built_in">log</span> <span class="hljs-comment">--oneline</span><br>  $ git <span class="hljs-built_in">log</span> <span class="hljs-comment">--oneline</span><br></code></pre></td></tr></tbody></table></figure></code></pre></li><li><p>你也可以用 <strong>–reverse</strong> 参数来逆向显示所有日志。</p></li><li><pre><code class="hljs">$ git log --reverse --oneline<figure class="highlight ldif"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><br><span class="hljs-literal">-</span> <span class="hljs-comment">### git blame</span><br><br><span class="hljs-literal">-</span> 如果要查看指定文件的修改记录可以使用 git blame 命令，格式如下：<br><br><span class="hljs-literal">-</span> ```<br>  git blame &lt;file&gt;<br></code></pre></td></tr></tbody></table></figure></code></pre></li><li><p>git blame 命令是以列表形式显示修改记录，如下实例：</p></li><li><pre><code class="hljs">$ git blame README<figure class="highlight livecodeserver"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><br><span class="hljs-comment"># Git 标签</span><br><br>如果你达到一个重要的阶段，并希望永远记住那个特别的提交快照，你可以使用 git tag 给它打上标签。<br><br>比如说，我们想为我们的 项目发布一个<span class="hljs-string">"1.0"</span>版本。 我们可以用 git tag -<span class="hljs-keyword">a</span> v1<span class="hljs-number">.0</span> 命令给最新一次提交打上 <span class="hljs-string">"v1.0"</span>的标签。<br><br>-<span class="hljs-keyword">a</span> 选项意为<span class="hljs-string">"创建一个带注解的标签"</span>。 不用 -<span class="hljs-keyword">a</span> 选项也可以执行的，但它不会记录这标签是啥时候打的，谁打的，也不会让你添加个标签的注解。<br><br></code></pre></td></tr></tbody></table></figure>$ git tag -a v1.0 -m '发布1.0版本'<figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns"><br>如果我们忘了给某个提交打标签，又将它发布了，我们可以给它追加标签。<br><br>例如，假设我们之前发布了提交 <span class="hljs-number">0456798</span>，但是那时候忘了给它打标签。 我们现在也可以：<br><br></code></pre></td></tr></tbody></table></figure>$ git tag -a v0.9 0456798 -m '发布0.9版本'<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs"><br>如果我们要查看所有标签可以使用以下命令：<br><br></code></pre></td></tr></tbody></table></figure>$ git tag</code></pre></li></ul><pre><code class="hljs"># Git GUIGit安装时会自带一个GUI管理软件，但是使用不是很方便，可以使用其他Git管理软件来代替，能够很大的提升工作效率SourceTree 是一个免费的Git图形化管理软件，有Windows和Mac OS的版本，下载地址：[sourcetree ](https://www.sourcetreeapp.com/)</code></pre>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git删除某个文件的所有提交记录</title>
    <link href="/2023/08/23/docs/git/git-shan-chu-mou-ge-wen-jian-de-suo-you-ti-jiao-ji-lu/"/>
    <url>/2023/08/23/docs/git/git-shan-chu-mou-ge-wen-jian-de-suo-you-ti-jiao-ji-lu/</url>
    
    <content type="html"><![CDATA[<p>Git删除某个文件的所有提交记录</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git filter-branch --index-filter <span class="hljs-string">'git rm --cached --ignore-unmatch 文件路径'</span> -- --all<br><br>git filter-branch --index-filter <span class="hljs-string">'git rm --cached --ignore-unmatch 文件路径1 文件路径2 文件路径3'</span> -- --all<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git批量修改提交记录中的作者邮箱</title>
    <link href="/2023/08/23/docs/git/git-pi-liang-xiu-gai-ti-jiao-ji-lu-zhong-de-zuo-zhe-you-xiang/"/>
    <url>/2023/08/23/docs/git/git-pi-liang-xiu-gai-ti-jiao-ji-lu-zhong-de-zuo-zhe-you-xiang/</url>
    
    <content type="html"><![CDATA[<p>批量修改Git仓库已提交的记录中的提交作者邮箱信息</p><p>执行 git log 命令，查看提交历史记录，并记住需要修改作者邮箱的提交 ID。</p><p>执行以下命令，将需要修改的提交 ID 替换为实际的值：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">git filter-branch --env-filter <span class="hljs-string">'</span><br><span class="hljs-string">OLD_EMAIL="原作者邮箱"</span><br><span class="hljs-string">CORRECT_NAME="新作者名字"</span><br><span class="hljs-string">CORRECT_EMAIL="新作者邮箱"</span><br><span class="hljs-string">if [ "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ]</span><br><span class="hljs-string">then</span><br><span class="hljs-string">    export GIT_COMMITTER_NAME="$CORRECT_NAME"</span><br><span class="hljs-string">    export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"</span><br><span class="hljs-string">fi</span><br><span class="hljs-string">if [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" ]</span><br><span class="hljs-string">then</span><br><span class="hljs-string">    export GIT_AUTHOR_NAME="$CORRECT_NAME"</span><br><span class="hljs-string">    export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"</span><br><span class="hljs-string">fi</span><br><span class="hljs-string">'</span> --tag-name-filter <span class="hljs-built_in">cat</span> -- --branches --tags<br></code></pre></td></tr></tbody></table></figure><p>该命令会将 Git 仓库中所有分支和标签下的提交历史记录中的指定作者邮箱信息修改为新的作者名字和邮箱信息。</p><p>执行命令，强制推送修改后的提交历史记录到远程仓库上。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git push --force --tags origin <span class="hljs-string">'refs/heads/*'</span> <br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git生成多个秘钥</title>
    <link href="/2023/08/23/docs/git/git-sheng-cheng-duo-ge-mi-yao/"/>
    <url>/2023/08/23/docs/git/git-sheng-cheng-duo-ge-mi-yao/</url>
    
    <content type="html"><![CDATA[<h2 id="Git配置多个SSH-Key"><a href="#Git配置多个SSH-Key" class="headerlink" title="Git配置多个SSH-Key"></a>Git配置多个SSH-Key</h2><p><a href="https://gitee.com/help/labels/19">SSH Key</a></p><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>当有多个git账号时，比如：</p><p>a. 一个gitee，用于公司内部的工作开发；</p><p>b. 一个github，用于自己进行一些开发活动；</p><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ol><li>生成一个公司用的SSH-Key</li></ol><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">$ ssh-keygen -t rsa -C <span class="hljs-string">'xxxxx@company.com'</span> -f ~<span class="hljs-regexp">/.ssh/gi</span>tee_id_rsa<br></code></pre></td></tr></tbody></table></figure><ol><li>生成一个github用的SSH-Key</li></ol><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">$ ssh-keygen -t rsa -C <span class="hljs-string">'xxxxx@qq.com'</span> -f ~<span class="hljs-regexp">/.ssh/gi</span>thub_id_rsa<br></code></pre></td></tr></tbody></table></figure><ol><li>在 ~/.ssh 目录下新建一个config文件，添加如下内容（其中Host和HostName填写git服务器的域名，IdentityFile指定私钥的路径）</li></ol><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># gitee</span><br>Host gitee.com<br>HostName gitee.com<br>PreferredAuthentications publickey<br>IdentityFile ~<span class="hljs-regexp">/.ssh/gi</span>tee_id_rsa<br><br><span class="hljs-comment"># github</span><br>Host github.com<br>HostName github.com<br>PreferredAuthentications publickey<br>IdentityFile ~<span class="hljs-regexp">/.ssh/gi</span>thub_id_rsa<br></code></pre></td></tr></tbody></table></figure><p>4.用ssh命令分别测试</p><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>ssh -T git<span class="hljs-variable">@gitee</span>.com<br><span class="hljs-variable">$ </span>ssh -T git<span class="hljs-variable">@github</span>.com<br></code></pre></td></tr></tbody></table></figure><p>这里以gitee为例，成功的话会返回下图内容</p><p><img src="https://images.gitee.com/uploads/images/2018/0921/161137_b71ef6be_967230.png" alt="输入图片说明"></p>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git换行符设置</title>
    <link href="/2023/08/23/docs/git/git-huan-xing-fu-she-zhi/"/>
    <url>/2023/08/23/docs/git/git-huan-xing-fu-she-zhi/</url>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在vim下面查看当前文本的模式类型，一般为dos,unix</span><br>:<span class="hljs-built_in">set</span> ff<br><br><span class="hljs-comment">#提交时转换为LF，检出时转换为CRLF</span><br>git config --global core.autocrlf <span class="hljs-literal">true</span>   <br><br><span class="hljs-comment">#提交时转换为LF，检出时不转换（以上问题使用此命令可解决）</span><br>git config --global core.autocrlf input   <br><br><span class="hljs-comment">#提交检出均不转换</span><br>git config --global core.autocrlf <span class="hljs-literal">false</span><br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gradle仓库源代理拦截</title>
    <link href="/2023/08/22/docs/gradle/gradle-cang-ku-yuan-dai-li-lan-jie/"/>
    <url>/2023/08/22/docs/gradle/gradle-cang-ku-yuan-dai-li-lan-jie/</url>
    
    <content type="html"><![CDATA[<p>国内访问Google、Maven仓库源速度很慢或者无法访问，导致项目一直卡在同步中，可以修改拦截仓库代理源，将其修改为国内仓库源</p><p>在用户gradle的目录下面新建一个<code>init.gradle.kts</code>的文件（如果有的话就不用新建）</p><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">~<span class="hljs-regexp">/.gradle/i</span>nit.gradle.kts<br></code></pre></td></tr></tbody></table></figure><p>将下面的内容添加到<code>init.gradle.kts</code>文件中，可以根据自己需求修改相关配置再保存</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repoMaps = mapOf(<br>    <span class="hljs-string">"ALI"</span> to mapOf(<br>        <span class="hljs-string">"https://repo.maven.apache.org/maven2"</span> to <span class="hljs-string">"https://maven.aliyun.com/repository/public/"</span>,<br>        <span class="hljs-comment">//"https://repo.maven.apache.org/maven2" to "https://maven.aliyun.com/repository/central/",</span><br>        <span class="hljs-comment">//"https://repo1.maven.org/maven2" to "https://maven.aliyun.com/repository/central/",</span><br>        <span class="hljs-string">"https://dl.google.com/dl/android/maven2"</span> to <span class="hljs-string">"https://maven.aliyun.com/repository/google/"</span>,<br>        <span class="hljs-string">"https://plugins.gradle.org/m2"</span> to <span class="hljs-string">"https://maven.aliyun.com/repository/gradle-plugin/"</span><br>    ),<br>    <span class="hljs-string">"TENCENT"</span> to mapOf(<br>        <span class="hljs-string">"https://repo.maven.apache.org/maven2"</span> to <span class="hljs-string">"https://mirrors.tencent.com/nexus/repository/maven-public/"</span>,<br>        <span class="hljs-string">"https://dl.google.com/dl/android/maven2"</span> to <span class="hljs-string">"https://mirrors.tencent.com/nexus/repository/maven-public/"</span>,<br>        <span class="hljs-string">"https://plugins.gradle.org/m2"</span> to <span class="hljs-string">"https://mirrors.tencent.com/nexus/repository/gradle-plugins/"</span><br>    ),<br>)<br><br><span class="hljs-comment">// 建议使用腾讯的仓库源，阿里的貌似不会即使更新</span><br><span class="hljs-keyword">val</span> repoMap = repoMaps[<span class="hljs-string">"TENCENT"</span>]<br><br><span class="hljs-function"><span class="hljs-keyword">fun</span> RepositoryHandler.<span class="hljs-title">enableMirror</span><span class="hljs-params">()</span></span> {<br>    all {<br>        <span class="hljs-keyword">when</span> (<span class="hljs-keyword">this</span>) {<br>            <span class="hljs-keyword">is</span> MavenArtifactRepository -&gt; {<br>                <span class="hljs-keyword">val</span> originalUrl = <span class="hljs-keyword">this</span>.url.toString().removeSuffix(<span class="hljs-string">"/"</span>)<br>                repoMap?.<span class="hljs-keyword">get</span>(originalUrl)?.also {<br>                    logger.lifecycle(<span class="hljs-string">"Repository[<span class="hljs-variable">$url</span>] is mirrored to [<span class="hljs-variable">$it</span>]"</span>)<br>                    <span class="hljs-keyword">this</span>.setUrl(it)<br>                } ?: run {<br>                    logger.lifecycle(<span class="hljs-string">"Repository[<span class="hljs-variable">$url</span>] retained"</span>)<br>                }<br>            }<br><br>            <span class="hljs-keyword">else</span> -&gt; {}<br>        }<br>    }<br>}<br><br>gradle.beforeProject {<br>    repositories.enableMirror()<br>}<br><br>gradle.beforeSettings {<br>    pluginManagement.repositories.enableMirror()<br>    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UnstableApiUsage"</span>)</span><br>    dependencyResolutionManagement.repositories.enableMirror()<br>}<br><br>gradle.allprojects {<br>    buildscript {<br>        repositories.enableMirror()<br>    }<br>    repositories.enableMirror()<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gradle编译配置优化</title>
    <link href="/2023/08/22/docs/gradle/gradle-bian-yi-you-hua/"/>
    <url>/2023/08/22/docs/gradle/gradle-bian-yi-you-hua/</url>
    
    <content type="html"><![CDATA[<p>在用户gradle的目录下面新建一个<code>gradle.properties</code>的文件（如果有的话就不用新建）</p><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">~<span class="hljs-regexp">/.gradle/g</span>radle.properties<br></code></pre></td></tr></tbody></table></figure><p>将下面的内容添加到<code>gradle.properties</code>文件中，可以根据自己需求修改相关配置再保存</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># Experiment with the JVM parallel garbage collector</span><br><span class="hljs-comment"># Increase the JVM heap size</span><br><span class="hljs-comment"># UseParallelGC</span><br><span class="hljs-attr">org.gradle.jvmargs</span>=<span class="hljs-string">-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -XX:+UseParallelGC -XX:MaxMetaspaceSize=1g</span><br><span class="hljs-comment"># 开启daemon守护进程，避免多次重复启动Gradle进程</span><br><span class="hljs-attr">org.gradle.daemon</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">org.gradle.configureondemand</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">#Gradle Daemon 守护进程将在指定的空闲毫秒数后自行终止。 默认为10800000（3 小时）。</span><br><span class="hljs-comment">#org.gradle.daemon.idletimeout=10800000</span><br><span class="hljs-comment">#开启并行编译 (编译速度提升较明显)</span><br><span class="hljs-attr">org.gradle.parallel</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">#开启并行编译线程数 (建议设置成 CPU核心数 *2)</span><br><span class="hljs-attr">org.gradle.parallel.threads</span>=<span class="hljs-string">20</span><br><span class="hljs-comment">#设置gradle编译线程 (建议设置成CPU核心数)</span><br><span class="hljs-attr">org.gradle.workers.max</span>=<span class="hljs-string">10</span><br><span class="hljs-comment"># 开启gradle缓存 (开启缓存，开启后会减少重复编译，速度可能会提升70%+，但是由于复用缓存，有的时候可能会编译出错)</span><br><span class="hljs-comment"># https://docs.gradle.org/current/userguide/build_cache.html</span><br><span class="hljs-comment">#org.gradle.caching=true</span><br><span class="hljs-comment"># 开启gradle configuration 缓存(开启后编译时间应该会小幅度提升，但是有的项目不兼容可能会编译报错)</span><br><span class="hljs-comment"># https://docs.gradle.org/current/userguide/configuration_cache.html</span><br><span class="hljs-comment"># Use this flag carefully, in case some of the plugins are not fully compatible.</span><br><span class="hljs-comment">#org.gradle.configuration-cache=true</span><br><span class="hljs-attr">org.gradle.configuration-cache.problems</span>=<span class="hljs-string">warn</span><br><span class="hljs-attr">org.gradle.configuration-cache.max-problems</span>=<span class="hljs-string">5</span><br><span class="hljs-comment"># 增量和并行编译(编译速度提升比较明显，这几个应该默认已经开启了)</span><br><span class="hljs-comment"># 开启kotlin的增量</span><br><span class="hljs-attr">kotlin.incremental</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">kotlin.incremental.java</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">kotlin.incremental.js</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">#开启kotlin并行编译</span><br><span class="hljs-attr">kotlin.parallel.tasks.in.project</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"># 开启跨模块增量编译</span><br><span class="hljs-attr">kotlin.incremental.useClasspathSnapshot</span>=<span class="hljs-string">true</span><br><span class="hljs-comment">#启用K2编译器（目前是实验阶段，启用后可能编译会有特别多警告提示）</span><br><span class="hljs-comment"># https://kotlinlang.org/docs/whatsnew-eap.html#new-kotlin-k2-compiler-updates</span><br><span class="hljs-comment">#kotlin.experimental.tryK2=true</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gradle知识点汇总</title>
    <link href="/2023/08/22/docs/gradle/gradle-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/22/docs/gradle/gradle-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<h1 id="依赖项配置"><a href="#依赖项配置" class="headerlink" title="依赖项配置"></a>依赖项配置</h1><table><thead><tr><th>配置</th><th>说明</th></tr></thead><tbody><tr><td>implementation</td><td>Gradle 会将依赖项添加到编译类路径，并将依赖项打包到编译输出。不过，当模块配置 implementation 依赖项时，其他模块只有在运行时才能使用该依赖项。</td></tr><tr><td>api</td><td>Gradle 会将依赖项添加到编译类路径和编译输出。当一个模块包含 api 依赖项时，会让 Gradle 了解该模块要以传递方式将该依赖项导出到其他模块，以便这些模块在运行时和编译时都可以使用该依赖项。</td></tr><tr><td>compileOnly</td><td>Gradle 只会将依赖项添加到编译类路径（也就是说，不会将其添加到编译输出）。</td></tr><tr><td>runtimeOnly</td><td>Gradle 只会将依赖项添加到编译输出，以便在运行时使用。也就是说，不会将其添加到编译类路径。</td></tr><tr><td>annotationProcessor</td><td>要添加对作为注解处理器的库的依赖关系，必须使用 annotationProcessor 配置将其添加到注解处理器类路径。</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gradle获取flavor</title>
    <link href="/2023/08/22/docs/gradle/gradle-huo-qu-flavor/"/>
    <url>/2023/08/22/docs/gradle/gradle-huo-qu-flavor/</url>
    
    <content type="html"><![CDATA[<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Groovy"><span class="hljs-keyword">def</span> getCurrentFlavor() {<br>    Gradle gradle = getGradle()<br>    String tskReqStr = gradle.getStartParameter().getTaskRequests().toString()<br>    Pattern pattern<br>    println(<span class="hljs-string">"tskReqStr: "</span> + tskReqStr)<br>    <span class="hljs-keyword">if</span> (tskReqStr.contains(<span class="hljs-string">"assemble"</span>)) {<br>        <span class="hljs-keyword">if</span> (tskReqStr.contains(<span class="hljs-string">"Cn"</span>) || tskReqStr.contains(<span class="hljs-string">"En"</span>))<br>            pattern = Pattern.compile(<span class="hljs-string">"assemble(\\w+)(Cn|En)(Release|Debug)"</span>)<br>        <span class="hljs-keyword">else</span><br>            pattern = Pattern.compile(<span class="hljs-string">"assemble(\\w+)(Release|Debug)"</span>)<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">if</span> (tskReqStr.contains(<span class="hljs-string">"Cn"</span>) || tskReqStr.contains(<span class="hljs-string">"En"</span>))<br>            pattern = Pattern.compile(<span class="hljs-string">"generate(\\w+)(Cn|En)(Release|Debug)"</span>)<br>        <span class="hljs-keyword">else</span><br>            pattern = Pattern.compile(<span class="hljs-string">"generate(\\w+)(Release|Debug)"</span>)<br>    }<br>    Matcher matcher = pattern.matcher(tskReqStr)<br>    <span class="hljs-keyword">if</span> (matcher.find())<br>        <span class="hljs-keyword">return</span> matcher.group(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span> {<br>        println <span class="hljs-string">"NO MATCH FOUND"</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一些常用的Gradle依赖</title>
    <link href="/2023/08/22/docs/gradle/yi-xie-chang-yong-de-gradle-yi-lai/"/>
    <url>/2023/08/22/docs/gradle/yi-xie-chang-yong-de-gradle-yi-lai/</url>
    
    <content type="html"><![CDATA[<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs Groovy"><span class="hljs-comment">//kotlin安卓扩展</span><br>apply <span class="hljs-attr">plugin:</span> <span class="hljs-string">'kotlin-android-extensions'</span><br><br><span class="hljs-comment">//Retrifot(网络请求)</span><br>implementation <span class="hljs-string">'com.squareup.retrofit2:retrofit:2.0.2'</span><br>implementation <span class="hljs-string">'com.squareup.retrofit2:converter-gson:2.0.2'</span><br>implementation <span class="hljs-string">'com.squareup.okhttp3:okhttp:3.12.1'</span><br><br><span class="hljs-comment">// CameraX</span><br><span class="hljs-keyword">def</span> camerax_version = <span class="hljs-string">"1.0.0-alpha05"</span><br><span class="hljs-comment">// CameraX view</span><br><span class="hljs-keyword">def</span> camerax_view_version = <span class="hljs-string">"1.0.0-alpha02"</span><br><span class="hljs-comment">// CameraX 扩展 library</span><br><span class="hljs-keyword">def</span> camerax_ext_version = <span class="hljs-string">"1.0.0-alpha02"</span><br>implementation <span class="hljs-string">"androidx.camera:camera-core:$camerax_version"</span><br><span class="hljs-comment">//如果你要使用Camera2的扩展功能</span><br>implementation <span class="hljs-string">"androidx.camera:camera-camera2:$camerax_version"</span><br><span class="hljs-comment">// 如果你要使用 CameraX View</span><br>implementation <span class="hljs-string">"androidx.camera:camera-view:$camerax_view_version"</span><br><span class="hljs-comment">// 如果你要使用 CameraX 的 扩展功能</span><br>implementation <span class="hljs-string">"androidx.camera:camera-extensions:$camerax_ext_version"</span><br><span class="hljs-comment">//申请权限</span><br>implementation <span class="hljs-string">'com.tbruyelle.rxpermissions2:rxpermissions:0.9.5'</span><br><br><span class="hljs-comment">//add at the end of android{} block</span><br>compileOptions {<br>    sourceCompatibility JavaVersion.VERSION_1_8<br>            targetCompatibility JavaVersion.VERSION_1_8<br>}<br><br><span class="hljs-comment">//Collection KTX</span><br>implementation <span class="hljs-string">"androidx.collection:collection-ktx:1.1.0"</span><br><br><span class="hljs-comment">//Permissionx</span><br>implementation <span class="hljs-string">'com.permissionx.guolindev:permissionx:1.3.0'</span><br>implementation <span class="hljs-string">'com.permissionx.guolindev:permission-support:1.3.0'</span><br><br><span class="hljs-comment">//协程</span><br>implementation <span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.4.1"</span><br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>踩坑：仓库中有某个库依然报错找不到某个依赖库</title>
    <link href="/2023/08/22/docs/gradle/cang-ku-zhong-you-mou-ge-ku-yi-ran-bao-cuo-zhao-bu-dao-mou-ge-yi-lai-ku/"/>
    <url>/2023/08/22/docs/gradle/cang-ku-zhong-you-mou-ge-ku-yi-ran-bao-cuo-zhao-bu-dao-mou-ge-yi-lai-ku/</url>
    
    <content type="html"><![CDATA[<p>gradle同步时提示找不到某个依赖库</p><p>先排除是不是网络有问题，或者这个库是不是真的不存在</p><p>但是大部分情况下上面这两个都是没问题的，还是会提示找不到某个依赖库，类似这样</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stata">Where:<br>    Build <span class="hljs-keyword">file</span> xxx build.gradle.kts' <span class="hljs-keyword">line</span>: 4<br><br><span class="hljs-comment">    * What went wrong:</span><br>    <span class="hljs-keyword">Plugin</span> [id:<span class="hljs-string">"xxx:"</span> x.x.x ，apply: false] was not found <span class="hljs-keyword">in</span> any of the following sources:<br>    -Gradle Core Plugins (<span class="hljs-keyword">plugin</span> is not <span class="hljs-keyword">in</span> 'org.gradle' namespace)<br>    -<span class="hljs-keyword">plugin</span> Repositories (could not resolve <span class="hljs-keyword">plugin</span> artifact xxx:x.x.x)<br>    Searched <span class="hljs-keyword">in</span> the following repositories:<br>    maven(http:<span class="hljs-comment">//xxx1/repository/maven-releases/)</span><br>    maven2(http:<span class="hljs-comment">//xxx2/repository/maven-releases/)</span><br>    Gradle Central <span class="hljs-keyword">Plugin</span> Repository<br>    Google <br>    MavenRepo<br>Try:<br>&gt; <span class="hljs-keyword">Run</span> with --stacktrace option to get the <span class="hljs-keyword">stack</span> trace .<br>&gt; <span class="hljs-keyword">Run</span> with --debug option to get <span class="hljs-keyword">more</span> <span class="hljs-keyword">log</span> output.<br>&gt; <span class="hljs-keyword">Run</span> with --scan to get full insights.<br></code></pre></td></tr></tbody></table></figure><p>这种情况可以加上<code>--info</code>之后再执行一下，看看控制台输出的具体日志，有可能会出现类似下面的内容:</p><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs subunit">...<br><br>Failed to get resource: HEAD.[HTTP HTTP/1.1 502 Bad Gateway: http://xxx2/repository/maven-releases/xxx.pom)]<br><br><span class="hljs-keyword">FAILURE: </span>Build failed with an exception.<br>...<br></code></pre></td></tr></tbody></table></figure><p>明明配置了多个仓库，但是gradle只在其中一个仓库中找不到这个依赖就直接报错停止了，没有继续从其他仓库中找。</p><p>这种情况是因为gradle下载依赖会判断 http status<br>code，正常情况下如果仓库中没有某个依赖，返回的code应该是404，这时gradle才会继续从下一个仓库中寻找，但如果仓库服务器返回了不明的code，gralde就会视为程序异常直接抛出异常提示build失败。上面这个例子就是因为这个maven2仓库返回了502的状态导致构建直接异常。</p><p>解决办法，调整gradle脚本中仓库地址的顺序，尽量将官方的仓库放到前面，将第三方仓库或者自建的maven仓库放到后面。<br>类似这样：</p><figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gradle">pluginManagement {<br>    <span class="hljs-keyword">repositories</span> {<br>        gradlePluginPortal()<br>        google()<br>        mavenCentral()<br>        maven {<br>            setUrl(<span class="hljs-string">"http://xxx1"</span>)<br>        }<br>        maven {<br>            setUrl(<span class="hljs-string">"http://xxx2"</span>)<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>如果报错不是这个原因的话，再根据实际日志信息进行排查</p>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用fat-aar 打包依赖库到aar</title>
    <link href="/2023/08/22/docs/gradle/shi-yong-fat-aar-da-bao-yi-lai-ku-dao-aar/"/>
    <url>/2023/08/22/docs/gradle/shi-yong-fat-aar-da-bao-yi-lai-ku-dao-aar/</url>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/kezong/fat-aar-android">https://github.com/kezong/fat-aar-android</a></p><p>项目根目录 <code>build.gradle</code> 添加</p><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">buildscript {<br>    repositories {<br>        maven { url <span class="hljs-string">"https://plugins.gradle.org/m2/"</span> }<br>    }<br>    dependencies {<br>        classpath <span class="hljs-string">'com.kezong:fat-aar:1.3.1'</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>module</code> 的 <code>build.gradle</code> 添加：</p><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">apply <span class="hljs-attr">plugin:</span> <span class="hljs-string">'com.kezong.fat-aar'</span><br></code></pre></td></tr></tbody></table></figure><p>使用：<br>需要打包进aar的库使用 <code>embed</code> ，而不是 <code>implementation</code></p><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">embed(<span class="hljs-attr">name:</span> <span class="hljs-string">'abcdef'</span>, <span class="hljs-attr">ext:</span> <span class="hljs-string">'aar'</span>)<br>embed(<span class="hljs-string">'com.abc.abc:abc:1.2.3'</span>)<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用git版本号控制</title>
    <link href="/2023/08/22/docs/gradle/shi-yong-git-ban-ben-hao-kong-zhi/"/>
    <url>/2023/08/22/docs/gradle/shi-yong-git-ban-ben-hao-kong-zhi/</url>
    
    <content type="html"><![CDATA[<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">defaultConfig {<br>        minSdkVersion minVersion<br>        targetSdkVersion versionTarget<br>        versionCode git_commit_count()<br>        versionName <span class="hljs-string">"2.1."</span><br><br><br><span class="hljs-keyword">def</span> gitId = git_commit_shortid()<br>        buildConfigField <span class="hljs-string">'String'</span>, <span class="hljs-string">'COMMIT_ID'</span>, <span class="hljs-string">"\"$gitId\""</span><br>}<br><br> buildTypes {<br>    release {<br>       versionNameSuffix formatedDate() + <span class="hljs-string">"."</span> + git_commit_shortid()<br>    }<br>}<br><br><br><span class="hljs-keyword">def</span> git_commit_count() {<br>    description <span class="hljs-string">'Get git revision number.'</span><br>    <span class="hljs-keyword">new</span> ByteArrayOutputStream().withStream { os -&gt;<br>        <span class="hljs-keyword">def</span> result = exec {<br>            executable = <span class="hljs-string">'git'</span><br>            args = [<span class="hljs-string">'rev-list'</span>, <span class="hljs-string">'--all'</span>,<span class="hljs-string">'--count'</span>]<br>            standardOutput = os<br>        }<br>        String revision = os.toString().trim()<br>        <span class="hljs-keyword">return</span> Integer.parseInt(revision) + <span class="hljs-number">5900</span><br>    }<br>}<br><br><span class="hljs-keyword">def</span> formatedDate() {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Date().format(<span class="hljs-string">"YYMMdd"</span>)<br>}<br><br><br><span class="hljs-keyword">def</span> git_commit_shortid() {<br>    <span class="hljs-keyword">new</span> ByteArrayOutputStream().withStream { os -&gt;<br>        <span class="hljs-keyword">def</span> result = exec {<br>            executable = <span class="hljs-string">'git'</span><br>            args = [<span class="hljs-string">'rev-parse'</span>, <span class="hljs-string">'--short'</span>,<span class="hljs-string">'HEAD'</span>]<br>            standardOutput = os<br>        }<br>        String commit_id = os.toString().trim()<br>        <span class="hljs-keyword">return</span> commit_id<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>根据flavor设置不同启动页面</title>
    <link href="/2023/08/22/docs/gradle/gen-ju-flavor-she-zhi-bu-tong-qi-dong-ye-mian/"/>
    <url>/2023/08/22/docs/gradle/gen-ju-flavor-she-zhi-bu-tong-qi-dong-ye-mian/</url>
    
    <content type="html"><![CDATA[<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">defaultConfig {<br>    <span class="hljs-comment">//......</span><br>    <span class="hljs-comment">// 先在默认配置中定义两个变量main_activity_key和oem_main_activity_key，并赋初始值</span><br>    manifestPlaceholders += [<span class="hljs-attr">main_activity_key    :</span> <span class="hljs-string">"android.intent.action.MAIN"</span>,<br>                             <span class="hljs-symbol">oem_main_activity_key:</span> <span class="hljs-string">"android.intent.action.NO_MAIN"</span>]<br><br>    <span class="hljs-comment">//不能单独写两个manifestPlaceholders，必须是一个数组，不然编译通不过</span><br><br>    <span class="hljs-comment">//......</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">productFlavors {<br>    OemA {<br>        buildConfigField <span class="hljs-string">"int"</span>, <span class="hljs-string">"oem_type"</span>, <span class="hljs-string">"0"</span><br>    }<br>    OemB {<br>        buildConfigField <span class="hljs-string">"int"</span>, <span class="hljs-string">"oem_type"</span>, <span class="hljs-string">"0"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Groovy"><span class="hljs-comment">// 遍历OEM版本，在目标客户中根据需要替换main_activity_key和oem_main_activity_key的值</span><br>productFlavors.all { flavor -&gt;<br>    <span class="hljs-keyword">if</span> (flavor.name.contains(<span class="hljs-string">"OemA"</span>)) {<br>        flavor.manifestPlaceholders = [<span class="hljs-attr">main_activity_key    :</span><br>                                               <span class="hljs-string">"androidintent.action.NO_MAIN"</span>,<br>                                       <span class="hljs-symbol">oem_main_activity_key:</span> <span class="hljs-string">"android.intent.action.MAIN"</span>]<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flavor.name.contains(<span class="hljs-string">"OemB"</span>)) {<br>        flavor.manifestPlaceholders = [<span class="hljs-attr">main_activity_key    :</span> <span class="hljs-string">"android.intent.action.MAIN"</span>,<br>                                       <span class="hljs-symbol">oem_main_activity_key:</span> <span class="hljs-string">"android.intent.action.NO_MAIN"</span>]<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>然后在Manifest中修改两个Activity的action属性</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".ui.activity.OemAActivity"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:excludeFromRecents</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">"singleInstance"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:screenOrientation</span>=<span class="hljs-string">"landscape"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@android:style/Theme.NoTitleBar.Fullscreen"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"${oem_main_activity_key}"</span>/&gt;</span><br>        // 修改属性<br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.LAUNCHER"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".ui.activity.OemBActivity"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:excludeFromRecents</span>=<span class="hljs-string">"true"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">"singleInstance"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:screenOrientation</span>=<span class="hljs-string">"landscape"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@android:style/Theme.NoTitleBar.Fullscreen"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"${main_activity_key}"</span>/&gt;</span><br>        // 修改属性<br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.LAUNCHER"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Gradle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Gradle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java知识点汇总</title>
    <link href="/2023/08/21/docs/java/java-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/21/docs/java/java-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#jvm">JVM</a><ul><li><a href="#jvm-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">JVM 工作流程</a></li><li><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BAruntime-data-area">运行时数据区（Runtime Data Area）</a><ul><li><a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8">程序计数器</a></li><li><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88">Java 虚拟机栈</a></li><li><a href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88">本地方法栈</a></li><li><a href="#java-%E5%A0%86">Java 堆</a></li><li><a href="#%E6%96%B9%E6%B3%95%E5%8C%BA">方法区</a></li></ul></li><li><a href="#%E6%96%B9%E6%B3%95%E6%8C%87%E4%BB%A4">方法指令</a></li><li><a href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">类加载器</a></li><li><a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-gc">垃圾回收 gc</a><ul><li><a href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E6%B4%BB%E5%88%A4%E6%96%AD">对象存活判断</a></li><li><a href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95">垃圾收集算法</a></li><li><a href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8">垃圾收集器</a></li><li><a href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5">内存模型与回收策略</a></li></ul></li></ul></li><li><a href="#object">Object</a><ul><li><a href="#equals-%E6%96%B9%E6%B3%95">equals 方法</a></li><li><a href="#hashcode-%E6%96%B9%E6%B3%95">hashCode 方法</a></li></ul></li><li><a href="#static">static</a></li><li><a href="#final">final</a></li><li><a href="#stringstringbufferstringbuilder">String、StringBuffer、StringBuilder</a></li><li><a href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">异常处理</a></li><li><a href="#%E5%86%85%E9%83%A8%E7%B1%BB">内部类</a><ul><li><a href="#%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB">匿名内部类</a></li></ul></li><li><a href="#%E5%A4%9A%E6%80%81">多态</a></li><li><a href="#%E6%8A%BD%E8%B1%A1%E5%92%8C%E6%8E%A5%E5%8F%A3">抽象和接口</a></li><li><a href="#%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6">集合框架</a><ul><li><a href="#hashmap">HashMap</a><ul><li><a href="#%E7%BB%93%E6%9E%84%E5%9B%BE">结构图</a></li><li><a href="#hashmap-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">HashMap 的工作原理</a></li><li><a href="#hashmap-%E4%B8%8E-hashtable-%E5%AF%B9%E6%AF%94">HashMap 与 HashTable 对比</a></li></ul></li><li><a href="#concurrenthashmap">ConcurrentHashMap</a><ul><li><a href="#base-17">Base 1.7</a></li><li><a href="#base-18">Base 1.8</a></li></ul></li><li><a href="#arraylist">ArrayList</a></li><li><a href="#linkedlist">LinkedList</a></li><li><a href="#copyonwritearraylist">CopyOnWriteArrayList</a></li></ul></li><li><a href="#%E5%8F%8D%E5%B0%84">反射</a></li><li><a href="#%E5%8D%95%E4%BE%8B">单例</a><ul><li><a href="#%E9%A5%BF%E6%B1%89%E5%BC%8F">饿汉式</a></li><li><a href="#%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%BC%8F">双重检查模式</a></li><li><a href="#%E9%9D%99%E6%80%81%E5%86%85%E9%83%A8%E7%B1%BB%E6%A8%A1%E5%BC%8F">静态内部类模式</a></li></ul></li><li><a href="#%E7%BA%BF%E7%A8%8B">线程</a><ul><li><a href="#%E5%B1%9E%E6%80%A7">属性</a></li><li><a href="#%E7%8A%B6%E6%80%81">状态</a></li><li><a href="#%E7%8A%B6%E6%80%81%E6%8E%A7%E5%88%B6">状态控制</a></li></ul></li><li><a href="#volatile">volatile</a></li><li><a href="#synchronized">synchronized</a><ul><li><a href="#%E6%A0%B9%E6%8D%AE%E8%8E%B7%E5%8F%96%E7%9A%84%E9%94%81%E5%88%86%E7%B1%BB">根据获取的锁分类</a></li><li><a href="#%E5%8E%9F%E7%90%86">原理</a></li></ul></li><li><a href="#lock">Lock</a><ul><li><a href="#%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB">锁的分类</a><ul><li><a href="#%E6%82%B2%E8%A7%82%E9%94%81%E4%B9%90%E8%A7%82%E9%94%81">悲观锁、乐观锁</a></li><li><a href="#%E8%87%AA%E6%97%8B%E9%94%81%E9%80%82%E5%BA%94%E6%80%A7%E8%87%AA%E6%97%8B%E9%94%81">自旋锁、适应性自旋锁</a></li><li><a href="#%E6%AD%BB%E9%94%81">死锁</a></li></ul></li></ul></li><li><a href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B">引用类型</a></li><li><a href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">动态代理</a></li><li><a href="#%E5%85%83%E6%B3%A8%E8%A7%A3">元注解</a></li></ul><h1 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h1><h2 id="JVM-工作流程"><a href="#JVM-工作流程" class="headerlink" title="JVM 工作流程"></a>JVM 工作流程</h2><p><img src="https://user-gold-cdn.xitu.io/2019/6/23/16b833f4a4906226?w=448&amp;h=592&amp;f=jpeg&amp;s=44057"></p><h2 id="运行时数据区（Runtime-Data-Area）"><a href="#运行时数据区（Runtime-Data-Area）" class="headerlink" title="运行时数据区（Runtime Data Area）"></a>运行时数据区（Runtime Data Area）</h2><p><img src="https://user-gold-cdn.xitu.io/2019/6/23/16b833f4a499f6fe?w=868&amp;h=497&amp;f=webp&amp;s=46378"></p><h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p><strong>程序计数器（Program Counter Register）</strong> 是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。</p><p>字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。</p><p>由于 Java 虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的，*<br>*在任何一个确定的时刻，一个处理器（对于多核处理器来说是一个内核）都只会执行一条线程中的指令**。</p><p>因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。</p><ul><li>如果线程正在执行的是一个 Java 方法，这个计数器记录的是正在执行的<strong>虚拟机字节码指令的地址</strong>。</li><li>如果线程正在执行的是一个 Native 方法，这个计数器值则为空（Undefined）。</li></ul><p><strong>此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</strong></p><h3 id="Java-虚拟机栈"><a href="#Java-虚拟机栈" class="headerlink" title="Java 虚拟机栈"></a>Java 虚拟机栈</h3><p><strong>Java 虚拟机栈（Java Virtual Machine Stacks</strong>）也是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是 Java<br>方法执行的内存模型，每个方法在执行的同时都会创建一个<strong>栈帧（Stack Frame）</strong> 用于存储**局部变量表、操作数栈、动态链接、方法出口<br>**等消息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。</p><p><strong>局部变量表</strong><br>存放了编译器可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference类型，它不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置）和<br>returnAddress 类型（指向了一条字节码指令的地址）。</p><p>其中 64 位长度的 long 和 double<br>类型的数据会占用两个局部变量空间（Slot），其余的数据类型只占用一个。局部变量表所需的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。</p><p>在 Java 虚拟机规范中，对这个区域规定了两种异常状态：</p><ul><li>如果线程请求的栈深度大于虚拟机所允许的的深度，将抛出 <strong>StackOverflowError</strong> 异常。</li><li>如果虚拟机栈可以动态扩展（当前大部分的Java虚拟机都可动态扩展，只不过Java虚拟机规范中也允许固定长度的虚拟机栈），如果扩展时无法申请到足够的内存，就会抛出<br><strong>OutOfMemoryError</strong> 异常。</li></ul><h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p><strong>本地方法栈（Native Method Stack）</strong> 与虚拟机栈所发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则为虚拟机使用到的Native方法服务。</p><p>在虚拟机规范中对本地方法栈中方法使用的语言、使用方式与数据结构并没有强制规定，因此具体的虚拟机可以自由实现它。甚至有的虚拟机（例如：Sun<br>HotSpot虚拟机）直接就把虚拟机栈和本地方法栈合二为一。与虚拟机栈一样，本地方法栈区域也会抛出 StackOverflowError 和<br>OutOfMemoryError 异常。</p><h3 id="Java-堆"><a href="#Java-堆" class="headerlink" title="Java 堆"></a>Java 堆</h3><p>对于大多数应用来说，<strong>Java 堆（Java Heap）</strong> 是 Java 虚拟机所管理的的内存中最大的一块。Java<br>堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。</p><p>Java堆是垃圾收集器管理的主要区域，从内存回收的角度来看，由于现在收集器基本采用分代收集算法，所以Java堆中还可以细分为：新生代和老年代；再细致一点的有<br>Eden 空间、From Survivor 空间、To Survivor 空间等。</p><p>从内存分配的角度来看，线程共享的Java堆中可能划分出多个线程私有的分配缓冲区（Thread Local Allocation<br>Buffer，TLAB）。不过无论如何划分，都与存放内容无关，无论哪个区域，存储的仍然是对象实例，进一步划分的目的是为了更好地回收内存，或者更快地分配内存。</p><h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p><strong>方法区（Method Area</strong>）与 Java 堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。</p><p><strong>运行时常量池（Runtime Constant Pool）</strong> 是方法区的一部分。Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是<br><strong>常量池（Constant Pool Table）</strong>，用于存放编译器生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。</p><p>既然运行时常量池是方法区的一部分，自然受到方法区内存的限制，当常量池无法再申请到内存时就会抛出 OutOfMemoryError 异常。</p><h2 id="方法指令"><a href="#方法指令" class="headerlink" title="方法指令"></a>方法指令</h2><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>invokeinterface</td><td>用以调用接口方法</td></tr><tr><td>invokevirtual</td><td>指令用于调用对象的实例方法</td></tr><tr><td>invokestatic</td><td>用以调用类/静态方法</td></tr><tr><td>invokespecial</td><td>用于调用一些需要特殊处理的实例方法，包括实例初始化方法、私有方法和父类方法</td></tr></tbody></table><h2 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h2><table><thead><tr><th>类加载器</th><th>说明</th></tr></thead><tbody><tr><td>BootstrapClassLoader</td><td>Bootstrap 类加载器负责加载 rt.jar 中的 JDK 类文件，它是所有类加载器的父加载器。Bootstrap 类加载器没有任何父类加载器，如果你调用 String.class.getClassLoader()，会返回 null，任何基于此的代码会抛出 NUllPointerException 异常。Bootstrap 加载器被称为初始类加载器</td></tr><tr><td>ExtClassLoader</td><td>而 Extension 将加载类的请求先委托给它的父加载器，也就是Bootstrap，如果没有成功加载的话，再从 jre/lib/ext 目录下或者 java.ext.dirs 系统属性定义的目录下加载类。Extension 加载器由 sun.misc.Launcher$ExtClassLoader 实现</td></tr><tr><td>AppClassLoader</td><td>第三种默认的加载器就是 System 类加载器（又叫作 Application 类加载器）了。它负责从 classpath 环境变量中加载某些应用相关的类，classpath 环境变量通常由 -classpath 或 -cp 命令行选项来定义，或者是 JAR 中的 Manifest 的 classpath 属性。Application 类加载器是 Extension 类加载器的子加载器</td></tr></tbody></table><table><thead><tr><th>工作原理</th><th>说明</th></tr></thead><tbody><tr><td>委托机制</td><td>加载任务委托交给父类加载器，如果不行就向下传递委托任务，由其子类加载器加载，保证 java 核心库的安全性</td></tr><tr><td>可见性机制</td><td>子类加载器可以看到父类加载器加载的类，而反之则不行</td></tr><tr><td>单一性机制</td><td>父加载器加载过的类不能被子加载器加载第二次</td></tr></tbody></table><h2 id="垃圾回收-gc"><a href="#垃圾回收-gc" class="headerlink" title="垃圾回收 gc"></a>垃圾回收 gc</h2><h3 id="对象存活判断"><a href="#对象存活判断" class="headerlink" title="对象存活判断"></a>对象存活判断</h3><ul><li><strong>引用计数</strong></li></ul><p>每个对象有一个引用计数属性，新增一个引用时计数加1，引用释放时计数减1，计数为0时可以回收。此方法简单，无法解决对象相互循环引用的问题。</p><ul><li><strong>可达性分析</strong></li></ul><p>从 GC Roots 开始向下搜索，搜索所走过的路径称为引用链。当一个对象到 GC Roots 没有任何引用链相连时，则证明此对象是不可用的。不可达对象。</p><blockquote><p>在Java语言中，GC Roots包括：</p><ul><li>虚拟机栈中引用的对象。</li><li>方法区中类静态属性实体引用的对象。</li><li>方法区中常量引用的对象。</li><li>本地方法栈中 JNI 引用的对象。</li></ul></blockquote><h3 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h3><ul><li><strong>标记 -清除算法</strong></li></ul><p>“标记-清除”（Mark-Sweep）算法，如它的名字一样，算法分为“标记”和“清除”两个阶段：首先标记出所有需要回收的对象，在标记完成后统一回收掉所有被标记的对象。之所以说它是最基础的收集算法，是因为后续的收集算法都是基于这种思路并对其缺点进行改进而得到的。</p><p>它的主要缺点有两个：一个是效率问题，标记和清除过程的效率都不高；另外一个是空间问题，标记清除之后会产生大量不连续的内存碎片，空间碎片太多可能会导致，当程序在以后的运行过程中需要分配较大对象时无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作。</p><ul><li><strong>复制算法</strong></li></ul><p>“复制”（Copying）的收集算法，它将可用内存按容量划分为大小相等的两块，每次只使用其中的一块。当这一块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。</p><p>这样使得每次都是对其中的一块进行内存回收，内存分配时也就不用考虑内存碎片等复杂情况，只要移动堆顶指针，按顺序分配内存即可，实现简单，运行高效。只是这种算法的代价是将内存缩小为原来的一半，持续复制长生存期的对象则导致效率降低。</p><ul><li><strong>标记-整理算法</strong></li></ul><p>复制收集算法在对象存活率较高时就要执行较多的复制操作，效率将会变低。更关键的是，如果不想浪费50%的空间，就需要有额外的空间进行分配担保，以应对被使用的内存中所有对象都100%存活的极端情况，所以在老年代一般不能直接选用这种算法。</p><p>根据老年代的特点，有人提出了另外一种“标记-整理”（Mark-Compact）算法，标记过程仍然与“标记-清除”算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存。</p><ul><li><strong>分代收集算法</strong></li></ul><p>GC 分代的基本假设：绝大部分对象的生命周期都非常短暂，存活时间短。</p><p>“分代收集”（Generational<br>Collection）算法，把Java堆分为新生代和老年代，这样就可以根据各个年代的特点采用最适当的收集算法。在新生代中，每次垃圾收集时都发现有大批对象死去，只有少量存活，那就选用复制算法，只需要付出少量存活对象的复制成本就可以完成收集。而老年代中因为对象存活率高、没有额外空间对它进行分配担保，就必须使用“标记-清理”或“标记-整理”算法来进行回收。</p><h3 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h3><ul><li><strong>CMS收集器</strong></li></ul><blockquote><p>CMS（Concurrent Mark Sweep）收集器是一种以获取最短回收停顿时间为目标的收集器。目前很大一部分的 Java<br>应用都集中在互联网站或B/S系统的服务端上，这类应用尤其重视服务的响应速度，希望系统停顿时间最短，以给用户带来较好的体验。</p></blockquote><p>从名字（包含“Mark Sweep”）上就可以看出CMS收集器是基于“标记-清除”算法实现的，它的运作过程相对于前面几种收集器来说要更复杂一些，整个过程分为4个步骤，包括：</p><ul><li>初始标记（CMS initial mark）</li><li>并发标记（CMS concurrent mark）</li><li>重新标记（CMS remark）</li><li>并发清除（CMS concurrent sweep）</li></ul><p>其中初始标记、重新标记这两个步骤仍然需要“Stop The World”。初始标记仅仅只是标记一下GC Roots能直接关联到的对象，速度很快，并发标记阶段就是进行GC<br>Roots Tracing的过程，而重新标记阶段则是为了修正并发标记期间，因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间一般会比初始标记阶段稍长一些，但远比并发标记的时间短。</p><p>由于整个过程中耗时最长的并发标记和并发清除过程中，收集器线程都可以与用户线程一起工作，所以总体上来说，CMS收集器的内存回收过程是与用户线程一起并发地执行。老年代收集器（新生代使用ParNew）</p><ul><li><strong>G1收集器</strong></li></ul><p>与CMS收集器相比G1收集器有以下特点：</p><p>1、空间整合，G1收集器采用标记整理算法，不会产生内存空间碎片。分配大对象时不会因为无法找到连续空间而提前触发下一次GC。</p><p>2、可预测停顿，这是G1的另一大优势，降低停顿时间是G1和CMS的共同关注点，但G1除了追求低停顿外，还能建立可预测的停顿时间模型，能让使用者明确指定在一个长度为N毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒，这几乎已经是实时<br>Java（RTSJ）的垃圾收集器的特征了。</p><p>使用G1收集器时，Java堆的内存布局与其他收集器有很大差别，它将整个Java堆划分为多个大小相等的独立区域（Region），虽然还保留有新生代和老年代的概念，但新生代和老年代不再是物理隔阂了，它们都是一部分（可以不连续）Region<br>的集合。</p><p>G1的新生代收集跟 ParNew 类似，当新生代占用达到一定比例的时候，开始出发收集。和 CMS 类似，G1 收集器收集老年代对象会有短暂停顿。</p><h3 id="内存模型与回收策略"><a href="#内存模型与回收策略" class="headerlink" title="内存模型与回收策略"></a>内存模型与回收策略</h3><p><img src="https://mmbiz.qpic.cn/mmbiz_png/qdzZBE73hWsbhfAng9ibqfcbjrqgyRWqAKiaJ2U75SGYwQhs2tuNbXtu8KIpaUsBOaHRKXf7esuuFoMjELFxibIVg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>Java 堆（Java Heap）是JVM所管理的内存中最大的一块，堆又是垃圾收集器管理的主要区域，Java 堆主要分为2个区域-年轻代与老年代，其中年轻代又分<br>Eden 区和 Survivor 区，其中 Survivor 区又分 From 和 To 2个区。</p><ul><li><strong>Eden 区</strong></li></ul><p>大多数情况下，对象会在新生代 Eden 区中进行分配，当 Eden 区没有足够空间进行分配时，虚拟机会发起一次 Minor GC，Minor GC 相比<br>Major GC 更频繁，回收速度也更快。<br>通过 Minor GC 之后，Eden 会被清空，Eden 区中绝大部分对象会被回收，而那些无需回收的存活对象，将会进到 Survivor 的 From 区（若<br>From 区不够，则直接进入 Old 区）。</p><ul><li><strong>Survivor 区</strong></li></ul><p>Survivor 区相当于是 Eden 区和 Old 区的一个缓冲，类似于我们交通灯中的黄灯。Survivor 又分为2个区，一个是 From 区，一个是 To<br>区。每次执行 Minor GC，会将 Eden 区和 From 存活的对象放到 Survivor 的 To 区（如果 To 区不够，则直接进入 Old 区）。Survivor<br>的存在意义就是减少被送到老年代的对象，进而减少 Major GC 的发生。Survivor 的预筛选保证，只有经历16次 Minor GC<br>还能在新生代中存活的对象，才会被送到老年代。</p><ul><li><strong>Old 区</strong></li></ul><p>老年代占据着2/3的堆内存空间，只有在 Major GC 的时候才会进行清理，每次 GC 都会触发“Stop-The-World”。内存越大，STW<br>的时间也越长，所以内存也不仅仅是越大就越好。由于复制算法在对象存活率较高的老年代会进行很多次的复制操作，效率很低，所以老年代这里采用的是标记——整理算法。</p><h1 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h1><h2 id="equals-方法"><a href="#equals-方法" class="headerlink" title="equals 方法"></a>equals 方法</h2><p>对两个对象的地址值进行的比较（即比较引用是否相同）</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object obj)</span>{<br>        <span class="hljs-keyword">return</span>(<span class="hljs-built_in">this</span>==obj);<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="hashCode-方法"><a href="#hashCode-方法" class="headerlink" title="hashCode 方法"></a>hashCode 方法</h2><p>hashCode() 方法给对象返回一个 hash code 值。这个方法被用于 hash tables，例如 HashMap。</p><p>它的性质是：</p><ul><li><p>在一个Java应用的执行期间，如果一个对象提供给 equals 做比较的信息没有被修改的话，该对象多次调用 hashCode()<br>方法，该方法必须始终如一返回同一个 integer。</p></li><li><p>如果两个对象根据 equals(Object) 方法是相等的，那么调用二者各自的 hashCode() 方法必须产生同一个 integer 结果。</p></li><li><p>并不要求根据 equals(Object) 方法不相等的两个对象，调用二者各自的 hashCode() 方法必须产生不同的 integer<br>结果。然而，程序员应该意识到对于不同的对象产生不同的 integer 结果，有可能会提高 hash table 的性能。</p></li></ul><p>在 JDK 中，Object 的 hashcode 方法是本地方法，也就是用 c 语言或 c++ 实现的，该方法直接返回对象的 内存地址。在 String 类，重写了<br>hashCode 方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span>{<br>        <span class="hljs-type">int</span> h=hash;<br>        <span class="hljs-keyword">if</span>(h==<span class="hljs-number">0</span>&amp;&amp;value.length&gt;<span class="hljs-number">0</span>){<br>        <span class="hljs-type">char</span> val[]=value;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;value.length;i++){<br>        h=<span class="hljs-number">31</span>*h+val[i];<br>        }<br>        hash=h;<br>        }<br>        <span class="hljs-keyword">return</span> h;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="static"><a href="#static" class="headerlink" title="static"></a>static</h1><ul><li>static关键字修饰的方法或者变量不需要依赖于对象来进行访问，只要类被加载了，就可以通过类名去进行访问。</li><li>静态变量被所有的对象所共享，在内存中只有一个副本，它当且仅当在类初次加载时会被初始化。</li><li>能通过 this 访问静态成员变量吗?<br>所有的静态方法和静态变量都可以通过对象访问（只要访问权限足够）。</li><li>static是不允许用来修饰局部变量</li></ul><h1 id="final"><a href="#final" class="headerlink" title="final"></a>final</h1><ul><li>可以声明成员变量、方法、类以及本地变量</li><li>final 成员变量必须在声明的时候初始化或者在构造器中初始化，否则就会报编译错误</li><li>final 变量是只读的</li><li>final 申明的方法不可以被子类的方法重写</li><li>final 类通常功能是完整的，不能被继承</li><li>final 变量可以安全的在多线程环境下进行共享，而不需要额外的同步开销</li><li>final 关键字提高了性能，JVM 和 Java 应用都会缓存 final 变量，会对方法、变量及类进行优化</li><li>方法的内部类访问方法中的局部变量，但必须用 final 修饰才能访问</li></ul><h1 id="String、StringBuffer、StringBuilder"><a href="#String、StringBuffer、StringBuilder" class="headerlink" title="String、StringBuffer、StringBuilder"></a>String、StringBuffer、StringBuilder</h1><ul><li>String 是 final 类，不能被继承。对于已经存在的 Stirng 对象，修改它的值，就是重新创建一个对象</li><li>StringBuffer 是一个类似于 String 的字符串缓冲区，使用 append() 方法修改 Stringbuffer 的值，使用 toString()<br>方法转换为字符串，是线程安全的</li><li>StringBuilder 用来替代于 StringBuffer，StringBuilder 是非线程安全的，速度更快</li></ul><h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><ul><li>Exception、Error 是 Throwable 类的子类</li><li>Error 类对象由 Java 虚拟机生成并抛出，不可捕捉</li><li>不管有没有异常，finally 中的代码都会执行</li><li>当 try、catch 中有 return 时，finally 中的代码依然会继续执行</li></ul><table><thead><tr><th>常见的Error</th><th></th><th></th></tr></thead><tbody><tr><td>OutOfMemoryError</td><td>StackOverflowError</td><td>NoClassDeffoundError</td></tr></tbody></table><table><thead><tr><th>常见的Exception</th><th></th><th></th></tr></thead><tbody><tr><td>常见的非检查性异常</td><td></td><td></td></tr><tr><td>ArithmeticException</td><td>ArrayIndexOutOfBoundsException</td><td>ClassCastException</td></tr><tr><td>IllegalArgumentException</td><td>IndexOutOfBoundsException</td><td>NullPointerException</td></tr><tr><td>NumberFormatException</td><td>SecurityException</td><td>UnsupportedOperationException</td></tr><tr><td>常见的检查性异常</td><td></td><td></td></tr><tr><td>IOException</td><td>CloneNotSupportedException</td><td>IllegalAccessException</td></tr><tr><td>NoSuchFieldException</td><td>NoSuchMethodException</td><td>FileNotFoundException</td></tr></tbody></table><h1 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h1><ul><li>非静态内部类没法在外部类的静态方法中实例化。</li><li>非静态内部类的方法可以直接访问外部类的所有数据，包括私有的数据。</li><li>在静态内部类中调用外部类成员，成员也要求用 static 修饰。</li><li>创建静态内部类的对象可以直接通过外部类调用静态内部类的构造器；创建非静态的内部类的对象必须先创建外部类的对象，通过外部类的对象调用内部类的构造器。</li></ul><h2 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h2><ul><li>匿名内部类不能定义任何静态成员、方法</li><li>匿名内部类中的方法不能是抽象的</li><li>匿名内部类必须实现接口或抽象父类的所有抽象方法</li><li>匿名内部类不能定义构造器</li><li>匿名内部类访问的外部类成员变量或成员方法必须用 final 修饰</li></ul><h1 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h1><ul><li>父类的引用可以指向子类的对象</li><li>创建子类对象时，调用的方法为子类重写的方法或者继承的方法</li><li>如果我们在子类中编写一个独有的方法，此时就不能通过父类的引用创建的子类对象来调用该方法</li></ul><h1 id="抽象和接口"><a href="#抽象和接口" class="headerlink" title="抽象和接口"></a>抽象和接口</h1><ul><li>抽象类不能有对象（不能用 new 关键字来创建抽象类的对象）</li><li>抽象类中的抽象方法必须在子类中被重写</li><li>接口中的所有属性默认为：public static final ****；</li><li>接口中的所有方法默认为：public abstract ****；</li></ul><h1 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h1><p><img src="https://user-gold-cdn.xitu.io/2019/6/23/16b833f4a86db5e6?w=643&amp;h=611&amp;f=gif&amp;s=22445"></p><ul><li>List接口存储一组不唯一，有序（插入顺序）的对象, Set接口存储一组唯一，无序的对象。</li></ul><h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><h3 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h3><ul><li><strong>JDK 1.7 HashMap 结构图</strong></li></ul><p><img src="https://user-gold-cdn.xitu.io/2019/6/23/16b833f4ac8f44fd?w=1636&amp;h=742&amp;f=png&amp;s=88323"></p><ul><li><strong>JDK 1.8 HashMap 结构图</strong></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/7/23/164c47f32f9650ba?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p><h3 id="HashMap-的工作原理"><a href="#HashMap-的工作原理" class="headerlink" title="HashMap 的工作原理"></a>HashMap 的工作原理</h3><p>HashMap 基于 hashing 原理，我们通过 put() 和 get() 方法储存和获取对象。当我们将键值对传递给 put() 方法时，它调用键对象的<br>hashCode() 方法来计算 hashcode，让后找到 bucket 位置来储存 Entry 对象。当两个对象的 hashcode 相同时，它们的 bucket<br>位置相同，‘碰撞’会发生。因为 HashMap 使用链表存储对象，这个 Entry 会存储在链表中，当获取对象时，通过键对象的 equals()<br>方法找到正确的键值对，然后返回值对象。</p><p><strong>如果 HashMap 的大小超过了负载因子(load factor)定义的容量，怎么办？</strong><br>默认的负载因子大小为 0.75，也就是说，当一个 map 填满了 75% 的 bucket 时候，和其它集合类(如 ArrayList 等)一样，将会创建原来<br>HashMap 大小的两倍的 bucket 数组，来重新调整 map 的大小，并将原来的对象放入新的 bucket 数组中。这个过程叫作 rehashing，因为它调用<br>hash 方法找到新的 bucket 位置。</p><p><strong>为什么 String, Interger 这样的 wrapper 类适合作为键?</strong><br>因为 String 是不可变的，也是 final 的，而且已经重写了 equals() 和 hashCode() 方法了。其他的 wrapper<br>类也有这个特点。不可变性是必要的，因为为了要计算 hashCode()，就要防止键值改变，如果键值在放入时和获取时返回不同的 hashcode<br>的话，那么就不能从 HashMap 中找到你想要的对象。不可变性还有其他的优点如线程安全。如果你可以仅仅通过将某个 field 声明成<br>final 就能保证 hashCode 是不变的，那么请这么做吧。因为获取对象的时候要用到 equals() 和 hashCode()<br>方法，那么键对象正确的重写这两个方法是非常重要的。如果两个不相等的对象返回不同的 hashcode 的话，那么碰撞的几率就会小些，这样就能提高<br>HashMap 的性能。</p><h3 id="HashMap-与-HashTable-对比"><a href="#HashMap-与-HashTable-对比" class="headerlink" title="HashMap 与 HashTable 对比"></a>HashMap 与 HashTable 对比</h3><p>HashMap 是非 synchronized 的，性能更好，HashMap 可以接受为 null 的 key-value，而 Hashtable 是线程安全的，比 HashMap 要慢，不接受<br>null 的 key-value。</p><p><code>HashMap.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable {<br>    ···<br><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    }<br>    ···<br><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {<br>        Node&lt;K,V&gt; e;<br>        <span class="hljs-keyword">return</span> (e = getNode(hash(key), key)) == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : e.value;<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>HashTable.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hashtable</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Dictionary</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;, Cloneable, java.io.Serializable {<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {<br>        <span class="hljs-comment">// Make sure the value is not null</span><br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        }<br><br>        ···<br>        addEntry(hash, key, value, index);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br>    ···<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {<br>        HashtableEntry&lt;?,?&gt; tab[] = table;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>        <span class="hljs-keyword">for</span> (HashtableEntry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) {<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) {<br>                <span class="hljs-keyword">return</span> (V)e.value;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><h3 id="Base-1-7"><a href="#Base-1-7" class="headerlink" title="Base 1.7"></a>Base 1.7</h3><p>ConcurrentHashMap 最外层不是一个大的数组，而是一个 Segment 的数组。每个 Segment 包含一个与 HashMap 数据结构差不多的链表数组。</p><p><img src="http://www.jasongj.com/img/java/concurrenthashmap/concurrenthashmap_java7.png"></p><p>在读写某个 Key 时，先取该 Key 的哈希值。并将哈希值的高 N 位对 Segment 个数取模从而得到该 Key 应该属于哪个Segment，接着如同操作<br>HashMap 一样操作这个 Segment。</p><p>Segment 继承自 ReentrantLock，可以很方便的对每一个 Segmen 上锁。</p><p>对于读操作，获取 Key 所在的 Segment<br>时，需要保证可见性。具体实现上可以使用volatile关键字，也可使用锁。但使用锁开销太大，而使用volatile时每次写操作都会让所有CPU内缓存无效，也有一定开销。ConcurrentHashMap<br>使用如下方法保证可见性，取得最新的Segment：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Segment&lt;K, V&gt; s=(Segment&lt;K, V&gt;)UNSAFE.getObjectVolatile(segments,u)<br></code></pre></td></tr></tbody></table></figure><p>获取 Segment 中的 HashEntry 时也使用了类似方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">HashEntry&lt;K, V&gt; e=(HashEntry&lt;K, V&gt;)UNSAFE.getObjectVolatile<br>        (tab,((<span class="hljs-type">long</span>)(((tab.length-<span class="hljs-number">1</span>)&amp;h))&lt;&lt;TSHIFT)+TBASE)<br></code></pre></td></tr></tbody></table></figure><p>对于写操作，并不要求同时获取所有 Segment 的锁，因为那样相当于锁住了整个Map。它会先获取该 Key-Value 对所在的 Segment<br>的锁，获取成功后就可以像操作一个普通的 HashMap 一样操作该 Segment，并保证该 Segment 的安全性。同时由于其它 Segment<br>的锁并未被获取，因此理论上可支持 concurrencyLevel（等于Segment的个数）个线程安全的并发读写。</p><p>获取锁时，并不直接使用 lock 来获取，因为该方法获取锁失败时会挂起。事实上，它使用了自旋锁，如果 tryLock<br>获取锁失败，说明锁被其它线程占用，此时通过循环再次以 tryLock 的方式申请锁。如果在循环过程中该 Key 所对应的链表头被修改，则重置<br>retry 次数。如果 retry 次数超过一定值，则使用 lock 方法申请锁。</p><p>这里使用自旋锁是因为自旋锁的效率比较高，但是它消耗 CPU 资源比较多，因此在自旋次数超过阈值时切换为互斥锁。</p><h3 id="Base-1-8"><a href="#Base-1-8" class="headerlink" title="Base 1.8"></a>Base 1.8</h3><p>1.7 已经解决了并发问题，并且能支持 N 个 Segment 这么多次数的并发，但依然存在 HashMap 在 1.7 版本中的问题：查询遍历链表效率太低。因此<br>1.8 做了一些数据结构上的调整。</p><p><img src="https://user-gold-cdn.xitu.io/2018/7/23/164c47f3756eb206?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"></p><p>其中抛弃了原有的 Segment 分段锁，而采用了 CAS + synchronized 来保证并发安全性。</p><p><code>ConcurrentHashMap.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key,V value,<span class="hljs-type">boolean</span> onlyIfAbsent)</span>{<br>        <span class="hljs-keyword">if</span>(key==<span class="hljs-literal">null</span>||value==<span class="hljs-literal">null</span>)<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-type">int</span> hash=spread(key.hashCode());<br>        <span class="hljs-type">int</span> binCount=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(Node&lt;K, V&gt;[]tab=table;;){<br>        Node&lt;K, V&gt; f;<span class="hljs-type">int</span> n,i,fh;<br>        <span class="hljs-keyword">if</span>(tab==<span class="hljs-literal">null</span>||(n=tab.length)==<span class="hljs-number">0</span>)<br>        tab=initTable();<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((f=tabAt(tab,i=(n-<span class="hljs-number">1</span>)&amp;hash))==<span class="hljs-literal">null</span>){<br>        <span class="hljs-keyword">if</span>(casTabAt(tab,i,<span class="hljs-literal">null</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K, V&gt;(hash,key,value,<span class="hljs-literal">null</span>)))<br>        <span class="hljs-keyword">break</span>;                   <span class="hljs-comment">// no lock when adding to empty bin</span><br>        }<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((fh=f.hash)==MOVED)<br>        tab=helpTransfer(tab,f);<br>        <span class="hljs-keyword">else</span>{<br>        V oldVal=<span class="hljs-literal">null</span>;<br><span class="hljs-keyword">synchronized</span> (f){<br>        <span class="hljs-keyword">if</span>(tabAt(tab,i)==f){<br>        <span class="hljs-keyword">if</span>(fh&gt;=<span class="hljs-number">0</span>){<br>        binCount=<span class="hljs-number">1</span>;<br>        ···<br>        }<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(f <span class="hljs-keyword">instanceof</span> TreeBin){<br>        ···<br>        }<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(f <span class="hljs-keyword">instanceof</span> ReservationNode)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Recursive update"</span>);<br>        }<br>        }<br>        ···<br>        }<br>        addCount(<span class="hljs-number">1L</span>,binCount);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><p>ArrayList 本质上是一个动态数组，第一次添加元素时，数组大小将变化为 DEFAULT_CAPACITY<br>10，不断添加元素后，会进行扩容。删除元素时，会按照位置关系把数组元素整体（复制）移动一遍。</p><p><code>ArrayList.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayList</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractList</span>&lt;E&gt;<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable<br>    ···<br><br><span class="hljs-comment">// 增加元素</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span>{<br>        ensureCapacityInternal(size+<span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>        elementData[size++]=e;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br>        ···<br><br><span class="hljs-comment">// 删除元素</span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>{<br>        <span class="hljs-keyword">if</span>(index&gt;=size)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(outOfBoundsMsg(index));<br><br>        modCount++;<br>        E oldValue=(E)elementData[index];<br><br>        <span class="hljs-type">int</span> numMoved=size-index-<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span>(numMoved&gt;<span class="hljs-number">0</span>)<br>        System.arraycopy(elementData,index+<span class="hljs-number">1</span>,elementData,index,<br>        numMoved);<br>        elementData[--size]=<span class="hljs-literal">null</span>; <span class="hljs-comment">// clear to let GC do its work</span><br><br>        <span class="hljs-keyword">return</span> oldValue;<br>        }<br>        ···<br><br><span class="hljs-comment">// 查找元素</span><br><span class="hljs-keyword">public</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>{<br>        <span class="hljs-keyword">if</span>(index&gt;=size)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(outOfBoundsMsg(index));<br><br>        <span class="hljs-keyword">return</span>(E)elementData[index];<br>        }<br>        ···<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><p>LinkedList 本质上是一个双向链表的存储结构。</p><p><code>LinkedList.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedList</span>&lt;E&gt;<br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSequentialList</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt;, Deque&lt;E&gt;, Cloneable, java.io.Serializable<br>{<br>    ····<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; {<br>        E item;<br>        Node&lt;E&gt; next;<br>        Node&lt;E&gt; prev;<br><br>        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) {<br>            <span class="hljs-built_in">this</span>.item = element;<br>            <span class="hljs-built_in">this</span>.next = next;<br>            <span class="hljs-built_in">this</span>.prev = prev;<br>        }<br>    }<br>    ···<br>    <br>    <span class="hljs-comment">// 增加元素</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkLast</span><span class="hljs-params">(E e)</span> {<br>        <span class="hljs-keyword">final</span> Node&lt;E&gt; l = last;<br>        <span class="hljs-keyword">final</span> Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(l, e, <span class="hljs-literal">null</span>);<br>        last = newNode;<br>        <span class="hljs-keyword">if</span> (l == <span class="hljs-literal">null</span>)<br>            first = newNode;<br>        <span class="hljs-keyword">else</span><br>            l.next = newNode;<br>        size++;<br>        modCount++;<br>    }<br>    ···<br><br>    <span class="hljs-comment">// 删除元素</span><br>    E <span class="hljs-title function_">unlink</span><span class="hljs-params">(Node&lt;E&gt; x)</span> {<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">E</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> x.item;<br>        <span class="hljs-keyword">final</span> Node&lt;E&gt; next = x.next;<br>        <span class="hljs-keyword">final</span> Node&lt;E&gt; prev = x.prev;<br><br>        <span class="hljs-keyword">if</span> (prev == <span class="hljs-literal">null</span>) {<br>            first = next;<br>        } <span class="hljs-keyword">else</span> {<br>            prev.next = next;<br>            x.prev = <span class="hljs-literal">null</span>;<br>        }<br><br>        <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>) {<br>            last = prev;<br>        } <span class="hljs-keyword">else</span> {<br>            next.prev = prev;<br>            x.next = <span class="hljs-literal">null</span>;<br>        }<br><br>        x.item = <span class="hljs-literal">null</span>;<br>        size--;<br>        modCount++;<br>        <span class="hljs-keyword">return</span> element;<br>    }<br>    ···<br><br>    <span class="hljs-comment">// 查找元素</span><br>    Node&lt;E&gt; <span class="hljs-title function_">node</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {<br>        <span class="hljs-comment">// assert isElementIndex(index);</span><br><br>        <span class="hljs-keyword">if</span> (index &lt; (size &gt;&gt; <span class="hljs-number">1</span>)) {<br>            Node&lt;E&gt; x = first;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; index; i++)<br>                x = x.next;<br>            <span class="hljs-keyword">return</span> x;<br>        } <span class="hljs-keyword">else</span> {<br>            Node&lt;E&gt; x = last;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size - <span class="hljs-number">1</span>; i &gt; index; i--)<br>                x = x.prev;<br>            <span class="hljs-keyword">return</span> x;<br>        }<br>    }<br>    ···<br>}<br></code></pre></td></tr></tbody></table></figure><p>对于元素查询来说，ArrayList 优于 LinkedList，因为 LinkedList 要移动指针。对于新增和删除操作，LinedList 比较占优势，因为<br>ArrayList 要移动数据。</p><h2 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h2><p>CopyOnWriteArrayList 是线程安全容器(相对于 ArrayList)，增加删除等写操作通过加锁的形式保证数据一致性，通过复制新集合的方式解决遍历迭代的问题。</p><p><code>CopyOnWriteArrayList.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable {<br> <br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    ···<br><br>    <span class="hljs-comment">// 增加元素</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {<br>        <span class="hljs-keyword">synchronized</span> (lock) {<br>            Object[] elements = getArray();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> elements.length;<br>            Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);<br>            newElements[len] = e;<br>            setArray(newElements);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        }<br>    }<br>    ···<br><br>    <span class="hljs-comment">// 删除元素</span><br>    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {<br>        <span class="hljs-keyword">synchronized</span> (lock) {<br>            Object[] elements = getArray();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> elements.length;<br>            <span class="hljs-type">E</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> get(elements, index);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">numMoved</span> <span class="hljs-operator">=</span> len - index - <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (numMoved == <span class="hljs-number">0</span>)<br>                setArray(Arrays.copyOf(elements, len - <span class="hljs-number">1</span>));<br>            <span class="hljs-keyword">else</span> {<br>                Object[] newElements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[len - <span class="hljs-number">1</span>];<br>                System.arraycopy(elements, <span class="hljs-number">0</span>, newElements, <span class="hljs-number">0</span>, index);<br>                System.arraycopy(elements, index + <span class="hljs-number">1</span>, newElements, index,<br>                                 numMoved);<br>                setArray(newElements);<br>            }<br>            <span class="hljs-keyword">return</span> oldValue;<br>        }<br>    }<br>    ···<br>    <br>    <span class="hljs-comment">// 查找元素</span><br>    <span class="hljs-keyword">private</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(Object[] a, <span class="hljs-type">int</span> index)</span> {<br>        <span class="hljs-keyword">return</span> (E) a[index];<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>{<br>        Class cls=Class.forName(<span class="hljs-string">"com.jasonwu.Test"</span>);<br>        <span class="hljs-comment">//获取构造方法</span><br>        Constructor[]publicConstructors=cls.getConstructors();<br>        <span class="hljs-comment">//获取全部构造方法</span><br>        Constructor[]declaredConstructors=cls.getDeclaredConstructors();<br>        <span class="hljs-comment">//获取公开方法</span><br>        Method[]methods=cls.getMethods();<br>        <span class="hljs-comment">//获取全部方法</span><br>        Method[]declaredMethods=cls.getDeclaredMethods();<br>        <span class="hljs-comment">//获取公开属性</span><br>        Field[]publicFields=cls.getFields();<br>        <span class="hljs-comment">//获取全部属性</span><br>        Field[]declaredFields=cls.getDeclaredFields();<br>        Object clsObject=cls.newInstance();<br>        Method method=cls.getDeclaredMethod(<span class="hljs-string">"getModule1Functionality"</span>);<br>        Object object=method.invoke(<span class="hljs-literal">null</span>);<br>        }<span class="hljs-keyword">catch</span>(ClassNotFoundException e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">catch</span>(IllegalAccessException e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">catch</span>(InstantiationException e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">catch</span>(NoSuchMethodException e){<br>        e.printStackTrace();<br>        }<span class="hljs-keyword">catch</span>(InvocationTargetException e){<br>        e.printStackTrace();<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="单例"><a href="#单例" class="headerlink" title="单例"></a>单例</h1><h2 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomManager</span> {<br>    <span class="hljs-keyword">private</span> Context mContext;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CustomManager mInstance;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CustomManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-keyword">synchronized</span> (mLock) {<br>            <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) {<br>                mInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomManager</span>(context);<br>            }<br><br>            <span class="hljs-keyword">return</span> mInstance;<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CustomManager</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-built_in">this</span>.mContext = context.getApplicationContext();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="双重检查模式"><a href="#双重检查模式" class="headerlink" title="双重检查模式"></a>双重检查模式</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomManager</span> {<br>    <span class="hljs-keyword">private</span> Context mContext;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> CustomManager mInstance;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CustomManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-comment">// 避免非必要加锁</span><br>        <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) {<br>            <span class="hljs-keyword">synchronized</span> (CustomManger.class) {<br>                <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-literal">null</span>) {<br>                    mInstacne = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomManager</span>(context);<br>                }<br>            }<br>        }<br><br>        <span class="hljs-keyword">return</span> mInstacne;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CustomManager</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-built_in">this</span>.mContext = context.getApplicationContext();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="静态内部类模式"><a href="#静态内部类模式" class="headerlink" title="静态内部类模式"></a>静态内部类模式</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomManager</span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CustomManager</span><span class="hljs-params">()</span>{}<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomManagerHolder</span> {<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CustomManager</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomManager</span>();<br>    }<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CustomManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> CustomManagerHolder.INSTANCE;<br>    } <br>}<br></code></pre></td></tr></tbody></table></figure><p>静态内部类的原理是：</p><p>当 SingleTon 第一次被加载时，并不需要去加载 SingleTonHoler，只有当 getInstance() 方法第一次被调用时，才会去初始化<br>INSTANCE，这种方法不仅能确保线程安全，也能保证单例的唯一性，同时也延迟了单例的实例化。getInstance 方法并没有多次去 new<br>对象，取的都是同一个 INSTANCE 对象。</p><p>虚拟机会保证一个类的 <code>&lt;clinit&gt;()</code><br>方法在多线程环境中被正确地加锁、同步，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的 <code>&lt;clinit&gt;()</code><br>方法，其他线程都需要阻塞等待，直到活动线程执行 <code>&lt;clinit&gt;()</code> 方法完毕</p><p>缺点在于无法传递参数，如Context等</p><h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><p>线程是进程中可独立执行的最小单位，也是 CPU 资源（时间片）分配的基本单位。同一个进程中的线程可以共享进程中的资源，如内存空间和文件句柄。</p><h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>线程 id 用于标识不同的线程。编号可能被后续创建的线程使用。编号是只读属性，不能修改</td></tr><tr><td>name</td><td>名字的默认值是 Thread-(id)</td></tr><tr><td>daemon</td><td>分为守护线程和用户线程，我们可以通过 setDaemon(true) 把线程设置为守护线程。守护线程通常用于执行不重要的任务，比如监控其他线程的运行情况，GC 线程就是一个守护线程。setDaemon() 要在线程启动前设置，否则 JVM 会抛出非法线程状态异常，可被继承。</td></tr><tr><td>priority</td><td>线程调度器会根据这个值来决定优先运行哪个线程（不保证），优先级的取值范围为 1~10，默认值是 5，可被继承。Thread 中定义了下面三个优先级常量：<br>- 最低优先级：MIN_PRIORITY = 1<br>- 默认优先级：NORM_PRIORITY = 5<br>- 最高优先级：MAX_PRIORITY = 10</td></tr></tbody></table><h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p><img src="https://pic2.zhimg.com/80/v2-326a2be9b86b1446d75b6f52f54c98fb_hd.jpg"></p><table><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>New</td><td>新创建了一个线程对象，但还没有调用start()方法。</td></tr><tr><td>Runnable</td><td>Ready 状态 线程对象创建后，其他线程(比如 main 线程）调用了该对象的 start() 方法。该状态的线程位于可运行线程池中，等待被线程调度选中 获取 cpu 的使用权。Running 绪状态的线程在获得 CPU 时间片后变为运行中状态（running）。</td></tr><tr><td>Blocked</td><td>线程因为某种原因放弃了cpu 使用权（等待锁），暂时停止运行</td></tr><tr><td>Waiting</td><td>线程进入等待状态因为以下几个方法：<br>- Object#wait()<br>- Thread#join()<br>- LockSupport#park()</td></tr><tr><td>Timed Waiting</td><td>有等待时间的等待状态。</td></tr><tr><td>Terminated</td><td>表示该线程已经执行完毕。</td></tr></tbody></table><h2 id="状态控制"><a href="#状态控制" class="headerlink" title="状态控制"></a>状态控制</h2><ul><li>wait() / notify() / notifyAll()</li></ul><p><code>wait()</code>，<code>notify()</code>，<code>notifyAll()</code> 是定义在Object类的实例方法，用于控制线程状态，三个方法都必须在synchronized<br>同步关键字所限定的作用域中调用，否则会报错 <code>java.lang.IllegalMonitorStateException</code>。</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>wait()</code></td><td>线程状态由 的使用权。Running 变为 Waiting, 并将当前线程放入等待队列中</td></tr><tr><td><code>notify()</code></td><td>notify() 方法是将等待队列中一个等待线程从等待队列移动到同步队列中</td></tr><tr><td><code>notifyAll() </code></td><td>则是将所有等待队列中的线程移动到同步队列中</td></tr></tbody></table><p>被移动的线程状态由 Running 变为 Blocked，notifyAll 方法调用后，等待线程依旧不会从 wait() 返回,需要调用 notify() 或者<br>notifyAll() 的线程释放掉锁后，等待线程才有机会从 wait() 返回。</p><ul><li>join() / sleep() / yield()</li></ul><p>在很多情况，主线程创建并启动子线程，如果子线程中需要进行大量的耗时计算，主线程往往早于子线程结束。这时，如果主线程想等待子线程执行结束之后再结束，比如子线程处理一个数据，主线程要取得这个数据，就要用 <code>join()</code><br>方法。</p><p><code>sleep(long)</code> 方法在睡眠时不释放对象锁，而 <code>join()</code> 方法在等待的过程中释放对象锁。</p><p><code>yield()</code><br>方法会临时暂停当前正在执行的线程，来让有同样优先级的正在等待的线程有机会执行。如果没有正在等待的线程，或者所有正在等待的线程的优先级都比较低，那么该线程会继续运行。执行了yield方法的线程什么时候会继续运行由线程调度器来决定。</p><h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><p>当把变量声明为 volatile 类型后，编译器与运行时都会注意到这个变量是共享的，因此不会将该变量上的操作与其他内存操作一起重排序。volatile<br>变量不会被缓存在寄存器或者对其他处理器不可见的地方，JVM 保证了每次读变量都从内存中读，跳过 CPU cache 这一步，因此在读取<br>volatile 类型的变量时总会返回最新写入的值。</p><p><img src="https://user-gold-cdn.xitu.io/2019/6/23/16b833f4a48b216e?w=550&amp;h=429&amp;f=png&amp;s=21448"></p><p>当一个变量定义为 volatile 之后，将具备以下特性：</p><ul><li>保证此变量对所有的线程的可见性，不能保证它具有原子性（可见性，是指线程之间的可见性，一个线程修改的状态对另一个线程是可见的）</li><li>禁止指令重排序优化</li><li>volatile 的读性能消耗与普通变量几乎相同，但是写操作稍慢，因为它需要在本地代码中插入许多内存屏障指令来保证处理器不发生乱序执行</li></ul><p>AtomicInteger 中主要实现了整型的原子操作，防止并发情况下出现异常结果，其内部主要依靠 JDK 中的 unsafe<br>类操作内存中的数据来实现的。volatile 修饰符保证了 value 在内存中其他线程可以看到其值得改变。CAS（Compare and Swap）操作保证了<br>AtomicInteger 可以安全的修改value 的值。</p><h1 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h1><p>当它用来修饰一个方法或者一个代码块的时候，能够保证在同一时刻最多只有一个线程执行该段代码。</p><p>在 Java 中，每个对象都会有一个 monitor 对象，这个对象其实就是 Java<br>对象的锁，通常会被称为“内置锁”或“对象锁”。类的对象可以有多个，所以每个对象有其独立的对象锁，互不干扰。针对每个类也有一个锁，可以称为“类锁”，类锁实际上是通过对象锁实现的，即类的<br>Class 对象锁。每个类只有一个 Class 对象，所以每个类只有一个类锁。</p><p>Monitor 是线程私有的数据结构，每一个线程都有一个可用 monitor record 列表，同时还有一个全局的可用列表。每一个被锁住的对象都会和一个<br>monitor 关联，同时 monitor 中有一个 Owner 字段存放拥有该锁的线程的唯一标识，表示该锁被这个线程占用。Monitor 是依赖于底层的操作系统的<br>Mutex Lock（互斥锁）来实现的线程同步。</p><h2 id="根据获取的锁分类"><a href="#根据获取的锁分类" class="headerlink" title="根据获取的锁分类"></a>根据获取的锁分类</h2><p><strong>获取对象锁</strong></p><ul><li>synchronized(this|object) {}</li><li>修饰非静态方法</li></ul><p><strong>获取类锁</strong></p><ul><li>synchronized(类.class) {}</li><li>修饰静态方法</li></ul><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><strong>同步代码块：</strong></p><ul><li>monitorenter 和 monitorexit 指令实现的</li></ul><p><strong>同步方法</strong></p><ul><li>方法修饰符上的 ACC_SYNCHRONIZED 实现</li></ul><h1 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Lock</span> {<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>;<br><br>    Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>lock()</code></td><td>用来获取锁，如果锁被其他线程获取，处于等待状态。如果采用 Lock，必须主动去释放锁，并且在发生异常时，不会自动释放锁。因此一般来说，使用Lock必须在 try{}catch{} 块中进行，并且将释放锁的操作放在finally块中进行，以保证锁一定被被释放，防止死锁的发生。</td></tr><tr><td><code>lockInterruptibly()</code></td><td>通过这个方法去获取锁时，如果线程正在等待获取锁，则这个线程能够响应中断，即中断线程的等待状态。</td></tr><tr><td><code>tryLock()</code></td><td>tryLock 方法是有返回值的，它表示用来尝试获取锁，如果获取成功，则返回 true，如果获取失败（即锁已被其他线程获取），则返回 false，也就说这个方法无论如何都会立即返回。在拿不到锁时不会一直在那等待。</td></tr><tr><td><code>tryLock(long，TimeUnit)</code></td><td>与 tryLock 类似，只不过是有等待时间，在等待时间内获取到锁返回 true，超时返回 false。</td></tr></tbody></table><h2 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h2><p><img src="https://user-gold-cdn.xitu.io/2019/6/18/16b69b50c9d340a5?w=1372&amp;h=1206&amp;f=png&amp;s=142754"></p><h3 id="悲观锁、乐观锁"><a href="#悲观锁、乐观锁" class="headerlink" title="悲观锁、乐观锁"></a>悲观锁、乐观锁</h3><p>悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。Java<br>中，synchronized 关键字和 Lock 的实现类都是悲观锁。悲观锁适合写操作多的场景，先加锁可以保证写操作时数据正确。</p><p>而乐观锁认为自己在使用数据时不会有别的线程修改数据，所以不会添加锁，只是在更新数据的时候去判断之前有没有别的线程更新了这个数据。如果这个数据没有被更新，当前线程将自己修改的数据成功写入。如果数据已经被其他线程更新，则根据不同的实现方式执行不同的操作（例如报错或者自动重试）。乐观锁在<br>Java 中是通过使用无锁编程来实现，最常采用的是 CAS 算法，Java 原子类中的递增操作就通过 CAS<br>自旋实现。乐观锁适合读操作多的场景，不加锁的特点能够使其读操作的性能大幅提升。</p><h3 id="自旋锁、适应性自旋锁"><a href="#自旋锁、适应性自旋锁" class="headerlink" title="自旋锁、适应性自旋锁"></a>自旋锁、适应性自旋锁</h3><p>阻塞或唤醒一个 Java 线程需要操作系统切换 CPU 状态来完成，这种状态转换需要耗费处理器时间。如果同步代码块中的内容过于简单，状态转换消耗的时间有可能比用户代码执行的时间还要长。</p><p>在许多场景中，同步资源的锁定时间很短，为了这一小段时间去切换线程，线程挂起和恢复现场的花费可能会让系统得不偿失。如果物理机器有多个处理器，能够让两个或以上的线程同时并行执行，我们就可以让后面那个请求锁的线程不放弃CPU的执行时间，看看持有锁的线程是否很快就会释放锁。</p><p>而为了让当前线程“稍等一下”，我们需让当前线程进行自旋，如果在自旋完成后前面锁定同步资源的线程已经释放了锁，那么当前线程就可以不必阻塞而是直接获取同步资源，从而避免切换线程的开销。这就是自旋锁。</p><p>自旋锁本身是有缺点的，它不能代替阻塞。自旋等待虽然避免了线程切换的开销，但它要占用处理器时间。如果锁被占用的时间很短，自旋等待的效果就会非常好。反之，如果锁被占用的时间很长，那么自旋的线程只会白浪费处理器资源。所以，自旋等待的时间必须要有一定的限度，如果自旋超过了限定次数（默认是<br>10 次，可以使用 -XX:PreBlockSpin 来更改）没有成功获得锁，就应当挂起线程。</p><p>自旋锁的实现原理同样也是 CAS，AtomicInteger 中调用 unsafe 进行自增操作的源码中的 do-while<br>循环就是一个自旋操作，如果修改数值失败则通过循环来执行自旋，直至修改成功。</p><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>当前线程拥有其他线程需要的资源，当前线程等待其他线程已拥有的资源，都不放弃自己拥有的资源。</p><h1 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h1><p>强引用 &gt; 软引用 &gt; 弱引用</p><table><thead><tr><th>引用类型</th><th>说明</th></tr></thead><tbody><tr><td>StrongReferenc（强引用）</td><td>当一个对象具有强引用，那么垃圾回收器是绝对不会的回收和销毁它的，<strong>非静态内部类会在其整个生命周期中持有对它外部类的强引用</strong></td></tr><tr><td>WeakReference （弱引用）</td><td>在垃圾回收器运行的时候，如果对一个对象的所有引用都是弱引用的话，该对象会被回收</td></tr><tr><td>SoftReference（软引用）</td><td>如果一个对象只具有软引用，若内存空间足够，垃圾回收器就不会回收它；如果内存空间不足了，才会回收这些对象的内存</td></tr><tr><td>PhantomReference（虚引用）</td><td>一个只被虚引用持有的对象可能会在任何时候被 GC 回收。虚引用对对象的生存周期完全没有影响，也无法通过虚引用来获取对象实例，仅仅能在对象被回收时，得到一个系统通知（只能通过是否被加入到 ReferenceQueue 来判断是否被GC，这也是唯一判断对象是否被 GC 的途径）。</td></tr></tbody></table><h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 定义相关接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseInterface</span> {<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span>;<br>}<br><br><span class="hljs-comment">// 接口的相关实现类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseInterface</span> {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {<br>        System.out.println(<span class="hljs-string">"doSomething"</span>);<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> {<br>    <span class="hljs-type">BaseImpl</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseImpl</span>();<br>    <span class="hljs-comment">// Proxy 动态代理实现</span><br>    <span class="hljs-type">BaseInterface</span> <span class="hljs-variable">proxyInstance</span> <span class="hljs-operator">=</span> (BaseInterface) Proxy.newProxyInstance(base.getClass().getClassLoader(), base.getClass().getInterfaces(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {<br>            <span class="hljs-keyword">if</span> (method.getName().equals(<span class="hljs-string">"doSomething"</span>)) {<br>                method.invoke(base, args);<br>                System.out.println(<span class="hljs-string">"do more"</span>);<br>            }<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<br>    });<br><br>    proxyInstance.doSomething();<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>Proxy.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable {<br><br>    <span class="hljs-comment">// 代理类的缓存</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;<br>        proxyClassCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakCache</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyFactory</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyClassFactory</span>());<br>    ···<br><br>    <span class="hljs-comment">// 生成代理对象方法入口</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span><br><span class="hljs-params">                                        Class&lt;?&gt;[] interfaces,</span><br><span class="hljs-params">                                        InvocationHandler h)</span><br>    <span class="hljs-keyword">throws</span> IllegalArgumentException<br>    {<br>        Objects.requireNonNull(h);<br><br>        <span class="hljs-keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();<br>        <span class="hljs-comment">// 找到并生成相关的代理类</span><br>        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);<br><br>        <span class="hljs-comment">// 调用代理类的构造方法生成代理类实例</span><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ih</span> <span class="hljs-operator">=</span> h;<br>            <span class="hljs-keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) {<br>                cons.setAccessible(<span class="hljs-literal">true</span>);<br>            }<br>            <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{h});<br>        } <br>        ···<br>    }<br>    ···<br>    <br>    <span class="hljs-comment">// 定义和返回代理类的工厂类</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyClassFactory</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BiFunction</span>&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;<br>    {<br>        <span class="hljs-comment">// 所有代理类的前缀</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">proxyClassNamePrefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">"$Proxy"</span>;<br><br>        <span class="hljs-comment">//  用于生成唯一代理类名称的下一个数字</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">nextUniqueNumber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>();<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) {<br><br>            Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdentityHashMap</span>&lt;&gt;(interfaces.length);<br>            ···<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">proxyPkg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 用于定义代理类的包名</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">accessFlags</span> <span class="hljs-operator">=</span> Modifier.PUBLIC | Modifier.FINAL;<br><br>            <span class="hljs-comment">// 确保所有 non-public 的代理接口在相同的包里</span><br>            <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) {<br>                <span class="hljs-type">int</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> intf.getModifiers();<br>                <span class="hljs-keyword">if</span> (!Modifier.isPublic(flags)) {<br>                    accessFlags = Modifier.FINAL;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> intf.getName();<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> name.lastIndexOf(<span class="hljs-string">'.'</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> ((n == -<span class="hljs-number">1</span>) ? <span class="hljs-string">""</span> : name.substring(<span class="hljs-number">0</span>, n + <span class="hljs-number">1</span>));<br>                    <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-literal">null</span>) {<br>                        proxyPkg = pkg;<br>                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!pkg.equals(proxyPkg)) {<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<br>                            <span class="hljs-string">"non-public interfaces from different packages"</span>);<br>                    }<br>                }<br>            }<br><br>            <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-literal">null</span>) {<br>                <span class="hljs-comment">// 如果没有 non-public 的代理接口，使用默认的包名</span><br>                proxyPkg = <span class="hljs-string">""</span>;<br>            }<br><br>            {<br>                List&lt;Method&gt; methods = getMethods(interfaces);<br>                Collections.sort(methods, ORDER_BY_SIGNATURE_AND_SUBTYPE);<br>                validateReturnTypes(methods);<br>                List&lt;Class&lt;?&gt;[]&gt; exceptions = deduplicateAndGetExceptions(methods);<br><br>                Method[] methodsArray = methods.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Method</span>[methods.size()]);<br>                Class&lt;?&gt;[][] exceptionsArray = exceptions.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[exceptions.size()][]);<br><br>                <span class="hljs-comment">// 生成代理类的名称</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> nextUniqueNumber.getAndIncrement();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">proxyName</span> <span class="hljs-operator">=</span> proxyPkg + proxyClassNamePrefix + num;<br><br>                <span class="hljs-comment">// Android 特定修改：直接调用 native 方法生成代理类</span><br>                <span class="hljs-keyword">return</span> generateProxy(proxyName, interfaces, loader, methodsArray,<br>                                     exceptionsArray);<br><br>                <span class="hljs-comment">// JDK 使用的 ProxyGenerator.generateProxyClas 方法创建代理类</span><br>                <span class="hljs-type">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(<br>                    proxyName, interfaces, accessFlags);<br>                <span class="hljs-keyword">try</span> {<br>                    <span class="hljs-keyword">return</span> defineClass0(loader, proxyName,<br>                                        proxyClassFile, <span class="hljs-number">0</span>, proxyClassFile.length);<br>                } ···<br>        }<br>    }<br>    ···<br><br>    <span class="hljs-comment">// 最终调用 native 方法生成代理类</span><br>    <span class="hljs-meta">@FastNative</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; generateProxy(String name, Class&lt;?&gt;[] interfaces,<br>                                                 ClassLoader loader, Method[] methods,<br>                                                 Class&lt;?&gt;[][] exceptions);<br><br>}<br></code></pre></td></tr></tbody></table></figure><p><code>ProxyGenerator.java</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[]generateProxyClass(<span class="hljs-keyword">final</span> String name,<br>        Class[]interfaces)<br>        {<br>        ProxyGenerator gen=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyGenerator</span>(name,interfaces);<br><span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[]classFile=gen.generateClassFile();<br><br>        <span class="hljs-keyword">if</span>(saveGeneratedFiles){<br>        java.security.AccessController.doPrivileged(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.security.PrivilegedAction&lt;Void&gt;(){<br><span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span>{<br>        <span class="hljs-keyword">try</span>{<br>        FileOutputStream file=<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(dotToSlash(name)+<span class="hljs-string">".class"</span>);<br>        file.write(classFile);<br>        file.close();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        }<span class="hljs-keyword">catch</span>(IOException e){<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(<br>        <span class="hljs-string">"I/O exception saving generated file: "</span>+e);<br>        }<br>        }<br>        });<br>        }<br><br>        <span class="hljs-keyword">return</span> classFile;<br>        }<br></code></pre></td></tr></tbody></table></figure><h1 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h1><p>@Retention：保留的范围，可选值有三种。</p><table><thead><tr><th>RetentionPolicy</th><th>说明</th></tr></thead><tbody><tr><td>SOURCE</td><td>注解将被编译器丢弃（该类型的注解信息只会保留在源码里，源码经过编译后，注解信息会被丢弃，不会保留在编译好的class文件里），如 @Override</td></tr><tr><td>CLASS</td><td>注解在class文件中可用，但会被 VM 丢弃（该类型的注解信息会保留在源码里和 class 文件里，在执行的时候，不会加载到虚拟机中），请注意，当注解未定义 Retention 值时，默认值是 CLASS。</td></tr><tr><td>RUNTIME</td><td>注解信息将在运行期 (JVM) 也保留，因此可以通过反射机制读取注解的信息（源码、class 文件和执行的时候都有注解的信息），如 @Deprecated</td></tr></tbody></table><p>@Target：可以用来修饰哪些程序元素，如 TYPE, METHOD, CONSTRUCTOR, FIELD, PARAMETER等，未标注则表示可修饰所有</p><p>@Inherited：是否可以被继承，默认为false</p><p>@Documented：是否会保存到 Javadoc 文档中</p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MarkDown简明语法手册</title>
    <link href="/2023/08/21/docs/markdown/markdown-jian-ming-yu-fa-shou-ce/"/>
    <url>/2023/08/21/docs/markdown/markdown-jian-ming-yu-fa-shou-ce/</url>
    
    <content type="html"><![CDATA[<p>转存 <a href="https://github.com/heanxu/markdown-handbook">Markdown 简明语法手册</a></p><hr><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a><a name="index">目录</a></h2><ul><a name="index"></a><li><a name="index"></a><a href="#title">标题</a></li><li><a href="#text">文本</a><ul><li>普通文本</li><li>单行文本</li><li>多行文本</li><li>文字高亮</li></ul></li><li><a href="#line">横线</a></li><li><a href="#link">链接</a><ul><li>文字超链接</li><li>锚点</li><li>图片超链接</li></ul></li><li><a href="#pic">图片</a></li><li><a href="#dot">列表</a><ul><li>圆点列表</li><li>数字列表</li><li>复选框列表</li></ul></li><li><a href="#blockquotes">块引用</a></li><li><a href="#code">代码</a></li><li><a href="#table">表格</a></li><li><a href="#emoji">表情</a></li></ul><hr><h3 id="1-标题"><a href="#1-标题" class="headerlink" title=" 1.标题"></a><a name="title"> 1.标题</a></h3><p><a name="title">行首加井号表示不同级别的标题 (H1-H6),例如：# H1, ## H2, ### H3，#### H4.</a></p><a name="title"></a><h1 id="一级标题"><a name="title"></a><a href="#一级标题" class="headerlink" title="一级标题"></a>一级标题</h1><h2 id="二级标题"><a href="#二级标题" class="headerlink" title="二级标题"></a>二级标题</h2><h3 id="三级标题"><a href="#三级标题" class="headerlink" title="三级标题"></a>三级标题</h3><h4 id="四级标题"><a href="#四级标题" class="headerlink" title="四级标题"></a>四级标题</h4><h5 id="五级标题"><a href="#五级标题" class="headerlink" title="五级标题"></a>五级标题</h5><h6 id="六级标题"><a href="#六级标题" class="headerlink" title="六级标题"></a>六级标题</h6><hr><p>也可以使用在文字下放加 === 表示一级标题,使用 — 表示二级标题.</p><h1 id="一级标题-1"><a href="#一级标题-1" class="headerlink" title="一级标题"></a>一级标题</h1><h2 id="二级标题-1"><a href="#二级标题-1" class="headerlink" title="二级标题"></a>二级标题</h2><h3 id="2-文本"><a href="#2-文本" class="headerlink" title="2. 文本 "></a>2. 文本 <a name="text"></a></h3><ul><a name="text"><li>普通文本</li></a></ul><a name="text"><p>直接输入的文字就是普通文本。需要注意的是要换行的时候不<br>能直接通过回车来换行，需要使用&lt;br&gt;.也就是html里面的标签.<br>注意第三行的<code>&lt;br&gt;</code>前加了反斜杠 \ .目的就是像其他语言那样实现转义，也就是 &lt; 的转义.</p><ul><li><p>单行文本</p><pre><code class="hljs">  使用两个Tab符实现单行文本.</code></pre></li><li><p>多行文本</p><pre><code class="hljs">  多行文本和  单行文本异曲同工，只要在  每行行首加两个Tab.</code></pre></li><li><p>文字高亮</p></li></ul><p>如果你想使一段话中部分文字高亮显示，来起到突出强调的作用，那么可以把它用 `  ` 包围起来.<code>注意</code>这不是单引号，而是<code>Tab</code><br>上方，<code>数字1</code>左边的按键（注意使用<code>英文</code>输入法).</p></a><h3 id="3-斜体和粗体"><a name="text"></a><a href="#3-斜体和粗体" class="headerlink" title="3. 斜体和粗体"></a>3. 斜体和粗体</h3><p>使用 * 和 ** 表示斜体和粗体.</p><p>这是 <em>斜体</em>,这是 <strong>粗体</strong>.</p><h3 id="4-删除线"><a href="#4-删除线" class="headerlink" title="4. 删除线"></a>4. 删除线</h3><p><del>使用~~表示删除线.</del></p><h3 id="5-外链接"><a href="#5-外链接" class="headerlink" title="5. 外链接"></a>5. 外链接<a name="link"></a></h3><p><a name="link">使用 [描述](链接地址) 为文字增加外链接。</a></p><a name="link"></a><p><a name="link">这是去往 </a><a href="https://gnipbao.github.io/h5-test/3dtag.html">有趣的HTML5和CSS3特效在线演示地址</a> 的链接。</p><h3 id="6-锚点"><a href="#6-锚点" class="headerlink" title="6.锚点"></a>6.锚点<a name=""></a></h3><p><a name="">我们可以使用HTML的锚点标签（<code>#</code>）来设置锚点：</a><a href="#index">回到目录</a><br>但其实呢，每一个标题都是一个锚点，不需要用标签来指定，比如我们 <a href="#TEST">回到顶部</a><br>不过不幸的是，由于对中文支持的不好，所以中文标题貌似是不能视作标签的。</p><h3 id="6-列表"><a href="#6-列表" class="headerlink" title=" 6. 列表"></a><a name="dot"> 6. 列表</a></h3><p><a name="dot">使用 *，+，- 表示无序列表。</a></p><a name="dot"><ul><li>无序列表项 一</li><li>无序列表项 二</li><li>无序列表项 三</li></ul><p>二级三级原点</p><ul><li>编程语言<ul><li>脚本语言<ul><li>Python</li></ul></li></ul></li></ul><p>使用数字和点表示有序列表。</p><ol><li>有序列表项 一</li><li>有序列表项 二</li><li>有序列表项 三</li></ol></a><h3 id="7-数字列表自动排序"><a name="dot"></a><a href="#7-数字列表自动排序" class="headerlink" title="7. 数字列表自动排序"></a>7. 数字列表自动排序</h3><p>也可以在第一行指定<code>1. </code>，而接下来的几行用星号<code>*</code>（或者继续用数字1. ）就可以了，它会自动显示成2、3、4……<br>面向对象的七大原则：</p><ol><li>开闭原则</li></ol><ul><li>里氏转换原则</li><li>依赖倒转原则</li></ul><ol><li>接口隔离原则</li><li>组合聚合复用原则</li><li>迪米特法则</li><li>单一直则原则</li></ol><h3 id="8-多级数字列表"><a href="#8-多级数字列表" class="headerlink" title="8. 多级数字列表"></a>8. 多级数字列表</h3><p>和圆点的列表一样，数字列表也有多级结构：</p><ol><li>这是一级的数字列表，数字1还是1</li><li>这是二级的数字列表，阿拉伯数字在显示的时候变成了罗马数字<br>1. 这是三级的数字列表，数字在显示的时候变成了英文字母<br>1. 四级的数字列表显示效果，就不再变化了，依旧是英文字母</li></ol><h3 id="9-复选框列表"><a href="#9-复选框列表" class="headerlink" title="9. 复选框列表"></a>9. 复选框列表</h3><ul><li><input checked="" disabled="" type="checkbox"> C</li><li><input checked="" disabled="" type="checkbox"> C++</li><li><input checked="" disabled="" type="checkbox"> Java</li><li><input checked="" disabled="" type="checkbox"> Qt</li><li><input checked="" disabled="" type="checkbox"> Android</li><li><input disabled="" type="checkbox"> C#</li><li><input disabled="" type="checkbox"> .NET</li></ul><h3 id="10-文字引用"><a href="#10-文字引用" class="headerlink" title="10. 文字引用"></a>10. 文字引用</h3><p>使用 &gt; 表示文字引用。</p><p>单个引用：</p><blockquote><p>野火烧不尽，春风吹又生。</p></blockquote><p>字符包围：</p><blockquote><p>数据结构</p><blockquote><p>树</p><blockquote><p>二叉树</p><blockquote><p>平衡二叉树</p><blockquote><p>满二叉树</p></blockquote></blockquote></blockquote></blockquote></blockquote><h3 id="11-代码块"><a href="#11-代码块" class="headerlink" title="11. 代码块"></a>11. 代码块<a name="blockquotes"></a></h3><p><a name="blockquotes">使用 四个缩进空格 表示代码块。</a></p><a name="blockquotes"><p>示例：</p><pre><code class="hljs">这是一个代码块，此行左侧有四个不可见的空格。</code></pre></a><h3 id="12-加强的代码块"><a name="blockquotes"></a><a href="#12-加强的代码块" class="headerlink" title="12. 加强的代码块 "></a>12. 加强的代码块 <a name="code"></a></h3><p><a name="code">支持四十一种编程语言的语法高亮的显示，行号显示。</a></p><a name="code"><p>非代码示例：</p><figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">$ sudo npm <span class="hljs-keyword">install</span> <br></code></pre></td></tr></tbody></table></figure><p>Python 示例：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@requires_authorization</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">somefunc</span>(<span class="hljs-params">param1=<span class="hljs-string">''</span>, param2=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-string">'''A docstring'''</span><br>    <span class="hljs-keyword">if</span> param1 &gt; param2: <span class="hljs-comment"># interesting</span><br>        <span class="hljs-built_in">print</span> <span class="hljs-string">'Greater'</span><br>    <span class="hljs-keyword">return</span> (param2 - param1 + <span class="hljs-number">1</span>) <span class="hljs-keyword">or</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeClass</span>:<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span>message = <span class="hljs-string">'''interpreter</span><br><span class="hljs-string"><span class="hljs-meta">... </span>prompt'''</span><br></code></pre></td></tr></tbody></table></figure><p>JavaScript 示例：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* nth element in the fibonacci series.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> n &gt;= 0</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span> the nth element, &gt;= 0.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>) {<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>, b = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">var</span> tmp;<br>  <span class="hljs-keyword">while</span> (--n &gt;= <span class="hljs-number">0</span>) {<br>    tmp = a;<br>    a += b;<br>    b = tmp;<br>  }<br>  <span class="hljs-keyword">return</span> a;<br>}<br><br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title function_">fib</span>(<span class="hljs-number">10</span>));<br></code></pre></td></tr></tbody></table></figure></a><h3 id="13-插入图像"><a name="code"></a><a href="#13-插入图像" class="headerlink" title=" 13.插入图像"></a><a name="pic"> 13.插入图像</a></h3><p><a name="pic">使用 ![描述](图片链接地址) 插入图像。</a></p><a name="pic"><p>插入图片示例：</p><p><img src="https://github.com/gnipbao/gnipbao.github.io/blob/master/images/markdown.jpg" alt="Markdown"></p><p>给图片添加链接:</p></a><p><a name="pic"></a><a href="http://gnipbao.github.io/css3-test/src/Funny-demo/Button/index.html">![V]</a><br>[V]:<a href="https://github.com/gnipbao/gnipbao.github.io/blob/master/images/markdown.jpg">https://github.com/gnipbao/gnipbao.github.io/blob/master/images/markdown.jpg</a></p><h3 id="14-显示表格"><a href="#14-显示表格" class="headerlink" title="14.显示表格"></a><a name="table">14.显示表格</a></h3><pre><a name="table"><code>表头1  | 表头2------------- | -------------Content Cell  | Content CellContent Cell  | Content Cell</code></a></pre><a name="table"><table><thead><tr><th>表头1</th><th>表头2</th></tr></thead><tbody><tr><td>Content Cell</td><td>Content Cell</td></tr><tr><td>Content Cell</td><td>Content Cell</td></tr></tbody></table><table><thead><tr><th>名字</th><th>描述</th></tr></thead><tbody><tr><td>Help</td><td>Display the help window.</td></tr><tr><td>Close</td><td>Closes a window</td></tr></tbody></table><p>表格中也可以使用普通文本的删除线，斜体等效果</p><table><thead><tr><th>名字</th><th>描述</th></tr></thead><tbody><tr><td>Help</td><td><del>Display the</del> help window.</td></tr><tr><td>Close</td><td><em>Closes</em> a window</td></tr></tbody></table><p>表格可以指定对齐方式</p><table><thead><tr><th align="left">左对齐</th><th align="center">居中</th><th align="right">右对齐</th></tr></thead><tbody><tr><td align="left">col 3 is</td><td align="center">some wordy text</td><td align="right">$1600</td></tr><tr><td align="left">col 2 is</td><td align="center">centered</td><td align="right">$12</td></tr><tr><td align="left">zebra stripes</td><td align="center">are neat</td><td align="right">$1</td></tr></tbody></table><p>表格中嵌入图片</p><table><thead><tr><th>图片</th><th>描述</th></tr></thead><tbody><tr><td><img src="https://github.com/gnipbao/gnipbao.github.io/blob/master/images/markdown.jpg" alt="Markdown"></td><td>图片</td></tr></tbody></table></a><h3 id="15-Html-标签"><a name="table"></a><a href="#15-Html-标签" class="headerlink" title="15. Html 标签"></a>15. Html 标签</h3><p>本站支持在 Markdown 语法中嵌套 Html 标签，譬如，你可以用 Html 写一个纵跨两行的表格：</p><pre><code class="hljs">&lt;table&gt;    &lt;tr&gt;        &lt;th rowspan="2"&gt;值班人员&lt;/th&gt;        &lt;th&gt;星期一&lt;/th&gt;        &lt;th&gt;星期二&lt;/th&gt;        &lt;th&gt;星期三&lt;/th&gt;    &lt;/tr&gt;    &lt;tr&gt;        &lt;td&gt;李强&lt;/td&gt;        &lt;td&gt;张明&lt;/td&gt;        &lt;td&gt;王平&lt;/td&gt;    &lt;/tr&gt;&lt;/table&gt;</code></pre><table>    <tbody><tr>        <th rowspan="2">值班人员</th>        <th>星期一</th>        <th>星期二</th>        <th>星期三</th>    </tr>    <tr>        <td>李强</td>        <td>张明</td>        <td>王平</td>    </tr></tbody></table><h3 id="16-待办事宜-Todo-列表"><a href="#16-待办事宜-Todo-列表" class="headerlink" title="16. 待办事宜 Todo 列表"></a>16. 待办事宜 Todo 列表</h3><p>使用带有 [ ] 或 [x] （未完成或已完成）项的列表语法撰写一个待办事宜列表，并且支持子列表嵌套以及混用Markdown语法，例如：</p><pre><code class="hljs">- [ ] **Cmd Markdown 开发**    - [ ] 改进 Cmd 渲染算法，使用局部渲染技术提高渲染效率    - [ ] 支持以 PDF 格式导出文稿    - [x] 新增Todo列表功能     - [x] 改进 LaTex 功能        - [x] 修复 LaTex 公式渲染问题        - [x] 新增 LaTex 公式编号功能 - [ ] **七月旅行准备**    - [ ] 准备邮轮上需要携带的物品    - [ ] 浏览日本免税店的物品    - [x] 购买蓝宝石公主号七月一日的船票</code></pre><p>对应显示如下待办事宜 Todo 列表：</p><ul><li><input disabled="" type="checkbox"> <strong>Cmd Markdown 开发</strong><ul><li><input disabled="" type="checkbox"> 改进 Cmd 渲染算法，使用局部渲染技术提高渲染效率</li><li><input disabled="" type="checkbox"> 支持以 PDF 格式导出文稿</li><li><input checked="" disabled="" type="checkbox"> 新增Todo列表功能<ul><li><input checked="" disabled="" type="checkbox"> 改进 LaTex 功能<ul><li><input checked="" disabled="" type="checkbox"> 修复 LaTex 公式渲染问题</li><li><input checked="" disabled="" type="checkbox"> 新增 LaTex 公式编号功能</li></ul></li></ul></li></ul></li><li><input disabled="" type="checkbox"> <strong>七月旅行准备</strong><ul><li><input disabled="" type="checkbox"> 准备邮轮上需要携带的物品</li><li><input disabled="" type="checkbox"> 浏览日本免税店的物品</li><li><input checked="" disabled="" type="checkbox"> 购买蓝宝石公主号七月一日的船票</li></ul></li></ul><h3 id="17-添加表情"><a href="#17-添加表情" class="headerlink" title="17.添加表情"></a><a name="emoji">17.添加表情</a></h3><p><a name="emoji">Github的Markdown语法支持添加emoji表情，输入不同的符号码（两个冒号包围的字符）可以显示出不同的表情.</a></p><a name="emoji"><p>比如<code>:blush:</code>，可以显示<span class="github-emoji"><span>😊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>.</p></a><p><a name="emoji">详细查看</a><a href="./emoji.md">emoji</a>.</p>]]></content>
    
    
    <categories>
      
      <category>MarkDown</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MarkDown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kotlin 协程篇</title>
    <link href="/2023/08/21/docs/kotlin/kotlin-xie-cheng-pian/"/>
    <url>/2023/08/21/docs/kotlin/kotlin-xie-cheng-pian/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h2 id="CoroutineScope-作用域"><a href="#CoroutineScope-作用域" class="headerlink" title="CoroutineScope 作用域"></a>CoroutineScope 作用域</h2><p>指定协程执行的范围</p><p><code>CoroutineScope</code> 应该在生命周期明确的实体上实现（或用作字段），这些实体负责启动子协程。例如在Activity中使用协程：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span>(), CoroutineScope <span class="hljs-keyword">by</span> MainScope() {<br><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {<br>       cancel() <span class="hljs-comment">// destroy的时候cancel()</span><br>   }<br><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showSomeData</span><span class="hljs-params">()</span></span> = launch { <span class="hljs-comment">// &lt;- extension on current activity, </span><br><span class="hljs-comment">// 主线程</span><br><span class="hljs-comment">// 也可以切换到其他线程</span><br>draw(<span class="hljs-keyword">data</span>) <span class="hljs-comment">// draw in the main thread</span><br>}<br>}<br></code></pre></td></tr></tbody></table></figure><p>Lifecycle的扩展中已经定义了一个协程作用域，这个作用范围是默认在主线程执行的，生命周期结束会执行<code>cancel()</code><br>，所以我们可以直接使用这个作用域就行了:</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> LifecycleOwner.lifecycleScope: LifecycleCoroutineScope<br>    <span class="hljs-keyword">get</span>() = lifecycle.coroutineScope<br></code></pre></td></tr></tbody></table></figure><p>在Activity中使用协程时就可以用 <code>lifecycleScope</code> 了</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch {<br><span class="hljs-comment">// do something in main thread</span><br>launch(Dispatchers.IO) { <br>    <span class="hljs-comment">// do something in io thread</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>在 <code>Fragment </code>中也是使用 <code>lifecycleScope</code> 作用域，在 <code>ViewModel </code>中用 <code>viewModelScope </code></p><h3 id="GlobalScope"><a href="#GlobalScope" class="headerlink" title="GlobalScope"></a>GlobalScope</h3><p>全局的 <code>CoroutineScope</code>，没有绑定到任何Job。<br><code>GlobalScope</code> 用于启动在整个应用程序生命周期内运行且不会过早取消的顶级协程.<br>应用程序代码通常应使用应用程序定义的<code>[CoroutineScope]</code>。不建议在<code>[GlobalScope]</code>实例上使用<code>[async][CoroutineScope.async]</code><br>或<code>[launch] [CoroutineScope.launch]</code>。</p><h2 id="suspendCoroutine"><a href="#suspendCoroutine" class="headerlink" title="suspendCoroutine"></a>suspendCoroutine</h2><p>挂起函数</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">suspendCoroutine</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> block: (<span class="hljs-type">Continuation</span>&lt;<span class="hljs-type">T</span>&gt;) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T<br></code></pre></td></tr></tbody></table></figure><p>获取暂停函数中的当前继续实例，并暂停当前正在运行的协程。也就是阻塞的等待函数返回结果，这个函数类似<code>RxJava</code> 中 <code>Single&lt;T&gt; </code><br>的<code>blockGet()</code>操作。</p><p>例：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch(Dispatchers.IO) {<br>    Timber.i(<span class="hljs-string">"start"</span>)<br>    <span class="hljs-keyword">val</span> result = suspendCoroutineGetTest()<br>    Timber.i(<span class="hljs-string">"result: <span class="hljs-variable">$result</span>"</span>)<br>    Timber.i(<span class="hljs-string">"end:"</span>)<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">suspendCoroutineGetTest</span><span class="hljs-params">()</span></span>: String? = suspendCoroutine {<br>    runBlocking(Dispatchers.IO) {<br>        delay(<span class="hljs-number">3000L</span>)<br>    }<br>    it.resume(<span class="hljs-string">"hhhhh"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果：</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">15</span>:<span class="hljs-number">53</span>:<span class="hljs-number">43</span>.<span class="hljs-number">858</span> I/MainActivity$onCreate: start<br><span class="hljs-attribute">15</span>:<span class="hljs-number">53</span>:<span class="hljs-number">46</span>.<span class="hljs-number">865</span> I/MainActivity$onCreate: result: hhhhh<br><span class="hljs-attribute">15</span>:<span class="hljs-number">53</span>:<span class="hljs-number">46</span>.<span class="hljs-number">865</span> I/MainActivity$onCreate: end:<br></code></pre></td></tr></tbody></table></figure><p>使用<code>resumeWithException</code>可以让它抛出异常，调用该方法的地方就可以捕获到该异常，例：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch(Dispatchers.IO) {<br>    Timber.i(<span class="hljs-string">"start"</span>)<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-keyword">val</span> result = suspendCoroutineGetTest()<br>        Timber.i(<span class="hljs-string">"result: <span class="hljs-variable">$result</span>"</span>)<br>    } <span class="hljs-keyword">catch</span> (e: Throwable) {<br>        Timber.e(e)<br>    }<br>    Timber.i(<span class="hljs-string">"end:"</span>)<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">suspendCoroutineGetTest</span><span class="hljs-params">()</span></span>: String? = suspendCoroutine {<br>    runBlocking(Dispatchers.IO) {<br>        delay(<span class="hljs-number">3000L</span>)<br>    }<br>    it.resumeWithException(IllegalStateException(<span class="hljs-string">"test"</span>))<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果</p><figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">2021-02-03</span> <span class="hljs-number">16</span>:<span class="hljs-number">01:50.964</span> I/MainActivity$onCreate: start<br><span class="hljs-number">2021-02-03</span> <span class="hljs-number">16</span>:<span class="hljs-number">01:53.971</span> E/MainActivity$onCreate: java.lang.IllegalStateException: test<br>        ......<br><span class="hljs-number">2021-02-03</span> <span class="hljs-number">16</span>:<span class="hljs-number">01:53.971</span> I/MainActivity$onCreate: end:<br></code></pre></td></tr></tbody></table></figure><p>使用这个函数我们就可以将异步的一些操作改能同步的，或者将一些回调特别多的操作改成同步的。<br>比如进行相机拍照操作就可以这样处理：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 点击拍照按钮</span><br>bt_snap.setOnClickListener {<br>bt_snap.isEnabled = <span class="hljs-literal">false</span><br>    lifecycleScope.launch(Dispatchers.IO) {<br>        <span class="hljs-keyword">val</span> byteArray = doTakePicture(mCamera)<br>        <span class="hljs-comment">// ....</span><br>launch(Dispatchers.Main) {<br>bt_snap.isEnabled = <span class="hljs-literal">true</span><br>}  <br>    }<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doTakePicture</span><span class="hljs-params">(camera: <span class="hljs-type">Camera</span>?)</span></span>: ByteArray? = suspendCoroutine {<br>    <span class="hljs-keyword">if</span> (camera == <span class="hljs-literal">null</span>) {<br>        it.resume(<span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span><span class="hljs-symbol">@suspendCoroutine</span><br>    }<br>    camera.autoFocus { _, c -&gt;<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) {<br>            it.resume(<span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span><span class="hljs-symbol">@autoFocus</span><br>        }<br>        c.takePicture (<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, { <span class="hljs-keyword">data</span>, c1 -&gt;<br>            <span class="hljs-keyword">if</span> (c1 == <span class="hljs-literal">null</span>) {<br>                it.resume(<span class="hljs-literal">null</span>)<br>                <span class="hljs-keyword">return</span><span class="hljs-symbol">@takePicture</span><br>            }<br>            <span class="hljs-keyword">try</span> {<br>                c1.startPreview()<br>            } <span class="hljs-keyword">finally</span> {<br>                it.resume(<span class="hljs-keyword">data</span>)<br>                <span class="hljs-keyword">return</span><span class="hljs-symbol">@takePicture</span><br>            }<br>        })<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure><p>在此函数中，<code>resume</code>和<code>resumeWithException</code><br>可以在运行暂停功能的同一堆栈中同步使用，也可以稍后在同一线程或不同执行线程中异步使用。随后调用任何恢复函数将产生一个<code>java.lang.IllegalStateException: Already resumed</code><br>的异常。另外，如果此函数中使用了<code>resumeWithException</code>，在调用它的地方也要进行异常捕获处理。</p><h2 id="suspendCancellableCoroutine"><a href="#suspendCancellableCoroutine" class="headerlink" title="suspendCancellableCoroutine"></a>suspendCancellableCoroutine</h2><p>可取消的挂起函数</p><p>上面讲的<code>suspendCoroutine </code>挂起函数执行开始之后是不可取消的，比如：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch(Dispatchers.Main) {<br>    <span class="hljs-keyword">val</span> job = launch(Dispatchers.IO) {<br>    Timber.i(<span class="hljs-string">"start"</span>)<br>   <span class="hljs-comment">//这里三秒后才会返回结果</span><br>        <span class="hljs-keyword">val</span> result = suspendCoroutineGetTest()<br>        Timber.i(<span class="hljs-string">"result: <span class="hljs-variable">$result</span>"</span>)<br>        Timber.i(<span class="hljs-string">"end:"</span>)<br>}<br><span class="hljs-comment">// 1秒后取消</span><br>launch(Dispatchers.IO) {<br>    delay(<span class="hljs-number">1000L</span>)<br>    Timber.i(<span class="hljs-string">"cancel job"</span>)<br>    job.cancel()<br>}<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">suspendCoroutineGetTest</span><span class="hljs-params">()</span></span>: String? = suspendCoroutine {<br>    runBlocking(Dispatchers.IO) {<br>        delay(<span class="hljs-number">3000L</span>)<br>    }<br>    Timber.i(<span class="hljs-string">"suspendCoroutine return "</span>)<br>    it.resume(<span class="hljs-string">"hhhhh"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>预期结果是1秒后 job 被取消，suspendCoroutineGetTest 将不再返回结果，而实际结果是：</p><figure class="highlight wasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs wasm"><span class="hljs-number">00.789</span> I/MainActivity<span class="hljs-variable">$onCreate</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job</span>: <span class="hljs-keyword">start</span><br><span class="hljs-number">01.796</span> I/MainActivity<span class="hljs-variable">$onCreate</span>: cancel job<br><span class="hljs-number">03.804</span> I/MainActivity: suspendCoroutine <span class="hljs-keyword">return</span> <br><span class="hljs-number">03.804</span> I/MainActivity<span class="hljs-variable">$onCreate</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job</span>: <span class="hljs-keyword">result</span>: hhhhh<br><span class="hljs-number">03.804</span> I/MainActivity<span class="hljs-variable">$onCreate</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job</span>: <span class="hljs-keyword">end</span>:<br></code></pre></td></tr></tbody></table></figure><p>job 调用了cancel方法之后，挂起函数还在执行，并且整个job还在正常运行，这显然不符合我们预期要求。<br>如果要让job能够取消就需要使用<code>suspendCancellableCoroutine</code></p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">suspendCoroutineGetTest</span><span class="hljs-params">()</span></span>: String? = suspendCancellableCoroutine {<br>    runBlocking(Dispatchers.IO) {<br>        delay(<span class="hljs-number">3000L</span>)<br>    }<br>    Timber.i(<span class="hljs-string">"suspendCoroutine return "</span>)<br>    it.resume(<span class="hljs-string">"hhhhh"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>这时候再运行：</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-number">52.797</span> I/MainActivity<span class="hljs-variable">$onCreate</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job:</span> <span class="hljs-built_in">start</span><br><span class="hljs-number">53.806</span> I/MainActivity<span class="hljs-variable">$onCreate:</span> cancel job<br><span class="hljs-number">55.806</span> I/MainActivity: suspendCoroutine <span class="hljs-keyword">return</span> <br><span class="hljs-number">55.810</span> E/MainActivity<span class="hljs-variable">$onCreate</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job:</span> kotlinx.coroutines.JobCancellationException: Job was cancelled;<br></code></pre></td></tr></tbody></table></figure><p>三秒后挂起函数返回结果时便抛出了异常，job也不会继续执行。</p><p>上面讲到挂起函数调用<code>resume</code>之后再次<code>resume</code>就会抛出异常，但是如果是使用 <code>suspendCancellableCoroutine</code><br>就可以通过 <code>isActive</code> 来判断是否需要再 <code>resume</code> 了:</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Timber.i(<span class="hljs-string">"suspendCoroutine return "</span>)<br>it.resume(<span class="hljs-string">"hhhhh"</span>)<br><span class="hljs-keyword">if</span>(it.isActive) {<br>    it.resume(<span class="hljs-string">"hhhhh"</span>)<br>}<br><span class="hljs-keyword">if</span>(it.isActive) {<br><span class="hljs-comment">//这里再次调用resume也不会再执行了，因为上面已经resume了，isActive也已经变成了false</span><br>    it.resume(<span class="hljs-string">"hhhhh"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>所以我们在使用挂起函数时最好使用 <code>suspendCancellableCoroutine </code>而不是 <code>suspendCoroutine </code>。<br>另外，这个挂起函数中有三个标志：<br><code>isActive</code>        函数如果没有完成或取消则返回 true<br><code>isCompleted</code>    由于任何原因完成此继续操作时，都返回 true 。被取消的继续也被视为完成。<br><code>isCancelled</code>    如果调用了job的<code>cancel()</code>方法，之后则返回 true</p><p>一般情况下使用<code>isActive</code>就可以满足需求了。</p><h2 id="Flow"><a href="#Flow" class="headerlink" title="Flow"></a>Flow</h2><h3 id="什么是Flow"><a href="#什么是Flow" class="headerlink" title="什么是Flow"></a>什么是Flow</h3><p>Flow 库是在 Kotlin Coroutines 1.3.2 发布之后新增的库，也叫做异步流</p><p>类似 RxJava 的 Observable 、 Flowable 等。用生产者和消费者来做对比，简单来讲就可以一边生产一边消费的作用。</p><h3 id="使用Flow"><a href="#使用Flow" class="headerlink" title="使用Flow"></a>使用Flow</h3><p>先看一个简单的使用例子</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch {<br>    launch {<br>    <span class="hljs-comment">//验证Flow没有阻塞线程</span><br>        repeat(<span class="hljs-number">3</span>){<br>            delay(<span class="hljs-number">1000</span>)<br>            Timber.i(<span class="hljs-string">"I'm not blocked: <span class="hljs-variable">$it</span>"</span>)<br>        }<br>    }<br>    flow{<br>    repeat(<span class="hljs-number">3</span>){<br>        delay(<span class="hljs-number">1000</span>)<br>        emit(it)<br>    }<br>}.collect {<br>        Timber.i(<span class="hljs-string">"collect: <span class="hljs-variable">$it</span>"</span>)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00</span>.<span class="hljs-number">480</span> I: collect : <span class="hljs-number">0</span><br><span class="hljs-attribute">00</span>.<span class="hljs-number">481</span> I: I'm not blocked : <span class="hljs-number">0</span><br><span class="hljs-attribute">01</span>.<span class="hljs-number">484</span> I: collect : <span class="hljs-number">1</span><br><span class="hljs-attribute">01</span>.<span class="hljs-number">484</span> I: I'm not blocked : <span class="hljs-number">1</span><br><span class="hljs-attribute">02</span>.<span class="hljs-number">486</span> I: collect : <span class="hljs-number">2</span><br><span class="hljs-attribute">02</span>.<span class="hljs-number">487</span> I: I'm not blocked : <span class="hljs-number">2</span><br></code></pre></td></tr></tbody></table></figure><p>其中Flow的接口，只有一个<code>collect</code>函数。和RXjava相比的话，可以理解为 <code>collect()</code> 对应<code>subscribe()</code>，而 <code>emit()</code><br>对应<code>onNext()</code>。</p><h3 id="切换线程"><a href="#切换线程" class="headerlink" title="切换线程"></a>切换线程</h3><p>默认情况没有切换线程的话flow的生产者和消费者是同步非阻塞的：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch {<br>    flow{<br>        repeat(<span class="hljs-number">3</span>){<br>            delay(<span class="hljs-number">1000</span>)<br>            Timber.i(<span class="hljs-string">"emit on: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)<br>            emit(it)<br>        }<br>    }.collect {<br>        Timber.i(<span class="hljs-string">"collect on <span class="hljs-subst">${Thread.currentThread().name}</span> : <span class="hljs-variable">$it</span>"</span>)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>输出结果：</p><figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">I:</span> emit <span class="hljs-keyword">on</span>: main<br><span class="hljs-symbol">I:</span> collect <span class="hljs-keyword">on</span> main : <span class="hljs-number">0</span><br><span class="hljs-symbol">I:</span> emit <span class="hljs-keyword">on</span>: main<br><span class="hljs-symbol">I:</span> collect <span class="hljs-keyword">on</span> main : <span class="hljs-number">1</span><br><span class="hljs-symbol">I:</span> emit <span class="hljs-keyword">on</span>: main<br><span class="hljs-symbol">I:</span> collect <span class="hljs-keyword">on</span> main : <span class="hljs-number">2</span><br></code></pre></td></tr></tbody></table></figure><p>切换线程，相比Rxjava中使用 observeOn、subscribeOn 来切换线程，flow 会更加简单。只需使用 flowOn，如下：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch {<br>    flow{<br>        repeat(<span class="hljs-number">3</span>){<br>            delay(<span class="hljs-number">1000</span>)<br>            Timber.i(<span class="hljs-string">"emit on: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)<br>            emit(it)<br>        }<br>    }.flowOn(Dispatchers.IO).collect {<br>        Timber.i(<span class="hljs-string">"collect on <span class="hljs-subst">${Thread.currentThread().name}</span> : <span class="hljs-variable">$it</span>"</span>)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>输出结果：</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">I</span>: emit <span class="hljs-literal">on</span>: DefaultDispatcher-worker-<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span>: collect <span class="hljs-literal">on</span> main : <span class="hljs-number">0</span><br><span class="hljs-attribute">I</span>: emit <span class="hljs-literal">on</span>: DefaultDispatcher-worker-<span class="hljs-number">2</span><br><span class="hljs-attribute">I</span>: collect <span class="hljs-literal">on</span> main : <span class="hljs-number">1</span><br><span class="hljs-attribute">I</span>: emit <span class="hljs-literal">on</span>: DefaultDispatcher-worker-<span class="hljs-number">1</span><br><span class="hljs-attribute">I</span>: collect <span class="hljs-literal">on</span> main : <span class="hljs-number">2</span><br></code></pre></td></tr></tbody></table></figure><p>flow builder是运行在 <code>flowOn()</code> 指定的线程中， <code>clollect() </code> 所在线程则取决于整个 flow 处于哪个</p><p>CoroutineScope 下。</p><h3 id="Flow-什么时候开始执行"><a href="#Flow-什么时候开始执行" class="headerlink" title="Flow 什么时候开始执行"></a>Flow 什么时候开始执行</h3><p>Flow 是一种类似于序列的冷流 ， flow 构建器中的代码直到流被收集的时候才运行。</p><p>例：先初始化一个flow，三秒后再collect</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">Timber.i(<span class="hljs-string">"start"</span>)<br><span class="hljs-keyword">val</span> f = flow{<br>    repeat(<span class="hljs-number">3</span>){<br>        delay(<span class="hljs-number">1000</span>)<br>        Timber.i(<span class="hljs-string">"emit on: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)<br>        emit(it)<br>    }<br>}.flowOn(Dispatchers.IO)<br>delay(<span class="hljs-number">3000</span>)<br>f.collect {<br>    Timber.i(<span class="hljs-string">"collect on <span class="hljs-subst">${Thread.currentThread().name}</span> : <span class="hljs-variable">$it</span>"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果</p><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-number">46.180</span> I: start<br><span class="hljs-number">50.211</span> I: emit <span class="hljs-keyword">on</span>: DefaultDispatcher<span class="hljs-params">-worker</span><span class="hljs-number">-1</span><br><span class="hljs-number">50.212</span> I: collect <span class="hljs-keyword">on</span> main : <span class="hljs-number">0</span><br><span class="hljs-params">...</span><span class="hljs-params">...</span><br></code></pre></td></tr></tbody></table></figure><h3 id="Flow-怎么取消"><a href="#Flow-怎么取消" class="headerlink" title="Flow 怎么取消"></a>Flow 怎么取消</h3><p>Flow是需要写在 <code>lanuch</code> 中的，所以取消的话只需要调用<code>launch</code>的<code>cancel()</code>把<code>launch</code>取消就行了</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> d = launch {<br>    flow{<br>        repeat(<span class="hljs-number">3</span>){<br>            delay(<span class="hljs-number">1000</span>)<br>            Timber.i(<span class="hljs-string">"emit on: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)<br>            emit(it)<br>        }<br>    }.flowOn(Dispatchers.IO).collect {<br>        Timber.i(<span class="hljs-string">"collect on <span class="hljs-subst">${Thread.currentThread().name}</span> : <span class="hljs-variable">$it</span>"</span>)<br>    }<br>}<br>delay(<span class="hljs-number">1000</span>)<br>d.cancel()<br></code></pre></td></tr></tbody></table></figure><p>这样一秒后这个flow操作就会被取消</p><h3 id="Flow-可以用在哪里"><a href="#Flow-可以用在哪里" class="headerlink" title="Flow 可以用在哪里"></a>Flow 可以用在哪里</h3><p>用处一：后台进行下载操作，主线程更新下载进度：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">doDownload().flowOn(Dispatchers.IO).collect {<br>    Timber.i(<span class="hljs-string">"下载进度：<span class="hljs-variable">$it</span>"</span>)<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doDownload</span><span class="hljs-params">()</span></span> = flow {<br>    repeat(<span class="hljs-number">100</span>){<br>        delay(<span class="hljs-number">10</span>)<br>        emit(it)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果：</p><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">0</span><br><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">1</span><br><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">2</span><br><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">3</span><br>......<br><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">98</span><br><span class="hljs-symbol">I:</span> 下载进度：<span class="hljs-number">99</span><br></code></pre></td></tr></tbody></table></figure><p>用法二：后台耗时获取数据，后台一边获取，主线程一边处理。比如获取大量设备列表，后台可以分批进行获取，获取一批便emit一批。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">lifecycleScope.launch {<br>    Timber.i(<span class="hljs-string">"start"</span>)<br>    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>    getDevices().flowOn(Dispatchers.IO).buffer().collect {<br>        count++<br>        Timber.i(<span class="hljs-string">"获取到 <span class="hljs-subst">${it.size}</span> 个设备，开始更新列表"</span>)<br>    }<br>    Timber.i(<span class="hljs-string">"end, count: <span class="hljs-variable">$count</span>"</span>)<br>}<br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDevices</span><span class="hljs-params">()</span></span> = flow {<br>    <span class="hljs-keyword">val</span> list: MutableList&lt;<span class="hljs-built_in">Int</span>&gt; = ArrayList()<br>    repeat(<span class="hljs-number">1000</span>) { i -&gt;<br>        list.add(i)<br>    }<br>    repeat(<span class="hljs-number">100</span>) {<br>        delay(<span class="hljs-number">100</span>)<br>        <span class="hljs-comment">//Timber.i("emit: $it")</span><br>        emit(list)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>上面是模拟一次获取1000个设备，获取100次</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">I:</span> <span class="hljs-string">start</span><br><span class="hljs-attr">I:</span> <span class="hljs-string">获取到</span> <span class="hljs-number">1000</span> <span class="hljs-string">个设备，开始更新列表</span><br><span class="hljs-attr">I:</span> <span class="hljs-string">获取到</span> <span class="hljs-number">1000</span> <span class="hljs-string">个设备，开始更新列表</span><br><span class="hljs-string">......</span><br><span class="hljs-attr">I:</span> <span class="hljs-string">end,</span> <span class="hljs-attr">count:</span> <span class="hljs-number">100</span><br></code></pre></td></tr></tbody></table></figure><h3 id="Flow-其他操作符"><a href="#Flow-其他操作符" class="headerlink" title="Flow 其他操作符"></a>Flow 其他操作符</h3><p>例子：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">foo().collect {<br>    println(it)<br>}<br><br>repeat(<span class="hljs-number">10</span>) {<br>    delay(<span class="hljs-number">100</span>)<br>    emit(it)<br>}<br></code></pre></td></tr></tbody></table></figure><p>结果：</p><figure class="highlight node-repl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs node-repl">0<br>1<br><span class="hljs-meta prompt_">...</span><br>9<br></code></pre></td></tr></tbody></table></figure><h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p>使用map我们可以将最终结果映射为其他类型，融合了Rxjava的map与flatMap的功能<br>代码如下所示：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">foo().map { <br>    <span class="hljs-string">"转换成了String : <span class="hljs-variable">$it</span>"</span><br>}.collect {<br>    println(it)<br>}<br></code></pre></td></tr></tbody></table></figure><p>结果：</p><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lasso">转换成了<span class="hljs-built_in">String</span> : <span class="hljs-number">0</span><br>转换成了<span class="hljs-built_in">String</span> : <span class="hljs-number">1</span><br><span class="hljs-params">...</span><br>转换成了<span class="hljs-built_in">String</span> : <span class="hljs-number">9</span><br></code></pre></td></tr></tbody></table></figure><h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>通过 filter 可以对结果添加过滤条件，如下所示，仅打印出大于7的值</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">foo().filter { <br>    it &gt; <span class="hljs-number">7</span><br>}.collect {<br>    println(it)<br>}<br></code></pre></td></tr></tbody></table></figure><p>结果：</p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">8<br>9<br></code></pre></td></tr></tbody></table></figure><h4 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h4><p>transform可以自定义转换逻辑，除了可以实现filter和map的功能，还可以实现其他功能</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">foo().transform {<br>    <span class="hljs-keyword">if</span>(it &gt; <span class="hljs-number">7</span>){<br>        emit(<span class="hljs-string">"transform to string :<span class="hljs-variable">$it</span>"</span>)<br>        emit(<span class="hljs-string">"emit second :<span class="hljs-variable">$it</span>"</span>)<br>    }<br>}.collect {<br>    println(it)<br>}<br></code></pre></td></tr></tbody></table></figure><p>运行结果：</p><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs applescript">transform <span class="hljs-keyword">to</span> <span class="hljs-built_in">string</span> :<span class="hljs-number">8</span><br>emit <span class="hljs-keyword">second</span> :<span class="hljs-number">8</span><br>transform <span class="hljs-keyword">to</span> <span class="hljs-built_in">string</span> :<span class="hljs-number">9</span><br>emit <span class="hljs-keyword">second</span> :<span class="hljs-number">9</span><br></code></pre></td></tr></tbody></table></figure><h4 id="末端操作符"><a href="#末端操作符" class="headerlink" title="末端操作符"></a>末端操作符</h4><p>上面常用的<code>collect</code>就是一个末端操作符，除此之外还有<code>toList</code>、<code>reduce</code>、<code>fold</code>、<code>asLiveData</code>等操作符<br><code>toList</code> 就如字面意思，把所有结果转成List数组<br><code>reduce</code> 可以把所有结果累加起来：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> d = foo().reduce { accumulator, value -&gt;<br>    accumulator + value<br>}<br>println(d)<br></code></pre></td></tr></tbody></table></figure><p>结果:</p><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">45<br></code></pre></td></tr></tbody></table></figure><p><code>asLiveData</code> 将Flow转成LiveData，通过LiveData来监听 emit 的数据：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> liveData = getDevices().flowOn(Dispatchers.IO).buffer().asLiveData()<br>liveData.observe(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MainActivity</span>, {<br>    count++<br>    Timber.i(<span class="hljs-string">"count: <span class="hljs-variable">$count</span>"</span>)<br>})<br></code></pre></td></tr></tbody></table></figure><p>运行结果：</p><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">I:</span> start<br><span class="hljs-symbol">I:</span> count: <span class="hljs-number">1</span><br><span class="hljs-symbol">I:</span> count: <span class="hljs-number">2</span><br><span class="hljs-symbol">I:</span> count: <span class="hljs-number">3</span><br>... ...<br><span class="hljs-symbol">I:</span> count: <span class="hljs-number">100</span><br></code></pre></td></tr></tbody></table></figure><h3 id="协程背压"><a href="#协程背压" class="headerlink" title="协程背压"></a>协程背压</h3><p>Kotlin流程设计中的所有函数都标有suspend修饰符，具有在不阻塞线程的情况下挂起调用程序执行的强大功能。因此，当流的收集器不堪重负时，它可以简单地挂起发射器，并在准备好接受更多元素时稍后将其恢复。</p><h4 id="buffer-操作符"><a href="#buffer-操作符" class="headerlink" title="buffer 操作符"></a>buffer 操作符</h4><p>例如，发射者需要100毫秒处理并产生一个数据，而收集者需要200毫秒来处理这个数据，这时候发射者发就需要等收集者处理完上个数据再去花费100毫秒处理产生一个新数据，这样一个周期就是300毫秒，而使用<code> buffer</code><br>操作符就可以并发运行流中发射元素的代码以及收集的代码，<br>当发射者发射数据时，收集者还没处理完，会将这个数据先缓存下来，收集者处理完上一个数据之后立马就可以处理下一个数据。这样除了第一个周期是300毫秒，接下来的每个周期都是200毫秒，会节省很多时间。<br>默认可以无限制添加数据，但是超出默认缓存区域大小时，会 <code>suspend</code> 暂停。<br><code>buffer()</code>  函数体可以传两个参数来自行定义缓存机制</p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">buffer(capacity: </span>Int = <span class="hljs-keyword">BUFFERED, </span>onBufferOverflow: <span class="hljs-keyword">BufferOverflow </span>= <span class="hljs-keyword">BufferOverflow.SUSPEND)</span><br></code></pre></td></tr></tbody></table></figure><p>前面的获取设备列表的演示就加上了buffer。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"start"</span>)<br><span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>getDevices().flowOn(Dispatchers.IO).conflate().collect {<br>    count++<br>    delay(<span class="hljs-number">200</span>)<br>    println(<span class="hljs-string">"获取到 <span class="hljs-subst">${it.size}</span> 个设备，开始更新列表"</span>)<br>}<br>println(<span class="hljs-string">"end, count: <span class="hljs-variable">$count</span>"</span>)<br></code></pre></td></tr></tbody></table></figure><h4 id="conflate-操作符"><a href="#conflate-操作符" class="headerlink" title="conflate 操作符"></a>conflate 操作符</h4><p>用了 <code>conflate</code> 操作符，当发射者发射数据时，收集者还在处理上一个数据时则会跳过这个值，上面例子中<code>buffer()</code><br>改成 <code>conflate()</code> 接口如下：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"start"</span>)<br><span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>getDevices().flowOn(Dispatchers.IO).conflate().collect {<br>    count++<br>    delay(<span class="hljs-number">200</span>)<br>    println(<span class="hljs-string">"获取到 <span class="hljs-subst">${it.size}</span> 个设备，开始更新列表"</span>)<br>}<br>println(<span class="hljs-string">"end, count: <span class="hljs-variable">$count</span>"</span>)<br></code></pre></td></tr></tbody></table></figure><p>输出结果：</p><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">... ...<br>获取到 <span class="hljs-number">1000</span> 个设备，开始更新列表<br><span class="hljs-keyword">end</span>, <span class="hljs-built_in">count</span>: <span class="hljs-number">11</span><br></code></pre></td></tr></tbody></table></figure><p>只处理了11个</p><h4 id="collectLatest-操作符"><a href="#collectLatest-操作符" class="headerlink" title="collectLatest()操作符"></a>collectLatest()操作符</h4><p>只处理最新的数据，这看上去似乎与 conflate 没有区别，其实区别大了：它并不会直接用新数据覆盖老数据，而是每一个都会被处理，只不过如果前一个还没被处理完后一个就来了的话，处理前一个数据的逻辑就会被取消。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>getDevices().flowOn(Dispatchers.IO).collectLatest {<br>    delay(<span class="hljs-number">500</span>)<br>    count++<br>    println(<span class="hljs-string">"获取到 <span class="hljs-subst">${it.size}</span> 个设备，开始更新列表"</span>)<br>}<br>println(<span class="hljs-string">"end, count: <span class="hljs-variable">$count</span>"</span>)<br></code></pre></td></tr></tbody></table></figure><p>处理的时候延时500毫秒，而发送间隔只有100毫秒，所以每次发送时都会把前面的处理取消掉，因此只有最后一个结果能被处理</p><figure class="highlight xquery"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xquery"><span class="hljs-keyword">start</span><br>获取到 <span class="hljs-number">1000</span> 个设备，开始更新列表<br><span class="hljs-keyword">end</span>,<span class="hljs-built_in"> count</span>: <span class="hljs-number">1</span><br></code></pre></td></tr></tbody></table></figure><h3 id="组合多个流"><a href="#组合多个流" class="headerlink" title="组合多个流"></a>组合多个流</h3><h4 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h4><p><code>zip</code> 操作符可以组合两个流中的相关值：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> nums = (<span class="hljs-number">1.</span><span class="hljs-number">.6</span>).onEach {<br>    delay(<span class="hljs-number">10</span>)<br>}.asFlow() <span class="hljs-comment">// 数字 1..3</span><br><span class="hljs-keyword">val</span> strs = flowOf(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>).onEach {<br>    delay(<span class="hljs-number">50</span>)<br>} <span class="hljs-comment">// 字符串</span><br>nums.zip(strs) { a, b -&gt;<br>    <span class="hljs-string">"<span class="hljs-variable">$a</span> -&gt; <span class="hljs-variable">$b</span>"</span> <br>}.collect { <br>    println(it) <br>}<br></code></pre></td></tr></tbody></table></figure><p>输出结果</p><figure class="highlight basic"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>-&gt; one<br><span class="hljs-symbol">2 </span>-&gt; two<br><span class="hljs-symbol">3 </span>-&gt; three<br></code></pre></td></tr></tbody></table></figure><h4 id="Combine"><a href="#Combine" class="headerlink" title="Combine"></a>Combine</h4><p>当流表示一个变量或操作的最新值时，可能需要执行计算，这依赖于相应流的最新值，并且每当上游流产生值的时候都需要重新计算。<br>也就是说当两个流中任何一个流产生了新的流的时候，并且这两个流都已经有值发射了，就将这两个流当前最新的值组合在一起。</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> nums = (<span class="hljs-number">1.</span><span class="hljs-number">.6</span>).asFlow().onEach {<br>    delay(<span class="hljs-number">10</span>)<br>} <br><span class="hljs-keyword">val</span> strs = flowOf(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>).onEach {<br>    delay(<span class="hljs-number">50</span>)<br>}<br>nums.combine(strs) { a, b -&gt;<br>    <span class="hljs-string">"<span class="hljs-variable">$a</span> -&gt; <span class="hljs-variable">$b</span>"</span><br>}.collect {<br>    println(it)<br>}<br></code></pre></td></tr></tbody></table></figure><p>输出结果</p><figure class="highlight basic"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">4 </span>-&gt; one<br><span class="hljs-symbol">5 </span>-&gt; one<br><span class="hljs-symbol">6 </span>-&gt; one<br><span class="hljs-symbol">6 </span>-&gt; two<br><span class="hljs-symbol">6 </span>-&gt; three<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kotlin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kotlin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kotlin 扩展函数</title>
    <link href="/2023/08/21/docs/kotlin/kotlin-kuo-zhan-han-shu/"/>
    <url>/2023/08/21/docs/kotlin/kotlin-kuo-zhan-han-shu/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h3 id="内置扩展函数"><a href="#内置扩展函数" class="headerlink" title="内置扩展函数"></a><strong>内置扩展函数</strong></h3><h4 id="IO操作扩展函数"><a href="#IO操作扩展函数" class="headerlink" title="IO操作扩展函数"></a>IO操作扩展函数</h4><h5 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h5><p>复制文件A到文件B</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> originFile = File(<span class="hljs-string">"<span class="hljs-variable">$TEST_PATH</span>\\copytest1.txt"</span>)<br><span class="hljs-keyword">val</span> dstFile = File(<span class="hljs-string">"<span class="hljs-variable">$TEST_PATH</span>\\copytest2.txt"</span>)<br></code></pre></td></tr></tbody></table></figure><p>常规写法</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> inputStream = FileInputStream(originFile)<br><span class="hljs-keyword">val</span> os = FileOutputStream(dstFile)<br><span class="hljs-keyword">try</span> {<br>    <span class="hljs-keyword">val</span> buffer = ByteArray(<span class="hljs-number">1024</span>)<br>    <span class="hljs-keyword">var</span> len = inputStream.read(buffer)<br>    <span class="hljs-keyword">while</span> (len != -<span class="hljs-number">1</span>) {<br>        os.write(buffer, <span class="hljs-number">0</span>, len)<br>        len = inputStream.read(buffer)<br>    }<br>} <span class="hljs-keyword">finally</span> {<br>    os.flush()<br>    os.close()<br>    inputStream.close()<br>}<br></code></pre></td></tr></tbody></table></figure><p><code>use</code> 结合扩展函数<code>InputStream.copyTo()</code>写法</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> inputStream = FileInputStream(originFile)<br><span class="hljs-keyword">val</span> os = FileOutputStream(dstFile)<br>inputStream.use {<br>    os.use { output -&gt;<br>        it.copyTo(output)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>使用 <code>File.copyTo()</code>扩展函数直接复制</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">try</span> {<br>    originFile.copyTo(dstFile)<br>} <span class="hljs-keyword">catch</span> (e: Throwable) {<br>    e.printStackTrace()<br>}<br></code></pre></td></tr></tbody></table></figure><h5 id="遍历文件"><a href="#遍历文件" class="headerlink" title="遍历文件"></a>遍历文件</h5><p>遍历文件夹下所有文件包括子目录，子文件等</p><p><code>File.walkBottomUp()</code><br>获取从下到上的顺序访问此目录及其所有内容的顺序。使用深度优先搜索，并在访问所有文件之前访问目录</p><p><code>File.walkTopDown()</code><br>获取从上到下的顺序访问此目录及其所有内容的顺序。使用深度优先搜索，并在访问所有文件之前访问目录</p><figure class="highlight isbl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">val</span> <span class="hljs-variable">path</span> = <span class="hljs-function"><span class="hljs-title">File</span>(<span class="hljs-string">"E:\\Note\\MarkDown"</span>)</span><br><span class="hljs-variable">val</span> <span class="hljs-variable">files</span> = <span class="hljs-variable">path.walkBottomUp</span>()<br><span class="hljs-function"><span class="hljs-title">println</span>(<span class="hljs-string">"walkBottomUp"</span>)</span><br><span class="hljs-variable">files.<span class="hljs-keyword">forEach</span></span> {<br>    <span class="hljs-function"><span class="hljs-title">println</span>(<span class="hljs-variable">it.path</span>)</span><br>}<br></code></pre></td></tr></tbody></table></figure><h5 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h5><p><code>File.deleteRecursively()</code></p><p>删除文件夹下所有文件，包括子目录、子文件</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">val</span> path = <span class="hljs-constructor">File(<span class="hljs-string">"$TEST_PATH\\testDelete - 副本\\"</span>)</span><br><span class="hljs-keyword">val</span> result = path.delete<span class="hljs-constructor">Recursively()</span><br></code></pre></td></tr></tbody></table></figure><p>函数返回 true 表示全部删除完成，返回 false 表示至少有一个文件没有删除成功</p><h3 id="自定义扩展函数"><a href="#自定义扩展函数" class="headerlink" title="自定义扩展函数"></a><strong>自定义扩展函数</strong></h3><p>自定义一个List交换两个元素位置的函数</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> MutableList<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">swap</span><span class="hljs-params">(index1: <span class="hljs-type">Int</span>, index2: <span class="hljs-type">Int</span>)</span></span> {<br>    <span class="hljs-keyword">if</span> (index1 &gt; <span class="hljs-keyword">this</span>.size - <span class="hljs-number">1</span> || index2 &gt; <span class="hljs-keyword">this</span>.size - <span class="hljs-number">1</span>) {<br>        <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"index is more than list's size"</span>)<br>    }<br>    <span class="hljs-keyword">val</span> temp = <span class="hljs-keyword">this</span>[index1]<br>    <span class="hljs-keyword">this</span>[index1] = <span class="hljs-keyword">this</span>[index2]<br>    <span class="hljs-keyword">this</span>[index2] = temp<br>}<br><br><span class="hljs-meta">@org</span>.junit.jupiter.api.Test<br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">listSwap</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">val</span> list = mutableListOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br>    println(<span class="hljs-string">"origin: <span class="hljs-variable">$list</span>"</span>)<br>    list.swap(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>    println(<span class="hljs-string">"after swap: <span class="hljs-subst">${list}</span>"</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><p>测试执行结果：</p><figure class="highlight inform7"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs inform7">origin: <span class="hljs-comment">[1, 2, 3, 4, 5]</span><br>after swap: <span class="hljs-comment">[1, 2, 4, 3, 5]</span><br></code></pre></td></tr></tbody></table></figure><p>扩展函数在不修改某个类源码的情况下,动态地添加新的函数.className.<br>扩展函数不能访问原有类的私有属性</p><h3 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a><strong>运算符重载</strong></h3><p>同一运算符在不同的环境所表现的效果不同，如 ”+“ 在两个 Int<br>值之间表示两者的数值相加，在两个字符串之间表示，将字符串拼接，同时kotlin允许我们将任意两个类型的对象进行”+“运算，或者其他运算符操作。</p><p>语法结构：如下，其中<code>operator</code> 为运算符重载的关键字</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">plus</span><span class="hljs-params">(a: <span class="hljs-type">A</span>)</span></span>: A {<br>    <span class="hljs-comment">//相关逻辑</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>常见的语法糖表达式和实际调用函数对照表：</p><table><thead><tr><th>表达式</th><th>函数名</th></tr></thead><tbody><tr><td>a * b</td><td>a.times(b)</td></tr><tr><td>a / b</td><td>a.div(b)</td></tr><tr><td>a % b</td><td>a.rem(b)</td></tr><tr><td>a + b</td><td>a.plus(b)</td></tr><tr><td>a - b</td><td>a.minus(b)</td></tr><tr><td>a++</td><td>a.inc()</td></tr><tr><td>a–</td><td>a.dec()</td></tr><tr><td>!a</td><td>a.not()</td></tr><tr><td>a == b</td><td>a.equals(b)</td></tr><tr><td>”a &gt; b“、”a &lt; b“、”a &gt;= b“、”a &gt;= b“</td><td>a.compareTo(b)</td></tr><tr><td>a..b</td><td>a.rangeTo(b)</td></tr><tr><td>a[b]</td><td>a.get(b)</td></tr><tr><td>a[b] = c</td><td>a.set(b, c)</td></tr><tr><td>a in b</td><td>b.contains(a)</td></tr></tbody></table><h4 id="扩展函数和运算符重载结合"><a href="#扩展函数和运算符重载结合" class="headerlink" title="扩展函数和运算符重载结合"></a>扩展函数和运算符重载结合</h4><p>例：重写 String 的 * （即 times) 操作</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">times</span><span class="hljs-params">(int: <span class="hljs-type">Int</span>)</span></span>: String {<br>    <span class="hljs-keyword">return</span> StringBuilder().also { s -&gt;<br>        repeat(int) {<br>            s.append(<span class="hljs-keyword">this</span>)<br>        }<br>    }.toString()<br>}<br></code></pre></td></tr></tbody></table></figure><p>使用</p><figure class="highlight isbl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">val</span> <span class="hljs-variable">s</span> = <span class="hljs-string">"hello "</span> * <span class="hljs-number">5</span><br><span class="hljs-function"><span class="hljs-title">println</span>(<span class="hljs-variable">s</span>)</span><br></code></pre></td></tr></tbody></table></figure><p>结果</p><figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hello hello hello hello hello</span> <br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kotlin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kotlin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kotlin 标准函数</title>
    <link href="/2023/08/21/docs/kotlin/kotlin-biao-zhun-han-shu/"/>
    <url>/2023/08/21/docs/kotlin/kotlin-biao-zhun-han-shu/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h2 id="Kotlin标准函数"><a href="#Kotlin标准函数" class="headerlink" title="Kotlin标准函数"></a><strong>Kotlin标准函数</strong></h2><h3 id="let函数"><a href="#let函数" class="headerlink" title="let函数"></a><strong>let函数</strong></h3><p>let函数会将调用它的对象作为参数传递到Lambda表达式中。</p><p>例如有如下方法</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doStudy</span><span class="hljs-params">(study: <span class="hljs-type">Study</span>)</span></span>{ <span class="hljs-comment">//Study接口中只有readBooks()和doHomeWork()两个方法</span><br>    <span class="hljs-keyword">if</span> (study != <span class="hljs-literal">null</span>){<br>        study.readBooks()<br>    }<br>    <span class="hljs-keyword">if</span> (study != <span class="hljs-literal">null</span>){<br>        study.doHomeWork()<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure><p>这个时候结合?.操作符合let函数就可以对代码进行优化了，如下所示</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doStudy</span><span class="hljs-params">(study: <span class="hljs-type">Study</span>)</span></span>{<br>    <span class="hljs-comment">//?.操作符表示对象不为空时正常调用相应的方法，对象为空时就什么都不做</span><br>    study?.let {stu -&gt;<br>        stu.readBooks() <span class="hljs-comment">//因为let函数可以正常调用，所以对象一定不为空</span><br>        stu.doHomeWork()<br>    }<br>}          <br></code></pre></td></tr></tbody></table></figure><p>然后利用Lambda语言的特性：当Lambda表达式的参数列表中只有一个参数时，可以不用声明参数名，直接用it关键字代替即可。那么代码就可以进一步简化</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doStudy</span><span class="hljs-params">(study: <span class="hljs-type">Study</span>)</span></span>{<br>    study?.let {<br>        it.readBooks()<br>        it.doHomeWork()<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure><p>注意： let函数是可以处理全局变量判空的问题的，而if判断语句则无法做到这一点，比如我们将doStudy()<br>函数中的参数变成一个全局变量，使用let函数仍然可以正常工作，但使用if判空语句就会提示错误，代码如下所示：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> study: Study? = <span class="hljs-literal">null</span><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doStudy</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">if</span> (study != <span class="hljs-literal">null</span>) {<br>        study.doHomeWork() <span class="hljs-comment">//这里会报错，下面一行也是</span><br>        study.readBooks()<br>        <span class="hljs-comment">//</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>调用study的方法会报错是因为全局变量的值随时都可能被其他线程所修改，即使做了判空处理仍然无法保证if语句中的study对象没有空指针的风险。</p><h3 id="with函数"><a href="#with函数" class="headerlink" title="with函数"></a><strong>with函数</strong></h3><p>with函数<br>接收两个参数：第一个参数可以是一个任意类型的对象，第二个参数是一个Lambda表达式。with函数会在Lambda表达式中提供第一个参数对象的上下文，并使用Lambda表达式的最后一行作为返回值返回。它可以在连续调用同一个对象的多个方法时让代码变得更加精简。</p><p>举个例子： 比如有一个水果列表，现在我们想吃完所有水果，并将结果答应出来，就可以这样写</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>, <span class="hljs-string">"Pear"</span>)<br><span class="hljs-keyword">val</span> builder = StringBuilder()<br>builder.append(<span class="hljs-string">"Start eating fruits.\n"</span>)<br><span class="hljs-keyword">for</span> (fruit <span class="hljs-keyword">in</span> list){ <br>    builder.append(fruit).append(<span class="hljs-string">"\n"</span>)<br>}<br>builder.append(<span class="hljs-string">"Ate all fruits"</span>)<br><span class="hljs-keyword">val</span> result = builder.toString()<br>println(result)<br><br></code></pre></td></tr></tbody></table></figure><p>上面代码，连续调用了多次builder对象的方法，这时候就可以考虑使用with函数了来让代码变得更加精简了。如下所示</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>, <span class="hljs-string">"Pear"</span>)<br><span class="hljs-keyword">val</span> builder = StringBuilder()<br><span class="hljs-keyword">val</span> result = with(StringBuilder()){<br>    append(<span class="hljs-string">"Start eating fruits.\n"</span>)<br>    <span class="hljs-keyword">for</span> (fruit <span class="hljs-keyword">in</span> list){<br>        append(fruit).append(<span class="hljs-string">"\n"</span>)<br>    }<br>    append(<span class="hljs-string">"Ate all fruits."</span>)<br>    toString()<br>}<br>println(result)<br></code></pre></td></tr></tbody></table></figure><p>这段代码其实也不难理解，首先我们给with函数第一个参数传入一个StringBuilder对象，那么接下来第二个参数也就是Lambda表达式的上下文就会是这个StringBuilder对象，于是我们在Lambda表达式中就不用使用builder.append()<br>的方式，而是直接使用append()的方式来调用，Lambda的最后一行会作为with函数的返回值返回，最终将结果打印出来，两段代码运行结果是一样的</p><h3 id="run函数"><a href="#run函数" class="headerlink" title="run函数"></a><strong>run函数</strong></h3><p>run函数的用法和使用场景其实和with函数斯非常类似的，只是稍微做了些语法改动而已。首先run函数是不能直接调用的，而是一定要调用某个对象的run函数才行；其次run函数只接收一个Lambda参数，并且会在Lambda表达式中提供调用对象的上下文。其他方面和with函数是一样的，也会使用Lambda表达式中的最后一行代码作为返回值返回。</p><p>现在可以用run函数来改一下吃水果的这段代码，如下所示：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>, <span class="hljs-string">"Pear"</span>)<br><span class="hljs-keyword">val</span> builder = StringBuilder()<br><span class="hljs-keyword">val</span> result = builder.run{<br>    append(<span class="hljs-string">"Start eating fruits.\n"</span>)<br>    <span class="hljs-keyword">for</span> (fruit <span class="hljs-keyword">in</span> list){<br>        append(fruit).append(<span class="hljs-string">"\n"</span>)<br>    }<br>    append(<span class="hljs-string">"Ate all fruits."</span>)<br>    toString()<br>}<br>println(result)<br><br></code></pre></td></tr></tbody></table></figure><p>总体来说变化非常小，只是将调用with函数并传入StringBuilder对象改成了调用StringBuilder对象的run方法，其他没有任何区别。两段代码运行结果都一样。</p><h3 id="apply函数"><a href="#apply函数" class="headerlink" title="apply函数"></a><strong>apply函数</strong></h3><p>apply函数和run函数也是极其类似的。都要在某个对象上调用，并且只接收一个Lambda参数，也会在Lambda表达式中提供调用对象的上下文，但是apply函数无法指定返回值，而是会返回调用对象本身。</p><p>那么现在用apply函数来改写吃水果这段代码，如下所示：</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> list = listOf(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Orange"</span>, <span class="hljs-string">"Pear"</span>)<br><span class="hljs-keyword">val</span> builder = StringBuilder()<br><span class="hljs-keyword">val</span> result = builder.apply{<br>    append(<span class="hljs-string">"Start eating fruits.\n"</span>)<br>    <span class="hljs-keyword">for</span> (fruit <span class="hljs-keyword">in</span> list){<br>        append(fruit).append(<span class="hljs-string">"\n"</span>)<br>    }<br>    append(<span class="hljs-string">"Ate all fruits."</span>)<br>}<br>println(result.toString())<br>              <br></code></pre></td></tr></tbody></table></figure><p>注意这里的代码变化，因为apply函数无法指定返回值，只能返回调用对象本身，因此这里的result实际上是一个StringBuilder对象。所以我们在最后打印的时候还要调用它的toString()<br>方法才行。这段代码运行结果和前面两段仍然完全相同。</p><h3 id="also函数"><a href="#also函数" class="headerlink" title="also函数"></a><strong>also函数</strong></h3><p>also函数和apply函数用法基本一致的。要在某个对象上调用，并且返回调用对象本身。只不过also函数在lambda中要用一个名称（默认为<br>it），在 apply中，不必添加其他前缀来访问其成员，或者使用 this引用 .</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">am.also {<br><span class="hljs-comment">//使用 it 来调用对象</span><br>it.xxx()<br>}<br>am.apply {<br><br><span class="hljs-comment">//使用 this 来调用对象 或者 直接调用对象</span><br><span class="hljs-keyword">this</span>.xxx()<br>xxx()<br>}<br></code></pre></td></tr></tbody></table></figure><p>小总结：</p><figure class="highlight coq"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-keyword">let</span>、run返回函数体最后一行<br><span class="hljs-built_in">apply</span>、also返回调用对象本身<br><span class="hljs-keyword">let</span>、also函数体调用时默认用 it<br>run、<span class="hljs-built_in">apply</span>函数体调用时默认用 this<br><span class="hljs-built_in">with</span>调用时需要传一个对象，返回函数体最后一行<br></code></pre></td></tr></tbody></table></figure><h3 id="use函数"><a href="#use函数" class="headerlink" title="use函数"></a><strong>use函数</strong></h3><p>使用<code>use</code>函数的对象要实现<code>Closeable</code>方法，并且无论接下来的操作是否引发异常都会自动正确关闭它，比如<code>InputStream</code><br>就可以使用<code>use</code>函数</p><p>常规写法</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> input:InputStream? = <span class="hljs-literal">null</span><br><span class="hljs-keyword">try</span>{<br>input= FileInputStream(File(<span class="hljs-string">"aaaaa"</span>))<br><span class="hljs-comment">//对 input 进行操作</span><br><span class="hljs-comment">// ......</span><br>}finall{<br><span class="hljs-comment">//最后需要调用close（）</span><br>input?.close()<br>}<br></code></pre></td></tr></tbody></table></figure><p>使用use函数写法</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> input = FileInputStream(File(<span class="hljs-string">"aaaaa"</span>))<br>input?.use{<br><span class="hljs-comment">//对 input 进行操作</span><br><span class="hljs-comment">//不需要手动close</span><br>}<br></code></pre></td></tr></tbody></table></figure><p><code>use</code> 函数可以极大地简化文件操作的代码</p><h3 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a><strong>repeat</strong></h3><p>重复执行指定次数</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">repeat</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span></span>{ <br><span class="hljs-built_in">println</span>(<span class="hljs-string">"count:$it"</span>) <br>}<br></code></pre></td></tr></tbody></table></figure><p>等价于</p><figure class="highlight erlang"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs erlang"><span class="hljs-function"><span class="hljs-title">for</span> <span class="hljs-params">(i in <span class="hljs-number">0</span>..<span class="hljs-number">4</span>)</span> { </span><br><span class="hljs-function"><span class="hljs-title">println</span><span class="hljs-params">(<span class="hljs-string">"count:$i"</span>)</span> </span><br><span class="hljs-function">}</span><br></code></pre></td></tr></tbody></table></figure><p>或者</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> 0 <span class="hljs-keyword">until</span> 5) { <br>println(<span class="hljs-string">"count:<span class="hljs-variable">$i</span>"</span>) <br>}<br></code></pre></td></tr></tbody></table></figure><p>或者</p><figure class="highlight isbl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl">(<span class="hljs-number">0</span>..<span class="hljs-number">4</span>).<span class="hljs-keyword">forEach</span> { <br> <span class="hljs-function"><span class="hljs-title">println</span>(<span class="hljs-string">"count:$i"</span>) </span><br><span class="hljs-function">}</span><br></code></pre></td></tr></tbody></table></figure><h3 id="takeIf-和-takeUnless"><a href="#takeIf-和-takeUnless" class="headerlink" title="**takeIf  和 takeUnless **"></a>**takeIf  和 takeUnless **</h3><p><code>takeIf</code> 传递一个函数参数，如果函数结果为true，返回T对象，否则返回null<br>例如，判断文件是否存在，不存在则返回</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">var</span> <span class="hljs-keyword">file</span> = <span class="hljs-keyword">File</span>(<span class="hljs-string">"filePath"</span>)<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">file</span>.exists()) {<br> <span class="hljs-comment">//do something</span><br>} <span class="hljs-keyword">else</span> {<br> <span class="hljs-keyword">return</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>使用<code>takeIf</code>:</p><figure class="highlight axapta"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-built_in">var</span> file = File(<span class="hljs-string">"filePath"</span>).takeIf { it.<span class="hljs-keyword">exists</span>() }?:<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br><span class="hljs-comment">//do something</span><br></code></pre></td></tr></tbody></table></figure><p><code>takeUnless</code> 传递一个函数参数，如果函数结果为false，返回T对象，否则返回null</p>]]></content>
    
    
    <categories>
      
      <category>Kotlin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kotlin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kotlin知识点汇总</title>
    <link href="/2023/08/21/docs/kotlin/kotlin-zhi-shi-dian-hui-zong/"/>
    <url>/2023/08/21/docs/kotlin/kotlin-zhi-shi-dian-hui-zong/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#%E5%AF%B9%E8%B1%A1">对象</a></li><li><a href="#%E7%B1%BB">类</a></li><li><a href="#%E7%BB%A7%E6%89%BF">继承</a></li><li><a href="#%E5%8F%98%E9%87%8F">变量</a></li><li><a href="#%E5%B8%B8%E9%87%8F">常量</a></li><li><a href="#%E9%9D%99%E6%80%81%E5%B8%B8%E9%87%8F">静态常量</a></li><li><a href="#%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95">定义方法</a></li><li><a href="#%E9%87%8D%E8%BD%BD%E6%96%B9%E6%B3%95">重载方法</a></li><li><a href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">基本数据类型</a></li><li><a href="#%E6%AF%94%E8%BE%83%E7%B1%BB%E5%9E%8B">比较类型</a></li><li><a href="#%E8%BD%AC%E6%8D%A2%E7%AC%A6">转换符</a></li><li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%AF%94%E8%BE%83">字符串比较</a></li><li><a href="#%E6%95%B0%E7%BB%84">数组</a></li><li><a href="#%E5%BE%AA%E7%8E%AF">循环</a></li><li><a href="#%E8%A7%92%E6%A0%87%E5%BE%AA%E7%8E%AF">角标循环</a></li><li><a href="#%E9%AB%98%E7%BA%A7%E5%BE%AA%E7%8E%AF">高级循环</a></li><li><a href="#%E5%88%A4%E6%96%AD%E5%99%A8">判断器</a></li><li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">构造函数</a></li><li><a href="#%E7%B1%BB%E5%88%9B%E5%BB%BA">类创建</a></li><li><a href="#%E7%A7%81%E6%9C%89%E5%8C%96-set-%E6%96%B9%E6%B3%95">私有化 set 方法</a></li><li><a href="#%E7%A7%81%E6%9C%89%E5%8C%96-get-%E6%96%B9%E6%B3%95">私有化 get 方法</a></li><li><a href="#%E6%9E%9A%E4%B8%BE">枚举</a></li><li><a href="#%E6%8E%A5%E5%8F%A3">接口</a></li><li><a href="#%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB">匿名内部类</a></li><li><a href="#%E5%86%85%E9%83%A8%E7%B1%BB">内部类</a></li><li><a href="#%E5%86%85%E9%83%A8%E7%B1%BB%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%B1%BB%E5%90%8C%E5%90%8D%E5%8F%98%E9%87%8F">内部类访问外部类同名变量</a></li><li><a href="#%E6%8A%BD%E8%B1%A1%E7%B1%BB">抽象类</a></li><li><a href="#%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F%E5%92%8C%E6%96%B9%E6%B3%95">静态变量和方法</a></li><li><a href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0">可变参数</a></li><li><a href="#%E6%B3%9B%E5%9E%8B">泛型</a></li><li><a href="#%E6%9E%84%E9%80%A0%E4%BB%A3%E7%A0%81%E5%9D%97">构造代码块</a></li><li><a href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E5%9D%97">静态代码块</a></li><li><a href="#%E6%96%B9%E6%B3%95%E4%BB%A3%E7%A0%81%E5%9D%97">方法代码块</a></li><li><a href="#%E5%8F%AF%E8%A7%81%E4%BF%AE%E9%A5%B0%E7%AC%A6">可见修饰符</a></li><li><a href="#%E6%97%A0%E9%9C%80-findViewById">无需 findViewById</a></li><li><a href="#Lambda">Lambda</a></li><li><a href="#%E5%87%BD%E6%95%B0%E5%8F%98%E9%87%8F">函数变量</a></li><li><a href="#%E7%A9%BA%E5%AE%89%E5%85%A8">空安全</a></li><li><a href="#%E6%96%B9%E6%B3%95%E6%94%AF%E6%8C%81%E6%B7%BB%E5%8A%A0%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0">方法支持添加默认参数</a></li><li><a href="#%E7%B1%BB%E6%96%B9%E6%B3%95%E6%89%A9%E5%B1%95">类方法扩展</a></li><li><a href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD">运算符重载</a></li><li><a href="#%E6%89%A9%E5%B1%95%E5%87%BD%E6%95%B0">扩展函数</a><ul><li><a href="#let-%E5%87%BD%E6%95%B0">let 函数</a></li><li><a href="#with-%E5%87%BD%E6%95%B0">with 函数</a></li><li><a href="#run-%E5%87%BD%E6%95%B0">run 函数</a></li><li><a href="#apply-%E5%87%BD%E6%95%B0">apply 函数</a></li><li><a href="#also-%E5%87%BD%E6%95%B0">also 函数</a></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ul></li><li><a href="#%E5%8D%8F%E7%A8%8B">协程</a></li></ul><h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MainActivity.<span class="hljs-built_in">this</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">this</span><span class="hljs-symbol">@MainActivity</span><br></code></pre></td></tr></tbody></table></figure><h1 id="类"><a href="#类" class="headerlink" title="类"></a>类</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MainActivity.class<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">MainActivity::<span class="hljs-keyword">class</span>.java<br></code></pre></td></tr></tbody></table></figure><h1 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（在 Kotlin 中被继承类必须被 open 关键字修饰）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> intent = Intent()<br></code></pre></td></tr></tbody></table></figure><h1 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> text = <span class="hljs-string">""</span><br></code></pre></td></tr></tbody></table></figure><h1 id="静态常量"><a href="#静态常量" class="headerlink" title="静态常量"></a>静态常量</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（需要注意的是要把静态变量定义在类上方）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> text = <span class="hljs-string">""</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="定义方法"><a href="#定义方法" class="headerlink" title="定义方法"></a>定义方法</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(String message)</span> {<br><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（Unit 跟 void 一样效果）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">(message : <span class="hljs-type">String</span>)</span></span> : <span class="hljs-built_in">Unit</span> {<br><br>}<br><span class="hljs-comment">// 在 Kotlin 可以省略 Unit 这种返回值</span><br><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">(message : <span class="hljs-type">String</span>)</span></span> {<br><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="重载方法"><a href="#重载方法" class="headerlink" title="重载方法"></a>重载方法</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-type">float</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-type">double</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-string">'A'</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"text"</span>;<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> i : <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span><br><span class="hljs-keyword">var</span> l : <span class="hljs-built_in">Long</span> = <span class="hljs-number">2</span><br><span class="hljs-keyword">var</span> b : <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span><br><span class="hljs-keyword">var</span> f : <span class="hljs-built_in">Float</span> = <span class="hljs-number">0F</span><br><span class="hljs-keyword">var</span> d : <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span><br><span class="hljs-keyword">var</span> c : <span class="hljs-built_in">Char</span> = <span class="hljs-string">'A'</span><br><span class="hljs-keyword">var</span> s : String = <span class="hljs-string">"text"</span><br><span class="hljs-comment">// 更简洁点可以这样，自动推倒类型</span><br><span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span><br><span class="hljs-keyword">var</span> l = <span class="hljs-number">2</span><br><span class="hljs-keyword">var</span> b = <span class="hljs-literal">true</span><br><span class="hljs-keyword">var</span> f = <span class="hljs-number">0F</span><br><span class="hljs-keyword">var</span> d = <span class="hljs-number">0.0</span><br><span class="hljs-keyword">var</span> c = <span class="hljs-string">'A'</span><br><span class="hljs-keyword">var</span> s = <span class="hljs-string">"text"</span><br></code></pre></td></tr></tbody></table></figure><h1 id="比较类型"><a href="#比较类型" class="headerlink" title="比较类型"></a>比较类型</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">""</span> <span class="hljs-keyword">instanceof</span> String) {<br><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">if</span> (<span class="hljs-string">""</span> <span class="hljs-keyword">is</span> String) {<br><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="转换符"><a href="#转换符" class="headerlink" title="转换符"></a>转换符</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>System.out.println(String.format(<span class="hljs-string">"商品数量有%d"</span>, number));<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> number = <span class="hljs-number">100</span><br>println(<span class="hljs-string">"商品数量有<span class="hljs-subst">${number}</span>"</span>)<br><span class="hljs-comment">// 换种简洁的写法</span><br><span class="hljs-keyword">var</span> number = <span class="hljs-number">100</span><br>println(<span class="hljs-string">"商品数量有<span class="hljs-variable">$number</span>"</span>)<br><span class="hljs-comment">// 如果不想字符串被转义可以使用\$</span><br><span class="hljs-keyword">var</span> number = <span class="hljs-number">100</span><br>println(<span class="hljs-string">"商品数量有\$number"</span>)<br></code></pre></td></tr></tbody></table></figure><h1 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"text"</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"text"</span>;<br><span class="hljs-keyword">if</span> (s1.equals(s2)) {<br>    <br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（Kotlin 对字符串比较的写法进行优化了，其他类型对象对比还是要用 equals 方法）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> s1 = <span class="hljs-string">"text"</span><br><span class="hljs-keyword">var</span> s2 = <span class="hljs-string">"text"</span><br><span class="hljs-keyword">if</span> (s1 == s2) {<br><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span>[] array1 = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};<br><span class="hljs-type">float</span>[] array2 = {<span class="hljs-number">1f</span>, <span class="hljs-number">2f</span>, <span class="hljs-number">3f</span>};<br>String[] array3 = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>};<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> array1 = intArrayOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><span class="hljs-keyword">val</span> array2 = floatArrayOf(<span class="hljs-number">1f</span>, <span class="hljs-number">2f</span>, <span class="hljs-number">3f</span>)<br><span class="hljs-keyword">val</span> array3 = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br></code></pre></td></tr></tbody></table></figure><h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] array = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>};<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; array.length; i++) {<br>    System.out.println(array[i]);<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> array = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br><br><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> array.indices) {<br>    println(array[i])<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="角标循环"><a href="#角标循环" class="headerlink" title="角标循环"></a>角标循环</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] array = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>};<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; array.length; i++) {<br>    System.out.println(array[i]);<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（这种写法在 Kotlin 中称之为区间）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> array = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br><br><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> IntRange(<span class="hljs-number">1</span>, array.size - <span class="hljs-number">1</span>)) {<br>    println(array[i])<br>}<br><span class="hljs-comment">// 换种更简洁的写法</span><br><span class="hljs-keyword">val</span> array = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br><br><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.array.size - <span class="hljs-number">1</span>) {<br>    println(array[i])<br>}<br><span class="hljs-comment">// 编译器提示要我们换种写法</span><br><span class="hljs-keyword">val</span> array = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br><br><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> until array.size) {<br>    println(array[i])<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="高级循环"><a href="#高级循环" class="headerlink" title="高级循环"></a>高级循环</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] array = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>};<br><br><span class="hljs-keyword">for</span> (String text : array) {<br>    System.out.println(text);<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> array = arrayListOf(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>)<br><br><span class="hljs-keyword">for</span> (text <span class="hljs-keyword">in</span> array) {<br>    println(text)<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="判断器"><a href="#判断器" class="headerlink" title="判断器"></a>判断器</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">switch</span> (count) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>        System.out.println(count);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        System.out.println(count);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        System.out.println(count);<br>        <span class="hljs-keyword">break</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> count = <span class="hljs-number">1</span><br><br><span class="hljs-keyword">when</span> (count) {<br>    <span class="hljs-number">0</span> -&gt; {<br>        println(count)<br>    }<br>    <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.2</span> -&gt; {<br>        println(count)<br>    }<br>    <span class="hljs-keyword">else</span> -&gt; {<br>        println(count)<br>    }<br>}<br><span class="hljs-keyword">var</span> count = <span class="hljs-number">1</span><br><br><span class="hljs-comment">// 换种更简洁的写法</span><br><span class="hljs-keyword">when</span> (count) {<br>    <span class="hljs-number">0</span> -&gt; println(count)<br>    <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.2</span> -&gt; println(count)<br>    <span class="hljs-keyword">else</span> -&gt; println(count)<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyView</span><span class="hljs-params">(Context context)</span> {<br>        <span class="hljs-built_in">this</span>(context, <span class="hljs-literal">null</span>);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyView</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {<br>        <span class="hljs-built_in">this</span>(context, attrs, <span class="hljs-number">0</span>);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyView</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {<br>        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyView</span> : <span class="hljs-type">View</span> {<br><br>    <span class="hljs-keyword">constructor</span>(context : Context) : <span class="hljs-keyword">this</span>(context, <span class="hljs-literal">null</span>) {<br><br>    }<br><br>    <span class="hljs-keyword">constructor</span>(context : Context, attrs : AttributeSet?) : <span class="hljs-keyword">this</span>(context, attrs, <span class="hljs-number">0</span>) {<br><br>    }<br><br>    <span class="hljs-keyword">constructor</span>(context : Context, attrs : AttributeSet?, defStyleAttr : <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">super</span>(context, attrs, defStyleAttr) {<br><br>    }<br>}<br><span class="hljs-comment">// 换种更简洁的写法</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyView</span> : <span class="hljs-type">View</span> {<br><br>    <span class="hljs-keyword">constructor</span>(context : Context) : <span class="hljs-keyword">this</span>(context, <span class="hljs-literal">null</span>)<br><br>    <span class="hljs-keyword">constructor</span>(context : Context, attrs : AttributeSet?) : <span class="hljs-keyword">this</span>(context, attrs, <span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">constructor</span>(context : Context, attrs : AttributeSet?, defStyleAttr : <span class="hljs-built_in">Int</span>) : <span class="hljs-keyword">super</span>(context, attrs, defStyleAttr)<br>}<br><span class="hljs-comment">// 只有一种构造函数的还可以这样写</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyView</span>(context: Context?) : View(context) {<br><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="类创建"><a href="#类创建" class="headerlink" title="类创建"></a>类创建</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    String name;<br>    <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> name;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> age;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br>}<br><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>);<br>person.setName(<span class="hljs-string">"ZJX"</span>);<br>person.setAge(<span class="hljs-number">50</span>);<br>System.out.println(<span class="hljs-string">"name: "</span> + person.getName() + <span class="hljs-string">", age: "</span> + person.getAge());<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（如果不想暴露成员变量的set方法，可以将 var 改成 val )</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    <span class="hljs-keyword">var</span> name : String? = <span class="hljs-literal">null</span><br>    <span class="hljs-keyword">get</span>() = field<br>    <span class="hljs-keyword">set</span>(value) {field = value}<br><br>    <span class="hljs-keyword">var</span> age : <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">get</span>() = field<br>    <span class="hljs-keyword">set</span>(value) {field = value}<br>}<br><span class="hljs-comment">// 换种更简洁的写法</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">var</span> name : String, <span class="hljs-keyword">var</span> age : <span class="hljs-built_in">Int</span>)<br><span class="hljs-keyword">var</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)<br>person.name = <span class="hljs-string">"ZJX"</span><br>person.age = <span class="hljs-number">50</span><br>println(<span class="hljs-string">"name: {<span class="hljs-variable">$person</span>.name}, age: {<span class="hljs-variable">$person</span>.age}"</span>)<br></code></pre></td></tr></tbody></table></figure><h1 id="私有化-set-方法"><a href="#私有化-set-方法" class="headerlink" title="私有化 set 方法"></a>私有化 set 方法</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    String name;<br>    <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> name;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> age;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    <span class="hljs-keyword">var</span> name : String? = <span class="hljs-literal">null</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span><br><br>    <span class="hljs-keyword">var</span> age : <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="私有化-get-方法"><a href="#私有化-get-方法" class="headerlink" title="私有化 get 方法"></a>私有化 get 方法</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    String name;<br>    <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> name;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {<br>        <span class="hljs-built_in">this</span>.name = name;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> age;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {<br>        <span class="hljs-built_in">this</span>.age = age;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> name : String? = <span class="hljs-literal">null</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> age : <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Sex</span> {<br><br>    MAN(<span class="hljs-literal">true</span>), WOMAN(<span class="hljs-literal">false</span>);<br><br>    Sex(<span class="hljs-type">boolean</span> isMan) {}<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sex</span> (<span class="hljs-keyword">var</span> isMan: <span class="hljs-built_in">Boolean</span>) {<br><br>    MAN(<span class="hljs-literal">true</span>), WOMAN(<span class="hljs-literal">false</span>)<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span> {<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFail</span><span class="hljs-params">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（Kotlin接口方法里面是可以自己实现，这里就不再演示了）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span> {<br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">()</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFail</span><span class="hljs-params">()</span></span><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">()</span> {<br>        <br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFail</span><span class="hljs-params">()</span> {<br><br>    }<br>};<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">object</span>:Callback {<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">()</span></span> {<br>        <br>    }<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFail</span><span class="hljs-params">()</span></span> {<br>        <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> {<br><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br><br>    <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> {<br>        <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="内部类访问外部类同名变量"><a href="#内部类访问外部类同名变量" class="headerlink" title="内部类访问外部类同名变量"></a>内部类访问外部类同名变量</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"CurvedBowZhang"</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> {<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ZJX"</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {<br>        System.out.println(name + <span class="hljs-string">"---"</span> + MainActivity.<span class="hljs-built_in">this</span>.name);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> name = <span class="hljs-string">"CurvedBowZhang"</span><br><br><span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> {<br><br>    <span class="hljs-keyword">var</span> name = <span class="hljs-string">"ZJX"</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> {<br>        println(name + <span class="hljs-string">"---"</span> + <span class="hljs-keyword">this</span><span class="hljs-symbol">@MainActivity</span>.name)<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {<br><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> : <span class="hljs-type">AppCompatActivity</span>(), Runnable {<br><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="静态变量和方法"><a href="#静态变量和方法" class="headerlink" title="静态变量和方法"></a>静态变量和方法</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ToastUtils</span> {<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Toast sToast;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {<br>        sToast.show();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法（在 Kotlin 将这种方式称之为伴生对象）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> ToastUtils {<br><br>    <span class="hljs-keyword">var</span> sToast : Toast? = <span class="hljs-literal">null</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> {<br>        sToast!!.show()<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span>... array)</span> {<br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i : array) {<br>        count += i;<br>    }<br>    <span class="hljs-keyword">return</span> count;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> array: <span class="hljs-type">Int</span>)</span></span> : <span class="hljs-built_in">Int</span> {<br>    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>    <span class="hljs-comment">//for (i in array) {</span><br>    <span class="hljs-comment">//    count += i</span><br>    <span class="hljs-comment">//}</span><br>    array.forEach {<br>        count += it<br>    }<br>    <span class="hljs-keyword">return</span> count<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bean</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">String</span>&gt; {<br><br>    T data;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Bean</span><span class="hljs-params">(T t)</span> {<br>        <span class="hljs-built_in">this</span>.data = t;<br>    }<br>}<br>Bean&lt;String&gt; bean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bean</span>&lt;&gt;(<span class="hljs-string">"666666"</span>);<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bean</span>&lt;<span class="hljs-type">T : Comparable&lt;String</span>&gt;&gt;(t: T) {<br>    <span class="hljs-keyword">var</span> <span class="hljs-keyword">data</span> = t<br>}<br><span class="hljs-keyword">var</span> bean = Bean&lt;String&gt;(<span class="hljs-string">"666666"</span>)<br><span class="hljs-comment">// 换种更简洁的写法</span><br><span class="hljs-keyword">var</span> bean = Bean(<span class="hljs-string">"666666"</span>)<br></code></pre></td></tr></tbody></table></figure><h1 id="构造代码块"><a href="#构造代码块" class="headerlink" title="构造代码块"></a>构造代码块</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-type">int</span> number;<br><br>    {<br>        number = <span class="hljs-number">1</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br><br>    <span class="hljs-keyword">var</span> number = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">init</span> {<br>        number = <span class="hljs-number">1</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="静态代码块"><a href="#静态代码块" class="headerlink" title="静态代码块"></a>静态代码块</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> number;<br><br>    <span class="hljs-keyword">static</span> {<br>        number = <span class="hljs-number">1</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {<br><br>    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {<br>        <br>        <span class="hljs-keyword">var</span> number = <span class="hljs-number">0</span><br>        <br>        <span class="hljs-keyword">init</span> {<br>            number = <span class="hljs-number">1</span><br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="方法代码块"><a href="#方法代码块" class="headerlink" title="方法代码块"></a>方法代码块</h1><blockquote><p>Java 的写法</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>{<br>    {<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Kotlin 的写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> {<br>    run {<br>        <span class="hljs-keyword">var</span> a =<span class="hljs-number">1</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h1 id="可见修饰符"><a href="#可见修饰符" class="headerlink" title="可见修饰符"></a>可见修饰符</h1><blockquote><p>Java 的写法（默认为 default）</p></blockquote><table><thead><tr><th align="center">修饰符</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">public</td><td align="center">所有类可见</td></tr><tr><td align="center">protected</td><td align="center">子类可见</td></tr><tr><td align="center">default</td><td align="center">同一包下的类可见</td></tr><tr><td align="center">private</td><td align="center">仅对自己类可见</td></tr></tbody></table><blockquote><p>Kotlin 的写法（默认为 public）</p></blockquote><table><thead><tr><th align="center">修饰符</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">public</td><td align="center">所有类可见</td></tr><tr><td align="center">internal</td><td align="center">同 Module 下的类可见</td></tr><tr><td align="center">protected</td><td align="center">子类可见</td></tr><tr><td align="center">private</td><td align="center">仅对自己类可见</td></tr></tbody></table><h1 id="无需-findViewById"><a href="#无需-findViewById" class="headerlink" title="无需 findViewById"></a>无需 findViewById</h1><blockquote><p>在布局中定义</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">&lt;TextView<br>    android:id=<span class="hljs-string">"@+id/tv_content"</span><br>    android:layout_width=<span class="hljs-string">"wrap_content"</span><br>    android:layout_height=<span class="hljs-string">"wrap_content"</span><br>    android:text=<span class="hljs-string">"Hello World!"</span> /&gt;<br></code></pre></td></tr></tbody></table></figure><blockquote><p>直接设置 TextView 的文本</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">tv_content.text = <span class="hljs-string">"改变文本"</span><br></code></pre></td></tr></tbody></table></figure><h1 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h1><blockquote><p>Lambda 表达式虽然在 Java JDK 已经加上了，但是没有普及开来，现在搭配 Kotlin 是一个不错的选择</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">tv_content.setOnClickListener(View.OnClickListener(<br><br>    <span class="hljs-function"><span class="hljs-title">fun</span><span class="hljs-params">(v : <span class="hljs-type">View</span>)</span></span> {<br>        v.visibility = View.GONE<br>    }<br>))<br></code></pre></td></tr></tbody></table></figure><blockquote><p>现在可以用 Lambda 表达式进行简化</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">tv_content.setOnClickListener { v -&gt; v.visibility = View.GONE }<br></code></pre></td></tr></tbody></table></figure><h1 id="函数变量"><a href="#函数变量" class="headerlink" title="函数变量"></a>函数变量</h1><blockquote><p>在 Kotlin 语法中函数是可以作为变量进行传递的</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> result = <span class="hljs-function"><span class="hljs-title">fun</span><span class="hljs-params">(number1 : <span class="hljs-type">Int</span>, number2 : <span class="hljs-type">Int</span>)</span></span> : <span class="hljs-built_in">Int</span> {<br>    <span class="hljs-keyword">return</span> number1 + number2<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>使用这个函数变量</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(result(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))<br></code></pre></td></tr></tbody></table></figure><h1 id="空安全"><a href="#空安全" class="headerlink" title="空安全"></a>空安全</h1><blockquote><p>在 Java 不用强制我们处理空对象，所以常常会导致 NullPointerException 空指针出现，现在 Kotlin<br>对空对象进行了限定，必须在编译时处理对象是否为空的情况，不然会编译不通过</p></blockquote><blockquote><p>在对象不可空的情况下，可以直接使用这个对象</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getText</span><span class="hljs-params">()</span></span> : String {<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"text"</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> text = getText()<br>print(text.length)<br></code></pre></td></tr></tbody></table></figure><blockquote><p>在对象可空的情况下，必须要判断对象是否为空</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getText</span><span class="hljs-params">()</span></span> : String? {<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> text = getText()<br><span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {<br>    print(text.length)<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 如果不想判断是否为空，可以直接这样，如果 text 对象为空，则会报空指针异常，一般情况下不推荐这样使用</span><br><span class="hljs-keyword">val</span> text = getText()<br>print(text!!.length)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 还有一种更好的处理方式，如果 text 对象为空则不会报错，但是 text.length 的结果会等于 null</span><br><span class="hljs-keyword">val</span> text = getText()<br>print(text?.length)<br></code></pre></td></tr></tbody></table></figure><h1 id="方法支持添加默认参数"><a href="#方法支持添加默认参数" class="headerlink" title="方法支持添加默认参数"></a>方法支持添加默认参数</h1><blockquote><p>在 Java 上，我们可能会为了扩展某个方法而进行多次重载</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toast</span><span class="hljs-params">(String text)</span> {<br>    toast(<span class="hljs-built_in">this</span>, text, Toast.LENGTH_SHORT);<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toast</span><span class="hljs-params">(Context context, String text)</span> {<br>    toast(context, text, Toast.LENGTH_SHORT);<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">toast</span><span class="hljs-params">(Context context, String text, <span class="hljs-type">int</span> time)</span> {<br>    Toast.makeText(context, text, time).show();<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">toast(<span class="hljs-string">"弹个吐司"</span>);<br>toast(<span class="hljs-built_in">this</span>, <span class="hljs-string">"弹个吐司"</span>);<br>toast(<span class="hljs-built_in">this</span>, <span class="hljs-string">"弹个吐司"</span>, Toast.LENGTH_LONG);<br></code></pre></td></tr></tbody></table></figure><blockquote><p>但是在 Kotlin 上面，我们无需进行重载，可以直接在方法上面直接定义参数的默认值</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toast</span><span class="hljs-params">(context : <span class="hljs-type">Context</span> = this, text : <span class="hljs-type">String</span>, time : <span class="hljs-type">Int</span> = Toast.LENGTH_SHORT)</span></span> {<br>    Toast.makeText(context, text, time).show()<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">toast(text = <span class="hljs-string">"弹个吐司"</span>)<br>toast(<span class="hljs-keyword">this</span>, <span class="hljs-string">"弹个吐司"</span>)<br>toast(<span class="hljs-keyword">this</span>, <span class="hljs-string">"弹个吐司"</span>, Toast.LENGTH_LONG)<br></code></pre></td></tr></tbody></table></figure><h1 id="类方法扩展"><a href="#类方法扩展" class="headerlink" title="类方法扩展"></a>类方法扩展</h1><blockquote><p>可以在不用继承的情况下对扩展原有类的方法，例如对 String 类进行扩展方法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">handle</span><span class="hljs-params">()</span></span> : String {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> + <span class="hljs-string">"CurvedBowZhang"</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// 需要注意，handle 方法在哪个类中被定义，这种扩展只能在那个类里面才能使用</span><br>print(<span class="hljs-string">"ZJX = "</span>.handle())<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">ZJX = CurvedBowZhang<br></code></pre></td></tr></tbody></table></figure><h1 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h1><blockquote><p>在 Kotlin 中使用运算符最终也会调用对象对应的方法，我们可以通过重写这些方法使得这个对象支持运算符，这里不再演示代码</p></blockquote><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">+a</td><td align="center">a.unaryPlus()</td></tr><tr><td align="center">-a</td><td align="center">a.unaryMinus()</td></tr><tr><td align="center">!a</td><td align="center">a.not()</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a++</td><td align="center">a.inc()</td></tr><tr><td align="center">a–</td><td align="center">a.dec()</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a + b</td><td align="center">a.plus(b)</td></tr><tr><td align="center">a - b</td><td align="center">a.minus(b)</td></tr><tr><td align="center">a * b</td><td align="center">a.times(b)</td></tr><tr><td align="center">a / b</td><td align="center">a.div(b)</td></tr><tr><td align="center">a % b</td><td align="center">a.rem(b), a.mod(b) (deprecated)</td></tr><tr><td align="center">a..b</td><td align="center">a.rangeTo(b)</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a in b</td><td align="center">b.contains(a)</td></tr><tr><td align="center">a !in b</td><td align="center">!b.contains(a)</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a[i]</td><td align="center">a.get(i)</td></tr><tr><td align="center">a[i, j]</td><td align="center">a.get(i, j)</td></tr><tr><td align="center">a[i_1, …, i_n]</td><td align="center">a.get(i_1, …, i_n)</td></tr><tr><td align="center">a[i] = b</td><td align="center">a.set(i, b)</td></tr><tr><td align="center">a[i, j] = b</td><td align="center">a.set(i, j, b)</td></tr><tr><td align="center">a[i_1, …, i_n] = b</td><td align="center">a.set(i_1, …, i_n, b)</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a()</td><td align="center">a.invoke()</td></tr><tr><td align="center">a(i)</td><td align="center">a.invoke(i)</td></tr><tr><td align="center">a(i, j)</td><td align="center">a.invoke(i, j)</td></tr><tr><td align="center">a(i_1, …, i_n)</td><td align="center">a.invoke(i_1, …, i_n)</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a += b</td><td align="center">a.plusAssign(b)</td></tr><tr><td align="center">a -= b</td><td align="center">a.minusAssign(b)</td></tr><tr><td align="center">a *= b</td><td align="center">a.timesAssign(b)</td></tr><tr><td align="center">a /= b</td><td align="center">a.divAssign(b)</td></tr><tr><td align="center">a %= b</td><td align="center">a.remAssign(b), a.modAssign(b) (deprecated)</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a == b</td><td align="center">a?.equals(b) ?: (b === null)</td></tr><tr><td align="center">a != b</td><td align="center">!(a?.equals(b) ?: (b === null))</td></tr></tbody></table><table><thead><tr><th align="center">运算符</th><th align="center">调用方法</th></tr></thead><tbody><tr><td align="center">a &gt; b</td><td align="center">a.compareTo(b) &gt; 0</td></tr><tr><td align="center">a &lt; b</td><td align="center">a.compareTo(b) &lt; 0</td></tr><tr><td align="center">a &gt;= b</td><td align="center">a.compareTo(b) &gt;= 0</td></tr><tr><td align="center">a &lt;= b</td><td align="center">a.compareTo(b) &lt;= 0</td></tr></tbody></table><h1 id="扩展函数"><a href="#扩展函数" class="headerlink" title="扩展函数"></a>扩展函数</h1><blockquote><p>扩展函数是 Kotlin 用于简化一些代码的书写产生的，其中有 let、with、run、apply、also 五个函数</p></blockquote><h2 id="let-函数"><a href="#let-函数" class="headerlink" title="let 函数"></a>let 函数</h2><blockquote><p>在函数块内可以通过 it 指代该对象。返回值为函数块的最后一行或指定return表达式</p></blockquote><blockquote><p>一般写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">val</span> text = <span class="hljs-string">"CurvedBowZhang"</span><br>    println(text.length)<br>    <span class="hljs-keyword">val</span> result = <span class="hljs-number">1000</span><br>    println(result)<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>let 写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">val</span> result = <span class="hljs-string">"CurvedBowZhang"</span>.let {<br>        println(it.length)<br>        <span class="hljs-number">1000</span><br>    }<br>    println(result)<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>最常用的场景就是使用let函数处理需要针对一个可null的对象统一做判空处理</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mVideoPlayer?.setVideoView(activity.course_video_view)<br>mVideoPlayer?.setControllerView(activity.course_video_controller_view)<br>mVideoPlayer?.setCurtainView(activity.course_video_curtain_view)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mVideoPlayer?.let {<br>   it.setVideoView(activity.course_video_view)<br>   it.setControllerView(activity.course_video_controller_view)<br>   it.setCurtainView(activity.course_video_curtain_view)<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>又或者是需要去明确一个变量所处特定的作用域范围内可以使用</p></blockquote><h2 id="with-函数"><a href="#with-函数" class="headerlink" title="with 函数"></a>with 函数</h2><blockquote><p>前面的几个函数使用方式略有不同，因为它不是以扩展的形式存在的。它是将某对象作为函数的参数，在函数块内可以通过 this<br>指代该对象。返回值为函数块的最后一行或指定return表达式</p></blockquote><blockquote><p>定义 Person 类</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">var</span> name : String, <span class="hljs-keyword">var</span> age : <span class="hljs-built_in">Int</span>)<br></code></pre></td></tr></tbody></table></figure><blockquote><p>一般写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">var</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)<br>    println(person.name + person.age)<br>    <span class="hljs-keyword">var</span> result = <span class="hljs-number">1000</span><br>    println(result)<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>with 写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">var</span> result = with(Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)) {<br>        println(name + age)<br>        <span class="hljs-number">1000</span><br>    }<br>    println(result)<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>适用于调用同一个类的多个方法时，可以省去类名重复，直接调用类的方法即可，经常用于Android中RecyclerView中onBinderViewHolder中，数据model的属性映射到UI上</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span>{<br>    <span class="hljs-keyword">val</span> item = getItem(position)?: <span class="hljs-keyword">return</span><br>    holder.nameView.text = <span class="hljs-string">"姓名：<span class="hljs-subst">${item.name}</span>"</span><br>    holder.ageView.text = <span class="hljs-string">"年龄：<span class="hljs-subst">${item.age}</span>"</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span>{<br>    <span class="hljs-keyword">val</span> item = getItem(position)?: <span class="hljs-keyword">return</span><br>    with(item){<br>        holder.nameView.text = <span class="hljs-string">"姓名：<span class="hljs-variable">$name</span>"</span><br>        holder.ageView.text = <span class="hljs-string">"年龄：<span class="hljs-variable">$age</span>"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="run-函数"><a href="#run-函数" class="headerlink" title="run 函数"></a>run 函数</h2><blockquote><p>实际上可以说是let和with两个函数的结合体，run函数只接收一个lambda函数为参数，以闭包形式返回，返回值为最后一行的值或者指定的return的表达式</p></blockquote><blockquote><p>一般写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)<br>println(person.name + <span class="hljs-string">"+"</span> + person.age)<br><span class="hljs-keyword">var</span> result = <span class="hljs-number">1000</span><br>println(result)<br></code></pre></td></tr></tbody></table></figure><blockquote><p>run 写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">var</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)<br><span class="hljs-keyword">var</span> result = person.run {<br>    println(<span class="hljs-string">"<span class="hljs-variable">$name</span> + <span class="hljs-variable">$age</span>"</span>)<br>    <span class="hljs-number">1000</span><br>}<br>println(result)<br></code></pre></td></tr></tbody></table></figure><blockquote></blockquote><p>适用于let,with函数任何场景。因为run函数是let,with两个函数结合体，准确来说它弥补了let函数在函数体内必须使用it参数替代对象，在run函数中可以像with函数一样可以省略，直接访问实例的公有属性和方法，另一方面它弥补了with函数传入对象判空问题，在run函数中可以像let函数一样做判空处理，这里还是借助<br>onBindViewHolder 案例进行简化</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span>{<br>    <span class="hljs-keyword">val</span> item = getItem(position)?: <span class="hljs-keyword">return</span><br>    holder.nameView.text = <span class="hljs-string">"姓名：<span class="hljs-subst">${item.name}</span>"</span><br>    holder.ageView.text = <span class="hljs-string">"年龄：<span class="hljs-subst">${item.age}</span>"</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span>{<br>    <span class="hljs-keyword">val</span> item = getItem(position)?: <span class="hljs-keyword">return</span><br>    item?.run {<br>        holder.nameView.text = <span class="hljs-string">"姓名：<span class="hljs-variable">$name</span>"</span><br>        holder.ageView.text = <span class="hljs-string">"年龄：<span class="hljs-variable">$age</span>"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="apply-函数"><a href="#apply-函数" class="headerlink" title="apply 函数"></a>apply 函数</h2><blockquote><p>从结构上来看apply函数和run函数很像，唯一不同点就是它们各自返回的值不一样，run函数是以闭包形式返回最后一行代码的值，而apply函数的返回的是传入对象的本身</p></blockquote><blockquote><p>一般写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>)<br>person.name = <span class="hljs-string">"ZJX"</span><br>person.age = <span class="hljs-number">50</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p>apply 写法</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"CurvedBowZhang"</span>, <span class="hljs-number">100</span>).apply {<br>    name = <span class="hljs-string">"ZJX"</span><br>    age = <span class="hljs-number">50</span><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote></blockquote><p>整体作用功能和run函数很像，唯一不同点就是它返回的值是对象本身，而run函数是一个闭包形式返回，返回的是最后一行的值。正是基于这一点差异它的适用场景稍微与run函数有点不一样。apply一般用于一个对象实例初始化的时候，需要对对象中的属性进行赋值。或者动态inflate出一个XML的View的时候需要给View绑定数据也会用到，这种情景非常常见。特别是在我们开发中会有一些数据model向View<br>model转化实例化的过程中需要用到</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mRootView = View.inflate(activity, R.layout.example_view, <span class="hljs-literal">null</span>)<br>mRootView.tv_cancel.paint.isFakeBoldText = <span class="hljs-literal">true</span><br>mRootView.tv_confirm.paint.isFakeBoldText = <span class="hljs-literal">true</span><br>mRootView.seek_bar.max = <span class="hljs-number">10</span><br>mRootView.seek_bar.progress = <span class="hljs-number">0</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p>使用 apply 函数后的代码是这样的</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mRootView = View.inflate(activity, R.layout.example_view, <span class="hljs-literal">null</span>).apply {<br>   tv_cancel.paint.isFakeBoldText = <span class="hljs-literal">true</span><br>   tv_confirm.paint.isFakeBoldText = <span class="hljs-literal">true</span><br>   seek_bar.max = <span class="hljs-number">10</span><br>   seek_bar.progress = <span class="hljs-number">0</span><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>多层级判空问题</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">if</span> (mSectionMetaData == <span class="hljs-literal">null</span> || mSectionMetaData.questionnaire == <span class="hljs-literal">null</span> || mSectionMetaData.section == <span class="hljs-literal">null</span>) {<br>    <span class="hljs-keyword">return</span>;<br>}<br><span class="hljs-keyword">if</span> (mSectionMetaData.questionnaire.userProject != <span class="hljs-literal">null</span>) {<br>    renderAnalysis();<br>    <span class="hljs-keyword">return</span>;<br>}<br><span class="hljs-keyword">if</span> (mSectionMetaData.section != <span class="hljs-literal">null</span> &amp;&amp; !mSectionMetaData.section.sectionArticles.isEmpty()) {<br>    fetchQuestionData();<br>    <span class="hljs-keyword">return</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>kotlin的apply函数优化</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">mSectionMetaData?.apply {<br><br>    <span class="hljs-comment">//mSectionMetaData不为空的时候操作mSectionMetaData</span><br><br>}?.questionnaire?.apply {<br><br>    <span class="hljs-comment">//questionnaire不为空的时候操作questionnaire</span><br><br>}?.section?.apply {<br><br>    <span class="hljs-comment">//section不为空的时候操作section</span><br><br>}?.sectionArticle?.apply {<br><br>    <span class="hljs-comment">//sectionArticle不为空的时候操作sectionArticle</span><br><br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="also-函数"><a href="#also-函数" class="headerlink" title="also 函数"></a>also 函数</h2><blockquote><p>also函数的结构实际上和let很像唯一的区别就是返回值的不一样，let是以闭包的形式返回，返回函数体内最后一行的值，如果最后一行为空就返回一个Unit类型的默认值。而also函数返回的则是传入对象的本身</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">val</span> result = <span class="hljs-string">"CurvedBowZhang"</span>.let {<br>        println(it.length)<br>        <span class="hljs-number">1000</span><br>    }<br>    println(result) <span class="hljs-comment">// 打印：1000</span><br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<br>    <span class="hljs-keyword">val</span> result = <span class="hljs-string">"CurvedBowZhang"</span>.also {<br>        println(it.length)<br>    }<br>    println(result) <span class="hljs-comment">// 打印：CurvedBowZhang</span><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>适用于let函数的任何场景，also函数和let很像，只是唯一的不同点就是let函数最后的返回值是最后一行的返回值而also函数的返回值是返回当前的这个对象。一般可用于多个扩展函数链式调用</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>通过以上几种函数的介绍，可以很方便优化kotlin中代码编写，整体看起来几个函数的作用很相似，但是各自又存在着不同。使用的场景有相同的地方比如run函数就是let和with的结合体</p></blockquote><h1 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h1><blockquote><p>子任务协作运行，优雅的处理异步问题解决方案</p></blockquote><blockquote><p>协程实际上就是极大程度的复用线程，通过让线程满载运行，达到最大程度的利用CPU，进而提升应用性能</p></blockquote><blockquote><p>在当前 app module 中配置环境和依赖（因为现在协程在 Kotlin 中是实验性的）</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">kotlin {<br>    experimental {<br>        coroutines <span class="hljs-string">'enable'</span><br>    }<br>}<br><br>dependencies {<br>    implementation <span class="hljs-string">'org.jetbrains.kotlinx:kotlinx-coroutines-core:0.20'</span><br>    implementation <span class="hljs-string">'org.jetbrains.kotlinx:kotlinx-coroutines-android:0.20'</span><br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>协程的三种启动方式</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">runBlocking:T     <br><br>launch:Job<br><br>async/await:Deferred<br></code></pre></td></tr></tbody></table></figure><ul><li>runBlocking</li></ul><blockquote><p>runBlocking 的中文翻译：运行阻塞。说太多没用，直接用代码测试一下</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br>runBlocking {<br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>) <span class="hljs-comment">// 因为 Activity 最长响应时间为 15 秒</span><br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span>.<span class="hljs-number">686</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span>.<span class="hljs-number">686</span> System.out: 测试开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span>.<span class="hljs-number">688</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">08</span>.<span class="hljs-number">688</span> System.out: 测试延迟开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">28</span>.<span class="hljs-number">692</span> System.out: 测试延迟结束<br><span class="hljs-attribute">17</span>:<span class="hljs-number">02</span>:<span class="hljs-number">28</span>.<span class="hljs-number">693</span> System.out: 测试结束<br></code></pre></td></tr></tbody></table></figure><blockquote><p>runBlocking 运行在主线程，过程中 App 出现过无响应提示，由此可见 runBlocking 和它的名称一样，真的会阻塞当前的线程，只有等<br>runBlocking 里面的代码执行完了才会执行 runBlocking 外面的代码</p></blockquote><ul><li>launch</li></ul><blockquote><p>launch 的中文翻译：启动。甭管这是啥，直接用代码测试</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br>launch {<br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>)<br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">17</span>.<span class="hljs-number">190</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">17</span>.<span class="hljs-number">190</span> System.out: 测试开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">17</span>.<span class="hljs-number">202</span> System.out: 测试结束<br><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">17</span>.<span class="hljs-number">203</span> System.out: 测试是否为主线程 false<br><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">17</span>.<span class="hljs-number">203</span> System.out: 测试延迟开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">37</span>.<span class="hljs-number">223</span> System.out: 测试延迟结束<br></code></pre></td></tr></tbody></table></figure><ul><li>async</li></ul><blockquote><p>async 的中文翻译：异步。还是老套路，直接上代码</p></blockquote><blockquote><p>测试的时候是主线程，但是到了 launch 中就会变成子线程，这种效果类似 new Thread()，有木有？和 runBlocking 最不同的是 launch<br>没有执行顺序这个概念</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br>async {<br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>)<br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">00</span>.<span class="hljs-number">694</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">00</span>.<span class="hljs-number">694</span> System.out: 测试开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">00</span>.<span class="hljs-number">697</span> System.out: 测试结束<br><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">00</span>.<span class="hljs-number">697</span> System.out: 测试是否为主线程 false<br><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">00</span>.<span class="hljs-number">697</span> System.out: 测试延迟开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">29</span>:<span class="hljs-number">20</span>.<span class="hljs-number">707</span> System.out: 测试延迟结束<br></code></pre></td></tr></tbody></table></figure><blockquote><p>这结果不是跟 launch 一样么？那么这两个到底有什么区别呢？，让我们先看一段测试代码</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br><span class="hljs-keyword">val</span> async = async {<br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>)<br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>    <span class="hljs-keyword">return</span><span class="hljs-symbol">@async</span> <span class="hljs-string">"666666"</span><br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br><br>runBlocking {<br>    println(<span class="hljs-string">"测试返回值："</span> + async.await())<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span>.<span class="hljs-number">117</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span>.<span class="hljs-number">117</span> System.out: 测试开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span>.<span class="hljs-number">120</span> System.out: 测试结束<br><span class="hljs-attribute">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span>.<span class="hljs-number">120</span> System.out: 测试是否为主线程 false<br><span class="hljs-attribute">17</span>:<span class="hljs-number">50</span>:<span class="hljs-number">57</span>.<span class="hljs-number">120</span> System.out: 测试延迟开始<br><span class="hljs-attribute">17</span>:<span class="hljs-number">51</span>:<span class="hljs-number">17</span>.<span class="hljs-number">131</span> System.out: 测试延迟结束<br><span class="hljs-attribute">17</span>:<span class="hljs-number">51</span>:<span class="hljs-number">17</span>.<span class="hljs-number">133</span> System.out: 测试返回值：<span class="hljs-number">666666</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p>看到这里你是否懂了，async 和 launch 还是有区别的，async 可以有返回值，通过它的 await 方法进行获取，需要注意的是这个方法只能在协程的操作符中才能调用</p></blockquote><ul><li>线程调度</li></ul><blockquote><p>啥？协程有类似 RxJava 线程调度？先用 launch 试验一下</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br>launch(CommonPool) { <span class="hljs-comment">// 同学们，敲重点</span><br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>)<br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>.<span class="hljs-number">243</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>.<span class="hljs-number">244</span> System.out: 测试开始<br><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>.<span class="hljs-number">246</span> System.out: 测试结束<br><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>.<span class="hljs-number">246</span> System.out: 测试是否为主线程 false<br><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">23</span>.<span class="hljs-number">247</span> System.out: 测试延迟开始<br><span class="hljs-attribute">18</span>:<span class="hljs-number">00</span>:<span class="hljs-number">43</span>.<span class="hljs-number">256</span> System.out: 测试延迟结束<br></code></pre></td></tr></tbody></table></figure><blockquote><p>Q：这个跟刚刚的代码有什么不一样吗？</p></blockquote><blockquote><p>A：当然不一样，假如一个网络请求框架维护了一个线程池，一个图片加载框架也维护了一个线程池…….，你会发现其实这样不好的地方在于，这些线程池里面的线程没有被重复利用，于是乎协程主动维护了一个公共的线程池<br>CommonPool，很好的解决了这个问题</p></blockquote><blockquote><p>Q：还有刚刚不是说能线程调度吗？为什么还是在子线程运行？</p></blockquote><blockquote><p>A：因为我刚刚只用了 CommonPool 这个关键字，我再介绍另一个关键字 UI，光听名字就知道是啥了</p></blockquote><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>println(<span class="hljs-string">"测试开始"</span>)<br>launch(UI) {<br>    println(<span class="hljs-string">"测试是否为主线程"</span> + (Thread.currentThread() == Looper.getMainLooper().thread))<br>    println(<span class="hljs-string">"测试延迟开始"</span>)<br>    delay(<span class="hljs-number">20000</span>)<br>    println(<span class="hljs-string">"测试延迟结束"</span>)<br>}<br>println(<span class="hljs-string">"测试结束"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">20</span>.<span class="hljs-number">181</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">20</span>.<span class="hljs-number">181</span> System.out: 测试开始<br><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">20</span>.<span class="hljs-number">186</span> System.out: 测试结束<br><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">20</span>.<span class="hljs-number">192</span> System.out: 测试是否为主线程 true<br><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">20</span>.<span class="hljs-number">192</span> System.out: 测试延迟开始<br><span class="hljs-attribute">18</span>:<span class="hljs-number">07</span>:<span class="hljs-number">40</span>.<span class="hljs-number">214</span> System.out: 测试延迟结束<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kotlin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kotlin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Emoji表情</title>
    <link href="/2023/08/21/docs/markdown/emoji-biao-qing/"/>
    <url>/2023/08/21/docs/markdown/emoji-biao-qing/</url>
    
    <content type="html"><![CDATA[<h1 id="Emoji表情"><a href="#Emoji表情" class="headerlink" title="Emoji表情"></a>Emoji表情</h1><p>将对应emoji表情的符号码复制后输入你的markdown文本即可显示emoji表情。<br>如<code>:blush:</code>，显示为<span class="github-emoji"><span>😊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p><strong>注：有些编辑器可能不支持显示表情</strong></p><h2 id="人物"><a href="#人物" class="headerlink" title="人物"></a>人物</h2><table><thead><tr><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th></tr></thead><tbody><tr><td align="center"><code>:bowtie:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/bowtie.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smile:</code></td><td align="center"><span class="github-emoji"><span>😄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:laughing:</code></td><td align="center"><span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:blush:</code></td><td align="center"><span class="github-emoji"><span>😊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smiley:</code></td><td align="center"><span class="github-emoji"><span>😃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:relaxed:</code></td><td align="center"><span class="github-emoji"><span>☺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/263a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:smirk:</code></td><td align="center"><span class="github-emoji"><span>😏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heart_eyes:</code></td><td align="center"><span class="github-emoji"><span>😍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:kissing_heart:</code></td><td align="center"><span class="github-emoji"><span>😘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f618.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:kissing_closed_eyes:</code></td><td align="center"><span class="github-emoji"><span>😚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:flushed:</code></td><td align="center"><span class="github-emoji"><span>😳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f633.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:relieved:</code></td><td align="center"><span class="github-emoji"><span>😌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:satisfied:</code></td><td align="center"><span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:grin:</code></td><td align="center"><span class="github-emoji"><span>😁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wink:</code></td><td align="center"><span class="github-emoji"><span>😉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f609.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:stuck_out_tongue_winking_eye:</code></td><td align="center"><span class="github-emoji"><span>😜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:stuck_out_tongue_closed_eyes:</code></td><td align="center"><span class="github-emoji"><span>😝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:grinning:</code></td><td align="center"><span class="github-emoji"><span>😀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:kissing:</code></td><td align="center"><span class="github-emoji"><span>😗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f617.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:kissing_smiling_eyes:</code></td><td align="center"><span class="github-emoji"><span>😙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f619.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:stuck_out_tongue:</code></td><td align="center"><span class="github-emoji"><span>😛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sleeping:</code></td><td align="center"><span class="github-emoji"><span>😴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f634.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:worried:</code></td><td align="center"><span class="github-emoji"><span>😟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:frowning:</code></td><td align="center"><span class="github-emoji"><span>😦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f626.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:anguished:</code></td><td align="center"><span class="github-emoji"><span>😧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f627.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:open_mouth:</code></td><td align="center"><span class="github-emoji"><span>😮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:grimacing:</code></td><td align="center"><span class="github-emoji"><span>😬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:confused:</code></td><td align="center"><span class="github-emoji"><span>😕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f615.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hushed:</code></td><td align="center"><span class="github-emoji"><span>😯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:expressionless:</code></td><td align="center"><span class="github-emoji"><span>😑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f611.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:unamused:</code></td><td align="center"><span class="github-emoji"><span>😒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f612.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sweat_smile:</code></td><td align="center"><span class="github-emoji"><span>😅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sweat:</code></td><td align="center"><span class="github-emoji"><span>😓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f613.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:disappointed_relieved:</code></td><td align="center"><span class="github-emoji"><span>😥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f625.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:weary:</code></td><td align="center"><span class="github-emoji"><span>😩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f629.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pensive:</code></td><td align="center"><span class="github-emoji"><span>😔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:disappointed:</code></td><td align="center"><span class="github-emoji"><span>😞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:confounded:</code></td><td align="center"><span class="github-emoji"><span>😖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f616.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fearful:</code></td><td align="center"><span class="github-emoji"><span>😨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f628.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cold_sweat:</code></td><td align="center"><span class="github-emoji"><span>😰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f630.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:persevere:</code></td><td align="center"><span class="github-emoji"><span>😣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f623.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cry:</code></td><td align="center"><span class="github-emoji"><span>😢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sob:</code></td><td align="center"><span class="github-emoji"><span>😭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:joy:</code></td><td align="center"><span class="github-emoji"><span>😂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:astonished:</code></td><td align="center"><span class="github-emoji"><span>😲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f632.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:scream:</code></td><td align="center"><span class="github-emoji"><span>😱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f631.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:neckbeard:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/neckbeard.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tired_face:</code></td><td align="center"><span class="github-emoji"><span>😫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:angry:</code></td><td align="center"><span class="github-emoji"><span>😠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f620.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rage:</code></td><td align="center"><span class="github-emoji"><span>😡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f621.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:triumph:</code></td><td align="center"><span class="github-emoji"><span>😤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f624.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sleepy:</code></td><td align="center"><span class="github-emoji"><span>😪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:yum:</code></td><td align="center"><span class="github-emoji"><span>😋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mask:</code></td><td align="center"><span class="github-emoji"><span>😷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f637.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sunglasses:</code></td><td align="center"><span class="github-emoji"><span>😎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dizzy_face:</code></td><td align="center"><span class="github-emoji"><span>😵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f635.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:imp:</code></td><td align="center"><span class="github-emoji"><span>👿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:smiling_imp:</code></td><td align="center"><span class="github-emoji"><span>😈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f608.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:neutral_face:</code></td><td align="center"><span class="github-emoji"><span>😐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f610.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:no_mouth:</code></td><td align="center"><span class="github-emoji"><span>😶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f636.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:innocent:</code></td><td align="center"><span class="github-emoji"><span>😇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f607.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:alien:</code></td><td align="center"><span class="github-emoji"><span>👽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:yellow_heart:</code></td><td align="center"><span class="github-emoji"><span>💛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:blue_heart:</code></td><td align="center"><span class="github-emoji"><span>💙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f499.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:purple_heart:</code></td><td align="center"><span class="github-emoji"><span>💜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heart:</code></td><td align="center"><span class="github-emoji"><span>❤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:green_heart:</code></td><td align="center"><span class="github-emoji"><span>💚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:broken_heart:</code></td><td align="center"><span class="github-emoji"><span>💔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f494.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heartbeat:</code></td><td align="center"><span class="github-emoji"><span>💓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f493.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:heartpulse:</code></td><td align="center"><span class="github-emoji"><span>💗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f497.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:two_hearts:</code></td><td align="center"><span class="github-emoji"><span>💕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f495.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:revolving_hearts:</code></td><td align="center"><span class="github-emoji"><span>💞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cupid:</code></td><td align="center"><span class="github-emoji"><span>💘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f498.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sparkling_heart:</code></td><td align="center"><span class="github-emoji"><span>💖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f496.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sparkles:</code></td><td align="center"><span class="github-emoji"><span>✨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:star:</code></td><td align="center"><span class="github-emoji"><span>⭐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:star2:</code></td><td align="center"><span class="github-emoji"><span>🌟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dizzy:</code></td><td align="center"><span class="github-emoji"><span>💫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ab.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:boom:</code></td><td align="center"><span class="github-emoji"><span>💥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:collision:</code></td><td align="center"><span class="github-emoji"><span>💥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:anger:</code></td><td align="center"><span class="github-emoji"><span>💢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:exclamation:</code></td><td align="center"><span class="github-emoji"><span>❗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:question:</code></td><td align="center"><span class="github-emoji"><span>❓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:grey_exclamation:</code></td><td align="center"><span class="github-emoji"><span>❕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2755.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:grey_question:</code></td><td align="center"><span class="github-emoji"><span>❔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2754.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:zzz:</code></td><td align="center"><span class="github-emoji"><span>💤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dash:</code></td><td align="center"><span class="github-emoji"><span>💨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sweat_drops:</code></td><td align="center"><span class="github-emoji"><span>💦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:notes:</code></td><td align="center"><span class="github-emoji"><span>🎶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:musical_note:</code></td><td align="center"><span class="github-emoji"><span>🎵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:fire:</code></td><td align="center"><span class="github-emoji"><span>🔥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f525.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hankey:</code></td><td align="center"><span class="github-emoji"><span>💩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:poop:</code></td><td align="center"><span class="github-emoji"><span>💩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>::</code></td><td align="center"><span class="github-emoji"><span>💩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:+1:</code></td><td align="center">:+1:</td><td align="center"><code>:thumbsup:</code></td><td align="center"><span class="github-emoji"><span>👍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:-1:</code></td><td align="center">:-1:</td><td align="center"><code>:thumbsdown:</code></td><td align="center"><span class="github-emoji"><span>👎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ok_hand:</code></td><td align="center"><span class="github-emoji"><span>👌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:punch:</code></td><td align="center"><span class="github-emoji"><span>👊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:facepunch:</code></td><td align="center"><span class="github-emoji"><span>👊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fist:</code></td><td align="center"><span class="github-emoji"><span>✊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:v:</code></td><td align="center"><span class="github-emoji"><span>✌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wave:</code></td><td align="center"><span class="github-emoji"><span>👋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hand:</code></td><td align="center"><span class="github-emoji"><span>✋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:raised_hand:</code></td><td align="center"><span class="github-emoji"><span>✋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:open_hands:</code></td><td align="center"><span class="github-emoji"><span>👐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f450.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:point_up:</code></td><td align="center"><span class="github-emoji"><span>☝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/261d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:point_down:</code></td><td align="center"><span class="github-emoji"><span>👇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f447.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:point_left:</code></td><td align="center"><span class="github-emoji"><span>👈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f448.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:point_right:</code></td><td align="center"><span class="github-emoji"><span>👉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f449.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:raised_hands:</code></td><td align="center"><span class="github-emoji"><span>🙌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f64c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pray:</code></td><td align="center"><span class="github-emoji"><span>🙏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:point_up_2:</code></td><td align="center"><span class="github-emoji"><span>👆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f446.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clap:</code></td><td align="center"><span class="github-emoji"><span>👏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:muscle:</code></td><td align="center"><span class="github-emoji"><span>💪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4aa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:metal:</code></td><td align="center"><span class="github-emoji"><span>🤘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f918.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:fu:</code></td><td align="center"><span class="github-emoji"><span>🖕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f595.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:walking:</code></td><td align="center"><span class="github-emoji"><span>🚶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:runner:</code></td><td align="center"><span class="github-emoji"><span>🏃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:running:</code></td><td align="center"><span class="github-emoji"><span>🏃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:couple:</code></td><td align="center"><span class="github-emoji"><span>👫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:family:</code></td><td align="center"><span class="github-emoji"><span>👪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:two_men_holding_hands:</code></td><td align="center"><span class="github-emoji"><span>👬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:two_women_holding_hands:</code></td><td align="center"><span class="github-emoji"><span>👭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dancer:</code></td><td align="center"><span class="github-emoji"><span>💃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f483.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:dancers:</code></td><td align="center"><span class="github-emoji"><span>👯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ok_woman:</code></td><td align="center"><span class="github-emoji"><span>🙆♀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f646-2640.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:no_good:</code></td><td align="center"><span class="github-emoji"><span>🙅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f645.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:information_desk_person:</code></td><td align="center"><span class="github-emoji"><span>💁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f481.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:raising_hand:</code></td><td align="center"><span class="github-emoji"><span>🙋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f64b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bride_with_veil:</code></td><td align="center"><span class="github-emoji"><span>👰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f470.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:person_with_pouting_face:</code></td><td align="center">:person_with_pouting_face:</td><td align="center"><code>:person_frowning:</code></td><td align="center">:person_frowning:</td><td align="center"><code>:bow:</code></td><td align="center"><span class="github-emoji"><span>🙇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f647.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:couplekiss:</code></td><td align="center"><span class="github-emoji"><span>💏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:couple_with_heart:</code></td><td align="center"><span class="github-emoji"><span>💑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f491.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:massage:</code></td><td align="center"><span class="github-emoji"><span>💆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f486.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:haircut:</code></td><td align="center"><span class="github-emoji"><span>💇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f487.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:nail_care:</code></td><td align="center"><span class="github-emoji"><span>💅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f485.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:boy:</code></td><td align="center"><span class="github-emoji"><span>👦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f466.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:girl:</code></td><td align="center"><span class="github-emoji"><span>👧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f467.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:woman:</code></td><td align="center"><span class="github-emoji"><span>👩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f469.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:man:</code></td><td align="center"><span class="github-emoji"><span>👨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f468.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:baby:</code></td><td align="center"><span class="github-emoji"><span>👶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f476.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:older_woman:</code></td><td align="center"><span class="github-emoji"><span>👵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f475.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:older_man:</code></td><td align="center"><span class="github-emoji"><span>👴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f474.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:person_with_blond_hair:</code></td><td align="center">:person_with_blond_hair:</td><td align="center"><code>:man_with_gua_pi_mao:</code></td><td align="center"><span class="github-emoji"><span>👲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f472.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:man_with_turban:</code></td><td align="center"><span class="github-emoji"><span>👳♂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f473-2642.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:construction_worker:</code></td><td align="center"><span class="github-emoji"><span>👷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f477.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cop:</code></td><td align="center"><span class="github-emoji"><span>👮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f46e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:angel:</code></td><td align="center"><span class="github-emoji"><span>👼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:princess:</code></td><td align="center"><span class="github-emoji"><span>👸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f478.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smiley_cat:</code></td><td align="center"><span class="github-emoji"><span>😺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smile_cat:</code></td><td align="center"><span class="github-emoji"><span>😸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f638.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:heart_eyes_cat:</code></td><td align="center"><span class="github-emoji"><span>😻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:kissing_cat:</code></td><td align="center"><span class="github-emoji"><span>😽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smirk_cat:</code></td><td align="center"><span class="github-emoji"><span>😼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:scream_cat:</code></td><td align="center"><span class="github-emoji"><span>🙀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f640.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:crying_cat_face:</code></td><td align="center"><span class="github-emoji"><span>😿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:joy_cat:</code></td><td align="center"><span class="github-emoji"><span>😹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f639.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:pouting_cat:</code></td><td align="center"><span class="github-emoji"><span>😾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f63e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:japanese_ogre:</code></td><td align="center"><span class="github-emoji"><span>👹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f479.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:japanese_goblin:</code></td><td align="center"><span class="github-emoji"><span>👺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:see_no_evil:</code></td><td align="center"><span class="github-emoji"><span>🙈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f648.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hear_no_evil:</code></td><td align="center"><span class="github-emoji"><span>🙉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f649.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:speak_no_evil:</code></td><td align="center"><span class="github-emoji"><span>🙊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f64a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:guardsman:</code></td><td align="center"><span class="github-emoji"><span>💂♂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f482-2642.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:skull:</code></td><td align="center"><span class="github-emoji"><span>💀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f480.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:feet:</code></td><td align="center"><span class="github-emoji"><span>🐾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:lips:</code></td><td align="center"><span class="github-emoji"><span>👄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f444.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:kiss:</code></td><td align="center"><span class="github-emoji"><span>💋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:droplet:</code></td><td align="center"><span class="github-emoji"><span>💧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ear:</code></td><td align="center"><span class="github-emoji"><span>👂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f442.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:eyes:</code></td><td align="center"><span class="github-emoji"><span>👀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f440.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:nose:</code></td><td align="center"><span class="github-emoji"><span>👃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f443.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tongue:</code></td><td align="center"><span class="github-emoji"><span>👅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f445.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:love_letter:</code></td><td align="center"><span class="github-emoji"><span>💌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bust_in_silhouette:</code></td><td align="center"><span class="github-emoji"><span>👤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f464.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:busts_in_silhouette:</code></td><td align="center"><span class="github-emoji"><span>👥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f465.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:speech_balloon:</code></td><td align="center"><span class="github-emoji"><span>💬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ac.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:thought_balloon:</code></td><td align="center"><span class="github-emoji"><span>💭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:feelsgood:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/feelsgood.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:finnadie:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/finnadie.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:goberserk:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/goberserk.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:godmode:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/godmode.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hurtrealbad:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/hurtrealbad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rage1:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/rage1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:rage2:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/rage2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rage3:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/rage3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rage4:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/rage4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:suspect:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/suspect.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:trollface:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/trollface.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="自然"><a href="#自然" class="headerlink" title="自然"></a>自然</h2><table><thead><tr><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th></tr></thead><tbody><tr><td align="center"><code>:sunny:</code></td><td align="center"><span class="github-emoji"><span>☀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2600.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:umbrella:</code></td><td align="center"><span class="github-emoji"><span>☔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2614.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cloud:</code></td><td align="center"><span class="github-emoji"><span>☁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2601.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:snowflake:</code></td><td align="center"><span class="github-emoji"><span>❄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2744.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:snowman:</code></td><td align="center"><span class="github-emoji"><span>⛄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26c4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:zap:</code></td><td align="center"><span class="github-emoji"><span>⚡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cyclone:</code></td><td align="center"><span class="github-emoji"><span>🌀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f300.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:foggy:</code></td><td align="center"><span class="github-emoji"><span>🌁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f301.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ocean:</code></td><td align="center"><span class="github-emoji"><span>🌊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cat:</code></td><td align="center"><span class="github-emoji"><span>🐱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dog:</code></td><td align="center"><span class="github-emoji"><span>🐶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f436.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mouse:</code></td><td align="center"><span class="github-emoji"><span>🐭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:hamster:</code></td><td align="center"><span class="github-emoji"><span>🐹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f439.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rabbit:</code></td><td align="center"><span class="github-emoji"><span>🐰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f430.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wolf:</code></td><td align="center"><span class="github-emoji"><span>🐺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:frog:</code></td><td align="center"><span class="github-emoji"><span>🐸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f438.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tiger:</code></td><td align="center"><span class="github-emoji"><span>🐯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:koala:</code></td><td align="center"><span class="github-emoji"><span>🐨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f428.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bear:</code></td><td align="center"><span class="github-emoji"><span>🐻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pig:</code></td><td align="center"><span class="github-emoji"><span>🐷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f437.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pig_nose:</code></td><td align="center"><span class="github-emoji"><span>🐽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cow:</code></td><td align="center"><span class="github-emoji"><span>🐮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:boar:</code></td><td align="center"><span class="github-emoji"><span>🐗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f417.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:monkey_face:</code></td><td align="center"><span class="github-emoji"><span>🐵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f435.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:monkey:</code></td><td align="center"><span class="github-emoji"><span>🐒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f412.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:horse:</code></td><td align="center"><span class="github-emoji"><span>🐴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f434.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:racehorse:</code></td><td align="center"><span class="github-emoji"><span>🐎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:camel:</code></td><td align="center"><span class="github-emoji"><span>🐫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sheep:</code></td><td align="center"><span class="github-emoji"><span>🐑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:elephant:</code></td><td align="center"><span class="github-emoji"><span>🐘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f418.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:panda_face:</code></td><td align="center"><span class="github-emoji"><span>🐼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:snake:</code></td><td align="center"><span class="github-emoji"><span>🐍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bird:</code></td><td align="center"><span class="github-emoji"><span>🐦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f426.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:baby_chick:</code></td><td align="center"><span class="github-emoji"><span>🐤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f424.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hatched_chick:</code></td><td align="center"><span class="github-emoji"><span>🐥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f425.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hatching_chick:</code></td><td align="center"><span class="github-emoji"><span>🐣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f423.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:chicken:</code></td><td align="center"><span class="github-emoji"><span>🐔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f414.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:penguin:</code></td><td align="center"><span class="github-emoji"><span>🐧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f427.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:turtle:</code></td><td align="center"><span class="github-emoji"><span>🐢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f422.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bug:</code></td><td align="center"><span class="github-emoji"><span>🐛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:honeybee:</code></td><td align="center"><span class="github-emoji"><span>🐝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ant:</code></td><td align="center"><span class="github-emoji"><span>🐜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:beetle:</code></td><td align="center"><span class="github-emoji"><span>🐞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:snail:</code></td><td align="center"><span class="github-emoji"><span>🐌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:octopus:</code></td><td align="center"><span class="github-emoji"><span>🐙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f419.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tropical_fish:</code></td><td align="center"><span class="github-emoji"><span>🐠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f420.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fish:</code></td><td align="center"><span class="github-emoji"><span>🐟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:whale:</code></td><td align="center"><span class="github-emoji"><span>🐳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:whale2:</code></td><td align="center"><span class="github-emoji"><span>🐋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dolphin:</code></td><td align="center"><span class="github-emoji"><span>🐬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cow2:</code></td><td align="center"><span class="github-emoji"><span>🐄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f404.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ram:</code></td><td align="center"><span class="github-emoji"><span>🐏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rat:</code></td><td align="center"><span class="github-emoji"><span>🐀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f400.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:water_buffalo:</code></td><td align="center"><span class="github-emoji"><span>🐃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f403.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tiger2:</code></td><td align="center"><span class="github-emoji"><span>🐅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f405.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rabbit2:</code></td><td align="center"><span class="github-emoji"><span>🐇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f407.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dragon:</code></td><td align="center"><span class="github-emoji"><span>🐉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f409.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:goat:</code></td><td align="center"><span class="github-emoji"><span>🐐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f410.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rooster:</code></td><td align="center"><span class="github-emoji"><span>🐓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f413.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dog2:</code></td><td align="center"><span class="github-emoji"><span>🐕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f415.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:pig2:</code></td><td align="center"><span class="github-emoji"><span>🐖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f416.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mouse2:</code></td><td align="center"><span class="github-emoji"><span>🐁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f401.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ox:</code></td><td align="center"><span class="github-emoji"><span>🐂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f402.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:dragon_face:</code></td><td align="center"><span class="github-emoji"><span>🐲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f432.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:blowfish:</code></td><td align="center"><span class="github-emoji"><span>🐡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f421.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:crocodile:</code></td><td align="center"><span class="github-emoji"><span>🐊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f40a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:dromedary_camel:</code></td><td align="center"><span class="github-emoji"><span>🐪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:leopard:</code></td><td align="center"><span class="github-emoji"><span>🐆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f406.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cat2:</code></td><td align="center"><span class="github-emoji"><span>🐈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f408.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:poodle:</code></td><td align="center"><span class="github-emoji"><span>🐩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f429.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:paw_prints:</code></td><td align="center"><span class="github-emoji"><span>🐾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f43e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bouquet:</code></td><td align="center"><span class="github-emoji"><span>💐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f490.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cherry_blossom:</code></td><td align="center"><span class="github-emoji"><span>🌸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f338.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tulip:</code></td><td align="center"><span class="github-emoji"><span>🌷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f337.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:four_leaf_clover:</code></td><td align="center"><span class="github-emoji"><span>🍀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f340.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:rose:</code></td><td align="center"><span class="github-emoji"><span>🌹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f339.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sunflower:</code></td><td align="center"><span class="github-emoji"><span>🌻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hibiscus:</code></td><td align="center"><span class="github-emoji"><span>🌺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:maple_leaf:</code></td><td align="center"><span class="github-emoji"><span>🍁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f341.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:leaves:</code></td><td align="center"><span class="github-emoji"><span>🍃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f343.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fallen_leaf:</code></td><td align="center"><span class="github-emoji"><span>🍂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f342.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:herb:</code></td><td align="center"><span class="github-emoji"><span>🌿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mushroom:</code></td><td align="center"><span class="github-emoji"><span>🍄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f344.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cactus:</code></td><td align="center"><span class="github-emoji"><span>🌵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f335.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:palm_tree:</code></td><td align="center"><span class="github-emoji"><span>🌴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f334.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:evergreen_tree:</code></td><td align="center"><span class="github-emoji"><span>🌲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f332.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:deciduous_tree:</code></td><td align="center"><span class="github-emoji"><span>🌳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f333.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:chestnut:</code></td><td align="center"><span class="github-emoji"><span>🌰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:seedling:</code></td><td align="center"><span class="github-emoji"><span>🌱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f331.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:blossom:</code></td><td align="center"><span class="github-emoji"><span>🌼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ear_of_rice:</code></td><td align="center"><span class="github-emoji"><span>🌾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:shell:</code></td><td align="center"><span class="github-emoji"><span>🐚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:globe_with_meridians:</code></td><td align="center"><span class="github-emoji"><span>🌐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f310.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sun_with_face:</code></td><td align="center"><span class="github-emoji"><span>🌞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:full_moon_with_face:</code></td><td align="center"><span class="github-emoji"><span>🌝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:new_moon_with_face:</code></td><td align="center"><span class="github-emoji"><span>🌚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:new_moon:</code></td><td align="center"><span class="github-emoji"><span>🌑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f311.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:waxing_crescent_moon:</code></td><td align="center"><span class="github-emoji"><span>🌒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f312.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:first_quarter_moon:</code></td><td align="center"><span class="github-emoji"><span>🌓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f313.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:full_moon:</code></td><td align="center"><span class="github-emoji"><span>🌕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f315.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:waning_gibbous_moon:</code></td><td align="center"><span class="github-emoji"><span>🌖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f316.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:last_quarter_moon:</code></td><td align="center"><span class="github-emoji"><span>🌗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f317.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:waning_crescent_moon:</code></td><td align="center"><span class="github-emoji"><span>🌘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f318.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:last_quarter_moon_with_face:</code></td><td align="center"><span class="github-emoji"><span>🌜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:first_quarter_moon_with_face:</code></td><td align="center"><span class="github-emoji"><span>🌛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:moon:</code></td><td align="center"><span class="github-emoji"><span>🌔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f314.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:earth_africa:</code></td><td align="center"><span class="github-emoji"><span>🌍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:earth_americas:</code></td><td align="center"><span class="github-emoji"><span>🌎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:earth_asia:</code></td><td align="center"><span class="github-emoji"><span>🌏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:volcano:</code></td><td align="center"><span class="github-emoji"><span>🌋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:milky_way:</code></td><td align="center"><span class="github-emoji"><span>🌌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f30c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:partly_sunny:</code></td><td align="center"><span class="github-emoji"><span>⛅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26c5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:octocat:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/octocat.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:squirrel:</code></td><td align="center">:squirrel:</td></tr><tr><td align="center"><code>:waxing_gibbous_moon:</code></td><td align="center"><span class="github-emoji"><span>🌔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f314.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="物体"><a href="#物体" class="headerlink" title="物体"></a>物体</h2><table><thead><tr><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th></tr></thead><tbody><tr><td align="center"><code>:bamboo:</code></td><td align="center"><span class="github-emoji"><span>🎍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:gift_heart:</code></td><td align="center"><span class="github-emoji"><span>💝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dolls:</code></td><td align="center"><span class="github-emoji"><span>🎎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:school_satchel:</code></td><td align="center"><span class="github-emoji"><span>🎒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f392.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mortar_board:</code></td><td align="center"><span class="github-emoji"><span>🎓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f393.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:flags:</code></td><td align="center"><span class="github-emoji"><span>🎏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:fireworks:</code></td><td align="center"><span class="github-emoji"><span>🎆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f386.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sparkler:</code></td><td align="center"><span class="github-emoji"><span>🎇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f387.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wind_chime:</code></td><td align="center"><span class="github-emoji"><span>🎐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f390.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:rice_scene:</code></td><td align="center"><span class="github-emoji"><span>🎑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f391.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:jack_o_lantern:</code></td><td align="center"><span class="github-emoji"><span>🎃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ghost:</code></td><td align="center"><span class="github-emoji"><span>👻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:santa:</code></td><td align="center"><span class="github-emoji"><span>🎅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f385.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:christmas_tree:</code></td><td align="center"><span class="github-emoji"><span>🎄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f384.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:gift:</code></td><td align="center"><span class="github-emoji"><span>🎁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f381.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bell:</code></td><td align="center"><span class="github-emoji"><span>🔔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f514.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:no_bell:</code></td><td align="center"><span class="github-emoji"><span>🔕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f515.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tanabata_tree:</code></td><td align="center"><span class="github-emoji"><span>🎋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tada:</code></td><td align="center"><span class="github-emoji"><span>🎉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:confetti_ball:</code></td><td align="center"><span class="github-emoji"><span>🎊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:balloon:</code></td><td align="center"><span class="github-emoji"><span>🎈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f388.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:crystal_ball:</code></td><td align="center"><span class="github-emoji"><span>🔮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cd:</code></td><td align="center"><span class="github-emoji"><span>💿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dvd:</code></td><td align="center"><span class="github-emoji"><span>📀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:floppy_disk:</code></td><td align="center"><span class="github-emoji"><span>💾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4be.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:camera:</code></td><td align="center"><span class="github-emoji"><span>📷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:video_camera:</code></td><td align="center"><span class="github-emoji"><span>📹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:movie_camera:</code></td><td align="center"><span class="github-emoji"><span>🎥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:computer:</code></td><td align="center"><span class="github-emoji"><span>💻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tv:</code></td><td align="center"><span class="github-emoji"><span>📺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4fa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:iphone:</code></td><td align="center"><span class="github-emoji"><span>📱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:phone:</code></td><td align="center"><span class="github-emoji"><span>☎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/260e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:telephone:</code></td><td align="center"><span class="github-emoji"><span>☎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/260e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:telephone_receiver:</code></td><td align="center"><span class="github-emoji"><span>📞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4de.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pager:</code></td><td align="center"><span class="github-emoji"><span>📟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4df.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fax:</code></td><td align="center"><span class="github-emoji"><span>📠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:minidisc:</code></td><td align="center"><span class="github-emoji"><span>💽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:vhs:</code></td><td align="center"><span class="github-emoji"><span>📼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4fc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sound:</code></td><td align="center"><span class="github-emoji"><span>🔉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f509.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:speaker:</code></td><td align="center"><span class="github-emoji"><span>🔈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f508.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mute:</code></td><td align="center"><span class="github-emoji"><span>🔇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f507.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:loudspeaker:</code></td><td align="center"><span class="github-emoji"><span>📢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:mega:</code></td><td align="center"><span class="github-emoji"><span>📣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hourglass:</code></td><td align="center"><span class="github-emoji"><span>⌛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/231b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hourglass_flowing_sand:</code></td><td align="center"><span class="github-emoji"><span>⏳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23f3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:alarm_clock:</code></td><td align="center"><span class="github-emoji"><span>⏰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23f0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:watch:</code></td><td align="center"><span class="github-emoji"><span>⌚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/231a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:radio:</code></td><td align="center"><span class="github-emoji"><span>📻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4fb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:satellite:</code></td><td align="center"><span class="github-emoji"><span>📡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:loop:</code></td><td align="center"><span class="github-emoji"><span>➿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27bf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mag:</code></td><td align="center"><span class="github-emoji"><span>🔍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:mag_right:</code></td><td align="center"><span class="github-emoji"><span>🔎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:unlock:</code></td><td align="center"><span class="github-emoji"><span>🔓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f513.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:lock:</code></td><td align="center"><span class="github-emoji"><span>🔒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f512.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:lock_with_ink_pen:</code></td><td align="center"><span class="github-emoji"><span>🔏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:closed_lock_with_key:</code></td><td align="center"><span class="github-emoji"><span>🔐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f510.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:key:</code></td><td align="center"><span class="github-emoji"><span>🔑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f511.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bulb:</code></td><td align="center"><span class="github-emoji"><span>💡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:flashlight:</code></td><td align="center"><span class="github-emoji"><span>🔦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f526.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:high_brightness:</code></td><td align="center"><span class="github-emoji"><span>🔆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:low_brightness:</code></td><td align="center"><span class="github-emoji"><span>🔅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f505.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:electric_plug:</code></td><td align="center"><span class="github-emoji"><span>🔌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:battery:</code></td><td align="center"><span class="github-emoji"><span>🔋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:calling:</code></td><td align="center"><span class="github-emoji"><span>📲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:email:</code></td><td align="center"><span class="github-emoji"><span>✉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2709.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mailbox:</code></td><td align="center"><span class="github-emoji"><span>📫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4eb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:postbox:</code></td><td align="center"><span class="github-emoji"><span>📮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ee.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bath:</code></td><td align="center"><span class="github-emoji"><span>🛀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bathtub:</code></td><td align="center"><span class="github-emoji"><span>🛁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:shower:</code></td><td align="center"><span class="github-emoji"><span>🚿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6bf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:toilet:</code></td><td align="center"><span class="github-emoji"><span>🚽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6bd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wrench:</code></td><td align="center"><span class="github-emoji"><span>🔧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f527.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:nut_and_bolt:</code></td><td align="center"><span class="github-emoji"><span>🔩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f529.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hammer:</code></td><td align="center"><span class="github-emoji"><span>🔨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f528.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:seat:</code></td><td align="center"><span class="github-emoji"><span>💺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ba.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:moneybag:</code></td><td align="center"><span class="github-emoji"><span>💰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:yen:</code></td><td align="center"><span class="github-emoji"><span>💴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dollar:</code></td><td align="center"><span class="github-emoji"><span>💵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:pound:</code></td><td align="center"><span class="github-emoji"><span>💷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:euro:</code></td><td align="center"><span class="github-emoji"><span>💶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:credit_card:</code></td><td align="center"><span class="github-emoji"><span>💳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:money_with_wings:</code></td><td align="center"><span class="github-emoji"><span>💸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:e-mail:</code></td><td align="center">:e-mail:</td><td align="center"><code>:inbox_tray:</code></td><td align="center"><span class="github-emoji"><span>📥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:outbox_tray:</code></td><td align="center"><span class="github-emoji"><span>📤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:envelope:</code></td><td align="center"><span class="github-emoji"><span>✉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2709.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:incoming_envelope:</code></td><td align="center"><span class="github-emoji"><span>📨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:postal_horn:</code></td><td align="center"><span class="github-emoji"><span>📯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ef.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mailbox_closed:</code></td><td align="center"><span class="github-emoji"><span>📪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ea.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mailbox_with_mail:</code></td><td align="center"><span class="github-emoji"><span>📬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ec.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:mailbox_with_no_mail:</code></td><td align="center"><span class="github-emoji"><span>📭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ed.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:door:</code></td><td align="center"><span class="github-emoji"><span>🚪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6aa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:smoking:</code></td><td align="center"><span class="github-emoji"><span>🚬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6ac.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bomb:</code></td><td align="center"><span class="github-emoji"><span>💣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:gun:</code></td><td align="center"><span class="github-emoji"><span>🔫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hocho:</code></td><td align="center"><span class="github-emoji"><span>🔪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:pill:</code></td><td align="center"><span class="github-emoji"><span>💊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:syringe:</code></td><td align="center"><span class="github-emoji"><span>💉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f489.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:page_facing_up:</code></td><td align="center"><span class="github-emoji"><span>📄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:page_with_curl:</code></td><td align="center"><span class="github-emoji"><span>📃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bookmark_tabs:</code></td><td align="center"><span class="github-emoji"><span>📑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bar_chart:</code></td><td align="center"><span class="github-emoji"><span>📊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ca.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:chart_with_upwards_trend:</code></td><td align="center"><span class="github-emoji"><span>📈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:chart_with_downwards_trend:</code></td><td align="center"><span class="github-emoji"><span>📉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:scroll:</code></td><td align="center"><span class="github-emoji"><span>📜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clipboard:</code></td><td align="center"><span class="github-emoji"><span>📋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:calendar:</code></td><td align="center"><span class="github-emoji"><span>📆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:date:</code></td><td align="center"><span class="github-emoji"><span>📅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:card_index:</code></td><td align="center"><span class="github-emoji"><span>📇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:file_folder:</code></td><td align="center"><span class="github-emoji"><span>📁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:open_file_folder:</code></td><td align="center"><span class="github-emoji"><span>📂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:scissors:</code></td><td align="center"><span class="github-emoji"><span>✂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2702.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pushpin:</code></td><td align="center"><span class="github-emoji"><span>📌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:paperclip:</code></td><td align="center"><span class="github-emoji"><span>📎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ce.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:black_nib:</code></td><td align="center"><span class="github-emoji"><span>✒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2712.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pencil2:</code></td><td align="center"><span class="github-emoji"><span>✏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:straight_ruler:</code></td><td align="center"><span class="github-emoji"><span>📏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:triangular_ruler:</code></td><td align="center"><span class="github-emoji"><span>📐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:closed_book:</code></td><td align="center"><span class="github-emoji"><span>📕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:green_book:</code></td><td align="center"><span class="github-emoji"><span>📗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:blue_book:</code></td><td align="center"><span class="github-emoji"><span>📘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:orange_book:</code></td><td align="center"><span class="github-emoji"><span>📙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:notebook:</code></td><td align="center"><span class="github-emoji"><span>📓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:notebook_with_decorative_cover:</code></td><td align="center"><span class="github-emoji"><span>📔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ledger:</code></td><td align="center"><span class="github-emoji"><span>📒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:books:</code></td><td align="center"><span class="github-emoji"><span>📚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4da.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bookmark:</code></td><td align="center"><span class="github-emoji"><span>🔖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f516.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:microscope:</code></td><td align="center"><span class="github-emoji"><span>🔬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:telescope:</code></td><td align="center"><span class="github-emoji"><span>🔭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:name_badge:</code></td><td align="center"><span class="github-emoji"><span>📛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4db.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:newspaper:</code></td><td align="center"><span class="github-emoji"><span>📰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:football:</code></td><td align="center"><span class="github-emoji"><span>🏈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:basketball:</code></td><td align="center"><span class="github-emoji"><span>🏀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:soccer:</code></td><td align="center"><span class="github-emoji"><span>⚽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26bd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:baseball:</code></td><td align="center"><span class="github-emoji"><span>⚾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26be.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tennis:</code></td><td align="center"><span class="github-emoji"><span>🎾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3be.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:8ball:</code></td><td align="center"><span class="github-emoji"><span>🎱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rugby_football:</code></td><td align="center"><span class="github-emoji"><span>🏉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bowling:</code></td><td align="center"><span class="github-emoji"><span>🎳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:golf:</code></td><td align="center"><span class="github-emoji"><span>⛳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26f3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mountain_bicyclist:</code></td><td align="center"><span class="github-emoji"><span>🚵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bicyclist:</code></td><td align="center"><span class="github-emoji"><span>🚴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:horse_racing:</code></td><td align="center"><span class="github-emoji"><span>🏇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:snowboarder:</code></td><td align="center"><span class="github-emoji"><span>🏂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:swimmer:</code></td><td align="center"><span class="github-emoji"><span>🏊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ca.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:surfer:</code></td><td align="center"><span class="github-emoji"><span>🏄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ski:</code></td><td align="center"><span class="github-emoji"><span>🎿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3bf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:spades:</code></td><td align="center"><span class="github-emoji"><span>♠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2660.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hearts:</code></td><td align="center"><span class="github-emoji"><span>♥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2665.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:clubs:</code></td><td align="center"><span class="github-emoji"><span>♣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2663.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:diamonds:</code></td><td align="center"><span class="github-emoji"><span>♦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2666.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:gem:</code></td><td align="center"><span class="github-emoji"><span>💎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ring:</code></td><td align="center"><span class="github-emoji"><span>💍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f48d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:trophy:</code></td><td align="center"><span class="github-emoji"><span>🏆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:musical_score:</code></td><td align="center"><span class="github-emoji"><span>🎼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3bc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:musical_keyboard:</code></td><td align="center"><span class="github-emoji"><span>🎹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:violin:</code></td><td align="center"><span class="github-emoji"><span>🎻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:space_invader:</code></td><td align="center"><span class="github-emoji"><span>👾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f47e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:video_game:</code></td><td align="center"><span class="github-emoji"><span>🎮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ae.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:black_joker:</code></td><td align="center"><span class="github-emoji"><span>🃏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f0cf.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:flower_playing_cards:</code></td><td align="center"><span class="github-emoji"><span>🎴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:game_die:</code></td><td align="center"><span class="github-emoji"><span>🎲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:dart:</code></td><td align="center"><span class="github-emoji"><span>🎯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3af.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mahjong:</code></td><td align="center"><span class="github-emoji"><span>🀄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f004.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:clapper:</code></td><td align="center"><span class="github-emoji"><span>🎬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ac.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:memo:</code></td><td align="center"><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pencil:</code></td><td align="center"><span class="github-emoji"><span>📝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:book:</code></td><td align="center"><span class="github-emoji"><span>📖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:art:</code></td><td align="center"><span class="github-emoji"><span>🎨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:microphone:</code></td><td align="center"><span class="github-emoji"><span>🎤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:headphones:</code></td><td align="center"><span class="github-emoji"><span>🎧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:trumpet:</code></td><td align="center"><span class="github-emoji"><span>🎺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ba.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:saxophone:</code></td><td align="center"><span class="github-emoji"><span>🎷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:guitar:</code></td><td align="center"><span class="github-emoji"><span>🎸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:shoe:</code></td><td align="center"><span class="github-emoji"><span>👞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sandal:</code></td><td align="center"><span class="github-emoji"><span>👡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f461.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:high_heel:</code></td><td align="center"><span class="github-emoji"><span>👠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f460.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:lipstick:</code></td><td align="center"><span class="github-emoji"><span>💄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f484.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:boot:</code></td><td align="center"><span class="github-emoji"><span>👢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f462.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:shirt:</code></td><td align="center"><span class="github-emoji"><span>👕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f455.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tshirt:</code></td><td align="center"><span class="github-emoji"><span>👕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f455.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:necktie:</code></td><td align="center"><span class="github-emoji"><span>👔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f454.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:womans_clothes:</code></td><td align="center"><span class="github-emoji"><span>👚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:dress:</code></td><td align="center"><span class="github-emoji"><span>👗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f457.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:running_shirt_with_sash:</code></td><td align="center"><span class="github-emoji"><span>🎽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3bd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:jeans:</code></td><td align="center"><span class="github-emoji"><span>👖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f456.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:kimono:</code></td><td align="center"><span class="github-emoji"><span>👘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f458.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bikini:</code></td><td align="center"><span class="github-emoji"><span>👙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f459.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ribbon:</code></td><td align="center"><span class="github-emoji"><span>🎀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f380.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tophat:</code></td><td align="center"><span class="github-emoji"><span>🎩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:crown:</code></td><td align="center"><span class="github-emoji"><span>👑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f451.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:womans_hat:</code></td><td align="center"><span class="github-emoji"><span>👒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f452.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:mans_shoe:</code></td><td align="center"><span class="github-emoji"><span>👞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:closed_umbrella:</code></td><td align="center"><span class="github-emoji"><span>🌂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f302.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:briefcase:</code></td><td align="center"><span class="github-emoji"><span>💼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4bc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:handbag:</code></td><td align="center"><span class="github-emoji"><span>👜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pouch:</code></td><td align="center"><span class="github-emoji"><span>👝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:purse:</code></td><td align="center"><span class="github-emoji"><span>👛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f45b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:eyeglasses:</code></td><td align="center"><span class="github-emoji"><span>👓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f453.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fishing_pole_and_fish:</code></td><td align="center"><span class="github-emoji"><span>🎣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:coffee:</code></td><td align="center"><span class="github-emoji"><span>☕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2615.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tea:</code></td><td align="center"><span class="github-emoji"><span>🍵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f375.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sake:</code></td><td align="center"><span class="github-emoji"><span>🍶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f376.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:baby_bottle:</code></td><td align="center"><span class="github-emoji"><span>🍼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f37c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:beer:</code></td><td align="center"><span class="github-emoji"><span>🍺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f37a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:beers:</code></td><td align="center"><span class="github-emoji"><span>🍻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f37b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cocktail:</code></td><td align="center"><span class="github-emoji"><span>🍸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f378.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tropical_drink:</code></td><td align="center"><span class="github-emoji"><span>🍹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f379.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wine_glass:</code></td><td align="center"><span class="github-emoji"><span>🍷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f377.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fork_and_knife:</code></td><td align="center"><span class="github-emoji"><span>🍴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f374.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:pizza:</code></td><td align="center"><span class="github-emoji"><span>🍕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f355.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hamburger:</code></td><td align="center"><span class="github-emoji"><span>🍔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f354.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fries:</code></td><td align="center"><span class="github-emoji"><span>🍟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:poultry_leg:</code></td><td align="center"><span class="github-emoji"><span>🍗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f357.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:meat_on_bone:</code></td><td align="center"><span class="github-emoji"><span>🍖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f356.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:spaghetti:</code></td><td align="center"><span class="github-emoji"><span>🍝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:curry:</code></td><td align="center"><span class="github-emoji"><span>🍛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fried_shrimp:</code></td><td align="center"><span class="github-emoji"><span>🍤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f364.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bento:</code></td><td align="center"><span class="github-emoji"><span>🍱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f371.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sushi:</code></td><td align="center"><span class="github-emoji"><span>🍣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f363.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fish_cake:</code></td><td align="center"><span class="github-emoji"><span>🍥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f365.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rice_ball:</code></td><td align="center"><span class="github-emoji"><span>🍙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f359.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:rice_cracker:</code></td><td align="center"><span class="github-emoji"><span>🍘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f358.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rice:</code></td><td align="center"><span class="github-emoji"><span>🍚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ramen:</code></td><td align="center"><span class="github-emoji"><span>🍜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:stew:</code></td><td align="center"><span class="github-emoji"><span>🍲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f372.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:oden:</code></td><td align="center"><span class="github-emoji"><span>🍢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f362.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:dango:</code></td><td align="center"><span class="github-emoji"><span>🍡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f361.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:egg:</code></td><td align="center"><span class="github-emoji"><span>🥚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f95a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bread:</code></td><td align="center"><span class="github-emoji"><span>🍞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f35e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:doughnut:</code></td><td align="center"><span class="github-emoji"><span>🍩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f369.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:custard:</code></td><td align="center"><span class="github-emoji"><span>🍮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:icecream:</code></td><td align="center"><span class="github-emoji"><span>🍦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f366.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:ice_cream:</code></td><td align="center"><span class="github-emoji"><span>🍨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f368.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:shaved_ice:</code></td><td align="center"><span class="github-emoji"><span>🍧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f367.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:birthday:</code></td><td align="center"><span class="github-emoji"><span>🎂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f382.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cake:</code></td><td align="center"><span class="github-emoji"><span>🍰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f370.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cookie:</code></td><td align="center"><span class="github-emoji"><span>🍪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:chocolate_bar:</code></td><td align="center"><span class="github-emoji"><span>🍫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:candy:</code></td><td align="center"><span class="github-emoji"><span>🍬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:lollipop:</code></td><td align="center"><span class="github-emoji"><span>🍭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:honey_pot:</code></td><td align="center"><span class="github-emoji"><span>🍯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f36f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:apple:</code></td><td align="center"><span class="github-emoji"><span>🍎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:green_apple:</code></td><td align="center"><span class="github-emoji"><span>🍏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tangerine:</code></td><td align="center"><span class="github-emoji"><span>🍊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:lemon:</code></td><td align="center"><span class="github-emoji"><span>🍋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:cherries:</code></td><td align="center"><span class="github-emoji"><span>🍒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f352.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:grapes:</code></td><td align="center"><span class="github-emoji"><span>🍇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f347.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:watermelon:</code></td><td align="center"><span class="github-emoji"><span>🍉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f349.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:strawberry:</code></td><td align="center"><span class="github-emoji"><span>🍓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f353.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:peach:</code></td><td align="center"><span class="github-emoji"><span>🍑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f351.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:melon:</code></td><td align="center"><span class="github-emoji"><span>🍈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f348.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:banana:</code></td><td align="center"><span class="github-emoji"><span>🍌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pear:</code></td><td align="center"><span class="github-emoji"><span>🍐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f350.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:pineapple:</code></td><td align="center"><span class="github-emoji"><span>🍍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sweet_potato:</code></td><td align="center"><span class="github-emoji"><span>🍠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f360.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:eggplant:</code></td><td align="center"><span class="github-emoji"><span>🍆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f346.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tomato:</code></td><td align="center"><span class="github-emoji"><span>🍅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f345.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:corn:</code></td><td align="center"><span class="github-emoji"><span>🌽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f33d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="地点"><a href="#地点" class="headerlink" title="地点"></a>地点</h2><table><thead><tr><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th></tr></thead><tbody><tr><td align="center"><code>:house:</code></td><td align="center"><span class="github-emoji"><span>🏠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:house_with_garden:</code></td><td align="center"><span class="github-emoji"><span>🏡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:school:</code></td><td align="center"><span class="github-emoji"><span>🏫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3eb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:office:</code></td><td align="center"><span class="github-emoji"><span>🏢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:post_office:</code></td><td align="center"><span class="github-emoji"><span>🏣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:hospital:</code></td><td align="center"><span class="github-emoji"><span>🏥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bank:</code></td><td align="center"><span class="github-emoji"><span>🏦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:convenience_store:</code></td><td align="center"><span class="github-emoji"><span>🏪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ea.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:love_hotel:</code></td><td align="center"><span class="github-emoji"><span>🏩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:hotel:</code></td><td align="center"><span class="github-emoji"><span>🏨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:wedding:</code></td><td align="center"><span class="github-emoji"><span>💒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f492.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:church:</code></td><td align="center"><span class="github-emoji"><span>⛪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26ea.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:department_store:</code></td><td align="center"><span class="github-emoji"><span>🏬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ec.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:european_post_office:</code></td><td align="center"><span class="github-emoji"><span>🏤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:city_sunrise:</code></td><td align="center"><span class="github-emoji"><span>🌇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f307.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:city_sunset:</code></td><td align="center"><span class="github-emoji"><span>🌆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f306.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:japanese_castle:</code></td><td align="center"><span class="github-emoji"><span>🏯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ef.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:european_castle:</code></td><td align="center"><span class="github-emoji"><span>🏰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3f0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:tent:</code></td><td align="center"><span class="github-emoji"><span>⛺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26fa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :factory:</code></td><td align="center"><span class="github-emoji"><span>🏭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ed.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tokyo_tower:</code></td><td align="center"><span class="github-emoji"><span>🗼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5fc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:japan:</code></td><td align="center"><span class="github-emoji"><span>🗾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5fe.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mount_fuji:</code></td><td align="center"><span class="github-emoji"><span>🗻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5fb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:sunrise_over_mountains:</code></td><td align="center"><span class="github-emoji"><span>🌄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f304.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sunrise:</code></td><td align="center"><span class="github-emoji"><span>🌅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f305.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:stars:</code></td><td align="center"><span class="github-emoji"><span>🌠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f320.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:statue_of_liberty:</code></td><td align="center"><span class="github-emoji"><span>🗽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5fd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bridge_at_night:</code></td><td align="center"><span class="github-emoji"><span>🌉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f309.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:carousel_horse:</code></td><td align="center"><span class="github-emoji"><span>🎠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rainbow:</code></td><td align="center"><span class="github-emoji"><span>🌈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f308.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ferris_wheel:</code></td><td align="center"><span class="github-emoji"><span>🎡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fountain:</code></td><td align="center"><span class="github-emoji"><span>⛲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26f2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:roller_coaster:</code></td><td align="center"><span class="github-emoji"><span>🎢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ship:</code></td><td align="center"><span class="github-emoji"><span>🚢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :speedboat:</code></td><td align="center"><span class="github-emoji"><span>🚤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :boat:</code></td><td align="center"><span class="github-emoji"><span>⛵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26f5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sailboat:</code></td><td align="center"><span class="github-emoji"><span>⛵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26f5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rowboat:</code></td><td align="center"><span class="github-emoji"><span>🚣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:anchor:</code></td><td align="center"><span class="github-emoji"><span>⚓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2693.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:rocket:</code></td><td align="center"><span class="github-emoji"><span>🚀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f680.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:airplane:</code></td><td align="center"><span class="github-emoji"><span>✈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2708.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:helicopter:</code></td><td align="center"><span class="github-emoji"><span>🚁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f681.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:steam_locomotive:</code></td><td align="center"><span class="github-emoji"><span>🚂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f682.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tram:</code></td><td align="center"><span class="github-emoji"><span>🚊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:mountain_railway:</code></td><td align="center"><span class="github-emoji"><span>🚞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bike:</code></td><td align="center"><span class="github-emoji"><span>🚲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:aerial_tramway:</code></td><td align="center"><span class="github-emoji"><span>🚡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:suspension_railway:</code></td><td align="center"><span class="github-emoji"><span>🚟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:mountain_cableway:</code></td><td align="center"><span class="github-emoji"><span>🚠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:tractor:</code></td><td align="center"><span class="github-emoji"><span>🚜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:blue_car:</code></td><td align="center"><span class="github-emoji"><span>🚙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f699.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:oncoming_automobile:</code></td><td align="center"><span class="github-emoji"><span>🚘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f698.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:car:</code></td><td align="center"><span class="github-emoji"><span>🚗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f697.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :red_car:</code></td><td align="center"><span class="github-emoji"><span>🚗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f697.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:taxi:</code></td><td align="center"><span class="github-emoji"><span>🚕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f695.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:oncoming_taxi:</code></td><td align="center"><span class="github-emoji"><span>🚖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f696.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:articulated_lorry:</code></td><td align="center"><span class="github-emoji"><span>🚛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bus:</code></td><td align="center"><span class="github-emoji"><span>🚌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:oncoming_bus:</code></td><td align="center"><span class="github-emoji"><span>🚍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:rotating_light:</code></td><td align="center"><span class="github-emoji"><span>🚨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:police_car:</code></td><td align="center"><span class="github-emoji"><span>🚓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f693.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:oncoming_police_car:</code></td><td align="center"><span class="github-emoji"><span>🚔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f694.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:fire_engine:</code></td><td align="center"><span class="github-emoji"><span>🚒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f692.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ambulance:</code></td><td align="center"><span class="github-emoji"><span>🚑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f691.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:minibus:</code></td><td align="center"><span class="github-emoji"><span>🚐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f690.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :truck:</code></td><td align="center"><span class="github-emoji"><span>🚚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :train:</code></td><td align="center"><span class="github-emoji"><span>🚋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :station:</code></td><td align="center"><span class="github-emoji"><span>🚉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f689.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :train2:</code></td><td align="center"><span class="github-emoji"><span>🚆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f686.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:bullettrain_front:</code></td><td align="center"><span class="github-emoji"><span>🚅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f685.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :bullettrain_side:</code></td><td align="center"><span class="github-emoji"><span>🚄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f684.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :light_rail:</code></td><td align="center"><span class="github-emoji"><span>🚈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f688.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :monorail:</code></td><td align="center"><span class="github-emoji"><span>🚝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f69d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :railway_car:</code></td><td align="center"><span class="github-emoji"><span>🚃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f683.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :trolleybus:</code></td><td align="center"><span class="github-emoji"><span>🚎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ticket:</code></td><td align="center"><span class="github-emoji"><span>🎫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ab.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :fuelpump:</code></td><td align="center"><span class="github-emoji"><span>⛽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26fd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :vertical_traffic_light:</code></td><td align="center"><span class="github-emoji"><span>🚦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :traffic_light:</code></td><td align="center"><span class="github-emoji"><span>🚥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :warning:</code></td><td align="center"><span class="github-emoji"><span>⚠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :construction:</code></td><td align="center"><span class="github-emoji"><span>🚧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:beginner:</code></td><td align="center"><span class="github-emoji"><span>🔰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f530.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :atm:</code></td><td align="center"><span class="github-emoji"><span>🏧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3e7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :slot_machine:</code></td><td align="center"><span class="github-emoji"><span>🎰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3b0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :busstop:</code></td><td align="center"><span class="github-emoji"><span>🚏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f68f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :barber:</code></td><td align="center"><span class="github-emoji"><span>💈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f488.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :hotsprings:</code></td><td align="center"><span class="github-emoji"><span>♨</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2668.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :checkered_flag:</code></td><td align="center"><span class="github-emoji"><span>🏁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3c1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :crossed_flags:</code></td><td align="center"><span class="github-emoji"><span>🎌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f38c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :izakaya_lantern:</code></td><td align="center"><span class="github-emoji"><span>🏮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ee.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:moyai:</code></td><td align="center"><span class="github-emoji"><span>🗿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f5ff.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :circus_tent:</code></td><td align="center"><span class="github-emoji"><span>🎪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3aa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :performing_arts:</code></td><td align="center"><span class="github-emoji"><span>🎭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3ad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :round_pushpin:</code></td><td align="center"><span class="github-emoji"><span>📍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :triangular_flag_on_post:</code></td><td align="center"><span class="github-emoji"><span>🚩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :jp:</code></td><td align="center"><span class="github-emoji"><span>🇯🇵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ef-1f1f5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:kr:</code></td><td align="center"><span class="github-emoji"><span>🇰🇷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1f0-1f1f7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :cn:</code></td><td align="center"><span class="github-emoji"><span>🇨🇳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1e8-1f1f3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :us:</code></td><td align="center"><span class="github-emoji"><span>🇺🇸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :fr:</code></td><td align="center"><span class="github-emoji"><span>🇫🇷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1eb-1f1f7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:es:</code></td><td align="center"><span class="github-emoji"><span>🇪🇸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ea-1f1f8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :it:</code></td><td align="center"><span class="github-emoji"><span>🇮🇹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ee-1f1f9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ru:</code></td><td align="center"><span class="github-emoji"><span>🇷🇺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1f7-1f1fa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :gb:</code></td><td align="center"><span class="github-emoji"><span>🇬🇧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ec-1f1e7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :uk:</code></td><td align="center"><span class="github-emoji"><span>🇬🇧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ec-1f1e7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:de:</code></td><td align="center"><span class="github-emoji"><span>🇩🇪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f1e9-1f1ea.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h2><table><thead><tr><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th><th align="center">syntax</th><th align="center">preview</th></tr></thead><tbody><tr><td align="center"><code>:one:</code></td><td align="center"><span class="github-emoji"><span>1⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:two:</code></td><td align="center"><span class="github-emoji"><span>2⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:three:</code></td><td align="center"><span class="github-emoji"><span>3⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:four:</code></td><td align="center"><span class="github-emoji"><span>4⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:five:</code></td><td align="center"><span class="github-emoji"><span>5⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0035-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :six:</code></td><td align="center"><span class="github-emoji"><span>6⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0036-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :seven:</code></td><td align="center"><span class="github-emoji"><span>7⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0037-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :eight:</code></td><td align="center"><span class="github-emoji"><span>8⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0038-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :nine:</code></td><td align="center"><span class="github-emoji"><span>9⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0039-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :keycap_ten:</code></td><td align="center"><span class="github-emoji"><span>🔟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :1234:</code></td><td align="center"><span class="github-emoji"><span>🔢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f522.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :zero:</code></td><td align="center"><span class="github-emoji"><span>0⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0030-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:hash:</code></td><td align="center"><span class="github-emoji"><span>#⃣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0023-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :symbols:</code></td><td align="center"><span class="github-emoji"><span>🔣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f523.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_backward:</code></td><td align="center"><span class="github-emoji"><span>◀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/25c0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :arrow_down:</code></td><td align="center"><span class="github-emoji"><span>⬇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b07.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_forward:</code></td><td align="center"><span class="github-emoji"><span>▶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/25b6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_left:</code></td><td align="center"><span class="github-emoji"><span>⬅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b05.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :capital_abcd:</code></td><td align="center"><span class="github-emoji"><span>🔠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f520.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :abcd:</code></td><td align="center"><span class="github-emoji"><span>🔡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f521.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :abc:</code></td><td align="center"><span class="github-emoji"><span>🔤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f524.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:arrow_lower_left:</code></td><td align="center"><span class="github-emoji"><span>↙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2199.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_lower_right:</code></td><td align="center"><span class="github-emoji"><span>↘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2198.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_right:</code></td><td align="center"><span class="github-emoji"><span>➡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :arrow_up:</code></td><td align="center"><span class="github-emoji"><span>⬆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b06.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_upper_left:</code></td><td align="center"><span class="github-emoji"><span>↖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2196.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_upper_right:</code></td><td align="center"><span class="github-emoji"><span>↗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2197.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:arrow_double_down:</code></td><td align="center"><span class="github-emoji"><span>⏬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23ec.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_double_up:</code></td><td align="center"><span class="github-emoji"><span>⏫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23eb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_down_small:</code></td><td align="center"><span class="github-emoji"><span>🔽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f53d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :arrow_heading_down:</code></td><td align="center"><span class="github-emoji"><span>⤵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2935.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_heading_up:</code></td><td align="center"><span class="github-emoji"><span>⤴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2934.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :leftwards_arrow_with_hook:</code></td><td align="center"><span class="github-emoji"><span>↩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:arrow_right_hook:</code></td><td align="center"><span class="github-emoji"><span>↪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/21aa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :left_right_arrow:</code></td><td align="center"><span class="github-emoji"><span>↔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2194.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrow_up_down:</code></td><td align="center"><span class="github-emoji"><span>↕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2195.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :arrow_up_small:</code></td><td align="center"><span class="github-emoji"><span>🔼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f53c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrows_clockwise:</code></td><td align="center"><span class="github-emoji"><span>🔃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f503.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :arrows_counterclockwise:</code></td><td align="center"><span class="github-emoji"><span>🔄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f504.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :rewind:</code></td><td align="center"><span class="github-emoji"><span>⏪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23ea.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :fast_forward:</code></td><td align="center"><span class="github-emoji"><span>⏩</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/23e9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :information_source:</code></td><td align="center"><span class="github-emoji"><span>ℹ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ok:</code></td><td align="center"><span class="github-emoji"><span>🆗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f197.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :twisted_rightwards_arrows:</code></td><td align="center"><span class="github-emoji"><span>🔀</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f500.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :repeat:</code></td><td align="center"><span class="github-emoji"><span>🔁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f501.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :repeat_one:</code></td><td align="center"><span class="github-emoji"><span>🔂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f502.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :new:</code></td><td align="center"><span class="github-emoji"><span>🆕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f195.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :top:</code></td><td align="center"><span class="github-emoji"><span>🔝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:up:</code></td><td align="center"><span class="github-emoji"><span>🆙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f199.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cool:</code></td><td align="center"><span class="github-emoji"><span>🆒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f192.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :free:</code></td><td align="center"><span class="github-emoji"><span>🆓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f193.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ng:</code></td><td align="center"><span class="github-emoji"><span>🆖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f196.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:cinema:</code></td><td align="center"><span class="github-emoji"><span>🎦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :koko:</code></td><td align="center"><span class="github-emoji"><span>🈁</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f201.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :signal_strength:</code></td><td align="center"><span class="github-emoji"><span>📶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u5272:</code></td><td align="center"><span class="github-emoji"><span>🈹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f239.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u5408:</code></td><td align="center"><span class="github-emoji"><span>🈴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f234.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :u55b6:</code></td><td align="center"><span class="github-emoji"><span>🈺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f23a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u6307:</code></td><td align="center"><span class="github-emoji"><span>🈯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f22f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u6708:</code></td><td align="center"><span class="github-emoji"><span>🈷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f237.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :u6709:</code></td><td align="center"><span class="github-emoji"><span>🈶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f236.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u6e80:</code></td><td align="center"><span class="github-emoji"><span>🈵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f235.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u7121:</code></td><td align="center"><span class="github-emoji"><span>🈚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f21a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :u7533:</code></td><td align="center"><span class="github-emoji"><span>🈸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f238.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u7a7a:</code></td><td align="center"><span class="github-emoji"><span>🈳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f233.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :u7981:</code></td><td align="center"><span class="github-emoji"><span>🈲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f232.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:sa:</code></td><td align="center"><span class="github-emoji"><span>🈂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f202.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :restroom:</code></td><td align="center"><span class="github-emoji"><span>🚻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6bb.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :mens:</code></td><td align="center"><span class="github-emoji"><span>🚹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :womens:</code></td><td align="center"><span class="github-emoji"><span>🚺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6ba.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :baby_symbol:</code></td><td align="center"><span class="github-emoji"><span>🚼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6bc.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :no_smoking:</code></td><td align="center"><span class="github-emoji"><span>🚭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6ad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:parking:</code></td><td align="center"><span class="github-emoji"><span>🅿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f17f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :wheelchair:</code></td><td align="center"><span class="github-emoji"><span>♿</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/267f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :metro:</code></td><td align="center"><span class="github-emoji"><span>🚇</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f687.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :baggage_claim:</code></td><td align="center"><span class="github-emoji"><span>🛄</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :accept:</code></td><td align="center"><span class="github-emoji"><span>🉑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f251.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :wc:</code></td><td align="center"><span class="github-emoji"><span>🚾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6be.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:potable_water:</code></td><td align="center"><span class="github-emoji"><span>🚰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :put_litter_in_its_place:</code></td><td align="center"><span class="github-emoji"><span>🚮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6ae.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :secret:</code></td><td align="center"><span class="github-emoji"><span>㊙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/3299.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :congratulations:</code></td><td align="center"><span class="github-emoji"><span>㊗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/3297.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :m:</code></td><td align="center"><span class="github-emoji"><span>Ⓜ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/24c2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :passport_control:</code></td><td align="center"><span class="github-emoji"><span>🛂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:left_luggage:</code></td><td align="center"><span class="github-emoji"><span>🛅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :customs:</code></td><td align="center"><span class="github-emoji"><span>🛃</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6c3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :ideograph_advantage:</code></td><td align="center"><span class="github-emoji"><span>🉐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f250.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :cl:</code></td><td align="center"><span class="github-emoji"><span>🆑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f191.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :sos:</code></td><td align="center"><span class="github-emoji"><span>🆘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f198.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :id:</code></td><td align="center"><span class="github-emoji"><span>🆔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f194.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :no_entry_sign:</code></td><td align="center"><span class="github-emoji"><span>🚫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6ab.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :underage:</code></td><td align="center"><span class="github-emoji"><span>🔞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :no_mobile_phones:</code></td><td align="center"><span class="github-emoji"><span>📵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f5.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :do_not_litter:</code></td><td align="center"><span class="github-emoji"><span>🚯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6af.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :non-potable_water:</code></td><td align="center">:non-potable_water:</td><td align="center"><code> :no_bicycles:</code></td><td align="center"><span class="github-emoji"><span>🚳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:no_pedestrians:</code></td><td align="center"><span class="github-emoji"><span>🚷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b7.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :children_crossing:</code></td><td align="center"><span class="github-emoji"><span>🚸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6b8.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :no_entry:</code></td><td align="center"><span class="github-emoji"><span>⛔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26d4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :eight_spoked_asterisk:</code></td><td align="center"><span class="github-emoji"><span>✳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2733.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :eight_pointed_black_star:</code></td><td align="center"><span class="github-emoji"><span>✴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2734.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :heart_decoration:</code></td><td align="center"><span class="github-emoji"><span>💟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f49f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :vs:</code></td><td align="center"><span class="github-emoji"><span>🆚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f19a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :vibration_mode:</code></td><td align="center"><span class="github-emoji"><span>📳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :mobile_phone_off:</code></td><td align="center"><span class="github-emoji"><span>📴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4f4.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :chart:</code></td><td align="center"><span class="github-emoji"><span>💹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :currency_exchange:</code></td><td align="center"><span class="github-emoji"><span>💱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :aries:</code></td><td align="center"><span class="github-emoji"><span>♈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2648.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :taurus:</code></td><td align="center"><span class="github-emoji"><span>♉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2649.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:gemini:</code></td><td align="center"><span class="github-emoji"><span>♊</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :cancer:</code></td><td align="center"><span class="github-emoji"><span>♋</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:leo:</code></td><td align="center"><span class="github-emoji"><span>♌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :virgo:</code></td><td align="center"><span class="github-emoji"><span>♍</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :libra:</code></td><td align="center"><span class="github-emoji"><span>♎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :scorpius:</code></td><td align="center"><span class="github-emoji"><span>♏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/264f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :sagittarius:</code></td><td align="center"><span class="github-emoji"><span>♐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2650.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :capricorn:</code></td><td align="center"><span class="github-emoji"><span>♑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2651.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :aquarius:</code></td><td align="center"><span class="github-emoji"><span>♒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2652.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :pisces:</code></td><td align="center"><span class="github-emoji"><span>♓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2653.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :ophiuchus:</code></td><td align="center"><span class="github-emoji"><span>⛎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26ce.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :six_pointed_star:</code></td><td align="center"><span class="github-emoji"><span>🔯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :negative_squared_cross_mark:</code></td><td align="center"><span class="github-emoji"><span>❎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/274e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :a:</code></td><td align="center"><span class="github-emoji"><span>🅰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f170.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:b:</code></td><td align="center"><span class="github-emoji"><span>🅱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f171.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :ab:</code></td><td align="center"><span class="github-emoji"><span>🆎</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f18e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :o2:</code></td><td align="center"><span class="github-emoji"><span>🅾</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f17e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :diamond_shape_with_a_dot_inside:</code></td><td align="center"><span class="github-emoji"><span>💠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :recycle:</code></td><td align="center"><span class="github-emoji"><span>♻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/267b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :end:</code></td><td align="center"><span class="github-emoji"><span>🔚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :on:</code></td><td align="center"><span class="github-emoji"><span>🔛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :soon:</code></td><td align="center"><span class="github-emoji"><span>🔜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f51c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock1:</code></td><td align="center"><span class="github-emoji"><span>🕐</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f550.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clock130:</code></td><td align="center"><span class="github-emoji"><span>🕜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock10:</code></td><td align="center"><span class="github-emoji"><span>🕙</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f559.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock1030:</code></td><td align="center"><span class="github-emoji"><span>🕥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f565.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :clock11:</code></td><td align="center"><span class="github-emoji"><span>🕚</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock1130:</code></td><td align="center"><span class="github-emoji"><span>🕦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f566.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock12:</code></td><td align="center"><span class="github-emoji"><span>🕛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :clock1230:</code></td><td align="center"><span class="github-emoji"><span>🕧</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f567.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock2:</code></td><td align="center"><span class="github-emoji"><span>🕑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f551.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:clock230:</code></td><td align="center"><span class="github-emoji"><span>🕝</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :clock3:</code></td><td align="center"><span class="github-emoji"><span>🕒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f552.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock330:</code></td><td align="center"><span class="github-emoji"><span>🕞</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55e.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock4:</code></td><td align="center"><span class="github-emoji"><span>🕓</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f553.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clock430:</code></td><td align="center"><span class="github-emoji"><span>🕟</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f55f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock5:</code></td><td align="center"><span class="github-emoji"><span>🕔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f554.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock530:</code></td><td align="center"><span class="github-emoji"><span>🕠</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f560.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clock6:</code></td><td align="center"><span class="github-emoji"><span>🕕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f555.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock630:</code></td><td align="center"><span class="github-emoji"><span>🕡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f561.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock7:</code></td><td align="center"><span class="github-emoji"><span>🕖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f556.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:clock730:</code></td><td align="center"><span class="github-emoji"><span>🕢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f562.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock8:</code></td><td align="center"><span class="github-emoji"><span>🕗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f557.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :clock830:</code></td><td align="center"><span class="github-emoji"><span>🕣</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f563.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :clock9:</code></td><td align="center"><span class="github-emoji"><span>🕘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f558.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:clock930:</code></td><td align="center"><span class="github-emoji"><span>🕤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f564.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :heavy_dollar_sign:</code></td><td align="center"><span class="github-emoji"><span>💲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b2.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :copyright:</code></td><td align="center"><span class="github-emoji"><span>©</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/00a9.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :registered:</code></td><td align="center"><span class="github-emoji"><span>®</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/00ae.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :tm:</code></td><td align="center"><span class="github-emoji"><span>™</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2122.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:x:</code></td><td align="center"><span class="github-emoji"><span>❌</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heavy_exclamation_mark:</code></td><td align="center"><span class="github-emoji"><span>❗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:bangbang:</code></td><td align="center"><span class="github-emoji"><span>‼</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/203c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:interrobang:</code></td><td align="center"><span class="github-emoji"><span>⁉</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2049.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :o:</code></td><td align="center"><span class="github-emoji"><span>⭕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b55.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :heavy_multiplication_x:</code></td><td align="center"><span class="github-emoji"><span>✖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2716.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :heavy_plus_sign:</code></td><td align="center"><span class="github-emoji"><span>➕</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2795.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :heavy_minus_sign:</code></td><td align="center"><span class="github-emoji"><span>➖</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2796.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heavy_division_sign:</code></td><td align="center"><span class="github-emoji"><span>➗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2797.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :white_flower:</code></td><td align="center"><span class="github-emoji"><span>💮</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ae.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :100:</code></td><td align="center"><span class="github-emoji"><span>💯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4af.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:heavy_check_mark:</code></td><td align="center"><span class="github-emoji"><span>✔</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:ballot_box_with_check:</code></td><td align="center"><span class="github-emoji"><span>☑</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2611.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :radio_button:</code></td><td align="center"><span class="github-emoji"><span>🔘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f518.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :link:</code></td><td align="center"><span class="github-emoji"><span>🔗</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:curly_loop:</code></td><td align="center"><span class="github-emoji"><span>➰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27b0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :wavy_dash:</code></td><td align="center"><span class="github-emoji"><span>〰</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/3030.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :part_alternation_mark:</code></td><td align="center"><span class="github-emoji"><span>〽</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/303d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:trident:</code></td><td align="center"><span class="github-emoji"><span>🔱</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f531.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code>:black_large_square:</code></td><td align="center"><span class="github-emoji"><span>⬛</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b1b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :white_large_square:</code></td><td align="center"><span class="github-emoji"><span>⬜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b1c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:white_check_mark:</code></td><td align="center"><span class="github-emoji"><span>✅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :white_square_button:</code></td><td align="center"><span class="github-emoji"><span>🔳</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f533.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :black_square_button:</code></td><td align="center"><span class="github-emoji"><span>🔲</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f532.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :black_circle:</code></td><td align="center"><span class="github-emoji"><span>⚫</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26ab.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :white_circle:</code></td><td align="center"><span class="github-emoji"><span>⚪</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26aa.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :red_circle:</code></td><td align="center"><span class="github-emoji"><span>🔴</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f534.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :large_blue_circle:</code></td><td align="center"><span class="github-emoji"><span>🔵</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f535.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :large_blue_diamond:</code></td><td align="center"><span class="github-emoji"><span>🔷</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f537.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :large_orange_diamond:</code></td><td align="center"><span class="github-emoji"><span>🔶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f536.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code> :small_blue_diamond:</code></td><td align="center"><span class="github-emoji"><span>🔹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :small_orange_diamond:</code></td><td align="center"><span class="github-emoji"><span>🔸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f538.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :small_red_triangle:</code></td><td align="center"><span class="github-emoji"><span>🔺</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f53a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td></tr><tr><td align="center"><code>:small_red_triangle_down:</code></td><td align="center"><span class="github-emoji"><span>🔻</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f53b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"><code> :shipit:</code></td><td align="center"><span class="github-emoji"><span> </span><img src="https://github.githubassets.com/images/icons/emoji/shipit.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></td><td align="center"></td><td align="center"></td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>MarkDown</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MarkDown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android Studio Logcat使用技巧</title>
    <link href="/2023/08/20/docs/others/android-studio-logcat-shi-yong-ji-qiao/"/>
    <url>/2023/08/20/docs/others/android-studio-logcat-shi-yong-ji-qiao/</url>
    
    <content type="html"><![CDATA[<p>让控制台只显示过滤指定字符的log</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">^(.<span class="hljs-strong">*(10:30)).*</span>$<br></code></pre></td></tr></tbody></table></figure><p>让控制台不显示指定字符</p><figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby">^(<span class="hljs-string">?!</span>.*()).*<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>^(<span class="hljs-string">?!</span>.*(<span class="hljs-title class_">HandlerThrea</span>|<span class="hljs-params">System.out:</span>|I/<span class="hljs-title class_">Camera</span><span class="hljs-symbol">:</span>)).*<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>^(<span class="hljs-string">?!</span>.*(waiting <span class="hljs-keyword">for</span> activeVoice|<span class="hljs-params">handleMessage:</span>|I/<span class="hljs-title class_">System</span>.out)).*$<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AndroidStudio</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VSCode 修改插件路径</title>
    <link href="/2023/08/20/docs/others/vs-code-xiu-gai-cha-jian-lu-jing/"/>
    <url>/2023/08/20/docs/others/vs-code-xiu-gai-cha-jian-lu-jing/</url>
    
    <content type="html"><![CDATA[<h3 id="VSCode-修改插件路径"><a href="#VSCode-修改插件路径" class="headerlink" title="VSCode 修改插件路径"></a>VSCode 修改插件路径</h3><p>右击vs code这个软件程序属性 在后边增加</p><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-built_in">--extensions-dir</span> <span class="hljs-string">"D:\VSCode\extensions"</span><br></code></pre></td></tr></tbody></table></figure><p>引号中是想要将插件位置修改到的目录</p>]]></content>
    
    
    <categories>
      
      <category>Others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>VS Code</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见字符串乱码对照表</title>
    <link href="/2023/08/20/docs/others/chang-jian-zi-fu-chuan-luan-ma-dui-zhao-biao/"/>
    <url>/2023/08/20/docs/others/chang-jian-zi-fu-chuan-luan-ma-dui-zhao-biao/</url>
    
    <content type="html"><![CDATA[<p><img src="/resources/img/docs_pic/%E6%96%87%E5%AD%97%E4%B9%B1%E7%A0%81%E5%AF%B9%E7%85%A7%E8%A1%A8.png" alt="文字乱码对照表.png"></p>]]></content>
    
    
    <categories>
      
      <category>Others</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>安卓设备网络抓包</title>
    <link href="/2023/08/20/docs/others/zhua-bao/"/>
    <url>/2023/08/20/docs/others/zhua-bao/</url>
    
    <content type="html"><![CDATA[<h2 id="安卓设备网络抓包步骤"><a href="#安卓设备网络抓包步骤" class="headerlink" title="安卓设备网络抓包步骤"></a>安卓设备网络抓包步骤</h2><p>准备 <a href="/resources/files/nethook/tcpdump">tcpdump</a> 文件</p><h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先将tcpdump文件推送到设备的临时目录里面</span><br>adb push tcpdump /data/local/tmp<br><br><span class="hljs-comment"># 设置权限</span><br>adb shell <span class="hljs-built_in">chmod</span> 777 /data/local/tmp/tcpdump<br><br><span class="hljs-comment"># 启动抓包，将抓包结果保存在指定文件</span><br>/data/local/tmp/tcpdump -i any -p -X -s 0 -w /sdcard/test.pcap<br><br><span class="hljs-comment"># 抓包完成后按 Ctrl+C 退出抓包</span><br><br><span class="hljs-comment"># exit 退出 adb shell</span><br><br><span class="hljs-comment"># 将抓包文件pull到电脑里</span><br>adb pull /sdcard/test.pcap E:\Files\pcaps<br><br></code></pre></td></tr></tbody></table></figure><h3 id="其他用法"><a href="#其他用法" class="headerlink" title="其他用法"></a>其他用法</h3><p>监视指定主机的数据包</p><p>打印所有进入或离开<code>sundown</code>的数据包.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump host sundown<br></code></pre></td></tr></tbody></table></figure><p>也可以指定ip,例如截获所有210.27.48.1 的主机收到的和发出的所有的数据包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump host 210.27.48.1 <br></code></pre></td></tr></tbody></table></figure><p>打印<code>helios</code> 与 <code>hot</code> 或者与 <code>ace</code> 之间通信的数据包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump host helios and \( hot or ace \)<br></code></pre></td></tr></tbody></table></figure><p>截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump host 210.27.48.1 and \ (210.27.48.2 or 210.27.48.3 \) <br></code></pre></td></tr></tbody></table></figure><p>打印ace与任何其他主机之间通信的IP 数据包, 但不包括与helios之间的数据包.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump ip host ace and not helios<br></code></pre></td></tr></tbody></table></figure><p>如果想要获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包，使用命令：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump ip host 210.27.48.1 and ! 210.27.48.2<br></code></pre></td></tr></tbody></table></figure><p>截获主机hostname发送的所有数据</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump -i eth0 src host hostname<br></code></pre></td></tr></tbody></table></figure><p>监视所有送到主机hostname的数据包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump -i eth0 dst host hostname<br></code></pre></td></tr></tbody></table></figure><p>监视指定主机和端口的数据包<br>如果想要获取主机210.27.48.1接收或发出的telnet包，使用如下命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump tcp port 23 and host 210.27.48.1<br></code></pre></td></tr></tbody></table></figure><p>对本机的udp 123 端口进行监视 123 为ntp的服务端口</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump udp port 123 <br></code></pre></td></tr></tbody></table></figure><p>监视指定网络的数据包<br>打印本地主机与Berkeley网络上的主机之间的所有通信数据包(nt: ucb-ether, 此处可理解为’Berkeley网络’<br>的网络地址,此表达式最原始的含义可表达为: 打印网络地址为ucb-ether的所有数据包)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump net ucb-ether<br></code></pre></td></tr></tbody></table></figure><p>打印所有通过网关snup的ftp数据包(注意, 表达式被单引号括起来了, 这可以防止shell对其中的括号进行错误解析)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump <span class="hljs-string">'gateway snup and (port ftp or ftp-data)'</span><br></code></pre></td></tr></tbody></table></figure><p>打印所有源地址或目标地址是本地主机的IP数据包<br>(如果本地网络通过网关连到了另一网络, 则另一网络并不能算作本地网络.(nt: 此句翻译曲折,需补充).localnet<br>实际使用时要真正替换成本地网络的名字)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcpdump ip and not net localnet<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>Others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>抓包</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssh-agent一些命令使用方法说明</title>
    <link href="/2023/08/20/docs/ssh/ssh-agent/"/>
    <url>/2023/08/20/docs/ssh/ssh-agent/</url>
    
    <content type="html"><![CDATA[<p>ssh-add命令是把专用密钥添加到ssh-agent的高速缓存中,从而提高ssh的认证速度。</p><h3 id="命令语法"><a href="#命令语法" class="headerlink" title="命令语法"></a>命令语法</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ssh-<span class="hljs-built_in">add</span> [-cDdLlXx] [-t life] [file <span class="hljs-built_in">..</span>.]<br>ssh-<span class="hljs-built_in">add</span> -s pkcs11<br>ssh-<span class="hljs-built_in">add</span> -e pkcs11<br></code></pre></td></tr></tbody></table></figure><h3 id="命令选项"><a href="#命令选项" class="headerlink" title="命令选项"></a>命令选项</h3><figure class="highlight ldif"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-literal">-</span>D：删除ssh-agent中的所有密钥.<br><span class="hljs-literal">-</span>d：从ssh-agent中的删除密钥<br><span class="hljs-literal">-</span>e pkcs11：删除PKCS<span class="hljs-comment">#11共享库pkcs1提供的钥匙。</span><br><span class="hljs-literal">-</span>s pkcs11：添加PKCS<span class="hljs-comment">#11共享库pkcs1提供的钥匙。</span><br><span class="hljs-literal">-</span>L：显示ssh-agent中的公钥<br><span class="hljs-literal">-</span>l：显示ssh-agent中的密钥<br><span class="hljs-literal">-</span>t life：对加载的密钥设置超时时间，超时ssh-agent将自动卸载密钥<br><span class="hljs-literal">-</span>X：对ssh-agent进行解锁<br><span class="hljs-literal">-</span>x：对ssh-agent进行加锁<br></code></pre></td></tr></tbody></table></figure><h3 id="开启ssh-agent"><a href="#开启ssh-agent" class="headerlink" title="开启ssh-agent"></a>开启ssh-agent</h3><p>默认操作系统是不开启ssh-agent的，需要手动打开</p><ul><li><p>Linux:</p><blockquote><p>ssh-agent bash</p></blockquote></li><li><p>Windows:</p><p>使用管理员打开Power Shell后执行：</p><blockquote><p>Start-Service ssh-agent</p></blockquote><p>也可以设置自启动：</p><blockquote><p>Set-Service ssh-agent -StartupType Auto</p></blockquote></li></ul><h3 id="把专用密钥添加到ssh-agent的高速缓存中"><a href="#把专用密钥添加到ssh-agent的高速缓存中" class="headerlink" title="把专用密钥添加到ssh-agent的高速缓存中"></a>把专用密钥添加到ssh-agent的高速缓存中</h3><blockquote><p>ssh-add ~/.ssh/id_dsa</p></blockquote><h3 id="从ssh-agent中删除密钥"><a href="#从ssh-agent中删除密钥" class="headerlink" title="从ssh-agent中删除密钥"></a>从ssh-agent中删除密钥</h3><blockquote><p>ssh-add -d ~/.ssh/id_dsa.pub</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ssh</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssh配置文件详解</title>
    <link href="/2023/08/20/docs/ssh/ssh-config/"/>
    <url>/2023/08/20/docs/ssh/ssh-config/</url>
    
    <content type="html"><![CDATA[<p>ssh配置文件详解</p><p>1、/etc/ssh/ssh_config配置文件</p><table><thead><tr><th>选项参数</th><th>说明</th></tr></thead><tbody><tr><td>Host *</td><td>选项“Host”只对能够匹配后面字串的计算机有效。“*”表示所有的计算机。</td></tr><tr><td>ForwardAgent no</td><td>设置连接是否经过验证代理（如果存在）转发给远程计算机。</td></tr><tr><td>ForwardX11 no</td><td>设置X11连接是否被自动重定向到安全的通道和显示集（DISPLAY set）</td></tr><tr><td>RhostsAuthentication no</td><td>设置是否使用基于rhosts的安全验证</td></tr><tr><td>RhostsRSAAuthentication no</td><td>设置是否使用用RSA算法的基于rhosts的安全验证</td></tr><tr><td>RSAAuthentication yes</td><td>设置是否使用RSA算法进行安全验证</td></tr><tr><td>PasswordAuthentication yes</td><td>设置是否使用口令验证</td></tr><tr><td>FallBackToRsh no</td><td>设置如果用ssh连接出现错误是否自动使用rsh</td></tr><tr><td>UseRsh no</td><td>设置是否在这台计算机上使用“rlogin/rsh”</td></tr><tr><td>BatchMode no</td><td>如果设为“yes”，passphrase/password（交互式输入口令）的提示将被禁止。当不能交互式输入口令的时候，这个选项对脚本文件和批处理任务十分有用</td></tr><tr><td>CheckHostIP yes</td><td>设置ssh是否查看连接到服务器的主机的IP地址以防止DNS欺骗。建议设置为“yes”</td></tr><tr><td>StrictHostKeyChecking no</td><td>如果设置成“yes”，ssh就不会自动把计算机的密匙加入“$HOME/.ssh/known_hosts”文件，并且一旦计算机的密匙发生了变化，就拒绝连接</td></tr><tr><td>IdentityFile ~/.ssh/identity</td><td>设置从哪个文件读取用户的RSA安全验证标识</td></tr><tr><td>Port 22</td><td>设置连接到远程主机的端口</td></tr><tr><td>Cipher blowfish</td><td>设置加密用的密码</td></tr><tr><td>EscapeChar ~</td><td>设置escape字符</td></tr></tbody></table><p>2、/etc/ssh/sshd_config配置文件</p><table><thead><tr><th>参数选项</th><th>说明</th></tr></thead><tbody><tr><td>Port 22</td><td>SH 预设使用 22 这个 port，您也可以使用多的 port ！</td></tr><tr><td>Protocol 2,1</td><td>选择的 SSH 协议版本，可以是 1 也可以是 2 ，如果要同时支持两者，就必须要使用 2,1 这个分隔了！</td></tr><tr><td>ListenAddress 0.0.0.0</td><td>监听的主机适配卡！举个例子来说，如果您有两个 IP，分别是 192.168.0.100 及 192.168.2.20 ，那么只想要开放 192.168.0.100 时，就可以写如同下面的样式：</td></tr><tr><td>ListenAddress 192.168.0.100</td><td>只监听来自 192.168.0.100 这个 IP 的SSH联机。如果不使用设定的话，则预设所有接口均接受 SSH</td></tr><tr><td>PidFile /var/run/sshd.pid</td><td>可以放置 SSHD 这个 PID 的档案！左列为默认值</td></tr><tr><td>LoginGraceTime 600</td><td>当使用者连上 SSH server 之后，会出现输入密码的画面，在该画面中，在多久时间内没有成功连上 SSH server ，就断线！时间为秒！</td></tr><tr><td>Compression yes</td><td>是否可以使用压缩指令？</td></tr><tr><td>HostKey /etc/ssh/ssh_host_key</td><td>SH version 1 使用的私钥</td></tr><tr><td>HostKey /etc/ssh/ssh_host_rsa_key</td><td>SH version 2 使用的 RSA 私钥</td></tr><tr><td>HostKey /etc/ssh/ssh_host_dsa_key</td><td>SH version 2 使用的 DSA 私钥</td></tr><tr><td>KeyRegenerationInterval 3600</td><td>由前面联机的说明可以知道， version 1 会使用 server 的 Public Key ，每隔一段时间来重新建立一次！时间为秒！</td></tr><tr><td>ServerKeyBits 768</td><td>erver key 的长度！</td></tr><tr><td>SyslogFacility AUTH</td><td>当有人使用 SSH 登入系统的时候，SSH会记录信息</td></tr><tr><td>LogLevel INFO</td><td>登录记录的等级—》全部</td></tr><tr><td>PermitRootLogin no</td><td>是否允许 root 登入！预设是允许的，但是建议设定成 no！</td></tr><tr><td>UserLogin no</td><td>在 SSH 底下本来就不接受 login 这个程序的登入！</td></tr><tr><td>StrictModes yes</td><td>当使用者的 host key 改变之后，Server 就不接受联机</td></tr><tr><td>RSAAuthentication yes</td><td>是否使用纯的 RSA 认证！？仅针对 version 1 ！</td></tr><tr><td>PubkeyAuthentication yes</td><td>是否允许 Public Key ？只有 version 2</td></tr><tr><td>AuthorizedKeysFile   .ssh/authorized_keys</td><td>设定若要使用不需要密码登入的账号时，那么那个账号的存放档案所在档名！</td></tr><tr><td>RhostsAuthentication no</td><td>本机系统不使用 .rhosts ， .rhosts 不安全！</td></tr><tr><td>IgnoreRhosts yes</td><td>是否取消使用 ~/.ssh/.rhosts 来做为认证！</td></tr><tr><td>RhostsRSAAuthentication no</td><td>针对 version 1 ，使用 rhosts 档案在/etc/hosts.equiv配合 RSA 演算方式来进行认证！</td></tr><tr><td>HostbasedAuthentication no</td><td>这个项目与上面的项目类似，不过是给 version 2 使用的！</td></tr><tr><td>IgnoreUserKnownHosts no</td><td>是否忽略家目录内的 ~/.ssh/known_hosts 这个档案所记录的主机内容</td></tr><tr><td>PasswordAuthentication yes</td><td>密码验证当然是需要的！</td></tr><tr><td>PermitEmptyPasswords no</td><td>上面那一项如果设定为 yes 的话，这一项就最好设定为 no ，这个项目在是否允许以空的密码登入！</td></tr><tr><td>ChallengeResponseAuthentication yes</td><td>挑战任何的密码认证！所以，任何 login.conf 规定的认证方式，均可适用！</td></tr><tr><td>PAMAuthenticationViaKbdInt yes</td><td>是否启用其它的 PAM 模块！启用这个模块将会导致 PasswordAuthentication 设定失效！</td></tr><tr><td>与Kerberos 有关的参数设定！底下不用设定</td><td></td></tr><tr><td>KerberosAuthentication no</td><td></td></tr><tr><td>KerberosOrLocalPasswd yes</td><td></td></tr><tr><td>KerberosTicketCleanup yes</td><td></td></tr><tr><td>KerberosTgtPassing no</td><td></td></tr><tr><td>有关在 X-Window 底下使用的相关设定</td><td></td></tr><tr><td>X11Forwarding yes</td><td></td></tr><tr><td>X11DisplayOffset 10</td><td></td></tr><tr><td>X11UseLocalhost yes</td><td></td></tr><tr><td>PrintMotd no</td><td>登入后是否显示出一些信息呢？例如上次登入的时间、地点等，预设是 yes ，但是，如果为了安全，可以考虑改为 no ！</td></tr><tr><td>PrintLastLog yes</td><td>显示上次登入的信息！预设也是 yes</td></tr><tr><td>KeepAlive yes</td><td>一般而言，如果设定这项目的话，那么 SSH Server 会传送KeepAlive 的讯息给 Client 端，以确保两者的联机正常！在这个情况下，任何一端死掉后， SSH 可以立刻知道！而不会有僵尸程序的发生！</td></tr><tr><td>UsePrivilegeSeparation yes</td><td>使用者的权限设定项目！</td></tr><tr><td>MaxStartups 10</td><td>同时允许几个尚未登入的联机画面</td></tr><tr><td>DenyUsers *</td><td>设定受抵挡的使用者名称</td></tr><tr><td>AllowUsers *</td><td>设定允许的使用者名称</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>ssh</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSH免密登录Linux服务器</title>
    <link href="/2023/08/20/docs/ssh/ssh-mian-mi-deng-lu/"/>
    <url>/2023/08/20/docs/ssh/ssh-mian-mi-deng-lu/</url>
    
    <content type="html"><![CDATA[<h3 id="SSH免密登录Linux服务器"><a href="#SSH免密登录Linux服务器" class="headerlink" title="SSH免密登录Linux服务器"></a>SSH免密登录Linux服务器</h3><p>首先要安装ssh</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install ssh<br></code></pre></td></tr></tbody></table></figure><p>检查ssh的一些配置项</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo gedit /etc/ssh/sshd_config<br></code></pre></td></tr></tbody></table></figure><p>注意下面的配置项是否开启</p><figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">PermitRootLogin</span> <span class="hljs-literal">yes</span><br>PubkeyAuthentication <span class="hljs-literal">yes</span><br></code></pre></td></tr></tbody></table></figure><p>重启ssh服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo /etc/init.d/ssh restart<br><span class="hljs-comment"># 或者</span><br>sudo service ssh restart<br></code></pre></td></tr></tbody></table></figure><p>生成秘钥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa<br></code></pre></td></tr></tbody></table></figure><p>将本机秘钥添加到远程客户端</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-copy-id user@127.0.0.1<br></code></pre></td></tr></tbody></table></figure><p>也可以手动复制 <code>id_rsa.pub</code> 到远程客户端的 <code>~/.ssh/authorized_keys</code>里面</p><blockquote><p>注意：<br>如果配置没问题，而且确认密钥已经加到了<code>authorized_keys</code>里面，但是仍然无法登录，<br>检查一下ssh文件夹权限，ssh对文件权限要求非常严格</p></blockquote><p>用户根目录必须为755或者700 不能为 77X</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chmod</span> 755 /root<br>sudo <span class="hljs-built_in">chmod</span> 755 ~<br></code></pre></td></tr></tbody></table></figure><p><code>.ssh</code> 目录的权限必须是 700</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chmod</span> 700 /root/.ssh<br>sudo <span class="hljs-built_in">chmod</span> 700 ~/.ssh<br></code></pre></td></tr></tbody></table></figure><p><code>authorized_keys</code> 文件权限必须是600</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo chmod <span class="hljs-number">600</span> <span class="hljs-regexp">/root/</span>.ssh/authorized_keys<br>sudo chmod <span class="hljs-number">600</span> ~<span class="hljs-regexp">/.ssh/</span>authorized_keys<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>ssh</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux安装Webmin</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-xiu-gai-java-ban-ben/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-xiu-gai-java-ban-ben/</url>
    
    <content type="html"><![CDATA[<p>#添加镜像源<br>sudo gedit /etc/apt/sources.list<br>deb [by-hash=force] <a href="https://mirrors.aliyun.com/deepin">https://mirrors.aliyun.com/deepin</a> apricot main contrib non-free</p><p>#更新软件包列表<br>sudo apt update</p><p>#查看软件库中的jdk版本<br>apt search openjdk</p><p>#安装所需JDK版本<br>sudo apt install -y openjdk-8-jdk<br>sudo apt install -y openjdk-11-jdk</p><p>#查询或修改JDK版本<br>sudo update-alternatives –config java</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>JDK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux汉化不完全</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-han-hua-bu-wan-quan/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-han-hua-bu-wan-quan/</url>
    
    <content type="html"><![CDATA[<p>成功安装了Linux Mint 19操作系统，但是部分界面还是英文的。<br>由于在Linux Mint 19里去除了Ubuntu的语言支持小工具，使用Cinnamon自身的一个新开发语言配置工具来替换，但是这个工具尚未完善，明明在Linux<br>Mint 19系统中的Firefox等软件还是英文的界面，可却显示中文已经完整安装。所以，我们需要手动来安装所需要的中文语言包，以下在Linux<br>Mint 19系统终端中运行相关指令即可完成。</p><ol><li>安装中文语言包</li></ol><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">$ sudo apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-keyword">language</span><span class="hljs-operator">-</span>pack<span class="hljs-operator">-</span>zh<span class="hljs-operator">-</span>hans  <span class="hljs-keyword">language</span><span class="hljs-operator">-</span>pack<span class="hljs-operator">-</span>gnome<span class="hljs-operator">-</span>zh<span class="hljs-operator">-</span>hans<br></code></pre></td></tr></tbody></table></figure><ol start="2"><li>安装firefox语言包</li></ol><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ sudo apt-<span class="hljs-built_in">get</span> install firefox-locale-zh-hans<br></code></pre></td></tr></tbody></table></figure><ol start="3"><li>安装libreoffice语言包</li></ol><figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">$ sudo apt-<span class="hljs-meta">get</span> install libreoffice-l10n-zh-<span class="hljs-meta">cn</span><br></code></pre></td></tr></tbody></table></figure><ol start="4"><li>安装thunderbird语言包</li></ol><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ sudo apt-<span class="hljs-built_in">get</span> install thunderbird-locale-zh-hans<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ubuntu看不到图形界面解决办法</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/ubuntu-kan-bu-dao-tu-xing-jie-mian-jie-jue-ban-fa/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/ubuntu-kan-bu-dao-tu-xing-jie-mian-jie-jue-ban-fa/</url>
    
    <content type="html"><![CDATA[<h2 id="ubuntu-看不到图形界面桌面的解决办法"><a href="#ubuntu-看不到图形界面桌面的解决办法" class="headerlink" title="ubuntu 看不到图形界面桌面的解决办法"></a>ubuntu 看不到图形界面桌面的解决办法</h2><p>1、使用Ctrl + Alt + F1组合键进入字符命令行界面</p><p>2、试试 restartx</p><p>3、如果第2条解决不了，再试试 sudo service lightdm restart 重启 lightdm</p><p>4、如果第3条解决不了，再试试 sudo dpkg-reconfigre lightdm 选择 lightdm</p><p>5、如果第4条解决不了，就只能重装 unity 了</p><p>sudo apt-get update</p><p>sudo apt-get install –reinstall ubuntu-desktop</p><p>sudo apt-get install unity</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ubuntu设置root登录</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/ubuntu-she-zhi-root-deng-lu/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/ubuntu-she-zhi-root-deng-lu/</url>
    
    <content type="html"><![CDATA[<p>sudo passwd root</p><p>su root</p><p>sudo gedit /etc/pam.d/gdm-autologin</p><p>//注释 auth requied pam_succeed_if.so user != root quiet success</p><p>sudo gedit /etc/pam.d/gdm-password</p><p>//注释 auth requied pam_succeed_if.so user != root quiet success</p><p>此时重启计算机，使用root账户登陆，出现错误提示：Error found when loading/root/.profile:mesg: ttyname失败: 对设备不适当的ioctl操作，As<br>a result the session will not be configured correctly.You shoud fix the problem as soon as feasible</p><p>运行：</p><p>sudo gedit /root/.profile</p><p>在行”mesg n || true”前添加”tty -s &amp;&amp; “，变为”tty -s &amp;&amp; mesg n || true”，此时重启计算机，使用root账户登陆正常。</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux vim编辑指令</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/vi-bian-ji/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/vi-bian-ji/</url>
    
    <content type="html"><![CDATA[<p>i 进入编辑模式</p><p>按ESC键 退出编辑模式，然后：</p><p>:w 保存文件但不退出vi</p><p>:w file 将修改另外保存到file中，不退出vi</p><p>:w! 强制保存，不推出vi</p><p>:wq 保存文件并退出vi</p><p>:wq! 强制保存文件，并退出vi</p><p>q: 不保存文件，退出vi</p><p>:q! 不保存文件，强制退出vi</p><p>:e! 放弃所有修改，从上次保存文件开始再编辑</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>vim</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux samba共享文件</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/samba-gong-xiang-wen-jian/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/samba-gong-xiang-wen-jian/</url>
    
    <content type="html"><![CDATA[<h2 id="Samba共享文件"><a href="#Samba共享文件" class="headerlink" title="Samba共享文件"></a>Samba共享文件</h2><p><a href="https://blog.csdn.net/qq_37992321/article/details/90084534">Samba共享文件</a></p><p><a href="http://www.360doc.com/content/21/0127/16/496343_959226652.shtml">Windows上无法访问共享文件</a></p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux bash执行命令相关问题</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/bash-zhi-xing-ming-ling-xiang-guan-wen-ti/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/bash-zhi-xing-ming-ling-xiang-guan-wen-ti/</url>
    
    <content type="html"><![CDATA[<h3 id="sh-执行问题"><a href="#sh-执行问题" class="headerlink" title="sh 执行问题"></a>sh 执行问题</h3><h4 id="bash-xxx-sh-bin-bash-M-bad-interpreter-No-such-file-or-directory"><a href="#bash-xxx-sh-bin-bash-M-bad-interpreter-No-such-file-or-directory" class="headerlink" title="bash: ./xxx.sh: /bin/bash^M: bad interpreter: No such file or directory"></a>bash: ./xxx.sh: /bin/bash^M: bad interpreter: No such file or directory</h4><p>解决方案：</p><ul><li><p>方法一</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim xxx.sh <br></code></pre></td></tr></tbody></table></figure><p>进入 xxx.sh后<br>在底部模式下执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">:<span class="hljs-built_in">set</span> fileformat=unix<br></code></pre></td></tr></tbody></table></figure><p>后执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">:x<br></code></pre></td></tr></tbody></table></figure><p>或者</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">:wq<br></code></pre></td></tr></tbody></table></figure><p>保存修改<br>然后就可以执行./***.sh运行脚本了。</p></li><li><p>方法二：</p><p>直接执行 <code>sed -i "s/\r//" xxx.sh</code> 来转化， 然后就可以执行 <code>./***.sh</code> 运行脚本了。</p></li><li><p>方法三：</p><p>直接执行 <code>dos2unix xxx.sh</code> 来转化， 然后就可以执行 <code>./xxx.sh</code> 运行脚本了.</p><p>如执行报错<code>bash: dos2unix: command not found</code>，请使用<code>busybox dos2unix ***.sh</code>继续操作。</p></li></ul><h4 id="bash-XXX-No-such-file-or-directory-没有那个文件或目录"><a href="#bash-XXX-No-such-file-or-directory-没有那个文件或目录" class="headerlink" title="bash: ./XXX: No such file or directory/ 没有那个文件或目录"></a>bash: ./XXX: No such file or directory/ 没有那个文件或目录</h4><p>明明文件存在而且有权限执行，却提示这个问题，有可可能是在64-bit机器上上运行了32-bit软件<br>需要安装32位支持库</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install ia32-libs<br></code></pre></td></tr></tbody></table></figure><p>安装这个库可能会提示找不到，安装不了</p><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">没有可用的软件包 ia32-libs，但是它被其它的软件包引用了。<br>这可能意味着这个缺失的软件包可能已被废弃，<br>或者只能在其他发布源中找到<br>然而下列软件包会取代它：<br>  lib32z1<br><br><span class="hljs-symbol">E:</span> 软件包 ia32-libs 没有可安装候选<br></code></pre></td></tr></tbody></table></figure><p>根据错误提示安装下面这个这个库</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install lib32z1<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux安装Webmin</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-an-zhuang-webmin/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/linux-an-zhuang-webmin/</url>
    
    <content type="html"><![CDATA[<p><a href="https://webmin.com/download">Webmin Download</a></p><h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><h3 id="添加仓库源"><a href="#添加仓库源" class="headerlink" title="添加仓库源"></a>添加仓库源</h3><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl -o setup-repos.sh https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/webmin/</span>webmin<span class="hljs-regexp">/master/</span>setup-repos.sh<br>sh setup-repos.sh<br></code></pre></td></tr></tbody></table></figure><p>此脚本将自动设置<code>Webmin</code>的存储库并在系统上安装 GPG 密钥，并提供 <code>Webmin</code> 包以供将来安装和轻松升级。支持的系统是 Red Hat<br>Enterprise Linux，Alma，Rocky，Oracle，CentOS Stream，Fedora或Debian，Ubuntu，Kali。</p><h3 id="启用存储库后，使用以下命令安装Webmin："><a href="#启用存储库后，使用以下命令安装Webmin：" class="headerlink" title="启用存储库后，使用以下命令安装Webmin："></a>启用存储库后，使用以下命令安装Webmin：</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">sudo apt <span class="hljs-keyword">update</span><br>apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install webmin <span class="hljs-comment">--install-recommends</span><br></code></pre></td></tr></tbody></table></figure><h2 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h2><p>默认情况下，Webmin侦听所有网络接口上端口10000上的连接。如果系统开启了防火墙，则需要打开Webmin端口：</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> ufw <span class="hljs-literal">allow</span> <span class="hljs-number">10000</span>/tcp<br></code></pre></td></tr></tbody></table></figure><h2 id="访问Webmin界面"><a href="#访问Webmin界面" class="headerlink" title="访问Webmin界面"></a>访问Webmin界面</h2><p>Webmin安装完成后，启动浏览器，然后域名或P地址，然后带上Webmin端口10000：</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">10000</span><br></code></pre></td></tr></tbody></table></figure><p>即可访问 Webmin</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>卸载已安装的Qt</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/xie-zai-yi-an-zhuang-de-qt/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/xie-zai-yi-an-zhuang-de-qt/</url>
    
    <content type="html"><![CDATA[<h1 id="linux下卸载之前的qt4"><a href="#linux下卸载之前的qt4" class="headerlink" title="linux下卸载之前的qt4"></a>linux下卸载之前的qt4</h1><ul><li>打开终端，进入安装Qt的目录</li><li>运行命令<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./MaintenanceTool<br></code></pre></td></tr></tbody></table></figure></li><li>如果没有这个的话，则执行：<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt autoremove <span class="hljs-string">'.*qt4.*-dev'</span><br></code></pre></td></tr></tbody></table></figure></li><li>还不行的话：<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> /usr/lib/x86_64-linux-gnu/libQt*<br></code></pre></td></tr></tbody></table></figure></li></ul><h1 id="安装Qt5"><a href="#安装Qt5" class="headerlink" title="安装Qt5"></a>安装Qt5</h1><p>以安装qt5.9.9为例</p><ol><li><p>从以下网址中下载qt安装包</p><p><a href="https://iso.mirrors.ustc.edu.cn/qtproject/archive/qt/5.12/5.12.12/qt-opensource-linux-x64-5.12.12.run">Qt5.12.12下载</a></p></li><li><p>打开终端，输入以下命令赋予安装包权限</p><p><code>chmod -R 777 qtopensource-linux-x64-5.12.12.run</code></p></li><li><p>输入以下命令开始进行安装</p><p><code>./qt-opensource-linux-x64-5.12.12.run</code></p></li><li><p>然后进入到安装页面，并且跟着提示一步一步走就好了（现在安装还要登录账户）</p></li><li><p>安装完成后不要马上打开qt软件，而是按照如下步骤配置环境变量</p><ul><li>在终端输入以下命令   <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span><br><span class="hljs-built_in">ls</span> -a <br>gedit ./bashrc<br></code></pre></td></tr></tbody></table></figure></li><li>然后在<code>.bashrc</code>文件中添加如下内容   <figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#其中下面第一行代码中的路劲是qt安装位置所对应的路径</span><br><span class="hljs-comment">#32位系统</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">QTDIR</span>=/opt/Qt5.12.12/5.12.12<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$QTDIR</span>/gcc/bin:$PATH<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">LD_LIBRARY_PATH</span>=<span class="hljs-variable">$QTDIR</span>/gcc/lib:$LD_LIBRARY_PATH<br> <br><span class="hljs-comment">#64位</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">QTDIR</span>=/opt/Qt5.12.12/5.12.12<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$QTDIR</span>/gcc_64/bin:$PATH<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">LD_LIBRARY_PATH</span>=<span class="hljs-variable">$QTDIR</span>/gcc_64/lib:$LD_LIBRARY_PATH<br></code></pre></td></tr></tbody></table></figure></li><li>保存退出，执行以下命令让环境变量生效   <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p>输入以下命令，验证qt是否安装成功</p> <figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">qmake -<span class="hljs-built_in">version</span><br></code></pre></td></tr></tbody></table></figure><p>如果出现qt信息则证明安装成功</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux安装Wine</title>
    <link href="/2023/08/19/docs/cao-zuo-xi-tong/linux/an-zhuang-wine/"/>
    <url>/2023/08/19/docs/cao-zuo-xi-tong/linux/an-zhuang-wine/</url>
    
    <content type="html"><![CDATA[<p>先得添加ubuntu-wine/ppa这个官方的源地址<br>指令是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo add-apt-repository ppa:ubuntu-wine/ppa<br></code></pre></td></tr></tbody></table></figure><p>当然，你如果直接开始安装也是可以的，但是不能获取到最新的wine哦！建议以上的操作。</p><p>再更新安装包<br>安装包的更新指令是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get update<br>```  <br><br>安装wine1.8<br><br>```bash<br>sudo apt-get install wine1.8<br></code></pre></td></tr></tbody></table></figure><p>第一步，在终端中使用如下命令，添加软件仓库并自动刷新缓存：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O- https://deepin-wine.i-m.dev/setup.sh | sh<br></code></pre></td></tr></tbody></table></figure><p>软件仓库添加完毕，会提示使用 apt 命令即可安装微信、QQ 了，与安装 Linux 原生软件一样</p><p>第二步，在终端中使用 apt 命令安装微信、QQ 等软件，以下以微信为例。安装其他软件只需使用相应的软件名称即可。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install com.qq.weixin.deepin<br></code></pre></td></tr></tbody></table></figure><p>安装后需要注销重登录才能显示应用图标。</p><p>常用应用的软件包名如下</p><table><thead><tr><th>应用</th><th>包名</th></tr></thead><tbody><tr><td>TIM</td><td>com.qq.office.deepin</td></tr><tr><td>QQ</td><td>com.qq.im.deepin</td></tr><tr><td>微信</td><td>com.qq.weixin.deepin</td></tr><tr><td>钉钉</td><td>com.dingtalk.deepin</td></tr></tbody></table><p>完整列表见 <a href="https://deepin-wine.i-m.dev/">https://deepin-wine.i-m.dev/</a></p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Edge浏览器优化</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/edge-liu-lan-qi-you-hua/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/edge-liu-lan-qi-you-hua/</url>
    
    <content type="html"><![CDATA[<h3 id="Edge浏览器优化"><a href="#Edge浏览器优化" class="headerlink" title="Edge浏览器优化"></a>Edge浏览器优化</h3><p>禁止Edge多余进程，自动更新等</p><p>创建一个文件 <code>Edge浏览器优化.reg</code></p><p>用记事本打开编辑，输入下面的内容</p><figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">Windows Registry Editor Version <span class="hljs-number">5.00</span><br><br>[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Edge]<br><span class="hljs-string">"HubsSidebarEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"QuickViewOfficeFilesEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"StartupBoostEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"BingAdsSuppression"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"BackgroundModeEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"EdgeShoppingAssistantEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"HideFirstRunExperience"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"PersonalizationReportingEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"SmartScreenPuaEnabled "</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"ShowMicrosoftRewards"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"VerticalTabsAllowed"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"ShowHomeButton"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"NewTabPageContentEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"NewTabPageHideDefaultTopSites"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"NewTabPageQuickLinksEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"NewTabPageManagedQuickLinks"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"EdgeFollowEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br><span class="hljs-string">"FamilySafetySettingsEnabled"</span>=<span class="hljs-built_in">dword</span>:<span class="hljs-number">00000000</span><br></code></pre></td></tr></tbody></table></figure><p>保存后，双击导入注册表</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
      <tag>Edge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>win+R 运行命令</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/win-r-yun-xing-ming-ling/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/win-r-yun-xing-ming-ling/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="win-R-运行命令"><a href="#win-R-运行命令" class="headerlink" title="win+R 运行命令"></a>win+R 运行命令</h1><h2 id="系统激活相关"><a href="#系统激活相关" class="headerlink" title="系统激活相关"></a>系统激活相关</h2><h3 id="查询操作系统版本"><a href="#查询操作系统版本" class="headerlink" title="查询操作系统版本"></a>查询操作系统版本</h3><figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">winver</span><br></code></pre></td></tr></tbody></table></figure><h3 id="查询操作系统版本、部分产品密钥、许可证状态等"><a href="#查询操作系统版本、部分产品密钥、许可证状态等" class="headerlink" title="查询操作系统版本、部分产品密钥、许可证状态等"></a>查询操作系统版本、部分产品密钥、许可证状态等</h3><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">slmgr<span class="hljs-selector-class">.vbs</span> -dli<br></code></pre></td></tr></tbody></table></figure><h3 id="查询系统是试用激活码还是永久激活码"><a href="#查询系统是试用激活码还是永久激活码" class="headerlink" title="查询系统是试用激活码还是永久激活码"></a>查询系统是试用激活码还是永久激活码</h3><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">slmgr<span class="hljs-selector-class">.vbs</span> -xpr<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Win11使用Win10右键菜单</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/win11-shi-yong-win10-you-jian-cai-dan/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/win11-shi-yong-win10-you-jian-cai-dan/</url>
    
    <content type="html"><![CDATA[<h3 id="Win11使用Win10右键菜单"><a href="#Win11使用Win10右键菜单" class="headerlink" title="Win11使用Win10右键菜单"></a>Win11使用Win10右键菜单</h3><p>终端管理员执行</p><p>使用win10风格右键菜单</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">reg add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /f /ve<br></code></pre></td></tr></tbody></table></figure><p>恢复Win11风格右键菜单</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">reg delete "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /va /f<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows文件夹映射成硬盘</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/windows-wen-jian-jia-ying-she-cheng-ying-pan/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/windows-wen-jian-jia-ying-she-cheng-ying-pan/</url>
    
    <content type="html"><![CDATA[<h2 id="Windows文件夹映射成硬盘"><a href="#Windows文件夹映射成硬盘" class="headerlink" title="Windows文件夹映射成硬盘"></a>Windows文件夹映射成硬盘</h2><ul><li><p>方法一，使用命令</p><p>映射<br>将<code>D:\files</code>文件夹映射为<code>E:</code>盘</p>  <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">subst e: d:\files<br></code></pre></td></tr></tbody></table></figure><p>取消映射</p>  <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">subst d: /d<br></code></pre></td></tr></tbody></table></figure><p>虚拟盘符可以用h~z任意一个做盘符,不能用已有的盘符的名称,包括光驱盘符，否则会报错。</p><p>注意：这种映射重启电脑后会失效</p></li><li><p>方法二，使用共享文件夹映射网络驱动器</p><p><a href="https://blog.csdn.net/bandaoyu/article/details/122746715">映射网络驱动器</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows状态栏图标白屏修复</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/xiu-fu-zhuang-tai-lan-tu-biao/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/xiu-fu-zhuang-tai-lan-tu-biao/</url>
    
    <content type="html"><![CDATA[<h3 id="Windows状态栏图标修复"><a href="#Windows状态栏图标修复" class="headerlink" title="Windows状态栏图标修复"></a>Windows状态栏图标修复</h3><p>有时候状态栏图标可能会异常，只显示一个白色的文件图标</p><p>终端管理员执行</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">reg delete "HKEY_CURRENT_USER\Software\Classes\Local Settings\Software\Microsoft\Windows\CurrentVersion\TrayNotify" /va /f<br>taskkill /f /im explorer.exe &amp; start explorer.exe<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微软商店跳过系统代理</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/wei-ruan-shang-dian-tiao-guo-xi-tong-dai-li/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/wei-ruan-shang-dian-tiao-guo-xi-tong-dai-li/</url>
    
    <content type="html"><![CDATA[<p>一打开系统代理就无法使用微软商店了，解决办法<br><a href="https://zhuanlan.zhihu.com/p/413730301">配置Microsoft Store等软件绕过V2ray全局代理</a></p><p>管理员权限打开终端，执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CheckNetIsolation.exe loopbackexempt -a -p=S-1-15-2-1609473798-1231923017-684268153-4268514328-882773646-2760585773-1760938157<br></code></pre></td></tr></tbody></table></figure><p>完成</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关闭Windows的下载目录的自动分组功能</title>
    <link href="/2023/08/18/docs/cao-zuo-xi-tong/windows/guan-bi-windows-de-xia-zai-mu-lu-de-zi-dong-fen-zu-gong-neng/"/>
    <url>/2023/08/18/docs/cao-zuo-xi-tong/windows/guan-bi-windows-de-xia-zai-mu-lu-de-zi-dong-fen-zu-gong-neng/</url>
    
    <content type="html"><![CDATA[<h2 id="关闭Windows的下载目录的自动分组功能"><a href="#关闭Windows的下载目录的自动分组功能" class="headerlink" title="关闭Windows的下载目录的自动分组功能"></a>关闭Windows的下载目录的自动分组功能</h2><p>升级到 windows 11 后，下载目录总是会自动分组，手动关了之后，下次打开又会自动分组。这里通过修改注册表彻底关闭。</p><p>键盘快捷键(win+R)，打开运行输入regedit，注册表找到下面的内容：</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">HKEY_LOCAL_MACHINE</span>\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FolderTypes\{<span class="hljs-number">885</span>a186e-a440-<span class="hljs-number">4</span>ada-<span class="hljs-number">812</span>b-db871b942259}\TopViews\{<span class="hljs-number">00000000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">000000000000</span>}<br></code></pre></td></tr></tbody></table></figure><p>修改右侧内容区域：</p><p><code>GroupBy</code>：从 <code>System.DateModified</code> 改为</p> <figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">System</span>.<span class="hljs-keyword">Null</span><br></code></pre></td></tr></tbody></table></figure><p><code>SortByList</code>：从 <code>prop:System.DateModified</code> 改为</p><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">prop</span>:System.ItemNameDisplay<br></code></pre></td></tr></tbody></table></figure><p>然后重启电脑</p><p>方法来自：<a href="https://www.v2ex.com/t/629634">如何彻底禁用 win10 资源管理器的分组依据功能</a></p><p>如果修改提示 写入值的新内容时出错，右键 <code>{00000000-0000-0000-0000-000000000000}</code> 项，选择 <code>权限</code>，弹出窗口中点击<br>高级，然后弹出窗口的左上角的 所有者，点击 更改。弹出的 <code>选择用户或组</code> 窗口中点击 <code>高级</code> ，然后点击 <code>立即找查</code><br>，在搜索结果的选项中选择 <code>Administrators</code> ，确定之后就可以正常修改了。</p>]]></content>
    
    
    <categories>
      
      <category>操作系统</category>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>学习正则表达式的简单方法</title>
    <link href="/2023/08/17/docs/zheng-ze-biao-da-shi/xue-xi-zheng-ze-biao-da-shi-de-jian-dan-fang-fa/"/>
    <url>/2023/08/17/docs/zheng-ze-biao-da-shi/xue-xi-zheng-ze-biao-da-shi-de-jian-dan-fang-fa/</url>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/cdoco/learn-regex-zh">源文件地址</a></p><br><p align="center"><img src="https://i.imgur.com/bYwl7Vf.png" alt="Learn Regex"></p><br><h2 id="什么是正则表达式-？"><a href="#什么是正则表达式-？" class="headerlink" title="什么是正则表达式 ？"></a>什么是正则表达式 ？</h2><blockquote><p>正则表达式是一种被用于从文本中检索符合某些特定模式的文本。</p></blockquote><p>正则表达式是从左到右来匹配一个字符串的。“Regular Expression”这个词太长了，我们通常使用它的缩写“regex”或者“regexp”。<br>正则表达式可以被用来替换字符串中的文本、验证表单、基于模式匹配从一个字符串中提取字符串等等。<br><br></p><p>想象一下，您正在编写应用程序，并且您希望在用户选择用户名时设置规则。我们希望用户名可以包含字母，数字，下划线和连字符。<br>为了让它看起来不丑，我们还想限制用户名中的字符数量。这时我们可以使用以下正则表达式来验证用户名：</p><p align="center"><img src="https://i.imgur.com/UrDb9qc.png" alt="Regular expression"></p><p>上面这个正则表达式可以匹配 <code>john_doe</code>，<code>jo-hn_doe</code> 和 <code>john12_as</code>。但是它不能匹配 <code>Jo</code>，因为该字符串里面包含大写字符，并且它太短了。</p><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#1-%E5%9F%BA%E6%9C%AC%E5%8C%B9%E9%85%8D">基本匹配</a></li><li><a href="#2-%E5%85%83%E5%AD%97%E7%AC%A6">元字符</a><ul><li><a href="#21-%E8%8B%B1%E6%96%87%E5%8F%A5%E5%8F%B7">英文句号</a></li><li><a href="#22-%E5%AD%97%E7%AC%A6%E9%9B%86">字符集</a><ul><li><a href="#221-%E5%90%A6%E5%AE%9A%E5%AD%97%E7%AC%A6%E9%9B%86">否定字符集</a></li></ul></li><li><a href="#23-%E9%87%8D%E5%A4%8D">重复</a><ul><li><a href="#231-%E6%98%9F%E5%8F%B7">星号</a></li><li><a href="#232-%E5%8A%A0%E5%8F%B7">加号</a></li><li><a href="#233-%E9%97%AE%E5%8F%B7">问号</a></li></ul></li><li><a href="#24-%E8%8A%B1%E6%8B%AC%E5%8F%B7">花括号</a></li><li><a href="#25-%E5%AD%97%E7%AC%A6%E7%BB%84">字符组</a></li><li><a href="#26-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84">分支结构</a></li><li><a href="#27-%E8%BD%AC%E4%B9%89%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6">转义特殊字符</a></li><li><a href="#28-%E5%AE%9A%E4%BD%8D%E7%AC%A6">定位符</a><ul><li><a href="#281-%E6%8F%92%E5%85%A5%E7%AC%A6%E5%8F%B7">插入符号</a></li><li><a href="#282-%E7%BE%8E%E5%85%83%E7%AC%A6%E5%8F%B7">美元符号</a></li></ul></li></ul></li><li><a href="#3-%E7%AE%80%E5%86%99%E5%AD%97%E7%AC%A6%E9%9B%86">简写字符集</a></li><li><a href="#4-%E6%96%AD%E8%A8%80">断言</a><ul><li><a href="#41-%E6%AD%A3%E5%90%91%E5%85%88%E8%A1%8C%E6%96%AD%E8%A8%80">正向先行断言</a></li><li><a href="#42-%E8%B4%9F%E5%90%91%E5%85%88%E8%A1%8C%E6%96%AD%E8%A8%80">负向先行断言</a></li><li><a href="#43-%E6%AD%A3%E5%90%91%E5%90%8E%E8%A1%8C%E6%96%AD%E8%A8%80">正向后行断言</a></li><li><a href="#44-%E8%B4%9F%E5%90%91%E5%90%8E%E8%A1%8C%E6%96%AD%E8%A8%80">负向后行断言</a></li></ul></li><li><a href="#5-%E6%A0%87%E8%AE%B0">标记</a><ul><li><a href="#51-%E4%B8%8D%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99">不区分大小写</a></li><li><a href="#52-%E5%85%A8%E5%B1%80%E6%90%9C%E7%B4%A2">全局搜索</a></li><li><a href="#53-%E5%A4%9A%E8%A1%8C%E5%8C%B9%E9%85%8D">多行匹配</a></li></ul></li><li><a href="#%E5%B8%B8%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">常用正则表达式</a></li></ul><h2 id="1-基本匹配"><a href="#1-基本匹配" class="headerlink" title="1. 基本匹配"></a>1. 基本匹配</h2><p>正则表达式只是我们用于在文本中检索字符串的模式。例如正则表达式 <code>cat</code>，表示：字母 <code>c</code> 后面跟着一个字母 <code>a</code><br>，再后面跟着一个字母 <code>t</code>。</p><pre>"cat" =&gt; The <a href="#learn-regex"><strong>cat</strong></a> sat on the mat</pre><p>正则表达式 <code>123</code> 会匹配字符串“123”。通过将正则表达式中的每个字符逐个与要匹配的字符串中的每个字符进行比较，来完成正则匹配。<br>正则表达式通常区分大小写，因此正则表达式 <code>Cat</code> 与字符串“cat”不匹配。</p><pre>"Cat" =&gt; The cat sat on the <a href="#learn-regex"><strong>Cat</strong></a></pre><h2 id="2-元字符"><a href="#2-元字符" class="headerlink" title="2. 元字符"></a>2. 元字符</h2><p>元字符是正则表达式的基本组成元素。元字符在这里跟它通常表达的意思不一样，而是以某种特殊的含义去解释。有些元字符在写在方括号内时有特殊含义。<br>元字符如下：</p><table><thead><tr><th align="center">元字符</th><th>描述</th></tr></thead><tbody><tr><td align="center">.</td><td>匹配除换行符以外的任意字符。</td></tr><tr><td align="center">[ ]</td><td>字符类，匹配方括号中包含的任意字符。</td></tr><tr><td align="center">[^ ]</td><td>否定字符类。匹配方括号中不包含的任意字符</td></tr><tr><td align="center">*</td><td>匹配前面的子表达式零次或多次</td></tr><tr><td align="center">+</td><td>匹配前面的子表达式一次或多次</td></tr><tr><td align="center">?</td><td>匹配前面的子表达式零次或一次，或指明一个非贪婪限定符。</td></tr><tr><td align="center">{n,m}</td><td>花括号，匹配前面字符至少 n 次，但是不超过 m 次。</td></tr><tr><td align="center">(xyz)</td><td>字符组，按照确切的顺序匹配字符 xyz。</td></tr><tr><td align="center">|</td><td>分支结构，匹配符号之前的字符或后面的字符。</td></tr><tr><td align="center">\</td><td>转义符，它可以还原元字符原来的含义，允许你匹配保留字符 <code>[ ] ( ) { } . * + ? ^ $ \ |</code></td></tr><tr><td align="center">^</td><td>匹配行的开始</td></tr><tr><td align="center">$</td><td>匹配行的结束</td></tr></tbody></table><h2 id="2-1-英文句号"><a href="#2-1-英文句号" class="headerlink" title="2.1 英文句号"></a>2.1 英文句号</h2><p>英文句号 <code>.</code> 是元字符的最简单的例子。元字符 <code>.</code> 可以匹配任意单个字符。它不会匹配换行符和新行的字符。例如正则表达式 <code>.ar</code><br>，表示：任意字符后面跟着一个字母 <code>a</code>，<br>再后面跟着一个字母 <code>r</code>。</p><pre>".ar" =&gt; The <a href="#learn-regex"><strong>car</strong></a> <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.</pre><h2 id="2-2-字符集"><a href="#2-2-字符集" class="headerlink" title="2.2 字符集"></a>2.2 字符集</h2><p>字符集也称为字符类。方括号被用于指定字符集。使用字符集内的连字符来指定字符范围。方括号内的字符范围的顺序并不重要。<br>例如正则表达式 <code>[Tt]he</code>，表示：大写 <code>T</code> 或小写 <code>t</code> ，后跟字母 <code>h</code>，再后跟字母 <code>e</code>。</p><pre>"[Tt]he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car parked in <a href="#learn-regex"><strong>the</strong></a> garage.</pre><p>然而，字符集中的英文句号表示它字面的含义。正则表达式 <code>ar[.]</code>，表示小写字母 <code>a</code>，后面跟着一个字母 <code>r</code><br>，再后面跟着一个英文句号 <code>.</code> 字符。</p><pre>"ar[.]" =&gt; A garage is a good place to park a c<a href="#learn-regex"><strong>ar.</strong></a></pre><h3 id="2-2-1-否定字符集"><a href="#2-2-1-否定字符集" class="headerlink" title="2.2.1 否定字符集"></a>2.2.1 否定字符集</h3><p>一般来说插入字符 <code>^</code> 表示一个字符串的开始，但是当它在方括号内出现时，它会取消字符集。例如正则表达式 <code>[^c]ar</code><br>，表示：除了字母 <code>c</code> 以外的任意字符，后面跟着字符 <code>a</code>，<br>再后面跟着一个字母 <code>r</code>。</p><pre>"[^c]ar" =&gt; The car <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.</pre><h2 id="2-3-重复"><a href="#2-3-重复" class="headerlink" title="2.3 重复"></a>2.3 重复</h2><p>以下元字符 <code>+</code>，<code>*</code> 或 <code>?</code> 用于指定子模式可以出现多少次。这些元字符在不同情况下的作用不同。</p><h3 id="2-3-1-星号"><a href="#2-3-1-星号" class="headerlink" title="2.3.1 星号"></a>2.3.1 星号</h3><p>星号 <code>*</code> 表示匹配上一个匹配规则零次或多次。正则表达式 <code>a*</code> 表示小写字母 <code>a</code> 可以重复零次或者多次。但是它如果出现在字符集或者字符类之后，它表示整个字符集的重复。<br>例如正则表达式 <code>[a-z]*</code>，表示：一行中可以包含任意数量的小写字母。</p><pre>"[a-z]*" =&gt; T<a href="#learn-regex"><strong>he</strong></a> <a href="#learn-regex"><strong>car</strong></a> <a href="#learn-regex"><strong>parked</strong></a> <a href="#learn-regex"><strong>in</strong></a> <a href="#learn-regex"><strong>the</strong></a> <a href="#learn-regex"><strong>garage</strong></a> #21.</pre><p>星号 <code>*</code> 可以与元符号 <code>.</code> 用在一起，用来匹配任意字符串 <code>.*</code>。星号 <code>*</code> 可以与空格符 <code>\s</code> 一起使用，用来匹配一串空格字符。<br>例如正则表达式 <code>\s*cat\s*</code>，表示：零个或多个空格，后面跟小写字母 <code>c</code>，再后面跟小写字母 <code>a</code>，再在后面跟小写字母 <code>t</code><br>，后面再跟零个或多个空格。</p><pre>"\s*cat\s*" =&gt; The fat<a href="#learn-regex"><strong> cat </strong></a>sat on the <a href="#learn-regex"><strong>cat</strong></a>.</pre><h3 id="2-3-2-加号"><a href="#2-3-2-加号" class="headerlink" title="2.3.2 加号"></a>2.3.2 加号</h3><p>加号 <code>+</code> 表示匹配上一个字符一次或多次。例如正则表达式 <code>c.+t</code>，表示：一个小写字母 <code>c</code>，后跟任意数量的字符，后跟小写字母 <code>t</code>。</p><pre>"c.+t" =&gt; The fat <a href="#learn-regex"><strong>cat sat on the mat</strong></a>.</pre><h3 id="2-3-3-问号"><a href="#2-3-3-问号" class="headerlink" title="2.3.3 问号"></a>2.3.3 问号</h3><p>在正则表达式中，元字符 <code>?</code> 用来表示前一个字符是可选的。该符号匹配前一个字符零次或一次。<br>例如正则表达式 <code>[T]?he</code>，表示：可选的大写字母 <code>T</code>，后面跟小写字母 <code>h</code>，后跟小写字母 <code>e</code>。</p><pre>"[T]he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in the garage.</pre><pre>"[T]?he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in t<a href="#learn-regex"><strong>he</strong></a> garage.</pre><h2 id="2-4-花括号"><a href="#2-4-花括号" class="headerlink" title="2.4 花括号"></a>2.4 花括号</h2><p>在正则表达式中花括号（也被称为量词？）用于指定字符或一组字符可以重复的次数。例如正则表达式 <code>[0-9]{2,3}</code>，表示：匹配至少 2<br>位数字但不超过 3 位（0 到 9 范围内的字符）。</p><pre>"[0-9]{2,3}" =&gt; The number was 9.<a href="#learn-regex"><strong>999</strong></a>7 but we rounded it off to <a href="#learn-regex"><strong>10</strong></a>.0.</pre><p>我们可以省略第二个数字。例如正则表达式 <code>[0-9]{2,}</code>，表示：匹配 2 个或更多个数字。如果我们也删除逗号，则正则表达式 <code>[0-9]{2}</code><br>，表示：匹配正好为 2 位数的数字。</p><pre>"[0-9]{2,}" =&gt; The number was 9.<a href="#learn-regex"><strong>9997</strong></a> but we rounded it off to <a href="#learn-regex"><strong>10</strong></a>.0.</pre><pre>"[0-9]{2}" =&gt; The number was 9.<a href="#learn-regex"><strong>99</strong></a><a href="#learn-regex"><strong>97</strong></a> but we rounded it off to <a href="#learn-regex"><strong>10</strong></a>.0.</pre><h2 id="2-5-字符组"><a href="#2-5-字符组" class="headerlink" title="2.5 字符组"></a>2.5 字符组</h2><p>字符组是一组写在圆括号内的子模式 <code>(...)</code>。正如我们在正则表达式中讨论的那样，如果我们把一个量词放在一个字符之后，它会重复前一个字符。<br>但是，如果我们把量词放在一个字符组之后，它会重复整个字符组。<br>例如正则表达式 <code>(ab)*</code> 表示匹配零个或多个的字符串“ab”。我们还可以在字符组中使用元字符 <code>|</code>。例如正则表达式 <code>(c|g|p)ar</code><br>，表示：小写字母 <code>c</code>、<code>g</code> 或 <code>p</code> 后面跟字母 <code>a</code>，后跟字母 <code>r</code>。</p><pre>"(c|g|p)ar" =&gt; The <a href="#learn-regex"><strong>car</strong></a> is <a href="#learn-regex"><strong>par</strong></a>ked in the <a href="#learn-regex"><strong>gar</strong></a>age.</pre><h2 id="2-6-分支结构"><a href="#2-6-分支结构" class="headerlink" title="2.6 分支结构"></a>2.6 分支结构</h2><p>在正则表达式中垂直条 <code>|</code> 用来定义分支结构，分支结构就像多个表达式之间的条件。现在你可能认为这个字符集和分支结构的工作方式一样。<br>但是字符集和分支结构巨大的区别是字符集只在字符级别上有作用，然而分支结构在表达式级别上依然可以使用。<br>例如正则表达式 <code>(T|t)he|car</code>，表示：匹配大写字母 <code>T</code> 或小写字母 <code>t</code>，后面跟小写字母 <code>h</code>，后跟小写字母 <code>e</code>，或匹配小写字母 <code>c</code><br>，后跟小写字母 <code>a</code>，后跟小写字母 <code>r</code>。</p><pre>"(T|t)he|car" =&gt; <a href="#learn-regex"><strong>The</strong></a> <a href="#learn-regex"><strong>car</strong></a> is parked in <a href="#learn-regex"><strong>the</strong></a> garage.</pre><h2 id="2-7-转义特殊字符"><a href="#2-7-转义特殊字符" class="headerlink" title="2.7 转义特殊字符"></a>2.7 转义特殊字符</h2><p>正则表达式中使用反斜杠 <code>\</code> 来转义下一个字符。这将允许你使用保留字符来作为匹配字符 <code>{ } [ ] / \ + * . $ ^ | ?</code><br>。在特殊字符前面加 <code>\</code>，就可以使用它来做匹配字符。<br>例如正则表达式 <code>.</code> 是用来匹配除了换行符以外的任意字符。现在要在输入字符串中匹配 <code>.</code> 字符，正则表达式 <code>(f|c|m)at\.?</code><br>，表示：小写字母 <code>f</code>、<code>c</code> 或者 <code>m</code> 后跟小写字母 <code>a</code>，后跟小写字母 <code>t</code>，后跟可选的 <code>.</code> 字符。</p><pre>"(f|c|m)at\.?" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> <a href="#learn-regex"><strong>cat</strong></a> sat on the <a href="#learn-regex"><strong>mat.</strong></a></pre><h2 id="2-8-定位符"><a href="#2-8-定位符" class="headerlink" title="2.8 定位符"></a>2.8 定位符</h2><p>在正则表达式中，为了检查匹配符号是否是起始符号或结尾符号，我们使用定位符。<br>定位符有两种类型：第一种类型是 <code>^</code> 检查匹配字符是否是起始字符，第二种类型是 <code>$</code>，它检查匹配字符是否是输入字符串的最后一个字符。</p><h3 id="2-8-1-插入符号"><a href="#2-8-1-插入符号" class="headerlink" title="2.8.1 插入符号"></a>2.8.1 插入符号</h3><p>插入符号 <code>^</code> 符号用于检查匹配字符是否是输入字符串的第一个字符。如果我们使用正则表达式 <code>^a</code>（如果 a<br>是起始符号）匹配字符串 <code>abc</code>，它会匹配到 <code>a</code>。<br>但是如果我们使用正则表达式 <code>^b</code>，它是匹配不到任何东西的，因为在字符串 <code>abc</code> 中“b”不是起始字符。<br>让我们来看看另一个正则表达式 <code>^(T|t)he</code>，这表示：大写字母 <code>T</code> 或小写字母 <code>t</code> 是输入字符串的起始符号，后面跟着小写字母 <code>h</code><br>，后跟小写字母 <code>e</code>。</p><pre>"(T|t)he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in <a href="#learn-regex"><strong>the</strong></a> garage.</pre><pre>"^(T|t)he" =&gt; <a href="#learn-regex"><strong>The</strong></a> car is parked in the garage.</pre><h3 id="2-8-2-美元符号"><a href="#2-8-2-美元符号" class="headerlink" title="2.8.2 美元符号"></a>2.8.2 美元符号</h3><p>美元 <code>$</code> 符号用于检查匹配字符是否是输入字符串的最后一个字符。例如正则表达式 <code>(at\.)$</code>，表示：小写字母 <code>a</code>，后跟小写字母 <code>t</code><br>，后跟一个 <code>.</code> 字符，且这个匹配器必须是字符串的结尾。</p><pre>"(at\.)" =&gt; The fat c<a href="#learn-regex"><strong>at.</strong></a> s<a href="#learn-regex"><strong>at.</strong></a> on the m<a href="#learn-regex"><strong>at.</strong></a></pre><pre>"(at\.)$" =&gt; The fat cat sat on the m<a href="#learn-regex"><strong>at.</strong></a></pre><h2 id="3-简写字符集"><a href="#3-简写字符集" class="headerlink" title="3. 简写字符集"></a>3. 简写字符集</h2><p>正则表达式为常用的字符集和常用的正则表达式提供了简写。简写字符集如下：</p><table><thead><tr><th align="center">简写</th><th>描述</th></tr></thead><tbody><tr><td align="center">.</td><td>匹配除换行符以外的任意字符</td></tr><tr><td align="center">\w</td><td>匹配所有字母和数字的字符：<code>[a-zA-Z0-9_]</code></td></tr><tr><td align="center">\W</td><td>匹配非字母和数字的字符：<code>[^\w]</code></td></tr><tr><td align="center">\d</td><td>匹配数字：<code>[0-9]</code></td></tr><tr><td align="center">\D</td><td>匹配非数字：<code>[^\d]</code></td></tr><tr><td align="center">\s</td><td>匹配空格符：<code>[\t\n\f\r\p{Z}]</code></td></tr><tr><td align="center">\S</td><td>匹配非空格符：<code>[^\s]</code></td></tr></tbody></table><h2 id="4-断言"><a href="#4-断言" class="headerlink" title="4. 断言"></a>4. 断言</h2><p>后行断言和先行断言有时候被称为断言，它们是特殊类型的 <em><strong>非捕获组</strong></em>（用于匹配模式，但不包括在匹配列表中）。当我们在一种特定模式之前或者之后有这种模式时，会优先使用断言。<br>例如我们想获取输入字符串 <code>$4.44 and $10.88</code> 中带有前缀 <code>$</code> 的所有数字。我们可以使用这个正则表达式 <code>(?&lt;=\$)[0-9\.]*</code><br>，表示：获取包含 <code>.</code> 字符且前缀为 <code>$</code> 的所有数字。<br>以下是正则表达式中使用的断言：</p><table><thead><tr><th align="center">符号</th><th>描述</th></tr></thead><tbody><tr><td align="center">?=</td><td>正向先行断言</td></tr><tr><td align="center">?!</td><td>负向先行断言</td></tr><tr><td align="center">?&lt;=</td><td>正向后行断言</td></tr><tr><td align="center">?&lt;!</td><td>负向后行断言</td></tr></tbody></table><h3 id="4-1-正向先行断言"><a href="#4-1-正向先行断言" class="headerlink" title="4.1 正向先行断言"></a>4.1 正向先行断言</h3><p>正向先行断言认为第一部分的表达式的后面必须是先行断言表达式。返回的匹配结果仅包含与第一部分表达式匹配的文本。<br>要在一个括号内定义一个正向先行断言，在括号中问号和等号是这样使用的 <code>(?=...)</code>。先行断言表达式写在括号中的等号后面。<br>例如正则表达式 <code>(T|t)he(?=\sfat)</code>，表示：匹配大写字母 <code>T</code> 或小写字母 <code>t</code>，后面跟字母 <code>h</code>，后跟字母 <code>e</code>。<br>在括号中，我们定义了正向先行断言，它会引导正则表达式引擎匹配后面跟着 <code>fat</code> 的 <code>The</code> 或 <code>the</code>。</p><pre>"(T|t)he(?=\sfat)" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on the mat.</pre><h3 id="4-2-负向先行断言"><a href="#4-2-负向先行断言" class="headerlink" title="4.2 负向先行断言"></a>4.2 负向先行断言</h3><p>当我们需要指定第一部分表达式的后面不跟随某一内容时，使用负向先行断言。负向先行断言的定义跟我们定义的正向先行断言一样，<br>唯一的区别在于我们使用否定符号 <code>!</code> 而不是等号 <code>=</code>，例如 <code>(?!...)</code>。<br>我们来看看下面的正则表达式 <code>(T|t)he(?!\sfat)</code>，表示：从输入字符串中获取全部 <code>The</code> 或者 <code>the</code> 且不匹配 <code>fat</code> 前面加上一个空格字符。</p><pre>"(T|t)he(?!\sfat)" =&gt; The fat cat sat on <a href="#learn-regex"><strong>the</strong></a> mat.</pre><h3 id="4-3-正向后行断言"><a href="#4-3-正向后行断言" class="headerlink" title="4.3 正向后行断言"></a>4.3 正向后行断言</h3><p>正向后行断言用于获取跟随在特定模式之后的所有匹配内容。正向后行断言表示为 <code>(?&lt;=...)</code><br>。例如正则表达式 <code>(?&lt;=(T|t)he\s)(fat|mat)</code>，表示：从输入字符串中获取在单词 <code>The</code> 或 <code>the</code> 之后的所有 <code>fat</code> 和 <code>mat</code> 单词。</p><pre>"(?&lt;=(T|t)he\s)(fat|mat)" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> cat sat on the <a href="#learn-regex"><strong>mat</strong></a>.</pre><h3 id="4-4-负向后行断言"><a href="#4-4-负向后行断言" class="headerlink" title="4.4 负向后行断言"></a>4.4 负向后行断言</h3><p>负向后行断言是用于获取不跟随在特定模式之后的所有匹配的内容。负向后行断言表示为 <code>(?&lt;!...)</code><br>。例如正则表达式 <code>(?&lt;!(T|t)he\s)(cat)</code>，表示：在输入字符中获取所有不在 <code>The</code> 或 <code>the</code> 之后的所有单词 <code>cat</code>。</p><pre>"(?&lt;!(T|t)he\s)(cat)" =&gt; The cat sat on <a href="#learn-regex"><strong>cat</strong></a>.</pre><h2 id="5-标记"><a href="#5-标记" class="headerlink" title="5. 标记"></a>5. 标记</h2><p>标记也称为修饰符，因为它会修改正则表达式的输出。这些标志可以以任意顺序或组合使用，并且是正则表达式的一部分。</p><table><thead><tr><th align="center">标记</th><th>描述</th></tr></thead><tbody><tr><td align="center">i</td><td>不区分大小写：将匹配设置为不区分大小写。</td></tr><tr><td align="center">g</td><td>全局搜索：搜索整个输入字符串中的所有匹配。</td></tr><tr><td align="center">m</td><td>多行匹配：会匹配输入字符串每一行。</td></tr></tbody></table><h3 id="5-1-不区分大小写"><a href="#5-1-不区分大小写" class="headerlink" title="5.1 不区分大小写"></a>5.1 不区分大小写</h3><p><code>i</code> 修饰符用于执行不区分大小写匹配。例如正则表达式 <code>/The/gi</code>，表示：大写字母 <code>T</code>，后跟小写字母 <code>h</code>，后跟字母 <code>e</code>。<br>但是在正则匹配结束时 <code>i</code> 标记会告诉正则表达式引擎忽略这种情况。正如你所看到的，我们还使用了 <code>g</code> 标记，因为我们要在整个输入字符串中搜索匹配。</p><pre>"The" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on the mat.</pre><pre>"/The/gi" =&gt; <a href="#learn-regex"><strong>The</strong></a> fat cat sat on <a href="#learn-regex"><strong>the</strong></a> mat.</pre><h3 id="5-2-全局搜索"><a href="#5-2-全局搜索" class="headerlink" title="5.2 全局搜索"></a>5.2 全局搜索</h3><p><code>g</code> 修饰符用于执行全局匹配（会查找所有匹配，不会在查找到第一个匹配时就停止）。<br>例如正则表达式 <code>/.(at)/g</code>，表示：除换行符之外的任意字符，后跟小写字母 <code>a</code>，后跟小写字母 <code>t</code>。<br>因为我们在正则表达式的末尾使用了 <code>g</code> 标记，它会从整个输入字符串中找到每个匹配项。</p><pre>".(at)" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> cat sat on the mat.</pre><pre>"/.(at)/g" =&gt; The <a href="#learn-regex"><strong>fat</strong></a> <a href="#learn-regex"><strong>cat</strong></a> <a href="#learn-regex"><strong>sat</strong></a> on the <a href="#learn-regex"><strong>mat</strong></a>.</pre><h3 id="5-3-多行匹配"><a href="#5-3-多行匹配" class="headerlink" title="5.3 多行匹配"></a>5.3 多行匹配</h3><p><code>m</code> 修饰符被用来执行多行的匹配。正如我们前面讨论过的 <code>(^, $)</code><br>，使用定位符来检查匹配字符是输入字符串开始或者结束。但是我们希望每一行都使用定位符，所以我们就使用 <code>m</code> 修饰符。<br>例如正则表达式 <code>/at(.)?$/gm</code>，表示：小写字母 <code>a</code>，后跟小写字母 <code>t</code>，匹配除了换行符以外任意字符零次或一次。而且因为 <code>m</code><br>标记，现在正则表达式引擎匹配字符串中每一行的末尾。</p><pre>"/.at(.)?$/" =&gt; The fat                cat sat                on the <a href="#learn-regex"><strong>mat.</strong></a></pre><pre>"/.at(.)?$/gm" =&gt; The <a href="#learn-regex"><strong>fat</strong></a>                  cat <a href="#learn-regex"><strong>sat</strong></a>                  on the <a href="#learn-regex"><strong>mat.</strong></a></pre><h2 id="常用正则表达式"><a href="#常用正则表达式" class="headerlink" title="常用正则表达式"></a>常用正则表达式</h2><ul><li><strong>正整数</strong>：<code>^\d+$</code></li><li><strong>负整数</strong>：<code>^-\d+$</code></li><li><strong>电话号码</strong>：<code>^+?[\d\s]{3,}$</code></li><li><strong>电话代码</strong>：<code>^+?[\d\s]+(?[\d\s]{10,}$</code></li><li><strong>整数</strong>：<code>^-?\d+$</code></li><li><strong>用户名</strong>：<code>^[\w\d_.]{4,16}$</code></li><li><strong>字母数字字符</strong>：<code>^[a-zA-Z0-9]*$</code></li><li><strong>带空格的字母数字字符</strong>：<code>^[a-zA-Z0-9 ]*$</code></li><li><strong>密码</strong>：<code>^(?=^.{6,}$)((?=.*[A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z]))^.*$</code></li><li><strong>电子邮件</strong>：<code>^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})*$</code></li><li><strong>IPv4 地址</strong>：<code>^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*$</code></li><li><strong>小写字母</strong>：<code>^([a-z])*$</code></li><li><strong>大写字母</strong>：<code>^([A-Z])*$</code></li><li><strong>网址</strong>：<code>^(((http|https|ftp):\/\/)?([[a-zA-Z0-9]\-\.])+(\.)([[a-zA-Z0-9]]){2,4}([[a-zA-Z0-9]\/+=%&amp;_\.~?\-]*))*$</code></li><li><strong>VISA 信用卡号码</strong>：<code>^(4[0-9]{12}(?:[0-9]{3})?)*$</code></li><li><strong>日期（MM/DD/YYYY）</strong>：<code>^(0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])[- /.](19|20)?[0-9]{2}$</code></li><li><strong>日期（YYYY/MM/DD）</strong>：<code>^(19|20)?[0-9]{2}[- /.](0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])$</code></li><li><strong>万事达信用卡号码</strong>：<code>^(5[1-5][0-9]{14})*$</code></li></ul><h2 id="Contribution"><a href="#Contribution" class="headerlink" title="Contribution"></a>Contribution</h2><ul><li>Report issues</li><li>Open pull request with improvements</li><li>Spread the word</li></ul><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>MIT © <a href="mailto:ziishaned@gmail.com">Zeeshan Ahmed</a></p><hr><p><strong><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-">⬆ top</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>正则表达式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>正则</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>正则表达式</title>
    <link href="/2023/08/17/docs/zheng-ze-biao-da-shi/zheng-ze-biao-da-shi/"/>
    <url>/2023/08/17/docs/zheng-ze-biao-da-shi/zheng-ze-biao-da-shi/</url>
    
    <content type="html"><![CDATA[<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><h3 id="基本表达式"><a href="#基本表达式" class="headerlink" title="基本表达式"></a>基本表达式</h3><table><thead><tr><th>表达式</th><th>匹配</th><th>示例</th></tr></thead><tbody><tr><td>\u####</td><td>中文字符</td><td>\u548c -&gt; 和</td></tr><tr><td>.</td><td>任意一个字符</td><td></td></tr><tr><td>\d</td><td>一个数字</td><td></td></tr><tr><td>\D</td><td>一个非数字</td><td></td></tr><tr><td>\w</td><td>一个字母、数字或下划线</td><td></td></tr><tr><td>\s</td><td>一个空格字符(空格，tab 等)</td><td></td></tr><tr><td>\S</td><td>非\s</td><td></td></tr><tr><td>*</td><td>修饰符，匹配任意个字符</td><td></td></tr><tr><td>+</td><td>修饰符，至少一个数字</td><td></td></tr><tr><td>？</td><td>修饰符，匹配 0 个或 1 个字符</td><td></td></tr><tr><td>{n}</td><td>修饰符，匹配 n 个字符</td><td>\d{3} - &gt; 匹配 3 个数字</td></tr><tr><td>{m,n}</td><td>修饰符，匹配 m 到 n 个字符</td><td>\d{3,5} -&gt; 匹配 3 到 5 个数字</td></tr><tr><td>{n,}</td><td>修饰符，匹配至少 n 个字符</td><td>\d{3,} -&gt; 匹配至少 3 个数字</td></tr><tr><td>[…]</td><td>修饰符，匹配[ ]里面的字符</td><td>[123456789]\d{6,7} -&gt; 匹配不以 0 开头的 7-8 位数字 <br> [1-9]\d{6,7} -&gt; 同上</td></tr><tr><td>[^…]</td><td>修饰符，匹配不包含 … 的字符</td><td></td></tr><tr><td>|</td><td>或</td><td></td></tr><tr><td>^</td><td>开头 ^\d -&gt; 数字开头</td><td></td></tr><tr><td>$</td><td>结尾 \d$ -&gt; 数字结尾</td><td></td></tr></tbody></table><h3 id="其他表达式示例"><a href="#其他表达式示例" class="headerlink" title="其他表达式示例"></a>其他表达式示例</h3><table><thead><tr><th>表达式</th><th>匹配</th></tr></thead><tbody><tr><td>(($\n\r*$)|(^\n\r*^))</td><td>匹配空行</td></tr><tr><td>(^(\s|&amp;nbsp;)*$)</td><td>匹配空行,包含空格</td></tr><tr><td>[一-龥]</td><td>匹配汉字</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>正则表达式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>正则</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常用到正则表达式</title>
    <link href="/2023/08/17/docs/zheng-ze-biao-da-shi/chang-yong-dao-zheng-ze-biao-da-shi/"/>
    <url>/2023/08/17/docs/zheng-ze-biao-da-shi/chang-yong-dao-zheng-ze-biao-da-shi/</url>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/cdoco/learn-regex-zh">源文件地址</a></p><div align="center">  <p><img src="http://openlogos.org/logos/sage.jpg"></p>  <img src="https://img.shields.io/badge/branch-master-brightgreen.svg">  <img src="https://img.shields.io/badge/License-MIT-blue.svg">  <img src="https://jaywcjlove.github.io/sb/lang/chinese.svg"></div><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li><a href="#%E9%82%AE%E7%AE%B1">邮箱</a></li><li><a href="#%E7%94%B5%E8%AF%9D">电话</a></li><li><a href="#%E5%9F%9F%E5%90%8D">域名</a></li><li><a href="#ip">IP</a></li><li><a href="#%E5%B8%90%E5%8F%B7%E6%A0%A1%E9%AA%8C">帐号校验</a></li><li><a href="#%E5%AD%97%E7%AC%A6%E6%A0%A1%E9%AA%8C">字符校验</a><ul><li><a href="#%E6%B1%89%E5%AD%97">汉字</a></li><li><a href="#%E8%8B%B1%E6%96%87%E5%92%8C%E6%95%B0%E5%AD%97">英文和数字</a></li><li><a href="#%E9%95%BF%E5%BA%A6%E4%B8%BA3-20%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%97%E7%AC%A6">长度为3-20的所有字符</a></li><li><a href="#%E7%94%B1%E8%8B%B1%E6%96%87%E5%AD%97%E7%AC%A6">英文字符</a><ul><li><a href="#%E7%94%B126%E4%B8%AA%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E7%BB%84%E6%88%90%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2">由26个英文字母组成的字符串</a></li><li><a href="#%E7%94%B126%E4%B8%AA%E5%A4%A7%E5%86%99%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E7%BB%84%E6%88%90%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2">由26个大写英文字母组成的字符串</a></li><li><a href="#%E7%94%B126%E4%B8%AA%E5%B0%8F%E5%86%99%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E7%BB%84%E6%88%90%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2">由26个小写英文字母组成的字符串</a></li><li><a href="#%E7%94%B1%E6%95%B0%E5%AD%97%E5%92%8C26%E4%B8%AA%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E7%BB%84%E6%88%90%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2">由数字和26个英文字母组成的字符串</a></li><li><a href="#%E7%94%B1%E6%95%B0%E5%AD%9726%E4%B8%AA%E8%8B%B1%E6%96%87%E5%AD%97%E6%AF%8D%E6%88%96%E8%80%85%E4%B8%8B%E5%88%92%E7%BA%BF%E7%BB%84%E6%88%90%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2">由数字、26个英文字母或者下划线组成的字符串</a></li></ul></li><li><a href="#%E4%B8%AD%E6%96%87%E8%8B%B1%E6%96%87%E6%95%B0%E5%AD%97%E5%8C%85%E6%8B%AC%E4%B8%8B%E5%88%92%E7%BA%BF">中文、英文、数字包括下划线</a></li><li><a href="#%E4%B8%AD%E6%96%87%E8%8B%B1%E6%96%87%E6%95%B0%E5%AD%97%E4%BD%86%E4%B8%8D%E5%8C%85%E6%8B%AC%E4%B8%8B%E5%88%92%E7%BA%BF%E7%AD%89%E7%AC%A6%E5%8F%B7">中文、英文、数字但不包括下划线等符号</a></li><li><a href="#%E7%A6%81%E6%AD%A2%E8%BE%93%E5%85%A5%E5%90%AB%E6%9C%89%E7%AD%89%E5%AD%97%E7%AC%A6">禁止输入含有^%&amp;’,;=?$"等字符</a></li><li><a href="#%E7%A6%81%E6%AD%A2%E8%BE%93%E5%85%A5%E5%90%AB%E6%9C%89%E7%9A%84%E5%AD%97%E7%AC%A6">禁止输入含有~的字符</a></li></ul></li><li><a href="#%E6%95%B0%E5%AD%97%E6%AD%A3%E5%88%99">数字正则</a><ul><li><a href="#%E6%95%B4%E6%95%B0">整数</a><ul><li><a href="#%E6%AD%A3%E6%95%B4%E6%95%B0">正整数</a></li><li><a href="#%E8%B4%9F%E6%95%B4%E6%95%B0">负整数</a></li><li><a href="#%E9%9D%9E%E8%B4%9F%E6%95%B4%E6%95%B0">非负整数</a></li><li><a href="#%E9%9D%9E%E6%AD%A3%E6%95%B4%E6%95%B0">非正整数</a></li></ul></li><li><a href="#%E6%B5%AE%E7%82%B9%E6%95%B0">浮点数</a><ul><li><a href="#%E6%AD%A3%E6%B5%AE%E7%82%B9%E6%95%B0">正浮点数</a></li><li><a href="#%E8%B4%9F%E6%B5%AE%E7%82%B9%E6%95%B0">负浮点数</a></li><li><a href="#%E9%9D%9E%E8%B4%9F%E6%B5%AE%E7%82%B9%E6%95%B0">非负浮点数</a></li><li><a href="#%E9%9D%9E%E6%AD%A3%E6%B5%AE%E7%82%B9%E6%95%B0">非正浮点数</a></li></ul></li></ul></li></ul><h2 id="邮箱"><a href="#邮箱" class="headerlink" title="邮箱"></a>邮箱</h2><p><code>gaozihang-001@gmail.com</code> 只允许英文字母、数字、下划线、英文句号、以及中划线组成</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/email.png" alt="email"></p><p><code>高子航001Abc@bowbee.com.cn</code> 名称允许汉字、字母、数字，域名只允许英文域名</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/email2.png" alt="email"></p><h2 id="电话"><a href="#电话" class="headerlink" title="电话"></a>电话</h2><p><code>13012345678</code> 手机号</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^1(3|4|5|6|7|8|9)\d{9}$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/phone.png" alt="phone"></p><p><code>XXX-XXXXXXX</code> <code>XXXX-XXXXXXXX</code> 固定电话</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">(\(\d{3,4}\)|\d{3,4}-|\s)?\d{8}<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/phone2.png" alt="email"></p><h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p><code>https://google.com/</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^((http:\/\/)|(https:\/\/))?([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}(\/)<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/domain-name.png" alt="domain-name"></p><h2 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h2><p><code>127.0.0.1</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">((?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d))<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/ip.png" alt="ip"></p><h2 id="帐号校验"><a href="#帐号校验" class="headerlink" title="帐号校验"></a>帐号校验</h2><p><code>gaozihang_001</code> 字母开头，允许5-16字节，允许字母数字下划线</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[a-zA-Z][a-zA-Z0-9_]{4,15}$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/userid.png" alt="user"></p><h2 id="字符校验"><a href="#字符校验" class="headerlink" title="字符校验"></a>字符校验</h2><h3 id="汉字"><a href="#汉字" class="headerlink" title="汉字"></a>汉字</h3><p><code>高子航</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[\u4e00-\u9fa5]{0,}$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/chineses.png" alt="chinese"></p><h3 id="英文和数字"><a href="#英文和数字" class="headerlink" title="英文和数字"></a>英文和数字</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[A-Za-z0-9]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char1.png" alt="char"></p><h3 id="长度为3-20的所有字符"><a href="#长度为3-20的所有字符" class="headerlink" title="长度为3-20的所有字符"></a>长度为3-20的所有字符</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^.{3,20}$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char2.png" alt="char"></p><h3 id="英文字符"><a href="#英文字符" class="headerlink" title="英文字符"></a>英文字符</h3><h4 id="由26个英文字母组成的字符串"><a href="#由26个英文字母组成的字符串" class="headerlink" title="由26个英文字母组成的字符串"></a>由26个英文字母组成的字符串</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[A-Za-z]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char3.png" alt="char"></p><h4 id="由26个大写英文字母组成的字符串"><a href="#由26个大写英文字母组成的字符串" class="headerlink" title="由26个大写英文字母组成的字符串"></a>由26个大写英文字母组成的字符串</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[A-Z]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char4.png" alt="char"></p><h4 id="由26个小写英文字母组成的字符串"><a href="#由26个小写英文字母组成的字符串" class="headerlink" title="由26个小写英文字母组成的字符串"></a>由26个小写英文字母组成的字符串</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[a-z]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char5.png" alt="char"></p><h4 id="由数字和26个英文字母组成的字符串"><a href="#由数字和26个英文字母组成的字符串" class="headerlink" title="由数字和26个英文字母组成的字符串"></a>由数字和26个英文字母组成的字符串</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[A-Za-z0-9]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char6.png" alt="char"></p><h4 id="由数字、26个英文字母或者下划线组成的字符串"><a href="#由数字、26个英文字母或者下划线组成的字符串" class="headerlink" title="由数字、26个英文字母或者下划线组成的字符串"></a>由数字、26个英文字母或者下划线组成的字符串</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^\w+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char7.png" alt="char"></p><h3 id="中文、英文、数字包括下划线"><a href="#中文、英文、数字包括下划线" class="headerlink" title="中文、英文、数字包括下划线"></a>中文、英文、数字包括下划线</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[\u4E00-\u9FA5A-Za-z0-9_]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char8.png" alt="char"></p><h3 id="中文、英文、数字但不包括下划线等符号"><a href="#中文、英文、数字但不包括下划线等符号" class="headerlink" title="中文、英文、数字但不包括下划线等符号"></a>中文、英文、数字但不包括下划线等符号</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[\u4E00-\u9FA5A-Za-z0-9]+$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char9.png" alt="char"></p><h3 id="禁止输入含有-’-等字符"><a href="#禁止输入含有-’-等字符" class="headerlink" title="禁止输入含有%&amp;’,;=?$&quot;等字符"></a>禁止输入含有%&amp;’,;=?$"等字符</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">[^%&amp;',;=?$\x22]+<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char10.png" alt="char"></p><h3 id="禁止输入含有-的字符"><a href="#禁止输入含有-的字符" class="headerlink" title="禁止输入含有~的字符"></a>禁止输入含有~的字符</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">[^~\x22]+<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/char11.png" alt="char"></p><h2 id="数字正则"><a href="#数字正则" class="headerlink" title="数字正则"></a>数字正则</h2><h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^-?[1-9]\d*$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num1.png" alt="num"></p><h4 id="正整数"><a href="#正整数" class="headerlink" title="正整数"></a>正整数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[1-9]\d*$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num2.png" alt="num"></p><h4 id="负整数"><a href="#负整数" class="headerlink" title="负整数"></a>负整数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^-[1-9]\d*$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num3.png" alt="num"></p><h4 id="非负整数"><a href="#非负整数" class="headerlink" title="非负整数"></a>非负整数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[1-9]\d*|0$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num4.png" alt="num"></p><h4 id="非正整数"><a href="#非正整数" class="headerlink" title="非正整数"></a>非正整数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^-[1-9]\d*|0$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num5.png" alt="num"></p><h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^-?([1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0)$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num6.png" alt="num"></p><h4 id="正浮点数"><a href="#正浮点数" class="headerlink" title="正浮点数"></a>正浮点数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[1-9]\d*\.\d*|0\.\d*[1-9]\d*$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num7.png" alt="num"></p><h4 id="负浮点数"><a href="#负浮点数" class="headerlink" title="负浮点数"></a>负浮点数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^-([1-9]\d*\.\d*|0\.\d*[1-9]\d*)$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num8.png" alt="num"></p><h4 id="非负浮点数"><a href="#非负浮点数" class="headerlink" title="非负浮点数"></a>非负浮点数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^[1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num9.png" alt="num"></p><h4 id="非正浮点数"><a href="#非正浮点数" class="headerlink" title="非正浮点数"></a>非正浮点数</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs regex">^(-([1-9]\d*\.\d*|0\.\d*[1-9]\d*))|0?\.0+|0$<br></code></pre></td></tr></tbody></table></figure><p><img src="/images/num10.png" alt="num"></p><h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>MIT License. See the <a href="LICENSE">LICENSE</a> file.</p><p><strong><a href="#%E7%9B%AE%E5%BD%95">⬆ top</a></strong></p>]]></content>
    
    
    <categories>
      
      <category>正则表达式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>正则</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
